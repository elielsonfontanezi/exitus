====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example*
!frontend/.env.*example*
!backend/.env.*example*
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.development.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.production.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.staging.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic.ini ---
# A generic, single database configuration.

[alembic]
# path to migration scripts
script_location = alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the
# "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:alembic/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
version_path_separator = os  # Use os.pathsep. Default configuration used for new projects.

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = driver://user:pass@localhost/dbname


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/README ---
Generic single-database configuration.
====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py ---
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# Adicionar path do app
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

# Importar a aplica√ß√£o Flask e o db
from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Criar aplica√ß√£o Flask e obter metadata
app = create_app()
with app.app_context():
    # Garantir que todos os models sejam importados
    from app.models import (
        Usuario, Corretora, Ativo, Posicao, Transacao,
        Provento, MovimentacaoCaixa, EventoCorporativo,
        FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
    )
    target_metadata = db.metadata
    
# Configurar URL do banco
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py.back ---
# backend/alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# ADICIONAR ESTAS LINHAS:
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ADICIONAR ESTA LINHA:
# Configurar a URL do banco a partir da aplica√ß√£o Flask
app = create_app()
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])

# add your model's MetaData object here
# SUBSTITUIR por:
target_metadata = db.metadata

# ... resto do arquivo permanece igual

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/script.py.mako ---
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/versions/b2542b2f7857_initial_schema_12_models.py ---
"""Initial schema - 12 models

Revision ID: b2542b2f7857
Revises: 
Create Date: 2025-11-26 19:40:34.891548

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b2542b2f7857'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do ativo'),
    sa.Column('ticker', sa.String(length=20), nullable=False, comment='C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome completo do ativo'),
    sa.Column('tipo', sa.Enum('ACAO', 'FII', 'REIT', 'BOND', 'ETF', 'CRIPTO', 'OUTRO', name='tipoativo'), nullable=False, comment='Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)'),
    sa.Column('classe', sa.Enum('RENDA_VARIAVEL', 'RENDA_FIXA', 'CRIPTO', 'HIBRIDO', name='classeativo'), nullable=False, comment='Classe do ativo (renda vari√°vel, fixa, cripto)'),
    sa.Column('mercado', sa.String(length=10), nullable=False, comment='Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='Moeda de negocia√ß√£o (BRL, USD, EUR)'),
    sa.Column('preco_atual', sa.Numeric(precision=18, scale=6), nullable=True, comment='Pre√ßo/cota√ß√£o atual do ativo'),
    sa.Column('data_ultima_cotacao', sa.DateTime(timezone=True), nullable=True, comment='Data e hora da √∫ltima cota√ß√£o'),
    sa.Column('dividend_yield', sa.Numeric(precision=8, scale=4), nullable=True, comment='Dividend Yield em % (ex: 6.5000 = 6.5%)'),
    sa.Column('p_l', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Lucro'),
    sa.Column('p_vp', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Valor Patrimonial'),
    sa.Column('roe', sa.Numeric(precision=8, scale=4), nullable=True, comment='Return on Equity em %'),
    sa.Column('ativo', sa.Boolean(), nullable=False, comment='Indica se ativo est√° dispon√≠vel para negocia√ß√£o'),
    sa.Column('deslistado', sa.Boolean(), nullable=False, comment='Indica se ativo foi deslistado da bolsa'),
    sa.Column('data_deslistagem', sa.Date(), nullable=True, comment='Data de deslistagem (se aplic√°vel)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas sobre o ativo'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='ativo_nome_min_length'),
    sa.CheckConstraint('length(ticker) >= 1', name='ativo_ticker_min_length'),
    sa.CheckConstraint('preco_atual IS NULL OR preco_atual >= 0', name='ativo_preco_positivo'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ticker', 'mercado', name='unique_ativo_ticker_mercado'),
    comment='Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'
    )
    op.create_index(op.f('ix_ativo_ativo'), 'ativo', ['ativo'], unique=False)
    op.create_index(op.f('ix_ativo_classe'), 'ativo', ['classe'], unique=False)
    op.create_index(op.f('ix_ativo_data_ultima_cotacao'), 'ativo', ['data_ultima_cotacao'], unique=False)
    op.create_index(op.f('ix_ativo_deslistado'), 'ativo', ['deslistado'], unique=False)
    op.create_index(op.f('ix_ativo_mercado'), 'ativo', ['mercado'], unique=False)
    op.create_index(op.f('ix_ativo_moeda'), 'ativo', ['moeda'], unique=False)
    op.create_index(op.f('ix_ativo_nome'), 'ativo', ['nome'], unique=False)
    op.create_index(op.f('ix_ativo_ticker'), 'ativo', ['ticker'], unique=False)
    op.create_index(op.f('ix_ativo_tipo'), 'ativo', ['tipo'], unique=False)
    op.create_table('feriado_mercado',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do feriado'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('mercado', sa.String(length=20), nullable=True, comment='Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos'),
    sa.Column('data_feriado', sa.Date(), nullable=False, comment='Data do feriado'),
    sa.Column('tipo_feriado', sa.Enum('NACIONAL', 'BOLSA', 'PONTE', 'FECHAMENTO_ANTECIPADO', 'MANUTENCAO', 'OUTRO', name='tipoferiado'), nullable=False, comment='Tipo do feriado'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome do feriado'),
    sa.Column('horario_fechamento', sa.Time(), nullable=True, comment='Hor√°rio de fechamento antecipado (se aplic√°vel)'),
    sa.Column('recorrente', sa.Boolean(), nullable=False, comment='Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o feriado'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='feriado_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 3', name='feriado_nome_min_length'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('pais', 'mercado', 'data_feriado', name='unique_feriado_pais_mercado_data'),
    comment='Tabela de feriados e dias sem preg√£o nos mercados'
    )
    op.create_index(op.f('ix_feriado_mercado_data_feriado'), 'feriado_mercado', ['data_feriado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_mercado'), 'feriado_mercado', ['mercado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_pais'), 'feriado_mercado', ['pais'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_recorrente'), 'feriado_mercado', ['recorrente'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_tipo_feriado'), 'feriado_mercado', ['tipo_feriado'], unique=False)
    op.create_table('fonte_dados',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da fonte'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da fonte de dados (ex: yfinance, Alpha Vantage)'),
    sa.Column('tipo_fonte', sa.Enum('API', 'SCRAPER', 'MANUAL', 'ARQUIVO', 'OUTRO', name='tipofontedados'), nullable=False, comment='Tipo da fonte de dados'),
    sa.Column('url_base', sa.String(length=500), nullable=True, comment='URL base da API ou site'),
    sa.Column('requer_autenticacao', sa.Boolean(), nullable=False, comment='Indica se requer chave API ou autentica√ß√£o'),
    sa.Column('rate_limit', sa.String(length=50), nullable=True, comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se fonte est√° ativa'),
    sa.Column('prioridade', sa.Integer(), nullable=False, comment='Ordem de prioridade (1 = maior prioridade)'),
    sa.Column('ultima_consulta', sa.DateTime(timezone=True), nullable=True, comment='Timestamp da √∫ltima consulta bem-sucedida'),
    sa.Column('total_consultas', sa.Integer(), nullable=False, comment='Total de consultas realizadas'),
    sa.Column('total_erros', sa.Integer(), nullable=False, comment='Total de erros encontrados'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a fonte de dados'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='fonte_nome_min_length'),
    sa.CheckConstraint('prioridade > 0', name='fonte_prioridade_positiva'),
    sa.CheckConstraint('total_consultas >= 0', name='fonte_consultas_positivas'),
    sa.CheckConstraint('total_erros >= 0', name='fonte_erros_positivos'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de fontes de dados externas (APIs, scrapers)'
    )
    op.create_index(op.f('ix_fonte_dados_ativa'), 'fonte_dados', ['ativa'], unique=False)
    op.create_index(op.f('ix_fonte_dados_nome'), 'fonte_dados', ['nome'], unique=True)
    op.create_index(op.f('ix_fonte_dados_prioridade'), 'fonte_dados', ['prioridade'], unique=False)
    op.create_index(op.f('ix_fonte_dados_tipo_fonte'), 'fonte_dados', ['tipo_fonte'], unique=False)
    op.create_index(op.f('ix_fonte_dados_ultima_consulta'), 'fonte_dados', ['ultima_consulta'], unique=False)
    op.create_table('regra_fiscal',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da regra'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('tipo_ativo', sa.String(length=20), nullable=True, comment='Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos'),
    sa.Column('tipo_operacao', sa.String(length=20), nullable=True, comment='Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas'),
    sa.Column('aliquota_ir', sa.Numeric(precision=6, scale=4), nullable=False, comment='Al√≠quota de IR em % (ex: 15.0000 = 15%)'),
    sa.Column('valor_isencao', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)'),
    sa.Column('incide_sobre', sa.Enum('LUCRO', 'RECEITA', 'PROVENTO', 'OPERACAO', name='incidenciaimposto'), nullable=False, comment='Sobre o que incide o imposto'),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada da regra fiscal'),
    sa.Column('vigencia_inicio', sa.Date(), nullable=False, comment='Data de in√≠cio da vig√™ncia da regra'),
    sa.Column('vigencia_fim', sa.Date(), nullable=True, comment='Data de fim da vig√™ncia (NULL = vigente indefinidamente)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se regra est√° ativa'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='regra_pais_iso_format'),
    sa.CheckConstraint('aliquota_ir >= 0 AND aliquota_ir <= 100', name='regra_aliquota_valida'),
    sa.CheckConstraint('valor_isencao IS NULL OR valor_isencao >= 0', name='regra_isencao_positiva'),
    sa.CheckConstraint('vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio', name='regra_vigencia_valida'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'
    )
    op.create_index(op.f('ix_regra_fiscal_ativa'), 'regra_fiscal', ['ativa'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_incide_sobre'), 'regra_fiscal', ['incide_sobre'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_pais'), 'regra_fiscal', ['pais'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_ativo'), 'regra_fiscal', ['tipo_ativo'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_operacao'), 'regra_fiscal', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_fim'), 'regra_fiscal', ['vigencia_fim'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_inicio'), 'regra_fiscal', ['vigencia_inicio'], unique=False)
    op.create_table('usuario',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('nome_completo', sa.String(length=200), nullable=True),
    sa.Column('ativo', sa.Boolean(), nullable=False),
    sa.Column('role', sa.Enum('ADMIN', 'USER', 'READONLY', name='userrole'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_usuario_email'), 'usuario', ['email'], unique=True)
    op.create_index(op.f('ix_usuario_username'), 'usuario', ['username'], unique=True)
    op.create_table('corretora',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da corretora'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da corretora/exchange (ex: XP, Clear, Binance)'),
    sa.Column('tipo', sa.Enum('CORRETORA', 'EXCHANGE', name='tipocorretora'), nullable=False, comment='Tipo: corretora tradicional ou exchange cripto'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)'),
    sa.Column('moeda_padrao', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('saldo_atual', sa.Numeric(precision=18, scale=2), nullable=False, comment='Saldo dispon√≠vel em caixa (na moeda padr√£o)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se conta est√° ativa'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas do usu√°rio sobre a conta'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("moeda_padrao ~* '^[A-Z]{3}$'", name='corretora_moeda_iso_format'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='corretora_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 2', name='corretora_nome_min_length'),
    sa.CheckConstraint('saldo_atual >= 0', name='corretora_saldo_positivo'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'nome', 'pais', name='unique_corretora_usuario_nome_pais'),
    comment='Tabela de corretoras e contas de investimento'
    )
    op.create_index(op.f('ix_corretora_ativa'), 'corretora', ['ativa'], unique=False)
    op.create_index(op.f('ix_corretora_moeda_padrao'), 'corretora', ['moeda_padrao'], unique=False)
    op.create_index(op.f('ix_corretora_nome'), 'corretora', ['nome'], unique=False)
    op.create_index(op.f('ix_corretora_pais'), 'corretora', ['pais'], unique=False)
    op.create_index(op.f('ix_corretora_tipo'), 'corretora', ['tipo'], unique=False)
    op.create_index(op.f('ix_corretora_usuario_id'), 'corretora', ['usuario_id'], unique=False)
    op.create_table('evento_corporativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do evento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo afetado pelo evento'),
    sa.Column('ativo_novo_id', sa.UUID(), nullable=True, comment='ID do novo ativo (fus√µes, mudan√ßas de ticker)'),
    sa.Column('tipo_evento', sa.Enum('SPLIT', 'GRUPAMENTO', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'FUSAO', 'CISAO', 'INCORPORACAO', 'MUDANCA_TICKER', 'DESLISTAGEM', 'RELISTING', 'CANCELAMENTO', 'OUTRO', name='tipoeventocorporativo'), nullable=False, comment='Tipo do evento corporativo'),
    sa.Column('data_evento', sa.Date(), nullable=False, comment='Data do evento'),
    sa.Column('data_com', sa.Date(), nullable=True, comment='Data COM (√∫ltimo dia para ter direito ao evento)'),
    sa.Column('proporcao', sa.String(length=20), nullable=True, comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada do evento'),
    sa.Column('impacto_posicoes', sa.Boolean(), nullable=False, comment='Indica se as posi√ß√µes j√° foram ajustadas'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes adicionais sobre o evento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)\n            OR \n            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))\n            ", name='evento_proporcao_obrigatoria'),
    sa.CheckConstraint('data_com IS NULL OR data_com <= data_evento', name='evento_data_com_valida'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['ativo_novo_id'], ['ativo.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de eventos corporativos que afetam ativos'
    )
    op.create_index(op.f('ix_evento_corporativo_ativo_id'), 'evento_corporativo', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_ativo_novo_id'), 'evento_corporativo', ['ativo_novo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_com'), 'evento_corporativo', ['data_com'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_evento'), 'evento_corporativo', ['data_evento'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_impacto_posicoes'), 'evento_corporativo', ['impacto_posicoes'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_tipo_evento'), 'evento_corporativo', ['tipo_evento'], unique=False)
    op.create_table('log_auditoria',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do log'),
    sa.Column('usuario_id', sa.UUID(), nullable=True, comment='ID do usu√°rio (NULL para a√ß√µes an√¥nimas)'),
    sa.Column('acao', sa.String(length=50), nullable=False, comment='Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)'),
    sa.Column('entidade', sa.String(length=100), nullable=True, comment='Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)'),
    sa.Column('entidade_id', sa.UUID(), nullable=True, comment='ID do registro afetado'),
    sa.Column('dados_antes', sa.JSON(), nullable=True, comment='Estado anterior do registro (JSON)'),
    sa.Column('dados_depois', sa.JSON(), nullable=True, comment='Estado posterior do registro (JSON)'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='Endere√ßo IP de origem'),
    sa.Column('user_agent', sa.String(length=500), nullable=True, comment='User-Agent (navegador/cliente)'),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False, comment='Data/hora da a√ß√£o'),
    sa.Column('sucesso', sa.Boolean(), nullable=False, comment='Indica se a√ß√£o foi bem-sucedida'),
    sa.Column('mensagem', sa.Text(), nullable=True, comment='Mensagem de erro ou detalhes adicionais'),
    sa.CheckConstraint('length(acao) >= 3', name='log_acao_min_length'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de logs de auditoria para compliance'
    )
    op.create_index(op.f('ix_log_auditoria_acao'), 'log_auditoria', ['acao'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade'), 'log_auditoria', ['entidade'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade_id'), 'log_auditoria', ['entidade_id'], unique=False)
    op.create_index(op.f('ix_log_auditoria_ip_address'), 'log_auditoria', ['ip_address'], unique=False)
    op.create_index(op.f('ix_log_auditoria_sucesso'), 'log_auditoria', ['sucesso'], unique=False)
    op.create_index(op.f('ix_log_auditoria_timestamp'), 'log_auditoria', ['timestamp'], unique=False)
    op.create_index(op.f('ix_log_auditoria_usuario_id'), 'log_auditoria', ['usuario_id'], unique=False)
    op.create_table('provento',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do provento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo que pagou o provento'),
    sa.Column('tipo_provento', sa.Enum('DIVIDENDO', 'JCP', 'RENDIMENTO', 'CUPOM', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'OUTRO', name='tipoprovento'), nullable=False, comment='Tipo do provento (dividendo, JCP, rendimento, etc.)'),
    sa.Column('valor_por_acao', sa.Numeric(precision=18, scale=6), nullable=False, comment='Valor unit√°rio por ativo'),
    sa.Column('quantidade_ativos', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos que geraram o provento'),
    sa.Column('valor_bruto', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor bruto recebido'),
    sa.Column('imposto_retido', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte'),
    sa.Column('valor_liquido', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor l√≠quido creditado'),
    sa.Column('data_com', sa.Date(), nullable=False, comment='Data COM (√∫ltimo dia para ter direito ao provento)'),
    sa.Column('data_pagamento', sa.Date(), nullable=False, comment='Data efetiva do pagamento'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o provento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_pagamento >= data_com', name='provento_data_pagamento_valida'),
    sa.CheckConstraint('imposto_retido >= 0', name='provento_imposto_positivo'),
    sa.CheckConstraint('quantidade_ativos > 0', name='provento_quantidade_positiva'),
    sa.CheckConstraint('valor_bruto > 0', name='provento_valor_bruto_positivo'),
    sa.CheckConstraint('valor_liquido <= valor_bruto', name='provento_liquido_menor_bruto'),
    sa.CheckConstraint('valor_liquido > 0', name='provento_valor_liquido_positivo'),
    sa.CheckConstraint('valor_por_acao > 0', name='provento_valor_por_acao_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de proventos recebidos (dividendos, JCP, rendimentos)'
    )
    op.create_index(op.f('ix_provento_ativo_id'), 'provento', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_provento_data_com'), 'provento', ['data_com'], unique=False)
    op.create_index(op.f('ix_provento_data_pagamento'), 'provento', ['data_pagamento'], unique=False)
    op.create_index(op.f('ix_provento_tipo_provento'), 'provento', ['tipo_provento'], unique=False)
    op.create_table('movimentacao_caixa',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da movimenta√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora (origem)'),
    sa.Column('corretora_destino_id', sa.UUID(), nullable=True, comment='ID da corretora destino (apenas para transfer√™ncias)'),
    sa.Column('provento_id', sa.UUID(), nullable=True, comment='ID do provento (apenas para cr√©dito de provento)'),
    sa.Column('tipo_movimentacao', sa.Enum('DEPOSITO', 'SAQUE', 'TRANSFERENCIA_ENVIADA', 'TRANSFERENCIA_RECEBIDA', 'CREDITO_PROVENTO', 'PAGAMENTO_TAXA', 'PAGAMENTO_IMPOSTO', 'AJUSTE', 'OUTRO', name='tipomovimentacao'), nullable=False, comment='Tipo da movimenta√ß√£o'),
    sa.Column('valor', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor da movimenta√ß√£o'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('data_movimentacao', sa.Date(), nullable=False, comment='Data da movimenta√ß√£o'),
    sa.Column('descricao', sa.Text(), nullable=True, comment='Descri√ß√£o da movimenta√ß√£o'),
    sa.Column('comprovante', sa.String(length=200), nullable=True, comment='Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)\n            OR \n            (tipo_movimentacao != 'credito_provento')\n            ", name='movimentacao_credito_tem_provento'),
    #sa.CheckConstraint("\n            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') \n             AND corretora_destino_id IS NOT NULL)\n            OR \n            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))\n            ", name='movimentacao_transferencia_tem_destino'),
    sa.CheckConstraint("moeda ~* '^[A-Z]{3}$'", name='movimentacao_moeda_iso_format'),
    sa.CheckConstraint('valor > 0', name='movimentacao_valor_positivo'),
    sa.ForeignKeyConstraint(['corretora_destino_id'], ['corretora.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provento_id'], ['provento.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de movimenta√ß√µes de caixa em corretoras'
    )
    op.create_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), 'movimentacao_caixa', ['corretora_destino_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_corretora_id'), 'movimentacao_caixa', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_data_movimentacao'), 'movimentacao_caixa', ['data_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_moeda'), 'movimentacao_caixa', ['moeda'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_provento_id'), 'movimentacao_caixa', ['provento_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), 'movimentacao_caixa', ['tipo_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_usuario_id'), 'movimentacao_caixa', ['usuario_id'], unique=False)
    op.create_table('posicao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da posi√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora onde est√° a posi√ß√£o'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos (suporta fracion√°rios)'),
    sa.Column('preco_medio', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo m√©dio de aquisi√ß√£o'),
    sa.Column('custo_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Custo total investido (quantidade * pre√ßo m√©dio)'),
    sa.Column('taxas_acumuladas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem e cust√≥dia acumuladas'),
    sa.Column('impostos_acumulados', sa.Numeric(precision=18, scale=2), nullable=False, comment='Impostos pagos acumulados (IR, IOF, etc.)'),
    sa.Column('valor_atual', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de mercado atual da posi√ß√£o'),
    sa.Column('lucro_prejuizo_realizado', sa.Numeric(precision=18, scale=2), nullable=False, comment='Lucro/preju√≠zo realizado em vendas'),
    sa.Column('lucro_prejuizo_nao_realizado', sa.Numeric(precision=18, scale=2), nullable=True, comment='Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)'),
    sa.Column('data_primeira_compra', sa.Date(), nullable=True, comment='Data da primeira aquisi√ß√£o deste ativo'),
    sa.Column('data_ultima_atualizacao', sa.DateTime(timezone=True), nullable=True, comment='Data da √∫ltima atualiza√ß√£o de valores'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('custo_total >= 0', name='posicao_custo_total_positivo'),
    sa.CheckConstraint('impostos_acumulados >= 0', name='posicao_impostos_positivos'),
    sa.CheckConstraint('preco_medio >= 0', name='posicao_preco_medio_positivo'),
    sa.CheckConstraint('quantidade >= 0', name='posicao_quantidade_positiva'),
    sa.CheckConstraint('taxas_acumuladas >= 0', name='posicao_taxas_positivas'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'corretora_id', 'ativo_id', name='unique_posicao_usuario_corretora_ativo'),
    comment='Tabela de posi√ß√µes em carteira (holdings)'
    )
    op.create_index(op.f('ix_posicao_ativo_id'), 'posicao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_posicao_corretora_id'), 'posicao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_posicao_data_primeira_compra'), 'posicao', ['data_primeira_compra'], unique=False)
    op.create_index(op.f('ix_posicao_data_ultima_atualizacao'), 'posicao', ['data_ultima_atualizacao'], unique=False)
    op.create_index(op.f('ix_posicao_usuario_id'), 'posicao', ['usuario_id'], unique=False)
    op.create_table('transacao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da transa√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo transacionado'),
    sa.Column('tipo_operacao', sa.Enum('COMPRA', 'VENDA', name='tipooperacao'), nullable=False, comment='Tipo de opera√ß√£o: COMPRA ou VENDA'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade transacionada (suporta fracion√°rios)'),
    sa.Column('preco_unitario', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo por unidade'),
    sa.Column('valor_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor total da opera√ß√£o (quantidade * pre√ßo)'),
    sa.Column('taxas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem, cust√≥dia, emolumentos'),
    sa.Column('impostos', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte, IOF, etc.'),
    sa.Column('data_operacao', sa.Date(), nullable=False, comment='Data da opera√ß√£o'),
    sa.Column('data_liquidacao', sa.Date(), nullable=True, comment='Data de liquida√ß√£o (D+2, D+3, etc.)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a transa√ß√£o'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_liquidacao IS NULL OR data_liquidacao >= data_operacao', name='transacao_data_liquidacao_valida'),
    sa.CheckConstraint('impostos >= 0', name='transacao_impostos_positivos'),
    sa.CheckConstraint('preco_unitario > 0', name='transacao_preco_positivo'),
    sa.CheckConstraint('quantidade > 0', name='transacao_quantidade_positiva'),
    sa.CheckConstraint('taxas >= 0', name='transacao_taxas_positivas'),
    sa.CheckConstraint('valor_total > 0', name='transacao_valor_total_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de transa√ß√µes de compra e venda de ativos'
    )
    op.create_index(op.f('ix_transacao_ativo_id'), 'transacao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_transacao_corretora_id'), 'transacao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_transacao_data_liquidacao'), 'transacao', ['data_liquidacao'], unique=False)
    op.create_index(op.f('ix_transacao_data_operacao'), 'transacao', ['data_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_tipo_operacao'), 'transacao', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_usuario_id'), 'transacao', ['usuario_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_transacao_usuario_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_tipo_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_liquidacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_corretora_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_ativo_id'), table_name='transacao')
    op.drop_table('transacao')
    op.drop_index(op.f('ix_posicao_usuario_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_ultima_atualizacao'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_primeira_compra'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_corretora_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_ativo_id'), table_name='posicao')
    op.drop_table('posicao')
    op.drop_index(op.f('ix_movimentacao_caixa_usuario_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_provento_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_moeda'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_data_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), table_name='movimentacao_caixa')
    op.drop_table('movimentacao_caixa')
    op.drop_index(op.f('ix_provento_tipo_provento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_pagamento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_com'), table_name='provento')
    op.drop_index(op.f('ix_provento_ativo_id'), table_name='provento')
    op.drop_table('provento')
    op.drop_index(op.f('ix_log_auditoria_usuario_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_timestamp'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_sucesso'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_ip_address'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_acao'), table_name='log_auditoria')
    op.drop_table('log_auditoria')
    op.drop_index(op.f('ix_evento_corporativo_tipo_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_impacto_posicoes'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_com'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_novo_id'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_id'), table_name='evento_corporativo')
    op.drop_table('evento_corporativo')
    op.drop_index(op.f('ix_corretora_usuario_id'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_tipo'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_pais'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_nome'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_moeda_padrao'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_ativa'), table_name='corretora')
    op.drop_table('corretora')
    op.drop_index(op.f('ix_usuario_username'), table_name='usuario')
    op.drop_index(op.f('ix_usuario_email'), table_name='usuario')
    op.drop_table('usuario')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_inicio'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_fim'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_operacao'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_ativo'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_pais'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_incide_sobre'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_ativa'), table_name='regra_fiscal')
    op.drop_table('regra_fiscal')
    op.drop_index(op.f('ix_fonte_dados_ultima_consulta'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_tipo_fonte'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_prioridade'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_nome'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_ativa'), table_name='fonte_dados')
    op.drop_table('fonte_dados')
    op.drop_index(op.f('ix_feriado_mercado_tipo_feriado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_recorrente'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_pais'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_mercado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_data_feriado'), table_name='feriado_mercado')
    op.drop_table('feriado_mercado')
    op.drop_index(op.f('ix_ativo_tipo'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ticker'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_nome'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_moeda'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_mercado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_deslistado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_data_ultima_cotacao'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_classe'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ativo'), table_name='ativo')
    op.drop_table('ativo')
    # ### end Alembic commands ###

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - M√≥dulo 2 Backend API REST - Application Factory"""

from flask import Flask
from flask_cors import CORS
from flask_jwt_extended import JWTManager
from .config import Config
from .database import init_db

def create_app(testing=False):
    """
    Factory para criar a aplica√ß√£o Flask do Exitus Backend.
    
    Args:
        testing (bool): Modo de teste (configura√ß√µes espec√≠ficas)
    
    Returns:
        Flask: Aplica√ß√£o Flask configurada
    """
    app = Flask(__name__)
    
    # Carregar configura√ß√µes
    app.config.from_object(Config)
    
    # Configura√ß√µes adicionais para JWT
    app.config['JWT_SECRET_KEY'] = app.config.get('SECRET_KEY', 'super-secret-key-mudar-no-env')
    app.config['JWT_ACCESS_TOKEN_EXPIRES'] = 3600  # 1 hora
    app.config['JWT_REFRESH_TOKEN_EXPIRES'] = 2592000  # 30 dias
    
    # Inicializar extens√µes
    jwt = JWTManager(app)
    cors = CORS(app, resources={
        r"/api/*": {
            "origins": ["http://localhost:8080", "http://127.0.0.1:8080"],
            "methods": ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
            "allow_headers": ["Content-Type", "Authorization", "X-Requested-With"]
        }
    })
    
    # Inicializar banco de dados
    init_db(app)
    
    # Health check b√°sico (M√≥dulo 1 + M√≥dulo 2)
    @app.route('/health')
    def health():
        return {
            "env": app.config.get('FLASK_ENV', 'development'),
            "service": "exitus-backend",
            "status": "ok",
            "module": "2 - API REST"
        }
    
    # ‚≠ê Registrar blueprints
    # Blueprint de autentica√ß√£o (Fase 2.1)
    from .blueprints.auth.routes import bp as auth_bp
    app.register_blueprint(auth_bp)
    
    # Blueprint de usu√°rios (Fase 2.2.1)
    from .blueprints.usuarios.routes import bp as usuarios_bp
    app.register_blueprint(usuarios_bp)
    
    # Blueprint de corretoras (Fase 2.2.2)
    from .blueprints.corretoras.routes import bp as corretoras_bp
    app.register_blueprint(corretoras_bp)
    
    # Blueprint de ativos (Fase 2.2.3)
    from .blueprints.ativos.routes import bp as ativos_bp
    app.register_blueprint(ativos_bp)
    
    # Blueprint de transa√ß√µes (Fase 2.2.4)
    from .blueprints.transacoes.routes import bp as transacoes_bp
    app.register_blueprint(transacoes_bp)
    
    # Outros blueprints ser√£o adicionados gradualmente nas pr√≥ximas fases
    from .blueprints.posicoes.routes import bp as posicoes_bp
    app.register_blueprint(posicoes_bp)

    # Blueprint de proventos (M√≥dulo 3 - Fase 2)
    from .blueprints.proventos.routes import bp as proventos_bp
    app.register_blueprint(proventos_bp)

    # Blueprint de movimentacoes (M√≥dulo 3 - Fase 3)
    from .blueprints.movimentacoes.routes import bp as movimentacoes_bp
    app.register_blueprint(movimentacoes_bp)

    # Blueprint de eventos (M√≥dulo 3 - Fase 4)
    from .blueprints.eventos.routes import bp as eventos_bp
    app.register_blueprint(eventos_bp)
    
    print("üöÄ Exitus Backend M√≥dulo 2 - Application Factory criada com sucesso!")
    print(f"üìç Environment: {app.config.get('FLASK_ENV')}")
    print(f"üîê JWT Secret configurado: {'*' * 16}")
    print(f"üåê CORS configurado para: http://localhost:8080")
    print(f"‚úÖ Blueprints registrados: auth, usuarios, corretoras, ativos, transacoes")
    
    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py.mod1.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config
from .database import init_db


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)
    
    # Inicializa banco de dados
    init_db(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__kk ---


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/ativos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/ativos/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativos Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from app.services.ativo_service import AtivoService
from app.schemas.ativo_schema import (
    AtivoCreateSchema, AtivoUpdateSchema, AtivoResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden
from app.utils.decorators import admin_required

bp = Blueprint('ativos', __name__, url_prefix='/api/ativos')

@bp.route('', methods=['GET'])
@jwt_required()
def list_ativos():
    """Lista ativos com filtros"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativo = request.args.get('ativo', type=lambda x: x.lower() == 'true')
    tipo = request.args.get('tipo', type=str)
    classe = request.args.get('classe', type=str)
    mercado = request.args.get('mercado', type=str)
    deslistado = request.args.get('deslistado', type=lambda x: x.lower() == 'true')
    search = request.args.get('search', type=str)
    
    pagination = AtivoService.get_all(page, per_page, ativo, tipo, classe, mercado, deslistado, search)
    
    return success({
        "ativos": AtivoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de ativos")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_ativo(id):
    """Buscar ativo por ID"""
    ativo = AtivoService.get_by_id(id)
    
    if not ativo:
        return not_found("Ativo n√£o encontrado")
    
    return success(AtivoResponseSchema().dump(ativo), "Dados do ativo")

@bp.route('/ticker/<string:ticker>', methods=['GET'])
@jwt_required()
def get_by_ticker(ticker):
    """Buscar ativo por ticker e mercado"""
    mercado = request.args.get('mercado', 'BR', type=str)
    ativo = AtivoService.get_by_ticker(ticker, mercado)
    
    if not ativo:
        return not_found(f"Ativo {ticker} n√£o encontrado no mercado {mercado}")
    
    return success(AtivoResponseSchema().dump(ativo), "Dados do ativo")

@bp.route('', methods=['POST'])
@admin_required
def create_ativo():
    """Criar novo ativo (admin only)"""
    try:
        data = AtivoCreateSchema().load(request.json)
        ativo = AtivoService.create(data)
        return success(
            AtivoResponseSchema().dump(ativo),
            "Ativo criado com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar ativo: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@admin_required
def update_ativo(id):
    """Atualizar ativo (admin only)"""
    try:
        data = AtivoUpdateSchema().load(request.json)
        ativo = AtivoService.update(id, data)
        return success(AtivoResponseSchema().dump(ativo), "Ativo atualizado")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@admin_required
def delete_ativo(id):
    """Deletar ativo (admin only)"""
    try:
        AtivoService.delete(id)
        return success(None, "Ativo deletado com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/mercado/<string:mercado>', methods=['GET'])
@jwt_required()
def list_by_mercado(mercado):
    """Listar ativos de um mercado espec√≠fico"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 50, type=int)
    
    pagination = AtivoService.get_by_mercado(mercado, page, per_page)
    
    return success({
        "mercado": mercado.upper(),
        "ativos": AtivoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page
    }, f"Ativos do mercado {mercado.upper()}")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/auth/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/auth/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Blueprint - Endpoints de autentica√ß√£o"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt
from app.services.auth_service import AuthService
from app.schemas.auth_schema import LoginSchema, TokenResponseSchema, UserMeSchema
from app.utils.responses import success, error, unauthorized
from app.utils.decorators import admin_required  # ‚Üê NOVO IMPORT
from app.models import Usuario  # ‚Üê NOVO IMPORT
from app.database import db

bp = Blueprint('auth', __name__, url_prefix='/api/auth')

@bp.route('/login', methods=['POST'])
def login():
    """Login e gera√ß√£o de tokens JWT."""
    try:
        data = LoginSchema().load(request.json)
        tokens = AuthService.login(data['username'], data['password'])
        return success(tokens, "Login realizado com sucesso", 200)
    except ValueError as e:
        return unauthorized(str(e))
    except Exception as e:
        return error(f"Erro no login: {str(e)}", 500)

@bp.route('/refresh', methods=['POST'])
@jwt_required(refresh=True)
def refresh():
    """Refresh do access_token."""
    identity = get_jwt_identity()
    tokens = AuthService.refresh(identity)
    return success(tokens, "Token renovado com sucesso", 200)

@bp.route('/me', methods=['GET'])
@jwt_required()
def me():
    """Dados do usu√°rio autenticado."""
    identity = get_jwt_identity()
    user = Usuario.query.get(identity)
    if not user:
        return unauthorized("Usu√°rio n√£o encontrado")
    return success(UserMeSchema().dump(user), "Dados do usu√°rio")

@bp.route('/me/admin', methods=['GET'])
@admin_required  # ‚Üê NOVO: Apenas ADMIN pode acessar
def me_admin():
    """Endpoint de teste - apenas para ADMIN."""
    identity = get_jwt_identity()
    user = Usuario.query.get(identity)
    return success({
        "message": "Voc√™ √© um administrador!",
        "user": UserMeSchema().dump(user)
    }, "Acesso ADMIN confirmado")

@bp.route('/logout', methods=['POST'])
@jwt_required(refresh=True)
def logout():
    """Logout - invalida refresh token (implementa√ß√£o b√°sica)."""
    return success({"message": "Logout realizado com sucesso"}, 200)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/corretoras/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/corretoras/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretoras Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from app.services.corretora_service import CorretoraService
from app.schemas.corretora_schema import (
    CorretoraCreateSchema, CorretoraUpdateSchema, CorretoraResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden

bp = Blueprint('corretoras', __name__, url_prefix='/api/corretoras')

@bp.route('', methods=['GET'])
@jwt_required()
def list_corretoras():
    """Lista corretoras do usu√°rio autenticado"""
    usuario_id = get_jwt_identity()
    
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativa = request.args.get('ativa', type=lambda x: x.lower() == 'true')
    tipo = request.args.get('tipo', type=str)
    pais = request.args.get('pais', type=str)
    search = request.args.get('search', type=str)
    
    pagination = CorretoraService.get_all(usuario_id, page, per_page, ativa, tipo, pais, search)
    
    return success({
        "corretoras": CorretoraResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de corretoras")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_corretora(id):
    """Buscar corretora por ID"""
    usuario_id = get_jwt_identity()
    corretora = CorretoraService.get_by_id(id, usuario_id)
    
    if not corretora:
        return not_found("Corretora n√£o encontrada")
    
    return success(CorretoraResponseSchema().dump(corretora), "Dados da corretora")

@bp.route('', methods=['POST'])
@jwt_required()
def create_corretora():
    """Criar nova corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        data = CorretoraCreateSchema().load(request.json)
        corretora = CorretoraService.create(data, usuario_id)
        return success(
            CorretoraResponseSchema().dump(corretora),
            "Corretora criada com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar corretora: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_corretora(id):
    """Atualizar corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        data = CorretoraUpdateSchema().load(request.json)
        corretora = CorretoraService.update(id, data, usuario_id)
        return success(CorretoraResponseSchema().dump(corretora), "Corretora atualizada")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@jwt_required()
def delete_corretora(id):
    """Deletar corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        CorretoraService.delete(id, usuario_id)
        return success(None, "Corretora deletada com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/saldo-total', methods=['GET'])
@jwt_required()
def saldo_total():
    """Saldo total do usu√°rio em determinada moeda"""
    usuario_id = get_jwt_identity()
    moeda = request.args.get('moeda', 'BRL', type=str)
    
    total = CorretoraService.get_saldo_total(usuario_id, moeda)
    
    return success({
        "moeda": moeda.upper(),
        "saldo_total": str(total)
    }, "Saldo total calculado")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/evento_corporativo_blueprint.py ---
# -*- coding: utf-8 -*-
"""
Exitus - EventoCorporativo Blueprint
Rotas para gerenciamento de eventos corporativos
"""

from flask import Blueprint, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.evento_corporativo_service import EventoCorporativoService
from app.schemas.evento_corporativo_schema import (
    EventoCorporativoCreateSchema,
    EventoCorporativoUpdateSchema,
    EventoCorporativoResponseSchema
)
from app.utils.responses import success_response, error_response
from app.decorators import admin_required
from marshmallow import ValidationError
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

evento_corporativo_bp = Blueprint('evento_corporativo', __name__, url_prefix='/api/eventos-corporativos')

# Schemas
evento_create_schema = EventoCorporativoCreateSchema()
evento_update_schema = EventoCorporativoUpdateSchema()
evento_schema = EventoCorporativoResponseSchema()
eventos_schema = EventoCorporativoResponseSchema(many=True)


@evento_corporativo_bp.route('', methods=['GET'])
@jwt_required()
def listar_eventos():
    """Lista eventos corporativos com filtros"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        filters = {}
        if request.args.get('ativo_id'):
            filters['ativo_id'] = request.args.get('ativo_id')
        if request.args.get('tipo_evento'):
            filters['tipo_evento'] = request.args.get('tipo_evento')
        if request.args.get('data_anuncio_inicio'):
            filters['data_anuncio_inicio'] = datetime.strptime(
                request.args.get('data_anuncio_inicio'), '%Y-%m-%d'
            ).date()
        if request.args.get('data_anuncio_fim'):
            filters['data_anuncio_fim'] = datetime.strptime(
                request.args.get('data_anuncio_fim'), '%Y-%m-%d'
            ).date()
        
        paginacao = EventoCorporativoService.get_all(page, per_page, filters)
        
        return success_response(
            data={
                'eventos': eventos_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} eventos encontrados"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar eventos: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/<uuid:evento_id>', methods=['GET'])
@jwt_required()
def buscar_evento(evento_id):
    """Busca evento por ID"""
    try:
        evento = EventoCorporativoService.get_by_id(evento_id)
        
        if not evento:
            return error_response("Evento n√£o encontrado", 404)
        
        return success_response(
            data=evento_schema.dump(evento),
            message="Evento encontrado"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar evento: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('', methods=['POST'])
@admin_required()
def criar_evento():
    """Cria novo evento corporativo (ADMIN)"""
    try:
        data = evento_create_schema.load(request.get_json())
        evento = EventoCorporativoService.create(data)
        
        return success_response(
            data=evento_schema.dump(evento),
            message="Evento criado com sucesso",
            status_code=201
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 400)
    except Exception as e:
        logger.error(f"Erro ao criar evento: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/<uuid:evento_id>', methods=['PUT'])
@admin_required()
def atualizar_evento(evento_id):
    """Atualiza evento corporativo (ADMIN)"""
    try:
        data = evento_update_schema.load(request.get_json())
        evento = EventoCorporativoService.update(evento_id, data)
        
        return success_response(
            data=evento_schema.dump(evento),
            message="Evento atualizado com sucesso"
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao atualizar evento: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/<uuid:evento_id>', methods=['DELETE'])
@admin_required()
def deletar_evento(evento_id):
    """Deleta evento corporativo (ADMIN)"""
    try:
        EventoCorporativoService.delete(evento_id)
        return success_response(message="Evento deletado com sucesso")
        
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao deletar evento: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/ativo/<uuid:ativo_id>', methods=['GET'])
@jwt_required()
def eventos_por_ativo(ativo_id):
    """Lista eventos de um ativo"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        paginacao = EventoCorporativoService.get_por_ativo(ativo_id, page, per_page)
        
        return success_response(
            data={
                'eventos': eventos_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} eventos encontrados"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar eventos por ativo: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/meus-eventos', methods=['GET'])
@jwt_required()
def meus_eventos():
    """Lista eventos que afetam as posi√ß√µes do usu√°rio"""
    try:
        usuario_id = get_jwt_identity()
        
        data_inicio = None
        data_fim = None
        
        if request.args.get('data_inicio'):
            data_inicio = datetime.strptime(request.args.get('data_inicio'), '%Y-%m-%d').date()
        if request.args.get('data_fim'):
            data_fim = datetime.strptime(request.args.get('data_fim'), '%Y-%m-%d').date()
        
        eventos = EventoCorporativoService.get_eventos_usuario(usuario_id, data_inicio, data_fim)
        
        return success_response(
            data={'eventos': eventos, 'total': len(eventos)},
            message=f"{len(eventos)} eventos encontrados"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar eventos do usu√°rio: {e}")
        return error_response(str(e), 500)


@evento_corporativo_bp.route('/<uuid:evento_id>/aplicar-split', methods=['POST'])
@jwt_required()
def aplicar_split(evento_id):
    """Aplica desdobramento/grupamento nas posi√ß√µes do usu√°rio"""
    try:
        usuario_id = get_jwt_identity()
        resultado = EventoCorporativoService.aplicar_evento_split(evento_id, usuario_id)
        
        return success_response(
            data=resultado,
            message=f"Evento aplicado a {resultado['posicoes_afetadas']} posi√ß√µes"
        )
        
    except ValueError as e:
        return error_response(str(e), 400)
    except Exception as e:
        logger.error(f"Erro ao aplicar evento: {e}")
        return error_response(str(e), 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/eventos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/eventos/routes.py ---
"""Exitus - Blueprint Eventos - M√≥dulo 3"""

from flask import Blueprint, jsonify

bp = Blueprint('eventos', __name__, url_prefix='/api/eventos')

@bp.route('', methods=['GET'])
def list_eventos():
    """Lista todos os eventos corporativos"""
    return jsonify({
        "success": True,
        "message": "Lista de eventos corporativos",
        "data": {
            "eventos": [],
            "total": 0
        }
    }), 200

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/feriados/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/feriados/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/fontes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/fontes/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/movimentacao_caixa_blueprint.py ---
# -*- coding: utf-8 -*-
"""
Exitus - MovimentacaoCaixa Blueprint
Rotas para gerenciamento de movimenta√ß√µes de caixa
"""

from flask import Blueprint, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.movimentacao_caixa_service import MovimentacaoCaixaService
from app.schemas.movimentacao_caixa_schema import (
    MovimentacaoCaixaCreateSchema,
    MovimentacaoCaixaUpdateSchema,
    MovimentacaoCaixaResponseSchema
)
from app.utils.responses import success_response, error_response
from marshmallow import ValidationError
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

movimentacao_caixa_bp = Blueprint('movimentacao_caixa', __name__, url_prefix='/api/movimentacoes-caixa')

# Schemas
movimentacao_create_schema = MovimentacaoCaixaCreateSchema()
movimentacao_update_schema = MovimentacaoCaixaUpdateSchema()
movimentacao_schema = MovimentacaoCaixaResponseSchema()
movimentacoes_schema = MovimentacaoCaixaResponseSchema(many=True)


@movimentacao_caixa_bp.route('', methods=['GET'])
@jwt_required()
def listar_movimentacoes():
    """Lista movimenta√ß√µes de caixa do usu√°rio"""
    try:
        usuario_id = get_jwt_identity()
        
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        filters = {}
        if request.args.get('corretora_id'):
            filters['corretora_id'] = request.args.get('corretora_id')
        if request.args.get('tipo_movimentacao'):
            filters['tipo_movimentacao'] = request.args.get('tipo_movimentacao')
        if request.args.get('data_inicio'):
            filters['data_inicio'] = datetime.strptime(request.args.get('data_inicio'), '%Y-%m-%d').date()
        if request.args.get('data_fim'):
            filters['data_fim'] = datetime.strptime(request.args.get('data_fim'), '%Y-%m-%d').date()
        if request.args.get('moeda'):
            filters['moeda'] = request.args.get('moeda')
        
        paginacao = MovimentacaoCaixaService.get_all(usuario_id, page, per_page, filters)
        
        return success_response(
            data={
                'movimentacoes': movimentacoes_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} movimenta√ß√µes encontradas"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar movimenta√ß√µes: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('/<uuid:movimentacao_id>', methods=['GET'])
@jwt_required()
def buscar_movimentacao(movimentacao_id):
    """Busca movimenta√ß√£o por ID"""
    try:
        usuario_id = get_jwt_identity()
        movimentacao = MovimentacaoCaixaService.get_by_id(movimentacao_id, usuario_id)
        
        if not movimentacao:
            return error_response("Movimenta√ß√£o n√£o encontrada", 404)
        
        return success_response(
            data=movimentacao_schema.dump(movimentacao),
            message="Movimenta√ß√£o encontrada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar movimenta√ß√£o: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('', methods=['POST'])
@jwt_required()
def criar_movimentacao():
    """Cria nova movimenta√ß√£o de caixa"""
    try:
        usuario_id = get_jwt_identity()
        data = movimentacao_create_schema.load(request.get_json())
        
        movimentacao = MovimentacaoCaixaService.create(usuario_id, data)
        
        return success_response(
            data=movimentacao_schema.dump(movimentacao),
            message="Movimenta√ß√£o criada com sucesso",
            status_code=201
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 400)
    except Exception as e:
        logger.error(f"Erro ao criar movimenta√ß√£o: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('/<uuid:movimentacao_id>', methods=['PUT'])
@jwt_required()
def atualizar_movimentacao(movimentacao_id):
    """Atualiza movimenta√ß√£o de caixa"""
    try:
        usuario_id = get_jwt_identity()
        data = movimentacao_update_schema.load(request.get_json())
        
        movimentacao = MovimentacaoCaixaService.update(movimentacao_id, usuario_id, data)
        
        return success_response(
            data=movimentacao_schema.dump(movimentacao),
            message="Movimenta√ß√£o atualizada com sucesso"
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao atualizar movimenta√ß√£o: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('/<uuid:movimentacao_id>', methods=['DELETE'])
@jwt_required()
def deletar_movimentacao(movimentacao_id):
    """Deleta movimenta√ß√£o de caixa"""
    try:
        usuario_id = get_jwt_identity()
        MovimentacaoCaixaService.delete(movimentacao_id, usuario_id)
        
        return success_response(message="Movimenta√ß√£o deletada com sucesso")
        
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao deletar movimenta√ß√£o: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('/saldo/<uuid:corretora_id>', methods=['GET'])
@jwt_required()
def saldo_corretora(corretora_id):
    """Retorna saldo consolidado de uma corretora"""
    try:
        usuario_id = get_jwt_identity()
        saldos = MovimentacaoCaixaService.get_saldo_corretora(usuario_id, corretora_id)
        
        return success_response(
            data={'saldos': saldos},
            message="Saldo calculado"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular saldo: {e}")
        return error_response(str(e), 500)


@movimentacao_caixa_bp.route('/extrato', methods=['GET'])
@jwt_required()
def extrato():
    """Gera extrato de movimenta√ß√µes"""
    try:
        usuario_id = get_jwt_identity()
        
        corretora_id = request.args.get('corretora_id')
        data_inicio = None
        data_fim = None
        
        if request.args.get('data_inicio'):
            data_inicio = datetime.strptime(request.args.get('data_inicio'), '%Y-%m-%d').date()
        if request.args.get('data_fim'):
            data_fim = datetime.strptime(request.args.get('data_fim'), '%Y-%m-%d').date()
        
        extrato = MovimentacaoCaixaService.get_extrato(usuario_id, corretora_id, data_inicio, data_fim)
        
        return success_response(
            data={'extrato': extrato, 'total': len(extrato)},
            message="Extrato gerado"
        )
        
    except Exception as e:
        logger.error(f"Erro ao gerar extrato: {e}")
        return error_response(str(e), 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/movimentacoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/movimentacoes/routes.py ---
"""Exitus - Blueprint Movimentacoes - M√≥dulo 3"""

from flask import Blueprint, jsonify

bp = Blueprint('movimentacoes', __name__, url_prefix='/api/movimentacoes')

@bp.route('', methods=['GET'])
def list_movimentacoes():
    """Lista todas as movimenta√ß√µes de caixa"""
    return jsonify({
        "success": True,
        "message": "Lista de movimenta√ß√µes",
        "data": {
            "movimentacoes": [],
            "total": 0
        }
    }), 200

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/portfolio_blueprint.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Portfolio Blueprint
Rotas para analytics de portf√≥lio
"""

from flask import Blueprint, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.portfolio_service import PortfolioService
from app.utils.responses import success_response, error_response
import logging

logger = logging.getLogger(__name__)

portfolio_bp = Blueprint('portfolio', __name__, url_prefix='/api/portfolio')


@portfolio_bp.route('/dashboard', methods=['GET'])
@jwt_required()
def dashboard():
    """Retorna dashboard completo do portf√≥lio"""
    try:
        usuario_id = get_jwt_identity()
        dados = PortfolioService.get_dashboard(usuario_id)
        
        return success_response(
            data=dados,
            message="Dashboard gerado com sucesso"
        )
        
    except Exception as e:
        logger.error(f"Erro ao gerar dashboard: {e}")
        return error_response(str(e), 500)


@portfolio_bp.route('/distribuicao/classes', methods=['GET'])
@jwt_required()
def distribuicao_classes():
    """Retorna distribui√ß√£o por classe de ativo"""
    try:
        usuario_id = get_jwt_identity()
        distribuicao = PortfolioService.get_distribuicao_classes(usuario_id)
        
        return success_response(
            data=distribuicao,
            message="Distribui√ß√£o por classes calculada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular distribui√ß√£o: {e}")
        return error_response(str(e), 500)


@portfolio_bp.route('/distribuicao/setores', methods=['GET'])
@jwt_required()
def distribuicao_setores():
    """Retorna distribui√ß√£o por setor"""
    try:
        usuario_id = get_jwt_identity()
        distribuicao = PortfolioService.get_distribuicao_setores(usuario_id)
        
        return success_response(
            data={'setores': distribuicao},
            message="Distribui√ß√£o por setores calculada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular distribui√ß√£o: {e}")
        return error_response(str(e), 500)


@portfolio_bp.route('/evolucao', methods=['GET'])
@jwt_required()
def evolucao_patrimonio():
    """Retorna evolu√ß√£o do patrim√¥nio ao longo do tempo"""
    try:
        usuario_id = get_jwt_identity()
        meses = request.args.get('meses', 12, type=int)
        
        if meses < 1 or meses > 60:
            return error_response("Meses deve estar entre 1 e 60", 400)
        
        evolucao = PortfolioService.get_evolucao_patrimonio(usuario_id, meses)
        
        return success_response(
            data={'evolucao': evolucao},
            message=f"Evolu√ß√£o de {meses} meses calculada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular evolu√ß√£o: {e}")
        return error_response(str(e), 500)


@portfolio_bp.route('/metricas-risco', methods=['GET'])
@jwt_required()
def metricas_risco():
    """Retorna m√©tricas de risco do portf√≥lio"""
    try:
        usuario_id = get_jwt_identity()
        metricas = PortfolioService.get_metricas_risco(usuario_id)
        
        return success_response(
            data=metricas,
            message="M√©tricas de risco calculadas"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular m√©tricas: {e}")
        return error_response(str(e), 500)


@portfolio_bp.route('/performance', methods=['GET'])
@jwt_required()
def performance_ativos():
    """Retorna performance individual de cada ativo"""
    try:
        usuario_id = get_jwt_identity()
        performance = PortfolioService.get_performance_ativos(usuario_id)
        
        return success_response(
            data={'ativos': performance, 'total': len(performance)},
            message="Performance calculada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular performance: {e}")
        return error_response(str(e), 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/posicao_blueprint.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Posicao Blueprint
Rotas para gerenciamento de posi√ß√µes
"""

from flask import Blueprint, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.posicao_service import PosicaoService
from app.schemas.posicao_schema import (
    PosicaoResponseSchema, 
    PosicaoResumoSchema,
    PosicaoConsolidadaSchema
)
from app.utils.responses import success_response, error_response
from app.decorators import admin_required
import logging

logger = logging.getLogger(__name__)

posicao_bp = Blueprint('posicao', __name__, url_prefix='/api/posicoes')

# Schemas
posicao_schema = PosicaoResponseSchema()
posicoes_schema = PosicaoResponseSchema(many=True)
resumo_schema = PosicaoResumoSchema()
consolidada_schema = PosicaoConsolidadaSchema()


@posicao_bp.route('', methods=['GET'])
@jwt_required()
def listar_posicoes():
    """
    Lista posi√ß√µes do usu√°rio com filtros e pagina√ß√£o
    
    Query Params:
        - page (int): P√°gina atual (default: 1)
        - per_page (int): Registros por p√°gina (default: 50, max: 100)
        - ativo_id (UUID): Filtrar por ativo
        - corretora_id (UUID): Filtrar por corretora
        - ticker (str): Buscar por ticker
        - lucro_positivo (bool): Filtrar por lucro > 0
        - quantidade_min (float): Quantidade m√≠nima
    """
    try:
        usuario_id = get_jwt_identity()
        
        # Par√¢metros de pagina√ß√£o
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        # Filtros
        filters = {}
        if request.args.get('ativo_id'):
            filters['ativo_id'] = request.args.get('ativo_id')
        if request.args.get('corretora_id'):
            filters['corretora_id'] = request.args.get('corretora_id')
        if request.args.get('ticker'):
            filters['ticker'] = request.args.get('ticker')
        if request.args.get('lucro_positivo') is not None:
            filters['lucro_positivo'] = request.args.get('lucro_positivo', type=bool)
        if request.args.get('quantidade_min'):
            filters['quantidade_min'] = request.args.get('quantidade_min', type=float)
        
        # Buscar posi√ß√µes
        paginacao = PosicaoService.get_all(usuario_id, page, per_page, filters)
        
        return success_response(
            data={
                'posicoes': posicoes_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'per_page': paginacao.per_page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} posi√ß√µes encontradas"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar posi√ß√µes: {e}")
        return error_response(str(e), 500)


@posicao_bp.route('/<uuid:posicao_id>', methods=['GET'])
@jwt_required()
def buscar_posicao(posicao_id):
    """Busca posi√ß√£o por ID"""
    try:
        usuario_id = get_jwt_identity()
        posicao = PosicaoService.get_by_id(posicao_id, usuario_id)
        
        if not posicao:
            return error_response("Posi√ß√£o n√£o encontrada", 404)
        
        return success_response(
            data=posicao_schema.dump(posicao),
            message="Posi√ß√£o encontrada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar posi√ß√£o: {e}")
        return error_response(str(e), 500)


@posicao_bp.route('/calcular', methods=['POST'])
@jwt_required()
def calcular_posicoes():
    """
    Recalcula todas as posi√ß√µes do usu√°rio a partir das transa√ß√µes
    """
    try:
        usuario_id = get_jwt_identity()
        resultado = PosicaoService.calcular_posicoes(usuario_id)
        
        return success_response(
            data=resultado,
            message="Posi√ß√µes recalculadas com sucesso"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular posi√ß√µes: {e}")
        return error_response(str(e), 500)


@posicao_bp.route('/resumo', methods=['GET'])
@jwt_required()
def resumo_posicoes():
    """Retorna resumo consolidado das posi√ß√µes"""
    try:
        usuario_id = get_jwt_identity()
        resumo = PosicaoService.get_resumo(usuario_id)
        
        return success_response(
            data=resumo_schema.dump(resumo),
            message="Resumo gerado com sucesso"
        )
        
    except Exception as e:
        logger.error(f"Erro ao gerar resumo: {e}")
        return error_response(str(e), 500)


@posicao_bp.route('/por-ativo/<uuid:ativo_id>', methods=['GET'])
@jwt_required()
def posicao_por_ativo(ativo_id):
    """Consolida posi√ß√µes de um ativo em todas as corretoras"""
    try:
        usuario_id = get_jwt_identity()
        consolidada = PosicaoService.get_por_ativo(usuario_id, ativo_id)
        
        if not consolidada:
            return error_response("Nenhuma posi√ß√£o encontrada para este ativo", 404)
        
        return success_response(
            data=consolidada_schema.dump(consolidada),
            message="Posi√ß√£o consolidada"
        )
        
    except Exception as e:
        logger.error(f"Erro ao consolidar posi√ß√£o: {e}")
        return error_response(str(e), 500)


@posicao_bp.route('/atualizar-valores', methods=['POST'])
@jwt_required()
def atualizar_valores():
    """Atualiza valores de mercado de todas as posi√ß√µes"""
    try:
        usuario_id = get_jwt_identity()
        quantidade = PosicaoService.atualizar_valores_atuais(usuario_id)
        
        return success_response(
            data={'posicoes_atualizadas': quantidade},
            message=f"{quantidade} posi√ß√µes atualizadas"
        )
        
    except Exception as e:
        logger.error(f"Erro ao atualizar valores: {e}")
        return error_response(str(e), 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/posicoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/posicoes/routes.py ---
"""Exitus - Blueprint Posicoes - M√≥dulo 3"""

from flask import Blueprint, jsonify

bp = Blueprint('posicoes', __name__, url_prefix='/api/posicoes')

@bp.route('', methods=['GET'])
def list_posicoes():
    """Lista todas as posi√ß√µes do usu√°rio"""
    return jsonify({
        "success": True,
        "message": "Lista de posi√ß√µes",
        "data": {
            "posicoes": [],
            "total": 0
        }
    }), 200

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/provento_blueprint.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Provento Blueprint
Rotas para gerenciamento de proventos
"""

from flask import Blueprint, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.provento_service import ProventoService
from app.schemas.provento_schema import (
    ProventoCreateSchema, 
    ProventoUpdateSchema,
    ProventoResponseSchema
)
from app.utils.responses import success_response, error_response
from app.decorators import admin_required
from marshmallow import ValidationError
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

provento_bp = Blueprint('provento', __name__, url_prefix='/api/proventos')

# Schemas
provento_create_schema = ProventoCreateSchema()
provento_update_schema = ProventoUpdateSchema()
provento_schema = ProventoResponseSchema()
proventos_schema = ProventoResponseSchema(many=True)


@provento_bp.route('', methods=['GET'])
@jwt_required()
def listar_proventos():
    """Lista proventos com filtros"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        filters = {}
        if request.args.get('ativo_id'):
            filters['ativo_id'] = request.args.get('ativo_id')
        if request.args.get('tipo_provento'):
            filters['tipo_provento'] = request.args.get('tipo_provento')
        if request.args.get('data_com_inicio'):
            filters['data_com_inicio'] = datetime.strptime(request.args.get('data_com_inicio'), '%Y-%m-%d').date()
        if request.args.get('data_com_fim'):
            filters['data_com_fim'] = datetime.strptime(request.args.get('data_com_fim'), '%Y-%m-%d').date()
        
        paginacao = ProventoService.get_all(page, per_page, filters)
        
        return success_response(
            data={
                'proventos': proventos_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} proventos encontrados"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar proventos: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/<uuid:provento_id>', methods=['GET'])
@jwt_required()
def buscar_provento(provento_id):
    """Busca provento por ID"""
    try:
        provento = ProventoService.get_by_id(provento_id)
        
        if not provento:
            return error_response("Provento n√£o encontrado", 404)
        
        return success_response(
            data=provento_schema.dump(provento),
            message="Provento encontrado"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar provento: {e}")
        return error_response(str(e), 500)


@provento_bp.route('', methods=['POST'])
@admin_required()
def criar_provento():
    """Cria novo provento (ADMIN)"""
    try:
        data = provento_create_schema.load(request.get_json())
        provento = ProventoService.create(data)
        
        return success_response(
            data=provento_schema.dump(provento),
            message="Provento criado com sucesso",
            status_code=201
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 400)
    except Exception as e:
        logger.error(f"Erro ao criar provento: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/<uuid:provento_id>', methods=['PUT'])
@admin_required()
def atualizar_provento(provento_id):
    """Atualiza provento (ADMIN)"""
    try:
        data = provento_update_schema.load(request.get_json())
        provento = ProventoService.update(provento_id, data)
        
        return success_response(
            data=provento_schema.dump(provento),
            message="Provento atualizado com sucesso"
        )
        
    except ValidationError as e:
        return error_response(e.messages, 400)
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao atualizar provento: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/<uuid:provento_id>', methods=['DELETE'])
@admin_required()
def deletar_provento(provento_id):
    """Deleta provento (ADMIN)"""
    try:
        ProventoService.delete(provento_id)
        return success_response(message="Provento deletado com sucesso")
        
    except ValueError as e:
        return error_response(str(e), 404)
    except Exception as e:
        logger.error(f"Erro ao deletar provento: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/ativo/<uuid:ativo_id>', methods=['GET'])
@jwt_required()
def proventos_por_ativo(ativo_id):
    """Lista proventos de um ativo"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = min(request.args.get('per_page', 50, type=int), 100)
        
        paginacao = ProventoService.get_por_ativo(ativo_id, page, per_page)
        
        return success_response(
            data={
                'proventos': proventos_schema.dump(paginacao.items),
                'total': paginacao.total,
                'page': paginacao.page,
                'pages': paginacao.pages
            },
            message=f"{paginacao.total} proventos encontrados"
        )
        
    except Exception as e:
        logger.error(f"Erro ao listar proventos por ativo: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/recebidos', methods=['GET'])
@jwt_required()
def proventos_recebidos():
    """Lista proventos recebidos pelo usu√°rio"""
    try:
        usuario_id = get_jwt_identity()
        
        data_inicio = None
        data_fim = None
        
        if request.args.get('data_inicio'):
            data_inicio = datetime.strptime(request.args.get('data_inicio'), '%Y-%m-%d').date()
        if request.args.get('data_fim'):
            data_fim = datetime.strptime(request.args.get('data_fim'), '%Y-%m-%d').date()
        
        proventos = ProventoService.get_recebidos_usuario(usuario_id, data_inicio, data_fim)
        
        return success_response(
            data={'proventos': proventos, 'total': len(proventos)},
            message=f"{len(proventos)} proventos recebidos"
        )
        
    except Exception as e:
        logger.error(f"Erro ao buscar proventos recebidos: {e}")
        return error_response(str(e), 500)


@provento_bp.route('/total-recebido', methods=['GET'])
@jwt_required()
def total_proventos_recebidos():
    """Calcula total de proventos recebidos"""
    try:
        usuario_id = get_jwt_identity()
        ativo_id = request.args.get('ativo_id')
        
        total = ProventoService.calcular_total_recebido(usuario_id, ativo_id)
        
        return success_response(
            data=total,
            message="Total de proventos calculado"
        )
        
    except Exception as e:
        logger.error(f"Erro ao calcular total de proventos: {e}")
        return error_response(str(e), 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/proventos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/proventos/routes.py ---
"""Exitus - Blueprint Proventos - M√≥dulo 3"""

from flask import Blueprint, jsonify

bp = Blueprint('proventos', __name__, url_prefix='/api/proventos')

@bp.route('', methods=['GET'])
def list_proventos():
    """Lista todos os proventos do usu√°rio"""
    return jsonify({
        "success": True,
        "message": "Lista de proventos",
        "data": {
            "proventos": [],
            "total": 0
        }
    }), 200

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/regras_fiscais/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/regras_fiscais/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/transacoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/transacoes/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacoes Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from datetime import datetime
from app.services.transacao_service import TransacaoService
from app.schemas.transacao_schema import TransacaoCreateSchema, TransacaoUpdateSchema, TransacaoResponseSchema
from app.utils.responses import success, error, not_found
from uuid import UUID

bp = Blueprint('transacoes', __name__, url_prefix='/api/transacoes')

@bp.route('', methods=['GET'])
@jwt_required()
def list_transacoes():
    """Lista transa√ß√µes do usu√°rio com filtros"""
    usuario_id = get_jwt_identity()
    
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    tipo = request.args.get('tipo', type=str)
    ativo_id = request.args.get('ativo_id', type=str)
    corretora_id = request.args.get('corretora_id', type=str)
    data_inicio = request.args.get('data_inicio', type=str)
    data_fim = request.args.get('data_fim', type=str)
    
    # Converter datas
    try:
        data_inicio = datetime.fromisoformat(data_inicio) if data_inicio else None
        data_fim = datetime.fromisoformat(data_fim) if data_fim else None
    except ValueError:
        return error("Formato de data inv√°lido. Use ISO 8601 (YYYY-MM-DD)", 400)
    
    pagination = TransacaoService.get_all(
        usuario_id, page, per_page, tipo, ativo_id, corretora_id, data_inicio, data_fim
    )
    
    return success({
        "transacoes": TransacaoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de transa√ß√µes")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_transacao(id):
    """Buscar transa√ß√£o por ID"""
    usuario_id = get_jwt_identity()
    
    transacao = TransacaoService.get_by_id(id, usuario_id)
    if not transacao:
        return not_found("Transa√ß√£o n√£o encontrada")
    
    return success(TransacaoResponseSchema().dump(transacao), "Dados da transa√ß√£o")

@bp.route('', methods=['POST'])
@jwt_required()
def create_transacao():
    """Criar nova transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        data = TransacaoCreateSchema().load(request.json)
        transacao = TransacaoService.create(usuario_id, data)
        return success(
            TransacaoResponseSchema().dump(transacao),
            "Transa√ß√£o criada com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar transa√ß√£o: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_transacao(id):
    """Atualizar transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        data = TransacaoUpdateSchema().load(request.json)
        transacao = TransacaoService.update(id, usuario_id, data)
        return success(TransacaoResponseSchema().dump(transacao), "Transa√ß√£o atualizada")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@jwt_required()
def delete_transacao(id):
    """Deletar transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        TransacaoService.delete(id, usuario_id)
        return success(None, "Transa√ß√£o deletada com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/resumo/<uuid:ativo_id>', methods=['GET'])
@jwt_required()
def get_resumo_ativo(ativo_id):
    """Retorna resumo de transa√ß√µes de um ativo"""
    usuario_id = get_jwt_identity()
    
    resumo = TransacaoService.get_resumo_por_ativo(usuario_id, ativo_id)
    return success(resumo, "Resumo do ativo")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/usuarios/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/usuarios/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuarios Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify, g
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.usuario_service import UsuarioService
from app.schemas.usuario_schema import (
    UsuarioCreateSchema, UsuarioUpdateSchema, 
    ChangePasswordSchema, UsuarioResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden
from app.utils.decorators import admin_required
from app.models import Usuario

bp = Blueprint('usuarios', __name__, url_prefix='/api/usuarios')

@bp.route('', methods=['GET'])
@admin_required
def list_usuarios():
    """Lista usu√°rios (admin only) com pagina√ß√£o e filtros"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativo = request.args.get('ativo', type=lambda x: x.lower() == 'true')
    role = request.args.get('role', type=str)
    search = request.args.get('search', type=str)
    
    pagination = UsuarioService.get_all(page, per_page, ativo, role, search)
    
    return success({
        "usuarios": UsuarioResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de usu√°rios")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_usuario(id):
    """Ver detalhes de usu√°rio (pr√≥prio ou admin)"""
    current_user_id = get_jwt_identity()
    current_user = Usuario.query.get(current_user_id)
    usuario = UsuarioService.get_by_id(id)
    
    if not usuario:
        return not_found("Usu√°rio n√£o encontrado")
    
    # Verifica permiss√£o: pr√≥prio usu√°rio ou admin
    if str(usuario.id) != current_user_id and current_user.role.value.upper() != 'ADMIN':
        return forbidden("Acesso negado")
    
    return success(UsuarioResponseSchema().dump(usuario), "Dados do usu√°rio")

@bp.route('', methods=['POST'])
def create_usuario():
    """Criar usu√°rio (registro p√∫blico)"""
    try:
        data = UsuarioCreateSchema().load(request.json)
        usuario = UsuarioService.create(data)
        return success(
            UsuarioResponseSchema().dump(usuario), 
            "Usu√°rio criado com sucesso", 
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar usu√°rio: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_usuario(id):
    """Atualizar usu√°rio (pr√≥prio ou admin)"""
    current_user_id = get_jwt_identity()
    current_user = Usuario.query.get(current_user_id)
    
    # Verifica permiss√£o
    if str(id) != current_user_id and current_user.role.value.upper() != 'ADMIN':
        return forbidden("Acesso negado")
    
    try:
        data = UsuarioUpdateSchema().load(request.json)
        usuario = UsuarioService.update(id, data, current_user)
        return success(UsuarioResponseSchema().dump(usuario), "Usu√°rio atualizado")
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@admin_required
def delete_usuario(id):
    """Deletar usu√°rio (admin only)"""
    try:
        UsuarioService.delete(id)
        return success(None, "Usu√°rio deletado com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/<uuid:id>/password', methods=['PATCH'])
@jwt_required()
def change_password(id):
    """Trocar senha (pr√≥prio usu√°rio)"""
    current_user_id = get_jwt_identity()
    
    # Apenas o pr√≥prio usu√°rio pode trocar sua senha
    if str(id) != current_user_id:
        return forbidden("Voc√™ s√≥ pode trocar sua pr√≥pria senha")
    
    try:
        data = ChangePasswordSchema().load(request.json)
        UsuarioService.change_password(id, data['old_password'], data['new_password'])
        return success(None, "Senha alterada com sucesso")
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao trocar senha: {str(e)}", 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py ---
# -*- coding: utf-8 -*-
"""Exitus - Database Configuration - SQLAlchemy + PostgreSQL"""

from flask_sqlalchemy import SQLAlchemy

# Inst√¢ncia global do SQLAlchemy
db = SQLAlchemy()

def init_db(app):
    """
    Inicializa o banco de dados com a aplica√ß√£o Flask.

    Args:
        app: Inst√¢ncia Flask
    """
    db.init_app(app)

    # Importar models DEPOIS de db.init_app para evitar circular imports
    with app.app_context():
        # Import APENAS do pacote - o __init__.py j√° importa todos os models
        # na ordem correta para resolver foreign keys
        import app.models

        # Criar todas as tabelas
        # db.create_all() # DESABILITADO - tabelas j√° existem
        print("‚úÖ Banco de dados inicializado e tabelas criadas!")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models (apenas quando existirem)
        # COMENTADO at√© criarmos os models na Fase 2
        # from app.models import (
        #     usuario, corretora, ativo, posicao, transacao,
        #     provento, movimentacao_caixa, evento_corporativo,
        #     fonte_dados, regra_fiscal, feriado_mercado, log_auditoria
        # )
        pass
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/middlewares/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/middlewares/auth_middleware.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Middlewares - Middlewares JWT avan√ßados"""

from functools import wraps
from flask import request, jsonify, g
from flask_jwt_extended import verify_jwt_in_request, get_jwt_identity
from app.database import db
from app.models import Usuario
from app.utils.responses import unauthorized, forbidden

def require_jwt():
    """Middleware: requer JWT v√°lido em todas as rotas protegidas."""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            try:
                verify_jwt_in_request()
                identity = get_jwt_identity()
                g.jwt_identity = identity
                return f(*args, **kwargs)
            except Exception:
                return unauthorized("Token JWT inv√°lido ou expirado"), 401
        return decorated_function
    return decorator

def rate_limit_by_user(max_requests=100):
    """Middleware: rate limiting por usu√°rio (implementa√ß√£o b√°sica)."""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            identity = get_jwt_identity()
            # Implementa√ß√£o simples - pode usar Redis em produ√ß√£o
            request_count = getattr(g, 'request_count', 0)
            g.request_count = request_count + 1
            
            if g.request_count > max_requests:
                return forbidden("Limite de requisi√ß√µes excedido"), 429
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - Models Package - Exporta√ß√£o centralizada"""

from .usuario import Usuario, UserRole
from .corretora import Corretora, TipoCorretora
from .ativo import Ativo, TipoAtivo, ClasseAtivo
from .transacao import Transacao, TipoTransacao

__all__ = [
    'Usuario',
    'UserRole',
    'Corretora',
    'TipoCorretora',
    'Ativo',
    'TipoAtivo',
    'ClasseAtivo',
    'Transacao',
    'TipoTransacao',
]

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/ativo.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Ativo - Entidade para instrumentos financeiros"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
from app.database import db

class TipoAtivo(enum.Enum):
    """Enum para tipos de ativo"""
    ACAO = "acao"
    FII = "fii"
    REIT = "reit"
    BOND = "bond"
    ETF = "etf"
    CRIPTO = "cripto"
    OUTRO = "outro"

class ClasseAtivo(enum.Enum):
    """Enum para classes de ativo"""
    RENDA_VARIAVEL = "renda_variavel"
    RENDA_FIXA = "renda_fixa"
    CRIPTO = "cripto"
    HIBRIDO = "hibrido"

class Ativo(db.Model):
    """Model para ativos financeiros"""
    __tablename__ = 'ativo'  # ‚¨ÖÔ∏è PLURAL
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    ticker = Column(String(20), nullable=False, index=True)
    nome = Column(String(200), nullable=False, index=True)
    tipo = Column(Enum(TipoAtivo), nullable=False, index=True)
    classe = Column(Enum(ClasseAtivo), nullable=False, index=True)
    
    # Mercado
    mercado = Column(String(10), nullable=False, default='BR', index=True)
    moeda = Column(String(3), nullable=False, default='BRL', index=True)
    
    # Cota√ß√£o
    preco_atual = Column(Numeric(18, 6), nullable=True)
    data_ultima_cotacao = Column(DateTime(timezone=True), nullable=True, index=True)
    
    # Indicadores
    dividend_yield = Column(Numeric(8, 4), nullable=True)
    p_l = Column(Numeric(10, 2), nullable=True)
    p_vp = Column(Numeric(10, 2), nullable=True)
    roe = Column(Numeric(8, 4), nullable=True)
    
    # Status
    ativo = Column(Boolean, default=True, nullable=False, index=True)
    deslistado = Column(Boolean, default=False, nullable=False, index=True)
    data_deslistagem = Column(Date, nullable=True)
    
    # Metadados
    observacoes = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def __repr__(self):
        return f"<Ativo {self.ticker} - {self.nome} ({self.mercado})>"
    
    def to_dict(self):
        return {
            "id": str(self.id),
            "ticker": self.ticker,
            "nome": self.nome,
            "tipo": self.tipo.value if self.tipo else None,
            "classe": self.classe.value if self.classe else None,
            "mercado": self.mercado,
            "moeda": self.moeda,
            "preco_atual": str(self.preco_atual) if self.preco_atual else None,
            "data_ultima_cotacao": self.data_ultima_cotacao.isoformat() if self.data_ultima_cotacao else None,
            "dividend_yield": str(self.dividend_yield) if self.dividend_yield else None,
            "p_l": str(self.p_l) if self.p_l else None,
            "p_vp": str(self.p_vp) if self.p_vp else None,
            "roe": str(self.roe) if self.roe else None,
            "ativo": self.ativo,
            "deslistado": self.deslistado,
            "data_deslistagem": self.data_deslistagem.isoformat() if self.data_deslistagem else None,
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/corretora.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Corretora"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Boolean, DateTime, Enum, Numeric, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from app.database import db

class TipoCorretora(enum.Enum):
    """Enum para tipos de corretora"""
    CORRETORA = "corretora"
    EXCHANGE = "exchange"

class Corretora(db.Model):
    """Model para corretoras/exchanges"""
    __tablename__ = 'corretora'  # ‚¨ÖÔ∏è PLURAL
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    usuario_id = Column(UUID(as_uuid=True), ForeignKey('usuario.id', ondelete='CASCADE'), nullable=False, index=True)
    
    # Dados
    nome = Column(String(100), nullable=False, index=True)
    tipo = Column(Enum(TipoCorretora), default=TipoCorretora.CORRETORA, nullable=False, index=True)
    pais = Column(String(2), nullable=False, default='BR', index=True)
    moeda_padrao = Column(String(3), nullable=False, default='BRL', index=True)
    saldo_atual = Column(Numeric(18, 2), default=0.00, nullable=False)
    
    # Status
    ativa = Column(Boolean, default=True, nullable=False, index=True)
    observacoes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # Relationships
    usuario = relationship("Usuario", backref="corretoras", primaryjoin="Corretora.usuario_id == Usuario.id", lazy=True)
    
    def __repr__(self):
        return f"<Corretora {self.nome} ({self.pais})>"
    
    def to_dict(self):
        return {
            "id": str(self.id),
            "usuario_id": str(self.usuario_id),
            "nome": self.nome,
            "tipo": self.tipo.value if self.tipo else None,
            "pais": self.pais,
            "moeda_padrao": self.moeda_padrao,
            "saldo_atual": str(self.saldo_atual),
            "ativa": self.ativa,
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/evento_corporativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model EventoCorporativo
Entidade para eventos corporativos que afetam ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Boolean, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoEventoCorporativo(enum.Enum):
    """Enum para tipos de evento corporativo"""
    SPLIT = "split"                          # Desdobramento (ex: 1 a√ß√£o vira 2)
    GRUPAMENTO = "grupamento"                # Grupamento/Inplit (ex: 10 a√ß√µes viram 1)
    BONIFICACAO = "bonificacao"              # Bonifica√ß√£o em a√ß√µes
    DIREITO_SUBSCRICAO = "direito_sub"       # Direito de subscri√ß√£o
    FUSAO = "fusao"                          # Fus√£o com outra empresa
    CISAO = "cisao"                          # Cis√£o (spin-off)
    INCORPORACAO = "incorporacao"            # Incorpora√ß√£o por outra empresa
    MUDANCA_TICKER = "mudanca_ticker"        # Mudan√ßa de c√≥digo
    DESLISTAGEM = "deslistagem"              # Deslistagem da bolsa
    RELISTING = "relisting"                  # Relistagem
    CANCELAMENTO = "cancelamento"            # Cancelamento de a√ß√µes
    OUTRO = "outro"                          # Outros eventos


class EventoCorporativo(db.Model):
    """
    Model para eventos corporativos que afetam ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo afetado
        tipo_evento (TipoEventoCorporativo): Tipo do evento
        data_evento (date): Data do evento
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        proporcao (str): Propor√ß√£o do evento (ex: "2:1", "1:10")
        ativo_novo_id (UUID): ID do novo ativo (fus√µes, mudan√ßas)
        descricao (str): Descri√ß√£o detalhada do evento
        impacto_posicoes (bool): Indica se posi√ß√µes j√° foram ajustadas
        observacoes (str): Observa√ß√µes adicionais
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo original afetado
        ativo_novo: Novo ativo (para fus√µes, mudan√ßas de ticker)
    """
    
    __tablename__ = 'evento_corporativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do evento"
    )
    
    # Foreign keys
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo afetado pelo evento"
    )
    
    ativo_novo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do novo ativo (fus√µes, mudan√ßas de ticker)"
    )
    
    # Dados do evento
    tipo_evento = db.Column(
        Enum(TipoEventoCorporativo),
        nullable=False,
        index=True,
        comment="Tipo do evento corporativo"
    )
    
    data_evento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do evento"
    )
    
    data_com = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao evento)"
    )
    
    proporcao = db.Column(
        String(20),
        nullable=True,
        comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"
    )
    
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada do evento"
    )
    
    # Controle de processamento
    impacto_posicoes = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se as posi√ß√µes j√° foram ajustadas"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes adicionais sobre o evento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship(
        'Ativo',
        foreign_keys=[ativo_id],
        backref='eventos_corporativos',
        lazy='joined'
    )
    ativo_novo = relationship(
        'Ativo',
        foreign_keys=[ativo_novo_id],
        lazy='joined'
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "data_com IS NULL OR data_com <= data_evento",
            name="evento_data_com_valida"
        ),
        db.CheckConstraint(
            """
            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)
            OR 
            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))
            """,
            name="evento_proporcao_obrigatoria"
        ),
        {'comment': 'Tabela de eventos corporativos que afetam ativos'}
    )
    
    def is_split(self):
        """Verifica se √© split (desdobramento)"""
        return self.tipo_evento == TipoEventoCorporativo.SPLIT
    
    def is_grupamento(self):
        """Verifica se √© grupamento (inplit)"""
        return self.tipo_evento == TipoEventoCorporativo.GRUPAMENTO
    
    def is_bonificacao(self):
        """Verifica se √© bonifica√ß√£o"""
        return self.tipo_evento == TipoEventoCorporativo.BONIFICACAO
    
    def is_mudanca_ticker(self):
        """Verifica se √© mudan√ßa de ticker"""
        return self.tipo_evento == TipoEventoCorporativo.MUDANCA_TICKER
    
    def parse_proporcao(self):
        """
        Faz parse da propor√ß√£o do evento
        
        Returns:
            tuple: (numerador, denominador) ou None se inv√°lido
            
        Examples:
            "2:1" -> (2.0, 1.0) # Split 2 para 1
            "1:10" -> (1.0, 10.0) # Grupamento 1 para 10
            "1:1.5" -> (1.0, 1.5) # Bonifica√ß√£o 50%
        """
        if not self.proporcao:
            return None
        
        try:
            parts = self.proporcao.split(':')
            if len(parts) == 2:
                return (float(parts[0]), float(parts[1]))
        except (ValueError, IndexError):
            pass
        
        return None
    
    def calcular_fator_ajuste(self):
        """
        Calcula o fator de ajuste para quantidade de ativos
        
        Returns:
            float: Fator multiplicador (ex: 2.0 para split 2:1, 0.1 para grupamento 1:10)
        """
        proporcao = self.parse_proporcao()
        if not proporcao:
            return 1.0
        
        numerador, denominador = proporcao
        
        if self.is_split() or self.is_bonificacao():
            # Split 2:1 ou Bonifica√ß√£o 1:1.5 -> multiplica quantidade
            return numerador / denominador
        elif self.is_grupamento():
            # Grupamento 1:10 -> divide quantidade (inverte propor√ß√£o)
            return numerador / denominador
        
        return 1.0
    
    def calcular_fator_ajuste_preco(self):
        """
        Calcula o fator de ajuste para pre√ßo m√©dio
        (inverso do ajuste de quantidade)
        
        Returns:
            float: Fator divisor para pre√ßo
        """
        fator_quantidade = self.calcular_fator_ajuste()
        if fator_quantidade > 0:
            return 1.0 / fator_quantidade
        return 1.0
    
    def marcar_como_processado(self):
        """Marca o evento como processado (posi√ß√µes ajustadas)"""
        self.impacto_posicoes = True
    
    def dias_ate_evento(self):
        """
        Calcula quantos dias faltam para o evento
        
        Returns:
            int: Dias at√© evento (negativo se j√° ocorreu)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_evento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do evento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'ativo_novo_id': str(self.ativo_novo_id) if self.ativo_novo_id else None,
            'tipo_evento': self.tipo_evento.value if self.tipo_evento else None,
            'data_evento': self.data_evento.isoformat() if self.data_evento else None,
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'proporcao': self.proporcao,
            'fator_ajuste_quantidade': self.calcular_fator_ajuste(),
            'fator_ajuste_preco': self.calcular_fator_ajuste_preco(),
            'descricao': self.descricao,
            'impacto_posicoes': self.impacto_posicoes,
            'dias_ate_evento': self.dias_ate_evento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_evento.value if self.tipo_evento else "N/A"
        return f"<EventoCorporativo {tipo.upper()} {ticker} {self.proporcao or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/feriado_mercado.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FeriadoMercado
Entidade para feriados e dias sem preg√£o
"""

from datetime import datetime, time
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Text, Date, Time
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFeriado(enum.Enum):
    """Enum para tipos de feriado"""
    NACIONAL = "nacional"            # Feriado nacional
    BOLSA = "bolsa"                  # Feriado espec√≠fico da bolsa
    PONTE = "ponte"                  # Ponto facultativo
    FECHAMENTO_ANTECIPADO = "antecip"  # Fechamento antecipado
    MANUTENCAO = "manutencao"        # Manuten√ß√£o de sistemas
    OUTRO = "outro"                  # Outros tipos


class FeriadoMercado(db.Model):
    """
    Model para feriados e dias sem preg√£o
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s do feriado (c√≥digo ISO)
        mercado (str): Mercado/bolsa espec√≠fica
        data_feriado (date): Data do feriado
        tipo_feriado (TipoFeriado): Tipo do feriado
        nome (str): Nome do feriado
        horario_fechamento (time): Hor√°rio de fechamento antecipado
        recorrente (bool): Se √© feriado anual fixo
        observacoes (str): Observa√ß√µes sobre o feriado
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'feriado_mercado'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do feriado"
    )
    
    # Localiza√ß√£o
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    mercado = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos"
    )
    
    # Dados do feriado
    data_feriado = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do feriado"
    )
    
    tipo_feriado = db.Column(
        Enum(TipoFeriado),
        nullable=False,
        index=True,
        comment="Tipo do feriado"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        comment="Nome do feriado"
    )
    
    horario_fechamento = db.Column(
        Time,
        nullable=True,
        comment="Hor√°rio de fechamento antecipado (se aplic√°vel)"
    )
    
    recorrente = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o feriado"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="feriado_pais_iso_format"
        ),
        db.CheckConstraint(
            "length(nome) >= 3",
            name="feriado_nome_min_length"
        ),
        db.UniqueConstraint(
            'pais', 'mercado', 'data_feriado',
            name='unique_feriado_pais_mercado_data'
        ),
        {'comment': 'Tabela de feriados e dias sem preg√£o nos mercados'}
    )
    
    def is_fechamento_total(self):
        """Verifica se √© fechamento total (n√£o h√° preg√£o)"""
        return self.tipo_feriado in [
            TipoFeriado.NACIONAL,
            TipoFeriado.BOLSA,
            TipoFeriado.PONTE
        ]
    
    def is_fechamento_antecipado(self):
        """Verifica se √© fechamento antecipado"""
        return self.tipo_feriado == TipoFeriado.FECHAMENTO_ANTECIPADO
    
    def is_recorrente(self):
        """Verifica se √© feriado recorrente (anual)"""
        return self.recorrente
    
    def dias_ate_feriado(self):
        """
        Calcula quantos dias faltam para o feriado
        
        Returns:
            int: Dias at√© feriado (negativo se j√° passou)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_feriado - hoje
        return delta.days
    
    def is_hoje(self):
        """Verifica se o feriado √© hoje"""
        return self.data_feriado == datetime.utcnow().date()
    
    def is_futuro(self):
        """Verifica se o feriado √© no futuro"""
        return self.data_feriado > datetime.utcnow().date()
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do feriado
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'mercado': self.mercado,
            'data_feriado': self.data_feriado.isoformat() if self.data_feriado else None,
            'tipo_feriado': self.tipo_feriado.value if self.tipo_feriado else None,
            'nome': self.nome,
            'horario_fechamento': self.horario_fechamento.isoformat() if self.horario_fechamento else None,
            'recorrente': self.recorrente,
            'is_fechamento_total': self.is_fechamento_total(),
            'is_fechamento_antecipado': self.is_fechamento_antecipado(),
            'dias_ate_feriado': self.dias_ate_feriado(),
            'is_hoje': self.is_hoje(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<FeriadoMercado {self.pais} {self.data_feriado} - {self.nome}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/fonte_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FonteDados
Entidade para gerenciamento de fontes de dados externas (APIs)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Integer, Text
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFonteDados(enum.Enum):
    """Enum para tipos de fonte de dados"""
    API = "api"              # API RESTful
    SCRAPER = "scraper"      # Web scraping
    MANUAL = "manual"        # Entrada manual
    ARQUIVO = "arquivo"      # Import de arquivo
    OUTRO = "outro"          # Outros tipos


class FonteDados(db.Model):
    """
    Model para fontes de dados externas
    
    Attributes:
        id (UUID): Identificador √∫nico
        nome (str): Nome da fonte
        tipo_fonte (TipoFonteDados): Tipo da fonte
        url_base (str): URL base da API/fonte
        requer_autenticacao (bool): Se requer chave API
        rate_limit (str): Limite de requisi√ß√µes
        ativa (bool): Se fonte est√° ativa
        prioridade (int): Ordem de prioridade (1 = maior)
        ultima_consulta (datetime): Timestamp da √∫ltima consulta
        total_consultas (int): Total de consultas realizadas
        total_erros (int): Total de erros encontrados
        observacoes (str): Observa√ß√µes sobre a fonte
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'fonte_dados'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da fonte"
    )
    
    # Identifica√ß√£o
    nome = db.Column(
        String(100),
        unique=True,
        nullable=False,
        index=True,
        comment="Nome da fonte de dados (ex: yfinance, Alpha Vantage)"
    )
    
    tipo_fonte = db.Column(
        Enum(TipoFonteDados),
        nullable=False,
        index=True,
        comment="Tipo da fonte de dados"
    )
    
    url_base = db.Column(
        String(500),
        nullable=True,
        comment="URL base da API ou site"
    )
    
    # Configura√ß√µes
    requer_autenticacao = db.Column(
        Boolean,
        default=False,
        nullable=False,
        comment="Indica se requer chave API ou autentica√ß√£o"
    )
    
    rate_limit = db.Column(
        String(50),
        nullable=True,
        comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"
    )
    
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se fonte est√° ativa"
    )
    
    prioridade = db.Column(
        Integer,
        default=100,
        nullable=False,
        index=True,
        comment="Ordem de prioridade (1 = maior prioridade)"
    )
    
    # Estat√≠sticas
    ultima_consulta = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Timestamp da √∫ltima consulta bem-sucedida"
    )
    
    total_consultas = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de consultas realizadas"
    )
    
    total_erros = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de erros encontrados"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a fonte de dados"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "prioridade > 0",
            name="fonte_prioridade_positiva"
        ),
        db.CheckConstraint(
            "total_consultas >= 0",
            name="fonte_consultas_positivas"
        ),
        db.CheckConstraint(
            "total_erros >= 0",
            name="fonte_erros_positivos"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="fonte_nome_min_length"
        ),
        {'comment': 'Tabela de fontes de dados externas (APIs, scrapers)'}
    )
    
    def is_active(self):
        """Verifica se fonte est√° ativa"""
        return self.ativa
    
    def is_api(self):
        """Verifica se √© API"""
        return self.tipo_fonte == TipoFonteDados.API
    
    def registrar_consulta_sucesso(self):
        """Registra uma consulta bem-sucedida"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.ultima_consulta = datetime.utcnow()
        self.total_consultas += 1

    def registrar_erro(self):
        """Registra um erro na consulta"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.total_erros += 1
        self.total_consultas += 1

    def taxa_sucesso(self):
        """
        Calcula a taxa de sucesso das consultas
        
        Returns:
            float: Percentual de sucesso (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            sucessos = total - erros
            return (sucessos / total) * 100
        return 100.0  # Sem consultas = 100% por padr√£o

    def taxa_erro(self):
        """
        Calcula a taxa de erro das consultas
        
        Returns:
            float: Percentual de erro (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            return (erros / total) * 100
        return 0.0

    def health_status(self):
        """
        Determina o status de sa√∫de da fonte
        
        Returns:
            str: 'healthy', 'degraded', 'down', 'unknown'
        """
        total = self.total_consultas if self.total_consultas else 0
        
        if total == 0:
            return 'unknown'
        
        taxa_sucesso = self.taxa_sucesso()
        
        if taxa_sucesso >= 95:
            return 'healthy'
        elif taxa_sucesso >= 80:
            return 'degraded'
        else:
            return 'down'

    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da fonte
        """
        return {
            'id': str(self.id),
            'nome': self.nome,
            'tipo_fonte': self.tipo_fonte.value if self.tipo_fonte else None,
            'url_base': self.url_base,
            'requer_autenticacao': self.requer_autenticacao,
            'rate_limit': self.rate_limit,
            'ativa': self.ativa,
            'prioridade': self.prioridade,
            'ultima_consulta': self.ultima_consulta.isoformat() if self.ultima_consulta else None,
            'total_consultas': self.total_consultas,
            'total_erros': self.total_erros,
            'taxa_sucesso': round(self.taxa_sucesso(), 2),
            'taxa_erro': round(self.taxa_erro(), 2),
            'health_status': self.health_status(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.ativa else "‚úó"
        return f"<FonteDados {status} {self.nome} (prioridade {self.prioridade})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/log_auditoria.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model LogAuditoria
Entidade para logs de auditoria e compliance
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Text, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class LogAuditoria(db.Model):
    """
    Model para logs de auditoria
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio que realizou a a√ß√£o
        acao (str): Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE, etc.)
        entidade (str): Nome da entidade afetada
        entidade_id (UUID): ID do registro afetado
        dados_antes (dict): Estado anterior do registro (JSON)
        dados_depois (dict): Estado posterior do registro (JSON)
        ip_address (str): Endere√ßo IP de origem
        user_agent (str): Navegador/cliente usado
        timestamp (datetime): Data/hora da a√ß√£o
        sucesso (bool): Se a√ß√£o foi bem-sucedida
        mensagem (str): Mensagem de erro ou detalhes adicionais
    
    Relationships:
        usuario: Usu√°rio que realizou a a√ß√£o
    """
    
    __tablename__ = 'log_auditoria'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do log"
    )
    
    # Foreign key
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do usu√°rio (NULL para a√ß√µes an√¥nimas)"
    )
    
    # Dados da a√ß√£o
    acao = db.Column(
        String(50),
        nullable=False,
        index=True,
        comment="Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)"
    )
    
    entidade = db.Column(
        String(100),
        nullable=True,
        index=True,
        comment="Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)"
    )
    
    entidade_id = db.Column(
        UUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="ID do registro afetado"
    )
    
    # Estados anterior e posterior (para UPDATE)
    dados_antes = db.Column(
        JSON,
        nullable=True,
        comment="Estado anterior do registro (JSON)"
    )
    
    dados_depois = db.Column(
        JSON,
        nullable=True,
        comment="Estado posterior do registro (JSON)"
    )
    
    # Dados de contexto
    ip_address = db.Column(
        String(45),  # IPv6 pode ter at√© 45 caracteres
        nullable=True,
        index=True,
        comment="Endere√ßo IP de origem"
    )
    
    user_agent = db.Column(
        String(500),
        nullable=True,
        comment="User-Agent (navegador/cliente)"
    )
    
    timestamp = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        index=True,
        comment="Data/hora da a√ß√£o"
    )
    
    # Resultado
    sucesso = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se a√ß√£o foi bem-sucedida"
    )
    
    mensagem = db.Column(
        Text,
        nullable=True,
        comment="Mensagem de erro ou detalhes adicionais"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='logs_auditoria', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "length(acao) >= 3",
            name="log_acao_min_length"
        ),
        {'comment': 'Tabela de logs de auditoria para compliance'}
    )
    
    def is_sucesso(self):
        """Verifica se a√ß√£o foi bem-sucedida"""
        return self.sucesso
    
    def is_falha(self):
        """Verifica se a√ß√£o falhou"""
        return not self.sucesso
    
    def is_login(self):
        """Verifica se √© log de login"""
        return self.acao == 'LOGIN'
    
    def is_logout(self):
        """Verifica se √© log de logout"""
        return self.acao == 'LOGOUT'
    
    def is_create(self):
        """Verifica se √© cria√ß√£o de registro"""
        return self.acao == 'CREATE'
    
    def is_update(self):
        """Verifica se √© atualiza√ß√£o de registro"""
        return self.acao == 'UPDATE'
    
    def is_delete(self):
        """Verifica se √© exclus√£o de registro"""
        return self.acao == 'DELETE'
    
    def is_export(self):
        """Verifica se √© exporta√ß√£o de dados"""
        return self.acao == 'EXPORT'
    
    def get_alteracoes(self):
        """
        Extrai as altera√ß√µes realizadas (campos modificados)
        
        Returns:
            dict: Dicion√°rio com campos alterados e seus valores antes/depois
        """
        if not self.is_update() or not self.dados_antes or not self.dados_depois:
            return {}
        
        alteracoes = {}
        for campo, valor_depois in self.dados_depois.items():
            valor_antes = self.dados_antes.get(campo)
            if valor_antes != valor_depois:
                alteracoes[campo] = {
                    'antes': valor_antes,
                    'depois': valor_depois
                }
        
        return alteracoes
    
    def to_dict(self, include_dados=False):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Args:
            include_dados (bool): Se deve incluir dados_antes e dados_depois
        
        Returns:
            dict: Dicion√°rio com dados do log
        """
        data = {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id) if self.usuario_id else None,
            'acao': self.acao,
            'entidade': self.entidade,
            'entidade_id': str(self.entidade_id) if self.entidade_id else None,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None,
            'sucesso': self.sucesso,
            'mensagem': self.mensagem
        }
        
        if include_dados:
            data['dados_antes'] = self.dados_antes
            data['dados_depois'] = self.dados_depois
            data['alteracoes'] = self.get_alteracoes()
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.sucesso else "‚úó"
        usuario = self.usuario.username if self.usuario else "ANON"
        return f"<LogAuditoria {status} {usuario} {self.acao} {self.entidade or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/movimentacao_caixa.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model MovimentacaoCaixa
Entidade para movimenta√ß√µes de caixa em corretoras
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoMovimentacao(enum.Enum):
    """Enum para tipos de movimenta√ß√£o"""
    DEPOSITO = "deposito"                    # Dep√≥sito na corretora
    SAQUE = "saque"                          # Saque da corretora
    TRANSFERENCIA_ENVIADA = "transf_env"    # Transfer√™ncia para outra corretora
    TRANSFERENCIA_RECEBIDA = "transf_rec"   # Transfer√™ncia de outra corretora
    CREDITO_PROVENTO = "credito_prov"       # Cr√©dito de provento
    PAGAMENTO_TAXA = "pagto_taxa"           # Pagamento de taxa/cust√≥dia
    PAGAMENTO_IMPOSTO = "pagto_imposto"     # Pagamento de imposto
    AJUSTE = "ajuste"                        # Ajuste manual
    OUTRO = "outro"                          # Outros tipos


class MovimentacaoCaixa(db.Model):
    """
    Model para movimenta√ß√µes de caixa em corretoras
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora (origem)
        tipo_movimentacao (TipoMovimentacao): Tipo da movimenta√ß√£o
        valor (Decimal): Valor da movimenta√ß√£o
        moeda (str): Moeda (BRL, USD, EUR)
        data_movimentacao (date): Data da movimenta√ß√£o
        corretora_destino_id (UUID): ID da corretora destino (transfer√™ncias)
        provento_id (UUID): ID do provento (se for cr√©dito de provento)
        descricao (str): Descri√ß√£o da movimenta√ß√£o
        comprovante (str): Refer√™ncia ao comprovante
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora origem
        corretora_destino: Corretora destino (para transfer√™ncias)
        provento: Provento relacionado (para cr√©ditos)
    """
    
    __tablename__ = 'movimentacao_caixa'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da movimenta√ß√£o"
    )
    
    # Foreign keys obrigat√≥rias
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora (origem)"
    )
    
    # Foreign keys opcionais
    corretora_destino_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID da corretora destino (apenas para transfer√™ncias)"
    )
    
    provento_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('provento.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do provento (apenas para cr√©dito de provento)"
    )
    
    # Dados da movimenta√ß√£o
    tipo_movimentacao = db.Column(
        Enum(TipoMovimentacao),
        nullable=False,
        index=True,
        comment="Tipo da movimenta√ß√£o"
    )
    
    valor = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor da movimenta√ß√£o"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    data_movimentacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da movimenta√ß√£o"
    )
    
    # Metadados
    descricao = db.Column(
        Text,
        nullable=True,
        comment="Descri√ß√£o da movimenta√ß√£o"
    )
    
    comprovante = db.Column(
        String(200),
        nullable=True,
        comment="Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='movimentacoes_caixa', lazy='joined')
    corretora = relationship(
        'Corretora',
        foreign_keys=[corretora_id],
        backref='movimentacoes_caixa',
        lazy='joined'
    )
    corretora_destino = relationship(
        'Corretora',
        foreign_keys=[corretora_destino_id],
        lazy='joined'
    )
    provento = relationship('Provento', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor > 0",
            name="movimentacao_valor_positivo"
        ),
        db.CheckConstraint(
            "moeda ~* '^[A-Z]{3}$'",
            name="movimentacao_moeda_iso_format"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') 
             AND corretora_destino_id IS NOT NULL)
            OR 
            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))
            """,
            name="movimentacao_transferencia_tem_destino"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)
            OR 
            (tipo_movimentacao != 'credito_provento')
            """,
            name="movimentacao_credito_tem_provento"
        ),
        {'comment': 'Tabela de movimenta√ß√µes de caixa em corretoras'}
    )
    
    def is_entrada(self):
        """Verifica se √© movimenta√ß√£o de entrada (aumenta saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.DEPOSITO,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA,
            TipoMovimentacao.CREDITO_PROVENTO,
            TipoMovimentacao.AJUSTE  # Depende do contexto, mas inclu√≠mos aqui
        ]
    
    def is_saida(self):
        """Verifica se √© movimenta√ß√£o de sa√≠da (diminui saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.SAQUE,
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.PAGAMENTO_TAXA,
            TipoMovimentacao.PAGAMENTO_IMPOSTO
        ]
    
    def is_transferencia(self):
        """Verifica se √© transfer√™ncia entre corretoras"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA
        ]
    
    def is_credito_provento(self):
        """Verifica se √© cr√©dito de provento"""
        return self.tipo_movimentacao == TipoMovimentacao.CREDITO_PROVENTO
    
    def impacto_saldo(self):
        """
        Calcula o impacto no saldo da corretora
        
        Returns:
            Decimal: Valor positivo para entradas, negativo para sa√≠das
        """
        if self.is_entrada():
            return self.valor
        elif self.is_saida():
            return -self.valor
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da movimenta√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'corretora_destino_id': str(self.corretora_destino_id) if self.corretora_destino_id else None,
            'provento_id': str(self.provento_id) if self.provento_id else None,
            'tipo_movimentacao': self.tipo_movimentacao.value if self.tipo_movimentacao else None,
            'valor': float(self.valor) if self.valor else 0,
            'moeda': self.moeda,
            'impacto_saldo': float(self.impacto_saldo()),
            'data_movimentacao': self.data_movimentacao.isoformat() if self.data_movimentacao else None,
            'descricao': self.descricao,
            'comprovante': self.comprovante,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = self.tipo_movimentacao.value if self.tipo_movimentacao else "N/A"
        sinal = "+" if self.is_entrada() else "-"
        return f"<MovimentacaoCaixa {tipo.upper()} {sinal} {self.moeda} {self.valor}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/posicao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Posicao
Entidade para holdings/posi√ß√µes em carteira de ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Numeric, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class Posicao(db.Model):
    """
    Model para posi√ß√µes em carteira (holdings)
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        corretora_id (UUID): ID da corretora onde est√° a posi√ß√£o
        ativo_id (UUID): ID do ativo
        quantidade (Decimal): Quantidade de ativos em posse
        preco_medio (Decimal): Pre√ßo m√©dio de aquisi√ß√£o
        custo_total (Decimal): Custo total investido
        taxas_acumuladas (Decimal): Taxas de corretagem acumuladas
        impostos_acumulados (Decimal): Impostos pagos acumulados
        valor_atual (Decimal): Valor de mercado atual da posi√ß√£o
        lucro_prejuizo_realizado (Decimal): L/P realizado (vendas)
        lucro_prejuizo_nao_realizado (Decimal): L/P n√£o realizado
        data_primeira_compra (date): Data da primeira aquisi√ß√£o
        data_ultima_atualizacao (datetime): √öltima atualiza√ß√£o
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora onde est√° a posi√ß√£o
        ativo: Ativo da posi√ß√£o
    """
    
    __tablename__ = 'posicao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da posi√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora onde est√° a posi√ß√£o"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo"
    )
    
    # Dados da posi√ß√£o
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        default=0,
        comment="Quantidade de ativos (suporta fracion√°rios)"
    )
    
    preco_medio = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        default=0,
        comment="Pre√ßo m√©dio de aquisi√ß√£o"
    )
    
    custo_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Custo total investido (quantidade * pre√ßo m√©dio)"
    )
    
    taxas_acumuladas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem e cust√≥dia acumuladas"
    )
    
    impostos_acumulados = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Impostos pagos acumulados (IR, IOF, etc.)"
    )
    
    # Valores calculados
    valor_atual = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de mercado atual da posi√ß√£o"
    )
    
    lucro_prejuizo_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Lucro/preju√≠zo realizado em vendas"
    )
    
    lucro_prejuizo_nao_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)"
    )
    
    # Datas
    data_primeira_compra = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data da primeira aquisi√ß√£o deste ativo"
    )
    
    data_ultima_atualizacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data da √∫ltima atualiza√ß√£o de valores"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='posicoes', lazy='joined')
    corretora = relationship('Corretora', backref='posicoes', lazy='joined')
    ativo = relationship('Ativo', backref='posicoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade >= 0",
            name="posicao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_medio >= 0",
            name="posicao_preco_medio_positivo"
        ),
        db.CheckConstraint(
            "custo_total >= 0",
            name="posicao_custo_total_positivo"
        ),
        db.CheckConstraint(
            "taxas_acumuladas >= 0",
            name="posicao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos_acumulados >= 0",
            name="posicao_impostos_positivos"
        ),
        db.UniqueConstraint(
            'usuario_id', 'corretora_id', 'ativo_id',
            name='unique_posicao_usuario_corretora_ativo'
        ),
        {'comment': 'Tabela de posi√ß√µes em carteira (holdings)'}
    )
    
    def calcular_valor_atual(self, preco_mercado):
        """
        Calcula o valor atual da posi√ß√£o baseado no pre√ßo de mercado
        
        Args:
            preco_mercado (Decimal): Pre√ßo atual do ativo no mercado
        
        Returns:
            Decimal: Valor atual da posi√ß√£o
        """
        self.valor_atual = self.quantidade * preco_mercado
        self.data_ultima_atualizacao = datetime.utcnow()
        return self.valor_atual
    
    def calcular_lucro_prejuizo_nao_realizado(self):
        """
        Calcula o lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)
        
        Returns:
            Decimal: L/P n√£o realizado
        """
        if self.valor_atual is not None:
            self.lucro_prejuizo_nao_realizado = self.valor_atual - self.custo_total
        return self.lucro_prejuizo_nao_realizado
    
    def adicionar_compra(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma compra √† posi√ß√£o (recalcula pre√ßo m√©dio)
        
        Args:
            quantidade (Decimal): Quantidade comprada
            preco_unitario (Decimal): Pre√ßo unit√°rio da compra
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        """
        # Garantir valores n√£o-None (defaults do SQLAlchemy s√≥ aplicam ao persistir)
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        custo_compra = quantidade * preco_unitario
        
        # Recalcular pre√ßo m√©dio ponderado
        novo_custo_total = self.custo_total + custo_compra
        nova_quantidade = self.quantidade + quantidade
        
        if nova_quantidade > 0:
            self.preco_medio = novo_custo_total / nova_quantidade
        
        self.quantidade = nova_quantidade
        self.custo_total = novo_custo_total
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Definir data primeira compra se for a primeira
        if self.data_primeira_compra is None:
            self.data_primeira_compra = datetime.utcnow().date()

    
    def adicionar_venda(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma venda √† posi√ß√£o
        
        Args:
            quantidade (Decimal): Quantidade vendida
            preco_unitario (Decimal): Pre√ßo unit√°rio da venda
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        
        Raises:
            ValueError: Se quantidade vendida for maior que quantidade em posse
        """
        # Garantir valores n√£o-None
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        if quantidade > self.quantidade:
            raise ValueError(
                f"Quantidade vendida ({quantidade}) maior que quantidade em posse ({self.quantidade})"
            )
        
        # Calcular lucro/preju√≠zo realizado
        receita_venda = quantidade * preco_unitario
        custo_proporcional = quantidade * self.preco_medio
        lp_realizado = receita_venda - custo_proporcional - taxas - impostos
        
        self.lucro_prejuizo_realizado += lp_realizado
        self.quantidade -= quantidade
        self.custo_total -= custo_proporcional
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Se zerou a posi√ß√£o, resetar pre√ßo m√©dio
        if self.quantidade == 0:
            self.preco_medio = 0
            self.custo_total = 0

    
    def percentual_lucro_prejuizo(self):
        """
        Calcula o percentual de lucro/preju√≠zo n√£o realizado
        
        Returns:
            Decimal: Percentual de L/P (ex: 15.5 = 15.5%)
        """
        if self.custo_total > 0 and self.lucro_prejuizo_nao_realizado is not None:
            return (self.lucro_prejuizo_nao_realizado / self.custo_total) * 100
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da posi√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_medio': float(self.preco_medio) if self.preco_medio else 0,
            'custo_total': float(self.custo_total) if self.custo_total else 0,
            'taxas_acumuladas': float(self.taxas_acumuladas) if self.taxas_acumuladas else 0,
            'impostos_acumulados': float(self.impostos_acumulados) if self.impostos_acumulados else 0,
            'valor_atual': float(self.valor_atual) if self.valor_atual else None,
            'lucro_prejuizo_realizado': float(self.lucro_prejuizo_realizado) if self.lucro_prejuizo_realizado else 0,
            'lucro_prejuizo_nao_realizado': float(self.lucro_prejuizo_nao_realizado) if self.lucro_prejuizo_nao_realizado else None,
            'percentual_lp': float(self.percentual_lucro_prejuizo()),
            'data_primeira_compra': self.data_primeira_compra.isoformat() if self.data_primeira_compra else None,
            'data_ultima_atualizacao': self.data_ultima_atualizacao.isoformat() if self.data_ultima_atualizacao else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Posicao {self.quantidade}x {self.ativo.ticker if self.ativo else 'N/A'}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/provento.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Provento
Entidade para registro de proventos (dividendos, JCP, rendimentos)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoProvento(enum.Enum):
    """Enum para tipos de provento"""
    DIVIDENDO = "dividendo"              # Dividendo ordin√°rio
    JCP = "jcp"                          # Juros sobre Capital Pr√≥prio
    RENDIMENTO = "rendimento"            # Rendimento de FII
    CUPOM = "cupom"                      # Cupom de t√≠tulo de renda fixa
    BONIFICACAO = "bonificacao"          # Bonifica√ß√£o em dinheiro
    DIREITO_SUBSCRICAO = "direito_sub"   # Direito de subscri√ß√£o vendido
    OUTRO = "outro"                      # Outros tipos


class Provento(db.Model):
    """
    Model para proventos recebidos de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo que pagou o provento
        tipo_provento (TipoProvento): Tipo do provento
        valor_por_acao (Decimal): Valor unit√°rio por ativo
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        data_pagamento (date): Data efetiva do pagamento
        quantidade_ativos (Decimal): Quantidade de ativos que geraram provento
        valor_bruto (Decimal): Valor bruto recebido
        imposto_retido (Decimal): IR retido na fonte
        valor_liquido (Decimal): Valor l√≠quido creditado
        observacoes (str): Observa√ß√µes sobre o provento
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo que pagou o provento
    """
    
    __tablename__ = 'provento'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do provento"
    )
    
    # Foreign key
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo que pagou o provento"
    )
    
    # Tipo de provento
    tipo_provento = db.Column(
        Enum(TipoProvento),
        nullable=False,
        index=True,
        comment="Tipo do provento (dividendo, JCP, rendimento, etc.)"
    )
    
    # Valores
    valor_por_acao = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Valor unit√°rio por ativo"
    )
    
    quantidade_ativos = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade de ativos que geraram o provento"
    )
    
    valor_bruto = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor bruto recebido"
    )
    
    imposto_retido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte"
    )
    
    valor_liquido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor l√≠quido creditado"
    )
    
    # Datas
    data_com = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao provento)"
    )
    
    data_pagamento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data efetiva do pagamento"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o provento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship('Ativo', backref='proventos', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor_por_acao > 0",
            name="provento_valor_por_acao_positivo"
        ),
        db.CheckConstraint(
            "quantidade_ativos > 0",
            name="provento_quantidade_positiva"
        ),
        db.CheckConstraint(
            "valor_bruto > 0",
            name="provento_valor_bruto_positivo"
        ),
        db.CheckConstraint(
            "imposto_retido >= 0",
            name="provento_imposto_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido > 0",
            name="provento_valor_liquido_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido <= valor_bruto",
            name="provento_liquido_menor_bruto"
        ),
        db.CheckConstraint(
            "data_pagamento >= data_com",
            name="provento_data_pagamento_valida"
        ),
        {'comment': 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa provento com c√°lculos autom√°ticos
        """
        super(Provento, self).__init__(**kwargs)
        
        # Calcular valor bruto se n√£o fornecido
        if self.valor_bruto is None and self.valor_por_acao and self.quantidade_ativos:
            self.valor_bruto = self.valor_por_acao * self.quantidade_ativos
        
        # Calcular valor l√≠quido se n√£o fornecido
        if self.valor_liquido is None and self.valor_bruto is not None:
            imposto = self.imposto_retido if self.imposto_retido else 0
            self.valor_liquido = self.valor_bruto - imposto
    
    def is_dividendo(self):
        """Verifica se √© dividendo"""
        return self.tipo_provento == TipoProvento.DIVIDENDO
    
    def is_jcp(self):
        """Verifica se √© JCP"""
        return self.tipo_provento == TipoProvento.JCP
    
    def is_rendimento_fii(self):
        """Verifica se √© rendimento de FII"""
        return self.tipo_provento == TipoProvento.RENDIMENTO
    
    def percentual_imposto(self):
        """
        Calcula o percentual de imposto retido
        
        Returns:
            Decimal: Percentual de imposto (ex: 15.0 = 15%)
        """
        if self.valor_bruto and self.valor_bruto > 0:
            imposto = self.imposto_retido if self.imposto_retido else 0
            return (imposto / self.valor_bruto) * 100
        return 0
    
    def dividend_yield_efetivo(self, preco_ativo):
        """
        Calcula o dividend yield efetivo baseado no pre√ßo do ativo
        
        Args:
            preco_ativo (Decimal): Pre√ßo atual do ativo
            
        Returns:
            Decimal: DY efetivo em % (ex: 6.5 = 6.5%)
        """
        if preco_ativo and preco_ativo > 0:
            return (self.valor_por_acao / preco_ativo) * 100
        return 0
    
    def dias_ate_pagamento(self):
        """
        Calcula quantos dias faltam para o pagamento
        
        Returns:
            int: Dias at√© pagamento (negativo se j√° pago)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_pagamento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do provento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'tipo_provento': self.tipo_provento.value if self.tipo_provento else None,
            'valor_por_acao': float(self.valor_por_acao) if self.valor_por_acao else 0,
            'quantidade_ativos': float(self.quantidade_ativos) if self.quantidade_ativos else 0,
            'valor_bruto': float(self.valor_bruto) if self.valor_bruto else 0,
            'imposto_retido': float(self.imposto_retido) if self.imposto_retido else 0,
            'valor_liquido': float(self.valor_liquido) if self.valor_liquido else 0,
            'percentual_imposto': float(self.percentual_imposto()),
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'data_pagamento': self.data_pagamento.isoformat() if self.data_pagamento else None,
            'dias_ate_pagamento': self.dias_ate_pagamento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_provento.value if self.tipo_provento else "N/A"
        return f"<Provento {tipo.upper()} {ticker} R$ {self.valor_por_acao}/a√ß√£o>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/regra_fiscal.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model RegraFiscal
Entidade para regras tribut√°rias por pa√≠s e tipo de ativo
"""

from datetime import datetime, date
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class IncidenciaImposto(enum.Enum):
    """Enum para tipo de incid√™ncia do imposto"""
    LUCRO = "lucro"              # Incide sobre lucro/ganho de capital
    RECEITA = "receita"          # Incide sobre receita bruta
    PROVENTO = "provento"        # Incide sobre proventos recebidos
    OPERACAO = "operacao"        # Incide sobre cada opera√ß√£o


class RegraFiscal(db.Model):
    """
    Model para regras tribut√°rias
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s da regra (c√≥digo ISO)
        tipo_ativo (str): Tipo de ativo (ACAO, FII, REIT, etc.)
        tipo_operacao (str): Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE)
        aliquota_ir (Decimal): Al√≠quota de IR em %
        valor_isencao (Decimal): Valor de isen√ß√£o mensal
        incide_sobre (IncidenciaImposto): Sobre o que incide o imposto
        descricao (str): Descri√ß√£o da regra
        vigencia_inicio (date): Data de in√≠cio da vig√™ncia
        vigencia_fim (date): Data de fim da vig√™ncia
        ativa (bool): Indica se regra est√° ativa
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'regra_fiscal'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da regra"
    )
    
    # Identifica√ß√£o da regra
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    tipo_ativo = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos"
    )
    
    tipo_operacao = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas"
    )
    
    # Valores fiscais
    aliquota_ir = db.Column(
        Numeric(precision=6, scale=4),
        nullable=False,
        comment="Al√≠quota de IR em % (ex: 15.0000 = 15%)"
    )
    
    valor_isencao = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)"
    )
    
    incide_sobre = db.Column(
        Enum(IncidenciaImposto),
        nullable=False,
        index=True,
        comment="Sobre o que incide o imposto"
    )
    
    # Descri√ß√£o
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada da regra fiscal"
    )
    
    # Vig√™ncia
    vigencia_inicio = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data de in√≠cio da vig√™ncia da regra"
    )
    
    vigencia_fim = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de fim da vig√™ncia (NULL = vigente indefinidamente)"
    )
    
    # Status
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se regra est√° ativa"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "aliquota_ir >= 0 AND aliquota_ir <= 100",
            name="regra_aliquota_valida"
        ),
        db.CheckConstraint(
            "valor_isencao IS NULL OR valor_isencao >= 0",
            name="regra_isencao_positiva"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="regra_pais_iso_format"
        ),
        db.CheckConstraint(
            "vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio",
            name="regra_vigencia_valida"
        ),
        {'comment': 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'}
    )
    
    def is_active(self):
        """Verifica se regra est√° ativa"""
        return self.ativa
    
    def is_vigente(self, data_referencia=None):
        """
        Verifica se regra est√° vigente em uma data
        
        Args:
            data_referencia (date): Data de refer√™ncia (default: hoje)
            
        Returns:
            bool: True se vigente
        """
        if not self.ativa:
            return False
        
        if data_referencia is None:
            data_referencia = datetime.utcnow().date()
        
        # Verifica in√≠cio
        if data_referencia < self.vigencia_inicio:
            return False
        
        # Verifica fim (se definido)
        if self.vigencia_fim and data_referencia > self.vigencia_fim:
            return False
        
        return True
    
    def tem_isencao(self):
        """Verifica se regra possui valor de isen√ß√£o"""
        return self.valor_isencao is not None and self.valor_isencao > 0
    
    def calcular_imposto(self, base_calculo):
        """
        Calcula o imposto devido sobre uma base de c√°lculo
        
        Args:
            base_calculo (Decimal): Valor base para c√°lculo
            
        Returns:
            Decimal: Valor do imposto devido
        """
        # Se tem isen√ß√£o e base est√° abaixo, n√£o h√° imposto
        if self.tem_isencao() and base_calculo <= self.valor_isencao:
            return 0
        
        # Calcula imposto sobre o valor (ou valor acima da isen√ß√£o)
        valor_tributavel = base_calculo
        if self.tem_isencao():
            valor_tributavel = base_calculo - self.valor_isencao
        
        imposto = valor_tributavel * (self.aliquota_ir / 100)
        return max(imposto, 0)  # Nunca retornar negativo
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da regra
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'tipo_ativo': self.tipo_ativo,
            'tipo_operacao': self.tipo_operacao,
            'aliquota_ir': float(self.aliquota_ir) if self.aliquota_ir else 0,
            'valor_isencao': float(self.valor_isencao) if self.valor_isencao else None,
            'incide_sobre': self.incide_sobre.value if self.incide_sobre else None,
            'descricao': self.descricao,
            'vigencia_inicio': self.vigencia_inicio.isoformat() if self.vigencia_inicio else None,
            'vigencia_fim': self.vigencia_fim.isoformat() if self.vigencia_fim else None,
            'ativa': self.ativa,
            'vigente': self.is_vigente(),
            'tem_isencao': self.tem_isencao(),
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<RegraFiscal {self.pais} {self.tipo_ativo or 'ALL'} IR={self.aliquota_ir}%>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/transacao.py ---
# -*- coding: utf-8 -*-
"""Exitus - Modelo Transacao - M√≥dulo 2 Fase 2.2.4"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Numeric, DateTime, Enum, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from app.database import db

class TipoTransacao(enum.Enum):
    """Enum para tipos de transa√ß√£o"""
    COMPRA = "compra"
    VENDA = "venda"
    DIVIDENDO = "dividendo"
    JCP = "jcp"
    BONIFICACAO = "bonificacao"
    DESDOBRAMENTO = "desdobramento"
    GRUPAMENTO = "grupamento"

class Transacao(db.Model):
    """
    Modelo de Transa√ß√£o.
    
    Representa opera√ß√µes financeiras do usu√°rio:
    - Compra/venda de ativos
    - Recebimento de dividendos/JCP
    - Eventos corporativos (bonifica√ß√£o, desdobramento, grupamento)
    """
    __tablename__ = 'transacao'
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    usuario_id = Column(UUID(as_uuid=True), ForeignKey('usuario.id'), nullable=False)
    tipo = Column(Enum(TipoTransacao), nullable=False)
    
    # Relacionamentos
    ativo_id = Column(UUID(as_uuid=True), ForeignKey('ativo.id'), nullable=False)
    corretora_id = Column(UUID(as_uuid=True), ForeignKey('corretora.id'), nullable=False)
    
    # Dados da transa√ß√£o
    data_transacao = Column(DateTime(timezone=True), nullable=False)
    quantidade = Column(Numeric(18, 8), nullable=False)
    preco_unitario = Column(Numeric(18, 6), nullable=False)
    valor_total = Column(Numeric(18, 2), nullable=False)  # quantidade * preco_unitario
    
    # Custos operacionais
    taxa_corretagem = Column(Numeric(18, 2), nullable=False, default=0)
    taxa_liquidacao = Column(Numeric(18, 2), nullable=False, default=0)
    emolumentos = Column(Numeric(18, 2), nullable=False, default=0)
    imposto = Column(Numeric(18, 2), nullable=False, default=0)
    outros_custos = Column(Numeric(18, 2), nullable=False, default=0)
    
    # Totalizadores
    custos_totais = Column(Numeric(18, 2), nullable=False, default=0)
    valor_liquido = Column(Numeric(18, 2), nullable=False)  # valor_total +/- custos
    
    # Metadados
    observacoes = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships (lazy loading)
    usuario = relationship("Usuario", backref="transacoes", lazy=True)
    ativo = relationship("Ativo", backref="transacoes", primaryjoin="Transacao.ativo_id == Ativo.id", lazy=True)
    corretora = relationship("Corretora", backref="transacoes", lazy=True)
    
    def __repr__(self):
        return f"<Transacao {self.tipo.value} {self.quantidade} {self.ativo.ticker if self.ativo else '?'} @ {self.data_transacao.date()}>"
    
    def to_dict(self):
        """Serializa transa√ß√£o para dict"""
        return {
            "id": str(self.id),
            "usuario_id": str(self.usuario_id),
            "tipo": self.tipo.value,
            "ativo_id": str(self.ativo_id),
            "corretora_id": str(self.corretora_id),
            "data_transacao": self.data_transacao.isoformat(),
            "quantidade": str(self.quantidade),
            "preco_unitario": str(self.preco_unitario),
            "valor_total": str(self.valor_total),
            "taxa_corretagem": str(self.taxa_corretagem),
            "taxa_liquidacao": str(self.taxa_liquidacao),
            "emolumentos": str(self.emolumentos),
            "imposto": str(self.imposto),
            "outros_custos": str(self.outros_custos),
            "custos_totais": str(self.custos_totais),
            "valor_liquido": str(self.valor_liquido),
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat(),
            "updated_at": self.updated_at.isoformat()
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/usuario.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Usuario - Entidade principal para autentica√ß√£o"""

import enum
from datetime import datetime
from sqlalchemy import String, Boolean, DateTime, Enum
from sqlalchemy.dialects.postgresql import UUID
import uuid
from werkzeug.security import generate_password_hash, check_password_hash
from app.database import db

class UserRole(enum.Enum):
    """Enum para roles/perfis de usu√°rio"""
    ADMIN = "admin"
    USER = "user"
    READONLY = "readonly"

class Usuario(db.Model):
    """Model para usu√°rios do sistema Exitus"""
    __tablename__ = 'usuario'  # ‚¨ÖÔ∏è PLURAL (consistente com FK)
    
    # Identifica√ß√£o
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = db.Column(String(50), unique=True, nullable=False, index=True)
    email = db.Column(String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(String(255), nullable=False)
    nome_completo = db.Column(String(200), nullable=True)
    
    # Controle
    ativo = db.Column(Boolean, default=True, nullable=False)
    role = db.Column(Enum(UserRole), default=UserRole.USER, nullable=False)
    
    # Timestamps
    created_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def set_password(self, password):
        """Define a senha do usu√°rio (gera hash bcrypt)"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Verifica se a senha fornecida est√° correta"""
        return check_password_hash(self.password_hash, password)
    
    def is_admin(self):
        """Verifica se usu√°rio √© administrador"""
        return self.role == UserRole.ADMIN
    
    def is_active(self):
        """Verifica se usu√°rio est√° ativo"""
        return self.ativo
    
    def to_dict(self, include_sensitive=False):
        """Converte objeto para dicion√°rio para serializa√ß√£o JSON"""
        data = {
            "id": str(self.id),
            "username": self.username,
            "email": self.email,
            "nome_completo": self.nome_completo,
            "ativo": self.ativo,
            "role": self.role.value if self.role else UserRole.USER.value,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }
        
        if include_sensitive:
            data["password_hash"] = self.password_hash
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Usuario {self.username} ({self.email})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/ativo_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Ativo, TipoAtivo, ClasseAtivo
from app.database import db
from decimal import Decimal

class AtivoCreateSchema(Schema):
    """Schema para cria√ß√£o de ativo"""
    ticker = fields.Str(required=True, validate=lambda x: 1 <= len(x) <= 20)
    nome = fields.Str(required=True, validate=lambda x: 2 <= len(x) <= 200)
    tipo = fields.Str(required=True)
    classe = fields.Str(required=True)
    mercado = fields.Str(required=True, validate=lambda x: len(x) <= 10)
    moeda = fields.Str(required=True, validate=lambda x: len(x) == 3)
    preco_atual = fields.Decimal(required=False, as_string=True, allow_none=True)
    dividend_yield = fields.Decimal(required=False, as_string=True, allow_none=True)
    pl = fields.Decimal(required=False, as_string=True, allow_none=True)
    pvp = fields.Decimal(required=False, as_string=True, allow_none=True)
    roe = fields.Decimal(required=False, as_string=True, allow_none=True)
    ativo = fields.Bool(required=False, default=True)
    deslistado = fields.Bool(required=False, default=False)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['acao', 'fii', 'reit', 'bond', 'etf', 'cripto', 'outro']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('classe')
    def validate_classe(self, value):
        """Valida se classe √© v√°lida"""
        valid_classes = ['renda_variavel', 'renda_fixa', 'cripto', 'hibrido']
        if value.lower() not in valid_classes:
            raise ValidationError(f"Classe inv√°lida. Op√ß√µes: {', '.join(valid_classes)}")
    
    @validates('moeda')
    def validate_moeda(self, value):
        """Valida c√≥digo ISO da moeda (3 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")
    
    @validates('ticker')
    def validate_ticker_format(self, value):
        """Valida formato do ticker"""
        if not value.replace('.', '').replace('-', '').isalnum():
            raise ValidationError("Ticker deve conter apenas letras, n√∫meros, pontos e h√≠fens")

class AtivoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de ativo"""
    nome = fields.Str(required=False, validate=lambda x: 2 <= len(x) <= 200)
    tipo = fields.Str(required=False)
    classe = fields.Str(required=False)
    mercado = fields.Str(required=False, validate=lambda x: len(x) <= 10)
    moeda = fields.Str(required=False, validate=lambda x: len(x) == 3)
    preco_atual = fields.Decimal(required=False, as_string=True, allow_none=True)
    dividend_yield = fields.Decimal(required=False, as_string=True, allow_none=True)
    pl = fields.Decimal(required=False, as_string=True, allow_none=True)
    pvp = fields.Decimal(required=False, as_string=True, allow_none=True)
    roe = fields.Decimal(required=False, as_string=True, allow_none=True)
    ativo = fields.Bool(required=False)
    deslistado = fields.Bool(required=False)
    data_deslistagem = fields.Date(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        valid_tipos = ['acao', 'fii', 'reit', 'bond', 'etf', 'cripto', 'outro']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('classe')
    def validate_classe(self, value):
        valid_classes = ['renda_variavel', 'renda_fixa', 'cripto', 'hibrido']
        if value.lower() not in valid_classes:
            raise ValidationError(f"Classe inv√°lida. Op√ß√µes: {', '.join(valid_classes)}")

class AtivoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de ativo"""
    class Meta:
        model = Ativo
        load_instance = False
    
    tipo = fields.Method("get_tipo_str")
    classe = fields.Method("get_classe_str")
    preco_atual = fields.Decimal(as_string=True)
    dividend_yield = fields.Decimal(as_string=True)
    pl = fields.Decimal(as_string=True)
    pvp = fields.Decimal(as_string=True)
    roe = fields.Decimal(as_string=True)
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None
    
    def get_classe_str(self, obj):
        """Converte Enum para string"""
        return obj.classe.value if obj.classe else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/ativo_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import date
from sqlalchemy import or_
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo

class AtivoService:
    """Servi√ßo para opera√ß√µes de ativos"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, tipo=None, classe=None, mercado=None, 
                deslistado=None, search=None):
        """
        Lista ativos com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            tipo: Filtro por tipo (ACAO, FII, etc)
            classe: Filtro por classe (RENDA_VARIAVEL, etc)
            mercado: Filtro por mercado (BR, US, etc)
            deslistado: Filtro por deslistados
            search: Busca em ticker e nome
        """
        query = Ativo.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if tipo:
            query = query.filter_by(tipo=TipoAtivo[tipo.upper()])
        
        if classe:
            query = query.filter_by(classe=ClasseAtivo[classe.upper()])
        
        if mercado:
            query = query.filter_by(mercado=mercado.upper())
        
        if deslistado is not None:
            query = query.filter_by(deslistado=deslistado)
        
        if search:
            query = query.filter(
                or_(
                    Ativo.ticker.ilike(f'%{search}%'),
                    Ativo.nome.ilike(f'%{search}%')
                )
            )
        
        # Ordenar por ticker
        query = query.order_by(Ativo.ticker)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(ativo_id):
        """Busca ativo por ID"""
        return Ativo.query.get(ativo_id)
    
    @staticmethod
    def get_by_ticker(ticker, mercado):
        """Busca ativo por ticker e mercado"""
        return Ativo.query.filter_by(
            ticker=ticker.upper(),
            mercado=mercado.upper()
        ).first()
    
    @staticmethod
    def create(data):
        """
        Cria novo ativo.
        
        Args:
            data: Dict com ticker, nome, tipo, classe, mercado, moeda, etc
        """
        # Verifica se j√° existe ativo com mesmo ticker e mercado
        existing = Ativo.query.filter_by(
            ticker=data['ticker'].upper(),
            mercado=data['mercado'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"Ativo {data['ticker']} j√° existe no mercado {data['mercado']}")
        
        ativo = Ativo(
            ticker=data['ticker'].upper(),
            nome=data['nome'],
            tipo=TipoAtivo[data['tipo'].upper()],
            classe=ClasseAtivo[data['classe'].upper()],
            mercado=data['mercado'].upper(),
            moeda=data['moeda'].upper(),
            preco_atual=Decimal(str(data['preco_atual'])) if data.get('preco_atual') else None,
            dividend_yield=Decimal(str(data['dividend_yield'])) if data.get('dividend_yield') else None,
            pl=Decimal(str(data['pl'])) if data.get('pl') else None,
            pvp=Decimal(str(data['pvp'])) if data.get('pvp') else None,
            roe=Decimal(str(data['roe'])) if data.get('roe') else None,
            ativo=data.get('ativo', True),
            deslistado=data.get('deslistado', False)
        )
        
        db.session.add(ativo)
        db.session.commit()
        return ativo
    
    @staticmethod
    def update(ativo_id, data):
        """
        Atualiza ativo.
        
        Args:
            ativo_id: ID do ativo
            data: Dict com campos a atualizar
        """
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            ativo.nome = data['nome']
        
        if 'tipo' in data:
            ativo.tipo = TipoAtivo[data['tipo'].upper()]
        
        if 'classe' in data:
            ativo.classe = ClasseAtivo[data['classe'].upper()]
        
        if 'mercado' in data:
            ativo.mercado = data['mercado'].upper()
        
        if 'moeda' in data:
            ativo.moeda = data['moeda'].upper()
        
        if 'preco_atual' in data:
            ativo.preco_atual = Decimal(str(data['preco_atual'])) if data['preco_atual'] else None
        
        if 'dividend_yield' in data:
            ativo.dividend_yield = Decimal(str(data['dividend_yield'])) if data['dividend_yield'] else None
        
        if 'pl' in data:
            ativo.pl = Decimal(str(data['pl'])) if data['pl'] else None
        
        if 'pvp' in data:
            ativo.pvp = Decimal(str(data['pvp'])) if data['pvp'] else None
        
        if 'roe' in data:
            ativo.roe = Decimal(str(data['roe'])) if data['roe'] else None
        
        if 'ativo' in data:
            ativo.ativo = data['ativo']
        
        if 'deslistado' in data:
            ativo.deslistado = data['deslistado']
            if data['deslistado'] and 'data_deslistagem' in data:
                ativo.data_deslistagem = data['data_deslistagem']
        
        db.session.commit()
        return ativo
    
    @staticmethod
    def delete(ativo_id):
        """Deleta ativo"""
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(ativo)
        db.session.commit()
        return True
    
    @staticmethod
    def get_by_mercado(mercado, page=1, per_page=50):
        """Lista ativos de um mercado espec√≠fico"""
        return Ativo.query.filter_by(
            mercado=mercado.upper(),
            ativo=True,
            deslistado=False
        ).order_by(Ativo.ticker).paginate(page=page, per_page=per_page, error_out=False)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/auth_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario

class LoginSchema(Schema):
    """Schema para valida√ß√£o de login"""
    username = fields.Str(required=True, validate=lambda x: len(x) >= 3)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 6)

    @validates('username')
    def validate_username(self, value):
        if len(value) < 3:
            raise ValidationError("Username deve ter pelo menos 3 caracteres")

class TokenResponseSchema(Schema):
    """Schema para resposta de tokens"""
    access_token = fields.Str(dump_only=True)
    refresh_token = fields.Str(dump_only=True)
    token_type = fields.Str(dump_only=True)
    expires_in = fields.Int(dump_only=True)

class UserMeSchema(SQLAlchemyAutoSchema):
    """Schema para dados do usu√°rio logado (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)

    role = fields.Method("get_role_str")

    def get_role_str(self, obj):
        return obj.role.value if obj.role else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/auth_schema.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario

class LoginSchema(Schema):
    """Schema para valida√ß√£o de login"""
    username = fields.Str(required=True, validate=lambda x: len(x) >= 3)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 6)
    
    @validates('username')
    def validate_username(self, value):
        if len(value) < 3:
            raise ValidationError("Username deve ter pelo menos 3 caracteres")

class TokenResponseSchema(Schema):
    """Schema para resposta de tokens"""
    access_token = fields.Str(dump_only=True)
    refresh_token = fields.Str(dump_only=True)
    token_type = fields.Str(dump_only=True)
    expires_in = fields.Int(dump_only=True)

class UserMeSchema(SQLAlchemyAutoSchema):
    """Schema para dados do usu√°rio logado (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)
    
    role = fields.Str(attribute='role')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/corretora_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretora Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Corretora, TipoCorretora
from app.database import db

class CorretoraCreateSchema(Schema):
    """Schema para cria√ß√£o de corretora"""
    nome = fields.Str(required=True, validate=lambda x: 2 <= len(x) <= 100)
    tipo = fields.Str(required=True)
    pais = fields.Str(required=True, validate=lambda x: len(x) == 2)
    moeda_padrao = fields.Str(required=True, validate=lambda x: len(x) == 3)
    saldo_atual = fields.Decimal(required=False, as_string=True, default="0.00")
    ativa = fields.Bool(required=False, default=True)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['corretora', 'exchange']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('pais')
    def validate_pais(self, value):
        """Valida c√≥digo ISO do pa√≠s (2 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 2:
            raise ValidationError("Pa√≠s deve ser c√≥digo ISO 3166-1 alpha-2 (ex: BR, US)")
    
    @validates('moeda_padrao')
    def validate_moeda(self, value):
        """Valida c√≥digo ISO da moeda (3 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")

class CorretoraUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de corretora"""
    nome = fields.Str(required=False, validate=lambda x: 2 <= len(x) <= 100)
    tipo = fields.Str(required=False)
    pais = fields.Str(required=False, validate=lambda x: len(x) == 2)
    moeda_padrao = fields.Str(required=False, validate=lambda x: len(x) == 3)
    saldo_atual = fields.Decimal(required=False, as_string=True)
    ativa = fields.Bool(required=False)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        valid_tipos = ['corretora', 'exchange']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('pais')
    def validate_pais(self, value):
        if not value.isupper() or len(value) != 2:
            raise ValidationError("Pa√≠s deve ser c√≥digo ISO 3166-1 alpha-2 (ex: BR, US)")
    
    @validates('moeda_padrao')
    def validate_moeda(self, value):
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")

class CorretoraResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de corretora"""
    class Meta:
        model = Corretora
        load_instance = False
        include_fk = True
    
    tipo = fields.Method("get_tipo_str")
    saldo_atual = fields.Decimal(as_string=True)
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/evento_corporativo_schema.py ---
# -*- coding: utf-8 -*-
"""
Exitus - EventoCorporativo Schemas - Valida√ß√£o Marshmallow
"""

from marshmallow import Schema, fields, validates, ValidationError, validates_schema
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import EventoCorporativo
from decimal import Decimal


class EventoCorporativoCreateSchema(Schema):
    """Schema para cria√ß√£o de evento corporativo"""
    
    ativo_id = fields.UUID(required=True)
    tipo_evento = fields.Str(required=True)
    descricao = fields.Str(required=True)
    data_anuncio = fields.Date(required=True)
    data_com = fields.Date(required=False, allow_none=True)
    data_aprovacao = fields.Date(required=False, allow_none=True)
    data_execucao = fields.Date(required=False, allow_none=True)
    proporcao = fields.Str(required=False, allow_none=True)
    preco_subscricao = fields.Decimal(required=False, allow_none=True, as_string=True)
    observacoes = fields.Str(required=False, allow_none=True)
    url_informacao = fields.Str(required=False, allow_none=True)
    
    @validates('tipo_evento')
    def validate_tipo(self, value):
        """Valida tipo de evento"""
        valid_tipos = [
            'desdobramento', 'grupamento', 'bonificacao', 'subscricao',
            'incorporacao', 'cisao', 'fusao', 'mudanca_ticker', 'oferta_publica'
        ]
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('proporcao')
    def validate_proporcao(self, value):
        """Valida formato da propor√ß√£o (ex: '2:1', '1:10')"""
        if value:
            if ':' not in value:
                raise ValidationError("Propor√ß√£o deve estar no formato 'X:Y' (ex: '2:1', '1:10')")
            
            try:
                partes = value.split(':')
                if len(partes) != 2:
                    raise ValidationError("Propor√ß√£o inv√°lida")
                
                numerador = float(partes[0])
                denominador = float(partes[1])
                
                if numerador <= 0 or denominador <= 0:
                    raise ValidationError("Valores da propor√ß√£o devem ser positivos")
            except (ValueError, IndexError):
                raise ValidationError("Formato de propor√ß√£o inv√°lido")
    
    @validates('preco_subscricao')
    def validate_preco(self, value):
        """Valida pre√ßo de subscri√ß√£o"""
        if value is not None and Decimal(str(value)) <= 0:
            raise ValidationError("Pre√ßo de subscri√ß√£o deve ser maior que zero")
    
    @validates_schema
    def validate_datas(self, data, **kwargs):
        """Valida ordem das datas"""
        data_anuncio = data.get('data_anuncio')
        data_com = data.get('data_com')
        data_aprovacao = data.get('data_aprovacao')
        data_execucao = data.get('data_execucao')
        
        if data_com and data_anuncio:
            if data_com < data_anuncio:
                raise ValidationError({'data_com': 'Data COM deve ser >= data de an√∫ncio'})
        
        if data_execucao and data_anuncio:
            if data_execucao < data_anuncio:
                raise ValidationError({'data_execucao': 'Data de execu√ß√£o deve ser >= data de an√∫ncio'})
        
        # Subscri√ß√£o requer pre√ßo
        if data.get('tipo_evento', '').lower() == 'subscricao':
            if not data.get('preco_subscricao'):
                raise ValidationError({'preco_subscricao': 'Subscri√ß√£o requer pre√ßo de subscri√ß√£o'})


class EventoCorporativoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de evento corporativo"""
    
    tipo_evento = fields.Str(required=False)
    descricao = fields.Str(required=False)
    data_anuncio = fields.Date(required=False)
    data_com = fields.Date(required=False, allow_none=True)
    data_aprovacao = fields.Date(required=False, allow_none=True)
    data_execucao = fields.Date(required=False, allow_none=True)
    proporcao = fields.Str(required=False, allow_none=True)
    preco_subscricao = fields.Decimal(required=False, allow_none=True, as_string=True)
    observacoes = fields.Str(required=False, allow_none=True)
    url_informacao = fields.Str(required=False, allow_none=True)


class EventoCorporativoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de evento corporativo"""
    
    class Meta:
        model = EventoCorporativo
        load_instance = False
        include_fk = True
    
    tipo_evento = fields.Method("get_tipo_str")
    preco_subscricao = fields.Decimal(as_string=True)
    
    ativo = fields.Method("get_ativo_info")
    
    def get_tipo_str(self, obj):
        return obj.tipo_evento.value if obj.tipo_evento else None
    
    def get_ativo_info(self, obj):
        if obj.ativo:
            return {
                'id': str(obj.ativo.id),
                'ticker': obj.ativo.ticker,
                'nome': obj.ativo.nome,
                'tipo': obj.ativo.tipo.value
            }
        return None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/movimentacao_caixa_schema.py ---
# -*- coding: utf-8 -*-
"""
Exitus - MovimentacaoCaixa Schemas - Valida√ß√£o Marshmallow
"""

from marshmallow import Schema, fields, validates, ValidationError, validates_schema
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import MovimentacaoCaixa
from decimal import Decimal


class MovimentacaoCaixaCreateSchema(Schema):
    """Schema para cria√ß√£o de movimenta√ß√£o"""
    
    corretora_id = fields.UUID(required=True)
    corretora_destino_id = fields.UUID(required=False, allow_none=True)
    provento_id = fields.UUID(required=False, allow_none=True)
    tipo_movimentacao = fields.Str(required=True)
    valor = fields.Decimal(required=True, as_string=True)
    moeda = fields.Str(required=True)
    data_movimentacao = fields.Date(required=True)
    descricao = fields.Str(required=False, allow_none=True)
    comprovante = fields.Str(required=False, allow_none=True)
    
    @validates('tipo_movimentacao')
    def validate_tipo(self, value):
        """Valida tipo de movimenta√ß√£o"""
        valid_tipos = [
            'deposito', 'saque', 'transferencia_enviada', 
            'transferencia_recebida', 'credito_provento', 
            'pagamento_taxa', 'pagamento_imposto', 'ajuste', 'outro'
        ]
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('valor')
    def validate_valor(self, value):
        """Valida valor positivo"""
        if Decimal(str(value)) <= 0:
            raise ValidationError("Valor deve ser maior que zero")
    
    @validates('moeda')
    def validate_moeda(self, value):
        """Valida c√≥digo ISO da moeda"""
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")
    
    @validates_schema
    def validate_transferencia(self, data, **kwargs):
        """Valida transfer√™ncias"""
        tipo = data.get('tipo_movimentacao', '').lower()
        
        if tipo in ['transferencia_enviada', 'transferencia_recebida']:
            if not data.get('corretora_destino_id'):
                raise ValidationError({'corretora_destino_id': 'Transfer√™ncia requer corretora de destino'})
        
        if tipo == 'credito_provento':
            if not data.get('provento_id'):
                raise ValidationError({'provento_id': 'Cr√©dito de provento requer provento_id'})


class MovimentacaoCaixaUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de movimenta√ß√£o"""
    
    tipo_movimentacao = fields.Str(required=False)
    valor = fields.Decimal(required=False, as_string=True)
    moeda = fields.Str(required=False)
    data_movimentacao = fields.Date(required=False)
    descricao = fields.Str(required=False, allow_none=True)
    comprovante = fields.Str(required=False, allow_none=True)


class MovimentacaoCaixaResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de movimenta√ß√£o"""
    
    class Meta:
        model = MovimentacaoCaixa
        load_instance = False
        include_fk = True
    
    tipo_movimentacao = fields.Method("get_tipo_str")
    valor = fields.Decimal(as_string=True)
    
    corretora = fields.Method("get_corretora_info")
    corretora_destino = fields.Method("get_corretora_destino_info")
    provento = fields.Method("get_provento_info")
    
    def get_tipo_str(self, obj):
        return obj.tipo_movimentacao.value if obj.tipo_movimentacao else None
    
    def get_corretora_info(self, obj):
        if obj.corretora:
            return {
                'id': str(obj.corretora.id),
                'nome': obj.corretora.nome,
                'tipo': obj.corretora.tipo.value
            }
        return None
    
    def get_corretora_destino_info(self, obj):
        if obj.corretora_destino:
            return {
                'id': str(obj.corretora_destino.id),
                'nome': obj.corretora_destino.nome
            }
        return None
    
    def get_provento_info(self, obj):
        if obj.provento:
            return {
                'id': str(obj.provento.id),
                'tipo': obj.provento.tipo_provento.value,
                'valor': float(obj.provento.valor_liquido)
            }
        return None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/posicao_schema.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Posicao Schemas - Valida√ß√£o Marshmallow
"""

from marshmallow import Schema, fields, validates, ValidationError
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Posicao


class PosicaoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de posi√ß√£o"""
    
    class Meta:
        model = Posicao
        load_instance = False
        include_fk = True
    
    # Campos calculados como string para JSON
    quantidade = fields.Decimal(as_string=True)
    preco_medio = fields.Decimal(as_string=True)
    custo_total = fields.Decimal(as_string=True)
    taxas_acumuladas = fields.Decimal(as_string=True)
    impostos_acumulados = fields.Decimal(as_string=True)
    valor_atual = fields.Decimal(as_string=True)
    lucro_prejuizo_realizado = fields.Decimal(as_string=True)
    lucro_prejuizo_nao_realizado = fields.Decimal(as_string=True)
    
    # Nested fields
    ativo = fields.Method("get_ativo_info")
    corretora = fields.Method("get_corretora_info")
    
    def get_ativo_info(self, obj):
        """Retorna info b√°sica do ativo"""
        if obj.ativo:
            return {
                'id': str(obj.ativo.id),
                'ticker': obj.ativo.ticker,
                'nome': obj.ativo.nome,
                'tipo': obj.ativo.tipo.value,
                'classe': obj.ativo.classe.value,
                'mercado': obj.ativo.mercado,
                'preco_atual': float(obj.ativo.preco_atual) if obj.ativo.preco_atual else None
            }
        return None
    
    def get_corretora_info(self, obj):
        """Retorna info b√°sica da corretora"""
        if obj.corretora:
            return {
                'id': str(obj.corretora.id),
                'nome': obj.corretora.nome,
                'tipo': obj.corretora.tipo.value
            }
        return None


class PosicaoResumoSchema(Schema):
    """Schema para resumo consolidado de posi√ß√µes"""
    
    quantidade_posicoes = fields.Int()
    total_investido = fields.Float()
    total_valor_atual = fields.Float()
    total_lucro_realizado = fields.Float()
    total_lucro_nao_realizado = fields.Float()
    lucro_total = fields.Float()
    roi_percentual = fields.Float()


class PosicaoConsolidadaSchema(Schema):
    """Schema para posi√ß√£o consolidada por ativo"""
    
    ativo = fields.Dict()
    quantidade_total = fields.Float()
    preco_medio = fields.Float()
    custo_total = fields.Float()
    valor_atual = fields.Float()
    lucro_prejuizo = fields.Float()
    corretoras = fields.List(fields.Dict())

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/provento_schema.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Provento Schemas - Valida√ß√£o Marshmallow
"""

from marshmallow import Schema, fields, validates, ValidationError, validates_schema
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Provento
from decimal import Decimal


class ProventoCreateSchema(Schema):
    """Schema para cria√ß√£o de provento"""
    
    ativo_id = fields.UUID(required=True)
    tipo_provento = fields.Str(required=True)
    valor_por_acao = fields.Decimal(required=True, as_string=True)
    quantidade_ativos = fields.Decimal(required=True, as_string=True)
    valor_bruto = fields.Decimal(required=False, as_string=True)
    imposto_retido = fields.Decimal(required=False, as_string=True, load_default=0)
    valor_liquido = fields.Decimal(required=False, as_string=True)
    data_com = fields.Date(required=True)
    data_pagamento = fields.Date(required=True)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo_provento')
    def validate_tipo(self, value):
        """Valida tipo de provento"""
        valid_tipos = ['dividendo', 'jcp', 'rendimento', 'bonificacao', 'direito']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('valor_por_acao')
    def validate_valor(self, value):
        """Valida valor positivo"""
        if Decimal(str(value)) <= 0:
            raise ValidationError("Valor por a√ß√£o deve ser maior que zero")
    
    @validates('quantidade_ativos')
    def validate_quantidade(self, value):
        """Valida quantidade positiva"""
        if Decimal(str(value)) <= 0:
            raise ValidationError("Quantidade deve ser maior que zero")
    
    @validates_schema
    def validate_datas(self, data, **kwargs):
        """Valida datas"""
        if data.get('data_pagamento') and data.get('data_com'):
            if data['data_pagamento'] < data['data_com']:
                raise ValidationError({'data_pagamento': 'Data de pagamento deve ser >= data COM'})
        
        if data.get('valor_bruto') and data.get('imposto_retido'):
            if Decimal(str(data['imposto_retido'])) > Decimal(str(data['valor_bruto'])):
                raise ValidationError({'imposto_retido': 'Imposto n√£o pode ser maior que valor bruto'})


class ProventoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de provento"""
    
    tipo_provento = fields.Str(required=False)
    valor_por_acao = fields.Decimal(required=False, as_string=True)
    quantidade_ativos = fields.Decimal(required=False, as_string=True)
    valor_bruto = fields.Decimal(required=False, as_string=True)
    imposto_retido = fields.Decimal(required=False, as_string=True)
    valor_liquido = fields.Decimal(required=False, as_string=True)
    data_com = fields.Date(required=False)
    data_pagamento = fields.Date(required=False)
    observacoes = fields.Str(required=False, allow_none=True)


class ProventoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de provento"""
    
    class Meta:
        model = Provento
        load_instance = False
        include_fk = True
    
    tipo_provento = fields.Method("get_tipo_str")
    valor_por_acao = fields.Decimal(as_string=True)
    quantidade_ativos = fields.Decimal(as_string=True)
    valor_bruto = fields.Decimal(as_string=True)
    imposto_retido = fields.Decimal(as_string=True)
    valor_liquido = fields.Decimal(as_string=True)
    
    ativo = fields.Method("get_ativo_info")
    
    def get_tipo_str(self, obj):
        return obj.tipo_provento.value if obj.tipo_provento else None
    
    def get_ativo_info(self, obj):
        if obj.ativo:
            return {
                'id': str(obj.ativo.id),
                'ticker': obj.ativo.ticker,
                'nome': obj.ativo.nome,
                'tipo': obj.ativo.tipo.value
            }
        return None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/transacao_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacao Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, validates_schema
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Transacao, TipoTransacao
from datetime import datetime
from decimal import Decimal

class TransacaoCreateSchema(Schema):
    """Schema para cria√ß√£o de transa√ß√£o"""
    tipo = fields.Str(required=True)
    ativo_id = fields.UUID(required=True)
    corretora_id = fields.UUID(required=True)
    data_transacao = fields.DateTime(required=True)
    quantidade = fields.Decimal(required=True, as_string=True)
    preco_unitario = fields.Decimal(required=True, as_string=True)
    taxa_corretagem = fields.Decimal(required=False, as_string=True, load_default="0")
    taxa_liquidacao = fields.Decimal(required=False, as_string=True, load_default="0")
    emolumentos = fields.Decimal(required=False, as_string=True, load_default="0")
    imposto = fields.Decimal(required=False, as_string=True, load_default="0")
    outros_custos = fields.Decimal(required=False, as_string=True, load_default="0")
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['compra', 'venda', 'dividendo', 'jcp', 'bonificacao', 'desdobramento', 'grupamento']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('quantidade')
    def validate_quantidade(self, value):
        """Valida quantidade positiva"""
        if Decimal(str(value)) <= 0:
            raise ValidationError("Quantidade deve ser maior que zero")
    
    @validates('preco_unitario')
    def validate_preco(self, value):
        """Valida pre√ßo n√£o negativo"""
        if Decimal(str(value)) < 0:
            raise ValidationError("Pre√ßo unit√°rio n√£o pode ser negativo")
    
    @validates_schema
    def validate_compra_venda(self, data, **kwargs):
        """Valida√ß√µes espec√≠ficas por tipo"""
        tipo = data.get('tipo', '').lower()
        preco = Decimal(str(data.get('preco_unitario', 0)))
        
        # Compra/venda devem ter pre√ßo > 0
        if tipo in ['compra', 'venda'] and preco == 0:
            raise ValidationError(
                {"preco_unitario": "Compra/venda deve ter pre√ßo unit√°rio maior que zero"}
            )

class TransacaoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de transa√ß√£o"""
    data_transacao = fields.DateTime(required=False)
    quantidade = fields.Decimal(required=False, as_string=True)
    preco_unitario = fields.Decimal(required=False, as_string=True)
    taxa_corretagem = fields.Decimal(required=False, as_string=True)
    taxa_liquidacao = fields.Decimal(required=False, as_string=True)
    emolumentos = fields.Decimal(required=False, as_string=True)
    imposto = fields.Decimal(required=False, as_string=True)
    outros_custos = fields.Decimal(required=False, as_string=True)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('quantidade')
    def validate_quantidade(self, value):
        if Decimal(str(value)) <= 0:
            raise ValidationError("Quantidade deve ser maior que zero")
    
    @validates('preco_unitario')
    def validate_preco(self, value):
        if Decimal(str(value)) < 0:
            raise ValidationError("Pre√ßo unit√°rio n√£o pode ser negativo")

class TransacaoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de transa√ß√£o"""
    class Meta:
        model = Transacao
        load_instance = False
        include_fk = True
    
    tipo = fields.Method("get_tipo_str")
    quantidade = fields.Decimal(as_string=True)
    preco_unitario = fields.Decimal(as_string=True)
    valor_total = fields.Decimal(as_string=True)
    taxa_corretagem = fields.Decimal(as_string=True)
    taxa_liquidacao = fields.Decimal(as_string=True)
    emolumentos = fields.Decimal(as_string=True)
    imposto = fields.Decimal(as_string=True)
    outros_custos = fields.Decimal(as_string=True)
    custos_totais = fields.Decimal(as_string=True)
    valor_liquido = fields.Decimal(as_string=True)
    
    # Campos relacionados (nested)
    ativo = fields.Method("get_ativo_info")
    corretora = fields.Method("get_corretora_info")
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None
    
    def get_ativo_info(self, obj):
        """Retorna info b√°sica do ativo"""
        if obj.ativo:
            return {
                "id": str(obj.ativo.id),
                "ticker": obj.ativo.ticker,
                "nome": obj.ativo.nome,
                "tipo": obj.ativo.tipo.value,
                "mercado": obj.ativo.mercado
            }
        return None
    
    def get_corretora_info(self, obj):
        """Retorna info b√°sica da corretora"""
        if obj.corretora:
            return {
                "id": str(obj.corretora.id),
                "nome": obj.corretora.nome,
                "tipo": obj.corretora.tipo.value
            }
        return None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/usuario_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuario Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario, UserRole
from app.database import db

class UsuarioCreateSchema(Schema):
    """Schema para cria√ß√£o de usu√°rio"""
    username = fields.Str(required=True, validate=lambda x: 3 <= len(x) <= 50)
    email = fields.Email(required=True)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 8, load_only=True)
    nome_completo = fields.Str(required=False, allow_none=True)
    role = fields.Str(required=False, default='user')
    
    @validates('username')
    def validate_username(self, value):
        """Valida se username j√° existe"""
        if Usuario.query.filter_by(username=value).first():
            raise ValidationError("Username j√° existe")
    
    @validates('email')
    def validate_email(self, value):
        """Valida se email j√° existe"""
        if Usuario.query.filter_by(email=value).first():
            raise ValidationError("Email j√° existe")
    
    @validates('role')
    def validate_role(self, value):
        """Valida se role √© v√°lida"""
        valid_roles = ['admin', 'user', 'readonly']
        if value.lower() not in valid_roles:
            raise ValidationError(f"Role inv√°lida. Op√ß√µes: {', '.join(valid_roles)}")

class UsuarioUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de usu√°rio"""
    email = fields.Email(required=False)
    nome_completo = fields.Str(required=False, allow_none=True)
    ativo = fields.Bool(required=False)
    role = fields.Str(required=False)
    
    @validates('email')
    def validate_email_unique(self, value):
        """Valida se email j√° existe (exceto o pr√≥prio)"""
        # Valida√ß√£o adicional ser√° feita no service
        pass
    
    @validates('role')
    def validate_role(self, value):
        """Valida se role √© v√°lida"""
        valid_roles = ['admin', 'user', 'readonly']
        if value.lower() not in valid_roles:
            raise ValidationError(f"Role inv√°lida. Op√ß√µes: {', '.join(valid_roles)}")

class ChangePasswordSchema(Schema):
    """Schema para troca de senha"""
    old_password = fields.Str(required=True, validate=lambda x: len(x) >= 6)
    new_password = fields.Str(required=True, validate=lambda x: len(x) >= 8)

class UsuarioResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de usu√°rio (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)
    
    role = fields.Method("get_role_str")
    
    def get_role_str(self, obj):
        """Converte Enum para string"""
        return obj.role.value if obj.role else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/run_all_seeds.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Executar Todos os Seeds
Script master para popular o banco com dados iniciais
"""

import sys
from app.seeds.seed_usuarios import seed_usuarios
from app.seeds.seed_ativos_br import seed_ativos_br
from app.seeds.seed_regras_fiscais_br import seed_regras_fiscais_br
from app.seeds.seed_feriados_b3 import seed_feriados_b3
from app.seeds.seed_fontes_dados import seed_fontes_dados


def run_all_seeds():
    """Executa todos os seeds em sequ√™ncia"""
    
    print("\n" + "=" * 60)
    print("  EXITUS - EXECUTAR TODOS OS SEEDS")
    print("=" * 60)
    print("\nEste script ir√° popular o banco com dados iniciais:")
    print("  1. Usu√°rios (4)")
    print("  2. Ativos BR (25)")
    print("  3. Regras Fiscais BR (6)")
    print("  4. Feriados B3 2025-2026 (30)")
    print("  5. Fontes de Dados (7)")
    print("\n‚ö† ATEN√á√ÉO: Seeds existentes ser√£o solicitados para confirma√ß√£o.\n")
    
    resposta = input("Deseja continuar? (s/N): ").lower()
    if resposta != 's':
        print("\n‚úó Opera√ß√£o cancelada pelo usu√°rio.\n")
        return
    
    seeds = [
        ("Usu√°rios", seed_usuarios),
        ("Ativos BR", seed_ativos_br),
        ("Regras Fiscais BR", seed_regras_fiscais_br),
        ("Feriados B3", seed_feriados_b3),
        ("Fontes de Dados", seed_fontes_dados),
    ]
    
    sucessos = 0
    erros = 0
    
    for nome, seed_func in seeds:
        print("\n" + "=" * 60)
        try:
            seed_func()
            sucessos += 1
        except KeyboardInterrupt:
            print(f"\n\n‚ö† Seed '{nome}' interrompido pelo usu√°rio.")
            print("Processo de seeds cancelado.\n")
            sys.exit(1)
        except Exception as e:
            print(f"\n‚úó Erro ao executar seed '{nome}': {e}")
            erros += 1
            resposta = input("\nDeseja continuar com os pr√≥ximos seeds? (s/N): ").lower()
            if resposta != 's':
                break
    
    # Resumo final
    print("\n" + "=" * 60)
    print("  RESUMO FINAL")
    print("=" * 60)
    print(f"‚úì Seeds executados com sucesso: {sucessos}")
    if erros > 0:
        print(f"‚úó Seeds com erro: {erros}")
    print("=" * 60 + "\n")
    
    if erros == 0:
        print("üéâ Todos os seeds foram executados com sucesso!")
        print("O banco de dados est√° pronto para uso.\n")
    else:
        print("‚ö† Alguns seeds falharam. Verifique os erros acima.\n")


if __name__ == '__main__':
    run_all_seeds()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_ativos_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Ativos Brasileiros
Popular tabela ativo com a√ß√µes e FIIs da B3
"""

from app import create_app
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal


def seed_ativos_br():
    """Cria ativos brasileiros (B3)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Ativos Brasileiros (B3)")
        print("=" * 50)
        
        # Verificar se j√° existem ativos
        count = Ativo.query.filter_by(mercado='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} ativos brasileiros cadastrados.")
            resposta = input("Deseja recriar os ativos BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar ativos BR existentes
            Ativo.query.filter_by(mercado='BR').delete()
            db.session.commit()
            print("‚úì Ativos brasileiros anteriores removidos.")
        
        # A√ß√µes mais negociadas da B3
        acoes = [
            # Ticker, Nome, Setor, Pre√ßo Inicial
            ('PETR4', 'Petrobras PN', 'Petr√≥leo e G√°s', Decimal('38.50')),
            ('VALE3', 'Vale ON', 'Minera√ß√£o', Decimal('62.80')),
            ('ITUB4', 'Ita√∫ Unibanco PN', 'Bancos', Decimal('28.45')),
            ('BBDC4', 'Bradesco PN', 'Bancos', Decimal('13.20')),
            ('BBAS3', 'Banco do Brasil ON', 'Bancos', Decimal('25.60')),
            ('MGLU3', 'Magazine Luiza ON', 'Varejo', Decimal('8.75')),
            ('WEGE3', 'WEG ON', 'M√°quinas e Equipamentos', Decimal('42.30')),
            ('RENT3', 'Localiza ON', 'Loca√ß√£o de Ve√≠culos', Decimal('56.90')),
            ('RAIL3', 'Rumo ON', 'Transporte', Decimal('18.45')),
            ('SUZB3', 'Suzano ON', 'Papel e Celulose', Decimal('52.80')),
            ('KLBN11', 'Klabin Units', 'Papel e Celulose', Decimal('22.15')),
            ('ELET3', 'Eletrobras ON', 'Energia El√©trica', Decimal('42.10')),
            ('CMIG4', 'Cemig PN', 'Energia El√©trica', Decimal('10.85')),
            ('CPLE6', 'Copel PNB', 'Energia El√©trica', Decimal('8.95')),
            ('ABEV3', 'Ambev ON', 'Bebidas', Decimal('11.20')),
        ]
        
        # FIIs mais negociados
        fiis = [
            # Ticker, Nome, Segmento, Pre√ßo Inicial
            ('HGLG11', 'CSHG Log√≠stica FII', 'Log√≠stica', Decimal('152.30')),
            ('VISC11', 'Vinci Shopping Centers FII', 'Shopping', Decimal('105.80')),
            ('KNRI11', 'Kinea Renda Imobili√°ria FII', 'H√≠brido', Decimal('98.45')),
            ('BTLG11', 'BTG Pactual Log√≠stica FII', 'Log√≠stica', Decimal('102.70')),
            ('XPML11', 'XP Malls FII', 'Shopping', Decimal('95.60')),
            ('MXRF11', 'Maxi Renda FII', 'H√≠brido', Decimal('10.25')),
            ('TRXF11', 'TRX Real Estate FII', 'Lajes Corporativas', Decimal('95.30')),
            ('KNCR11', 'Kinea Rendimentos Imobili√°rios FII', 'Papel', Decimal('110.50')),
            ('LVBI11', 'VBI Log√≠stico FII', 'Log√≠stica', Decimal('98.20')),
            ('GGRC11', 'GGR Covepi Renda FII', 'Lajes Corporativas', Decimal('105.40')),
        ]
        
        created_ativos = []
        
        # Criar a√ß√µes
        print("\nüìà Criando A√ß√µes...")
        for ticker, nome, setor, preco in acoes:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.ACAO,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Setor: {setor}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:35} - R$ {preco}")
        
        # Criar FIIs
        print("\nüè¢ Criando FIIs...")
        for ticker, nome, segmento, preco in fiis:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.FII,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Segmento: {segmento}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:40} - R$ {preco}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_ativos)} ativos criados com sucesso!")
            print(f"  - {len(acoes)} a√ß√µes")
            print(f"  - {len(fiis)} FIIs")
            print("=" * 50 + "\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar ativos: {e}")
            raise


if __name__ == '__main__':
    seed_ativos_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_feriados_b3.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Feriados B3
Popular tabela feriado_mercado com feriados da B3
"""

from app import create_app
from app.database import db
from app.models import FeriadoMercado, TipoFeriado
from datetime import date


def seed_feriados_b3():
    """Cria feriados da B3 para 2025 e 2026"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Feriados B3 (2025-2026)")
        print("=" * 50)
        
        # Verificar se j√° existem feriados B3
        count = FeriadoMercado.query.filter_by(pais='BR', mercado='B3').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} feriados B3 cadastrados.")
            resposta = input("Deseja recriar os feriados? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar feriados B3 existentes
            FeriadoMercado.query.filter_by(pais='BR', mercado='B3').delete()
            db.session.commit()
            print("‚úì Feriados B3 anteriores removidos.")
        
        # Feriados B3 2025
        feriados_2025 = [
            (date(2025, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2025, 3, 3), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2025, 3, 4), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2025, 4, 18), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2025, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2025, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2025, 6, 19), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2025, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2025, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2025, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        # Feriados B3 2026
        feriados_2026 = [
            (date(2026, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2026, 2, 16), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2026, 2, 17), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2026, 4, 3), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2026, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2026, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2026, 6, 4), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2026, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2026, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2026, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        todos_feriados = feriados_2025 + feriados_2026
        created_feriados = []
        
        print("\nüìÖ Criando Feriados 2025...")
        for data_feriado, nome, tipo, recorrente in feriados_2025:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        print("\nüìÖ Criando Feriados 2026...")
        for data_feriado, nome, tipo, recorrente in feriados_2026:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_feriados)} feriados criados!")
            print(f"  - 2025: {len(feriados_2025)} feriados")
            print(f"  - 2026: {len(feriados_2026)} feriados")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  üö´ = Fechamento total (sem preg√£o)")
            print("  ‚è∞ = Fechamento antecipado (meio per√≠odo)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar feriados: {e}")
            raise


if __name__ == '__main__':
    seed_feriados_b3()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_fontes_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Fontes de Dados
Popular tabela fonte_dados com APIs de cota√ß√µes
"""

from app import create_app
from app.database import db
from app.models import FonteDados, TipoFonteDados


def seed_fontes_dados():
    """Cria fontes de dados (APIs)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Fontes de Dados (APIs)")
        print("=" * 50)
        
        # Verificar se j√° existem fontes
        count = FonteDados.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} fontes de dados cadastradas.")
            resposta = input("Deseja recriar as fontes? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar fontes existentes
            FonteDados.query.delete()
            db.session.commit()
            print("‚úì Fontes de dados anteriores removidas.")
        
        # Fontes de dados
        fontes = [
            {
                'nome': 'yfinance',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://query1.finance.yahoo.com',
                'requer_autenticacao': False,
                'rate_limit': '2000/hour',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'Biblioteca Python gratuita para Yahoo Finance. Boa cobertura global, incluindo B3.'
            },
            {
                'nome': 'brapi.dev',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://brapi.dev/api',
                'requer_autenticacao': False,
                'rate_limit': '100/minute',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'API brasileira gratuita especializada em ativos da B3. Dados em tempo real.'
            },
            {
                'nome': 'Alpha Vantage',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://www.alphavantage.co/query',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API gratuita com chave. Limite de 5 requisi√ß√µes por minuto (plano free).'
            },
            {
                'nome': 'Finnhub',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://finnhub.io/api/v1',
                'requer_autenticacao': True,
                'rate_limit': '60/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API com plano gratuito. Boa cobertura de mercados globais e not√≠cias.'
            },
            {
                'nome': 'IEX Cloud',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://cloud.iexapis.com/stable',
                'requer_autenticacao': True,
                'rate_limit': '50000/month',
                'ativa': True,
                'prioridade': 3,
                'observacoes': 'API focada em mercado americano. Plano gratuito com limite mensal.'
            },
            {
                'nome': 'Polygon.io',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://api.polygon.io',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': False,
                'prioridade': 4,
                'observacoes': 'API premium com dados hist√≥ricos detalhados. Desativada por padr√£o.'
            },
            {
                'nome': 'Manual',
                'tipo_fonte': TipoFonteDados.MANUAL,
                'url_base': None,
                'requer_autenticacao': False,
                'rate_limit': None,
                'ativa': True,
                'prioridade': 99,
                'observacoes': 'Entrada manual de dados pelo usu√°rio.'
            },
        ]
        
        created_fontes = []
        
        print("\nüîå Criando Fontes de Dados...")
        for fonte_data in fontes:
            fonte = FonteDados(
                nome=fonte_data['nome'],
                tipo_fonte=fonte_data['tipo_fonte'],
                url_base=fonte_data['url_base'],
                requer_autenticacao=fonte_data['requer_autenticacao'],
                rate_limit=fonte_data['rate_limit'],
                ativa=fonte_data['ativa'],
                prioridade=fonte_data['prioridade'],
                observacoes=fonte_data['observacoes']
            )
            db.session.add(fonte)
            created_fontes.append(fonte)
            
            status_icon = "‚úì" if fonte.ativa else "‚úó"
            auth_icon = "üîê" if fonte.requer_autenticacao else "üîì"
            
            print(f"  {status_icon} {auth_icon} {fonte.nome:20} | Prioridade: {fonte.prioridade} | Limite: {fonte.rate_limit or 'N/A'}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_fontes)} fontes de dados criadas!")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  ‚úì = Ativa    | ‚úó = Inativa")
            print("  üîì = Sem auth | üîê = Requer chave API")
            print("\nüí° PRIORIDADE:")
            print("  1 = Alta (usar primeiro)")
            print("  2-3 = M√©dia (fallback)")
            print("  99 = Baixa (manual)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar fontes: {e}")
            raise


if __name__ == '__main__':
    seed_fontes_dados()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_modulo2.py ---
# -*- coding: utf-8 -*-
"""Exitus - Seed M√≥dulo 2 - Usu√°rios, Corretoras e Ativos"""

from app.database import db
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal

def seed_usuarios():
    """Seed de usu√°rios"""
    print("\nüîê Seeding Usu√°rios...")
    
    usuarios = [
        {
            "username": "admin",
            "email": "admin@exitus.com",
            "nome_completo": "Administrador do Sistema",
            "password": "admin123",
            "role": UserRole.ADMIN
        },
        {
            "username": "joao.silva",
            "email": "joao.silva@email.com",
            "nome_completo": "Jo√£o Silva",
            "password": "user123",
            "role": UserRole.USER
        },
        {
            "username": "maria.santos",
            "email": "maria.santos@email.com",
            "nome_completo": "Maria Santos",
            "password": "user123",
            "role": UserRole.USER
        }
    ]
    
    for data in usuarios:
        existing = Usuario.query.filter_by(username=data['username']).first()
        if not existing:
            user = Usuario(
                username=data['username'],
                email=data['email'],
                nome_completo=data['nome_completo'],
                role=data['role'],
                ativo=True
            )
            user.set_password(data['password'])
            db.session.add(user)
            print(f"  ‚úÖ Criado: {data['username']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['username']}")
    
    db.session.commit()
    print("‚úÖ Usu√°rios criados!")

def seed_corretoras():
    """Seed de corretoras para usu√°rio joao.silva"""
    print("\nüè¶ Seeding Corretoras...")
    
    user = Usuario.query.filter_by(username='joao.silva').first()
    if not user:
        print("‚ùå Usu√°rio joao.silva n√£o encontrado")
        return
    
    corretoras = [
        {
            "nome": "XP Investimentos",
            "tipo": TipoCorretora.CORRETORA,
            "pais": "BR",
            "moeda_padrao": "BRL"
        },
        {
            "nome": "Clear Corretora",
            "tipo": TipoCorretora.CORRETORA,
            "pais": "BR",
            "moeda_padrao": "BRL"
        }
    ]
    
    for data in corretoras:
        existing = Corretora.query.filter_by(
            usuario_id=user.id,
            nome=data['nome']
        ).first()
        
        if not existing:
            corretora = Corretora(
                usuario_id=user.id,
                nome=data['nome'],
                tipo=data['tipo'],
                pais=data['pais'],
                moeda_padrao=data['moeda_padrao'],
                saldo_atual=Decimal('0.00'),
                ativa=True
            )
            db.session.add(corretora)
            print(f"  ‚úÖ Criado: {data['nome']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['nome']}")
    
    db.session.commit()
    print("‚úÖ Corretoras criadas!")

def seed_ativos():
    """Seed de ativos - MANT√âM OS 25 ATIVOS ORIGINAIS"""
    print("\nüìà Seeding Ativos...")
    
    ativos_br = [
        # A√ß√µes BR
        {"ticker": "PETR4", "nome": "Petrobras PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "38.50", "observacoes": "Setor: Petr√≥leo e G√°s"},
        {"ticker": "VALE3", "nome": "Vale ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "62.80", "observacoes": "Setor: Minera√ß√£o"},
        {"ticker": "ITUB4", "nome": "Ita√∫ Unibanco PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "28.45", "observacoes": "Setor: Bancos"},
        {"ticker": "BBDC4", "nome": "Bradesco PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "13.20", "observacoes": "Setor: Bancos"},
        {"ticker": "BBAS3", "nome": "Banco do Brasil ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "25.60", "observacoes": "Setor: Bancos"},
        {"ticker": "MGLU3", "nome": "Magazine Luiza ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "8.75", "observacoes": "Setor: Varejo"},
        {"ticker": "WEGE3", "nome": "WEG ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "42.30", "observacoes": "Setor: M√°quinas e Equipamentos"},
        {"ticker": "RENT3", "nome": "Localiza ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "56.90", "observacoes": "Setor: Loca√ß√£o de Ve√≠culos"},
        {"ticker": "RAIL3", "nome": "Rumo ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "18.45", "observacoes": "Setor: Transporte"},
        {"ticker": "SUZB3", "nome": "Suzano ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "52.80", "observacoes": "Setor: Papel e Celulose"},
        {"ticker": "KLBN11", "nome": "Klabin Units", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "22.15", "observacoes": "Setor: Papel e Celulose"},
        {"ticker": "ELET3", "nome": "Eletrobras ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "42.10", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "CMIG4", "nome": "Cemig PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "10.85", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "CPLE6", "nome": "Copel PNB", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "8.95", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "ABEV3", "nome": "Ambev ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "11.20", "observacoes": "Setor: Bebidas"},
        
        # FIIs BR
        {"ticker": "HGLG11", "nome": "CSHG Log√≠stica FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "152.30", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "KNRI11", "nome": "Kinea Renda Imobili√°ria FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "98.45", "observacoes": "Segmento: H√≠brido"},
        {"ticker": "BTLG11", "nome": "BTG Pactual Log√≠stica FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "102.70", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "MXRF11", "nome": "Maxi Renda FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "10.25", "observacoes": "Segmento: H√≠brido"},
        {"ticker": "KNCR11", "nome": "Kinea Rendimentos Imobili√°rios FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "110.50", "observacoes": "Segmento: Papel"},
        {"ticker": "LVBI11", "nome": "VBI Log√≠stico FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "98.20", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "GGRC11", "nome": "GGR Covepi Renda FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "105.40", "observacoes": "Segmento: Lajes Corporativas"},
        {"ticker": "XPML11", "nome": "XP Malls FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "9.85", "observacoes": "Segmento: Shoppings"},
        {"ticker": "VISC11", "nome": "Vinci Shopping Centers FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "7.90", "observacoes": "Segmento: Shoppings"},
        {"ticker": "TRXF11", "nome": "TRX Real Estate FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "92.30", "observacoes": "Segmento: Lajes Corporativas"},
    ]
    
    for data in ativos_br:
        existing = Ativo.query.filter_by(ticker=data['ticker'], mercado=data['mercado']).first()
        if not existing:
            ativo = Ativo(
                ticker=data['ticker'],
                nome=data['nome'],
                tipo=data['tipo'],
                classe=data['classe'],
                mercado=data['mercado'],
                moeda=data['moeda'],
                preco_atual=Decimal(data['preco_atual']) if data.get('preco_atual') else None,
                observacoes=data.get('observacoes'),
                ativo=True,
                deslistado=False
            )
            db.session.add(ativo)
            print(f"  ‚úÖ Criado: {data['ticker']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['ticker']}")
    
    db.session.commit()
    print("‚úÖ Ativos criados!")

def run_seed_modulo2():
    """Executa todos os seeds do M√≥dulo 2"""
    print("=" * 60)
    print("üå± SEED M√ìDULO 2 - Usu√°rios, Corretoras, Ativos")
    print("=" * 60)
    
    seed_usuarios()
    seed_corretoras()
    seed_ativos()
    
    print("\n" + "=" * 60)
    print("‚úÖ SEED M√ìDULO 2 CONCLU√çDO!")
    print("=" * 60)

if __name__ == "__main__":
    from app import create_app
    app = create_app()
    with app.app_context():
        run_seed_modulo2()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_regras_fiscais_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Regras Fiscais Brasileiras
Popular tabela regra_fiscal com regras de IR do Brasil
"""

from app import create_app
from app.database import db
from app.models import RegraFiscal, IncidenciaImposto
from decimal import Decimal
from datetime import date


def seed_regras_fiscais_br():
    """Cria regras fiscais brasileiras"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Regras Fiscais Brasileiras")
        print("=" * 50)
        
        # Verificar se j√° existem regras BR
        count = RegraFiscal.query.filter_by(pais='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} regras fiscais brasileiras.")
            resposta = input("Deseja recriar as regras BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar regras BR existentes
            RegraFiscal.query.filter_by(pais='BR').delete()
            db.session.commit()
            print("‚úì Regras fiscais brasileiras anteriores removidas.")
        
        # Regras fiscais brasileiras
        regras = [
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': Decimal('20000.00'),
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em a√ß√µes - Swing Trade. Isen√ß√£o para vendas at√© R$ 20.000,00 por m√™s.'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'DAY_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em Day Trade. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em FIIs. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': None,  # Aplica a todos
                'tipo_operacao': None,
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'IR sobre JCP (Juros sobre Capital Pr√≥prio). Retido na fonte, al√≠quota de 15%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Rendimentos de FII s√£o ISENTOS de IR para pessoa f√≠sica (requisitos: FII com +50 cotistas, cotas negociadas em bolsa, investidor com <10% das cotas).'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Dividendos de a√ß√µes s√£o ISENTOS de IR para pessoa f√≠sica no Brasil.'
            },
        ]
        
        created_regras = []
        
        print("\nüìã Criando Regras...")
        for regra_data in regras:
            regra = RegraFiscal(
                pais='BR',
                tipo_ativo=regra_data['tipo_ativo'],
                tipo_operacao=regra_data['tipo_operacao'],
                aliquota_ir=regra_data['aliquota_ir'],
                valor_isencao=regra_data['valor_isencao'],
                incide_sobre=regra_data['incide_sobre'],
                descricao=regra_data['descricao'],
                vigencia_inicio=date(2024, 1, 1),
                ativa=True
            )
            db.session.add(regra)
            created_regras.append(regra)
            
            tipo_str = regra_data['tipo_ativo'] or 'TODOS'
            op_str = regra_data['tipo_operacao'] or 'TODAS'
            isencao_str = f"R$ {regra_data['valor_isencao']}" if regra_data['valor_isencao'] else "SEM"
            
            print(f"  ‚úì {tipo_str:10} | {op_str:12} | IR: {regra_data['aliquota_ir']:6}% | Isen√ß√£o: {isencao_str}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_regras)} regras fiscais criadas!")
            print("=" * 50)
            print("\nüìå RESUMO DAS REGRAS:")
            print("-" * 50)
            print("‚Ä¢ A√ß√µes Swing Trade: 15% IR (isen√ß√£o at√© R$ 20k/m√™s)")
            print("‚Ä¢ A√ß√µes Day Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ FII Swing Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ Dividendos de A√ß√µes: ISENTO")
            print("‚Ä¢ Rendimentos de FII: ISENTO*")
            print("‚Ä¢ JCP: 15% IR retido na fonte")
            print("-" * 50)
            print("* Requisitos para isen√ß√£o de FII aplicam-se\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar regras fiscais: {e}")
            raise


if __name__ == '__main__':
    seed_regras_fiscais_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_usuarios.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Usu√°rios
Popular tabela usuario com dados iniciais
"""
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))


from app import create_app
from app.database import db
from app.models import Usuario, UserRole
from datetime import datetime


def seed_usuarios():
    """Cria usu√°rios iniciais do sistema"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Usu√°rios Iniciais")
        print("=" * 50)
        
        # Verificar se j√° existem usu√°rios
        count = Usuario.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} usu√°rios cadastrados.")
            resposta = input("Deseja recriar os usu√°rios? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar usu√°rios existentes
            Usuario.query.delete()
            db.session.commit()
            print("‚úì Usu√°rios anteriores removidos.")
        
        # Lista de usu√°rios a criar
        usuarios = [
            {
                'username': 'admin',
                'email': 'admin@exitus.com',
                'password': 'admin123',  # Senha padr√£o para desenvolvimento
                'nome_completo': 'Administrador do Sistema',
                'role': UserRole.ADMIN,
                'ativo': True
            },
            {
                'username': 'joao.silva',
                'email': 'joao.silva@example.com',
                'password': 'user123',
                'nome_completo': 'Jo√£o Silva',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'maria.santos',
                'email': 'maria.santos@example.com',
                'password': 'user123',
                'nome_completo': 'Maria Santos',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'viewer',
                'email': 'viewer@exitus.com',
                'password': 'viewer123',
                'nome_completo': 'Usu√°rio Visualizador',
                'role': UserRole.READONLY,
                'ativo': True
            }
        ]
        
        # Criar usu√°rios
        created_users = []
        for user_data in usuarios:
            user = Usuario(
                username=user_data['username'],
                email=user_data['email'],
                nome_completo=user_data.get('nome_completo'),
                role=user_data['role'],
                ativo=user_data['ativo']
            )
            user.set_password(user_data['password'])
            
            db.session.add(user)
            created_users.append(user)
            
            print(f"‚úì Usu√°rio criado: {user.username} ({user.role.value}) - {user.email}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_users)} usu√°rios criados com sucesso!")
            print("=" * 50)
            
            # Exibir credenciais
            print("\nüìã CREDENCIAIS DE ACESSO:")
            print("-" * 50)
            for user_data in usuarios:
                print(f"Username: {user_data['username']:<15} | Senha: {user_data['password']}")
            print("-" * 50)
            print("‚ö† ATEN√á√ÉO: Altere as senhas em produ√ß√£o!\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar usu√°rios: {e}")
            raise


if __name__ == '__main__':
    seed_usuarios()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/ativo_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import date
from sqlalchemy import or_
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo

class AtivoService:
    """Servi√ßo para opera√ß√µes de ativos"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, tipo=None, classe=None, mercado=None, 
                deslistado=None, search=None):
        """
        Lista ativos com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            tipo: Filtro por tipo (ACAO, FII, etc)
            classe: Filtro por classe (RENDA_VARIAVEL, etc)
            mercado: Filtro por mercado (BR, US, etc)
            deslistado: Filtro por deslistados
            search: Busca em ticker e nome
        """
        query = Ativo.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if tipo:
            query = query.filter_by(tipo=TipoAtivo[tipo.upper()])
        
        if classe:
            query = query.filter_by(classe=ClasseAtivo[classe.upper()])
        
        if mercado:
            query = query.filter_by(mercado=mercado.upper())
        
        if deslistado is not None:
            query = query.filter_by(deslistado=deslistado)
        
        if search:
            query = query.filter(
                or_(
                    Ativo.ticker.ilike(f'%{search}%'),
                    Ativo.nome.ilike(f'%{search}%')
                )
            )
        
        # Ordenar por ticker
        query = query.order_by(Ativo.ticker)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(ativo_id):
        """Busca ativo por ID"""
        return Ativo.query.get(ativo_id)
    
    @staticmethod
    def get_by_ticker(ticker, mercado):
        """Busca ativo por ticker e mercado"""
        return Ativo.query.filter_by(
            ticker=ticker.upper(),
            mercado=mercado.upper()
        ).first()
    
    @staticmethod
    def create(data):
        """
        Cria novo ativo.
        
        Args:
            data: Dict com ticker, nome, tipo, classe, mercado, moeda, etc
        """
        # Verifica se j√° existe ativo com mesmo ticker e mercado
        existing = Ativo.query.filter_by(
            ticker=data['ticker'].upper(),
            mercado=data['mercado'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"Ativo {data['ticker']} j√° existe no mercado {data['mercado']}")
        
        # ‚ö†Ô∏è CORRE√á√ÉO: Usar p_l, p_vp (nomes das colunas no DB)
        ativo = Ativo(
            ticker=data['ticker'].upper(),
            nome=data['nome'],
            tipo=TipoAtivo[data['tipo'].upper()],
            classe=ClasseAtivo[data['classe'].upper()],
            mercado=data['mercado'].upper(),
            moeda=data['moeda'].upper(),
            preco_atual=Decimal(str(data['preco_atual'])) if data.get('preco_atual') else None,
            dividend_yield=Decimal(str(data['dividend_yield'])) if data.get('dividend_yield') else None,
            p_l=Decimal(str(data['pl'])) if data.get('pl') else None,  # ‚¨ÖÔ∏è CORRIGIDO
            p_vp=Decimal(str(data['pvp'])) if data.get('pvp') else None,  # ‚¨ÖÔ∏è CORRIGIDO
            roe=Decimal(str(data['roe'])) if data.get('roe') else None,
            ativo=data.get('ativo', True),
            deslistado=data.get('deslistado', False)
        )
        
        db.session.add(ativo)
        db.session.commit()
        return ativo
    
    @staticmethod
    def update(ativo_id, data):
        """
        Atualiza ativo.
        
        Args:
            ativo_id: ID do ativo
            data: Dict com campos a atualizar
        """
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            ativo.nome = data['nome']
        
        if 'tipo' in data:
            ativo.tipo = TipoAtivo[data['tipo'].upper()]
        
        if 'classe' in data:
            ativo.classe = ClasseAtivo[data['classe'].upper()]
        
        if 'mercado' in data:
            ativo.mercado = data['mercado'].upper()
        
        if 'moeda' in data:
            ativo.moeda = data['moeda'].upper()
        
        if 'preco_atual' in data:
            ativo.preco_atual = Decimal(str(data['preco_atual'])) if data['preco_atual'] else None
        
        if 'dividend_yield' in data:
            ativo.dividend_yield = Decimal(str(data['dividend_yield'])) if data['dividend_yield'] else None
        
        # ‚ö†Ô∏è CORRE√á√ÉO: Usar p_l, p_vp
        if 'pl' in data:
            ativo.p_l = Decimal(str(data['pl'])) if data['pl'] else None  # ‚¨ÖÔ∏è CORRIGIDO
        
        if 'pvp' in data:
            ativo.p_vp = Decimal(str(data['pvp'])) if data['pvp'] else None  # ‚¨ÖÔ∏è CORRIGIDO
        
        if 'roe' in data:
            ativo.roe = Decimal(str(data['roe'])) if data['roe'] else None
        
        if 'ativo' in data:
            ativo.ativo = data['ativo']
        
        if 'deslistado' in data:
            ativo.deslistado = data['deslistado']
            if data['deslistado'] and 'data_deslistagem' in data:
                ativo.data_deslistagem = data['data_deslistagem']
        
        db.session.commit()
        return ativo
    
    @staticmethod
    def delete(ativo_id):
        """Deleta ativo"""
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(ativo)
        db.session.commit()
        return True
    
    @staticmethod
    def get_by_mercado(mercado, page=1, per_page=50):
        """Lista ativos de um mercado espec√≠fico"""
        return Ativo.query.filter_by(
            mercado=mercado.upper(),
            ativo=True,
            deslistado=False
        ).order_by(Ativo.ticker).paginate(page=page, per_page=per_page, error_out=False)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/auth_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Service - L√≥gica de autentica√ß√£o JWT"""

from datetime import timedelta
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import check_password_hash
from app.database import db
from app.models import Usuario

class AuthService:
    """Servi√ßo respons√°vel por autentica√ß√£o e gera√ß√£o de tokens JWT"""
    
    @staticmethod
    def login(username: str, password: str):
        """
        Valida credenciais e gera tokens JWT.
        
        Returns:
            dict: Tokens de acesso e refresh
        Raises:
            ValueError: Credenciais inv√°lidas
        """
        user = Usuario.query.filter_by(username=username).first()
        if not user or not check_password_hash(user.password_hash, password):
            raise ValueError("Credenciais inv√°lidas")
        
        if not user.ativo:
            raise ValueError("Usu√°rio inativo")
        
        # ‚úÖ CORRE√á√ÉO: .value converte Enum UserRole para string
        additional_claims = {"role": user.role.value}
        
        access_token = create_access_token(
            identity=str(user.id), 
            additional_claims=additional_claims, 
            expires_delta=timedelta(hours=1)
        )
        refresh_token = create_refresh_token(
            identity=str(user.id), 
            expires_delta=timedelta(days=30)
        )
        
        # Atualizar √∫ltimo login
        user.ultimo_login = db.func.now()
        db.session.commit()
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
    
    @staticmethod
    def refresh(identity: str):
        """Gera novo access_token a partir do refresh_token."""
        user = Usuario.query.get(identity)
        additional_claims = {"role": user.role.value} if user else {}
        
        access_token = create_access_token(
            identity=identity, 
            additional_claims=additional_claims,
            expires_delta=timedelta(hours=1)
        )
        return {
            "access_token": access_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/auth_service.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Service - L√≥gica de autentica√ß√£o JWT"""

from datetime import timedelta
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import check_password_hash
from app.database import db
from app.models import Usuario

class AuthService:
    """Servi√ßo respons√°vel por autentica√ß√£o e gera√ß√£o de tokens JWT"""
    
    @staticmethod
    def login(username: str, password: str):
        """
        Valida credenciais e gera tokens JWT.
        
        Returns:
            dict: Tokens de acesso e refresh
        Raises:
            ValueError: Credenciais inv√°lidas
        """
        user = Usuario.query.filter_by(username=username).first()
        if not user or not check_password_hash(user.password_hash, password):
            raise ValueError("Credenciais inv√°lidas")
        
        if not user.ativo:
            raise ValueError("Usu√°rio inativo")
        
        # Claims adicionais para autoriza√ß√£o
        additional_claims = {"role": user.role}
        access_token = create_access_token(
            identity=str(user.id), 
            additional_claims=additional_claims, 
            expires_delta=timedelta(hours=1)
        )
        refresh_token = create_refresh_token(
            identity=str(user.id), 
            expires_delta=timedelta(days=30)
        )
        
        # Atualizar √∫ltimo login
        user.ultimo_login = db.func.now()
        db.session.commit()
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
    
    @staticmethod
    def refresh(identity: str):
        """Gera novo access_token a partir do refresh_token."""
        access_token = create_access_token(
            identity=identity, 
            expires_delta=timedelta(hours=1)
        )
        return {
            "access_token": access_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/corretora_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretora Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from sqlalchemy import or_
from app.database import db
from app.models import Corretora, TipoCorretora

class CorretoraService:
    """Servi√ßo para opera√ß√µes de corretoras"""
    
    @staticmethod
    def get_all(usuario_id, page=1, per_page=20, ativa=None, tipo=None, pais=None, search=None):
        """
        Lista corretoras do usu√°rio com pagina√ß√£o e filtros.
        
        Args:
            usuario_id: ID do usu√°rio propriet√°rio
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativa: Filtro por status ativo
            tipo: Filtro por tipo (CORRETORA, EXCHANGE)
            pais: Filtro por pa√≠s (BR, US, etc)
            search: Busca em nome
        """
        query = Corretora.query.filter_by(usuario_id=usuario_id)
        
        # Filtros
        if ativa is not None:
            query = query.filter_by(ativa=ativa)
        
        if tipo:
            query = query.filter_by(tipo=TipoCorretora[tipo.upper()])
        
        if pais:
            query = query.filter_by(pais=pais.upper())
        
        if search:
            query = query.filter(Corretora.nome.ilike(f'%{search}%'))
        
        # Ordenar por nome
        query = query.order_by(Corretora.nome)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(corretora_id, usuario_id):
        """Busca corretora por ID (valida propriedade)"""
        return Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
    
    @staticmethod
    def create(data, usuario_id):
        """
        Cria nova corretora.
        
        Args:
            data: Dict com nome, tipo, pais, moeda_padrao, etc
            usuario_id: ID do usu√°rio propriet√°rio
        """
        # Verifica se j√° existe corretora com mesmo nome, pa√≠s e usu√°rio
        existing = Corretora.query.filter_by(
            usuario_id=usuario_id,
            nome=data['nome'],
            pais=data['pais'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"J√° existe uma corretora '{data['nome']}' em {data['pais']}")
        
        corretora = Corretora(
            usuario_id=usuario_id,
            nome=data['nome'],
            tipo=TipoCorretora[data['tipo'].upper()],
            pais=data['pais'].upper(),
            moeda_padrao=data['moeda_padrao'].upper(),
            saldo_atual=Decimal(data.get('saldo_atual', '0.00')),
            ativa=data.get('ativa', True),
            observacoes=data.get('observacoes')
        )
        
        db.session.add(corretora)
        db.session.commit()
        return corretora
    
    @staticmethod
    def update(corretora_id, data, usuario_id):
        """
        Atualiza corretora.
        
        Args:
            corretora_id: ID da corretora
            data: Dict com campos a atualizar
            usuario_id: ID do usu√°rio propriet√°rio
        """
        corretora = Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
        if not corretora:
            raise ValueError("Corretora n√£o encontrada")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            # Verifica duplicidade
            existing = Corretora.query.filter_by(
                usuario_id=usuario_id,
                nome=data['nome'],
                pais=corretora.pais
            ).first()
            if existing and existing.id != corretora.id:
                raise ValueError(f"J√° existe uma corretora '{data['nome']}' em {corretora.pais}")
            corretora.nome = data['nome']
        
        if 'tipo' in data:
            corretora.tipo = TipoCorretora[data['tipo'].upper()]
        
        if 'pais' in data:
            corretora.pais = data['pais'].upper()
        
        if 'moeda_padrao' in data:
            corretora.moeda_padrao = data['moeda_padrao'].upper()
        
        if 'saldo_atual' in data:
            corretora.saldo_atual = Decimal(str(data['saldo_atual']))
        
        if 'ativa' in data:
            corretora.ativa = data['ativa']
        
        if 'observacoes' in data:
            corretora.observacoes = data['observacoes']
        
        db.session.commit()
        return corretora
    
    @staticmethod
    def delete(corretora_id, usuario_id):
        """Deleta corretora (valida propriedade)"""
        corretora = Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
        if not corretora:
            raise ValueError("Corretora n√£o encontrada")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(corretora)
        db.session.commit()
        return True
    
    @staticmethod
    def get_saldo_total(usuario_id, moeda='BRL'):
        """Calcula saldo total do usu√°rio em determinada moeda"""
        corretoras = Corretora.query.filter_by(
            usuario_id=usuario_id,
            moeda_padrao=moeda.upper(),
            ativa=True
        ).all()
        
        total = sum(c.saldo_atual for c in corretoras)
        return total

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/evento_corporativo_service.py ---
# -*- coding: utf-8 -*-
"""
Exitus - EventoCorporativo Service
Service layer para gerenciamento de eventos corporativos
"""

from app.database import db
from app.models import EventoCorporativo, Ativo, Posicao
from sqlalchemy.orm import joinedload
from decimal import Decimal
from datetime import datetime
import logging

logger = logging.getLogger(__name__)


class EventoCorporativoService:
    """Service para opera√ß√µes de eventos corporativos"""

    @staticmethod
    def get_all(page=1, per_page=50, filters=None):
        """
        Lista eventos corporativos com filtros
        
        Args:
            page (int): P√°gina atual
            per_page (int): Registros por p√°gina
            filters (dict): Filtros opcionais
        
        Returns:
            Pagination: Objeto de pagina√ß√£o
        """
        try:
            query = EventoCorporativo.query.options(joinedload(EventoCorporativo.ativo))
            
            if filters:
                if filters.get('ativo_id'):
                    query = query.filter_by(ativo_id=filters['ativo_id'])
                if filters.get('tipo_evento'):
                    query = query.filter_by(tipo_evento=filters['tipo_evento'])
                if filters.get('data_anuncio_inicio'):
                    query = query.filter(EventoCorporativo.data_anuncio >= filters['data_anuncio_inicio'])
                if filters.get('data_anuncio_fim'):
                    query = query.filter(EventoCorporativo.data_anuncio <= filters['data_anuncio_fim'])
                if filters.get('data_aprovacao_inicio'):
                    query = query.filter(EventoCorporativo.data_aprovacao >= filters['data_aprovacao_inicio'])
                if filters.get('data_aprovacao_fim'):
                    query = query.filter(EventoCorporativo.data_aprovacao <= filters['data_aprovacao_fim'])
            
            query = query.order_by(EventoCorporativo.data_anuncio.desc())
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar eventos: {e}")
            raise


    @staticmethod
    def get_by_id(evento_id):
        """Busca evento por ID"""
        return EventoCorporativo.query.options(joinedload(EventoCorporativo.ativo)).get(evento_id)


    @staticmethod
    def create(data):
        """
        Cria novo evento corporativo (ADMIN)
        
        Args:
            data (dict): Dados do evento
        
        Returns:
            EventoCorporativo: Evento criado
        """
        try:
            ativo = Ativo.query.get(data['ativo_id'])
            if not ativo:
                raise ValueError("Ativo n√£o encontrado")
            
            evento = EventoCorporativo(**data)
            db.session.add(evento)
            db.session.commit()
            
            logger.info(f"Evento criado: {evento.id} - {ativo.ticker} - {evento.tipo_evento.value}")
            return evento
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao criar evento: {e}")
            raise


    @staticmethod
    def update(evento_id, data):
        """
        Atualiza evento corporativo (ADMIN)
        
        Args:
            evento_id (UUID): ID do evento
            data (dict): Dados a atualizar
        
        Returns:
            EventoCorporativo: Evento atualizado
        """
        try:
            evento = EventoCorporativo.query.get(evento_id)
            if not evento:
                raise ValueError("Evento n√£o encontrado")
            
            campos_permitidos = [
                'tipo_evento', 'descricao', 'data_anuncio', 'data_com',
                'data_aprovacao', 'data_execucao', 'proporcao',
                'preco_subscricao', 'observacoes', 'url_informacao'
            ]
            
            for campo in campos_permitidos:
                if campo in data:
                    setattr(evento, campo, data[campo])
            
            db.session.commit()
            logger.info(f"Evento atualizado: {evento.id}")
            return evento
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao atualizar evento: {e}")
            raise


    @staticmethod
    def delete(evento_id):
        """
        Deleta evento corporativo (ADMIN)
        
        Args:
            evento_id (UUID): ID do evento
        
        Returns:
            bool: True se deletado
        """
        try:
            evento = EventoCorporativo.query.get(evento_id)
            if not evento:
                raise ValueError("Evento n√£o encontrado")
            
            db.session.delete(evento)
            db.session.commit()
            logger.info(f"Evento deletado: {evento_id}")
            return True
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao deletar evento: {e}")
            raise


    @staticmethod
    def get_por_ativo(ativo_id, page=1, per_page=50):
        """Lista eventos de um ativo espec√≠fico"""
        try:
            query = EventoCorporativo.query.filter_by(ativo_id=ativo_id).options(
                joinedload(EventoCorporativo.ativo)
            ).order_by(EventoCorporativo.data_anuncio.desc())
            
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar eventos por ativo: {e}")
            raise


    @staticmethod
    def get_eventos_usuario(usuario_id, data_inicio=None, data_fim=None):
        """
        Lista eventos que afetam as posi√ß√µes do usu√°rio
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            data_inicio (date): Data inicial (opcional)
            data_fim (date): Data final (opcional)
        
        Returns:
            list: Lista de eventos relevantes
        """
        try:
            # Buscar posi√ß√µes do usu√°rio
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            if not posicoes:
                return []
            
            ativos_ids = [p.ativo_id for p in posicoes]
            
            query = EventoCorporativo.query.filter(EventoCorporativo.ativo_id.in_(ativos_ids))
            
            if data_inicio:
                query = query.filter(EventoCorporativo.data_anuncio >= data_inicio)
            if data_fim:
                query = query.filter(EventoCorporativo.data_anuncio <= data_fim)
            
            query = query.options(joinedload(EventoCorporativo.ativo)).order_by(
                EventoCorporativo.data_anuncio.desc()
            )
            
            eventos = query.all()
            
            eventos_formatados = []
            
            for evento in eventos:
                posicao = next((p for p in posicoes if p.ativo_id == evento.ativo_id), None)
                
                if posicao:
                    eventos_formatados.append({
                        'evento_id': str(evento.id),
                        'ativo': {
                            'ticker': evento.ativo.ticker,
                            'nome': evento.ativo.nome
                        },
                        'tipo_evento': evento.tipo_evento.value,
                        'descricao': evento.descricao,
                        'data_anuncio': evento.data_anuncio.isoformat(),
                        'data_com': evento.data_com.isoformat() if evento.data_com else None,
                        'data_execucao': evento.data_execucao.isoformat() if evento.data_execucao else None,
                        'proporcao': evento.proporcao,
                        'quantidade_afetada': float(posicao.quantidade),
                        'impacto_estimado': EventoCorporativoService._calcular_impacto(evento, posicao)
                    })
            
            return eventos_formatados
            
        except Exception as e:
            logger.error(f"Erro ao buscar eventos do usu√°rio: {e}")
            raise


    @staticmethod
    def _calcular_impacto(evento, posicao):
        """Calcula impacto estimado de um evento em uma posi√ß√£o"""
        try:
            tipo = evento.tipo_evento.value
            
            if tipo == 'desdobramento':
                # Split: quantidade aumenta
                if evento.proporcao:
                    nova_quantidade = posicao.quantidade * Decimal(evento.proporcao)
                    return {
                        'tipo': 'aumento_quantidade',
                        'nova_quantidade': float(nova_quantidade),
                        'diferenca': float(nova_quantidade - posicao.quantidade)
                    }
            
            elif tipo == 'grupamento':
                # Reverse split: quantidade diminui
                if evento.proporcao:
                    nova_quantidade = posicao.quantidade / Decimal(evento.proporcao)
                    return {
                        'tipo': 'reducao_quantidade',
                        'nova_quantidade': float(nova_quantidade),
                        'diferenca': float(posicao.quantidade - nova_quantidade)
                    }
            
            elif tipo == 'bonificacao':
                # Bonifica√ß√£o: novas a√ß√µes gr√°tis
                if evento.proporcao:
                    novas_acoes = posicao.quantidade * Decimal(evento.proporcao)
                    return {
                        'tipo': 'bonificacao',
                        'novas_acoes': float(novas_acoes),
                        'quantidade_final': float(posicao.quantidade + novas_acoes)
                    }
            
            elif tipo == 'subscricao':
                # Direito de subscri√ß√£o: possibilidade de compra
                if evento.proporcao and evento.preco_subscricao:
                    direitos = posicao.quantidade * Decimal(evento.proporcao)
                    custo_subscricao = direitos * evento.preco_subscricao
                    return {
                        'tipo': 'direito_subscricao',
                        'quantidade_direitos': float(direitos),
                        'preco_subscricao': float(evento.preco_subscricao),
                        'custo_total': float(custo_subscricao)
                    }
            
            return {'tipo': 'informativo', 'descricao': evento.descricao}
            
        except Exception as e:
            logger.error(f"Erro ao calcular impacto: {e}")
            return {'tipo': 'erro', 'mensagem': 'N√£o foi poss√≠vel calcular o impacto'}


    @staticmethod
    def aplicar_evento_split(evento_id, usuario_id):
        """
        Aplica desdobramento/grupamento nas posi√ß√µes do usu√°rio
        
        Args:
            evento_id (UUID): ID do evento
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            dict: Resultado da aplica√ß√£o
        """
        try:
            evento = EventoCorporativo.query.get(evento_id)
            if not evento:
                raise ValueError("Evento n√£o encontrado")
            
            if evento.tipo_evento.value not in ['desdobramento', 'grupamento']:
                raise ValueError("Evento n√£o √© desdobramento ou grupamento")
            
            if not evento.proporcao:
                raise ValueError("Evento sem propor√ß√£o definida")
            
            # Buscar posi√ß√µes do ativo do usu√°rio
            posicoes = Posicao.query.filter_by(
                usuario_id=usuario_id,
                ativo_id=evento.ativo_id
            ).all()
            
            if not posicoes:
                return {'posicoes_afetadas': 0, 'mensagem': 'Usu√°rio n√£o possui este ativo'}
            
            posicoes_atualizadas = 0
            
            for posicao in posicoes:
                quantidade_antiga = posicao.quantidade
                
                if evento.tipo_evento.value == 'desdobramento':
                    posicao.quantidade = quantidade_antiga * Decimal(evento.proporcao)
                    posicao.preco_medio = posicao.preco_medio / Decimal(evento.proporcao)
                else:  # grupamento
                    posicao.quantidade = quantidade_antiga / Decimal(evento.proporcao)
                    posicao.preco_medio = posicao.preco_medio * Decimal(evento.proporcao)
                
                posicao.data_ultima_atualizacao = datetime.utcnow()
                posicoes_atualizadas += 1
            
            db.session.commit()
            
            logger.info(f"Evento {evento_id} aplicado a {posicoes_atualizadas} posi√ß√µes do usu√°rio {usuario_id}")
            
            return {
                'posicoes_afetadas': posicoes_atualizadas,
                'tipo_evento': evento.tipo_evento.value,
                'proporcao': evento.proporcao
            }
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao aplicar evento: {e}")
            raise

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/movimentacao_caixa_service.py ---
# -*- coding: utf-8 -*-
"""
Exitus - MovimentacaoCaixa Service
Service layer para gerenciamento de movimenta√ß√µes de caixa
"""

from app.database import db
from app.models import MovimentacaoCaixa, Corretora, Provento
from sqlalchemy import func, or_
from sqlalchemy.orm import joinedload
from decimal import Decimal
from datetime import datetime
import logging

logger = logging.getLogger(__name__)


class MovimentacaoCaixaService:
    """Service para opera√ß√µes de movimenta√ß√£o de caixa"""

    @staticmethod
    def get_all(usuario_id, page=1, per_page=50, filters=None):
        """
        Lista movimenta√ß√µes de caixa do usu√°rio
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            page (int): P√°gina atual
            per_page (int): Registros por p√°gina
            filters (dict): Filtros opcionais
        
        Returns:
            Pagination: Objeto de pagina√ß√£o
        """
        try:
            query = MovimentacaoCaixa.query.filter_by(usuario_id=usuario_id)
            
            query = query.options(
                joinedload(MovimentacaoCaixa.corretora),
                joinedload(MovimentacaoCaixa.corretora_destino),
                joinedload(MovimentacaoCaixa.provento)
            )
            
            if filters:
                if filters.get('corretora_id'):
                    query = query.filter(
                        or_(
                            MovimentacaoCaixa.corretora_id == filters['corretora_id'],
                            MovimentacaoCaixa.corretora_destino_id == filters['corretora_id']
                        )
                    )
                if filters.get('tipo_movimentacao'):
                    query = query.filter_by(tipo_movimentacao=filters['tipo_movimentacao'])
                if filters.get('data_inicio'):
                    query = query.filter(MovimentacaoCaixa.data_movimentacao >= filters['data_inicio'])
                if filters.get('data_fim'):
                    query = query.filter(MovimentacaoCaixa.data_movimentacao <= filters['data_fim'])
                if filters.get('moeda'):
                    query = query.filter_by(moeda=filters['moeda'])
            
            query = query.order_by(MovimentacaoCaixa.data_movimentacao.desc())
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar movimenta√ß√µes: {e}")
            raise


    @staticmethod
    def get_by_id(movimentacao_id, usuario_id):
        """Busca movimenta√ß√£o por ID com valida√ß√£o de propriedade"""
        return MovimentacaoCaixa.query.filter_by(
            id=movimentacao_id,
            usuario_id=usuario_id
        ).options(
            joinedload(MovimentacaoCaixa.corretora),
            joinedload(MovimentacaoCaixa.corretora_destino),
            joinedload(MovimentacaoCaixa.provento)
        ).first()


    @staticmethod
    def create(usuario_id, data):
        """
        Cria nova movimenta√ß√£o de caixa
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            data (dict): Dados da movimenta√ß√£o
        
        Returns:
            MovimentacaoCaixa: Movimenta√ß√£o criada
        """
        try:
            # Validar corretora pertence ao usu√°rio
            corretora = Corretora.query.filter_by(
                id=data['corretora_id'],
                usuario_id=usuario_id
            ).first()
            
            if not corretora:
                raise ValueError("Corretora n√£o encontrada ou n√£o pertence ao usu√°rio")
            
            # Validar corretora destino se for transfer√™ncia
            tipo = data.get('tipo_movimentacao', '').upper()
            if tipo in ['TRANSFERENCIA_ENVIADA', 'TRANSFERENCIA_RECEBIDA']:
                if not data.get('corretora_destino_id'):
                    raise ValueError("Transfer√™ncia requer corretora de destino")
                
                corretora_destino = Corretora.query.filter_by(
                    id=data['corretora_destino_id'],
                    usuario_id=usuario_id
                ).first()
                
                if not corretora_destino:
                    raise ValueError("Corretora destino n√£o encontrada")
            
            # Criar movimenta√ß√£o
            data['usuario_id'] = usuario_id
            movimentacao = MovimentacaoCaixa(**data)
            db.session.add(movimentacao)
            
            # Atualizar saldo da corretora
            MovimentacaoCaixaService._atualizar_saldo_corretora(
                corretora, 
                movimentacao.impacto_saldo
            )
            
            # Se for transfer√™ncia, atualizar corretora destino
            if tipo == 'TRANSFERENCIA_ENVIADA':
                MovimentacaoCaixaService._atualizar_saldo_corretora(
                    corretora_destino,
                    movimentacao.valor
                )
            
            db.session.commit()
            
            logger.info(f"Movimenta√ß√£o criada: {movimentacao.id} - {tipo}")
            return movimentacao
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao criar movimenta√ß√£o: {e}")
            raise


    @staticmethod
    def _atualizar_saldo_corretora(corretora, valor):
        """Atualiza saldo da corretora"""
        corretora.saldo_atual += valor


    @staticmethod
    def update(movimentacao_id, usuario_id, data):
        """
        Atualiza movimenta√ß√£o de caixa
        
        Args:
            movimentacao_id (UUID): ID da movimenta√ß√£o
            usuario_id (UUID): ID do usu√°rio
            data (dict): Dados a atualizar
        
        Returns:
            MovimentacaoCaixa: Movimenta√ß√£o atualizada
        """
        try:
            movimentacao = MovimentacaoCaixaService.get_by_id(movimentacao_id, usuario_id)
            
            if not movimentacao:
                raise ValueError("Movimenta√ß√£o n√£o encontrada")
            
            # Reverter saldo anterior
            MovimentacaoCaixaService._atualizar_saldo_corretora(
                movimentacao.corretora,
                -movimentacao.impacto_saldo
            )
            
            # Atualizar campos permitidos
            campos_permitidos = [
                'tipo_movimentacao', 'valor', 'moeda', 
                'data_movimentacao', 'descricao', 'comprovante'
            ]
            
            for campo in campos_permitidos:
                if campo in data:
                    setattr(movimentacao, campo, data[campo])
            
            # Aplicar novo saldo
            MovimentacaoCaixaService._atualizar_saldo_corretora(
                movimentacao.corretora,
                movimentacao.impacto_saldo
            )
            
            db.session.commit()
            logger.info(f"Movimenta√ß√£o atualizada: {movimentacao_id}")
            return movimentacao
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao atualizar movimenta√ß√£o: {e}")
            raise


    @staticmethod
    def delete(movimentacao_id, usuario_id):
        """
        Deleta movimenta√ß√£o de caixa
        
        Args:
            movimentacao_id (UUID): ID da movimenta√ß√£o
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            bool: True se deletado
        """
        try:
            movimentacao = MovimentacaoCaixaService.get_by_id(movimentacao_id, usuario_id)
            
            if not movimentacao:
                raise ValueError("Movimenta√ß√£o n√£o encontrada")
            
            # Reverter saldo
            MovimentacaoCaixaService._atualizar_saldo_corretora(
                movimentacao.corretora,
                -movimentacao.impacto_saldo
            )
            
            db.session.delete(movimentacao)
            db.session.commit()
            
            logger.info(f"Movimenta√ß√£o deletada: {movimentacao_id}")
            return True
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao deletar movimenta√ß√£o: {e}")
            raise


    @staticmethod
    def get_saldo_corretora(usuario_id, corretora_id):
        """
        Calcula saldo consolidado de uma corretora
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            corretora_id (UUID): ID da corretora
        
        Returns:
            dict: Saldo por moeda
        """
        try:
            movimentacoes = MovimentacaoCaixa.query.filter_by(
                usuario_id=usuario_id,
                corretora_id=corretora_id
            ).all()
            
            # Agrupar por moeda
            saldos = {}
            
            for m in movimentacoes:
                moeda = m.moeda
                if moeda not in saldos:
                    saldos[moeda] = Decimal('0')
                
                saldos[moeda] += m.impacto_saldo
            
            return {
                moeda: float(saldo)
                for moeda, saldo in saldos.items()
            }
            
        except Exception as e:
            logger.error(f"Erro ao calcular saldo: {e}")
            raise


    @staticmethod
    def get_extrato(usuario_id, corretora_id=None, data_inicio=None, data_fim=None):
        """
        Gera extrato de movimenta√ß√µes
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            corretora_id (UUID, optional): Filtrar por corretora
            data_inicio (date, optional): Data inicial
            data_fim (date, optional): Data final
        
        Returns:
            list: Lista de movimenta√ß√µes com saldo acumulado
        """
        try:
            query = MovimentacaoCaixa.query.filter_by(usuario_id=usuario_id)
            
            if corretora_id:
                query = query.filter_by(corretora_id=corretora_id)
            
            if data_inicio:
                query = query.filter(MovimentacaoCaixa.data_movimentacao >= data_inicio)
            
            if data_fim:
                query = query.filter(MovimentacaoCaixa.data_movimentacao <= data_fim)
            
            query = query.options(
                joinedload(MovimentacaoCaixa.corretora)
            ).order_by(MovimentacaoCaixa.data_movimentacao.asc())
            
            movimentacoes = query.all()
            
            # Calcular saldo acumulado
            saldo_acumulado = Decimal('0')
            extrato = []
            
            for m in movimentacoes:
                saldo_acumulado += m.impacto_saldo
                
                extrato.append({
                    'id': str(m.id),
                    'data': m.data_movimentacao.isoformat(),
                    'tipo': m.tipo_movimentacao.value,
                    'descricao': m.descricao or m.tipo_movimentacao.value,
                    'valor': float(m.valor),
                    'impacto': float(m.impacto_saldo),
                    'saldo_acumulado': float(saldo_acumulado),
                    'moeda': m.moeda,
                    'corretora': m.corretora.nome
                })
            
            return extrato
            
        except Exception as e:
            logger.error(f"Erro ao gerar extrato: {e}")
            raise

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/portfolio_service.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Portfolio Service
Service layer para an√°lises avan√ßadas de portf√≥lio
"""

from app.database import db
from app.models import Posicao, Transacao, Provento, MovimentacaoCaixa
from sqlalchemy import func
from sqlalchemy.orm import joinedload
from decimal import Decimal
from datetime import datetime, date, timedelta
import logging

logger = logging.getLogger(__name__)


class PortfolioService:
    """Service para analytics de portf√≥lio"""

    @staticmethod
    def get_dashboard(usuario_id):
        """
        Retorna dashboard completo do portf√≥lio
        
        Args:
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            dict: Dados do dashboard
        """
        try:
            # Resumo de posi√ß√µes
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            total_investido = sum(p.custo_total for p in posicoes)
            total_atual = sum(p.valor_atual or Decimal('0') for p in posicoes)
            total_lucro_realizado = sum(p.lucro_prejuizo_realizado for p in posicoes)
            total_lucro_nao_realizado = sum(p.lucro_prejuizo_nao_realizado or Decimal('0') for p in posicoes)
            
            lucro_total = total_lucro_realizado + total_lucro_nao_realizado
            roi = (lucro_total / total_investido * 100) if total_investido > 0 else Decimal('0')
            
            # Proventos recebidos
            proventos_total = PortfolioService._calcular_proventos_total(usuario_id)
            
            # Distribui√ß√£o por classe
            distribuicao = PortfolioService.get_distribuicao_classes(usuario_id)
            
            # Top 5 posi√ß√µes
            top_posicoes = sorted(posicoes, key=lambda p: p.valor_atual or Decimal('0'), reverse=True)[:5]
            
            return {
                'resumo_geral': {
                    'total_investido': float(total_investido),
                    'valor_atual': float(total_atual),
                    'lucro_realizado': float(total_lucro_realizado),
                    'lucro_nao_realizado': float(total_lucro_nao_realizado),
                    'lucro_total': float(lucro_total),
                    'roi_percentual': float(roi),
                    'quantidade_posicoes': len(posicoes)
                },
                'proventos': proventos_total,
                'distribuicao_classes': distribuicao,
                'top_posicoes': [
                    {
                        'ticker': p.ativo.ticker,
                        'nome': p.ativo.nome,
                        'quantidade': float(p.quantidade),
                        'valor_atual': float(p.valor_atual or 0),
                        'lucro_prejuizo': float((p.valor_atual or 0) - p.custo_total),
                        'percentual_carteira': float((p.valor_atual or 0) / total_atual * 100) if total_atual > 0 else 0
                    }
                    for p in top_posicoes
                ]
            }
            
        except Exception as e:
            logger.error(f"Erro ao gerar dashboard: {e}")
            raise


    @staticmethod
    def _calcular_proventos_total(usuario_id):
        """Calcula total de proventos recebidos"""
        from app.services.provento_service import ProventoService
        return ProventoService.calcular_total_recebido(usuario_id)


    @staticmethod
    def get_distribuicao_classes(usuario_id):
        """
        Retorna distribui√ß√£o do portf√≥lio por classe de ativo
        
        Args:
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            dict: Distribui√ß√£o por classe
        """
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            total_carteira = sum(p.valor_atual or Decimal('0') for p in posicoes)
            
            distribuicao = {}
            
            for p in posicoes:
                classe = p.ativo.classe.value if p.ativo.classe else 'outros'
                valor = p.valor_atual or Decimal('0')
                
                if classe not in distribuicao:
                    distribuicao[classe] = {
                        'valor': Decimal('0'),
                        'quantidade_ativos': 0,
                        'lucro_prejuizo': Decimal('0')
                    }
                
                distribuicao[classe]['valor'] += valor
                distribuicao[classe]['quantidade_ativos'] += 1
                distribuicao[classe]['lucro_prejuizo'] += (valor - p.custo_total)
            
            # Calcular percentuais
            resultado = {}
            for classe, dados in distribuicao.items():
                percentual = (dados['valor'] / total_carteira * 100) if total_carteira > 0 else Decimal('0')
                
                resultado[classe] = {
                    'valor': float(dados['valor']),
                    'percentual': float(percentual),
                    'quantidade_ativos': dados['quantidade_ativos'],
                    'lucro_prejuizo': float(dados['lucro_prejuizo'])
                }
            
            return resultado
            
        except Exception as e:
            logger.error(f"Erro ao calcular distribui√ß√£o: {e}")
            raise


    @staticmethod
    def get_distribuicao_setores(usuario_id):
        """
        Retorna distribui√ß√£o do portf√≥lio por setor
        
        Args:
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            dict: Distribui√ß√£o por setor
        """
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            total_carteira = sum(p.valor_atual or Decimal('0') for p in posicoes)
            
            distribuicao = {}
            
            for p in posicoes:
                setor = p.ativo.setor or 'N√£o classificado'
                valor = p.valor_atual or Decimal('0')
                
                if setor not in distribuicao:
                    distribuicao[setor] = {
                        'valor': Decimal('0'),
                        'quantidade_ativos': 0
                    }
                
                distribuicao[setor]['valor'] += valor
                distribuicao[setor]['quantidade_ativos'] += 1
            
            # Calcular percentuais e ordenar
            resultado = []
            for setor, dados in distribuicao.items():
                percentual = (dados['valor'] / total_carteira * 100) if total_carteira > 0 else Decimal('0')
                resultado.append({
                    'setor': setor,
                    'valor': float(dados['valor']),
                    'percentual': float(percentual),
                    'quantidade_ativos': dados['quantidade_ativos']
                })
            
            # Ordenar por valor (maior primeiro)
            resultado.sort(key=lambda x: x['valor'], reverse=True)
            
            return resultado
            
        except Exception as e:
            logger.error(f"Erro ao calcular distribui√ß√£o por setor: {e}")
            raise


    @staticmethod
    def get_evolucao_patrimonio(usuario_id, meses=12):
        """
        Retorna evolu√ß√£o do patrim√¥nio ao longo do tempo
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            meses (int): Quantidade de meses para an√°lise
        
        Returns:
            list: Evolu√ß√£o mensal
        """
        try:
            data_inicio = date.today() - timedelta(days=meses * 30)
            
            transacoes = Transacao.query.filter_by(usuario_id=usuario_id).filter(
                Transacao.data_transacao >= data_inicio
            ).order_by(Transacao.data_transacao.asc()).all()
            
            if not transacoes:
                return []
            
            # Agrupar por m√™s
            evolucao = {}
            patrimonio_acumulado = Decimal('0')
            
            for t in transacoes:
                mes_ano = t.data_transacao.strftime('%Y-%m')
                
                if mes_ano not in evolucao:
                    evolucao[mes_ano] = {
                        'data': mes_ano,
                        'aportes': Decimal('0'),
                        'resgates': Decimal('0'),
                        'patrimonio': Decimal('0')
                    }
                
                if t.tipo.value == 'compra':
                    evolucao[mes_ano]['aportes'] += t.valor_liquido
                    patrimonio_acumulado += t.valor_liquido
                elif t.tipo.value == 'venda':
                    evolucao[mes_ano]['resgates'] += t.valor_liquido
                    patrimonio_acumulado -= t.valor_liquido
                
                evolucao[mes_ano]['patrimonio'] = patrimonio_acumulado
            
            resultado = [
                {
                    'mes': dados['data'],
                    'aportes': float(dados['aportes']),
                    'resgates': float(dados['resgates']),
                    'patrimonio': float(dados['patrimonio'])
                }
                for dados in evolucao.values()
            ]
            
            return sorted(resultado, key=lambda x: x['mes'])
            
        except Exception as e:
            logger.error(f"Erro ao calcular evolu√ß√£o: {e}")
            raise


    @staticmethod
    def get_metricas_risco(usuario_id):
        """
        Calcula m√©tricas de risco do portf√≥lio
        
        Args:
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            dict: M√©tricas de risco
        """
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            if not posicoes:
                return {}
            
            total_carteira = sum(p.valor_atual or Decimal('0') for p in posicoes)
            
            # Concentra√ß√£o (% do maior ativo)
            maior_posicao = max(posicoes, key=lambda p: p.valor_atual or Decimal('0'))
            concentracao = (maior_posicao.valor_atual or Decimal('0')) / total_carteira * 100 if total_carteira > 0 else Decimal('0')
            
            # Diversifica√ß√£o (quantidade de ativos)
            qtd_ativos = len(posicoes)
            
            # √çndice Herfindahl-Hirschman (HHI) - mede concentra√ß√£o
            hhi = sum(
                ((p.valor_atual or Decimal('0')) / total_carteira * 100) ** 2
                for p in posicoes
            ) if total_carteira > 0 else Decimal('0')
            
            # Classifica√ß√£o de risco baseado em HHI
            if hhi < 1500:
                nivel_concentracao = 'Baixa'
            elif hhi < 2500:
                nivel_concentracao = 'Moderada'
            else:
                nivel_concentracao = 'Alta'
            
            return {
                'quantidade_ativos': qtd_ativos,
                'maior_posicao': {
                    'ticker': maior_posicao.ativo.ticker,
                    'percentual': float(concentracao)
                },
                'hhi': float(hhi),
                'nivel_concentracao': nivel_concentracao,
                'recomendacao': PortfolioService._gerar_recomendacao_risco(qtd_ativos, float(hhi))
            }
            
        except Exception as e:
            logger.error(f"Erro ao calcular m√©tricas de risco: {e}")
            raise


    @staticmethod
    def _gerar_recomendacao_risco(qtd_ativos, hhi):
        """Gera recomenda√ß√£o baseada em m√©tricas de risco"""
        recomendacoes = []
        
        if qtd_ativos < 5:
            recomendacoes.append("Considere diversificar mais seu portf√≥lio (m√≠nimo recomendado: 5-10 ativos)")
        
        if hhi > 2500:
            recomendacoes.append("Carteira muito concentrada. Considere reduzir exposi√ß√£o aos ativos principais")
        
        if not recomendacoes:
            recomendacoes.append("Portf√≥lio com boa diversifica√ß√£o")
        
        return recomendacoes


    @staticmethod
    def get_performance_ativos(usuario_id):
        """
        Retorna performance individual de cada ativo
        
        Args:
            usuario_id (UUID): ID do usu√°rio
        
        Returns:
            list: Performance dos ativos
        """
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            performance = []
            
            for p in posicoes:
                valor_atual = p.valor_atual or Decimal('0')
                lucro = valor_atual - p.custo_total
                roi = (lucro / p.custo_total * 100) if p.custo_total > 0 else Decimal('0')
                
                performance.append({
                    'ticker': p.ativo.ticker,
                    'nome': p.ativo.nome,
                    'quantidade': float(p.quantidade),
                    'preco_medio': float(p.preco_medio),
                    'preco_atual': float(p.ativo.preco_atual) if p.ativo.preco_atual else None,
                    'custo_total': float(p.custo_total),
                    'valor_atual': float(valor_atual),
                    'lucro_prejuizo': float(lucro),
                    'roi_percentual': float(roi),
                    'lucro_realizado': float(p.lucro_prejuizo_realizado)
                })
            
            # Ordenar por ROI (maior primeiro)
            performance.sort(key=lambda x: x['roi_percentual'], reverse=True)
            
            return performance
            
        except Exception as e:
            logger.error(f"Erro ao calcular performance: {e}")
            raise

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/posicao_service.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Posicao Service
Service layer para gerenciamento de posi√ß√µes (holdings)
"""

from app.database import db
from app.models import Posicao, Transacao, Ativo, Corretora
from sqlalchemy import func
from sqlalchemy.orm import joinedload
from decimal import Decimal
from datetime import datetime
import logging

logger = logging.getLogger(__name__)


class PosicaoService:
    """Service para opera√ß√µes de posi√ß√µes"""

    @staticmethod
    def get_all(usuario_id, page=1, per_page=50, filters=None):
        """
        Lista todas as posi√ß√µes do usu√°rio com filtros opcionais
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            page (int): P√°gina atual
            per_page (int): Registros por p√°gina
            filters (dict): Filtros opcionais
        
        Returns:
            Pagination: Objeto de pagina√ß√£o
        """
        try:
            query = Posicao.query.filter_by(usuario_id=usuario_id)
            query = query.options(
                joinedload(Posicao.ativo),
                joinedload(Posicao.corretora)
            )
            
            if filters:
                if filters.get('ativo_id'):
                    query = query.filter_by(ativo_id=filters['ativo_id'])
                if filters.get('corretora_id'):
                    query = query.filter_by(corretora_id=filters['corretora_id'])
                if filters.get('ticker'):
                    query = query.join(Ativo).filter(
                        Ativo.ticker.ilike(f"%{filters['ticker']}%")
                    )
                if filters.get('lucro_positivo') is not None:
                    if filters['lucro_positivo']:
                        query = query.filter(
                            Posicao.lucro_prejuizo_realizado + 
                            func.coalesce(Posicao.lucro_prejuizo_nao_realizado, 0) > 0
                        )
            
            query = query.order_by(Posicao.custo_total.desc())
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar posi√ß√µes: {e}")
            raise


    @staticmethod
    def get_by_id(posicao_id, usuario_id):
        """Busca posi√ß√£o por ID"""
        return Posicao.query.filter_by(
            id=posicao_id,
            usuario_id=usuario_id
        ).options(
            joinedload(Posicao.ativo),
            joinedload(Posicao.corretora)
        ).first()


    @staticmethod
    def calcular_posicoes(usuario_id):
        """Recalcula todas as posi√ß√µes do usu√°rio a partir das transa√ß√µes"""
        try:
            transacoes = Transacao.query.filter_by(usuario_id=usuario_id).all()
            
            if not transacoes:
                return {"posicoes_criadas": 0, "posicoes_atualizadas": 0, "posicoes_zeradas": 0}
            
            # Agrupar por (ativo_id, corretora_id)
            posicoes_map = {}
            for t in transacoes:
                chave = (str(t.ativo_id), str(t.corretora_id))
                if chave not in posicoes_map:
                    posicoes_map[chave] = {
                        'ativo_id': t.ativo_id,
                        'corretora_id': t.corretora_id,
                        'transacoes': []
                    }
                posicoes_map[chave]['transacoes'].append(t)
            
            criadas = atualizadas = zeradas = 0
            
            for dados in posicoes_map.values():
                resultado = PosicaoService._processar_posicao(
                    usuario_id, dados['ativo_id'], 
                    dados['corretora_id'], dados['transacoes']
                )
                if resultado == 'criada': criadas += 1
                elif resultado == 'atualizada': atualizadas += 1
                elif resultado == 'zerada': zeradas += 1
            
            db.session.commit()
            
            return {
                "posicoes_criadas": criadas,
                "posicoes_atualizadas": atualizadas,
                "posicoes_zeradas": zeradas
            }
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao calcular posi√ß√µes: {e}")
            raise


    @staticmethod
    def _processar_posicao(usuario_id, ativo_id, corretora_id, transacoes):
        """Processa transa√ß√µes de uma posi√ß√£o espec√≠fica"""
        transacoes = sorted(transacoes, key=lambda t: t.data_transacao)
        
        quantidade_total = Decimal('0')
        custo_total = Decimal('0')
        taxas_acumuladas = Decimal('0')
        impostos_acumulados = Decimal('0')
        lucro_realizado = Decimal('0')
        data_primeira_compra = None
        
        for t in transacoes:
            if t.tipo.value == 'compra':
                quantidade_total += t.quantidade
                custo_total += t.valor_liquido
                taxas_acumuladas += t.custos_totais
                impostos_acumulados += t.imposto
                if data_primeira_compra is None:
                    data_primeira_compra = t.data_transacao
            
            elif t.tipo.value == 'venda':
                if quantidade_total > 0:
                    preco_medio = custo_total / quantidade_total
                    custo_vendido = preco_medio * t.quantidade
                    lucro_realizado += (t.valor_total - custo_vendido)
                
                quantidade_total -= t.quantidade
                if quantidade_total > 0:
                    custo_total -= (custo_total * t.quantidade / (quantidade_total + t.quantidade))
                else:
                    custo_total = Decimal('0')
                taxas_acumuladas += t.custos_totais
                impostos_acumulados += t.imposto
        
        preco_medio = custo_total / quantidade_total if quantidade_total > 0 else Decimal('0')
        
        posicao = Posicao.query.filter_by(
            usuario_id=usuario_id,
            ativo_id=ativo_id,
            corretora_id=corretora_id
        ).first()
        
        if quantidade_total <= 0:
            if posicao:
                db.session.delete(posicao)
                return 'zerada'
            return 'nenhuma'
        
        if not posicao:
            posicao = Posicao(
                usuario_id=usuario_id,
                ativo_id=ativo_id,
                corretora_id=corretora_id
            )
            db.session.add(posicao)
            resultado = 'criada'
        else:
            resultado = 'atualizada'
        
        posicao.quantidade = quantidade_total
        posicao.preco_medio = preco_medio
        posicao.custo_total = custo_total
        posicao.taxas_acumuladas = taxas_acumuladas
        posicao.impostos_acumulados = impostos_acumulados
        posicao.lucro_prejuizo_realizado = lucro_realizado
        posicao.data_primeira_compra = data_primeira_compra
        posicao.data_ultima_atualizacao = datetime.utcnow()
        
        return resultado


    @staticmethod
    def atualizar_valores_atuais(usuario_id):
        """Atualiza valores de mercado de todas as posi√ß√µes"""
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            atualizadas = 0
            for p in posicoes:
                if p.ativo.preco_atual and p.quantidade > 0:
                    p.valor_atual = p.ativo.preco_atual * p.quantidade
                    p.lucro_prejuizo_nao_realizado = p.valor_atual - p.custo_total
                    p.data_ultima_atualizacao = datetime.utcnow()
                    atualizadas += 1
            
            db.session.commit()
            return atualizadas
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao atualizar valores: {e}")
            raise


    @staticmethod
    def get_resumo(usuario_id):
        """Retorna resumo consolidado das posi√ß√µes"""
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            total_investido = sum(p.custo_total for p in posicoes)
            total_valor_atual = sum(p.valor_atual or Decimal('0') for p in posicoes)
            total_lucro_realizado = sum(p.lucro_prejuizo_realizado for p in posicoes)
            total_lucro_nao_realizado = sum(p.lucro_prejuizo_nao_realizado or Decimal('0') for p in posicoes)
            
            lucro_total = total_lucro_realizado + total_lucro_nao_realizado
            roi = (lucro_total / total_investido * 100) if total_investido > 0 else Decimal('0')
            
            return {
                'quantidade_posicoes': len(posicoes),
                'total_investido': float(total_investido),
                'total_valor_atual': float(total_valor_atual),
                'total_lucro_realizado': float(total_lucro_realizado),
                'total_lucro_nao_realizado': float(total_lucro_nao_realizado),
                'lucro_total': float(lucro_total),
                'roi_percentual': float(roi)
            }
            
        except Exception as e:
            logger.error(f"Erro ao gerar resumo: {e}")
            raise


    @staticmethod
    def get_por_ativo(usuario_id, ativo_id):
        """Consolida posi√ß√µes de um ativo em todas as corretoras"""
        try:
            posicoes = Posicao.query.filter_by(
                usuario_id=usuario_id,
                ativo_id=ativo_id
            ).options(
                joinedload(Posicao.ativo),
                joinedload(Posicao.corretora)
            ).all()
            
            if not posicoes:
                return None
            
            quantidade_total = sum(p.quantidade for p in posicoes)
            custo_total = sum(p.custo_total for p in posicoes)
            valor_atual_total = sum(p.valor_atual or Decimal('0') for p in posicoes)
            preco_medio = custo_total / quantidade_total if quantidade_total > 0 else Decimal('0')
            
            return {
                'ativo': posicoes[0].ativo.to_dict(),
                'quantidade_total': float(quantidade_total),
                'preco_medio': float(preco_medio),
                'custo_total': float(custo_total),
                'valor_atual': float(valor_atual_total),
                'lucro_prejuizo': float(valor_atual_total - custo_total),
                'corretoras': [
                    {
                        'corretora': p.corretora.nome,
                        'quantidade': float(p.quantidade),
                        'custo_total': float(p.custo_total)
                    }
                    for p in posicoes
                ]
            }
            
        except Exception as e:
            logger.error(f"Erro ao consolidar posi√ß√£o: {e}")
            raise

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/provento_service.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Provento Service
Service layer para gerenciamento de proventos
"""

from app.database import db
from app.models import Provento, Ativo, Posicao
from sqlalchemy.orm import joinedload
from decimal import Decimal
from datetime import datetime, date
import logging

logger = logging.getLogger(__name__)


class ProventoService:
    """Service para opera√ß√µes de proventos"""

    @staticmethod
    def get_all(page=1, per_page=50, filters=None):
        """
        Lista proventos com filtros opcionais
        
        Args:
            page (int): P√°gina atual
            per_page (int): Registros por p√°gina
            filters (dict): Filtros opcionais
        
        Returns:
            Pagination: Objeto de pagina√ß√£o
        """
        try:
            query = Provento.query.options(joinedload(Provento.ativo))
            
            if filters:
                if filters.get('ativo_id'):
                    query = query.filter_by(ativo_id=filters['ativo_id'])
                if filters.get('tipo_provento'):
                    query = query.filter_by(tipo_provento=filters['tipo_provento'])
                if filters.get('data_com_inicio'):
                    query = query.filter(Provento.data_com >= filters['data_com_inicio'])
                if filters.get('data_com_fim'):
                    query = query.filter(Provento.data_com <= filters['data_com_fim'])
                if filters.get('data_pagamento_inicio'):
                    query = query.filter(Provento.data_pagamento >= filters['data_pagamento_inicio'])
                if filters.get('data_pagamento_fim'):
                    query = query.filter(Provento.data_pagamento <= filters['data_pagamento_fim'])
            
            query = query.order_by(Provento.data_com.desc())
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar proventos: {e}")
            raise


    @staticmethod
    def get_by_id(provento_id):
        """Busca provento por ID"""
        return Provento.query.options(joinedload(Provento.ativo)).get(provento_id)


    @staticmethod
    def create(data):
        """
        Cria novo provento (ADMIN)
        
        Args:
            data (dict): Dados do provento
        
        Returns:
            Provento: Provento criado
        """
        try:
            ativo = Ativo.query.get(data['ativo_id'])
            if not ativo:
                raise ValueError("Ativo n√£o encontrado")
            
            # Calcular valores se n√£o fornecidos
            if 'valor_por_acao' in data and 'quantidade_ativos' in data:
                valor_bruto = Decimal(str(data['valor_por_acao'])) * Decimal(str(data['quantidade_ativos']))
                data['valor_bruto'] = valor_bruto
            
            if 'valor_bruto' in data and 'imposto_retido' in data:
                valor_liquido = Decimal(str(data['valor_bruto'])) - Decimal(str(data['imposto_retido']))
                data['valor_liquido'] = valor_liquido
            
            provento = Provento(**data)
            db.session.add(provento)
            db.session.commit()
            
            logger.info(f"Provento criado: {provento.id} - {ativo.ticker}")
            return provento
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao criar provento: {e}")
            raise


    @staticmethod
    def update(provento_id, data):
        """
        Atualiza provento (ADMIN)
        
        Args:
            provento_id (UUID): ID do provento
            data (dict): Dados a atualizar
        
        Returns:
            Provento: Provento atualizado
        """
        try:
            provento = Provento.query.get(provento_id)
            if not provento:
                raise ValueError("Provento n√£o encontrado")
            
            campos_permitidos = [
                'tipo_provento', 'valor_por_acao', 'quantidade_ativos',
                'valor_bruto', 'imposto_retido', 'valor_liquido',
                'data_com', 'data_pagamento', 'observacoes'
            ]
            
            for campo in campos_permitidos:
                if campo in data:
                    setattr(provento, campo, data[campo])
            
            # Recalcular valores se necess√°rio
            if 'valor_por_acao' in data or 'quantidade_ativos' in data:
                provento.valor_bruto = provento.valor_por_acao * provento.quantidade_ativos
            
            if 'valor_bruto' in data or 'imposto_retido' in data:
                provento.valor_liquido = provento.valor_bruto - provento.imposto_retido
            
            db.session.commit()
            logger.info(f"Provento atualizado: {provento.id}")
            return provento
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao atualizar provento: {e}")
            raise


    @staticmethod
    def delete(provento_id):
        """
        Deleta provento (ADMIN)
        
        Args:
            provento_id (UUID): ID do provento
        
        Returns:
            bool: True se deletado
        """
        try:
            provento = Provento.query.get(provento_id)
            if not provento:
                raise ValueError("Provento n√£o encontrado")
            
            db.session.delete(provento)
            db.session.commit()
            logger.info(f"Provento deletado: {provento_id}")
            return True
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erro ao deletar provento: {e}")
            raise


    @staticmethod
    def get_por_ativo(ativo_id, page=1, per_page=50):
        """Lista proventos de um ativo espec√≠fico"""
        try:
            query = Provento.query.filter_by(ativo_id=ativo_id).options(
                joinedload(Provento.ativo)
            ).order_by(Provento.data_com.desc())
            
            return query.paginate(page=page, per_page=per_page, error_out=False)
            
        except Exception as e:
            logger.error(f"Erro ao listar proventos por ativo: {e}")
            raise


    @staticmethod
    def get_recebidos_usuario(usuario_id, data_inicio=None, data_fim=None):
        """
        Calcula proventos recebidos pelo usu√°rio em um per√≠odo
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            data_inicio (date): Data inicial (opcional)
            data_fim (date): Data final (opcional)
        
        Returns:
            list: Lista de proventos recebidos com valores
        """
        try:
            posicoes = Posicao.query.filter_by(usuario_id=usuario_id).options(
                joinedload(Posicao.ativo)
            ).all()
            
            if not posicoes:
                return []
            
            ativos_ids = [p.ativo_id for p in posicoes]
            
            query = Provento.query.filter(Provento.ativo_id.in_(ativos_ids))
            
            if data_inicio:
                query = query.filter(Provento.data_pagamento >= data_inicio)
            if data_fim:
                query = query.filter(Provento.data_pagamento <= data_fim)
            
            query = query.options(joinedload(Provento.ativo)).order_by(Provento.data_pagamento.desc())
            proventos = query.all()
            
            proventos_recebidos = []
            
            for prov in proventos:
                posicao = next((p for p in posicoes if p.ativo_id == prov.ativo_id), None)
                
                if posicao:
                    quantidade_recebida = posicao.quantidade
                    valor_bruto_recebido = prov.valor_por_acao * quantidade_recebida
                    valor_liquido_recebido = valor_bruto_recebido * (prov.valor_liquido / prov.valor_bruto) if prov.valor_bruto > 0 else Decimal('0')
                    
                    proventos_recebidos.append({
                        'provento_id': str(prov.id),
                        'ativo': {
                            'ticker': prov.ativo.ticker,
                            'nome': prov.ativo.nome
                        },
                        'tipo_provento': prov.tipo_provento.value,
                        'data_com': prov.data_com.isoformat(),
                        'data_pagamento': prov.data_pagamento.isoformat(),
                        'valor_por_acao': float(prov.valor_por_acao),
                        'quantidade_recebida': float(quantidade_recebida),
                        'valor_bruto_recebido': float(valor_bruto_recebido),
                        'valor_liquido_recebido': float(valor_liquido_recebido)
                    })
            
            return proventos_recebidos
            
        except Exception as e:
            logger.error(f"Erro ao calcular proventos recebidos: {e}")
            raise


    @staticmethod
    def calcular_total_recebido(usuario_id, ativo_id=None):
        """
        Calcula total de proventos recebidos
        
        Args:
            usuario_id (UUID): ID do usu√°rio
            ativo_id (UUID, optional): Filtrar por ativo
        
        Returns:
            dict: Total de proventos por tipo
        """
        try:
            proventos = ProventoService.get_recebidos_usuario(usuario_id)
            
            if ativo_id:
                proventos = [p for p in proventos if p.get('ativo', {}).get('id') == str(ativo_id)]
            
            total_por_tipo = {}
            total_geral_bruto = Decimal('0')
            total_geral_liquido = Decimal('0')
            
            for p in proventos:
                tipo = p['tipo_provento']
                valor_bruto = Decimal(str(p['valor_bruto_recebido']))
                valor_liquido = Decimal(str(p['valor_liquido_recebido']))
                
                if tipo not in total_por_tipo:
                    total_por_tipo[tipo] = {
                        'quantidade': 0,
                        'valor_bruto': Decimal('0'),
                        'valor_liquido': Decimal('0')
                    }
                
                total_por_tipo[tipo]['quantidade'] += 1
                total_por_tipo[tipo]['valor_bruto'] += valor_bruto
                total_por_tipo[tipo]['valor_liquido'] += valor_liquido
                
                total_geral_bruto += valor_bruto
                total_geral_liquido += valor_liquido
            
            return {
                'total_geral_bruto': float(total_geral_bruto),
                'total_geral_liquido': float(total_geral_liquido),
                'por_tipo': {
                    tipo: {
                        'quantidade': dados['quantidade'],
                        'valor_bruto': float(dados['valor_bruto']),
                        'valor_liquido': float(dados['valor_liquido'])
                    }
                    for tipo, dados in total_por_tipo.items()
                }
            }
            
        except Exception as e:
            logger.error(f"Erro ao calcular total de proventos: {e}")
            raise

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/transacao_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacao Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import datetime, date
from sqlalchemy import and_, or_, func
from app.database import db
from app.models import Transacao, TipoTransacao, Ativo, Corretora

class TransacaoService:
    """Servi√ßo para opera√ß√µes de transa√ß√µes"""
    
    @staticmethod
    def get_all(usuario_id, page=1, per_page=20, tipo=None, ativo_id=None, 
                corretora_id=None, data_inicio=None, data_fim=None):
        """
        Lista transa√ß√µes do usu√°rio com pagina√ß√£o e filtros.
        
        Args:
            usuario_id: ID do usu√°rio (multi-tenant)
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            tipo: Filtro por tipo (COMPRA, VENDA, etc)
            ativo_id: Filtro por ativo
            corretora_id: Filtro por corretora
            data_inicio: Data inicial
            data_fim: Data final
        """
        query = Transacao.query.filter_by(usuario_id=usuario_id)
        
        # Filtros
        if tipo:
            query = query.filter_by(tipo=TipoTransacao[tipo.upper()])
        
        if ativo_id:
            query = query.filter_by(ativo_id=ativo_id)
        
        if corretora_id:
            query = query.filter_by(corretora_id=corretora_id)
        
        if data_inicio:
            query = query.filter(Transacao.data_transacao >= data_inicio)
        
        if data_fim:
            query = query.filter(Transacao.data_transacao <= data_fim)
        
        # Ordenar por data (mais recentes primeiro)
        query = query.order_by(Transacao.data_transacao.desc())
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(transacao_id, usuario_id):
        """Busca transa√ß√£o por ID (com verifica√ß√£o de ownership)"""
        return Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
    
    @staticmethod
    def create(usuario_id, data):
        """
        Cria nova transa√ß√£o.
        
        Args:
            usuario_id: ID do usu√°rio
            data: Dict com tipo, ativo_id, corretora_id, quantidade, preco, etc
        """
        # Verificar se ativo existe
        ativo = Ativo.query.get(data['ativo_id'])
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Verificar se corretora existe e pertence ao usu√°rio
        corretora = Corretora.query.filter_by(
            id=data['corretora_id'],
            usuario_id=usuario_id
        ).first()
        
        if not corretora:
            raise ValueError("Corretora n√£o encontrada ou n√£o pertence ao usu√°rio")
        
        # Calcular valores
        quantidade = Decimal(str(data['quantidade']))
        preco_unitario = Decimal(str(data['preco_unitario']))
        valor_total = quantidade * preco_unitario
        
        # Somar custos
        taxa_corretagem = Decimal(str(data.get('taxa_corretagem', 0)))
        taxa_liquidacao = Decimal(str(data.get('taxa_liquidacao', 0)))
        emolumentos = Decimal(str(data.get('emolumentos', 0)))
        imposto = Decimal(str(data.get('imposto', 0)))
        outros_custos = Decimal(str(data.get('outros_custos', 0)))
        
        custos_totais = (taxa_corretagem + taxa_liquidacao + emolumentos + 
                        imposto + outros_custos)
        
        # Valor l√≠quido (compra: total + custos, venda: total - custos)
        tipo = TipoTransacao[data['tipo'].upper()]
        if tipo == TipoTransacao.COMPRA:
            valor_liquido = valor_total + custos_totais
        elif tipo == TipoTransacao.VENDA:
            valor_liquido = valor_total - custos_totais
        else:
            valor_liquido = valor_total  # Dividendos, JCP, etc
        
        transacao = Transacao(
            usuario_id=usuario_id,
            tipo=tipo,
            ativo_id=data['ativo_id'],
            corretora_id=data['corretora_id'],
            data_transacao=data['data_transacao'],
            quantidade=quantidade,
            preco_unitario=preco_unitario,
            valor_total=valor_total,
            taxa_corretagem=taxa_corretagem,
            taxa_liquidacao=taxa_liquidacao,
            emolumentos=emolumentos,
            imposto=imposto,
            outros_custos=outros_custos,
            custos_totais=custos_totais,
            valor_liquido=valor_liquido,
            observacoes=data.get('observacoes')
        )
        
        db.session.add(transacao)
        db.session.commit()
        return transacao
    
    @staticmethod
    def update(transacao_id, usuario_id, data):
        """
        Atualiza transa√ß√£o.
        
        Args:
            transacao_id: ID da transa√ß√£o
            usuario_id: ID do usu√°rio
            data: Dict com campos a atualizar
        """
        transacao = Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
        
        if not transacao:
            raise ValueError("Transa√ß√£o n√£o encontrada")
        
        # Atualizar campos permitidos
        if 'data_transacao' in data:
            transacao.data_transacao = data['data_transacao']
        
        if 'quantidade' in data:
            transacao.quantidade = Decimal(str(data['quantidade']))
        
        if 'preco_unitario' in data:
            transacao.preco_unitario = Decimal(str(data['preco_unitario']))
        
        if 'taxa_corretagem' in data:
            transacao.taxa_corretagem = Decimal(str(data['taxa_corretagem']))
        
        if 'taxa_liquidacao' in data:
            transacao.taxa_liquidacao = Decimal(str(data['taxa_liquidacao']))
        
        if 'emolumentos' in data:
            transacao.emolumentos = Decimal(str(data['emolumentos']))
        
        if 'imposto' in data:
            transacao.imposto = Decimal(str(data['imposto']))
        
        if 'outros_custos' in data:
            transacao.outros_custos = Decimal(str(data['outros_custos']))
        
        if 'observacoes' in data:
            transacao.observacoes = data['observacoes']
        
        # Recalcular valores
        transacao.valor_total = transacao.quantidade * transacao.preco_unitario
        transacao.custos_totais = (transacao.taxa_corretagem + transacao.taxa_liquidacao + 
                                   transacao.emolumentos + transacao.imposto + 
                                   transacao.outros_custos)
        
        if transacao.tipo == TipoTransacao.COMPRA:
            transacao.valor_liquido = transacao.valor_total + transacao.custos_totais
        elif transacao.tipo == TipoTransacao.VENDA:
            transacao.valor_liquido = transacao.valor_total - transacao.custos_totais
        else:
            transacao.valor_liquido = transacao.valor_total
        
        db.session.commit()
        return transacao
    
    @staticmethod
    def delete(transacao_id, usuario_id):
        """Deleta transa√ß√£o"""
        transacao = Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
        
        if not transacao:
            raise ValueError("Transa√ß√£o n√£o encontrada")
        
        db.session.delete(transacao)
        db.session.commit()
        return True
    
    @staticmethod
    def get_resumo_por_ativo(usuario_id, ativo_id):
        """
        Retorna resumo de transa√ß√µes de um ativo.
        
        Returns:
            Dict com quantidade_total, valor_investido, preco_medio
        """
        transacoes = Transacao.query.filter_by(
            usuario_id=usuario_id,
            ativo_id=ativo_id
        ).all()
        
        quantidade_comprada = Decimal('0')
        quantidade_vendida = Decimal('0')
        valor_investido = Decimal('0')
        valor_vendido = Decimal('0')
        
        for t in transacoes:
            if t.tipo == TipoTransacao.COMPRA:
                quantidade_comprada += t.quantidade
                valor_investido += t.valor_liquido
            elif t.tipo == TipoTransacao.VENDA:
                quantidade_vendida += t.quantidade
                valor_vendido += t.valor_liquido
        
        quantidade_atual = quantidade_comprada - quantidade_vendida
        preco_medio = (valor_investido / quantidade_comprada 
                      if quantidade_comprada > 0 else Decimal('0'))
        
        return {
            "quantidade_total": quantidade_atual,
            "quantidade_comprada": quantidade_comprada,
            "quantidade_vendida": quantidade_vendida,
            "valor_investido": valor_investido,
            "valor_vendido": valor_vendido,
            "preco_medio": preco_medio
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/usuario_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuario Service - L√≥gica de neg√≥cio"""

from werkzeug.security import generate_password_hash, check_password_hash
from sqlalchemy import or_
from app.database import db
from app.models import Usuario, UserRole

class UsuarioService:
    """Servi√ßo para opera√ß√µes de usu√°rios"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, role=None, search=None):
        """
        Lista usu√°rios com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            role: Filtro por role
            search: Busca em username e nome_completo
        """
        query = Usuario.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if role:
            query = query.filter_by(role=UserRole[role.upper()])
        
        if search:
            query = query.filter(
                or_(
                    Usuario.username.ilike(f'%{search}%'),
                    Usuario.nome_completo.ilike(f'%{search}%')
                )
            )
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(user_id):
        """Busca usu√°rio por ID"""
        return Usuario.query.get(user_id)
    
    @staticmethod
    def create(data):
        """
        Cria novo usu√°rio.
        
        Args:
            data: Dict com username, email, password, nome_completo, role
        """
        user = Usuario(
            username=data['username'],
            email=data['email'],
            password_hash=generate_password_hash(data['password']),
            nome_completo=data.get('nome_completo'),
            role=UserRole[data.get('role', 'user').upper()]
        )
        db.session.add(user)
        db.session.commit()
        return user
    
    @staticmethod
    def update(user_id, data, current_user):
        """
        Atualiza usu√°rio.
        
        Args:
            user_id: ID do usu√°rio a atualizar
            data: Dict com campos a atualizar
            current_user: Usu√°rio fazendo a atualiza√ß√£o
        """
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        # Apenas admin pode alterar role e ativo
        is_admin = current_user.role.value.upper() == 'ADMIN'
        
        if 'email' in data:
            # Verifica se email j√° existe (exceto o pr√≥prio)
            existing = Usuario.query.filter_by(email=data['email']).first()
            if existing and existing.id != user.id:
                raise ValueError("Email j√° existe")
            user.email = data['email']
        
        if 'nome_completo' in data:
            user.nome_completo = data['nome_completo']
        
        if 'ativo' in data and is_admin:
            user.ativo = data['ativo']
        
        if 'role' in data and is_admin:
            user.role = UserRole[data['role'].upper()]
        
        db.session.commit()
        return user
    
    @staticmethod
    def delete(user_id):
        """Deleta usu√°rio"""
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        db.session.delete(user)
        db.session.commit()
        return True
    
    @staticmethod
    def change_password(user_id, old_password, new_password):
        """Troca senha do usu√°rio"""
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        if not check_password_hash(user.password_hash, old_password):
            raise ValueError("Senha atual incorreta")
        
        user.password_hash = generate_password_hash(new_password)
        db.session.commit()
        return True

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/decorators.py ---
# -*- coding: utf-8 -*-
"""Exitus - Decorators - Controle de autoriza√ß√£o por roles"""

from functools import wraps
from flask import jsonify, g
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt
from app.database import db
from app.models import Usuario
from app.utils.responses import forbidden, unauthorized

def admin_required(f):
    """Decorator: apenas usu√°rios ADMIN."""
    @wraps(f)
    @jwt_required()
    def decorated_function(*args, **kwargs):
        identity = get_jwt_identity()
        user = Usuario.query.get(identity)
        # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
        if not user or user.role.value.upper() != 'ADMIN':
            return forbidden("Acesso restrito a administradores")
        g.current_user = user
        return f(*args, **kwargs)
    return decorated_function

def role_required(*roles):
    """Decorator: usu√°rios com roles espec√≠ficas.
    
    Uso: @role_required('ADMIN', 'USER')
    """
    def decorator(f):
        @wraps(f)
        @jwt_required()
        def decorated_function(*args, **kwargs):
            identity = get_jwt_identity()
            user = Usuario.query.get(identity)
            # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
            user_role = user.role.value.upper() if user else None
            roles_upper = [r.upper() for r in roles]
            
            if not user or user_role not in roles_upper:
                return forbidden(f"Acesso restrito √†s roles: {', '.join(roles)}")
            g.current_user = user
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def owner_or_admin_required(resource_model):
    """Decorator: propriet√°rio do recurso OU ADMIN.
    
    Uso: @owner_or_admin_required(Usuario)
    """
    def decorator(f):
        @wraps(f)
        @jwt_required()
        def decorated_function(resource_id, *args, **kwargs):
            identity = get_jwt_identity()
            current_user = Usuario.query.get(identity)
            
            if not current_user:
                return unauthorized("Usu√°rio n√£o encontrado")
            
            # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
            if current_user.role.value.upper() == 'ADMIN':
                g.current_user = current_user
                return f(resource_id, *args, **kwargs)
            
            # Verificar se √© o dono do recurso
            resource = resource_model.query.filter_by(usuario_id=identity).first()
            if not resource:
                return forbidden("Acesso negado ao recurso")
            
            g.current_user = current_user
            g.resource_owner = True
            return f(resource_id, *args, **kwargs)
        return decorated_function
    return decorator

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/responses.py ---
# -*- coding: utf-8 -*-
"""Exitus - Utility Responses - Respostas padronizadas"""

from flask import jsonify

def success(data=None, message="Sucesso", status=200):
    """Resposta de sucesso padronizada."""
    response = {"success": True, "message": message}
    if data is not None:
        response["data"] = data
    return jsonify(response), status

def error(message="Erro interno do servidor", status=500):
    """Resposta de erro gen√©rico."""
    return jsonify({
        "success": False, 
        "message": message
    }), status

def unauthorized(message="N√£o autorizado"):
    """Resposta 401."""
    return jsonify({
        "success": False,
        "message": message
    }), 401

def forbidden(message="Acesso negado"):
    """Resposta 403."""
    return jsonify({
        "success": False,
        "message": message
    }), 403

def not_found(message="Recurso n√£o encontrado"):
    """Resposta 404."""
    return jsonify({
        "success": False,
        "message": message
    }), 404

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
# Exitus - M√≥dulo 2 Backend API REST
# Depend√™ncias existentes (M√≥dulo 1)
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
psycopg2-binary==2.9.9
python-dotenv==1.0.0
alembic==1.13.0
gunicorn==21.2.0

# ‚≠ê Novas depend√™ncias (M√≥dulo 2)
Flask-JWT-Extended==4.5.3
Flask-CORS==4.0.0
marshmallow==3.20.1
marshmallow-sqlalchemy==0.29.0
pytest==7.4.3
pytest-flask==1.3.0
pytest-cov==4.1.0
flask-restx==1.3.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt.mod1.bak ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
alembic==1.13.1
Flask-Migrate==4.0.5

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

# Criar a aplica√ß√£o Flask (j√° inicializa o banco internamente)
app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/conftest.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_ativos_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.3 - CRUD DE ATIVOS"
echo ""

# 1. Login ADMIN
echo "1. Login ADMIN..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$ADMIN_TOKEN" ]; then
    echo "‚ùå Erro ao obter token ADMIN!"
    exit 1
fi
echo "‚úÖ Token ADMIN obtido"
echo ""

# 2. Criar a√ß√£o brasileira
echo "2. POST /api/ativos - Criar PETR4 (A√ß√£o BR)..."
PETR4=$(curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "PETR4",
    "nome": "Petrobras PN",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL",
    "preco_atual": "38.50",
    "dividend_yield": "12.5",
    "pl": "4.2",
    "pvp": "0.85",
    "roe": "18.3"
  }')

echo "$PETR4" | python3 -m json.tool
PETR4_ID=$(echo "$PETR4" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['id'])" 2>/dev/null)
echo ""

# 3. Criar FII
echo "3. POST /api/ativos - Criar HGLG11 (FII)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "HGLG11",
    "nome": "CSHG Log√≠stica FII",
    "tipo": "fii",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL",
    "preco_atual": "165.00",
    "dividend_yield": "10.2",
    "pvp": "0.98"
  }' | python3 -m json.tool
echo ""

# 4. Criar a√ß√£o US
echo "4. POST /api/ativos - Criar AAPL (A√ß√£o US)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "AAPL",
    "nome": "Apple Inc",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "US",
    "moeda": "USD",
    "preco_atual": "195.50",
    "dividend_yield": "0.5",
    "pl": "32.5",
    "pvp": "45.2",
    "roe": "147.5"
  }' | python3 -m json.tool
echo ""

# 5. Criar criptomoeda
echo "5. POST /api/ativos - Criar BTC (Cripto)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "BTC",
    "nome": "Bitcoin",
    "tipo": "cripto",
    "classe": "cripto",
    "mercado": "CRIPTO",
    "moeda": "USD",
    "preco_atual": "43500.00"
  }' | python3 -m json.tool
echo ""

# 6. Listar todos os ativos
echo "6. GET /api/ativos - Listar todos ativos..."
curl -s -X GET "http://localhost:5000/api/ativos?page=1&per_page=10" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 7. Filtrar por tipo
echo "7. GET /api/ativos?tipo=acao - Filtrar a√ß√µes..."
curl -s -X GET "http://localhost:5000/api/ativos?tipo=acao" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 8. Filtrar por mercado
echo "8. GET /api/ativos?mercado=BR - Filtrar mercado BR..."
curl -s -X GET "http://localhost:5000/api/ativos?mercado=BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 9. Buscar por ticker
echo "9. GET /api/ativos/ticker/PETR4?mercado=BR - Buscar PETR4..."
curl -s -X GET "http://localhost:5000/api/ativos/ticker/PETR4?mercado=BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 10. Buscar por nome
echo "10. GET /api/ativos?search=Petrobras - Buscar 'Petrobras'..."
curl -s -X GET "http://localhost:5000/api/ativos?search=Petrobras" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 11. Atualizar pre√ßo
if [ ! -z "$PETR4_ID" ]; then
    echo "11. PUT /api/ativos/{id} - Atualizar pre√ßo PETR4..."
    curl -s -X PUT "http://localhost:5000/api/ativos/$PETR4_ID" \
      -H "Authorization: Bearer $ADMIN_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"preco_atual": "39.75", "pl": "4.3"}' | python3 -m json.tool
    echo ""
fi

# 12. Listar ativos por mercado
echo "12. GET /api/ativos/mercado/BR - Ativos mercado BR..."
curl -s -X GET "http://localhost:5000/api/ativos/mercado/BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 13. Login USER
echo "13. Login USER (joao.silva)..."
USER_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"novasenha123"}')

USER_TOKEN=$(echo "$USER_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    # Tentar senha antiga
    USER_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username":"joao.silva","password":"user123"}')
    USER_TOKEN=$(echo "$USER_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
fi

echo "‚úÖ Token USER obtido"
echo ""

# 14. USER pode listar ativos (leitura p√∫blica)
echo "14. GET /api/ativos - USER listando ativos (deve funcionar)..."
curl -s -X GET "http://localhost:5000/api/ativos" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 15. USER tentar criar ativo (deve falhar 403)
echo "15. POST /api/ativos - USER tentando criar (deve falhar 403)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "VALE3",
    "nome": "Vale",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL"
  }' | python3 -m json.tool
echo ""

echo "‚úÖ Testes CRUD Ativos conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_auth_phase21.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.1 - AUTENTICA√á√ÉO JWT"

# 1. Health check
echo "1. Health check..."
curl -s http://localhost:5000/health | python3 -m json.tool

# 2. Login admin (deve funcionar)
echo "2. Login admin..."
curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | python3 -m json.tool

# 3. Login inv√°lido (deve falhar)
echo "3. Login inv√°lido..."
curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"invalido","password":"123"}' | python3 -m json.tool

# 4. /me sem token (deve falhar 401)
echo "4. /me sem token..."
curl -s -X GET http://localhost:5000/api/auth/me | python3 -m json.tool

echo "‚úÖ Testes Fase 2.1 conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_corretoras_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.2 - CRUD DE CORRETORAS"
echo ""

# 1. Login usu√°rio comum (joao.silva) - senha foi alterada para novasenha123
echo "1. Login USER (joao.silva)..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"novasenha123"}')

USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    echo "‚ùå Erro ao obter token USER! Tentando senha antiga..."
    RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username":"joao.silva","password":"user123"}')
    USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
fi

echo "‚úÖ Token USER obtido"
echo ""

# 2. Criar corretora BR
echo "2. POST /api/corretoras - Criar corretora XP (BR)..."
CORRETORA_XP=$(curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "XP Investimentos",
    "tipo": "corretora",
    "pais": "BR",
    "moeda_padrao": "BRL",
    "saldo_atual": "10000.50",
    "observacoes": "Conta principal"
  }')

echo "$CORRETORA_XP" | python3 -m json.tool
XP_ID=$(echo "$CORRETORA_XP" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['id'])" 2>/dev/null)
echo ""

# 3. Criar exchange cripto
echo "3. POST /api/corretoras - Criar exchange Binance..."
curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Binance",
    "tipo": "exchange",
    "pais": "US",
    "moeda_padrao": "USD",
    "saldo_atual": "5000.00",
    "observacoes": "Exchange de criptomoedas"
  }' | python3 -m json.tool
echo ""

# 4. Criar corretora US
echo "4. POST /api/corretoras - Criar Avenue (US)..."
curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Avenue Securities",
    "tipo": "corretora",
    "pais": "US",
    "moeda_padrao": "USD",
    "saldo_atual": "2500.75"
  }' | python3 -m json.tool
echo ""

# 5. Listar todas as corretoras
echo "5. GET /api/corretoras - Listar todas corretoras do usu√°rio..."
curl -s -X GET "http://localhost:5000/api/corretoras?page=1&per_page=10" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 6. Filtrar por tipo
echo "6. GET /api/corretoras?tipo=exchange - Filtrar exchanges..."
curl -s -X GET "http://localhost:5000/api/corretoras?tipo=exchange" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 7. Filtrar por pa√≠s
echo "7. GET /api/corretoras?pais=BR - Filtrar por pa√≠s BR..."
curl -s -X GET "http://localhost:5000/api/corretoras?pais=BR" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 8. Buscar por nome
echo "8. GET /api/corretoras?search=XP - Buscar 'XP'..."
curl -s -X GET "http://localhost:5000/api/corretoras?search=XP" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 9. Buscar corretora espec√≠fica
if [ ! -z "$XP_ID" ]; then
    echo "9. GET /api/corretoras/{id} - Buscar XP por ID..."
    curl -s -X GET "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 10. Atualizar corretora
if [ ! -z "$XP_ID" ]; then
    echo "10. PUT /api/corretoras/{id} - Atualizar saldo XP..."
    curl -s -X PUT "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $USER_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"saldo_atual": "15000.00", "observacoes": "Saldo atualizado"}' | python3 -m json.tool
    echo ""
fi

# 11. Saldo total em BRL
echo "11. GET /api/corretoras/saldo-total?moeda=BRL - Saldo total BRL..."
curl -s -X GET "http://localhost:5000/api/corretoras/saldo-total?moeda=BRL" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 12. Saldo total em USD
echo "12. GET /api/corretoras/saldo-total?moeda=USD - Saldo total USD..."
curl -s -X GET "http://localhost:5000/api/corretoras/saldo-total?moeda=USD" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 13. Tentar acessar corretora de outro usu√°rio (admin)
echo "13. Login ADMIN..."
ADMIN_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$ADMIN_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ ! -z "$XP_ID" ] && [ ! -z "$ADMIN_TOKEN" ]; then
    echo "14. GET - ADMIN tentando acessar corretora do USER (deve falhar)..."
    curl -s -X GET "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
    echo ""
fi

echo "‚úÖ Testes CRUD Corretoras conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_decorators.sh ---
#!/bin/bash
echo "üß™ TESTES DECORATORS - Fase 2.1.2"

# 1. Fazer login e pegar token
echo "1. Login admin..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ACCESS_TOKEN=$(echo $RESPONSE | python3 -m json.tool | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
echo "‚úÖ Token obtido: ${ACCESS_TOKEN:0:30}..."

# 2. Teste /me COM token (deve funcionar)
echo "2. /me COM token..."
curl -s -X GET "http://localhost:5000/api/auth/me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | python3 -m json.tool

# 3. Teste /me SEM token (deve falhar 401)
echo "3. /me SEM token..."
curl -s -X GET http://localhost:5000/api/auth/me | python3 -m json.tool

# 4. Teste refresh token
echo "4. Refresh token..."
REFRESH_TOKEN=$(echo $RESPONSE | python3 -m json.tool | grep -o '"refresh_token":"[^"]*' | cut -d'"' -f4)
curl -s -X POST http://localhost:5000/api/auth/refresh \
  -H "Authorization: Bearer $REFRESH_TOKEN" | python3 -m json.tool

echo "‚úÖ Testes decorators conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_transacoes_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.4 - CRUD DE TRANSA√á√ïES"
echo ""

# 1. Login USER
echo "1. Login USER (joao.silva)..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"user123"}')

USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('access_token', ''))" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    echo "‚ùå Falha ao obter token USER"
    echo "$RESPONSE" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ Token USER obtido: ${USER_TOKEN:0:20}..."
echo ""

# 2. Buscar corretora do USER
echo "2. GET /api/corretoras - Buscar corretora do USER..."
CORRETORAS=$(curl -s -X GET "http://localhost:5000/api/corretoras" \
  -H "Authorization: Bearer $USER_TOKEN")

CORRETORA_ID=$(echo "$CORRETORAS" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('corretoras', [{}])[0].get('id', ''))" 2>/dev/null)

if [ -z "$CORRETORA_ID" ]; then
    echo "‚ùå Nenhuma corretora encontrada"
    echo "$CORRETORAS" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ Corretora ID: $CORRETORA_ID"
echo ""

# 3. Buscar ativo PETR4
echo "3. GET /api/ativos/ticker/PETR4?mercado=BR - Buscar PETR4..."
PETR4=$(curl -s -X GET "http://localhost:5000/api/ativos/ticker/PETR4?mercado=BR" \
  -H "Authorization: Bearer $USER_TOKEN")

PETR4_ID=$(echo "$PETR4" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)

if [ -z "$PETR4_ID" ]; then
    echo "‚ùå PETR4 n√£o encontrado"
    echo "$PETR4" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ PETR4 ID: $PETR4_ID"
echo ""

# 4. Criar transa√ß√£o de COMPRA
echo "4. POST /api/transacoes - Criar COMPRA 100 PETR4 @ R\$ 38.50..."
COMPRA=$(curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"compra\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-01T10:30:00\",
    \"quantidade\": \"100\",
    \"preco_unitario\": \"38.50\",
    \"taxa_corretagem\": \"10.00\",
    \"emolumentos\": \"2.50\",
    \"imposto\": \"0.50\"
  }")

echo "$COMPRA" | python3 -m json.tool
COMPRA_ID=$(echo "$COMPRA" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)
echo ""

# 5. Buscar ativo VALE3
echo "5. GET /api/ativos/ticker/VALE3?mercado=BR - Buscar VALE3..."
VALE3=$(curl -s -X GET "http://localhost:5000/api/ativos/ticker/VALE3?mercado=BR" \
  -H "Authorization: Bearer $USER_TOKEN")

VALE3_ID=$(echo "$VALE3" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)
echo "‚úÖ VALE3 ID: $VALE3_ID"
echo ""

# 6. Criar transa√ß√£o de COMPRA VALE3
echo "6. POST /api/transacoes - Criar COMPRA 50 VALE3 @ R\$ 62.80..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"compra\",
    \"ativo_id\": \"$VALE3_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-02T14:00:00\",
    \"quantidade\": \"50\",
    \"preco_unitario\": \"62.80\",
    \"taxa_corretagem\": \"8.00\",
    \"emolumentos\": \"2.00\"
  }" | python3 -m json.tool
echo ""

# 7. Criar transa√ß√£o de VENDA
echo "7. POST /api/transacoes - Criar VENDA 30 PETR4 @ R\$ 39.20..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"venda\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-02T15:30:00\",
    \"quantidade\": \"30\",
    \"preco_unitario\": \"39.20\",
    \"taxa_corretagem\": \"6.00\",
    \"emolumentos\": \"1.50\",
    \"imposto\": \"0.30\"
  }" | python3 -m json.tool
echo ""

# 8. Criar transa√ß√£o de DIVIDENDO
echo "8. POST /api/transacoes - Criar DIVIDENDO PETR4..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"dividendo\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-11-15T00:00:00\",
    \"quantidade\": \"100\",
    \"preco_unitario\": \"0.85\",
    \"observacoes\": \"Dividendos referentes a novembro/2025\"
  }" | python3 -m json.tool
echo ""

# 9. Listar todas as transa√ß√µes
echo "9. GET /api/transacoes - Listar todas transa√ß√µes..."
curl -s -X GET "http://localhost:5000/api/transacoes?page=1&per_page=10" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 10. Filtrar por tipo
echo "10. GET /api/transacoes?tipo=compra - Filtrar compras..."
curl -s -X GET "http://localhost:5000/api/transacoes?tipo=compra" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 11. Filtrar por ativo
if [ ! -z "$PETR4_ID" ]; then
    echo "11. GET /api/transacoes?ativo_id=PETR4_ID - Filtrar PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes?ativo_id=$PETR4_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 12. Filtrar por per√≠odo
echo "12. GET /api/transacoes?data_inicio=2025-12-01 - Filtrar dezembro..."
curl -s -X GET "http://localhost:5000/api/transacoes?data_inicio=2025-12-01T00:00:00" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 13. Buscar transa√ß√£o por ID
if [ ! -z "$COMPRA_ID" ]; then
    echo "13. GET /api/transacoes/{id} - Buscar compra PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes/$COMPRA_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 14. Atualizar transa√ß√£o
if [ ! -z "$COMPRA_ID" ]; then
    echo "14. PUT /api/transacoes/{id} - Atualizar taxa corretagem..."
    curl -s -X PUT "http://localhost:5000/api/transacoes/$COMPRA_ID" \
      -H "Authorization: Bearer $USER_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"taxa_corretagem": "12.00"}' | python3 -m json.tool
    echo ""
fi

# 15. Resumo por ativo
if [ ! -z "$PETR4_ID" ]; then
    echo "15. GET /api/transacoes/resumo/{ativo_id} - Resumo PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes/resumo/$PETR4_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

echo "‚úÖ Testes CRUD Transa√ß√µes conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_usuarios_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.1 - CRUD DE USU√ÅRIOS"
echo ""

# 1. Login ADMIN para obter token
echo "1. Login ADMIN..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$ADMIN_TOKEN" ]; then
    echo "‚ùå Erro ao obter token ADMIN!"
    exit 1
fi
echo "‚úÖ Token ADMIN obtido"
echo ""

# 2. Criar novo usu√°rio
echo "2. POST /api/usuarios - Criar usu√°rio 'teste.user'..."
curl -s -X POST http://localhost:5000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "username": "teste.user",
    "email": "teste@exitus.com",
    "password": "senha12345",
    "nome_completo": "Usu√°rio de Teste",
    "role": "user"
  }' | python3 -m json.tool
echo ""

# 3. Listar usu√°rios (admin only)
echo "3. GET /api/usuarios - Listar usu√°rios (ADMIN)..."
curl -s -X GET "http://localhost:5000/api/usuarios?page=1&per_page=10" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 4. Buscar usu√°rio espec√≠fico
echo "4. GET /api/usuarios/{id} - Buscar admin (com token ADMIN)..."
ADMIN_ID="783c2bfd-9e36-4cbd-a4fb-901afae9fad3"
curl -s -X GET "http://localhost:5000/api/usuarios/$ADMIN_ID" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 5. Login usu√°rio comum
echo "5. Login usu√°rio comum (joao.silva)..."
RESPONSE_USER=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"user123"}')

USER_TOKEN=$(echo "$RESPONSE_USER" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
USER_ID=$(echo "$RESPONSE_USER" | python3 -c "import sys, json; import jwt; token=json.load(sys.stdin)['data']['access_token']; print(jwt.decode(token, options={'verify_signature': False})['sub'])" 2>/dev/null)

echo "‚úÖ Token USER obtido (ID: $USER_ID)"
echo ""

# 6. Tentar listar usu√°rios com USER (deve falhar 403)
echo "6. GET /api/usuarios - Tentar listar com USER (deve falhar 403)..."
curl -s -X GET http://localhost:5000/api/usuarios \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 7. Ver pr√≥prio perfil com USER (deve funcionar)
echo "7. GET /api/usuarios/{id} - USER vendo pr√≥prio perfil..."
curl -s -X GET "http://localhost:5000/api/usuarios/$USER_ID" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 8. Atualizar pr√≥prio perfil
echo "8. PUT /api/usuarios/{id} - USER atualizando pr√≥prio nome..."
curl -s -X PUT "http://localhost:5000/api/usuarios/$USER_ID" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nome_completo": "Jo√£o Silva Atualizado"}' | python3 -m json.tool
echo ""

# 9. Trocar senha
echo "9. PATCH /api/usuarios/{id}/password - Trocar senha..."
curl -s -X PATCH "http://localhost:5000/api/usuarios/$USER_ID/password" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"old_password": "user123", "new_password": "novasenha123"}' | python3 -m json.tool
echo ""

# 10. Filtros e busca
echo "10. GET /api/usuarios?search=admin - Buscar por nome..."
curl -s -X GET "http://localhost:5000/api/usuarios?search=admin" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

echo "‚úÖ Testes CRUD Usu√°rios conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/INSTALACAO_MODULO1.md ---
# Exitus - M√≥dulo 1: Database Backend
## Guia Completo de Instala√ß√£o e Configura√ß√£o

---

## üìã √çndice

1. [Pr√©-requisitos](#pr√©-requisitos)
2. [Estrutura do Projeto](#estrutura-do-projeto)
3. [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
4. [Instala√ß√£o dos Containers](#instala√ß√£o-dos-containers)
5. [Configura√ß√£o do Backend](#configura√ß√£o-do-backend)
6. [Migrations e Schema](#migrations-e-schema)
7. [Seeds de Dados](#seeds-de-dados)
8. [Valida√ß√£o da Instala√ß√£o](#valida√ß√£o-da-instala√ß√£o)
9. [Troubleshooting](#troubleshooting)

---

## üîß Pr√©-requisitos

### Sistema Operacional
- Ubuntu 22.04+ (WSL2 ou nativo)
- Podman instalado e configurado

### Verificar Instala√ß√£o
```bash
# Verificar vers√£o do Podman
podman --version
# Sa√≠da esperada: podman version 4.x.x ou superior

# Verificar se Podman est√° rodando
podman ps
```

---

## üìÅ Estrutura do Projeto

```
exitus/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ alembic/              # Migrations do banco de dados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ versions/         # Arquivos de migration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.py           # Configura√ß√£o do Alembic
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py      # Inicializa√ß√£o da aplica√ß√£o Flask
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py        # Configura√ß√µes da aplica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py      # Configura√ß√£o do SQLAlchemy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/          # Models do sistema (12 arquivos)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ usuario.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ corretora.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ativo.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posicao.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transacao.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provento.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ movimentacao_caixa.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ evento_corporativo.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fonte_dados.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ regra_fiscal.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ feriado_mercado.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ log_auditoria.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeds/           # Scripts de popula√ß√£o de dados
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_usuarios.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_ativos_br.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_regras_fiscais_br.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_feriados_b3.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_fontes_dados.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ run_all_seeds.py
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile           # Imagem Docker do backend
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt     # Depend√™ncias Python
‚îÇ   ‚îú‚îÄ‚îÄ alembic.ini         # Configura√ß√£o do Alembic
‚îÇ   ‚îî‚îÄ‚îÄ run.py              # Entry point da aplica√ß√£o
‚îú‚îÄ‚îÄ docs/                    # Documenta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ INSTALACAO_MODULO1.md
‚îÇ   ‚îî‚îÄ‚îÄ modulo1_database.md
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ setup_containers.sh  # Script de setup dos containers
‚îî‚îÄ‚îÄ tests/                   # Scripts de valida√ß√£o
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase1.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase2.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase3.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase4.sh
    ‚îî‚îÄ‚îÄ mod1_validacao_final_fase5.sh
```

---

## ‚öôÔ∏è Configura√ß√£o do Ambiente

### 1. Criar Diret√≥rios do Projeto

```bash
mkdir -p ~/exitus/{backend,docs,scripts,tests}
cd ~/exitus
```

### 2. Criar Rede Podman

```bash
podman network create exitus-network
```

**Verificar:**
```bash
podman network ls
# Deve mostrar: exitus-network
```

---

## üê≥ Instala√ß√£o dos Containers

### 1. Container PostgreSQL

```bash
podman run -d \
  --name exitus-db \
  --network exitus-network \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus_pass \
  -e POSTGRES_DB=exitusdb \
  -v exitus-db-data:/var/lib/postgresql/data \
  postgres:15-alpine
```

**Verificar:**
```bash
podman logs exitus-db
# Deve mostrar: "database system is ready to accept connections"
```

### 2. Preparar Backend

**Criar requirements.txt:**
```bash
nano backend/requirements.txt
```

```txt
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
psycopg2-binary==2.9.9
python-dotenv==1.0.0
alembic==1.13.0
gunicorn==21.2.0
```

**Criar Dockerfile:**
```bash
nano backend/Dockerfile
```

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instalar depend√™ncias do sistema
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Copiar requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar c√≥digo
COPY . .

# Expor porta
EXPOSE 5000

# Comando de inicializa√ß√£o
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--reload", "--timeout", "120", "run:app"]
```

### 3. Container Backend

**Build da imagem:**
```bash
cd backend
podman build -t exitus-backend:latest .
```

**Executar container:**
```bash
podman run -d \
  --name exitus-backend \
  --network exitus-network \
  -p 5000:5000 \
  -e FLASK_ENV=development \
  -e DATABASE_URL=postgresql://exitus:exitus_pass@exitus-db:5432/exitusdb \
  -v $(pwd):/app:Z \
  exitus-backend:latest
```

**Verificar:**
```bash
curl http://localhost:5000/health
# Deve retornar: {"status":"ok","service":"exitus-backend","env":"development"}
```

---

## üîß Configura√ß√£o do Backend

### 1. Estrutura de Arquivos

Todos os arquivos do backend j√° devem estar criados conforme a estrutura mostrada acima.

### 2. Arquivo de Configura√ß√£o Principal

**backend/app/__init__.py:**
```python
from flask import Flask
from app.config import Config
from app.database import init_db

def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)

    # Inicializar banco de dados
    init_db(app)

    # Registrar blueprints (ser√° feito no M√≥dulo 2)

    # Rota de health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config['ENV']
        }

    return app

app = create_app()
```

### 3. Configura√ß√£o do Banco de Dados

**backend/app/database.py:**
```python
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()

def init_db(app):
    db.init_app(app)
    migrate.init_app(app, db)

    with app.app_context():
        # Importar todos os models
        from app.models import (
            Usuario, Corretora, Ativo, Posicao, Transacao,
            Provento, MovimentacaoCaixa, EventoCorporativo,
            FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
        )

    return db
```

---

## üóÉÔ∏è Migrations e Schema

### 1. Configurar Alembic

**backend/alembic/env.py** (j√° deve estar configurado corretamente)

### 2. Gerar Migration Inicial

```bash
# Entrar no container
podman exec -it exitus-backend bash

# Dentro do container:
cd /app
alembic revision --autogenerate -m "Initial schema - 12 models"
```

**Sa√≠da esperada:**
```
INFO  [alembic.autogenerate.compare] Detected added table 'usuario'
INFO  [alembic.autogenerate.compare] Detected added table 'ativo'
...
Generating /app/alembic/versions/XXXXX_initial_schema_12_models.py ... done
```

### 3. Aplicar Migration

```bash
# Dentro do container:
alembic upgrade head
```

**Sa√≠da esperada:**
```
INFO  [alembic.runtime.migration] Running upgrade  -> XXXXX, Initial schema - 12 models
```

### 4. Validar Schema Criado

```bash
# No host:
podman exec exitus-db psql -U exitus -d exitusdb -c "\dt"
```

**Deve listar 13 tabelas:**
- alembic_version
- ativo
- corretora
- evento_corporativo
- feriado_mercado
- fonte_dados
- log_auditoria
- movimentacao_caixa
- posicao
- provento
- regra_fiscal
- transacao
- usuario

---

## üå± Seeds de Dados

### Executar Seeds Individuais

```bash
# Dentro do container backend:
python3 -m app.seeds.seed_usuarios
python3 -m app.seeds.seed_ativos_br
python3 -m app.seeds.seed_regras_fiscais_br
python3 -m app.seeds.seed_feriados_b3
python3 -m app.seeds.seed_fontes_dados
```

### Ou Executar Todos de Uma Vez

```bash
# Dentro do container backend:
python3 -m app.seeds.run_all_seeds
```

### Dados Populados

Ap√≥s executar os seeds, o banco ter√°:
- **4 usu√°rios** (admin, 2 users, 1 readonly)
- **25 ativos BR** (15 a√ß√µes + 10 FIIs)
- **6 regras fiscais** brasileiras
- **30 feriados** B3 (2025-2026)
- **7 fontes de dados** (APIs)

**Credenciais de acesso:**
```
Username: admin       | Senha: admin123
Username: joao.silva  | Senha: user123
Username: maria.santos| Senha: user123
Username: viewer      | Senha: viewer123
```

‚ö†Ô∏è **ATEN√á√ÉO:** Altere as senhas em produ√ß√£o!

---

## ‚úÖ Valida√ß√£o da Instala√ß√£o

### Scripts de Valida√ß√£o Autom√°tica

```bash
# No host, executar cada fase:
./tests/mod1_validacao_final_fase1.sh
./tests/mod1_validacao_final_fase2.sh
./tests/mod1_validacao_final_fase3.sh
./tests/mod1_validacao_final_fase4.sh
./tests/mod1_validacao_final_fase5.sh
```

### Valida√ß√£o Manual

**1. Verificar containers:**
```bash
podman ps
# Deve mostrar 3 containers rodando: exitus-db, exitus-backend, exitus-frontend
```

**2. Testar conex√£o com banco:**
```bash
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT COUNT(*) FROM usuario;"
# Deve retornar: 4
```

**3. Testar API backend:**
```bash
curl http://localhost:5000/health
# Deve retornar JSON com status ok
```

**4. Verificar logs:**
```bash
podman logs exitus-backend --tail 20
# N√£o deve ter erros cr√≠ticos
```

---

## üîç Troubleshooting

### Container n√£o inicia

**Problema:** Container exitus-backend n√£o sobe
```bash
podman logs exitus-backend
# Ver erros espec√≠ficos
```

**Solu√ß√µes comuns:**
- Verificar se porta 5000 n√£o est√° em uso: `netstat -tulpn | grep 5000`
- Verificar vari√°veis de ambiente: `podman exec exitus-backend env | grep DATABASE`
- Reconstruir imagem: `podman build --no-cache -t exitus-backend:latest .`

### Erro de conex√£o com banco

**Problema:** Backend n√£o conecta no PostgreSQL

**Solu√ß√µes:**
```bash
# Verificar se containers est√£o na mesma rede
podman network inspect exitus-network

# Testar conex√£o manualmente
podman exec exitus-backend ping exitus-db

# Verificar se PostgreSQL est√° aceitando conex√µes
podman exec exitus-db pg_isready -U exitus
```

### Migration falha

**Problema:** `alembic upgrade head` retorna erro

**Solu√ß√µes:**
```bash
# Ver hist√≥rico de migrations
alembic history

# Ver vers√£o atual
alembic current

# Reverter migration (cuidado!)
alembic downgrade -1

# Gerar nova migration
alembic revision --autogenerate -m "Fix: descri√ß√£o"
```

### Seed falha

**Problema:** Seed retorna erro de constraint ou duplicate

**Solu√ß√µes:**
```bash
# Limpar tabela espec√≠fica (exemplo: usuario)
podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario;"

# Resetar banco (CUIDADO - apaga tudo!)
podman exec exitus-db psql -U exitus -d exitusdb -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
alembic upgrade head
```

---

## üìä Resumo da Instala√ß√£o

Ao final deste guia, voc√™ ter√°:

‚úÖ 3 containers rodando (PostgreSQL, Backend, Frontend)  
‚úÖ 13 tabelas criadas no banco de dados  
‚úÖ 11 enums personalizados  
‚úÖ 15 foreign keys configuradas  
‚úÖ 86 √≠ndices otimizados  
‚úÖ 72 registros de dados iniciais  
‚úÖ 5 scripts de valida√ß√£o funcionando  

**Tempo estimado de instala√ß√£o:** 45-60 minutos

---

## üéØ Pr√≥ximos Passos

Com o M√≥dulo 1 instalado, voc√™ pode:

1. **M√≥dulo 2:** Desenvolver API REST com endpoints CRUD
2. **M√≥dulo 3:** Criar interface frontend
3. **Testes:** Implementar testes unit√°rios e de integra√ß√£o
4. **Deploy:** Preparar ambiente de produ√ß√£o

---

## üìö Refer√™ncias

- [Documenta√ß√£o do PostgreSQL](https://www.postgresql.org/docs/)
- [Flask Documentation](https://flask.palletsprojects.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Podman Documentation](https://docs.podman.io/)

---

**Vers√£o:** 1.0  
**Data:** Novembro 2025  
**Autor:** Equipe Exitus

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/MODULO0_CHECKLIST.md ---
# ‚úÖ Checklist de Conclus√£o - M√≥dulo 0

**Projeto**: Exitus - Sistema de Controle e An√°lise de Investimentos  
**M√≥dulo**: 0 - Prepara√ß√£o do Ambiente Podman  
**Data de Conclus√£o**: Novembro 2025  
**Status**: ‚úÖ **CONCLU√çDO COM SUCESSO**

---

## üìã Vis√£o Geral

O M√≥dulo 0 estabeleceu a **infraestrutura base** do projeto Exitus, incluindo:
- Estrutura de diret√≥rios do projeto
- Configura√ß√£o de ambiente com Podman
- Cria√ß√£o de rede bridge customizada
- Configura√ß√£o de volumes persistentes
- Prepara√ß√£o dos 3 containers (PostgreSQL, Backend, Frontend)
- Scripts de gerenciamento e automa√ß√£o
- Documenta√ß√£o completa

---

## üèóÔ∏è Fase 0.1 - Estrutura do Projeto

### ‚úÖ Diret√≥rios Criados

- [x] **Diret√≥rio raiz** `/home/p016525/exitus`
- [x] **docs/** - Documenta√ß√£o modular
  - [x] modulo0_ambiente.md
  - [x] Preparado para m√≥dulos 1-8
- [x] **scripts/** - Scripts de automa√ß√£o
  - [x] setup_containers.sh
  - [x] start_services.sh
  - [x] stop_services.sh
  - [x] backup_db.sh
  - [x] cleanup_containers.sh
- [x] **backend/** - C√≥digo Flask Backend
  - [x] app/ (estrutura b√°sica)
  - [x] requirements.txt
  - [x] Dockerfile
  - [x] .env.example
  - [x] run.py
- [x] **frontend/** - C√≥digo Flask Frontend
  - [x] app/ (estrutura b√°sica)
  - [x] templates/
  - [x] static/
  - [x] requirements.txt
  - [x] Dockerfile
  - [x] .env.example
  - [x] run.py
- [x] **tests/** - Testes automatizados
- [x] **backups/** - Backups do banco

### ‚úÖ Arquivos de Configura√ß√£o

- [x] **README.md** principal com vis√£o geral
- [x] **.gitignore** configurado
- [x] **backend/.env.example** (template)
- [x] **backend/.env.development.example**
- [x] **backend/.env.staging.example**
- [x] **backend/.env.production.example**
- [x] **frontend/.env.example** (template)

---

## üê≥ Fase 0.2 - Instala√ß√£o do Podman

### ‚úÖ Instala√ß√£o e Configura√ß√£o

- [x] **Podman instalado** no Ubuntu 22.04
  - [x] Vers√£o: 4.x ou superior
  - [x] Modo rootless configurado
  - [x] Comando: `podman --version`

- [x] **Verifica√ß√µes iniciais**
  - [x] `podman info` executado com sucesso
  - [x] Storage configurado corretamente
  - [x] Networking funcional

### ‚úÖ Permiss√µes e Configura√ß√£o

- [x] Usu√°rio adicionado ao grupo necess√°rio
- [x] Subuid/subgid configurados
- [x] Systemd user service habilitado (se aplic√°vel)

---

## üåê Fase 0.3 - Configura√ß√£o de Rede

### ‚úÖ Rede Bridge Customizada

- [x] **Rede criada**: `exitus-network`
  - [x] Comando: `podman network create exitus-network`
  - [x] Driver: bridge
  - [x] Subnet: auto-configurado

- [x] **Verifica√ß√£o**
  - [x] `podman network ls` lista exitus-network
  - [x] `podman network inspect exitus-network` retorna configura√ß√µes

### ‚úÖ Isolamento e Comunica√ß√£o

- [x] Containers podem se comunicar via nome
- [x] Resolu√ß√£o DNS interna funcionando
- [x] Portas expostas apenas quando necess√°rio

---

## üíæ Fase 0.4 - Volumes Persistentes

### ‚úÖ Volumes Criados

- [x] **exitus-db-data** (PostgreSQL)
  - [x] Comando: `podman volume create exitus-db-data`
  - [x] Montado em: `/var/lib/postgresql/data`
  - [x] Persist√™ncia validada ap√≥s restart

- [x] **Volumes de desenvolvimento** (opcional)
  - [x] Bind mounts para hot reload
  - [x] Backend: `$(pwd)/backend:/app`
  - [x] Frontend: `$(pwd)/frontend:/app`

### ‚úÖ Backups

- [x] Script de backup criado (`backup_db.sh`)
- [x] Pol√≠tica de reten√ß√£o definida
- [x] Teste de backup realizado
- [x] Teste de restore realizado

---

## üóÑÔ∏è Fase 0.5 - Container PostgreSQL

### ‚úÖ Configura√ß√£o

- [x] **Imagem**: `docker.io/library/postgres:15`
- [x] **Nome do container**: `exitus-db`
- [x] **Rede**: `exitus-network`
- [x] **Volume**: `exitus-db-data` montado

### ‚úÖ Vari√°veis de Ambiente

- [x] `POSTGRES_USER=exitus`
- [x] `POSTGRES_PASSWORD=exitus123`
- [x] `POSTGRES_DB=exitusdb`
- [x] `TZ=America/Sao_Paulo`

### ‚úÖ Valida√ß√£o

- [x] Container iniciado com sucesso
- [x] Logs sem erros cr√≠ticos
- [x] `podman exec exitus-db pg_isready -U exitus` retorna sucesso
- [x] Conex√£o via psql funcionando
- [x] Porta 5432 exposta (apenas para rede interna)

### ‚úÖ Comandos Testados

```bash
# Iniciar container
podman run -d --name exitus-db   --network exitus-network   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -v exitus-db-data:/var/lib/postgresql/data   postgres:15

# Verificar logs
podman logs exitus-db

# Testar conex√£o
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();"
```

---

## üîß Fase 0.6 - Container Backend (Prepara√ß√£o)

### ‚úÖ Arquivos Base

- [x] **backend/requirements.txt** criado
  ```txt
  Flask==3.0.0
  Flask-SQLAlchemy==3.1.1
  Flask-Migrate==4.0.5
  Flask-CORS==4.0.0
  psycopg2-binary==2.9.9
  python-dotenv==1.0.0
  requests==2.31.0
  pytest==7.4.3
  gunicorn==21.2.0
  ```

- [x] **backend/Dockerfile** criado
  - [x] Base: `python:3.11-slim`
  - [x] Workdir: `/app`
  - [x] Depend√™ncias do sistema instaladas
  - [x] Requirements instalados
  - [x] C√≥digo copiado
  - [x] Porta 5000 exposta
  - [x] CMD: gunicorn com reload

- [x] **backend/.env.example** criado
  ```bash
  POSTGRES_HOST=exitus-db
  POSTGRES_USER=exitus
  POSTGRES_PASSWORD=exitus123
  POSTGRES_DB=exitusdb
  POSTGRES_PORT=5432
  FLASK_APP=run.py
  FLASK_ENV=development
  SECRET_KEY=change-me-in-env
  TZ=America/Sao_Paulo
  ```

### ‚úÖ Estrutura Backend B√°sica

- [x] **backend/app/__init__.py** (Application Factory)
- [x] **backend/app/config.py** (Configura√ß√µes)
- [x] **backend/app/database.py** (SQLAlchemy setup)
- [x] **backend/run.py** (Entry point)

### ‚úÖ Build e Teste

- [x] Build da imagem realizado
  ```bash
  cd backend
  podman build -t exitus-backend:latest .
  ```

- [x] Container executado em modo teste
- [x] Health check endpoint `/health` funcionando
- [x] Conectividade com PostgreSQL validada

---

## üñ•Ô∏è Fase 0.7 - Container Frontend (Prepara√ß√£o)

### ‚úÖ Arquivos Base

- [x] **frontend/requirements.txt** criado
  ```txt
  Flask==3.0.0
  python-dotenv==1.0.0
  requests==2.31.0
  ```

- [x] **frontend/Dockerfile** criado
  - [x] Base: `python:3.11-slim`
  - [x] Workdir: `/app`
  - [x] Requirements instalados
  - [x] C√≥digo copiado
  - [x] Porta 3000 exposta
  - [x] CMD: gunicorn

- [x] **frontend/.env.example** criado
  ```bash
  BACKEND_API_URL=http://exitus-backend:5000
  FLASK_APP=run.py
  FLASK_ENV=development
  SECRET_KEY=change-me-in-env
  TZ=America/Sao_Paulo
  ```

### ‚úÖ Estrutura Frontend B√°sica

- [x] **frontend/app/__init__.py**
- [x] **frontend/app/config.py**
- [x] **frontend/templates/** (preparado)
- [x] **frontend/static/** (preparado)
- [x] **frontend/run.py**

### ‚úÖ Build e Teste

- [x] Build da imagem realizado
  ```bash
  cd frontend
  podman build -t exitus-frontend:latest .
  ```

- [x] Container executado em modo teste
- [x] Comunica√ß√£o com backend validada

---

## üöÄ Fase 0.8 - Scripts de Automa√ß√£o

### ‚úÖ Scripts Criados

- [x] **scripts/start_services.sh**
  - [x] Inicia os 3 containers em ordem
  - [x] Aguarda inicializa√ß√£o do PostgreSQL
  - [x] Valida conectividade
  - [x] Exibe status dos servi√ßos

- [x] **scripts/stop_services.sh**
  - [x] Para todos os containers gracefully
  - [x] Exibe confirma√ß√£o

- [x] **scripts/restart_services.sh**
  - [x] Stop + Start automatizado

- [x] **scripts/logs_services.sh**
  - [x] Exibe logs de todos os containers
  - [x] Op√ß√£o para follow logs

- [x] **scripts/backup_db.sh**
  - [x] Backup autom√°tico do PostgreSQL
  - [x] Compress√£o com gzip
  - [x] Rota√ß√£o de backups antigos
  - [x] Logs de backup

- [x] **scripts/cleanup_containers.sh**
  - [x] Remove containers parados
  - [x] Remove volumes √≥rf√£os
  - [x] Limpa imagens n√£o utilizadas

### ‚úÖ Permiss√µes

- [x] Todos os scripts com permiss√£o de execu√ß√£o
  ```bash
  chmod +x scripts/*.sh
  ```

---

## üìù Fase 0.9 - Documenta√ß√£o

### ‚úÖ Documentos Criados

- [x] **README.md** principal
  - [x] Vis√£o geral do projeto
  - [x] Arquitetura t√©cnica
  - [x] Stack tecnol√≥gico
  - [x] Quick start
  - [x] Links para documenta√ß√£o modular

- [x] **docs/modulo0_ambiente.md**
  - [x] Guia completo de instala√ß√£o
  - [x] Configura√ß√£o do Podman
  - [x] Cria√ß√£o de rede e volumes
  - [x] Setup dos 3 containers
  - [x] Scripts de automa√ß√£o
  - [x] Troubleshooting

### ‚úÖ Qualidade da Documenta√ß√£o

- [x] Todos os comandos testados
- [x] Exemplos funcionais inclu√≠dos
- [x] Screenshots/diagramas (quando aplic√°vel)
- [x] Se√ß√£o de troubleshooting completa
- [x] Links para documenta√ß√£o oficial

---

## üß™ Fase 0.10 - Testes e Valida√ß√£o

### ‚úÖ Testes de Conectividade

- [x] **PostgreSQL acess√≠vel**
  ```bash
  podman exec exitus-db pg_isready -U exitus
  # Resultado: /var/run/postgresql:5432 - accepting connections
  ```

- [x] **Backend conecta no PostgreSQL**
  ```bash
  podman exec exitus-backend ping -c 3 exitus-db
  # Resultado: 3 packets transmitted, 3 received
  ```

- [x] **Frontend conecta no Backend**
  ```bash
  podman exec exitus-frontend curl http://exitus-backend:5000/health
  # Resultado: {"status": "ok", "service": "exitus-backend"}
  ```

### ‚úÖ Testes de Persist√™ncia

- [x] Dados persistem ap√≥s restart do container
- [x] Volume PostgreSQL mant√©m dados
- [x] Backup e restore funcionam

### ‚úÖ Testes de Rede

- [x] Resolu√ß√£o DNS interna funciona
- [x] Portas expostas acess√≠veis do host
- [x] Isolamento de rede validado

---

## üìä Estat√≠sticas do M√≥dulo 0

### Arquivos Criados

- **Diret√≥rios**: 10+
- **Arquivos de configura√ß√£o**: 15+
- **Scripts de automa√ß√£o**: 6
- **Dockerfiles**: 2
- **Documenta√ß√£o**: 2 arquivos principais

### Containers Configurados

- **PostgreSQL**: 1 container (database)
- **Backend**: 1 container (API REST)
- **Frontend**: 1 container (UI)
- **Total**: 3 containers

### Recursos de Infraestrutura

- **Redes**: 1 (exitus-network)
- **Volumes**: 1+ (exitus-db-data + bind mounts)
- **Imagens constru√≠das**: 2 (backend, frontend)

---

## üéØ Objetivos Alcan√ßados

### Infraestrutura

- [x] Ambiente de desenvolvimento containerizado
- [x] Arquitetura de 3 camadas isoladas
- [x] Comunica√ß√£o inter-container funcional
- [x] Persist√™ncia de dados garantida
- [x] Scripts de automa√ß√£o funcionais

### Qualidade

- [x] Estrutura organizada e escal√°vel
- [x] Configura√ß√£o via vari√°veis de ambiente
- [x] Separa√ß√£o de responsabilidades
- [x] Documenta√ß√£o completa
- [x] Pronto para desenvolvimento

### DevOps

- [x] Podman configurado e funcional
- [x] Hot reload habilitado (desenvolvimento)
- [x] Logs acess√≠veis
- [x] Backups automatizados
- [x] Scripts de gerenciamento

---

## üì¶ Tecnologias Configuradas

### Containeriza√ß√£o

- **Podman**: 4.x+ (rootless)
- **Network**: Bridge customizada
- **Storage**: Volumes persistentes

### Base Images

- **PostgreSQL**: 15 (alpine)
- **Python**: 3.11-slim
- **Sistema**: Ubuntu 22.04 LTS (host)

---

## üöÄ Pr√≥ximos Passos - M√≥dulo 1

### Prepara√ß√£o para M√≥dulo 1

O M√≥dulo 0 estabeleceu a infraestrutura. O M√≥dulo 1 focar√° em:

- [ ] Modelagem completa do banco de dados (12 entidades)
- [ ] Migrations com Alembic
- [ ] Schema SQL otimizado
- [ ] Seeds de dados iniciais
- [ ] √çndices e constraints
- [ ] Documenta√ß√£o: `docs/modulo1_database.md`

### Valida√ß√µes Antes de Prosseguir

- [x] Todos os 3 containers iniciam corretamente
- [x] PostgreSQL aceita conex√µes
- [x] Backend acessa o banco
- [x] Frontend acessa o backend
- [x] Scripts de automa√ß√£o funcionam
- [x] Documenta√ß√£o completa e testada

---

## üìù Notas Finais

### Decis√µes T√©cnicas

- **Podman vs Docker**: Escolhido por seguran√ßa (rootless) e compatibilidade
- **3 Containers**: Separa√ß√£o clara de responsabilidades
- **Bridge Network**: Isolamento e comunica√ß√£o eficiente
- **Volumes Named**: Melhor portabilidade que bind mounts para produ√ß√£o

### Li√ß√µes Aprendidas

1. **Podman** √© leve e seguro para desenvolvimento local
2. **Rede customizada** facilita comunica√ß√£o entre containers
3. **Scripts de automa√ß√£o** economizam tempo
4. **Documenta√ß√£o desde o in√≠cio** √© essencial
5. **Estrutura organizada** facilita manuten√ß√£o

### Melhorias Futuras

- [ ] Docker Compose / Podman Compose (para simplificar)
- [ ] Health checks autom√°ticos nos containers
- [ ] Monitoramento de recursos (CPU, mem√≥ria)
- [ ] SSL/TLS para comunica√ß√£o local
- [ ] Secrets management (Vault)

---

## ‚úÖ Aprova√ß√£o Final

**Status do M√≥dulo 0**: ‚úÖ **CONCLU√çDO E APROVADO**

- Infraestrutura completa e funcional
- Todos os containers operacionais
- Comunica√ß√£o inter-container validada
- Documenta√ß√£o completa
- Scripts de automa√ß√£o testados
- Pronto para iniciar desenvolvimento (M√≥dulo 1)

**Respons√°vel**: Equipe Exitus  
**Data**: Novembro 2025  
**Pr√≥ximo M√≥dulo**: M√≥dulo 1 - Database Backend üöÄ

---

**Comandos √öteis de Refer√™ncia**:

```bash
# Iniciar servi√ßos
./scripts/start_services.sh

# Parar servi√ßos
./scripts/stop_services.sh

# Ver logs
podman logs exitus-db
podman logs exitus-backend
podman logs exitus-frontend

# Backup
./scripts/backup_db.sh

# Limpeza
./scripts/cleanup_containers.sh
```

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/MODULO1_CHECKLIST.md ---
# ‚úÖ Checklist de Conclus√£o - M√≥dulo 1

**Projeto**: Exitus - Sistema de Controle e An√°lise de Investimentos  
**M√≥dulo**: 1 - Database Backend (PostgreSQL)  
**Data de Conclus√£o**: Novembro 2025  
**Status**: ‚úÖ **CONCLU√çDO COM SUCESSO**

---

## üìã Vis√£o Geral

O M√≥dulo 1 estabeleceu a **camada de dados completa** do sistema Exitus, incluindo:
- Modelagem de 12 entidades principais
- Schema SQL otimizado com 86 √≠ndices
- 11 enums personalizados para valida√ß√£o
- 15 foreign keys com integridade referencial
- Migrations gerenciadas com Alembic
- Seeds de dados iniciais (72 registros)
- Scripts de valida√ß√£o automatizados

---

## üóÑÔ∏è Fase 1.1 - Modelagem do Banco de Dados

### ‚úÖ Entidades Criadas (12 Models)

- [x] **Usuario** (`app/models/usuario.py`)
  - [x] Campos: id (UUID), username, email, password_hash, nome_completo
  - [x] Enum: UserRole (ADMIN, USER, READONLY)
  - [x] Constraints: username unique, email unique
  - [x] M√©todos: set_password(), check_password()

- [x] **Corretora** (`app/models/corretora.py`)
  - [x] Campos: id, usuario_id (FK), nome, tipo, pais, moeda_padrao, saldo_atual
  - [x] Enum: TipoCorretora (CORRETORA, EXCHANGE)
  - [x] Constraints: unique (usuario_id, nome, pais)
  - [x] Relacionamento: Usuario (many-to-one)

- [x] **Ativo** (`app/models/ativo.py`)
  - [x] Campos: id, ticker, nome, tipo, classe, mercado, moeda
  - [x] Enums: TipoAtivo (ACAO, FII, REIT, BOND, ETF, CRIPTO, OUTRO)
  - [x] Enums: ClasseAtivo (RENDA_VARIAVEL, RENDA_FIXA, CRIPTO, HIBRIDO)
  - [x] Campos anal√≠ticos: preco_atual, dividend_yield, p_l, p_vp, roe
  - [x] Constraints: unique (ticker, mercado)

- [x] **Posicao** (`app/models/posicao.py`)
  - [x] Campos: id, usuario_id (FK), corretora_id (FK), ativo_id (FK)
  - [x] Campos financeiros: quantidade, preco_medio, valor_investido, valor_atual
  - [x] Campos calculados: lucro_prejuizo, percentual_lucro
  - [x] Timestamps: data_primeira_compra, data_ultima_atualizacao

- [x] **Transacao** (`app/models/transacao.py`)
  - [x] Campos: id, usuario_id (FK), ativo_id (FK), corretora_id (FK)
  - [x] Enum: TipoTransacao (COMPRA, VENDA, DIVIDENDO, JCP, etc - 10 tipos)
  - [x] Campos financeiros: quantidade, preco_unitario, valor_total, custos
  - [x] Campos de custo: taxa_corretagem, emolumentos, taxa_liquidacao, imposto
  - [x] Constraints: quantidade > 0, preco > 0

- [x] **Provento** (`app/models/provento.py`)
  - [x] Campos: id, ativo_id (FK), tipo_provento
  - [x] Enum: TipoProvento (DIVIDENDO, JCP, RENDIMENTO, CUPOM, BONIFICACAO, etc)
  - [x] Campos financeiros: valor_por_acao, quantidade_ativos, valor_bruto, valor_liquido
  - [x] Datas: data_com, data_pagamento
  - [x] Constraints: valor_liquido <= valor_bruto

- [x] **MovimentacaoCaixa** (`app/models/movimentacao_caixa.py`)
  - [x] Campos: id, usuario_id (FK), corretora_id (FK), corretora_destino_id (FK)
  - [x] Enum: TipoMovimentacao (DEPOSITO, SAQUE, TRANSFERENCIA, CREDITO_PROVENTO, etc)
  - [x] Campos: valor, moeda, data_movimentacao, descricao
  - [x] Relacionamento: provento_id (FK) para cr√©dito de proventos

- [x] **EventoCorporativo** (`app/models/evento_corporativo.py`)
  - [x] Campos: id, ativo_id (FK), ativo_novo_id (FK), tipo_evento
  - [x] Enum: TipoEventoCorporativo (SPLIT, GRUPAMENTO, BONIFICACAO, FUSAO, etc - 12 tipos)
  - [x] Campos: data_evento, data_com, proporcao, descricao
  - [x] Flag: impacto_posicoes (para tracking de ajustes)

- [x] **FonteDados** (`app/models/fonte_dados.py`)
  - [x] Campos: id, nome, tipo_fonte, url_base, requer_autenticacao
  - [x] Enum: TipoFonteDados (API, SCRAPER, MANUAL, ARQUIVO, OUTRO)
  - [x] Monitoramento: rate_limit, ultima_consulta, total_consultas, total_erros
  - [x] Constraints: nome unique, prioridade > 0

- [x] **RegraFiscal** (`app/models/regra_fiscal.py`)
  - [x] Campos: id, pais, tipo_ativo, tipo_operacao, aliquota_ir
  - [x] Enum: IncidenciaImposto (LUCRO, RECEITA, PROVENTO, OPERACAO)
  - [x] Campos: valor_isencao, vigencia_inicio, vigencia_fim
  - [x] Constraints: aliquota entre 0 e 100, pais formato ISO

- [x] **FeriadoMercado** (`app/models/feriado_mercado.py`)
  - [x] Campos: id, pais, mercado, data_feriado, nome
  - [x] Enum: TipoFeriado (NACIONAL, BOLSA, PONTE, FECHAMENTO_ANTECIPADO, etc)
  - [x] Campos: horario_fechamento, recorrente
  - [x] Constraints: unique (pais, mercado, data_feriado)

- [x] **LogAuditoria** (`app/models/log_auditoria.py`)
  - [x] Campos: id, usuario_id (FK), acao, entidade, entidade_id
  - [x] Campos JSON: dados_antes, dados_depois
  - [x] Metadados: ip_address, user_agent, timestamp
  - [x] Flag: sucesso (para tracking de falhas)

---

## üîß Fase 1.2 - Configura√ß√£o do SQLAlchemy

### ‚úÖ Arquivos de Configura√ß√£o

- [x] **app/database.py**
  - [x] Inicializa√ß√£o do SQLAlchemy
  - [x] Configura√ß√£o do Migrate
  - [x] Fun√ß√£o init_db(app)
  - [x] Importa√ß√£o de todos os models

- [x] **app/config.py**
  - [x] Configura√ß√£o de DATABASE_URI
  - [x] Vari√°veis de ambiente (.env)
  - [x] SQLALCHEMY_TRACK_MODIFICATIONS = False

### ‚úÖ Enums Personalizados (11 enums)

- [x] UserRole (3 valores)
- [x] TipoCorretora (2 valores)
- [x] TipoAtivo (7 valores)
- [x] ClasseAtivo (4 valores)
- [x] TipoTransacao (10 valores)
- [x] TipoProvento (7 valores)
- [x] TipoMovimentacao (9 valores)
- [x] TipoEventoCorporativo (12 valores)
- [x] TipoFonteDados (5 valores)
- [x] IncidenciaImposto (4 valores)
- [x] TipoFeriado (6 valores)

---

## üîÄ Fase 1.3 - Migrations com Alembic

### ‚úÖ Configura√ß√£o do Alembic

- [x] **alembic.ini** configurado
- [x] **alembic/env.py** atualizado
  - [x] Import da aplica√ß√£o Flask
  - [x] Import de todos os models
  - [x] Configura√ß√£o de metadata
  - [x] Suporte a timezone

### ‚úÖ Migrations Criadas

- [x] **Migration inicial** (b2542b2f7857)
  - [x] Cria√ß√£o de 12 tabelas
  - [x] Defini√ß√£o de 11 enums
  - [x] Cria√ß√£o de 86 √≠ndices
  - [x] Defini√ß√£o de 15 foreign keys
  - [x] Constraints de valida√ß√£o

### ‚úÖ Comandos Executados

```bash
# Gerar migration inicial
alembic revision --autogenerate -m "Initial schema - 12 models"

# Aplicar migration
alembic upgrade head

# Verificar vers√£o atual
alembic current

# Ver hist√≥rico
alembic history
```

---

## üìä Fase 1.4 - √çndices e Otimiza√ß√µes

### ‚úÖ √çndices Criados (86 total)

**Usuario** (2 √≠ndices):
- [x] ix_usuario_username (unique)
- [x] ix_usuario_email (unique)

**Corretora** (6 √≠ndices):
- [x] ix_corretora_usuario_id
- [x] ix_corretora_nome
- [x] ix_corretora_tipo
- [x] ix_corretora_pais
- [x] ix_corretora_moeda_padrao
- [x] ix_corretora_ativa

**Ativo** (9 √≠ndices):
- [x] ix_ativo_ticker
- [x] ix_ativo_nome
- [x] ix_ativo_tipo
- [x] ix_ativo_classe
- [x] ix_ativo_mercado
- [x] ix_ativo_moeda
- [x] ix_ativo_ativo
- [x] ix_ativo_deslistado
- [x] ix_ativo_data_ultima_cotacao

**Posicao** (5 √≠ndices):
- [x] ix_posicao_usuario_id
- [x] ix_posicao_corretora_id
- [x] ix_posicao_ativo_id
- [x] ix_posicao_data_primeira_compra
- [x] ix_posicao_data_ultima_atualizacao

**Transacao** (6 √≠ndices):
- [x] ix_transacao_usuario_id
- [x] ix_transacao_ativo_id
- [x] ix_transacao_corretora_id
- [x] ix_transacao_tipo_operacao
- [x] ix_transacao_data_operacao
- [x] ix_transacao_data_liquidacao

**Provento** (4 √≠ndices):
- [x] ix_provento_ativo_id
- [x] ix_provento_tipo_provento
- [x] ix_provento_data_com
- [x] ix_provento_data_pagamento

**MovimentacaoCaixa** (7 √≠ndices):
- [x] ix_movimentacao_caixa_usuario_id
- [x] ix_movimentacao_caixa_corretora_id
- [x] ix_movimentacao_caixa_corretora_destino_id
- [x] ix_movimentacao_caixa_provento_id
- [x] ix_movimentacao_caixa_tipo_movimentacao
- [x] ix_movimentacao_caixa_moeda
- [x] ix_movimentacao_caixa_data_movimentacao

**EventoCorporativo** (6 √≠ndices):
- [x] ix_evento_corporativo_ativo_id
- [x] ix_evento_corporativo_ativo_novo_id
- [x] ix_evento_corporativo_tipo_evento
- [x] ix_evento_corporativo_data_evento
- [x] ix_evento_corporativo_data_com
- [x] ix_evento_corporativo_impacto_posicoes

**FonteDados** (5 √≠ndices):
- [x] ix_fonte_dados_nome (unique)
- [x] ix_fonte_dados_tipo_fonte
- [x] ix_fonte_dados_ativa
- [x] ix_fonte_dados_prioridade
- [x] ix_fonte_dados_ultima_consulta

**RegraFiscal** (7 √≠ndices):
- [x] ix_regra_fiscal_pais
- [x] ix_regra_fiscal_tipo_ativo
- [x] ix_regra_fiscal_tipo_operacao
- [x] ix_regra_fiscal_incide_sobre
- [x] ix_regra_fiscal_vigencia_inicio
- [x] ix_regra_fiscal_vigencia_fim
- [x] ix_regra_fiscal_ativa

**FeriadoMercado** (5 √≠ndices):
- [x] ix_feriado_mercado_pais
- [x] ix_feriado_mercado_mercado
- [x] ix_feriado_mercado_data_feriado
- [x] ix_feriado_mercado_tipo_feriado
- [x] ix_feriado_mercado_recorrente

**LogAuditoria** (7 √≠ndices):
- [x] ix_log_auditoria_usuario_id
- [x] ix_log_auditoria_acao
- [x] ix_log_auditoria_entidade
- [x] ix_log_auditoria_entidade_id
- [x] ix_log_auditoria_timestamp
- [x] ix_log_auditoria_sucesso
- [x] ix_log_auditoria_ip_address

---

## üîó Fase 1.5 - Foreign Keys e Integridade

### ‚úÖ Foreign Keys Criadas (15 total)

**Relacionamentos Usuario**:
- [x] corretora.usuario_id ‚Üí usuario.id (CASCADE)
- [x] posicao.usuario_id ‚Üí usuario.id (CASCADE)
- [x] transacao.usuario_id ‚Üí usuario.id (CASCADE)
- [x] movimentacao_caixa.usuario_id ‚Üí usuario.id (CASCADE)
- [x] log_auditoria.usuario_id ‚Üí usuario.id (SET NULL)

**Relacionamentos Corretora**:
- [x] posicao.corretora_id ‚Üí corretora.id (CASCADE)
- [x] transacao.corretora_id ‚Üí corretora.id (CASCADE)
- [x] movimentacao_caixa.corretora_id ‚Üí corretora.id (CASCADE)
- [x] movimentacao_caixa.corretora_destino_id ‚Üí corretora.id (SET NULL)

**Relacionamentos Ativo**:
- [x] posicao.ativo_id ‚Üí ativo.id (RESTRICT)
- [x] transacao.ativo_id ‚Üí ativo.id (RESTRICT)
- [x] provento.ativo_id ‚Üí ativo.id (RESTRICT)
- [x] evento_corporativo.ativo_id ‚Üí ativo.id (RESTRICT)
- [x] evento_corporativo.ativo_novo_id ‚Üí ativo.id (SET NULL)

**Relacionamento Provento**:
- [x] movimentacao_caixa.provento_id ‚Üí provento.id (SET NULL)

### ‚úÖ Pol√≠ticas de Dele√ß√£o

- **CASCADE**: Deleta registros dependentes (usuario ‚Üí transacoes)
- **RESTRICT**: Impede dele√ß√£o se h√° dependentes (ativo ‚Üí transacoes)
- **SET NULL**: Mant√©m registro mas remove refer√™ncia

---

## üå± Fase 1.6 - Seeds de Dados Iniciais

### ‚úÖ Scripts de Seeds Criados

- [x] **app/seeds/seed_usuarios.py**
  - [x] 4 usu√°rios criados
  - [x] 1 ADMIN (admin/admin123)
  - [x] 2 USER (joao.silva, maria.santos)
  - [x] 1 READONLY (viewer/viewer123)

- [x] **app/seeds/seed_ativos_br.py**
  - [x] 25 ativos brasileiros
  - [x] 15 a√ß√µes (PETR4, VALE3, ITUB4, etc)
  - [x] 10 FIIs (HGLG11, MXRF11, VISC11, etc)
  - [x] Dados completos: ticker, nome, tipo, classe, mercado

- [x] **app/seeds/seed_regras_fiscais_br.py**
  - [x] 6 regras fiscais brasileiras
  - [x] A√ß√µes: swing trade (15%), day trade (20%)
  - [x] FIIs: isen√ß√£o at√© R$ 20.000/m√™s
  - [x] Dividendos: isen√ß√£o
  - [x] JCP: 15% de IR retido na fonte

- [x] **app/seeds/seed_feriados_b3.py**
  - [x] 30 feriados da B3 (2025-2026)
  - [x] Feriados nacionais
  - [x] Pontes e fechamentos antecipados
  - [x] Marcados como recorrentes quando aplic√°vel

- [x] **app/seeds/seed_fontes_dados.py**
  - [x] 7 fontes de dados configuradas
  - [x] APIs: yfinance, Alpha Vantage, Finnhub, brapi.dev
  - [x] Prioridades definidas
  - [x] Rate limits configurados

- [x] **app/seeds/run_all_seeds.py**
  - [x] Executa todos os seeds em ordem
  - [x] Tratamento de erros
  - [x] Logs informativos

### ‚úÖ Dados Populados (72 registros)

- **Usu√°rios**: 4
- **Ativos**: 25
- **Regras Fiscais**: 6
- **Feriados**: 30
- **Fontes de Dados**: 7

### ‚úÖ Comando de Execu√ß√£o

```bash
# Executar todos os seeds
podman exec -it exitus-backend python -m app.seeds.run_all_seeds

# Ou executar individualmente
python -m app.seeds.seed_usuarios
python -m app.seeds.seed_ativos_br
python -m app.seeds.seed_regras_fiscais_br
python -m app.seeds.seed_feriados_b3
python -m app.seeds.seed_fontes_dados
```

---

## ‚úÖ Fase 1.7 - Constraints e Valida√ß√µes

### ‚úÖ Check Constraints Implementadas

**Usuario**:
- [x] password_hash n√£o nulo
- [x] email formato v√°lido (via Marshmallow)

**Corretora**:
- [x] pais formato ISO (^[A-Z]{2}$)
- [x] moeda_padrao formato ISO (^[A-Z]{3}$)
- [x] saldo_atual >= 0
- [x] nome >= 2 caracteres

**Ativo**:
- [x] ticker >= 1 caractere
- [x] nome >= 2 caracteres
- [x] preco_atual >= 0 (ou NULL)

**Transacao**:
- [x] quantidade > 0
- [x] preco_unitario > 0
- [x] valor_total > 0
- [x] Todas as taxas >= 0

**Provento**:
- [x] valor_por_acao > 0
- [x] quantidade_ativos > 0
- [x] valor_bruto > 0
- [x] valor_liquido > 0
- [x] valor_liquido <= valor_bruto
- [x] imposto_retido >= 0
- [x] data_pagamento >= data_com

**MovimentacaoCaixa**:
- [x] valor > 0
- [x] moeda formato ISO (^[A-Z]{3}$)

**EventoCorporativo**:
- [x] data_com <= data_evento (quando aplic√°vel)

**FonteDados**:
- [x] nome >= 2 caracteres
- [x] prioridade > 0
- [x] total_consultas >= 0
- [x] total_erros >= 0

**RegraFiscal**:
- [x] pais formato ISO (^[A-Z]{2}$)
- [x] aliquota_ir entre 0 e 100
- [x] valor_isencao >= 0 (ou NULL)
- [x] vigencia_fim >= vigencia_inicio (quando aplic√°vel)

**FeriadoMercado**:
- [x] pais formato ISO (^[A-Z]{2}$)
- [x] nome >= 3 caracteres

**LogAuditoria**:
- [x] acao >= 3 caracteres

---

## üß™ Fase 1.8 - Testes e Valida√ß√£o

### ‚úÖ Scripts de Valida√ß√£o Criados

- [x] **tests/mod1_validacao_final_fase1.sh**
  - [x] Valida cria√ß√£o de tabelas
  - [x] Conta n√∫mero de tabelas (13 esperadas)

- [x] **tests/mod1_validacao_final_fase2.sh**
  - [x] Valida enums criados (11 esperados)
  - [x] Valida valores dos enums

- [x] **tests/mod1_validacao_final_fase3.sh**
  - [x] Valida √≠ndices criados (86 esperados)
  - [x] Lista todos os √≠ndices

- [x] **tests/mod1_validacao_final_fase4.sh**
  - [x] Valida foreign keys (15 esperadas)
  - [x] Verifica integridade referencial

- [x] **tests/mod1_validacao_final_fase5.sh**
  - [x] Valida seeds executados
  - [x] Conta registros em cada tabela
  - [x] Verifica usu√°rio admin criado

### ‚úÖ Resultados dos Testes

```bash
# Executar todos os testes
./tests/mod1_validacao_final_fase1.sh  # ‚úÖ 13 tabelas
./tests/mod1_validacao_final_fase2.sh  # ‚úÖ 11 enums
./tests/mod1_validacao_final_fase3.sh  # ‚úÖ 86 √≠ndices
./tests/mod1_validacao_final_fase4.sh  # ‚úÖ 15 foreign keys
./tests/mod1_validacao_final_fase5.sh  # ‚úÖ 72 registros
```

### ‚úÖ Testes Manuais Realizados

- [x] Inser√ß√£o de dados v√°lidos
- [x] Viola√ß√£o de constraints (testado e rejeitado)
- [x] Dele√ß√£o em cascata (CASCADE)
- [x] Prote√ß√£o de dele√ß√£o (RESTRICT)
- [x] Atualiza√ß√£o de timestamps (updated_at)
- [x] Valida√ß√£o de enums
- [x] Verifica√ß√£o de √≠ndices (EXPLAIN)

---

## üìä Estat√≠sticas do M√≥dulo 1

### Schema Completo

- **Tabelas criadas**: 13 (12 entidades + alembic_version)
- **Enums personalizados**: 11
- **√çndices totais**: 86
- **Foreign keys**: 15
- **Check constraints**: 30+
- **Unique constraints**: 8

### Dados Iniciais

- **Seeds executados**: 5
- **Registros criados**: 72
  - Usu√°rios: 4
  - Ativos: 25
  - Regras Fiscais: 6
  - Feriados: 30
  - Fontes de Dados: 7

### Arquivos Criados

- **Models**: 12 arquivos
- **Seeds**: 6 arquivos
- **Migrations**: 1 migration inicial
- **Scripts de valida√ß√£o**: 5
- **Documenta√ß√£o**: 1 arquivo (modulo1_database.md)

---

## üéØ Objetivos Alcan√ßados

### Modelagem

- [x] 12 entidades financeiras modeladas
- [x] Relacionamentos complexos implementados
- [x] Enums para valida√ß√£o de dom√≠nio
- [x] Campos calculados (lucro, percentuais)
- [x] Suporte a multi-moeda
- [x] Suporte a multi-mercado
- [x] Auditoria completa (logs)

### Performance

- [x] 86 √≠ndices para otimiza√ß√£o
- [x] Foreign keys com pol√≠ticas adequadas
- [x] Constraints para integridade
- [x] Timestamps autom√°ticos
- [x] UUIDs como chaves prim√°rias

### Qualidade

- [x] C√≥digo comentado (docstrings)
- [x] Migrations versionadas
- [x] Seeds replic√°veis
- [x] Testes de valida√ß√£o
- [x] Documenta√ß√£o completa

---

## üì¶ Tecnologias Utilizadas

### ORM e Database

- **SQLAlchemy**: 2.x (ORM moderno)
- **Alembic**: 1.13+ (migrations)
- **PostgreSQL**: 15 (database)
- **psycopg2-binary**: 2.9.9 (driver)

### Python

- **Python**: 3.11+
- **UUID**: Para chaves prim√°rias
- **Datetime**: Com timezone awareness
- **Decimal**: Para precis√£o financeira

---

## üöÄ Pr√≥ximos Passos - M√≥dulo 2

### Prepara√ß√£o para M√≥dulo 2

O M√≥dulo 1 estabeleceu a base de dados. O M√≥dulo 2 focar√° em:

- [ ] API REST com Flask
- [ ] Autentica√ß√£o JWT
- [ ] CRUD completo para todas as entidades
- [ ] Valida√ß√£o com Marshmallow
- [ ] Serializa√ß√£o de dados
- [ ] Endpoints protegidos por role
- [ ] Documenta√ß√£o: `docs/modulo2_backend_auth.md`

### Valida√ß√µes Antes de Prosseguir

- [x] Schema completo criado (13 tabelas)
- [x] Migrations aplicadas com sucesso
- [x] Seeds executados (72 registros)
- [x] √çndices otimizados (86 total)
- [x] Foreign keys funcionando (15 total)
- [x] Constraints validando dados
- [x] Testes de valida√ß√£o passando 100%

---

## üìù Notas Finais

### Decis√µes T√©cnicas

- **UUID como PK**: Melhor para sistemas distribu√≠dos e seguran√ßa
- **Enums**: Valida√ß√£o no n√≠vel de banco + aplica√ß√£o
- **Decimal**: Precis√£o para valores monet√°rios (n√£o usar Float)
- **Timezone-aware**: Timestamps com timezone (DateTime(timezone=True))
- **Soft delete**: N√£o implementado (usar flags "ativo" quando necess√°rio)

### Li√ß√µes Aprendidas

1. **Planejamento antecipado** economiza refatora√ß√µes futuras
2. **√çndices corretos** s√£o cruciais para performance
3. **Foreign keys** garantem integridade referencial
4. **Enums** reduzem erros de digita√ß√£o
5. **Seeds** facilitam testes e desenvolvimento

### Melhorias Futuras

- [ ] Particionamento de tabelas grandes (transacao, log_auditoria)
- [ ] √çndices parciais para queries espec√≠ficas
- [ ] Materialized views para relat√≥rios
- [ ] Triggers para c√°lculos autom√°ticos
- [ ] Full-text search para busca de ativos
- [ ] Archived tables para dados hist√≥ricos

---

## ‚úÖ Aprova√ß√£o Final

**Status do M√≥dulo 1**: ‚úÖ **CONCLU√çDO E APROVADO**

- Schema completo e otimizado
- Todas as tabelas criadas com sucesso
- Migrations aplicadas e versionadas
- Seeds executados (72 registros)
- Testes de valida√ß√£o 100% aprovados
- Documenta√ß√£o completa
- Pronto para iniciar desenvolvimento da API (M√≥dulo 2)

**Respons√°vel**: Equipe Exitus  
**Data**: Novembro 2025  
**Pr√≥ximo M√≥dulo**: M√≥dulo 2 - Backend API REST üöÄ

---

**Comandos √öteis de Refer√™ncia**:

```bash
# Ver tabelas criadas
podman exec exitus-db psql -U exitus -d exitusdb -c "\dt"

# Contar registros
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT COUNT(*) FROM usuario;"

# Ver enums
podman exec exitus-db psql -U exitus -d exitusdb -c "\dT+"

# Executar seeds
podman exec exitus-backend python -m app.seeds.run_all_seeds

# Ver hist√≥rico de migrations
podman exec exitus-backend alembic history

# Vers√£o atual do schema
podman exec exitus-backend alembic current
```

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/MODULO2_CHECKLIST.md ---
# ‚úÖ Checklist de Conclus√£o - M√≥dulo 2

**Projeto**: Exitus - Sistema de Controle e An√°lise de Investimentos  
**M√≥dulo**: 2 - API REST CRUD  
**Data de Conclus√£o**: 02/12/2025  
**Status**: ‚úÖ **CONCLU√çDO COM SUCESSO**

---

## üìã Vis√£o Geral

O M√≥dulo 2 implementou a **camada completa de API REST** do sistema Exitus, incluindo:
- Autentica√ß√£o JWT
- CRUD de 4 entidades principais (Usu√°rios, Corretoras, Ativos, Transa√ß√µes)
- 30+ endpoints funcionais
- Valida√ß√£o com Marshmallow
- Service Layer com l√≥gica de neg√≥cio
- Testes completos para todos os endpoints

---

## üéØ Fase 2.1 - Autentica√ß√£o JWT

### ‚úÖ Implementa√ß√£o

- [x] **JWT Configuration**
  - [x] Instala√ß√£o: `Flask-JWT-Extended==4.6.0`
  - [x] Configura√ß√£o em `config.py`
  - [x] Secret key e tempos de expira√ß√£o definidos
  - [x] Integration no `__init__.py`

- [x] **AuthService** (`app/services/auth_service.py`)
  - [x] M√©todo `login(username, password)`
  - [x] Verifica√ß√£o de senha com bcrypt
  - [x] Gera√ß√£o de access_token (1 hora)
  - [x] Gera√ß√£o de refresh_token (30 dias)
  - [x] M√©todo `refresh(identity)`

- [x] **AuthSchema** (`app/schemas/auth_schema.py`)
  - [x] `LoginSchema` com valida√ß√£o
  - [x] `TokenResponseSchema`
  - [x] `UserMeSchema`

- [x] **Blueprint Auth** (`app/blueprints/auth/routes.py`)
  - [x] `POST /api/auth/login` - Login
  - [x] `POST /api/auth/refresh` - Renovar token
  - [x] `GET /api/auth/me` - Dados do usu√°rio
  - [x] `POST /api/auth/logout` - Logout

- [x] **Decorators de Autoriza√ß√£o** (`app/utils/decorators.py`)
  - [x] `@admin_required` - Apenas ADMIN
  - [x] `@role_required(['ADMIN', 'USER'])` - Lista de roles
  - [x] Verifica√ß√£o de JWT em todas as rotas protegidas

### ‚úÖ Testes

- [x] Login com credenciais v√°lidas
- [x] Login com credenciais inv√°lidas (401)
- [x] Refresh token v√°lido
- [x] Acesso ao endpoint `/me`
- [x] Acesso negado sem token (401)
- [x] Acesso negado com role inadequada (403)

**Arquivo de Teste**: `backend/tests/test_auth.sh`

---

## üë• Fase 2.2.1 - CRUD Usu√°rios

### ‚úÖ Implementa√ß√£o

- [x] **Model Usuario** (`app/models/usuario.py`)
  - [x] Campos: id, username, email, password_hash, nome_completo
  - [x] Enum `UserRole` (ADMIN, USER, READONLY)
  - [x] M√©todos: `set_password()`, `check_password()`
  - [x] Constraints: username unique, email unique

- [x] **Schemas** (`app/schemas/usuario_schema.py`)
  - [x] `UsuarioCreateSchema` - Valida√ß√£o de cria√ß√£o
  - [x] `UsuarioUpdateSchema` - Valida√ß√£o de atualiza√ß√£o
  - [x] `UsuarioResponseSchema` - Serializa√ß√£o de resposta
  - [x] `ChangePasswordSchema` - Troca de senha
  - [x] Valida√ß√µes: email v√°lido, senha m√≠nimo 6 chars

- [x] **Service** (`app/services/usuario_service.py`)
  - [x] `get_all(page, per_page, filters)` - Listagem paginada
  - [x] `get_by_id(id)` - Busca por ID
  - [x] `create(data)` - Cria√ß√£o com hash de senha
  - [x] `update(id, data)` - Atualiza√ß√£o
  - [x] `delete(id)` - Dele√ß√£o
  - [x] `change_password(id, current, new)` - Troca de senha

- [x] **Blueprint** (`app/blueprints/usuarios/routes.py`)
  - [x] `GET /api/usuarios` - Listar (ADMIN)
  - [x] `GET /api/usuarios/{id}` - Buscar por ID
  - [x] `POST /api/usuarios` - Criar (p√∫blico)
  - [x] `PUT /api/usuarios/{id}` - Atualizar
  - [x] `DELETE /api/usuarios/{id}` - Deletar (ADMIN)
  - [x] `PATCH /api/usuarios/{id}/password` - Trocar senha

- [x] **Filtros e Pagina√ß√£o**
  - [x] `?page=1&per_page=20`
  - [x] `?ativo=true`
  - [x] `?role=USER`
  - [x] `?search=termo`

### ‚úÖ Testes

- [x] Criar usu√°rio (registro)
- [x] Listar usu√°rios (ADMIN)
- [x] Buscar usu√°rio por ID
- [x] Atualizar dados do usu√°rio
- [x] Trocar senha
- [x] Deletar usu√°rio (ADMIN)
- [x] Valida√ß√£o de email duplicado
- [x] Valida√ß√£o de username duplicado
- [x] Controle de acesso (pr√≥prio usu√°rio ou ADMIN)

**Arquivo de Teste**: `backend/tests/test_usuarios_crud.sh`

---

## üè¶ Fase 2.2.2 - CRUD Corretoras

### ‚úÖ Implementa√ß√£o

- [x] **Model Corretora** (`app/models/corretora.py`)
  - [x] Campos: id, usuario_id (FK), nome, tipo, pais, moeda_padrao
  - [x] Enum `TipoCorretora` (CORRETORA, EXCHANGE)
  - [x] Relacionamento: `usuario` (many-to-one)
  - [x] Campo `saldo_atual` (Numeric)

- [x] **Schemas** (`app/schemas/corretora_schema.py`)
  - [x] `CorretoraCreateSchema`
  - [x] `CorretoraUpdateSchema`
  - [x] `CorretoraResponseSchema`
  - [x] Valida√ß√µes: nome obrigat√≥rio, tipo v√°lido

- [x] **Service** (`app/services/corretora_service.py`)
  - [x] `get_all(usuario_id, page, per_page, filters)`
  - [x] `get_by_id(id, usuario_id)` - Isolamento por usu√°rio
  - [x] `create(usuario_id, data)`
  - [x] `update(id, usuario_id, data)`
  - [x] `delete(id, usuario_id)`
  - [x] `get_saldo_total(usuario_id)` - Soma de saldos

- [x] **Blueprint** (`app/blueprints/corretoras/routes.py`)
  - [x] `GET /api/corretoras` - Listar do usu√°rio
  - [x] `GET /api/corretoras/{id}` - Buscar por ID
  - [x] `POST /api/corretoras` - Criar
  - [x] `PUT /api/corretoras/{id}` - Atualizar
  - [x] `DELETE /api/corretoras/{id}` - Deletar
  - [x] `GET /api/corretoras/saldo-total` - Saldo total

- [x] **Filtros e Pagina√ß√£o**
  - [x] `?page=1&per_page=20`
  - [x] `?ativa=true`
  - [x] `?tipo=CORRETORA`
  - [x] `?pais=BR`
  - [x] `?search=XP`

### ‚úÖ Testes

- [x] Criar corretora
- [x] Listar corretoras do usu√°rio
- [x] Buscar corretora por ID
- [x] Atualizar corretora
- [x] Deletar corretora
- [x] Obter saldo total
- [x] Filtros: ativa, tipo, pa√≠s
- [x] Isolamento: usu√°rio n√£o acessa corretora de outro

**Arquivo de Teste**: `backend/tests/test_corretoras_crud.sh`

---

## üìà Fase 2.2.3 - CRUD Ativos

### ‚úÖ Implementa√ß√£o

- [x] **Model Ativo** (`app/models/ativo.py`)
  - [x] Campos: id, ticker, nome, tipo, classe, mercado, moeda
  - [x] Enum `TipoAtivo` (ACAO, FII, REIT, BOND, ETF, CRIPTO)
  - [x] Enum `ClasseAtivo` (RENDA_VARIAVEL, RENDA_FIXA, CRIPTO)
  - [x] Campos anal√≠ticos: preco_atual, dividend_yield, p_l, p_vp, roe
  - [x] Campos de status: ativo, deslistado, data_deslistagem
  - [x] Constraint unique: (ticker, mercado)

- [x] **Schemas** (`app/schemas/ativo_schema.py`)
  - [x] `AtivoCreateSchema` - Valida√ß√£o completa
  - [x] `AtivoUpdateSchema` - Campos opcionais
  - [x] `AtivoResponseSchema` - Serializa√ß√£o
  - [x] Valida√ß√µes: ticker obrigat√≥rio, tipo v√°lido

- [x] **Service** (`app/services/ativo_service.py`)
  - [x] `get_all(page, per_page, filters)` - Global, filtrado
  - [x] `get_by_id(id)` - Busca por UUID
  - [x] `get_by_ticker(ticker, mercado)` - Busca por ticker
  - [x] `create(data)` - ADMIN only
  - [x] `update(id, data)` - ADMIN only
  - [x] `delete(id)` - ADMIN only
  - [x] `get_by_mercado(mercado, page, per_page)` - Filtro por mercado

- [x] **Blueprint** (`app/blueprints/ativos/routes.py`)
  - [x] `GET /api/ativos` - Listar ativos
  - [x] `GET /api/ativos/{id}` - Buscar por ID
  - [x] `GET /api/ativos/ticker/{ticker}?mercado=BR` - Buscar por ticker
  - [x] `POST /api/ativos` - Criar (ADMIN)
  - [x] `PUT /api/ativos/{id}` - Atualizar (ADMIN)
  - [x] `DELETE /api/ativos/{id}` - Deletar (ADMIN)
  - [x] `GET /api/ativos/mercado/{mercado}` - Listar por mercado

- [x] **Filtros e Pagina√ß√£o**
  - [x] `?page=1&per_page=20`
  - [x] `?tipo=ACAO`
  - [x] `?classe=RENDA_VARIAVEL`
  - [x] `?mercado=BR`
  - [x] `?ativo=true`
  - [x] `?deslistado=false`
  - [x] `?search=PETR`

### ‚úÖ Testes

- [x] Listar ativos com pagina√ß√£o
- [x] Buscar ativo por ID
- [x] Buscar ativo por ticker (PETR4, VALE3)
- [x] Criar ativo (ADMIN)
- [x] Atualizar ativo (ADMIN)
- [x] Deletar ativo (ADMIN)
- [x] Listar ativos do mercado BR
- [x] Filtros: tipo, classe, mercado, ativo, deslistado
- [x] Busca textual (search)
- [x] Valida√ß√£o de ticker √∫nico por mercado

**Arquivo de Teste**: `backend/tests/test_ativos_crud.sh`

---

## üíº Fase 2.2.4 - CRUD Transa√ß√µes

### ‚úÖ Implementa√ß√£o

- [x] **Model Transacao** (`app/models/transacao.py`)
  - [x] Campos: id, usuario_id (FK), ativo_id (FK), corretora_id (FK)
  - [x] Enum `TipoTransacao` (COMPRA, VENDA, DIVIDENDO, JCP, etc)
  - [x] Campos financeiros: quantidade, preco_unitario, valor_total
  - [x] Custos: taxa_corretagem, emolumentos, taxa_liquidacao, imposto
  - [x] Campos calculados: custos_totais, valor_liquido
  - [x] Relacionamentos: usuario, ativo, corretora (lazy loaded)

- [x] **Schemas** (`app/schemas/transacao_schema.py`)
  - [x] `TransacaoCreateSchema` - Valida√ß√£o completa
  - [x] `TransacaoUpdateSchema` - Campos opcionais
  - [x] `TransacaoResponseSchema` - Com nested objects (ativo, corretora)
  - [x] Valida√ß√µes: quantidade > 0, preco > 0, datas v√°lidas

- [x] **Service** (`app/services/transacao_service.py`)
  - [x] `get_all(usuario_id, page, per_page, filters)` - Listagem filtrada
  - [x] `get_by_id(id, usuario_id)` - Busca com isolamento
  - [x] `create(usuario_id, data)` - Com c√°lculos autom√°ticos
  - [x] `update(id, usuario_id, data)` - Recalcula valores
  - [x] `delete(id, usuario_id)` - Dele√ß√£o isolada
  - [x] `get_resumo_por_ativo(usuario_id, ativo_id)` - Agrega√ß√µes

- [x] **C√°lculos Autom√°ticos**
  - [x] `valor_total = quantidade √ó preco_unitario`
  - [x] `custos_totais = soma de todas as taxas`
  - [x] `valor_liquido` conforme tipo:
    - [x] COMPRA: `valor_total + custos_totais`
    - [x] VENDA: `valor_total - custos_totais`
    - [x] DIVIDENDO/JCP: `valor_total - imposto`

- [x] **Blueprint** (`app/blueprints/transacoes/routes.py`)
  - [x] `GET /api/transacoes` - Listar transa√ß√µes
  - [x] `GET /api/transacoes/{id}` - Buscar por ID
  - [x] `POST /api/transacoes` - Criar transa√ß√£o
  - [x] `PUT /api/transacoes/{id}` - Atualizar transa√ß√£o
  - [x] `DELETE /api/transacoes/{id}` - Deletar transa√ß√£o
  - [x] `GET /api/transacoes/resumo/{ativo_id}` - Resumo por ativo

- [x] **Filtros e Pagina√ß√£o**
  - [x] `?page=1&per_page=20`
  - [x] `?tipo=COMPRA`
  - [x] `?ativo_id={uuid}`
  - [x] `?corretora_id={uuid}`
  - [x] `?data_inicio=2025-01-01T00:00:00`
  - [x] `?data_fim=2025-12-31T23:59:59`

- [x] **Resumo por Ativo**
  - [x] Quantidade comprada
  - [x] Quantidade vendida
  - [x] Quantidade total (saldo)
  - [x] Pre√ßo m√©dio ponderado
  - [x] Valor investido
  - [x] Valor vendido

### ‚úÖ Testes

- [x] Criar transa√ß√£o COMPRA (PETR4, VALE3)
- [x] Criar transa√ß√£o VENDA
- [x] Criar transa√ß√£o DIVIDENDO
- [x] Listar todas as transa√ß√µes
- [x] Filtrar por tipo (compra, venda)
- [x] Filtrar por ativo
- [x] Filtrar por per√≠odo (data_inicio, data_fim)
- [x] Buscar transa√ß√£o por ID
- [x] Atualizar transa√ß√£o (recalcula autom√°tico)
- [x] Deletar transa√ß√£o
- [x] Obter resumo por ativo (agrega√ß√µes)
- [x] Valida√ß√£o: ativo n√£o encontrado
- [x] Valida√ß√£o: corretora n√£o pertence ao usu√°rio
- [x] C√°lculos corretos de valor_liquido

**Arquivo de Teste**: `backend/tests/test_transacoes_crud.sh` (15 cen√°rios)

---

## üõ†Ô∏è Infraestrutura e Suporte

### ‚úÖ Configura√ß√£o

- [x] **config.py** atualizado com JWT_SECRET_KEY
- [x] **__init__.py** (Application Factory)
  - [x] Registro de blueprints: auth, usuarios, corretoras, ativos, transacoes
  - [x] Configura√ß√£o CORS
  - [x] Inicializa√ß√£o JWT Manager

- [x] **utils/responses.py**
  - [x] `success(data, message, status=200)`
  - [x] `error(message, status=400)`
  - [x] `not_found(message)`
  - [x] `unauthorized(message)`
  - [x] `forbidden(message)`

- [x] **utils/decorators.py**
  - [x] `@admin_required`
  - [x] `@role_required([roles])`

### ‚úÖ Seeds

- [x] **seeds/seed_modulo2.py**
  - [x] 3 usu√°rios (admin, joao.silva, maria.santos)
  - [x] 2 corretoras (XP, Clear)
  - [x] 25 ativos (a√ß√µes BR, FIIs)
  - [x] Execu√ß√£o: `podman exec -it exitus-backend python -m app.seeds.seed_modulo2`

### ‚úÖ Containers

- [x] Backend rodando em `http://localhost:5000`
- [x] PostgreSQL em container `exitus-db`
- [x] Network: `exitus-network`
- [x] Volumes persistentes: `pgdata`, `backend-logs`

---

## üß™ Testes Realizados

### Scripts de Teste

| Arquivo | Endpoints Testados | Status |
|---------|-------------------|--------|
| `test_auth.sh` | Login, Refresh, Me, Logout | ‚úÖ Passou |
| `test_usuarios_crud.sh` | 6 endpoints de usu√°rios | ‚úÖ Passou |
| `test_corretoras_crud.sh` | 6 endpoints de corretoras | ‚úÖ Passou |
| `test_ativos_crud.sh` | 7 endpoints de ativos | ‚úÖ Passou |
| `test_transacoes_crud.sh` | 6 endpoints + resumo (15 cen√°rios) | ‚úÖ Passou |

### Resumo de Cobertura

- **Total de endpoints**: 30+
- **Total de cen√°rios testados**: 40+
- **Taxa de sucesso**: 100% ‚úÖ
- **Erros encontrados**: 0
- **Bugs abertos**: 0

---

## üìä Estat√≠sticas do M√≥dulo 2

### Arquivos Criados/Modificados

- **Models**: 4 (Usuario, Corretora, Ativo, Transacao)
- **Schemas**: 12 (Create, Update, Response para cada entidade)
- **Services**: 5 (auth + 4 entidades)
- **Blueprints**: 5 (auth + 4 entidades)
- **Utils**: 2 (responses, decorators)
- **Seeds**: 1 (seed_modulo2.py)
- **Tests**: 5 scripts bash

### Linhas de C√≥digo

- **Backend total**: ~3.500 linhas (Python)
- **Testes**: ~800 linhas (Bash + JSON)
- **Documenta√ß√£o**: ~1.500 linhas (Markdown)

### Endpoints por Categoria

- **Autentica√ß√£o**: 4 endpoints
- **Usu√°rios**: 6 endpoints
- **Corretoras**: 6 endpoints
- **Ativos**: 7 endpoints
- **Transa√ß√µes**: 6 endpoints
- **Utilit√°rios**: 1 endpoint (health)
- **Total**: 30 endpoints

---

## üéØ Objetivos Alcan√ßados

### Funcionalidades

- [x] Sistema de autentica√ß√£o JWT completo
- [x] CRUD completo para 4 entidades principais
- [x] Filtros avan√ßados e pagina√ß√£o
- [x] Isolamento de dados por usu√°rio
- [x] Controle de acesso baseado em roles
- [x] Valida√ß√£o robusta com Marshmallow
- [x] C√°lculos autom√°ticos (transa√ß√µes)
- [x] Nested objects nas respostas
- [x] Padr√£o de respostas consistente

### Qualidade

- [x] C√≥digo comentado e documentado
- [x] Arquitetura MVC + Service Layer
- [x] Separation of Concerns
- [x] DRY (Don't Repeat Yourself)
- [x] Error handling consistente
- [x] Testes manuais completos
- [x] Seeds para desenvolvimento

### DevOps

- [x] Containeriza√ß√£o com Podman
- [x] Hot reload com Gunicorn
- [x] Vari√°veis de ambiente (.env)
- [x] Logs estruturados
- [x] Health check endpoint

---

## üì¶ Depend√™ncias Utilizadas

```txt
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-JWT-Extended==4.6.0
Flask-CORS==4.0.0
marshmallow==3.20.1
marshmallow-sqlalchemy==1.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
gunicorn==21.2.0
bcrypt==4.1.2
```

---

## üöÄ Pr√≥ximos Passos - M√≥dulo 3

### Planejamento

**M√≥dulo 3 - C√°lculos e An√°lises Financeiras**

Baseado no Prompt Mestre, o M√≥dulo 3 deve implementar:

- [ ] C√°lculo de posi√ß√µes consolidadas (holdings)
- [ ] Pre√ßo m√©dio ponderado por ativo
- [ ] Lucro/Preju√≠zo realizado
- [ ] Lucro/Preju√≠zo n√£o realizado
- [ ] Integra√ß√£o com APIs externas (cota√ß√µes)
- [ ] C√°lculo de indicadores (DY, P/L, P/VP, ROE)
- [ ] Atualiza√ß√£o autom√°tica de pre√ßos
- [ ] Endpoints de relat√≥rios e analytics
- [ ] Dashboard consolidado de portf√≥lio

### Prepara√ß√£o

1. Revisar estrutura de transa√ß√µes ‚úÖ
2. Definir l√≥gica de c√°lculo de posi√ß√µes
3. Integrar com API de cota√ß√µes (yfinance, Alpha Vantage)
4. Criar endpoints de relat√≥rios
5. Implementar cache de cota√ß√µes

---

## üìù Notas Finais

### Decis√µes T√©cnicas

- **JWT**: Escolhido por ser stateless e escal√°vel
- **Marshmallow**: Valida√ß√£o robusta e serializa√ß√£o flex√≠vel
- **Service Layer**: Facilita testes e manuten√ß√£o
- **Podman**: Container leve e rootless
- **PostgreSQL**: ACID, JSON support, performance

### Li√ß√µes Aprendidas

1. **Isolamento de dados** √© cr√≠tico em sistemas multiusu√°rio
2. **C√°lculos autom√°ticos** reduzem erros humanos
3. **Nested objects** melhoram UX do frontend
4. **Testes manuais** s√£o essenciais antes de automatizar
5. **Documenta√ß√£o** economiza tempo no futuro

### Melhorias Futuras

- [ ] Testes automatizados com pytest
- [ ] CI/CD com GitHub Actions
- [ ] Documenta√ß√£o Swagger/OpenAPI
- [ ] Rate limiting
- [ ] Cache (Redis)
- [ ] Logs estruturados (ELK)
- [ ] M√©tricas e monitoramento

---

## ‚úÖ Aprova√ß√£o Final

**Status do M√≥dulo 2**: ‚úÖ **CONCLU√çDO E APROVADO**

- Todos os endpoints funcionando corretamente
- Testes passando 100%
- Documenta√ß√£o completa
- C√≥digo limpo e organizado
- Pronto para produ√ß√£o (MVP)

**Respons√°vel**: Desenvolvedor Exitus  
**Data**: 02/12/2025  
**Assinatura Digital**: `git commit -m "feat: M√≥dulo 2 - API REST CRUD completo"`

---

**Pr√≥ximo M√≥dulo**: M√≥dulo 3 - C√°lculos e An√°lises Financeiras üöÄ

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/MODULO3_CHECKLIST.md ---
# M√ìDULO 3 - CHECKLIST DE IMPLEMENTA√á√ÉO

Sistema Exitus - Entidades Financeiras Avan√ßadas + Analytics de Portf√≥lio

## üìã VIS√ÉO GERAL

**Status:** ‚úÖ Arquivos criados - Aguardando integra√ß√£o  
**Data:** 02/12/2025  
**M√≥dulos:** 5 fases (Posi√ß√µes, Proventos, Movimenta√ß√£o Caixa, Eventos Corporativos, Portfolio)

---

## ‚úÖ FASE 3.1 - POSI√á√ïES (HOLDINGS)

### Arquivos Criados
- [x] `backend/app/services/posicao_service.py`
- [x] `backend/app/schemas/posicao_schema.py`
- [x] `backend/app/blueprints/posicao_blueprint.py`

### Funcionalidades Implementadas
- [x] Listar posi√ß√µes com filtros e pagina√ß√£o
- [x] Buscar posi√ß√£o por ID
- [x] Calcular posi√ß√µes a partir de transa√ß√µes
- [x] Calcular pre√ßo m√©dio ponderado
- [x] Calcular lucro/preju√≠zo realizado
- [x] Calcular lucro/preju√≠zo n√£o realizado (mark-to-market)
- [x] Atualizar valores de mercado
- [x] Gerar resumo consolidado
- [x] Consolidar posi√ß√µes por ativo

### Endpoints Criados
- `GET /api/posicoes` - Listar posi√ß√µes
- `GET /api/posicoes/<id>` - Buscar posi√ß√£o
- `POST /api/posicoes/calcular` - Recalcular posi√ß√µes
- `GET /api/posicoes/resumo` - Resumo consolidado
- `GET /api/posicoes/por-ativo/<id>` - Consolidar por ativo
- `POST /api/posicoes/atualizar-valores` - Atualizar valores

### Pend√™ncias
- [ ] Registrar blueprint em `app/__init__.py`
- [ ] Testar endpoints com curl/httpie
- [ ] Validar c√°lculos de pre√ßo m√©dio
- [ ] Testar rec√°lculo ap√≥s transa√ß√µes

---

## ‚úÖ FASE 3.2 - PROVENTOS

### Arquivos Criados
- [x] `backend/app/services/provento_service.py`
- [x] `backend/app/schemas/provento_schema.py`
- [x] `backend/app/blueprints/provento_blueprint.py`

### Funcionalidades Implementadas
- [x] CRUD completo de proventos (ADMIN)
- [x] Listar proventos com filtros
- [x] Buscar proventos por ativo
- [x] Calcular proventos recebidos pelo usu√°rio
- [x] Calcular total de proventos por tipo
- [x] Valida√ß√£o de tipos (dividendo, JCP, rendimento, bonifica√ß√£o, direito)

### Endpoints Criados
- `GET /api/proventos` - Listar proventos
- `GET /api/proventos/<id>` - Buscar provento
- `POST /api/proventos` - Criar provento (ADMIN)
- `PUT /api/proventos/<id>` - Atualizar provento (ADMIN)
- `DELETE /api/proventos/<id>` - Deletar provento (ADMIN)
- `GET /api/proventos/ativo/<id>` - Proventos de um ativo
- `GET /api/proventos/recebidos` - Proventos recebidos
- `GET /api/proventos/total-recebido` - Total recebido

### Pend√™ncias
- [ ] Registrar blueprint em `app/__init__.py`
- [ ] Testar c√°lculo de proventos recebidos
- [ ] Validar imposto retido
- [ ] Integrar com movimenta√ß√£o de caixa

---

## ‚úÖ FASE 3.3 - MOVIMENTA√á√ÉO DE CAIXA

### Arquivos Criados
- [x] `backend/app/services/movimentacao_caixa_service.py`
- [x] `backend/app/schemas/movimentacao_caixa_schema.py`
- [x] `backend/app/blueprints/movimentacao_caixa_blueprint.py`

### Funcionalidades Implementadas
- [x] CRUD completo de movimenta√ß√µes
- [x] Tipos: dep√≥sito, saque, transfer√™ncia, cr√©dito provento, taxas, impostos
- [x] Atualiza√ß√£o autom√°tica de saldo das corretoras
- [x] C√°lculo de saldo consolidado por moeda
- [x] Gera√ß√£o de extrato com saldo acumulado
- [x] Suporte a m√∫ltiplas moedas (BRL, USD, EUR)

### Endpoints Criados
- `GET /api/movimentacoes-caixa` - Listar movimenta√ß√µes
- `GET /api/movimentacoes-caixa/<id>` - Buscar movimenta√ß√£o
- `POST /api/movimentacoes-caixa` - Criar movimenta√ß√£o
- `PUT /api/movimentacoes-caixa/<id>` - Atualizar movimenta√ß√£o
- `DELETE /api/movimentacoes-caixa/<id>` - Deletar movimenta√ß√£o
- `GET /api/movimentacoes-caixa/saldo/rretora_id>` - Saldo
- `GET /api/movimentacoes-caixa/extrato` - Extrato

### Pend√™ncias
- [ ] Registrar blueprint em `app/__init__.py`
- [ ] Testar transfer√™ncias entre corretoras
- [ ] Validar c√°lculo de saldo
- [ ] Testar extrato com filtros de data

---

## ‚úÖ FASE 3.4 - EVENTOS CORPORATIVOS

### Arquivos Criados
- [x] `backend/app/services/evento_corporativo_service.py`
- [x] `backend/app/schemas/evento_corporativo_schema.py`
- [x] `backend/app/blueprints/evento_corporativo_blueprint.py`

### Funcionalidades Implementadas
- [x] CRUD completo de eventos (ADMIN)
- [x] Tipos: desdobramento, grupamento, bonifica√ß√£o, subscri√ß√£o, fus√£o, cis√£o
- [x] Calcular impacto de eventos nas posi√ß√µes
- [x] Aplicar split/reverse split automaticamente
- [x] Listar eventos que afetam o usu√°rio
- [x] Valida√ß√£o de propor√ß√µes (formato X:Y)

### Endpoints Criados
- `GET /api/eventos-corporativos` - Listar eventos
- `GET /api/eventos-corporativos/<id>` - Buscar evento
- `POST /api/eventos-corporativos` - Criar evento (ADMIN)
- `PUT /api/eventos-corporativos/<id>` - Atualizar evento (ADMIN)
- `DELETE /api/eventos-corporativos/<id>` - Deletar evento (ADMIN)
- `GET /api/eventos-corporativos/ativo/<id>` - Eventos de um ativo
- `GET /api/eventos-corporativos/meus-eventos` - Eventos do usu√°rio
- `POST /api/eventos-corporativos/<id>/aplicar-split` - Aplicar split

### Pend√™ncias
- [ ] Registrar blueprint em `app/__init__.py`
- [ ] Testar aplica√ß√£o de desdobramento
- [ ] Testar aplica√ß√£o de grupamento
- [ ] Validar c√°lculo de impacto

---

## ‚úÖ FASE 3.5 - PORTFOLIO ANALYTICS

### Arquivos Criados
- [x] `backend/app/services/portfolio_service.py`
- [x] `backend/app/blueprints/portfolio_blueprint.py`

### Funcionalidades Implementadas
- [x] Dashboard completo do portf√≥lio
- [x] Distribui√ß√£o por classe de ativo
- [x] Distribui√ß√£o por setor
- [x] Evolu√ß√£o do patrim√¥nio ao longo do tempo
- [x] M√©tricas de risco (HHI, concentra√ß√£o)
- [x] Performance individual dos ativos
- [x] ROI por ativo
- [x] Recomenda√ß√µes de diversifica√ß√£o

### Endpoints Criados
- `GET /api/portfolio/dashboard` - Dashboard completo
- `GET /api/portfolio/distribuicao/classes` - Distribui√ß√£o classes
- `GET /api/portfolio/distribuicao/setores` - Distribui√ß√£o setores
- `GET /api/portfolio/evolucao` - Evolu√ß√£o patrim√¥nio
- `GET /api/portfolio/metricas-risco` - M√©tricas de risco
- `GET /api/portfolio/performance` - Performance dos ativos

### Pend√™ncias
- [ ] Registrar blueprint em `app/__init__.py`
- [ ] Testar dashboard completo
- [ ] Validar m√©tricas de risco
- [ ] Testar evolu√ß√£o com diferentes per√≠odos

---

## üîß INTEGRA√á√ÉO COM APP

### Passo 1: Registrar Blueprints

Editar `backend/app/__init__.py` e adicionar:

Importar blueprints do M√≥dulo 3
from app.blueprints.posicao_blueprint import posicao_bp
from app.blueprints.provento_blueprint import provento_bp
from app.blueprints.movimentacao_caixa_blueprint import movimentacao_caixa_bp
from app.blueprints.evento_corporativo_blueprint import evento_corporativo_bp
from app.blueprints.portfolio_blueprint import portfolio_bp

Registrar blueprints
app.register_blueprint(posicao_bp)
app.register_blueprint(provento_bp)
app.register_blueprint(movimentacao_caixa_bp)
app.register_blueprint(evento_corporativo_bp)
app.register_blueprint(portfolio_bp)

text

### Passo 2: Verificar Imports nos Models

Verificar se `app/models/__init__.py` exporta:
- `Posicao`
- `Provento`
- `MovimentacaoCaixa`
- `EventoCorporativo`

### Passo 3: Criar Testes

Executar os scripts de teste (ser√£o criados na pr√≥xima etapa):
- `tests/test_posicoes_crud.sh`
- `tests/test_proventos_crud.sh`
- `tests/test_movimentacoes_crud.sh`
- `tests/test_eventos_crud.sh`
- `tests/test_portfolio_analytics.sh`

---

## üìä RESUMO DE PROGRESSO

| Fase | Arquivos | Status | Testes |
|------|----------|--------|--------|
| 3.1 - Posi√ß√µes | 3/3 | ‚úÖ Criado | ‚è≥ Pendente |
| 3.2 - Proventos | 3/3 | ‚úÖ Criado | ‚è≥ Pendente |
| 3.3 - Mov. Caixa | 3/3 | ‚úÖ Criado | ‚è≥ Pendente |
| 3.4 - Eventos Corp. | 3/3 | ‚úÖ Criado | ‚è≥ Pendente |
| 3.5 - Portfolio | 2/2 | ‚úÖ Criado | ‚è≥ Pendente |

**Total:** 14/14 arquivos criados ‚úÖ

---

## üéØ PR√ìXIMOS PASSOS

1. [ ] Registrar todos os blueprints no app
2. [ ] Reiniciar containers Podman
3. [ ] Executar testes de cada fase
4. [ ] Validar c√°lculos financeiros
5. [ ] Testar integra√ß√µes entre m√≥dulos
6. [ ] Criar documenta√ß√£o de API detalhada
7. [ ] Implementar logs de auditoria

---

## üìù OBSERVA√á√ïES

- Todos os services implementam valida√ß√£o de propriedade (usuario_id)
- Schemas Marshmallow validam tipos de dados e regras de neg√≥cio
- Endpoints seguem padr√£o RESTful
- Suporte a pagina√ß√£o em todas as listagens
- C√°lculos financeiros usam `Decimal` para precis√£o
- Logs estruturados para debugging

---

**Documenta√ß√£o gerada automaticamente**  
**Sistema Exitus - M√≥dulo 3**

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/exitus_m2_final_100percent.txt ---
[0;34m================================================[0m
[0;34m  EXITUS - Documenta√ß√£o da Estrutura do Banco[0m
[0;34m================================================[0m

[0;32m‚úì Container exitus-db est√° online[0m
Gerando documenta√ß√£o em: [1;33mexitus_db_structure_20251202_214838.txt[0m

Coletando lista de tabelas...
Coletando estrutura detalhada das tabelas...
Coletando detalhes de colunas, PKs e FKs...
  - Processando tabela: alembic_version
  - Processando tabela: ativo
  - Processando tabela: corretora
  - Processando tabela: evento_corporativo
  - Processando tabela: feriado_mercado
  - Processando tabela: fonte_dados
  - Processando tabela: log_auditoria
  - Processando tabela: movimentacao_caixa
  - Processando tabela: posicao
  - Processando tabela: provento
  - Processando tabela: regra_fiscal
  - Processando tabela: transacao
  - Processando tabela: usuario

[0;32m‚úì Documenta√ß√£o gerada com sucesso![0m
[0;34mArquivo: [1;33mexitus_db_structure_20251202_214838.txt[0m

[0;34mPara visualizar:[0m
  cat exitus_db_structure_20251202_214838.txt
  less exitus_db_structure_20251202_214838.txt
  code exitus_db_structure_20251202_214838.txt  [0;34m# (se estiver usando VSCode)[0m

[0;32mPronto para compartilhar o status do banco! üéØ[0m

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo1_database.md ---
# Exitus - M√≥dulo 1: Database
## Documenta√ß√£o T√©cnica do Banco de Dados

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Banco](#arquitetura-do-banco)
3. [Models e Tabelas](#models-e-tabelas)
4. [Relacionamentos](#relacionamentos)
5. [Enums e Tipos](#enums-e-tipos)
6. [√çndices e Performance](#√≠ndices-e-performance)
7. [Queries √öteis](#queries-√∫teis)
8. [Diagrama ER](#diagrama-er)
9. [Boas Pr√°ticas](#boas-pr√°ticas)

---

## üéØ Vis√£o Geral

O banco de dados do Exitus foi projetado para gerenciar investimentos de forma completa e eficiente.

### Estat√≠sticas

| M√©trica | Valor |
|---------|-------|
| **Tabelas** | 13 (12 models + alembic_version) |
| **Enums** | 11 tipos personalizados |
| **Foreign Keys** | 15 relacionamentos |
| **√çndices** | 86 (autom√°ticos + customizados) |
| **SGBD** | PostgreSQL 15+ |

### Tecnologias

- **ORM:** SQLAlchemy 2.0+
- **Migrations:** Alembic 1.13+
- **Language:** Python 3.11+
- **Database:** PostgreSQL 15+ Alpine

---

## üèóÔ∏è Arquitetura do Banco

### Camadas de Dados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CAMADA DE APLICA√á√ÉO (Flask)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   CAMADA ORM (SQLAlchemy)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   CAMADA DE DADOS (PostgreSQL)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Grupos de Tabelas

**1. Core (Essenciais):**
- `usuario` - Usu√°rios do sistema
- `corretora` - Corretoras/brokers
- `ativo` - Ativos financeiros (a√ß√µes, FIIs, etc.)
- `posicao` - Posi√ß√µes consolidadas
- `transacao` - Opera√ß√µes de compra/venda

**2. Financeiras:**
- `provento` - Dividendos, JCP, rendimentos
- `movimentacao_caixa` - Dep√≥sitos, saques, transfer√™ncias

**3. Eventos e Refer√™ncia:**
- `evento_corporativo` - Splits, grupamentos, bonifica√ß√µes
- `feriado_mercado` - Feriados de bolsa

**4. Sistema:**
- `fonte_dados` - APIs de cota√ß√µes
- `regra_fiscal` - Regras de IR
- `log_auditoria` - Auditoria de a√ß√µes

---

## üìä Models e Tabelas

### 1. Usuario

**Descri√ß√£o:** Gerencia usu√°rios e autentica√ß√£o

**Tabela:** `usuario`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `username` | VARCHAR(80) | Username √∫nico |
| `email` | VARCHAR(120) | Email √∫nico |
| `password_hash` | VARCHAR(256) | Senha criptografada |
| `nome_completo` | VARCHAR(200) | Nome completo (opcional) |
| `ativo` | BOOLEAN | Se usu√°rio est√° ativo |
| `role` | ENUM(UserRole) | Papel: ADMIN, USER, READONLY |
| `ultimo_login` | TIMESTAMP | Data do √∫ltimo login |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `username`, `email`
- CHECK: `username` deve ter pelo menos 3 caracteres
- CHECK: `email` deve ter formato v√°lido

**√çndices:**
- `ix_usuario_username`
- `ix_usuario_email`

**Relacionamentos:**
- 1:N com `corretora`
- 1:N com `posicao`
- 1:N com `transacao`
- 1:N com `movimentacao_caixa`
- 1:N com `log_auditoria`

---

### 2. Corretora

**Descri√ß√£o:** Corretoras/brokers onde o usu√°rio opera

**Tabela:** `corretora`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio dono |
| `nome` | VARCHAR(100) | Nome da corretora |
| `tipo` | ENUM(TipoCorretora) | NACIONAL, INTERNACIONAL |
| `pais` | VARCHAR(2) | C√≥digo ISO do pa√≠s |
| `moeda_padrao` | VARCHAR(3) | Moeda padr√£o (BRL, USD) |
| `ativa` | BOOLEAN | Se corretora est√° ativa |
| `numero_conta` | VARCHAR(50) | N√∫mero da conta (opcional) |
| `observacoes` | TEXT | Observa√ß√µes gerais |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (ON DELETE CASCADE)
- CHECK: `pais` formato ISO (2 letras mai√∫sculas)
- CHECK: `moeda_padrao` formato ISO (3 letras mai√∫sculas)
- CHECK: `nome` pelo menos 2 caracteres

**√çndices:**
- `ix_corretora_usuario_id`
- `ix_corretora_nome`
- `ix_corretora_tipo`
- `ix_corretora_pais`
- `ix_corretora_moeda_padrao`
- `ix_corretora_ativa`

---

### 3. Ativo

**Descri√ß√£o:** Ativos financeiros (a√ß√µes, FIIs, ETFs, etc.)

**Tabela:** `ativo`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ticker` | VARCHAR(20) | C√≥digo do ativo (PETR4, AAPL) |
| `nome` | VARCHAR(200) | Nome completo |
| `tipo` | ENUM(TipoAtivo) | ACAO, FII, ETF, BDR, etc. |
| `classe` | ENUM(ClasseAtivo) | RENDA_VARIAVEL, RENDA_FIXA |
| `mercado` | VARCHAR(10) | Mercado (BR, US, etc.) |
| `moeda` | VARCHAR(3) | Moeda de negocia√ß√£o |
| `preco_atual` | NUMERIC(18,8) | √öltimo pre√ßo |
| `data_ultima_cotacao` | TIMESTAMP | Data da √∫ltima cota√ß√£o |
| `ativo` | BOOLEAN | Se est√° dispon√≠vel |
| `deslistado` | BOOLEAN | Se foi deslistado |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `ticker`, `mercado`
- CHECK: `ticker` pelo menos 1 caractere
- CHECK: `preco_atual` >= 0 (se informado)

**√çndices:**
- `ix_ativo_ticker`
- `ix_ativo_nome`
- `ix_ativo_tipo`
- `ix_ativo_classe`
- `ix_ativo_mercado`
- `ix_ativo_moeda`
- `ix_ativo_ativo`
- `ix_ativo_deslistado`
- `ix_ativo_data_ultima_cotacao`

---

### 4. Posicao

**Descri√ß√£o:** Posi√ß√£o consolidada de um ativo na carteira

**Tabela:** `posicao`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio dono |
| `corretora_id` | UUID | FK - Corretora |
| `ativo_id` | UUID | FK - Ativo |
| `quantidade` | NUMERIC(18,8) | Quantidade de ativos |
| `preco_medio` | NUMERIC(18,8) | Pre√ßo m√©dio de compra |
| `valor_investido` | NUMERIC(18,2) | Custo total |
| `data_primeira_compra` | DATE | Data da primeira compra |
| `data_ultima_atualizacao` | TIMESTAMP | √öltima atualiza√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (CASCADE)
- FOREIGN KEY: `corretora_id` ‚Üí `corretora.id` (CASCADE)
- FOREIGN KEY: `ativo_id` ‚Üí `ativo.id` (RESTRICT)
- UNIQUE: `usuario_id`, `corretora_id`, `ativo_id`
- CHECK: `quantidade` >= 0
- CHECK: `preco_medio` > 0
- CHECK: `valor_investido` >= 0

**√çndices:**
- `ix_posicao_usuario_id`
- `ix_posicao_corretora_id`
- `ix_posicao_ativo_id`
- `ix_posicao_data_primeira_compra`
- `ix_posicao_data_ultima_atualizacao`

---

### 5. Transacao

**Descri√ß√£o:** Opera√ß√µes de compra/venda de ativos

**Tabela:** `transacao`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio |
| `corretora_id` | UUID | FK - Corretora |
| `ativo_id` | UUID | FK - Ativo |
| `tipo_operacao` | ENUM | COMPRA, VENDA, BONIFICACAO, etc. |
| `quantidade` | NUMERIC(18,8) | Quantidade negociada |
| `preco_unitario` | NUMERIC(18,8) | Pre√ßo por ativo |
| `custos_operacao` | NUMERIC(18,2) | Taxas e emolumentos |
| `data_operacao` | DATE | Data da opera√ß√£o |
| `data_liquidacao` | DATE | Data de liquida√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id`, `corretora_id`, `ativo_id`
- CHECK: `quantidade` > 0
- CHECK: `preco_unitario` >= 0
- CHECK: `custos_operacao` >= 0
- CHECK: `data_liquidacao` >= `data_operacao`

**√çndices:**
- `ix_transacao_usuario_id`
- `ix_transacao_corretora_id`
- `ix_transacao_ativo_id`
- `ix_transacao_tipo_operacao`
- `ix_transacao_data_operacao`
- `ix_transacao_data_liquidacao`

---

### 6. Provento

**Descri√ß√£o:** Dividendos, JCP e outros proventos

**Tabela:** `provento`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ativo_id` | UUID | FK - Ativo que pagou |
| `tipo_provento` | ENUM | DIVIDENDO, JCP, RENDIMENTO, etc. |
| `valor_por_acao` | NUMERIC(18,8) | Valor por a√ß√£o/cota |
| `quantidade_ativos` | NUMERIC(18,8) | Qtd de ativos que o usu√°rio tinha |
| `valor_total` | NUMERIC(18,2) | Valor total recebido |
| `imposto_retido` | NUMERIC(18,2) | IR retido na fonte |
| `data_com` | DATE | Data COM |
| `data_pagamento` | DATE | Data de pagamento |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `ativo_id` ‚Üí `ativo.id` (RESTRICT)
- CHECK: `valor_por_acao` >= 0
- CHECK: `quantidade_ativos` > 0
- CHECK: `valor_total` >= 0
- CHECK: `imposto_retido` >= 0
- CHECK: `data_pagamento` >= `data_com`

**√çndices:**
- `ix_provento_ativo_id`
- `ix_provento_tipo_provento`
- `ix_provento_data_com`
- `ix_provento_data_pagamento`

---

### 7. MovimentacaoCaixa

**Descri√ß√£o:** Dep√≥sitos, saques e transfer√™ncias entre corretoras

**Tabela:** `movimentacao_caixa`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio |
| `corretora_id` | UUID | FK - Corretora origem |
| `corretora_destino_id` | UUID | FK - Corretora destino (transfer√™ncias) |
| `provento_id` | UUID | FK - Provento relacionado (se houver) |
| `tipo_movimentacao` | ENUM | DEPOSITO, SAQUE, TRANSFERENCIA, etc. |
| `valor` | NUMERIC(18,2) | Valor da movimenta√ß√£o |
| `moeda` | VARCHAR(3) | Moeda |
| `data_movimentacao` | DATE | Data da movimenta√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id`, `corretora_id`, `corretora_destino_id`, `provento_id`
- CHECK: `valor` > 0

**√çndices:**
- `ix_movimentacao_caixa_usuario_id`
- `ix_movimentacao_caixa_corretora_id`
- `ix_movimentacao_caixa_corretora_destino_id`
- `ix_movimentacao_caixa_provento_id`
- `ix_movimentacao_caixa_tipo_movimentacao`
- `ix_movimentacao_caixa_data_movimentacao`
- `ix_movimentacao_caixa_moeda`

---

### 8. EventoCorporativo

**Descri√ß√£o:** Eventos corporativos (splits, grupamentos, etc.)

**Tabela:** `evento_corporativo`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ativo_id` | UUID | FK - Ativo afetado |
| `ativo_novo_id` | UUID | FK - Novo ativo (fus√µes/cis√µes) |
| `tipo_evento` | ENUM | SPLIT, GRUPAMENTO, BONIFICACAO, etc. |
| `data_evento` | DATE | Data do evento |
| `data_com` | DATE | Data COM |
| `proporcao` | VARCHAR(20) | Propor√ß√£o (ex: 2:1) |
| `descricao` | TEXT | Descri√ß√£o do evento |
| `impacto_posicoes` | BOOLEAN | Se afeta posi√ß√µes |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `ativo_id`, `ativo_novo_id` ‚Üí `ativo.id`
- CHECK: `data_com` <= `data_evento` (se informado)

**√çndices:**
- `ix_evento_corporativo_ativo_id`
- `ix_evento_corporativo_ativo_novo_id`
- `ix_evento_corporativo_tipo_evento`
- `ix_evento_corporativo_data_evento`
- `ix_evento_corporativo_data_com`
- `ix_evento_corporativo_impacto_posicoes`

---

### 9. FonteDados

**Descri√ß√£o:** Fontes de dados para cota√ß√µes (APIs)

**Tabela:** `fonte_dados`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `nome` | VARCHAR(100) | Nome da fonte (yfinance, brapi) |
| `tipo_fonte` | ENUM | API, SCRAPING, MANUAL, ARQUIVO |
| `url_base` | VARCHAR(500) | URL base da API |
| `requer_autenticacao` | BOOLEAN | Se requer API key |
| `rate_limit` | VARCHAR(50) | Limite de requisi√ß√µes |
| `ativa` | BOOLEAN | Se est√° ativa |
| `prioridade` | INTEGER | Ordem de prioridade |
| `ultima_consulta` | TIMESTAMP | √öltima consulta realizada |
| `total_consultas` | INTEGER | Total de consultas |
| `total_erros` | INTEGER | Total de erros |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `nome`
- CHECK: `nome` pelo menos 2 caracteres
- CHECK: `prioridade` >= 1

**√çndices:**
- `ix_fonte_dados_nome`
- `ix_fonte_dados_tipo_fonte`
- `ix_fonte_dados_ativa`
- `ix_fonte_dados_prioridade`
- `ix_fonte_dados_ultima_consulta`

---

### 10. RegraFiscal

**Descri√ß√£o:** Regras de tributa√ß√£o (IR)

**Tabela:** `regra_fiscal`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `pais` | VARCHAR(2) | Pa√≠s (c√≥digo ISO) |
| `tipo_ativo` | VARCHAR(50) | Tipo de ativo (ACAO, FII) |
| `tipo_operacao` | VARCHAR(50) | Tipo opera√ß√£o (SWING_TRADE, DAY_TRADE) |
| `aliquota_ir` | NUMERIC(5,4) | Al√≠quota de IR (%) |
| `valor_isencao` | NUMERIC(18,2) | Valor de isen√ß√£o mensal |
| `incide_sobre` | ENUM | LUCRO, PROVENTO, OPERACAO |
| `descricao` | TEXT | Descri√ß√£o da regra |
| `vigencia_inicio` | DATE | In√≠cio da vig√™ncia |
| `vigencia_fim` | DATE | Fim da vig√™ncia |
| `ativa` | BOOLEAN | Se regra est√° ativa |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- CHECK: `pais` formato ISO (2 letras)
- CHECK: `aliquota_ir` >= 0 AND <= 100
- CHECK: `valor_isencao` >= 0 (se informado)
- CHECK: `vigencia_fim` >= `vigencia_inicio` (se informado)

**√çndices:**
- `ix_regra_fiscal_pais`
- `ix_regra_fiscal_tipo_ativo`
- `ix_regra_fiscal_tipo_operacao`
- `ix_regra_fiscal_incide_sobre`
- `ix_regra_fiscal_vigencia_inicio`
- `ix_regra_fiscal_vigencia_fim`
- `ix_regra_fiscal_ativa`

---

### 11. FeriadoMercado

**Descri√ß√£o:** Feriados e dias sem preg√£o

**Tabela:** `feriado_mercado`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `pais` | VARCHAR(2) | Pa√≠s (c√≥digo ISO) |
| `mercado` | VARCHAR(20) | Mercado/bolsa (B3, NYSE) |
| `data_feriado` | DATE | Data do feriado |
| `tipo_feriado` | ENUM | NACIONAL, BOLSA, ANTECIPADO, etc. |
| `nome` | VARCHAR(200) | Nome do feriado |
| `horario_fechamento` | TIME | Hor√°rio de fechamento (se antecipado) |
| `recorrente` | BOOLEAN | Se √© feriado anual fixo |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `pais`, `mercado`, `data_feriado`
- CHECK: `pais` formato ISO
- CHECK: `nome` pelo menos 3 caracteres

**√çndices:**
- `ix_feriado_mercado_pais`
- `ix_feriado_mercado_mercado`
- `ix_feriado_mercado_data_feriado`
- `ix_feriado_mercado_tipo_feriado`
- `ix_feriado_mercado_recorrente`

---

### 12. LogAuditoria

**Descri√ß√£o:** Logs de auditoria para compliance

**Tabela:** `log_auditoria`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio que realizou a√ß√£o |
| `acao` | VARCHAR(50) | Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE) |
| `entidade` | VARCHAR(100) | Entidade afetada (Usuario, Transacao) |
| `entidade_id` | UUID | ID do registro afetado |
| `dados_antes` | JSON | Estado anterior (UPDATE) |
| `dados_depois` | JSON | Estado posterior (UPDATE/CREATE) |
| `ip_address` | VARCHAR(45) | IP de origem |
| `user_agent` | VARCHAR(500) | Navegador/cliente |
| `timestamp` | TIMESTAMP | Data/hora da a√ß√£o |
| `sucesso` | BOOLEAN | Se a√ß√£o foi bem-sucedida |
| `mensagem` | TEXT | Mensagem de erro ou detalhes |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (SET NULL)
- CHECK: `acao` pelo menos 3 caracteres

**√çndices:**
- `ix_log_auditoria_usuario_id`
- `ix_log_auditoria_acao`
- `ix_log_auditoria_entidade`
- `ix_log_auditoria_entidade_id`
- `ix_log_auditoria_timestamp`
- `ix_log_auditoria_sucesso`
- `ix_log_auditoria_ip_address`

---

## üîó Relacionamentos

### Diagrama de Relacionamentos

```
USUARIO (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) CORRETORA
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) LOG_AUDITORIA

CORRETORA (1) ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA

ATIVO (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) PROVENTO
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) EVENTO_CORPORATIVO

PROVENTO (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA

EVENTO_CORPORATIVO ‚îÄ‚îÄ‚îÄ (1) ATIVO (ativo_novo_id, opcional)
```

### Pol√≠ticas de DELETE

| Tabela Pai | Tabela Filha | Pol√≠tica |
|------------|--------------|----------|
| `usuario` | `corretora` | CASCADE |
| `usuario` | `posicao` | CASCADE |
| `usuario` | `transacao` | CASCADE |
| `usuario` | `movimentacao_caixa` | CASCADE |
| `usuario` | `log_auditoria` | SET NULL |
| `corretora` | `posicao` | CASCADE |
| `corretora` | `transacao` | CASCADE |
| `ativo` | `posicao` | RESTRICT |
| `ativo` | `transacao` | RESTRICT |
| `ativo` | `provento` | RESTRICT |
| `provento` | `movimentacao_caixa` | SET NULL |

---

## üî¢ Enums e Tipos

### 1. UserRole
```python
ADMIN = "admin"      # Administrador completo
USER = "user"        # Usu√°rio normal
READONLY = "readonly" # Apenas leitura
```

### 2. TipoCorretora
```python
NACIONAL = "nacional"           # Corretora brasileira
INTERNACIONAL = "internacional" # Corretora estrangeira
```

### 3. TipoAtivo
```python
ACAO = "acao"               # A√ß√£o
FII = "fii"                 # Fundo Imobili√°rio
ETF = "etf"                 # Exchange Traded Fund
BDR = "bdr"                 # Brazilian Depositary Receipt
REIT = "reit"               # Real Estate Investment Trust
STOCK = "stock"             # A√ß√£o estrangeira
CRYPTO = "crypto"           # Criptomoeda
RENDA_FIXA = "renda_fixa"   # T√≠tulo de renda fixa
OUTRO = "outro"             # Outros
```

### 4. ClasseAtivo
```python
RENDA_VARIAVEL = "renda_variavel"
RENDA_FIXA = "renda_fixa"
```

### 5. TipoOperacao
```python
COMPRA = "compra"
VENDA = "venda"
BONIFICACAO = "bonificacao"
SUBSCRICAO = "subscricao"
DESDOBRAMENTO = "desdobramento"
GRUPAMENTO = "grupamento"
```

### 6. TipoProvento
```python
DIVIDENDO = "dividendo"
JCP = "jcp"                    # Juros sobre Capital Pr√≥prio
RENDIMENTO = "rendimento"      # Rendimento de FII
BONUS = "bonus"
```

### 7. TipoMovimentacao
```python
DEPOSITO = "deposito"
SAQUE = "saque"
TRANSFERENCIA = "transferencia"
CREDITO_PROVENTO = "credito_provento"
DEBITO_TAXA = "debito_taxa"
```

### 8. TipoEventoCorporativo
```python
SPLIT = "split"               # Desdobramento
GRUPAMENTO = "grupamento"
BONIFICACAO = "bonificacao"
FUSAO = "fusao"
CISAO = "cisao"
INCORPORACAO = "incorporacao"
MUDANCA_TICKER = "mudanca_ticker"
```

### 9. TipoFonteDados
```python
API = "api"
SCRAPING = "scraping"
MANUAL = "manual"
ARQUIVO = "arquivo"
```

### 10. IncidenciaImposto
```python
LUCRO = "lucro"           # IR sobre ganho de capital
PROVENTO = "provento"     # IR sobre dividendos/JCP
OPERACAO = "operacao"     # IR sobre opera√ß√£o (day trade)
```

### 11. TipoFeriado
```python
NACIONAL = "nacional"
BOLSA = "bolsa"
PONTE = "ponte"
FECHAMENTO_ANTECIPADO = "antecip"
MANUTENCAO = "manutencao"
OUTRO = "outro"
```

---

## üìà √çndices e Performance

### √çndices Principais por Tabela

**Total de √≠ndices:** 86

**Distribui√ß√£o:**
- √çndices em foreign keys: 15
- √çndices em campos de busca: 35
- √çndices em campos de data: 20
- √çndices UNIQUE: 8
- Outros √≠ndices: 8

### Estrat√©gias de Indexa√ß√£o

1. **Foreign Keys:** Todas possuem √≠ndice autom√°tico
2. **Campos de Busca Frequente:** `ticker`, `username`, `email`, `nome`
3. **Campos de Filtro:** `ativo`, `tipo`, `mercado`, `pais`
4. **Campos de Ordena√ß√£o:** `data_operacao`, `timestamp`, `prioridade`
5. **Campos UNIQUE:** `username`, `email`, `ticker+mercado`

### Queries Otimizadas

Todos os relacionamentos e buscas frequentes est√£o cobertos por √≠ndices.

---

## üí° Queries √öteis

### 1. Listar todas as tabelas
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema='public' 
AND table_type='BASE TABLE'
ORDER BY table_name;
```

### 2. Ver estrutura de uma tabela
```sql
\d+ usuario
```

### 3. Ver todos os enums
```sql
SELECT typname, enumlabel
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typtype = 'e'
ORDER BY typname, enumsortorder;
```

### 4. Ver todas as foreign keys
```sql
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    rc.delete_rule
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
JOIN information_schema.referential_constraints AS rc
    ON rc.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
ORDER BY tc.table_name;
```

### 5. Ver todos os √≠ndices
```sql
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

### 6. Estat√≠sticas de tabelas
```sql
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    n_tup_ins AS inserts,
    n_tup_upd AS updates,
    n_tup_del AS deletes
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7. Buscar ativos por ticker
```sql
SELECT ticker, nome, tipo, mercado, preco_atual
FROM ativo
WHERE ticker ILIKE '%PETR%'
AND ativo = true
ORDER BY ticker;
```

### 8. Carteira consolidada de um usu√°rio
```sql
SELECT
    a.ticker,
    a.nome,
    p.quantidade,
    p.preco_medio,
    p.valor_investido,
    a.preco_atual,
    (a.preco_atual * p.quantidade) AS valor_atual,
    ((a.preco_atual * p.quantidade) - p.valor_investido) AS lucro_prejuizo
FROM posicao p
JOIN ativo a ON p.ativo_id = a.id
WHERE p.usuario_id = 'uuid-do-usuario'
AND p.quantidade > 0
ORDER BY p.valor_investido DESC;
```

### 9. Hist√≥rico de transa√ß√µes
```sql
SELECT
    t.data_operacao,
    a.ticker,
    t.tipo_operacao,
    t.quantidade,
    t.preco_unitario,
    t.custos_operacao,
    (t.quantidade * t.preco_unitario + t.custos_operacao) AS valor_total
FROM transacao t
JOIN ativo a ON t.ativo_id = a.id
WHERE t.usuario_id = 'uuid-do-usuario'
ORDER BY t.data_operacao DESC
LIMIT 50;
```

### 10. Proventos recebidos no m√™s
```sql
SELECT
    a.ticker,
    p.tipo_provento,
    p.data_pagamento,
    p.valor_total,
    p.imposto_retido,
    (p.valor_total - p.imposto_retido) AS valor_liquido
FROM provento p
JOIN ativo a ON p.ativo_id = a.id
WHERE DATE_TRUNC('month', p.data_pagamento) = DATE_TRUNC('month', CURRENT_DATE)
ORDER BY p.data_pagamento DESC;
```

---

## üìê Diagrama ER

### Diagrama Textual Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      USUARIO        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ
‚îÇ username (UQ)      ‚îÇ
‚îÇ email (UQ)         ‚îÇ
‚îÇ password_hash      ‚îÇ
‚îÇ role               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 1:N
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                      ‚îÇ
           ‚ñº                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     CORRETORA       ‚îÇ  ‚îÇ      POSICAO        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ  ‚îÇ id (PK)            ‚îÇ
‚îÇ usuario_id (FK)    ‚îÇ  ‚îÇ usuario_id (FK)    ‚îÇ
‚îÇ nome               ‚îÇ  ‚îÇ corretora_id (FK)  ‚îÇ
‚îÇ tipo               ‚îÇ  ‚îÇ ativo_id (FK)      ‚îÇ
‚îÇ pais               ‚îÇ  ‚îÇ quantidade         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                        ‚îÇ
           ‚îÇ                        ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
           ‚îÇ                        ‚îÇ
           ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     TRANSACAO       ‚îÇ  ‚îÇ       ATIVO         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ  ‚îÇ id (PK)            ‚îÇ
‚îÇ usuario_id (FK)    ‚îÇ  ‚îÇ ticker (UQ)        ‚îÇ
‚îÇ corretora_id (FK)  ‚îÇ  ‚îÇ nome               ‚îÇ
‚îÇ ativo_id (FK)      ‚îÇ  ‚îÇ tipo               ‚îÇ
‚îÇ tipo_operacao      ‚îÇ  ‚îÇ mercado            ‚îÇ
‚îÇ quantidade         ‚îÇ  ‚îÇ preco_atual        ‚îÇ
‚îÇ preco_unitario     ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
                                    ‚îÇ 1:N
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ           ‚îÇ           ‚îÇ
                        ‚ñº           ‚ñº           ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   PROVENTO   ‚îÇ ‚îÇ MOVIMENTACAO ‚îÇ ‚îÇ EVENTO_          ‚îÇ
              ‚îÇ              ‚îÇ ‚îÇ    _CAIXA    ‚îÇ ‚îÇ CORPORATIVO      ‚îÇ
              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
              ‚îÇ id (PK)     ‚îÇ ‚îÇ id (PK)     ‚îÇ ‚îÇ id (PK)         ‚îÇ
              ‚îÇ ativo_id(FK)‚îÇ ‚îÇ usuario_id  ‚îÇ ‚îÇ ativo_id (FK)   ‚îÇ
              ‚îÇ tipo        ‚îÇ ‚îÇ corretora   ‚îÇ ‚îÇ tipo_evento     ‚îÇ
              ‚îÇ valor       ‚îÇ ‚îÇ provento_id ‚îÇ ‚îÇ proporcao       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TABELAS DE REFER√äNCIA                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FONTE_DADOS   ‚îÇ  REGRA_FISCAL  ‚îÇ  FERIADO_MERCADO          ‚îÇ
‚îÇ  LOG_AUDITORIA ‚îÇ                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Boas Pr√°ticas

### 1. Uso de UUIDs

Todas as PKs s√£o UUIDs para:
- Evitar exposi√ß√£o de IDs sequenciais
- Facilitar merge de bancos
- Seguran√ßa adicional

### 2. Timestamps

Todas as tabelas t√™m `created_at` e `updated_at` para auditoria.

### 3. Soft Delete

Tabelas principais usam flag `ativo` ao inv√©s de DELETE f√≠sico.

### 4. Constraints

Uso extensivo de:
- CHECK constraints para valida√ß√£o
- UNIQUE constraints para integridade
- Foreign keys com pol√≠ticas apropriadas

### 5. √çndices

√çndices em:
- Todas as foreign keys
- Campos de busca frequente
- Campos de ordena√ß√£o
- Campos de filtro

### 6. Normaliza√ß√£o

Banco normalizado (3FN) com desnormaliza√ß√µes estrat√©gicas:
- `preco_atual` em `ativo` (cache)
- `valor_total` em `provento` (calculado)

### 7. Tipos de Dados

- `NUMERIC` para valores monet√°rios (evita erros de arredondamento)
- `DATE` para datas puras
- `TIMESTAMP` para data+hora
- `VARCHAR` com limites apropriados
- `TEXT` para campos sem limite
- `BOOLEAN` para flags
- `JSON` para dados semi-estruturados

### 8. Nomenclatura

- Tabelas: singular, snake_case
- Colunas: snake_case
- Enums: UPPERCASE
- Foreign keys: `<tabela>_id`

---

## üîí Seguran√ßa

### 1. Senhas

- Armazenadas com hash bcrypt
- Nunca expor `password_hash` em APIs

### 2. SQL Injection

- Uso exclusivo de ORM (SQLAlchemy)
- Queries parametrizadas

### 3. Auditoria

- Tabela `log_auditoria` registra todas as a√ß√µes
- IP e user-agent salvos

### 4. Roles

- Sistema de permiss√µes baseado em roles
- ADMIN, USER, READONLY

---

## üìä Performance

### Otimiza√ß√µes Implementadas

1. ‚úÖ √çndices em foreign keys
2. ‚úÖ √çndices em campos de busca
3. ‚úÖ √çndices compostos quando necess√°rio
4. ‚úÖ Connection pooling (SQLAlchemy)
5. ‚úÖ Lazy loading de relacionamentos
6. ‚úÖ Eager loading quando apropriado (joined)

### Monitoramento

```sql
-- Ver queries lentas
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- Ver tamanho das tabelas
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## üéØ Conclus√£o

O banco de dados do Exitus foi projetado para:

‚úÖ **Escalabilidade:** Suporta milh√µes de registros  
‚úÖ **Performance:** √çndices e queries otimizadas  
‚úÖ **Integridade:** Constraints e foreign keys  
‚úÖ **Auditoria:** Log completo de a√ß√µes  
‚úÖ **Seguran√ßa:** Hashing, roles, valida√ß√µes  
‚úÖ **Manutenibilidade:** C√≥digo limpo e documentado  

---

**Vers√£o:** 1.0  
**Data:** Novembro 2025  
**Autor:** Equipe Exitus

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo2_backend_auth.md ---
# üìò Exitus - M√≥dulo 2: API REST CRUD

## Vis√£o Geral

O M√≥dulo 2 implementa a **API REST completa** do sistema Exitus, fornecendo endpoints CRUD para todas as entidades principais do sistema de controle de investimentos.

### Tecnologias Utilizadas

- **Framework**: Flask 3.0+
- **ORM**: SQLAlchemy 2.0+
- **Valida√ß√£o**: Marshmallow 3.20+
- **Autentica√ß√£o**: Flask-JWT-Extended
- **Database**: PostgreSQL 15
- **Container**: Podman
- **Servidor**: Gunicorn

---

## üèóÔ∏è Arquitetura

### Padr√£o MVC + Service Layer

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ models/          # SQLAlchemy Models (Entidades)
‚îÇ   ‚îú‚îÄ‚îÄ schemas/         # Marshmallow Schemas (Valida√ß√£o)
‚îÇ   ‚îú‚îÄ‚îÄ services/        # Business Logic
‚îÇ   ‚îú‚îÄ‚îÄ blueprints/      # Flask Routes (Controllers)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ usuarios/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ corretoras/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ativos/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transacoes/
‚îÇ   ‚îú‚îÄ‚îÄ utils/           # Helpers (responses, decorators)
‚îÇ   ‚îú‚îÄ‚îÄ database.py      # SQLAlchemy setup
‚îÇ   ‚îú‚îÄ‚îÄ config.py        # Configura√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py      # Application Factory
‚îú‚îÄ‚îÄ tests/               # Scripts de teste
‚îú‚îÄ‚îÄ run.py               # Entry point
‚îî‚îÄ‚îÄ requirements.txt
```

---

## üîê Fase 2.1 - Autentica√ß√£o JWT

### Endpoints

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| `POST` | `/api/auth/login` | Login e gera√ß√£o de tokens | P√∫blico |
| `POST` | `/api/auth/refresh` | Renovar access token | Refresh Token |
| `GET` | `/api/auth/me` | Dados do usu√°rio autenticado | JWT |
| `POST` | `/api/auth/logout` | Logout (invalidar token) | Refresh Token |

### Exemplo de Login

**Request:**
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "joao.silva",
    "password": "user123"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Login realizado com sucesso",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "Bearer",
    "expires_in": 3600
  }
}
```

### Uso do Token

Incluir em todas as requisi√ß√µes autenticadas:
```bash
Authorization: Bearer <access_token>
```

---

## üë• Fase 2.2.1 - CRUD Usu√°rios

### Endpoints

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| `GET` | `/api/usuarios` | Listar usu√°rios (paginado) | Admin |
| `GET` | `/api/usuarios/{id}` | Buscar usu√°rio por ID | JWT (pr√≥prio ou Admin) |
| `POST` | `/api/usuarios` | Criar usu√°rio | P√∫blico |
| `PUT` | `/api/usuarios/{id}` | Atualizar usu√°rio | JWT (pr√≥prio ou Admin) |
| `DELETE` | `/api/usuarios/{id}` | Deletar usu√°rio | Admin |
| `PATCH` | `/api/usuarios/{id}/password` | Trocar senha | JWT (pr√≥prio) |

### Model Usuario

```python
class Usuario(db.Model):
    __tablename__ = 'usuarios'

    id = UUID
    username = String(50, unique=True)
    email = String(120, unique=True)
    password_hash = String(255)
    nome_completo = String(200)
    ativo = Boolean (default=True)
    role = Enum(UserRole)  # ADMIN, USER, READONLY
    created_at = DateTime
    updated_at = DateTime
```

### Exemplo de Cria√ß√£o

**Request:**
```bash
curl -X POST http://localhost:5000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "username": "maria.santos",
    "email": "maria@email.com",
    "password": "senha123",
    "nome_completo": "Maria Santos",
    "role": "user"
  }'
```

---

## üè¶ Fase 2.2.2 - CRUD Corretoras

### Endpoints

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| `GET` | `/api/corretoras` | Listar corretoras do usu√°rio | JWT |
| `GET` | `/api/corretoras/{id}` | Buscar corretora por ID | JWT |
| `POST` | `/api/corretoras` | Criar corretora | JWT |
| `PUT` | `/api/corretoras/{id}` | Atualizar corretora | JWT |
| `DELETE` | `/api/corretoras/{id}` | Deletar corretora | JWT |
| `GET` | `/api/corretoras/saldo-total` | Saldo total do usu√°rio | JWT |

### Model Corretora

```python
class Corretora(db.Model):
    __tablename__ = 'corretoras'

    id = UUID
    usuario_id = UUID (FK -> usuarios.id)
    nome = String(100)
    tipo = Enum(TipoCorretora)  # CORRETORA, EXCHANGE
    pais = String(2)  # BR, US, etc
    moeda_padrao = String(3)  # BRL, USD, EUR
    saldo_atual = Numeric(18, 2)
    ativa = Boolean
    observacoes = Text
    created_at = DateTime
    updated_at = DateTime
```

### Filtros Dispon√≠veis

- `?page=1&per_page=20` - Pagina√ß√£o
- `?ativa=true` - Apenas corretoras ativas
- `?tipo=corretora` - Filtrar por tipo
- `?pais=BR` - Filtrar por pa√≠s
- `?search=XP` - Busca textual

---

## üìà Fase 2.2.3 - CRUD Ativos

### Endpoints

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| `GET` | `/api/ativos` | Listar ativos (paginado) | JWT |
| `GET` | `/api/ativos/{id}` | Buscar ativo por ID | JWT |
| `GET` | `/api/ativos/ticker/{ticker}` | Buscar por ticker | JWT |
| `POST` | `/api/ativos` | Criar ativo | Admin |
| `PUT` | `/api/ativos/{id}` | Atualizar ativo | Admin |
| `DELETE` | `/api/ativos/{id}` | Deletar ativo | Admin |
| `GET` | `/api/ativos/mercado/{mercado}` | Listar por mercado | JWT |

### Model Ativo

```python
class Ativo(db.Model):
    __tablename__ = 'ativos'

    id = UUID
    ticker = String(20)
    nome = String(200)
    tipo = Enum(TipoAtivo)  # ACAO, FII, REIT, BOND, ETF, CRIPTO
    classe = Enum(ClasseAtivo)  # RENDA_VARIAVEL, RENDA_FIXA, CRIPTO
    mercado = String(10)  # BR, US, EUR
    moeda = String(3)  # BRL, USD, EUR
    preco_atual = Numeric(18, 6)
    data_ultima_cotacao = DateTime
    dividend_yield = Numeric(8, 4)
    p_l = Numeric(10, 2)
    p_vp = Numeric(10, 2)
    roe = Numeric(8, 4)
    ativo = Boolean
    deslistado = Boolean
    data_deslistagem = Date
    observacoes = Text
    created_at = DateTime
    updated_at = DateTime
```

### Filtros Dispon√≠veis

- `?page=1&per_page=20` - Pagina√ß√£o
- `?tipo=acao` - Filtrar por tipo (acao, fii, reit, etc)
- `?classe=renda_variavel` - Filtrar por classe
- `?mercado=BR` - Filtrar por mercado
- `?ativo=true` - Apenas ativos negoci√°veis
- `?deslistado=false` - Excluir deslistados
- `?search=PETR` - Busca textual (ticker ou nome)

### Exemplo de Busca por Ticker

**Request:**
```bash
curl -X GET "http://localhost:5000/api/ativos/ticker/PETR4?mercado=BR" \
  -H "Authorization: Bearer <token>"
```

**Response:**
```json
{
  "success": true,
  "message": "Dados do ativo",
  "data": {
    "id": "d2f6e058-2a32-470f-bd55-3573ad397690",
    "ticker": "PETR4",
    "nome": "Petrobras PN",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL",
    "preco_atual": "38.50",
    "ativo": true,
    "deslistado": false
  }
}
```

---

## üíº Fase 2.2.4 - CRUD Transa√ß√µes

### Endpoints

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| `GET` | `/api/transacoes` | Listar transa√ß√µes do usu√°rio | JWT |
| `GET` | `/api/transacoes/{id}` | Buscar transa√ß√£o por ID | JWT |
| `POST` | `/api/transacoes` | Criar transa√ß√£o | JWT |
| `PUT` | `/api/transacoes/{id}` | Atualizar transa√ß√£o | JWT |
| `DELETE` | `/api/transacoes/{id}` | Deletar transa√ß√£o | JWT |
| `GET` | `/api/transacoes/resumo/{ativo_id}` | Resumo por ativo | JWT |

### Model Transacao

```python
class Transacao(db.Model):
    __tablename__ = 'transacoes'

    id = UUID
    usuario_id = UUID (FK -> usuarios.id)
    ativo_id = UUID (FK -> ativos.id)
    corretora_id = UUID (FK -> corretoras.id)
    tipo = Enum(TipoTransacao)  # COMPRA, VENDA, DIVIDENDO, JCP, etc
    data_transacao = DateTime
    quantidade = Numeric(18, 8)
    preco_unitario = Numeric(18, 6)
    valor_total = Numeric(18, 2)  # quantidade * preco_unitario
    taxa_corretagem = Numeric(18, 2)
    emolumentos = Numeric(18, 2)
    taxa_liquidacao = Numeric(18, 2)
    imposto = Numeric(18, 2)
    outros_custos = Numeric(18, 2)
    custos_totais = Numeric(18, 2)  # soma de todas as taxas
    valor_liquido = Numeric(18, 2)  # valor_total +/- custos
    observacoes = Text
    created_at = DateTime
    updated_at = DateTime
```

### C√°lculos Autom√°ticos

O sistema calcula automaticamente:

1. **valor_total** = `quantidade √ó preco_unitario`
2. **custos_totais** = `taxa_corretagem + emolumentos + taxa_liquidacao + imposto + outros_custos`
3. **valor_liquido**:
   - COMPRA: `valor_total + custos_totais`
   - VENDA: `valor_total - custos_totais`
   - DIVIDENDO/JCP: `valor_total - imposto`

### Filtros Dispon√≠veis

- `?page=1&per_page=20` - Pagina√ß√£o
- `?tipo=compra` - Filtrar por tipo
- `?ativo_id={uuid}` - Filtrar por ativo
- `?corretora_id={uuid}` - Filtrar por corretora
- `?data_inicio=2025-01-01T00:00:00` - Data in√≠cio (ISO 8601)
- `?data_fim=2025-12-31T23:59:59` - Data fim (ISO 8601)

### Exemplo de Cria√ß√£o de Transa√ß√£o

**Request:**
```bash
curl -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "tipo": "compra",
    "ativo_id": "d2f6e058-2a32-470f-bd55-3573ad397690",
    "corretora_id": "73f2032d-59de-4af5-a1e7-0087e1793bf8",
    "data_transacao": "2025-12-01T10:30:00",
    "quantidade": "100",
    "preco_unitario": "38.50",
    "taxa_corretagem": "10.00",
    "emolumentos": "2.50",
    "imposto": "0.50"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Transa√ß√£o criada com sucesso",
  "data": {
    "id": "0188f968-b063-4423-a348-8fd012d7f34f",
    "tipo": "compra",
    "ativo": {
      "id": "d2f6e058-2a32-470f-bd55-3573ad397690",
      "ticker": "PETR4",
      "nome": "Petrobras PN"
    },
    "corretora": {
      "id": "73f2032d-59de-4af5-a1e7-0087e1793bf8",
      "nome": "Clear Corretora"
    },
    "quantidade": "100.00000000",
    "preco_unitario": "38.500000",
    "valor_total": "3850.00",
    "custos_totais": "13.00",
    "valor_liquido": "3863.00",
    "data_transacao": "2025-12-01T10:30:00+00:00"
  }
}
```

### Resumo por Ativo

**Request:**
```bash
curl -X GET "http://localhost:5000/api/transacoes/resumo/{ativo_id}" \
  -H "Authorization: Bearer <token>"
```

**Response:**
```json
{
  "success": true,
  "message": "Resumo do ativo",
  "data": {
    "quantidade_comprada": "100.00000000",
    "quantidade_vendida": "30.00000000",
    "quantidade_total": "70.00000000",
    "preco_medio": "38.65",
    "valor_investido": "3865.00",
    "valor_vendido": "1168.20"
  }
}
```

---

## üîí Seguran√ßa e Autentica√ß√£o

### Roles (Perfis de Usu√°rio)

- **ADMIN**: Acesso total ao sistema
- **USER**: Acesso aos pr√≥prios recursos
- **READONLY**: Apenas leitura

### Decorators de Autoriza√ß√£o

```python
@jwt_required()  # Requer JWT v√°lido
@admin_required  # Requer role ADMIN
@role_required(['ADMIN', 'USER'])  # Requer uma das roles
```

### Isolamento de Dados

- Cada usu√°rio acessa apenas **seus pr√≥prios recursos**
- Corretoras, transa√ß√µes e posi√ß√µes s√£o **filtradas por usuario_id**
- Admins podem acessar todos os recursos

---

## üìä Padr√£o de Respostas

### Sucesso (2xx)

```json
{
  "success": true,
  "message": "Mensagem descritiva",
  "data": { ... }
}
```

### Erro (4xx / 5xx)

```json
{
  "success": false,
  "message": "Descri√ß√£o do erro",
  "errors": { ... }  // Opcional (valida√ß√£o)
}
```

### Pagina√ß√£o

```json
{
  "success": true,
  "message": "Lista de recursos",
  "data": {
    "items": [ ... ],
    "total": 100,
    "pages": 5,
    "page": 1,
    "per_page": 20
  }
}
```

---

## üß™ Testes

### Scripts de Teste Dispon√≠veis

```bash
# Autentica√ß√£o
./backend/tests/test_auth.sh

# Usu√°rios
./backend/tests/test_usuarios_crud.sh

# Corretoras
./backend/tests/test_corretoras_crud.sh

# Ativos
./backend/tests/test_ativos_crud.sh

# Transa√ß√µes
./backend/tests/test_transacoes_crud.sh
```

### Executar Todos os Testes

```bash
for test in backend/tests/test_*.sh; do
  echo "Executando: $test"
  bash "$test"
  echo "---"
done
```

---

## üöÄ Deploy e Execu√ß√£o

### Iniciar Containers

```bash
./scripts/setup_containers.sh
```

### Rebuild Backend

```bash
cd backend && podman build -t exitus-backend:latest . && cd ..
```

### Popular Seeds

```bash
podman exec -it exitus-backend python -m app.seeds.seed_modulo2
```

### Verificar Status

```bash
podman ps
podman logs --tail 50 exitus-backend
```

### Health Check

```bash
curl http://localhost:5000/health
```

---

## üì¶ Depend√™ncias Principais

```
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-JWT-Extended==4.6.0
Flask-CORS==4.0.0
marshmallow==3.20.1
marshmallow-sqlalchemy==1.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
gunicorn==21.2.0
```

---

## üìã Checklist de Conclus√£o - M√≥dulo 2

- [x] **2.1 - Autentica√ß√£o JWT**
  - [x] Login com gera√ß√£o de tokens
  - [x] Refresh token
  - [x] Endpoint /me
  - [x] Decorators de autoriza√ß√£o

- [x] **2.2.1 - CRUD Usu√°rios**
  - [x] Model Usuario
  - [x] Schemas (Create, Update, Response)
  - [x] Service Layer
  - [x] Routes (6 endpoints)
  - [x] Testes completos

- [x] **2.2.2 - CRUD Corretoras**
  - [x] Model Corretora
  - [x] Schemas (Create, Update, Response)
  - [x] Service Layer
  - [x] Routes (6 endpoints)
  - [x] Filtros e pagina√ß√£o
  - [x] Testes completos

- [x] **2.2.3 - CRUD Ativos**
  - [x] Model Ativo
  - [x] Enums (TipoAtivo, ClasseAtivo)
  - [x] Schemas (Create, Update, Response)
  - [x] Service Layer
  - [x] Routes (7 endpoints)
  - [x] Busca por ticker
  - [x] Testes completos

- [x] **2.2.4 - CRUD Transa√ß√µes**
  - [x] Model Transacao
  - [x] Enum TipoTransacao
  - [x] Schemas (Create, Update, Response)
  - [x] Service Layer com c√°lculos autom√°ticos
  - [x] Routes (6 endpoints)
  - [x] Filtros por tipo, ativo, corretora, per√≠odo
  - [x] Endpoint de resumo por ativo
  - [x] Testes completos (15 cen√°rios)

---

## üéØ Pr√≥ximos Passos

**M√≥dulo 3 - C√°lculos e Posi√ß√µes:**
- C√°lculo autom√°tico de posi√ß√µes (holdings)
- Pre√ßo m√©dio ponderado
- Lucro/Preju√≠zo realizado e n√£o realizado
- Atualiza√ß√£o de cota√ß√µes em tempo real

---

## üìû Suporte e Contato

- **Desenvolvedor**: Sistema Exitus
- **Data de Conclus√£o**: 02/12/2025
- **Vers√£o**: 2.0.0
- **Status**: ‚úÖ Produ√ß√£o-Ready

---

**M√≥dulo 2 Completo! üéâ**

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo3_backend_financeiro.md ---
# M√ìDULO 3 - DOCUMENTA√á√ÉO T√âCNICA COMPLETA

**Sistema Exitus - Entidades Financeiras Avan√ßadas + Portfolio Analytics**

---

## üìë √çNDICE

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura](#arquitetura)
3. [Fase 3.1 - Posi√ß√µes](#fase-31---posi√ß√µes)
4. [Fase 3.2 - Proventos](#fase-32---proventos)
5. [Fase 3.3 - Movimenta√ß√£o de Caixa](#fase-33---movimenta√ß√£o-de-caixa)
6. [Fase 3.4 - Eventos Corporativos](#fase-34---eventos-corporativos)
7. [Fase 3.5 - Portfolio Analytics](#fase-35---portfolio-analytics)
8. [Integra√ß√µes](#integra√ß√µes)
9. [Exemplos de Uso](#exemplos-de-uso)
10. [Troubleshooting](#troubleshooting)

---

## VIS√ÉO GERAL

O M√≥dulo 3 implementa as funcionalidades avan√ßadas de gest√£o financeira do Exitus:

### Objetivos
- Calcular e gerenciar posi√ß√µes de investimento (holdings)
- Controlar proventos recebidos (dividendos, JCP, etc)
- Gerenciar movimenta√ß√µes de caixa entre corretoras
- Rastrear eventos corporativos (splits, bonifica√ß√µes, etc)
- Fornecer analytics avan√ßados de portf√≥lio

### Tecnologias
- **Backend:** Flask + SQLAlchemy
- **Valida√ß√£o:** Marshmallow
- **Autentica√ß√£o:** JWT
- **Banco de Dados:** PostgreSQL
- **Decimal:** Precis√£o em c√°lculos financeiros

---

## ARQUITETURA

### Camadas da Aplica√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           API REST (Flask)              ‚îÇ
‚îÇ  Blueprints: posicao, provento, etc.    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Schemas (Marshmallow)              ‚îÇ
‚îÇ  Valida√ß√£o e Serializa√ß√£o               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Services (L√≥gica)               ‚îÇ
‚îÇ  C√°lculos financeiros e regras          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       Models (SQLAlchemy)               ‚îÇ
‚îÇ  Posicao, Provento, MovimentacaoCaixa   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Banco de Dados (PostgreSQL)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Fluxo de Dados

1. **Transa√ß√µes** ‚Üí Geram **Posi√ß√µes**
2. **Posi√ß√µes** + **Pre√ßos Atuais** ‚Üí Calculam **Lucro/Preju√≠zo**
3. **Proventos** + **Posi√ß√µes** ‚Üí Calculam **Proventos Recebidos**
4. **Movimenta√ß√µes** ‚Üí Atualizam **Saldo das Corretoras**
5. **Eventos Corporativos** ‚Üí Ajustam **Posi√ß√µes**
6. **Tudo** ‚Üí Alimenta **Portfolio Analytics**

---

## FASE 3.1 - POSI√á√ïES

### Conceito

Posi√ß√µes representam os **holdings** do usu√°rio - quanto de cada ativo ele possui em cada corretora.

### Model: Posicao

```python
class Posicao(db.Model):
    id = UUID (PK)
    usuario_id = UUID (FK ‚Üí Usuario)
    ativo_id = UUID (FK ‚Üí Ativo)
    corretora_id = UUID (FK ‚Üí Corretora)

    quantidade = Decimal          # Quantidade de ativos
    preco_medio = Decimal          # Pre√ßo m√©dio de compra
    custo_total = Decimal          # Investimento total

    taxas_acumuladas = Decimal
    impostos_acumulados = Decimal

    valor_atual = Decimal          # Valor de mercado
    lucro_prejuizo_realizado = Decimal
    lucro_prejuizo_nao_realizado = Decimal

    data_primeira_compra = Date
    data_ultima_atualizacao = DateTime
```

### C√°lculos Principais

#### 1. Pre√ßo M√©dio Ponderado

```python
preco_medio = custo_total / quantidade
```

**Exemplo:**
- Compra 1: 10 a√ß√µes a R$ 20,00 = R$ 200,00
- Compra 2: 5 a√ß√µes a R$ 25,00 = R$ 125,00
- **Total:** 15 a√ß√µes custando R$ 325,00
- **Pre√ßo M√©dio:** R$ 325,00 / 15 = R$ 21,67

#### 2. Lucro/Preju√≠zo N√£o Realizado

```python
lucro_nao_realizado = (preco_atual * quantidade) - custo_total
```

**Exemplo:**
- Quantidade: 15 a√ß√µes
- Pre√ßo M√©dio: R$ 21,67
- Pre√ßo Atual: R$ 30,00
- Valor Atual: 15 √ó R$ 30,00 = R$ 450,00
- Custo Total: R$ 325,00
- **Lucro N√£o Realizado:** R$ 450,00 - R$ 325,00 = R$ 125,00

#### 3. Lucro/Preju√≠zo Realizado (Venda)

```python
lucro_realizado = (preco_venda * quantidade_vendida) - (preco_medio * quantidade_vendida)
```

**Exemplo:**
- Venda: 5 a√ß√µes a R$ 35,00 = R$ 175,00
- Custo dessas 5: 5 √ó R$ 21,67 = R$ 108,35
- **Lucro Realizado:** R$ 175,00 - R$ 108,35 = R$ 66,65

### Endpoints

#### GET /api/posicoes
Lista posi√ß√µes do usu√°rio

**Query Params:**
- `page` (int): P√°gina
- `per_page` (int): Itens por p√°gina
- `ativo_id` (UUID): Filtrar por ativo
- `corretora_id` (UUID): Filtrar por corretora
- `ticker` (str): Buscar por ticker
- `lucro_positivo` (bool): Apenas lucros

**Resposta:**
```json
{
  "success": true,
  "data": {
    "posicoes": [...],
    "total": 10,
    "page": 1,
    "pages": 2
  }
}
```

#### POST /api/posicoes/calcular
Recalcula todas as posi√ß√µes a partir das transa√ß√µes

**Resposta:**
```json
{
  "success": true,
  "data": {
    "posicoes_criadas": 3,
    "posicoes_atualizadas": 5,
    "posicoes_zeradas": 1
  }
}
```

#### GET /api/posicoes/resumo
Resumo consolidado do portf√≥lio

**Resposta:**
```json
{
  "success": true,
  "data": {
    "quantidade_posicoes": 8,
    "total_investido": 50000.00,
    "total_valor_atual": 62000.00,
    "total_lucro_realizado": 3500.00,
    "total_lucro_nao_realizado": 12000.00,
    "lucro_total": 15500.00,
    "roi_percentual": 31.0
  }
}
```

---

## FASE 3.2 - PROVENTOS

### Conceito

Proventos s√£o pagamentos feitos pelas empresas aos acionistas (dividendos, JCP, rendimentos).

### Model: Provento

```python
class Provento(db.Model):
    id = UUID (PK)
    ativo_id = UUID (FK ‚Üí Ativo)

    tipo_provento = Enum          # dividendo, jcp, rendimento, bonificacao
    valor_por_acao = Decimal
    quantidade_ativos = Decimal

    valor_bruto = Decimal
    imposto_retido = Decimal
    valor_liquido = Decimal

    data_com = Date               # Data COM (para ter direito)
    data_pagamento = Date
    observacoes = Text
```

### Tipos de Provento

1. **Dividendo:** Distribui√ß√£o de lucros (isento IR)
2. **JCP:** Juros sobre Capital Pr√≥prio (15% IR)
3. **Rendimento:** Rendimento de FIIs (isento IR)
4. **Bonifica√ß√£o:** Novas a√ß√µes gr√°tis
5. **Direito:** Direito de subscri√ß√£o

### C√°lculos

#### Provento Recebido por Usu√°rio

```python
valor_recebido = valor_por_acao √ó quantidade_possuida
```

**Exemplo:**
- Provento: R$ 0,50 por a√ß√£o
- Posi√ß√£o do usu√°rio: 100 a√ß√µes
- **Valor Bruto:** R$ 0,50 √ó 100 = R$ 50,00
- Se JCP (15% IR): **Valor L√≠quido:** R$ 50,00 √ó 0,85 = R$ 42,50

### Endpoints

#### GET /api/proventos
Lista proventos dispon√≠veis

#### GET /api/proventos/recebidos
Lista proventos que o usu√°rio recebeu

**Query Params:**
- `data_inicio` (YYYY-MM-DD)
- `data_fim` (YYYY-MM-DD)

**Resposta:**
```json
{
  "success": true,
  "data": {
    "proventos": [
      {
        "ativo": {"ticker": "PETR4", "nome": "Petrobras"},
        "tipo_provento": "dividendo",
        "valor_por_acao": "0.50",
        "quantidade_recebida": 100,
        "valor_bruto_recebido": 50.00,
        "valor_liquido_recebido": 50.00
      }
    ]
  }
}
```

#### GET /api/proventos/total-recebido
Total de proventos recebidos

**Resposta:**
```json
{
  "success": true,
  "data": {
    "total_geral_bruto": 5000.00,
    "total_geral_liquido": 4750.00,
    "por_tipo": {
      "dividendo": {
        "quantidade": 12,
        "valor_bruto": 3000.00,
        "valor_liquido": 3000.00
      },
      "jcp": {
        "quantidade": 5,
        "valor_bruto": 2000.00,
        "valor_liquido": 1700.00
      }
    }
  }
}
```

---

## FASE 3.3 - MOVIMENTA√á√ÉO DE CAIXA

### Conceito

Controla entrada e sa√≠da de dinheiro das corretoras (dep√≥sitos, saques, transfer√™ncias).

### Model: MovimentacaoCaixa

```python
class MovimentacaoCaixa(db.Model):
    id = UUID (PK)
    usuario_id = UUID (FK ‚Üí Usuario)
    corretora_id = UUID (FK ‚Üí Corretora)
    corretora_destino_id = UUID (FK ‚Üí Corretora, optional)
    provento_id = UUID (FK ‚Üí Provento, optional)

    tipo_movimentacao = Enum      # deposito, saque, transferencia, etc
    valor = Decimal
    moeda = String                # BRL, USD, EUR

    data_movimentacao = Date
    descricao = Text
    comprovante = String (URL)
```

### Tipos de Movimenta√ß√£o

1. **DEPOSITO:** Entrada de dinheiro (+)
2. **SAQUE:** Sa√≠da de dinheiro (-)
3. **TRANSFERENCIA_ENVIADA:** Envio para outra corretora (-)
4. **TRANSFERENCIA_RECEBIDA:** Recebimento de outra corretora (+)
5. **CREDITO_PROVENTO:** Recebimento de provento (+)
6. **PAGAMENTO_TAXA:** Pagamento de taxa (-)
7. **PAGAMENTO_IMPOSTO:** Pagamento de imposto (-)

### Impacto no Saldo

```python
@property
def impacto_saldo(self):
    if tipo in ['deposito', 'transferencia_recebida', 'credito_provento']:
        return +valor
    else:
        return -valor
```

### Endpoints

#### POST /api/movimentacoes-caixa
Criar movimenta√ß√£o

**Body:**
```json
{
  "corretora_id": "uuid",
  "tipo_movimentacao": "deposito",
  "valor": "1000.00",
  "moeda": "BRL",
  "data_movimentacao": "2025-12-02",
  "descricao": "Aporte mensal"
}
```

#### GET /api/movimentacoes-caixa/saldo/{corretora_id}
Saldo consolidado da corretora

**Resposta:**
```json
{
  "success": true,
  "data": {
    "saldos": {
      "BRL": 15000.00,
      "USD": 500.00
    }
  }
}
```

#### GET /api/movimentacoes-caixa/extrato
Extrato de movimenta√ß√µes

**Query Params:**
- `corretora_id` (UUID)
- `data_inicio` (YYYY-MM-DD)
- `data_fim` (YYYY-MM-DD)

**Resposta:**
```json
{
  "success": true,
  "data": {
    "extrato": [
      {
        "data": "2025-12-01",
        "tipo": "deposito",
        "valor": 1000.00,
        "impacto": 1000.00,
        "saldo_acumulado": 1000.00
      },
      {
        "data": "2025-12-02",
        "tipo": "saque",
        "valor": 200.00,
        "impacto": -200.00,
        "saldo_acumulado": 800.00
      }
    ]
  }
}
```

---

## FASE 3.4 - EVENTOS CORPORATIVOS

### Conceito

Eventos corporativos s√£o a√ß√µes das empresas que afetam as a√ß√µes (splits, bonifica√ß√µes, fus√µes).

### Model: EventoCorporativo

```python
class EventoCorporativo(db.Model):
    id = UUID (PK)
    ativo_id = UUID (FK ‚Üí Ativo)

    tipo_evento = Enum            # desdobramento, grupamento, etc
    descricao = Text

    data_anuncio = Date
    data_com = Date
    data_aprovacao = Date
    data_execucao = Date

    proporcao = String            # Ex: "2:1", "1:10"
    preco_subscricao = Decimal

    observacoes = Text
    url_informacao = String
```

### Tipos de Evento

1. **DESDOBRAMENTO (Split):** 1 a√ß√£o vira N a√ß√µes
2. **GRUPAMENTO (Reverse Split):** N a√ß√µes viram 1 a√ß√£o
3. **BONIFICACAO:** Novas a√ß√µes gr√°tis
4. **SUBSCRICAO:** Direito de comprar novas a√ß√µes
5. **INCORPORACAO:** Empresa A incorpora empresa B
6. **CISAO:** Empresa se divide em duas
7. **FUSAO:** Duas empresas se fundem
8. **MUDANCA_TICKER:** Mudan√ßa de c√≥digo de negocia√ß√£o

### C√°lculo de Impacto

#### Desdobramento (Split 2:1)

```python
nova_quantidade = quantidade_antiga √ó 2
novo_preco_medio = preco_medio_antigo / 2
```

**Exemplo:**
- Antes: 100 a√ß√µes a R$ 50,00
- Ap√≥s split 2:1: 200 a√ß√µes a R$ 25,00
- **Custo total permanece:** R$ 5.000,00

#### Grupamento (1:10)

```python
nova_quantidade = quantidade_antiga / 10
novo_preco_medio = preco_medio_antigo √ó 10
```

**Exemplo:**
- Antes: 1.000 a√ß√µes a R$ 1,00
- Ap√≥s grupamento 1:10: 100 a√ß√µes a R$ 10,00
- **Custo total permanece:** R$ 1.000,00

### Endpoints

#### GET /api/eventos-corporativos/meus-eventos
Eventos que afetam o usu√°rio

**Resposta:**
```json
{
  "success": true,
  "data": {
    "eventos": [
      {
        "ativo": {"ticker": "PETR4"},
        "tipo_evento": "desdobramento",
        "data_anuncio": "2025-11-15",
        "proporcao": "2:1",
        "quantidade_afetada": 100,
        "impacto_estimado": {
          "tipo": "aumento_quantidade",
          "nova_quantidade": 200,
          "diferenca": 100
        }
      }
    ]
  }
}
```

#### POST /api/eventos-corporativos/{id}/aplicar-split
Aplicar desdobramento/grupamento

**Resposta:**
```json
{
  "success": true,
  "data": {
    "posicoes_afetadas": 3,
    "tipo_evento": "desdobramento",
    "proporcao": "2:1"
  },
  "message": "Evento aplicado a 3 posi√ß√µes"
}
```

---

## FASE 3.5 - PORTFOLIO ANALYTICS

### Conceito

Analytics avan√ßados para an√°lise de performance e risco do portf√≥lio.

### M√©tricas Principais

#### 1. ROI (Return on Investment)

```python
roi = (lucro_total / investimento_total) √ó 100
```

#### 2. HHI (√çndice Herfindahl-Hirschman)

Mede concentra√ß√£o do portf√≥lio:

```python
hhi = Œ£ (percentual_ativo¬≤)
```

**Classifica√ß√£o:**
- HHI < 1500: Baixa concentra√ß√£o ‚úÖ
- 1500 ‚â§ HHI < 2500: Concentra√ß√£o moderada ‚ö†Ô∏è
- HHI ‚â• 2500: Alta concentra√ß√£o ‚ùå

**Exemplo:**
- Ativo A: 40% ‚Üí 40¬≤ = 1600
- Ativo B: 30% ‚Üí 30¬≤ = 900
- Ativo C: 20% ‚Üí 20¬≤ = 400
- Ativo D: 10% ‚Üí 10¬≤ = 100
- **HHI:** 1600 + 900 + 400 + 100 = 3000 (Alta concentra√ß√£o)

#### 3. Diversifica√ß√£o

- **Ideal:** 5-10 ativos diferentes
- **Bom:** 10-20 ativos
- **Muito diversificado:** >20 ativos

### Endpoints

#### GET /api/portfolio/dashboard
Dashboard completo

**Resposta:**
```json
{
  "success": true,
  "data": {
    "resumo_geral": {
      "total_investido": 50000.00,
      "valor_atual": 62000.00,
      "lucro_total": 12000.00,
      "roi_percentual": 24.0
    },
    "proventos": {...},
    "distribuicao_classes": {...},
    "top_posicoes": [...]
  }
}
```

#### GET /api/portfolio/distribuicao/classes
Distribui√ß√£o por classe

**Resposta:**
```json
{
  "success": true,
  "data": {
    "acao": {
      "valor": 40000.00,
      "percentual": 64.5,
      "quantidade_ativos": 10
    },
    "fii": {
      "valor": 15000.00,
      "percentual": 24.2,
      "quantidade_ativos": 5
    },
    "renda_fixa": {
      "valor": 7000.00,
      "percentual": 11.3,
      "quantidade_ativos": 3
    }
  }
}
```

#### GET /api/portfolio/metricas-risco
M√©tricas de risco

**Resposta:**
```json
{
  "success": true,
  "data": {
    "quantidade_ativos": 18,
    "maior_posicao": {
      "ticker": "PETR4",
      "percentual": 15.5
    },
    "hhi": 1250.5,
    "nivel_concentracao": "Baixa",
    "recomendacao": ["Portf√≥lio com boa diversifica√ß√£o"]
  }
}
```

#### GET /api/portfolio/performance
Performance dos ativos

**Resposta:**
```json
{
  "success": true,
  "data": {
    "ativos": [
      {
        "ticker": "PETR4",
        "quantidade": 100,
        "preco_medio": 25.50,
        "preco_atual": 35.00,
        "custo_total": 2550.00,
        "valor_atual": 3500.00,
        "lucro_prejuizo": 950.00,
        "roi_percentual": 37.25
      }
    ]
  }
}
```

---

## INTEGRA√á√ïES

### Fluxo Completo

```
1. Usu√°rio cria TRANSACAO (compra/venda)
   ‚Üì
2. Sistema calcula POSICAO automaticamente
   ‚Üì
3. Proventos s√£o lan√ßados (ADMIN)
   ‚Üì
4. Sistema calcula proventos RECEBIDOS baseado em POSICAO
   ‚Üì
5. Proventos geram MOVIMENTACAO_CAIXA (cr√©dito)
   ‚Üì
6. Eventos corporativos ajustam POSICAO
   ‚Üì
7. PORTFOLIO_ANALYTICS consolida tudo
```

### Depend√™ncias entre M√≥dulos

```
Posicao ‚Üê depende de ‚Üí Transacao (M√≥dulo 2)
Provento ‚Üí calcula com ‚Üí Posicao
MovimentacaoCaixa ‚Üê referencia ‚Üí Provento
EventoCorporativo ‚Üí modifica ‚Üí Posicao
Portfolio ‚Üí agrega ‚Üí Todos os acima
```

---

## EXEMPLOS DE USO

### Exemplo 1: Acompanhar Posi√ß√µes

```bash
# 1. Criar transa√ß√µes
curl -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"ativo_id":"...","tipo":"compra","quantidade":100}'

# 2. Recalcular posi√ß√µes
curl -X POST http://localhost:5000/api/posicoes/calcular \
  -H "Authorization: Bearer $TOKEN"

# 3. Ver resumo
curl http://localhost:5000/api/posicoes/resumo \
  -H "Authorization: Bearer $TOKEN"
```

### Exemplo 2: Consultar Proventos

```bash
# Ver proventos recebidos no √∫ltimo ano
curl "http://localhost:5000/api/proventos/recebidos?data_inicio=2024-01-01" \
  -H "Authorization: Bearer $TOKEN"

# Ver total recebido
curl http://localhost:5000/api/proventos/total-recebido \
  -H "Authorization: Bearer $TOKEN"
```

### Exemplo 3: Gest√£o de Caixa

```bash
# Fazer dep√≥sito
curl -X POST http://localhost:5000/api/movimentacoes-caixa \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "corretora_id":"uuid",
    "tipo_movimentacao":"deposito",
    "valor":"5000.00",
    "moeda":"BRL",
    "data_movimentacao":"2025-12-02"
  }'

# Ver saldo
curl http://localhost:5000/api/movimentacoes-caixa/saldo/{corretora_id} \
  -H "Authorization: Bearer $TOKEN"
```

### Exemplo 4: Dashboard Completo

```bash
# Ver dashboard
curl http://localhost:5000/api/portfolio/dashboard \
  -H "Authorization: Bearer $TOKEN"
```

---

## TROUBLESHOOTING

### Erro: Posi√ß√µes n√£o calculadas

**Sintoma:** GET /api/posicoes retorna vazio

**Solu√ß√£o:**
```bash
curl -X POST http://localhost:5000/api/posicoes/calcular \
  -H "Authorization: Bearer $TOKEN"
```

### Erro: Pre√ßo m√©dio incorreto

**Causa:** Transa√ß√µes antigas n√£o processadas

**Solu√ß√£o:** Recalcular todas as posi√ß√µes

### Erro: Proventos n√£o aparecem

**Causa:** Usu√°rio n√£o possui o ativo na data COM

**Verifica√ß√£o:** Conferir se possu√≠a o ativo na data_com do provento

### Erro: Saldo incorreto na corretora

**Causa:** Movimenta√ß√µes inconsistentes

**Solu√ß√£o:** Revisar extrato e corrigir movimenta√ß√µes

---

## CONCLUS√ÉO

O M√≥dulo 3 completa a estrutura financeira do Exitus, permitindo:

‚úÖ Controle completo de posi√ß√µes e holdings  
‚úÖ Acompanhamento de proventos recebidos  
‚úÖ Gest√£o de caixa entre corretoras  
‚úÖ Rastreamento de eventos corporativos  
‚úÖ Analytics avan√ßados de portf√≥lio  

**Pr√≥ximos passos:** Implementar M√≥dulo 4 (Frontend) para visualiza√ß√£o dos dados.

---

**Documenta√ß√£o gerada em:** 02/12/2025  
**Vers√£o:** 1.0  
**Sistema:** Exitus - Controle e An√°lise de Investimentos

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.development.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.production.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.staging.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/modulo0_fontes.txt ---
====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
!frontend/.env.example
!backend/.env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/all_git_files_concatenated.txt ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/test_module0.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/modulo1_fontes.txt ---
====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example*
!frontend/.env.*example*
!backend/.env.*example*
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.development.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.production.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.staging.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic.ini ---
# A generic, single database configuration.

[alembic]
# path to migration scripts
script_location = alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the
# "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:alembic/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
version_path_separator = os  # Use os.pathsep. Default configuration used for new projects.

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = driver://user:pass@localhost/dbname


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/README ---
Generic single-database configuration.
====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py ---
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# Adicionar path do app
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

# Importar a aplica√ß√£o Flask e o db
from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Criar aplica√ß√£o Flask e obter metadata
app = create_app()
with app.app_context():
    # Garantir que todos os models sejam importados
    from app.models import (
        Usuario, Corretora, Ativo, Posicao, Transacao,
        Provento, MovimentacaoCaixa, EventoCorporativo,
        FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
    )
    target_metadata = db.metadata
    
# Configurar URL do banco
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py.back ---
# backend/alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# ADICIONAR ESTAS LINHAS:
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ADICIONAR ESTA LINHA:
# Configurar a URL do banco a partir da aplica√ß√£o Flask
app = create_app()
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])

# add your model's MetaData object here
# SUBSTITUIR por:
target_metadata = db.metadata

# ... resto do arquivo permanece igual

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/script.py.mako ---
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/versions/b2542b2f7857_initial_schema_12_models.py ---
"""Initial schema - 12 models

Revision ID: b2542b2f7857
Revises: 
Create Date: 2025-11-26 19:40:34.891548

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b2542b2f7857'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do ativo'),
    sa.Column('ticker', sa.String(length=20), nullable=False, comment='C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome completo do ativo'),
    sa.Column('tipo', sa.Enum('ACAO', 'FII', 'REIT', 'BOND', 'ETF', 'CRIPTO', 'OUTRO', name='tipoativo'), nullable=False, comment='Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)'),
    sa.Column('classe', sa.Enum('RENDA_VARIAVEL', 'RENDA_FIXA', 'CRIPTO', 'HIBRIDO', name='classeativo'), nullable=False, comment='Classe do ativo (renda vari√°vel, fixa, cripto)'),
    sa.Column('mercado', sa.String(length=10), nullable=False, comment='Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='Moeda de negocia√ß√£o (BRL, USD, EUR)'),
    sa.Column('preco_atual', sa.Numeric(precision=18, scale=6), nullable=True, comment='Pre√ßo/cota√ß√£o atual do ativo'),
    sa.Column('data_ultima_cotacao', sa.DateTime(timezone=True), nullable=True, comment='Data e hora da √∫ltima cota√ß√£o'),
    sa.Column('dividend_yield', sa.Numeric(precision=8, scale=4), nullable=True, comment='Dividend Yield em % (ex: 6.5000 = 6.5%)'),
    sa.Column('p_l', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Lucro'),
    sa.Column('p_vp', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Valor Patrimonial'),
    sa.Column('roe', sa.Numeric(precision=8, scale=4), nullable=True, comment='Return on Equity em %'),
    sa.Column('ativo', sa.Boolean(), nullable=False, comment='Indica se ativo est√° dispon√≠vel para negocia√ß√£o'),
    sa.Column('deslistado', sa.Boolean(), nullable=False, comment='Indica se ativo foi deslistado da bolsa'),
    sa.Column('data_deslistagem', sa.Date(), nullable=True, comment='Data de deslistagem (se aplic√°vel)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas sobre o ativo'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='ativo_nome_min_length'),
    sa.CheckConstraint('length(ticker) >= 1', name='ativo_ticker_min_length'),
    sa.CheckConstraint('preco_atual IS NULL OR preco_atual >= 0', name='ativo_preco_positivo'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ticker', 'mercado', name='unique_ativo_ticker_mercado'),
    comment='Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'
    )
    op.create_index(op.f('ix_ativo_ativo'), 'ativo', ['ativo'], unique=False)
    op.create_index(op.f('ix_ativo_classe'), 'ativo', ['classe'], unique=False)
    op.create_index(op.f('ix_ativo_data_ultima_cotacao'), 'ativo', ['data_ultima_cotacao'], unique=False)
    op.create_index(op.f('ix_ativo_deslistado'), 'ativo', ['deslistado'], unique=False)
    op.create_index(op.f('ix_ativo_mercado'), 'ativo', ['mercado'], unique=False)
    op.create_index(op.f('ix_ativo_moeda'), 'ativo', ['moeda'], unique=False)
    op.create_index(op.f('ix_ativo_nome'), 'ativo', ['nome'], unique=False)
    op.create_index(op.f('ix_ativo_ticker'), 'ativo', ['ticker'], unique=False)
    op.create_index(op.f('ix_ativo_tipo'), 'ativo', ['tipo'], unique=False)
    op.create_table('feriado_mercado',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do feriado'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('mercado', sa.String(length=20), nullable=True, comment='Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos'),
    sa.Column('data_feriado', sa.Date(), nullable=False, comment='Data do feriado'),
    sa.Column('tipo_feriado', sa.Enum('NACIONAL', 'BOLSA', 'PONTE', 'FECHAMENTO_ANTECIPADO', 'MANUTENCAO', 'OUTRO', name='tipoferiado'), nullable=False, comment='Tipo do feriado'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome do feriado'),
    sa.Column('horario_fechamento', sa.Time(), nullable=True, comment='Hor√°rio de fechamento antecipado (se aplic√°vel)'),
    sa.Column('recorrente', sa.Boolean(), nullable=False, comment='Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o feriado'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='feriado_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 3', name='feriado_nome_min_length'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('pais', 'mercado', 'data_feriado', name='unique_feriado_pais_mercado_data'),
    comment='Tabela de feriados e dias sem preg√£o nos mercados'
    )
    op.create_index(op.f('ix_feriado_mercado_data_feriado'), 'feriado_mercado', ['data_feriado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_mercado'), 'feriado_mercado', ['mercado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_pais'), 'feriado_mercado', ['pais'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_recorrente'), 'feriado_mercado', ['recorrente'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_tipo_feriado'), 'feriado_mercado', ['tipo_feriado'], unique=False)
    op.create_table('fonte_dados',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da fonte'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da fonte de dados (ex: yfinance, Alpha Vantage)'),
    sa.Column('tipo_fonte', sa.Enum('API', 'SCRAPER', 'MANUAL', 'ARQUIVO', 'OUTRO', name='tipofontedados'), nullable=False, comment='Tipo da fonte de dados'),
    sa.Column('url_base', sa.String(length=500), nullable=True, comment='URL base da API ou site'),
    sa.Column('requer_autenticacao', sa.Boolean(), nullable=False, comment='Indica se requer chave API ou autentica√ß√£o'),
    sa.Column('rate_limit', sa.String(length=50), nullable=True, comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se fonte est√° ativa'),
    sa.Column('prioridade', sa.Integer(), nullable=False, comment='Ordem de prioridade (1 = maior prioridade)'),
    sa.Column('ultima_consulta', sa.DateTime(timezone=True), nullable=True, comment='Timestamp da √∫ltima consulta bem-sucedida'),
    sa.Column('total_consultas', sa.Integer(), nullable=False, comment='Total de consultas realizadas'),
    sa.Column('total_erros', sa.Integer(), nullable=False, comment='Total de erros encontrados'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a fonte de dados'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='fonte_nome_min_length'),
    sa.CheckConstraint('prioridade > 0', name='fonte_prioridade_positiva'),
    sa.CheckConstraint('total_consultas >= 0', name='fonte_consultas_positivas'),
    sa.CheckConstraint('total_erros >= 0', name='fonte_erros_positivos'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de fontes de dados externas (APIs, scrapers)'
    )
    op.create_index(op.f('ix_fonte_dados_ativa'), 'fonte_dados', ['ativa'], unique=False)
    op.create_index(op.f('ix_fonte_dados_nome'), 'fonte_dados', ['nome'], unique=True)
    op.create_index(op.f('ix_fonte_dados_prioridade'), 'fonte_dados', ['prioridade'], unique=False)
    op.create_index(op.f('ix_fonte_dados_tipo_fonte'), 'fonte_dados', ['tipo_fonte'], unique=False)
    op.create_index(op.f('ix_fonte_dados_ultima_consulta'), 'fonte_dados', ['ultima_consulta'], unique=False)
    op.create_table('regra_fiscal',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da regra'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('tipo_ativo', sa.String(length=20), nullable=True, comment='Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos'),
    sa.Column('tipo_operacao', sa.String(length=20), nullable=True, comment='Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas'),
    sa.Column('aliquota_ir', sa.Numeric(precision=6, scale=4), nullable=False, comment='Al√≠quota de IR em % (ex: 15.0000 = 15%)'),
    sa.Column('valor_isencao', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)'),
    sa.Column('incide_sobre', sa.Enum('LUCRO', 'RECEITA', 'PROVENTO', 'OPERACAO', name='incidenciaimposto'), nullable=False, comment='Sobre o que incide o imposto'),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada da regra fiscal'),
    sa.Column('vigencia_inicio', sa.Date(), nullable=False, comment='Data de in√≠cio da vig√™ncia da regra'),
    sa.Column('vigencia_fim', sa.Date(), nullable=True, comment='Data de fim da vig√™ncia (NULL = vigente indefinidamente)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se regra est√° ativa'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='regra_pais_iso_format'),
    sa.CheckConstraint('aliquota_ir >= 0 AND aliquota_ir <= 100', name='regra_aliquota_valida'),
    sa.CheckConstraint('valor_isencao IS NULL OR valor_isencao >= 0', name='regra_isencao_positiva'),
    sa.CheckConstraint('vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio', name='regra_vigencia_valida'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'
    )
    op.create_index(op.f('ix_regra_fiscal_ativa'), 'regra_fiscal', ['ativa'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_incide_sobre'), 'regra_fiscal', ['incide_sobre'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_pais'), 'regra_fiscal', ['pais'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_ativo'), 'regra_fiscal', ['tipo_ativo'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_operacao'), 'regra_fiscal', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_fim'), 'regra_fiscal', ['vigencia_fim'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_inicio'), 'regra_fiscal', ['vigencia_inicio'], unique=False)
    op.create_table('usuario',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('nome_completo', sa.String(length=200), nullable=True),
    sa.Column('ativo', sa.Boolean(), nullable=False),
    sa.Column('role', sa.Enum('ADMIN', 'USER', 'READONLY', name='userrole'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_usuario_email'), 'usuario', ['email'], unique=True)
    op.create_index(op.f('ix_usuario_username'), 'usuario', ['username'], unique=True)
    op.create_table('corretora',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da corretora'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da corretora/exchange (ex: XP, Clear, Binance)'),
    sa.Column('tipo', sa.Enum('CORRETORA', 'EXCHANGE', name='tipocorretora'), nullable=False, comment='Tipo: corretora tradicional ou exchange cripto'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)'),
    sa.Column('moeda_padrao', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('saldo_atual', sa.Numeric(precision=18, scale=2), nullable=False, comment='Saldo dispon√≠vel em caixa (na moeda padr√£o)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se conta est√° ativa'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas do usu√°rio sobre a conta'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("moeda_padrao ~* '^[A-Z]{3}$'", name='corretora_moeda_iso_format'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='corretora_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 2', name='corretora_nome_min_length'),
    sa.CheckConstraint('saldo_atual >= 0', name='corretora_saldo_positivo'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'nome', 'pais', name='unique_corretora_usuario_nome_pais'),
    comment='Tabela de corretoras e contas de investimento'
    )
    op.create_index(op.f('ix_corretora_ativa'), 'corretora', ['ativa'], unique=False)
    op.create_index(op.f('ix_corretora_moeda_padrao'), 'corretora', ['moeda_padrao'], unique=False)
    op.create_index(op.f('ix_corretora_nome'), 'corretora', ['nome'], unique=False)
    op.create_index(op.f('ix_corretora_pais'), 'corretora', ['pais'], unique=False)
    op.create_index(op.f('ix_corretora_tipo'), 'corretora', ['tipo'], unique=False)
    op.create_index(op.f('ix_corretora_usuario_id'), 'corretora', ['usuario_id'], unique=False)
    op.create_table('evento_corporativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do evento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo afetado pelo evento'),
    sa.Column('ativo_novo_id', sa.UUID(), nullable=True, comment='ID do novo ativo (fus√µes, mudan√ßas de ticker)'),
    sa.Column('tipo_evento', sa.Enum('SPLIT', 'GRUPAMENTO', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'FUSAO', 'CISAO', 'INCORPORACAO', 'MUDANCA_TICKER', 'DESLISTAGEM', 'RELISTING', 'CANCELAMENTO', 'OUTRO', name='tipoeventocorporativo'), nullable=False, comment='Tipo do evento corporativo'),
    sa.Column('data_evento', sa.Date(), nullable=False, comment='Data do evento'),
    sa.Column('data_com', sa.Date(), nullable=True, comment='Data COM (√∫ltimo dia para ter direito ao evento)'),
    sa.Column('proporcao', sa.String(length=20), nullable=True, comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada do evento'),
    sa.Column('impacto_posicoes', sa.Boolean(), nullable=False, comment='Indica se as posi√ß√µes j√° foram ajustadas'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes adicionais sobre o evento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)\n            OR \n            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))\n            ", name='evento_proporcao_obrigatoria'),
    sa.CheckConstraint('data_com IS NULL OR data_com <= data_evento', name='evento_data_com_valida'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['ativo_novo_id'], ['ativo.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de eventos corporativos que afetam ativos'
    )
    op.create_index(op.f('ix_evento_corporativo_ativo_id'), 'evento_corporativo', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_ativo_novo_id'), 'evento_corporativo', ['ativo_novo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_com'), 'evento_corporativo', ['data_com'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_evento'), 'evento_corporativo', ['data_evento'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_impacto_posicoes'), 'evento_corporativo', ['impacto_posicoes'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_tipo_evento'), 'evento_corporativo', ['tipo_evento'], unique=False)
    op.create_table('log_auditoria',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do log'),
    sa.Column('usuario_id', sa.UUID(), nullable=True, comment='ID do usu√°rio (NULL para a√ß√µes an√¥nimas)'),
    sa.Column('acao', sa.String(length=50), nullable=False, comment='Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)'),
    sa.Column('entidade', sa.String(length=100), nullable=True, comment='Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)'),
    sa.Column('entidade_id', sa.UUID(), nullable=True, comment='ID do registro afetado'),
    sa.Column('dados_antes', sa.JSON(), nullable=True, comment='Estado anterior do registro (JSON)'),
    sa.Column('dados_depois', sa.JSON(), nullable=True, comment='Estado posterior do registro (JSON)'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='Endere√ßo IP de origem'),
    sa.Column('user_agent', sa.String(length=500), nullable=True, comment='User-Agent (navegador/cliente)'),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False, comment='Data/hora da a√ß√£o'),
    sa.Column('sucesso', sa.Boolean(), nullable=False, comment='Indica se a√ß√£o foi bem-sucedida'),
    sa.Column('mensagem', sa.Text(), nullable=True, comment='Mensagem de erro ou detalhes adicionais'),
    sa.CheckConstraint('length(acao) >= 3', name='log_acao_min_length'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de logs de auditoria para compliance'
    )
    op.create_index(op.f('ix_log_auditoria_acao'), 'log_auditoria', ['acao'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade'), 'log_auditoria', ['entidade'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade_id'), 'log_auditoria', ['entidade_id'], unique=False)
    op.create_index(op.f('ix_log_auditoria_ip_address'), 'log_auditoria', ['ip_address'], unique=False)
    op.create_index(op.f('ix_log_auditoria_sucesso'), 'log_auditoria', ['sucesso'], unique=False)
    op.create_index(op.f('ix_log_auditoria_timestamp'), 'log_auditoria', ['timestamp'], unique=False)
    op.create_index(op.f('ix_log_auditoria_usuario_id'), 'log_auditoria', ['usuario_id'], unique=False)
    op.create_table('provento',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do provento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo que pagou o provento'),
    sa.Column('tipo_provento', sa.Enum('DIVIDENDO', 'JCP', 'RENDIMENTO', 'CUPOM', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'OUTRO', name='tipoprovento'), nullable=False, comment='Tipo do provento (dividendo, JCP, rendimento, etc.)'),
    sa.Column('valor_por_acao', sa.Numeric(precision=18, scale=6), nullable=False, comment='Valor unit√°rio por ativo'),
    sa.Column('quantidade_ativos', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos que geraram o provento'),
    sa.Column('valor_bruto', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor bruto recebido'),
    sa.Column('imposto_retido', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte'),
    sa.Column('valor_liquido', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor l√≠quido creditado'),
    sa.Column('data_com', sa.Date(), nullable=False, comment='Data COM (√∫ltimo dia para ter direito ao provento)'),
    sa.Column('data_pagamento', sa.Date(), nullable=False, comment='Data efetiva do pagamento'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o provento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_pagamento >= data_com', name='provento_data_pagamento_valida'),
    sa.CheckConstraint('imposto_retido >= 0', name='provento_imposto_positivo'),
    sa.CheckConstraint('quantidade_ativos > 0', name='provento_quantidade_positiva'),
    sa.CheckConstraint('valor_bruto > 0', name='provento_valor_bruto_positivo'),
    sa.CheckConstraint('valor_liquido <= valor_bruto', name='provento_liquido_menor_bruto'),
    sa.CheckConstraint('valor_liquido > 0', name='provento_valor_liquido_positivo'),
    sa.CheckConstraint('valor_por_acao > 0', name='provento_valor_por_acao_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de proventos recebidos (dividendos, JCP, rendimentos)'
    )
    op.create_index(op.f('ix_provento_ativo_id'), 'provento', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_provento_data_com'), 'provento', ['data_com'], unique=False)
    op.create_index(op.f('ix_provento_data_pagamento'), 'provento', ['data_pagamento'], unique=False)
    op.create_index(op.f('ix_provento_tipo_provento'), 'provento', ['tipo_provento'], unique=False)
    op.create_table('movimentacao_caixa',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da movimenta√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora (origem)'),
    sa.Column('corretora_destino_id', sa.UUID(), nullable=True, comment='ID da corretora destino (apenas para transfer√™ncias)'),
    sa.Column('provento_id', sa.UUID(), nullable=True, comment='ID do provento (apenas para cr√©dito de provento)'),
    sa.Column('tipo_movimentacao', sa.Enum('DEPOSITO', 'SAQUE', 'TRANSFERENCIA_ENVIADA', 'TRANSFERENCIA_RECEBIDA', 'CREDITO_PROVENTO', 'PAGAMENTO_TAXA', 'PAGAMENTO_IMPOSTO', 'AJUSTE', 'OUTRO', name='tipomovimentacao'), nullable=False, comment='Tipo da movimenta√ß√£o'),
    sa.Column('valor', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor da movimenta√ß√£o'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('data_movimentacao', sa.Date(), nullable=False, comment='Data da movimenta√ß√£o'),
    sa.Column('descricao', sa.Text(), nullable=True, comment='Descri√ß√£o da movimenta√ß√£o'),
    sa.Column('comprovante', sa.String(length=200), nullable=True, comment='Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)\n            OR \n            (tipo_movimentacao != 'credito_provento')\n            ", name='movimentacao_credito_tem_provento'),
    #sa.CheckConstraint("\n            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') \n             AND corretora_destino_id IS NOT NULL)\n            OR \n            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))\n            ", name='movimentacao_transferencia_tem_destino'),
    sa.CheckConstraint("moeda ~* '^[A-Z]{3}$'", name='movimentacao_moeda_iso_format'),
    sa.CheckConstraint('valor > 0', name='movimentacao_valor_positivo'),
    sa.ForeignKeyConstraint(['corretora_destino_id'], ['corretora.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provento_id'], ['provento.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de movimenta√ß√µes de caixa em corretoras'
    )
    op.create_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), 'movimentacao_caixa', ['corretora_destino_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_corretora_id'), 'movimentacao_caixa', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_data_movimentacao'), 'movimentacao_caixa', ['data_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_moeda'), 'movimentacao_caixa', ['moeda'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_provento_id'), 'movimentacao_caixa', ['provento_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), 'movimentacao_caixa', ['tipo_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_usuario_id'), 'movimentacao_caixa', ['usuario_id'], unique=False)
    op.create_table('posicao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da posi√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora onde est√° a posi√ß√£o'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos (suporta fracion√°rios)'),
    sa.Column('preco_medio', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo m√©dio de aquisi√ß√£o'),
    sa.Column('custo_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Custo total investido (quantidade * pre√ßo m√©dio)'),
    sa.Column('taxas_acumuladas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem e cust√≥dia acumuladas'),
    sa.Column('impostos_acumulados', sa.Numeric(precision=18, scale=2), nullable=False, comment='Impostos pagos acumulados (IR, IOF, etc.)'),
    sa.Column('valor_atual', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de mercado atual da posi√ß√£o'),
    sa.Column('lucro_prejuizo_realizado', sa.Numeric(precision=18, scale=2), nullable=False, comment='Lucro/preju√≠zo realizado em vendas'),
    sa.Column('lucro_prejuizo_nao_realizado', sa.Numeric(precision=18, scale=2), nullable=True, comment='Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)'),
    sa.Column('data_primeira_compra', sa.Date(), nullable=True, comment='Data da primeira aquisi√ß√£o deste ativo'),
    sa.Column('data_ultima_atualizacao', sa.DateTime(timezone=True), nullable=True, comment='Data da √∫ltima atualiza√ß√£o de valores'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('custo_total >= 0', name='posicao_custo_total_positivo'),
    sa.CheckConstraint('impostos_acumulados >= 0', name='posicao_impostos_positivos'),
    sa.CheckConstraint('preco_medio >= 0', name='posicao_preco_medio_positivo'),
    sa.CheckConstraint('quantidade >= 0', name='posicao_quantidade_positiva'),
    sa.CheckConstraint('taxas_acumuladas >= 0', name='posicao_taxas_positivas'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'corretora_id', 'ativo_id', name='unique_posicao_usuario_corretora_ativo'),
    comment='Tabela de posi√ß√µes em carteira (holdings)'
    )
    op.create_index(op.f('ix_posicao_ativo_id'), 'posicao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_posicao_corretora_id'), 'posicao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_posicao_data_primeira_compra'), 'posicao', ['data_primeira_compra'], unique=False)
    op.create_index(op.f('ix_posicao_data_ultima_atualizacao'), 'posicao', ['data_ultima_atualizacao'], unique=False)
    op.create_index(op.f('ix_posicao_usuario_id'), 'posicao', ['usuario_id'], unique=False)
    op.create_table('transacao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da transa√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo transacionado'),
    sa.Column('tipo_operacao', sa.Enum('COMPRA', 'VENDA', name='tipooperacao'), nullable=False, comment='Tipo de opera√ß√£o: COMPRA ou VENDA'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade transacionada (suporta fracion√°rios)'),
    sa.Column('preco_unitario', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo por unidade'),
    sa.Column('valor_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor total da opera√ß√£o (quantidade * pre√ßo)'),
    sa.Column('taxas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem, cust√≥dia, emolumentos'),
    sa.Column('impostos', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte, IOF, etc.'),
    sa.Column('data_operacao', sa.Date(), nullable=False, comment='Data da opera√ß√£o'),
    sa.Column('data_liquidacao', sa.Date(), nullable=True, comment='Data de liquida√ß√£o (D+2, D+3, etc.)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a transa√ß√£o'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_liquidacao IS NULL OR data_liquidacao >= data_operacao', name='transacao_data_liquidacao_valida'),
    sa.CheckConstraint('impostos >= 0', name='transacao_impostos_positivos'),
    sa.CheckConstraint('preco_unitario > 0', name='transacao_preco_positivo'),
    sa.CheckConstraint('quantidade > 0', name='transacao_quantidade_positiva'),
    sa.CheckConstraint('taxas >= 0', name='transacao_taxas_positivas'),
    sa.CheckConstraint('valor_total > 0', name='transacao_valor_total_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de transa√ß√µes de compra e venda de ativos'
    )
    op.create_index(op.f('ix_transacao_ativo_id'), 'transacao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_transacao_corretora_id'), 'transacao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_transacao_data_liquidacao'), 'transacao', ['data_liquidacao'], unique=False)
    op.create_index(op.f('ix_transacao_data_operacao'), 'transacao', ['data_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_tipo_operacao'), 'transacao', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_usuario_id'), 'transacao', ['usuario_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_transacao_usuario_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_tipo_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_liquidacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_corretora_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_ativo_id'), table_name='transacao')
    op.drop_table('transacao')
    op.drop_index(op.f('ix_posicao_usuario_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_ultima_atualizacao'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_primeira_compra'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_corretora_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_ativo_id'), table_name='posicao')
    op.drop_table('posicao')
    op.drop_index(op.f('ix_movimentacao_caixa_usuario_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_provento_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_moeda'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_data_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), table_name='movimentacao_caixa')
    op.drop_table('movimentacao_caixa')
    op.drop_index(op.f('ix_provento_tipo_provento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_pagamento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_com'), table_name='provento')
    op.drop_index(op.f('ix_provento_ativo_id'), table_name='provento')
    op.drop_table('provento')
    op.drop_index(op.f('ix_log_auditoria_usuario_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_timestamp'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_sucesso'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_ip_address'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_acao'), table_name='log_auditoria')
    op.drop_table('log_auditoria')
    op.drop_index(op.f('ix_evento_corporativo_tipo_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_impacto_posicoes'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_com'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_novo_id'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_id'), table_name='evento_corporativo')
    op.drop_table('evento_corporativo')
    op.drop_index(op.f('ix_corretora_usuario_id'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_tipo'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_pais'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_nome'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_moeda_padrao'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_ativa'), table_name='corretora')
    op.drop_table('corretora')
    op.drop_index(op.f('ix_usuario_username'), table_name='usuario')
    op.drop_index(op.f('ix_usuario_email'), table_name='usuario')
    op.drop_table('usuario')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_inicio'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_fim'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_operacao'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_ativo'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_pais'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_incide_sobre'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_ativa'), table_name='regra_fiscal')
    op.drop_table('regra_fiscal')
    op.drop_index(op.f('ix_fonte_dados_ultima_consulta'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_tipo_fonte'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_prioridade'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_nome'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_ativa'), table_name='fonte_dados')
    op.drop_table('fonte_dados')
    op.drop_index(op.f('ix_feriado_mercado_tipo_feriado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_recorrente'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_pais'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_mercado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_data_feriado'), table_name='feriado_mercado')
    op.drop_table('feriado_mercado')
    op.drop_index(op.f('ix_ativo_tipo'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ticker'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_nome'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_moeda'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_mercado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_deslistado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_data_ultima_cotacao'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_classe'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ativo'), table_name='ativo')
    op.drop_table('ativo')
    # ### end Alembic commands ###

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config
from .database import init_db


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)
    
    # Inicializa banco de dados
    init_db(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models para que Alembic os detecte
        from app.models import (
            Usuario, UserRole,
            Corretora, TipoCorretora,
            Ativo, TipoAtivo, ClasseAtivo,
            Posicao,
            Transacao, TipoOperacao,
            Provento, TipoProvento,
            MovimentacaoCaixa, TipoMovimentacao,
            EventoCorporativo, TipoEventoCorporativo,
            FonteDados, TipoFonteDados,
            RegraFiscal, IncidenciaImposto,
            FeriadoMercado, TipoFeriado,
            LogAuditoria
        )
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models (apenas quando existirem)
        # COMENTADO at√© criarmos os models na Fase 2
        # from app.models import (
        #     usuario, corretora, ativo, posicao, transacao,
        #     provento, movimentacao_caixa, evento_corporativo,
        #     fonte_dados, regra_fiscal, feriado_mercado, log_auditoria
        # )
        pass
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - Models Package"""

from app.database import db

# Importar models criados
from .usuario import Usuario, UserRole
from .corretora import Corretora, TipoCorretora
from .ativo import Ativo, TipoAtivo, ClasseAtivo
from .posicao import Posicao
from .transacao import Transacao, TipoOperacao
from .provento import Provento, TipoProvento
from .movimentacao_caixa import MovimentacaoCaixa, TipoMovimentacao
from .evento_corporativo import EventoCorporativo, TipoEventoCorporativo
from .fonte_dados import FonteDados, TipoFonteDados
from .regra_fiscal import RegraFiscal, IncidenciaImposto
from .feriado_mercado import FeriadoMercado, TipoFeriado
from .log_auditoria import LogAuditoria

# Exportar para facilitar imports
__all__ = [
    'db',
    'Usuario',
    'UserRole',
    'Corretora',
    'TipoCorretora',
    'Ativo',
    'TipoAtivo',
    'ClasseAtivo',
    'Posicao',
    'Transacao',
    'TipoOperacao',
    'Provento',
    'TipoProvento',
    'MovimentacaoCaixa',
    'TipoMovimentacao',
    'EventoCorporativo',
    'TipoEventoCorporativo',
    'FonteDados',
    'TipoFonteDados',
    'RegraFiscal',
    'IncidenciaImposto',
    'FeriadoMercado',
    'TipoFeriado',
    'LogAuditoria'
]

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/ativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Ativo
Entidade para instrumentos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoAtivo(enum.Enum):
    """Enum para tipos de ativo"""
    ACAO = "acao"              # A√ß√£o
    FII = "fii"                # Fundo Imobili√°rio
    REIT = "reit"              # Real Estate Investment Trust
    BOND = "bond"              # T√≠tulo de renda fixa
    ETF = "etf"                # Exchange Traded Fund
    CRIPTO = "cripto"          # Criptomoeda
    OUTRO = "outro"            # Outros tipos


class ClasseAtivo(enum.Enum):
    """Enum para classes de ativo"""
    RENDA_VARIAVEL = "renda_variavel"
    RENDA_FIXA = "renda_fixa"
    CRIPTO = "cripto"
    HIBRIDO = "hibrido"


class Ativo(db.Model):
    """
    Model para ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)
    
    Attributes:
        id (UUID): Identificador √∫nico
        ticker (str): C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL)
        nome (str): Nome completo do ativo
        tipo (TipoAtivo): Tipo do ativo
        classe (ClasseAtivo): Classe do ativo
        mercado (str): Mercado/pa√≠s (BR, US, EUR)
        moeda (str): Moeda de negocia√ß√£o (BRL, USD, EUR)
        preco_atual (Decimal): Pre√ßo/cota√ß√£o atual
        data_ultima_cotacao (datetime): Data da √∫ltima cota√ß√£o
        dividend_yield (Decimal): Dividend Yield (%)
        p_l (Decimal): √çndice Pre√ßo/Lucro
        p_vp (Decimal): √çndice Pre√ßo/Valor Patrimonial
        roe (Decimal): Return on Equity (%)
        ativo (bool): Indica se ativo est√° ativo para negocia√ß√£o
        deslistado (bool): Indica se foi deslistado da bolsa
        data_deslistagem (date): Data de deslistagem (se aplic√°vel)
        observacoes (str): Observa√ß√µes gerais
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        posicoes: Posi√ß√µes deste ativo nos portfolios
        transacoes: Transa√ß√µes realizadas com este ativo
        proventos: Proventos distribu√≠dos por este ativo
        eventos_corporativos: Eventos corporativos deste ativo
    """
    
    __tablename__ = 'ativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do ativo"
    )
    
    # Identifica√ß√£o do ativo
    ticker = db.Column(
        String(20),
        nullable=False,
        index=True,
        comment="C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        index=True,
        comment="Nome completo do ativo"
    )
    
    tipo = db.Column(
        Enum(TipoAtivo),
        nullable=False,
        index=True,
        comment="Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)"
    )
    
    classe = db.Column(
        Enum(ClasseAtivo),
        nullable=False,
        index=True,
        comment="Classe do ativo (renda vari√°vel, fixa, cripto)"
    )
    
    # Mercado e moeda
    mercado = db.Column(
        String(10),
        nullable=False,
        default='BR',
        index=True,
        comment="Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="Moeda de negocia√ß√£o (BRL, USD, EUR)"
    )
    
    # Cota√ß√£o
    preco_atual = db.Column(
        Numeric(precision=18, scale=6),
        nullable=True,
        comment="Pre√ßo/cota√ß√£o atual do ativo"
    )
    
    data_ultima_cotacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data e hora da √∫ltima cota√ß√£o"
    )
    
    # Indicadores financeiros
    dividend_yield = db.Column(
        Numeric(precision=8, scale=4),
        nullable=True,
        comment="Dividend Yield em % (ex: 6.5000 = 6.5%)"
    )
    
    p_l = db.Column(
        Numeric(precision=10, scale=2),
        nullable=True,
        comment="√çndice Pre√ßo/Lucro"
    )
    
    p_vp = db.Column(
        Numeric(precision=10, scale=2),
        nullable=True,
        comment="√çndice Pre√ßo/Valor Patrimonial"
    )
    
    roe = db.Column(
        Numeric(precision=8, scale=4),
        nullable=True,
        comment="Return on Equity em %"
    )
    
    # Status
    ativo = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se ativo est√° dispon√≠vel para negocia√ß√£o"
    )
    
    deslistado = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se ativo foi deslistado da bolsa"
    )
    
    data_deslistagem = db.Column(
        Date,
        nullable=True,
        comment="Data de deslistagem (se aplic√°vel)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes e notas sobre o ativo"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos futuros (descomentar quando criar os models)
    # posicoes = relationship('Posicao', back_populates='ativo', lazy='dynamic')
    # transacoes = relationship('Transacao', back_populates='ativo', lazy='dynamic')
    # proventos = relationship('Provento', back_populates='ativo', lazy='dynamic')
    # eventos_corporativos = relationship('EventoCorporativo', back_populates='ativo', lazy='dynamic')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "preco_atual IS NULL OR preco_atual >= 0",
            name="ativo_preco_positivo"
        ),
        db.CheckConstraint(
            "length(ticker) >= 1",
            name="ativo_ticker_min_length"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="ativo_nome_min_length"
        ),
        db.UniqueConstraint(
            'ticker', 'mercado',
            name='unique_ativo_ticker_mercado'
        ),
        {'comment': 'Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'}
    )
    
    def is_active(self):
        """Verifica se ativo est√° ativo"""
        return self.ativo and not self.deslistado
    
    def is_renda_fixa(self):
        """Verifica se √© ativo de renda fixa"""
        return self.classe == ClasseAtivo.RENDA_FIXA
    
    def is_renda_variavel(self):
        """Verifica se √© ativo de renda vari√°vel"""
        return self.classe == ClasseAtivo.RENDA_VARIAVEL
    
    def is_cripto(self):
        """Verifica se √© criptomoeda"""
        return self.tipo == TipoAtivo.CRIPTO or self.classe == ClasseAtivo.CRIPTO
    
    def atualizar_cotacao(self, preco, data_cotacao=None):
        """
        Atualiza a cota√ß√£o do ativo
        
        Args:
            preco (Decimal): Novo pre√ßo
            data_cotacao (datetime): Data da cota√ß√£o (default: agora)
        
        Raises:
            ValueError: Se pre√ßo for negativo
        """
        if preco < 0:
            raise ValueError(f"Pre√ßo n√£o pode ser negativo: {preco}")
        
        self.preco_atual = preco
        self.data_ultima_cotacao = data_cotacao or datetime.utcnow()
    
    def atualizar_indicadores(self, dy=None, pl=None, pvp=None, roe_value=None):
        """
        Atualiza indicadores financeiros do ativo
        
        Args:
            dy (Decimal): Dividend Yield
            pl (Decimal): √çndice P/L
            pvp (Decimal): √çndice P/VP
            roe_value (Decimal): ROE
        """
        if dy is not None:
            self.dividend_yield = dy
        if pl is not None:
            self.p_l = pl
        if pvp is not None:
            self.p_vp = pvp
        if roe_value is not None:
            self.roe = roe_value
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do ativo
        """
        return {
            'id': str(self.id),
            'ticker': self.ticker,
            'nome': self.nome,
            'tipo': self.tipo.value if self.tipo else None,
            'classe': self.classe.value if self.classe else None,
            'mercado': self.mercado,
            'moeda': self.moeda,
            'preco_atual': float(self.preco_atual) if self.preco_atual else None,
            'data_ultima_cotacao': self.data_ultima_cotacao.isoformat() if self.data_ultima_cotacao else None,
            'dividend_yield': float(self.dividend_yield) if self.dividend_yield else None,
            'p_l': float(self.p_l) if self.p_l else None,
            'p_vp': float(self.p_vp) if self.p_vp else None,
            'roe': float(self.roe) if self.roe else None,
            'ativo': self.ativo,
            'deslistado': self.deslistado,
            'data_deslistagem': self.data_deslistagem.isoformat() if self.data_deslistagem else None,
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Ativo {self.ticker} - {self.nome} ({self.mercado})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/corretora.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Corretora
Entidade para gest√£o de contas de investimento (corretoras e exchanges)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoCorretora(enum.Enum):
    """Enum para tipos de corretora"""
    CORRETORA = "corretora"  # Corretora tradicional
    EXCHANGE = "exchange"     # Exchange de criptomoedas


class Corretora(db.Model):
    """
    Model para corretoras/exchanges de investimento
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        nome (str): Nome da corretora
        tipo (TipoCorretora): Tipo (corretora ou exchange)
        pais (str): C√≥digo ISO do pa√≠s (BR, US, etc.)
        moeda_padrao (str): Moeda padr√£o (BRL, USD, EUR)
        saldo_atual (Decimal): Saldo dispon√≠vel em caixa
        ativa (bool): Indica se conta est√° ativa
        observacoes (str): Observa√ß√µes do usu√°rio
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio da conta
        posicoes: Posi√ß√µes de ativos nesta corretora
        transacoes: Transa√ß√µes realizadas nesta corretora
        movimentacoes_caixa: Movimenta√ß√µes de caixa desta corretora
    """
    
    __tablename__ = 'corretora'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da corretora"
    )
    
    # Foreign key para Usuario
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    # Dados da corretora
    nome = db.Column(
        String(100),
        nullable=False,
        index=True,
        comment="Nome da corretora/exchange (ex: XP, Clear, Binance)"
    )
    
    tipo = db.Column(
        Enum(TipoCorretora),
        default=TipoCorretora.CORRETORA,
        nullable=False,
        index=True,
        comment="Tipo: corretora tradicional ou exchange cripto"
    )
    
    pais = db.Column(
        String(2),
        nullable=False,
        default='BR',
        index=True,
        comment="C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)"
    )
    
    moeda_padrao = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    saldo_atual = db.Column(
        Numeric(precision=18, scale=2),
        default=0.00,
        nullable=False,
        comment="Saldo dispon√≠vel em caixa (na moeda padr√£o)"
    )
    
    # Status e metadados
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se conta est√° ativa"
    )
    
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes e notas do usu√°rio sobre a conta"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship(
        'Usuario',
        backref='corretoras',
        lazy='joined'
    )
    
    # Relacionamentos futuros (descomentar quando criar os models)
    # posicoes = relationship('Posicao', back_populates='corretora', lazy='dynamic')
    # transacoes = relationship('Transacao', back_populates='corretora', lazy='dynamic')
    # movimentacoes_caixa = relationship('MovimentacaoCaixa', back_populates='corretora', lazy='dynamic')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "saldo_atual >= 0",
            name="corretora_saldo_positivo"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="corretora_nome_min_length"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="corretora_pais_iso_format"
        ),
        db.CheckConstraint(
            "moeda_padrao ~* '^[A-Z]{3}$'",
            name="corretora_moeda_iso_format"
        ),
        db.UniqueConstraint(
            'usuario_id', 'nome', 'pais',
            name='unique_corretora_usuario_nome_pais'
        ),
        {'comment': 'Tabela de corretoras e contas de investimento'}
    )
    
    def is_active(self):
        """Verifica se corretora est√° ativa"""
        return self.ativa
    
    def is_exchange(self):
        """Verifica se √© exchange de criptomoedas"""
        return self.tipo == TipoCorretora.EXCHANGE
    
    def atualizar_saldo(self, valor, operacao='credito'):
        """
        Atualiza o saldo da corretora
        
        Args:
            valor (Decimal): Valor a ser creditado/debitado
            operacao (str): 'credito' ou 'debito'
        
        Raises:
            ValueError: Se saldo ficar negativo ou opera√ß√£o inv√°lida
        """
        if operacao == 'credito':
            self.saldo_atual += valor
        elif operacao == 'debito':
            if self.saldo_atual < valor:
                raise ValueError(f"Saldo insuficiente. Dispon√≠vel: {self.saldo_atual}, Solicitado: {valor}")
            self.saldo_atual -= valor
        else:
            raise ValueError(f"Opera√ß√£o inv√°lida: {operacao}. Use 'credito' ou 'debito'")
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da corretora
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'nome': self.nome,
            'tipo': self.tipo.value if self.tipo else TipoCorretora.CORRETORA.value,
            'pais': self.pais,
            'moeda_padrao': self.moeda_padrao,
            'saldo_atual': float(self.saldo_atual) if self.saldo_atual else 0.0,
            'ativa': self.ativa,
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Corretora {self.nome} ({self.pais}/{self.moeda_padrao})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/evento_corporativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model EventoCorporativo
Entidade para eventos corporativos que afetam ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Boolean, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoEventoCorporativo(enum.Enum):
    """Enum para tipos de evento corporativo"""
    SPLIT = "split"                          # Desdobramento (ex: 1 a√ß√£o vira 2)
    GRUPAMENTO = "grupamento"                # Grupamento/Inplit (ex: 10 a√ß√µes viram 1)
    BONIFICACAO = "bonificacao"              # Bonifica√ß√£o em a√ß√µes
    DIREITO_SUBSCRICAO = "direito_sub"       # Direito de subscri√ß√£o
    FUSAO = "fusao"                          # Fus√£o com outra empresa
    CISAO = "cisao"                          # Cis√£o (spin-off)
    INCORPORACAO = "incorporacao"            # Incorpora√ß√£o por outra empresa
    MUDANCA_TICKER = "mudanca_ticker"        # Mudan√ßa de c√≥digo
    DESLISTAGEM = "deslistagem"              # Deslistagem da bolsa
    RELISTING = "relisting"                  # Relistagem
    CANCELAMENTO = "cancelamento"            # Cancelamento de a√ß√µes
    OUTRO = "outro"                          # Outros eventos


class EventoCorporativo(db.Model):
    """
    Model para eventos corporativos que afetam ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo afetado
        tipo_evento (TipoEventoCorporativo): Tipo do evento
        data_evento (date): Data do evento
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        proporcao (str): Propor√ß√£o do evento (ex: "2:1", "1:10")
        ativo_novo_id (UUID): ID do novo ativo (fus√µes, mudan√ßas)
        descricao (str): Descri√ß√£o detalhada do evento
        impacto_posicoes (bool): Indica se posi√ß√µes j√° foram ajustadas
        observacoes (str): Observa√ß√µes adicionais
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo original afetado
        ativo_novo: Novo ativo (para fus√µes, mudan√ßas de ticker)
    """
    
    __tablename__ = 'evento_corporativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do evento"
    )
    
    # Foreign keys
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo afetado pelo evento"
    )
    
    ativo_novo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do novo ativo (fus√µes, mudan√ßas de ticker)"
    )
    
    # Dados do evento
    tipo_evento = db.Column(
        Enum(TipoEventoCorporativo),
        nullable=False,
        index=True,
        comment="Tipo do evento corporativo"
    )
    
    data_evento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do evento"
    )
    
    data_com = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao evento)"
    )
    
    proporcao = db.Column(
        String(20),
        nullable=True,
        comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"
    )
    
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada do evento"
    )
    
    # Controle de processamento
    impacto_posicoes = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se as posi√ß√µes j√° foram ajustadas"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes adicionais sobre o evento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship(
        'Ativo',
        foreign_keys=[ativo_id],
        backref='eventos_corporativos',
        lazy='joined'
    )
    ativo_novo = relationship(
        'Ativo',
        foreign_keys=[ativo_novo_id],
        lazy='joined'
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "data_com IS NULL OR data_com <= data_evento",
            name="evento_data_com_valida"
        ),
        db.CheckConstraint(
            """
            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)
            OR 
            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))
            """,
            name="evento_proporcao_obrigatoria"
        ),
        {'comment': 'Tabela de eventos corporativos que afetam ativos'}
    )
    
    def is_split(self):
        """Verifica se √© split (desdobramento)"""
        return self.tipo_evento == TipoEventoCorporativo.SPLIT
    
    def is_grupamento(self):
        """Verifica se √© grupamento (inplit)"""
        return self.tipo_evento == TipoEventoCorporativo.GRUPAMENTO
    
    def is_bonificacao(self):
        """Verifica se √© bonifica√ß√£o"""
        return self.tipo_evento == TipoEventoCorporativo.BONIFICACAO
    
    def is_mudanca_ticker(self):
        """Verifica se √© mudan√ßa de ticker"""
        return self.tipo_evento == TipoEventoCorporativo.MUDANCA_TICKER
    
    def parse_proporcao(self):
        """
        Faz parse da propor√ß√£o do evento
        
        Returns:
            tuple: (numerador, denominador) ou None se inv√°lido
            
        Examples:
            "2:1" -> (2.0, 1.0) # Split 2 para 1
            "1:10" -> (1.0, 10.0) # Grupamento 1 para 10
            "1:1.5" -> (1.0, 1.5) # Bonifica√ß√£o 50%
        """
        if not self.proporcao:
            return None
        
        try:
            parts = self.proporcao.split(':')
            if len(parts) == 2:
                return (float(parts[0]), float(parts[1]))
        except (ValueError, IndexError):
            pass
        
        return None
    
    def calcular_fator_ajuste(self):
        """
        Calcula o fator de ajuste para quantidade de ativos
        
        Returns:
            float: Fator multiplicador (ex: 2.0 para split 2:1, 0.1 para grupamento 1:10)
        """
        proporcao = self.parse_proporcao()
        if not proporcao:
            return 1.0
        
        numerador, denominador = proporcao
        
        if self.is_split() or self.is_bonificacao():
            # Split 2:1 ou Bonifica√ß√£o 1:1.5 -> multiplica quantidade
            return numerador / denominador
        elif self.is_grupamento():
            # Grupamento 1:10 -> divide quantidade (inverte propor√ß√£o)
            return numerador / denominador
        
        return 1.0
    
    def calcular_fator_ajuste_preco(self):
        """
        Calcula o fator de ajuste para pre√ßo m√©dio
        (inverso do ajuste de quantidade)
        
        Returns:
            float: Fator divisor para pre√ßo
        """
        fator_quantidade = self.calcular_fator_ajuste()
        if fator_quantidade > 0:
            return 1.0 / fator_quantidade
        return 1.0
    
    def marcar_como_processado(self):
        """Marca o evento como processado (posi√ß√µes ajustadas)"""
        self.impacto_posicoes = True
    
    def dias_ate_evento(self):
        """
        Calcula quantos dias faltam para o evento
        
        Returns:
            int: Dias at√© evento (negativo se j√° ocorreu)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_evento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do evento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'ativo_novo_id': str(self.ativo_novo_id) if self.ativo_novo_id else None,
            'tipo_evento': self.tipo_evento.value if self.tipo_evento else None,
            'data_evento': self.data_evento.isoformat() if self.data_evento else None,
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'proporcao': self.proporcao,
            'fator_ajuste_quantidade': self.calcular_fator_ajuste(),
            'fator_ajuste_preco': self.calcular_fator_ajuste_preco(),
            'descricao': self.descricao,
            'impacto_posicoes': self.impacto_posicoes,
            'dias_ate_evento': self.dias_ate_evento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_evento.value if self.tipo_evento else "N/A"
        return f"<EventoCorporativo {tipo.upper()} {ticker} {self.proporcao or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/feriado_mercado.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FeriadoMercado
Entidade para feriados e dias sem preg√£o
"""

from datetime import datetime, time
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Text, Date, Time
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFeriado(enum.Enum):
    """Enum para tipos de feriado"""
    NACIONAL = "nacional"            # Feriado nacional
    BOLSA = "bolsa"                  # Feriado espec√≠fico da bolsa
    PONTE = "ponte"                  # Ponto facultativo
    FECHAMENTO_ANTECIPADO = "antecip"  # Fechamento antecipado
    MANUTENCAO = "manutencao"        # Manuten√ß√£o de sistemas
    OUTRO = "outro"                  # Outros tipos


class FeriadoMercado(db.Model):
    """
    Model para feriados e dias sem preg√£o
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s do feriado (c√≥digo ISO)
        mercado (str): Mercado/bolsa espec√≠fica
        data_feriado (date): Data do feriado
        tipo_feriado (TipoFeriado): Tipo do feriado
        nome (str): Nome do feriado
        horario_fechamento (time): Hor√°rio de fechamento antecipado
        recorrente (bool): Se √© feriado anual fixo
        observacoes (str): Observa√ß√µes sobre o feriado
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'feriado_mercado'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do feriado"
    )
    
    # Localiza√ß√£o
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    mercado = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos"
    )
    
    # Dados do feriado
    data_feriado = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do feriado"
    )
    
    tipo_feriado = db.Column(
        Enum(TipoFeriado),
        nullable=False,
        index=True,
        comment="Tipo do feriado"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        comment="Nome do feriado"
    )
    
    horario_fechamento = db.Column(
        Time,
        nullable=True,
        comment="Hor√°rio de fechamento antecipado (se aplic√°vel)"
    )
    
    recorrente = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o feriado"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="feriado_pais_iso_format"
        ),
        db.CheckConstraint(
            "length(nome) >= 3",
            name="feriado_nome_min_length"
        ),
        db.UniqueConstraint(
            'pais', 'mercado', 'data_feriado',
            name='unique_feriado_pais_mercado_data'
        ),
        {'comment': 'Tabela de feriados e dias sem preg√£o nos mercados'}
    )
    
    def is_fechamento_total(self):
        """Verifica se √© fechamento total (n√£o h√° preg√£o)"""
        return self.tipo_feriado in [
            TipoFeriado.NACIONAL,
            TipoFeriado.BOLSA,
            TipoFeriado.PONTE
        ]
    
    def is_fechamento_antecipado(self):
        """Verifica se √© fechamento antecipado"""
        return self.tipo_feriado == TipoFeriado.FECHAMENTO_ANTECIPADO
    
    def is_recorrente(self):
        """Verifica se √© feriado recorrente (anual)"""
        return self.recorrente
    
    def dias_ate_feriado(self):
        """
        Calcula quantos dias faltam para o feriado
        
        Returns:
            int: Dias at√© feriado (negativo se j√° passou)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_feriado - hoje
        return delta.days
    
    def is_hoje(self):
        """Verifica se o feriado √© hoje"""
        return self.data_feriado == datetime.utcnow().date()
    
    def is_futuro(self):
        """Verifica se o feriado √© no futuro"""
        return self.data_feriado > datetime.utcnow().date()
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do feriado
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'mercado': self.mercado,
            'data_feriado': self.data_feriado.isoformat() if self.data_feriado else None,
            'tipo_feriado': self.tipo_feriado.value if self.tipo_feriado else None,
            'nome': self.nome,
            'horario_fechamento': self.horario_fechamento.isoformat() if self.horario_fechamento else None,
            'recorrente': self.recorrente,
            'is_fechamento_total': self.is_fechamento_total(),
            'is_fechamento_antecipado': self.is_fechamento_antecipado(),
            'dias_ate_feriado': self.dias_ate_feriado(),
            'is_hoje': self.is_hoje(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<FeriadoMercado {self.pais} {self.data_feriado} - {self.nome}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/fonte_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FonteDados
Entidade para gerenciamento de fontes de dados externas (APIs)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Integer, Text
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFonteDados(enum.Enum):
    """Enum para tipos de fonte de dados"""
    API = "api"              # API RESTful
    SCRAPER = "scraper"      # Web scraping
    MANUAL = "manual"        # Entrada manual
    ARQUIVO = "arquivo"      # Import de arquivo
    OUTRO = "outro"          # Outros tipos


class FonteDados(db.Model):
    """
    Model para fontes de dados externas
    
    Attributes:
        id (UUID): Identificador √∫nico
        nome (str): Nome da fonte
        tipo_fonte (TipoFonteDados): Tipo da fonte
        url_base (str): URL base da API/fonte
        requer_autenticacao (bool): Se requer chave API
        rate_limit (str): Limite de requisi√ß√µes
        ativa (bool): Se fonte est√° ativa
        prioridade (int): Ordem de prioridade (1 = maior)
        ultima_consulta (datetime): Timestamp da √∫ltima consulta
        total_consultas (int): Total de consultas realizadas
        total_erros (int): Total de erros encontrados
        observacoes (str): Observa√ß√µes sobre a fonte
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'fonte_dados'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da fonte"
    )
    
    # Identifica√ß√£o
    nome = db.Column(
        String(100),
        unique=True,
        nullable=False,
        index=True,
        comment="Nome da fonte de dados (ex: yfinance, Alpha Vantage)"
    )
    
    tipo_fonte = db.Column(
        Enum(TipoFonteDados),
        nullable=False,
        index=True,
        comment="Tipo da fonte de dados"
    )
    
    url_base = db.Column(
        String(500),
        nullable=True,
        comment="URL base da API ou site"
    )
    
    # Configura√ß√µes
    requer_autenticacao = db.Column(
        Boolean,
        default=False,
        nullable=False,
        comment="Indica se requer chave API ou autentica√ß√£o"
    )
    
    rate_limit = db.Column(
        String(50),
        nullable=True,
        comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"
    )
    
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se fonte est√° ativa"
    )
    
    prioridade = db.Column(
        Integer,
        default=100,
        nullable=False,
        index=True,
        comment="Ordem de prioridade (1 = maior prioridade)"
    )
    
    # Estat√≠sticas
    ultima_consulta = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Timestamp da √∫ltima consulta bem-sucedida"
    )
    
    total_consultas = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de consultas realizadas"
    )
    
    total_erros = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de erros encontrados"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a fonte de dados"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "prioridade > 0",
            name="fonte_prioridade_positiva"
        ),
        db.CheckConstraint(
            "total_consultas >= 0",
            name="fonte_consultas_positivas"
        ),
        db.CheckConstraint(
            "total_erros >= 0",
            name="fonte_erros_positivos"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="fonte_nome_min_length"
        ),
        {'comment': 'Tabela de fontes de dados externas (APIs, scrapers)'}
    )
    
    def is_active(self):
        """Verifica se fonte est√° ativa"""
        return self.ativa
    
    def is_api(self):
        """Verifica se √© API"""
        return self.tipo_fonte == TipoFonteDados.API
    
    def registrar_consulta_sucesso(self):
        """Registra uma consulta bem-sucedida"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.ultima_consulta = datetime.utcnow()
        self.total_consultas += 1

    def registrar_erro(self):
        """Registra um erro na consulta"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.total_erros += 1
        self.total_consultas += 1

    def taxa_sucesso(self):
        """
        Calcula a taxa de sucesso das consultas
        
        Returns:
            float: Percentual de sucesso (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            sucessos = total - erros
            return (sucessos / total) * 100
        return 100.0  # Sem consultas = 100% por padr√£o

    def taxa_erro(self):
        """
        Calcula a taxa de erro das consultas
        
        Returns:
            float: Percentual de erro (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            return (erros / total) * 100
        return 0.0

    def health_status(self):
        """
        Determina o status de sa√∫de da fonte
        
        Returns:
            str: 'healthy', 'degraded', 'down', 'unknown'
        """
        total = self.total_consultas if self.total_consultas else 0
        
        if total == 0:
            return 'unknown'
        
        taxa_sucesso = self.taxa_sucesso()
        
        if taxa_sucesso >= 95:
            return 'healthy'
        elif taxa_sucesso >= 80:
            return 'degraded'
        else:
            return 'down'

    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da fonte
        """
        return {
            'id': str(self.id),
            'nome': self.nome,
            'tipo_fonte': self.tipo_fonte.value if self.tipo_fonte else None,
            'url_base': self.url_base,
            'requer_autenticacao': self.requer_autenticacao,
            'rate_limit': self.rate_limit,
            'ativa': self.ativa,
            'prioridade': self.prioridade,
            'ultima_consulta': self.ultima_consulta.isoformat() if self.ultima_consulta else None,
            'total_consultas': self.total_consultas,
            'total_erros': self.total_erros,
            'taxa_sucesso': round(self.taxa_sucesso(), 2),
            'taxa_erro': round(self.taxa_erro(), 2),
            'health_status': self.health_status(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.ativa else "‚úó"
        return f"<FonteDados {status} {self.nome} (prioridade {self.prioridade})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/log_auditoria.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model LogAuditoria
Entidade para logs de auditoria e compliance
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Text, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class LogAuditoria(db.Model):
    """
    Model para logs de auditoria
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio que realizou a a√ß√£o
        acao (str): Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE, etc.)
        entidade (str): Nome da entidade afetada
        entidade_id (UUID): ID do registro afetado
        dados_antes (dict): Estado anterior do registro (JSON)
        dados_depois (dict): Estado posterior do registro (JSON)
        ip_address (str): Endere√ßo IP de origem
        user_agent (str): Navegador/cliente usado
        timestamp (datetime): Data/hora da a√ß√£o
        sucesso (bool): Se a√ß√£o foi bem-sucedida
        mensagem (str): Mensagem de erro ou detalhes adicionais
    
    Relationships:
        usuario: Usu√°rio que realizou a a√ß√£o
    """
    
    __tablename__ = 'log_auditoria'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do log"
    )
    
    # Foreign key
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do usu√°rio (NULL para a√ß√µes an√¥nimas)"
    )
    
    # Dados da a√ß√£o
    acao = db.Column(
        String(50),
        nullable=False,
        index=True,
        comment="Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)"
    )
    
    entidade = db.Column(
        String(100),
        nullable=True,
        index=True,
        comment="Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)"
    )
    
    entidade_id = db.Column(
        UUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="ID do registro afetado"
    )
    
    # Estados anterior e posterior (para UPDATE)
    dados_antes = db.Column(
        JSON,
        nullable=True,
        comment="Estado anterior do registro (JSON)"
    )
    
    dados_depois = db.Column(
        JSON,
        nullable=True,
        comment="Estado posterior do registro (JSON)"
    )
    
    # Dados de contexto
    ip_address = db.Column(
        String(45),  # IPv6 pode ter at√© 45 caracteres
        nullable=True,
        index=True,
        comment="Endere√ßo IP de origem"
    )
    
    user_agent = db.Column(
        String(500),
        nullable=True,
        comment="User-Agent (navegador/cliente)"
    )
    
    timestamp = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        index=True,
        comment="Data/hora da a√ß√£o"
    )
    
    # Resultado
    sucesso = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se a√ß√£o foi bem-sucedida"
    )
    
    mensagem = db.Column(
        Text,
        nullable=True,
        comment="Mensagem de erro ou detalhes adicionais"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='logs_auditoria', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "length(acao) >= 3",
            name="log_acao_min_length"
        ),
        {'comment': 'Tabela de logs de auditoria para compliance'}
    )
    
    def is_sucesso(self):
        """Verifica se a√ß√£o foi bem-sucedida"""
        return self.sucesso
    
    def is_falha(self):
        """Verifica se a√ß√£o falhou"""
        return not self.sucesso
    
    def is_login(self):
        """Verifica se √© log de login"""
        return self.acao == 'LOGIN'
    
    def is_logout(self):
        """Verifica se √© log de logout"""
        return self.acao == 'LOGOUT'
    
    def is_create(self):
        """Verifica se √© cria√ß√£o de registro"""
        return self.acao == 'CREATE'
    
    def is_update(self):
        """Verifica se √© atualiza√ß√£o de registro"""
        return self.acao == 'UPDATE'
    
    def is_delete(self):
        """Verifica se √© exclus√£o de registro"""
        return self.acao == 'DELETE'
    
    def is_export(self):
        """Verifica se √© exporta√ß√£o de dados"""
        return self.acao == 'EXPORT'
    
    def get_alteracoes(self):
        """
        Extrai as altera√ß√µes realizadas (campos modificados)
        
        Returns:
            dict: Dicion√°rio com campos alterados e seus valores antes/depois
        """
        if not self.is_update() or not self.dados_antes or not self.dados_depois:
            return {}
        
        alteracoes = {}
        for campo, valor_depois in self.dados_depois.items():
            valor_antes = self.dados_antes.get(campo)
            if valor_antes != valor_depois:
                alteracoes[campo] = {
                    'antes': valor_antes,
                    'depois': valor_depois
                }
        
        return alteracoes
    
    def to_dict(self, include_dados=False):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Args:
            include_dados (bool): Se deve incluir dados_antes e dados_depois
        
        Returns:
            dict: Dicion√°rio com dados do log
        """
        data = {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id) if self.usuario_id else None,
            'acao': self.acao,
            'entidade': self.entidade,
            'entidade_id': str(self.entidade_id) if self.entidade_id else None,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None,
            'sucesso': self.sucesso,
            'mensagem': self.mensagem
        }
        
        if include_dados:
            data['dados_antes'] = self.dados_antes
            data['dados_depois'] = self.dados_depois
            data['alteracoes'] = self.get_alteracoes()
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.sucesso else "‚úó"
        usuario = self.usuario.username if self.usuario else "ANON"
        return f"<LogAuditoria {status} {usuario} {self.acao} {self.entidade or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/movimentacao_caixa.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model MovimentacaoCaixa
Entidade para movimenta√ß√µes de caixa em corretoras
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoMovimentacao(enum.Enum):
    """Enum para tipos de movimenta√ß√£o"""
    DEPOSITO = "deposito"                    # Dep√≥sito na corretora
    SAQUE = "saque"                          # Saque da corretora
    TRANSFERENCIA_ENVIADA = "transf_env"    # Transfer√™ncia para outra corretora
    TRANSFERENCIA_RECEBIDA = "transf_rec"   # Transfer√™ncia de outra corretora
    CREDITO_PROVENTO = "credito_prov"       # Cr√©dito de provento
    PAGAMENTO_TAXA = "pagto_taxa"           # Pagamento de taxa/cust√≥dia
    PAGAMENTO_IMPOSTO = "pagto_imposto"     # Pagamento de imposto
    AJUSTE = "ajuste"                        # Ajuste manual
    OUTRO = "outro"                          # Outros tipos


class MovimentacaoCaixa(db.Model):
    """
    Model para movimenta√ß√µes de caixa em corretoras
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora (origem)
        tipo_movimentacao (TipoMovimentacao): Tipo da movimenta√ß√£o
        valor (Decimal): Valor da movimenta√ß√£o
        moeda (str): Moeda (BRL, USD, EUR)
        data_movimentacao (date): Data da movimenta√ß√£o
        corretora_destino_id (UUID): ID da corretora destino (transfer√™ncias)
        provento_id (UUID): ID do provento (se for cr√©dito de provento)
        descricao (str): Descri√ß√£o da movimenta√ß√£o
        comprovante (str): Refer√™ncia ao comprovante
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora origem
        corretora_destino: Corretora destino (para transfer√™ncias)
        provento: Provento relacionado (para cr√©ditos)
    """
    
    __tablename__ = 'movimentacao_caixa'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da movimenta√ß√£o"
    )
    
    # Foreign keys obrigat√≥rias
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora (origem)"
    )
    
    # Foreign keys opcionais
    corretora_destino_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID da corretora destino (apenas para transfer√™ncias)"
    )
    
    provento_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('provento.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do provento (apenas para cr√©dito de provento)"
    )
    
    # Dados da movimenta√ß√£o
    tipo_movimentacao = db.Column(
        Enum(TipoMovimentacao),
        nullable=False,
        index=True,
        comment="Tipo da movimenta√ß√£o"
    )
    
    valor = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor da movimenta√ß√£o"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    data_movimentacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da movimenta√ß√£o"
    )
    
    # Metadados
    descricao = db.Column(
        Text,
        nullable=True,
        comment="Descri√ß√£o da movimenta√ß√£o"
    )
    
    comprovante = db.Column(
        String(200),
        nullable=True,
        comment="Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='movimentacoes_caixa', lazy='joined')
    corretora = relationship(
        'Corretora',
        foreign_keys=[corretora_id],
        backref='movimentacoes_caixa',
        lazy='joined'
    )
    corretora_destino = relationship(
        'Corretora',
        foreign_keys=[corretora_destino_id],
        lazy='joined'
    )
    provento = relationship('Provento', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor > 0",
            name="movimentacao_valor_positivo"
        ),
        db.CheckConstraint(
            "moeda ~* '^[A-Z]{3}$'",
            name="movimentacao_moeda_iso_format"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') 
             AND corretora_destino_id IS NOT NULL)
            OR 
            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))
            """,
            name="movimentacao_transferencia_tem_destino"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)
            OR 
            (tipo_movimentacao != 'credito_provento')
            """,
            name="movimentacao_credito_tem_provento"
        ),
        {'comment': 'Tabela de movimenta√ß√µes de caixa em corretoras'}
    )
    
    def is_entrada(self):
        """Verifica se √© movimenta√ß√£o de entrada (aumenta saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.DEPOSITO,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA,
            TipoMovimentacao.CREDITO_PROVENTO,
            TipoMovimentacao.AJUSTE  # Depende do contexto, mas inclu√≠mos aqui
        ]
    
    def is_saida(self):
        """Verifica se √© movimenta√ß√£o de sa√≠da (diminui saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.SAQUE,
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.PAGAMENTO_TAXA,
            TipoMovimentacao.PAGAMENTO_IMPOSTO
        ]
    
    def is_transferencia(self):
        """Verifica se √© transfer√™ncia entre corretoras"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA
        ]
    
    def is_credito_provento(self):
        """Verifica se √© cr√©dito de provento"""
        return self.tipo_movimentacao == TipoMovimentacao.CREDITO_PROVENTO
    
    def impacto_saldo(self):
        """
        Calcula o impacto no saldo da corretora
        
        Returns:
            Decimal: Valor positivo para entradas, negativo para sa√≠das
        """
        if self.is_entrada():
            return self.valor
        elif self.is_saida():
            return -self.valor
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da movimenta√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'corretora_destino_id': str(self.corretora_destino_id) if self.corretora_destino_id else None,
            'provento_id': str(self.provento_id) if self.provento_id else None,
            'tipo_movimentacao': self.tipo_movimentacao.value if self.tipo_movimentacao else None,
            'valor': float(self.valor) if self.valor else 0,
            'moeda': self.moeda,
            'impacto_saldo': float(self.impacto_saldo()),
            'data_movimentacao': self.data_movimentacao.isoformat() if self.data_movimentacao else None,
            'descricao': self.descricao,
            'comprovante': self.comprovante,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = self.tipo_movimentacao.value if self.tipo_movimentacao else "N/A"
        sinal = "+" if self.is_entrada() else "-"
        return f"<MovimentacaoCaixa {tipo.upper()} {sinal} {self.moeda} {self.valor}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/posicao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Posicao
Entidade para holdings/posi√ß√µes em carteira de ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Numeric, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class Posicao(db.Model):
    """
    Model para posi√ß√µes em carteira (holdings)
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        corretora_id (UUID): ID da corretora onde est√° a posi√ß√£o
        ativo_id (UUID): ID do ativo
        quantidade (Decimal): Quantidade de ativos em posse
        preco_medio (Decimal): Pre√ßo m√©dio de aquisi√ß√£o
        custo_total (Decimal): Custo total investido
        taxas_acumuladas (Decimal): Taxas de corretagem acumuladas
        impostos_acumulados (Decimal): Impostos pagos acumulados
        valor_atual (Decimal): Valor de mercado atual da posi√ß√£o
        lucro_prejuizo_realizado (Decimal): L/P realizado (vendas)
        lucro_prejuizo_nao_realizado (Decimal): L/P n√£o realizado
        data_primeira_compra (date): Data da primeira aquisi√ß√£o
        data_ultima_atualizacao (datetime): √öltima atualiza√ß√£o
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora onde est√° a posi√ß√£o
        ativo: Ativo da posi√ß√£o
    """
    
    __tablename__ = 'posicao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da posi√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora onde est√° a posi√ß√£o"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo"
    )
    
    # Dados da posi√ß√£o
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        default=0,
        comment="Quantidade de ativos (suporta fracion√°rios)"
    )
    
    preco_medio = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        default=0,
        comment="Pre√ßo m√©dio de aquisi√ß√£o"
    )
    
    custo_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Custo total investido (quantidade * pre√ßo m√©dio)"
    )
    
    taxas_acumuladas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem e cust√≥dia acumuladas"
    )
    
    impostos_acumulados = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Impostos pagos acumulados (IR, IOF, etc.)"
    )
    
    # Valores calculados
    valor_atual = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de mercado atual da posi√ß√£o"
    )
    
    lucro_prejuizo_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Lucro/preju√≠zo realizado em vendas"
    )
    
    lucro_prejuizo_nao_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)"
    )
    
    # Datas
    data_primeira_compra = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data da primeira aquisi√ß√£o deste ativo"
    )
    
    data_ultima_atualizacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data da √∫ltima atualiza√ß√£o de valores"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='posicoes', lazy='joined')
    corretora = relationship('Corretora', backref='posicoes', lazy='joined')
    ativo = relationship('Ativo', backref='posicoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade >= 0",
            name="posicao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_medio >= 0",
            name="posicao_preco_medio_positivo"
        ),
        db.CheckConstraint(
            "custo_total >= 0",
            name="posicao_custo_total_positivo"
        ),
        db.CheckConstraint(
            "taxas_acumuladas >= 0",
            name="posicao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos_acumulados >= 0",
            name="posicao_impostos_positivos"
        ),
        db.UniqueConstraint(
            'usuario_id', 'corretora_id', 'ativo_id',
            name='unique_posicao_usuario_corretora_ativo'
        ),
        {'comment': 'Tabela de posi√ß√µes em carteira (holdings)'}
    )
    
    def calcular_valor_atual(self, preco_mercado):
        """
        Calcula o valor atual da posi√ß√£o baseado no pre√ßo de mercado
        
        Args:
            preco_mercado (Decimal): Pre√ßo atual do ativo no mercado
        
        Returns:
            Decimal: Valor atual da posi√ß√£o
        """
        self.valor_atual = self.quantidade * preco_mercado
        self.data_ultima_atualizacao = datetime.utcnow()
        return self.valor_atual
    
    def calcular_lucro_prejuizo_nao_realizado(self):
        """
        Calcula o lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)
        
        Returns:
            Decimal: L/P n√£o realizado
        """
        if self.valor_atual is not None:
            self.lucro_prejuizo_nao_realizado = self.valor_atual - self.custo_total
        return self.lucro_prejuizo_nao_realizado
    
    def adicionar_compra(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma compra √† posi√ß√£o (recalcula pre√ßo m√©dio)
        
        Args:
            quantidade (Decimal): Quantidade comprada
            preco_unitario (Decimal): Pre√ßo unit√°rio da compra
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        """
        # Garantir valores n√£o-None (defaults do SQLAlchemy s√≥ aplicam ao persistir)
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        custo_compra = quantidade * preco_unitario
        
        # Recalcular pre√ßo m√©dio ponderado
        novo_custo_total = self.custo_total + custo_compra
        nova_quantidade = self.quantidade + quantidade
        
        if nova_quantidade > 0:
            self.preco_medio = novo_custo_total / nova_quantidade
        
        self.quantidade = nova_quantidade
        self.custo_total = novo_custo_total
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Definir data primeira compra se for a primeira
        if self.data_primeira_compra is None:
            self.data_primeira_compra = datetime.utcnow().date()

    
    def adicionar_venda(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma venda √† posi√ß√£o
        
        Args:
            quantidade (Decimal): Quantidade vendida
            preco_unitario (Decimal): Pre√ßo unit√°rio da venda
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        
        Raises:
            ValueError: Se quantidade vendida for maior que quantidade em posse
        """
        # Garantir valores n√£o-None
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        if quantidade > self.quantidade:
            raise ValueError(
                f"Quantidade vendida ({quantidade}) maior que quantidade em posse ({self.quantidade})"
            )
        
        # Calcular lucro/preju√≠zo realizado
        receita_venda = quantidade * preco_unitario
        custo_proporcional = quantidade * self.preco_medio
        lp_realizado = receita_venda - custo_proporcional - taxas - impostos
        
        self.lucro_prejuizo_realizado += lp_realizado
        self.quantidade -= quantidade
        self.custo_total -= custo_proporcional
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Se zerou a posi√ß√£o, resetar pre√ßo m√©dio
        if self.quantidade == 0:
            self.preco_medio = 0
            self.custo_total = 0

    
    def percentual_lucro_prejuizo(self):
        """
        Calcula o percentual de lucro/preju√≠zo n√£o realizado
        
        Returns:
            Decimal: Percentual de L/P (ex: 15.5 = 15.5%)
        """
        if self.custo_total > 0 and self.lucro_prejuizo_nao_realizado is not None:
            return (self.lucro_prejuizo_nao_realizado / self.custo_total) * 100
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da posi√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_medio': float(self.preco_medio) if self.preco_medio else 0,
            'custo_total': float(self.custo_total) if self.custo_total else 0,
            'taxas_acumuladas': float(self.taxas_acumuladas) if self.taxas_acumuladas else 0,
            'impostos_acumulados': float(self.impostos_acumulados) if self.impostos_acumulados else 0,
            'valor_atual': float(self.valor_atual) if self.valor_atual else None,
            'lucro_prejuizo_realizado': float(self.lucro_prejuizo_realizado) if self.lucro_prejuizo_realizado else 0,
            'lucro_prejuizo_nao_realizado': float(self.lucro_prejuizo_nao_realizado) if self.lucro_prejuizo_nao_realizado else None,
            'percentual_lp': float(self.percentual_lucro_prejuizo()),
            'data_primeira_compra': self.data_primeira_compra.isoformat() if self.data_primeira_compra else None,
            'data_ultima_atualizacao': self.data_ultima_atualizacao.isoformat() if self.data_ultima_atualizacao else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Posicao {self.quantidade}x {self.ativo.ticker if self.ativo else 'N/A'}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/provento.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Provento
Entidade para registro de proventos (dividendos, JCP, rendimentos)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoProvento(enum.Enum):
    """Enum para tipos de provento"""
    DIVIDENDO = "dividendo"              # Dividendo ordin√°rio
    JCP = "jcp"                          # Juros sobre Capital Pr√≥prio
    RENDIMENTO = "rendimento"            # Rendimento de FII
    CUPOM = "cupom"                      # Cupom de t√≠tulo de renda fixa
    BONIFICACAO = "bonificacao"          # Bonifica√ß√£o em dinheiro
    DIREITO_SUBSCRICAO = "direito_sub"   # Direito de subscri√ß√£o vendido
    OUTRO = "outro"                      # Outros tipos


class Provento(db.Model):
    """
    Model para proventos recebidos de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo que pagou o provento
        tipo_provento (TipoProvento): Tipo do provento
        valor_por_acao (Decimal): Valor unit√°rio por ativo
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        data_pagamento (date): Data efetiva do pagamento
        quantidade_ativos (Decimal): Quantidade de ativos que geraram provento
        valor_bruto (Decimal): Valor bruto recebido
        imposto_retido (Decimal): IR retido na fonte
        valor_liquido (Decimal): Valor l√≠quido creditado
        observacoes (str): Observa√ß√µes sobre o provento
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo que pagou o provento
    """
    
    __tablename__ = 'provento'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do provento"
    )
    
    # Foreign key
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo que pagou o provento"
    )
    
    # Tipo de provento
    tipo_provento = db.Column(
        Enum(TipoProvento),
        nullable=False,
        index=True,
        comment="Tipo do provento (dividendo, JCP, rendimento, etc.)"
    )
    
    # Valores
    valor_por_acao = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Valor unit√°rio por ativo"
    )
    
    quantidade_ativos = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade de ativos que geraram o provento"
    )
    
    valor_bruto = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor bruto recebido"
    )
    
    imposto_retido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte"
    )
    
    valor_liquido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor l√≠quido creditado"
    )
    
    # Datas
    data_com = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao provento)"
    )
    
    data_pagamento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data efetiva do pagamento"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o provento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship('Ativo', backref='proventos', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor_por_acao > 0",
            name="provento_valor_por_acao_positivo"
        ),
        db.CheckConstraint(
            "quantidade_ativos > 0",
            name="provento_quantidade_positiva"
        ),
        db.CheckConstraint(
            "valor_bruto > 0",
            name="provento_valor_bruto_positivo"
        ),
        db.CheckConstraint(
            "imposto_retido >= 0",
            name="provento_imposto_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido > 0",
            name="provento_valor_liquido_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido <= valor_bruto",
            name="provento_liquido_menor_bruto"
        ),
        db.CheckConstraint(
            "data_pagamento >= data_com",
            name="provento_data_pagamento_valida"
        ),
        {'comment': 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa provento com c√°lculos autom√°ticos
        """
        super(Provento, self).__init__(**kwargs)
        
        # Calcular valor bruto se n√£o fornecido
        if self.valor_bruto is None and self.valor_por_acao and self.quantidade_ativos:
            self.valor_bruto = self.valor_por_acao * self.quantidade_ativos
        
        # Calcular valor l√≠quido se n√£o fornecido
        if self.valor_liquido is None and self.valor_bruto is not None:
            imposto = self.imposto_retido if self.imposto_retido else 0
            self.valor_liquido = self.valor_bruto - imposto
    
    def is_dividendo(self):
        """Verifica se √© dividendo"""
        return self.tipo_provento == TipoProvento.DIVIDENDO
    
    def is_jcp(self):
        """Verifica se √© JCP"""
        return self.tipo_provento == TipoProvento.JCP
    
    def is_rendimento_fii(self):
        """Verifica se √© rendimento de FII"""
        return self.tipo_provento == TipoProvento.RENDIMENTO
    
    def percentual_imposto(self):
        """
        Calcula o percentual de imposto retido
        
        Returns:
            Decimal: Percentual de imposto (ex: 15.0 = 15%)
        """
        if self.valor_bruto and self.valor_bruto > 0:
            imposto = self.imposto_retido if self.imposto_retido else 0
            return (imposto / self.valor_bruto) * 100
        return 0
    
    def dividend_yield_efetivo(self, preco_ativo):
        """
        Calcula o dividend yield efetivo baseado no pre√ßo do ativo
        
        Args:
            preco_ativo (Decimal): Pre√ßo atual do ativo
            
        Returns:
            Decimal: DY efetivo em % (ex: 6.5 = 6.5%)
        """
        if preco_ativo and preco_ativo > 0:
            return (self.valor_por_acao / preco_ativo) * 100
        return 0
    
    def dias_ate_pagamento(self):
        """
        Calcula quantos dias faltam para o pagamento
        
        Returns:
            int: Dias at√© pagamento (negativo se j√° pago)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_pagamento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do provento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'tipo_provento': self.tipo_provento.value if self.tipo_provento else None,
            'valor_por_acao': float(self.valor_por_acao) if self.valor_por_acao else 0,
            'quantidade_ativos': float(self.quantidade_ativos) if self.quantidade_ativos else 0,
            'valor_bruto': float(self.valor_bruto) if self.valor_bruto else 0,
            'imposto_retido': float(self.imposto_retido) if self.imposto_retido else 0,
            'valor_liquido': float(self.valor_liquido) if self.valor_liquido else 0,
            'percentual_imposto': float(self.percentual_imposto()),
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'data_pagamento': self.data_pagamento.isoformat() if self.data_pagamento else None,
            'dias_ate_pagamento': self.dias_ate_pagamento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_provento.value if self.tipo_provento else "N/A"
        return f"<Provento {tipo.upper()} {ticker} R$ {self.valor_por_acao}/a√ß√£o>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/regra_fiscal.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model RegraFiscal
Entidade para regras tribut√°rias por pa√≠s e tipo de ativo
"""

from datetime import datetime, date
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class IncidenciaImposto(enum.Enum):
    """Enum para tipo de incid√™ncia do imposto"""
    LUCRO = "lucro"              # Incide sobre lucro/ganho de capital
    RECEITA = "receita"          # Incide sobre receita bruta
    PROVENTO = "provento"        # Incide sobre proventos recebidos
    OPERACAO = "operacao"        # Incide sobre cada opera√ß√£o


class RegraFiscal(db.Model):
    """
    Model para regras tribut√°rias
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s da regra (c√≥digo ISO)
        tipo_ativo (str): Tipo de ativo (ACAO, FII, REIT, etc.)
        tipo_operacao (str): Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE)
        aliquota_ir (Decimal): Al√≠quota de IR em %
        valor_isencao (Decimal): Valor de isen√ß√£o mensal
        incide_sobre (IncidenciaImposto): Sobre o que incide o imposto
        descricao (str): Descri√ß√£o da regra
        vigencia_inicio (date): Data de in√≠cio da vig√™ncia
        vigencia_fim (date): Data de fim da vig√™ncia
        ativa (bool): Indica se regra est√° ativa
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'regra_fiscal'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da regra"
    )
    
    # Identifica√ß√£o da regra
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    tipo_ativo = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos"
    )
    
    tipo_operacao = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas"
    )
    
    # Valores fiscais
    aliquota_ir = db.Column(
        Numeric(precision=6, scale=4),
        nullable=False,
        comment="Al√≠quota de IR em % (ex: 15.0000 = 15%)"
    )
    
    valor_isencao = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)"
    )
    
    incide_sobre = db.Column(
        Enum(IncidenciaImposto),
        nullable=False,
        index=True,
        comment="Sobre o que incide o imposto"
    )
    
    # Descri√ß√£o
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada da regra fiscal"
    )
    
    # Vig√™ncia
    vigencia_inicio = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data de in√≠cio da vig√™ncia da regra"
    )
    
    vigencia_fim = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de fim da vig√™ncia (NULL = vigente indefinidamente)"
    )
    
    # Status
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se regra est√° ativa"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "aliquota_ir >= 0 AND aliquota_ir <= 100",
            name="regra_aliquota_valida"
        ),
        db.CheckConstraint(
            "valor_isencao IS NULL OR valor_isencao >= 0",
            name="regra_isencao_positiva"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="regra_pais_iso_format"
        ),
        db.CheckConstraint(
            "vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio",
            name="regra_vigencia_valida"
        ),
        {'comment': 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'}
    )
    
    def is_active(self):
        """Verifica se regra est√° ativa"""
        return self.ativa
    
    def is_vigente(self, data_referencia=None):
        """
        Verifica se regra est√° vigente em uma data
        
        Args:
            data_referencia (date): Data de refer√™ncia (default: hoje)
            
        Returns:
            bool: True se vigente
        """
        if not self.ativa:
            return False
        
        if data_referencia is None:
            data_referencia = datetime.utcnow().date()
        
        # Verifica in√≠cio
        if data_referencia < self.vigencia_inicio:
            return False
        
        # Verifica fim (se definido)
        if self.vigencia_fim and data_referencia > self.vigencia_fim:
            return False
        
        return True
    
    def tem_isencao(self):
        """Verifica se regra possui valor de isen√ß√£o"""
        return self.valor_isencao is not None and self.valor_isencao > 0
    
    def calcular_imposto(self, base_calculo):
        """
        Calcula o imposto devido sobre uma base de c√°lculo
        
        Args:
            base_calculo (Decimal): Valor base para c√°lculo
            
        Returns:
            Decimal: Valor do imposto devido
        """
        # Se tem isen√ß√£o e base est√° abaixo, n√£o h√° imposto
        if self.tem_isencao() and base_calculo <= self.valor_isencao:
            return 0
        
        # Calcula imposto sobre o valor (ou valor acima da isen√ß√£o)
        valor_tributavel = base_calculo
        if self.tem_isencao():
            valor_tributavel = base_calculo - self.valor_isencao
        
        imposto = valor_tributavel * (self.aliquota_ir / 100)
        return max(imposto, 0)  # Nunca retornar negativo
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da regra
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'tipo_ativo': self.tipo_ativo,
            'tipo_operacao': self.tipo_operacao,
            'aliquota_ir': float(self.aliquota_ir) if self.aliquota_ir else 0,
            'valor_isencao': float(self.valor_isencao) if self.valor_isencao else None,
            'incide_sobre': self.incide_sobre.value if self.incide_sobre else None,
            'descricao': self.descricao,
            'vigencia_inicio': self.vigencia_inicio.isoformat() if self.vigencia_inicio else None,
            'vigencia_fim': self.vigencia_fim.isoformat() if self.vigencia_fim else None,
            'ativa': self.ativa,
            'vigente': self.is_vigente(),
            'tem_isencao': self.tem_isencao(),
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<RegraFiscal {self.pais} {self.tipo_ativo or 'ALL'} IR={self.aliquota_ir}%>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/transacao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Transacao
Entidade para registro de opera√ß√µes de compra e venda de ativos
"""

from datetime import datetime, timedelta
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoOperacao(enum.Enum):
    """Enum para tipos de opera√ß√£o"""
    COMPRA = "compra"
    VENDA = "venda"


class Transacao(db.Model):
    """
    Model para transa√ß√µes de compra e venda de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora
        ativo_id (UUID): ID do ativo
        tipo_operacao (TipoOperacao): COMPRA ou VENDA
        quantidade (Decimal): Quantidade transacionada
        preco_unitario (Decimal): Pre√ßo por unidade
        valor_total (Decimal): Valor total da opera√ß√£o
        taxas (Decimal): Taxas de corretagem e cust√≥dia
        impostos (Decimal): IR e outros impostos
        data_operacao (date): Data da opera√ß√£o
        data_liquidacao (date): Data de liquida√ß√£o
        observacoes (str): Observa√ß√µes sobre a transa√ß√£o
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio que realizou a opera√ß√£o
        corretora: Corretora onde foi realizada
        ativo: Ativo transacionado
    """
    
    __tablename__ = 'transacao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da transa√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo transacionado"
    )
    
    # Dados da transa√ß√£o
    tipo_operacao = db.Column(
        Enum(TipoOperacao),
        nullable=False,
        index=True,
        comment="Tipo de opera√ß√£o: COMPRA ou VENDA"
    )
    
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade transacionada (suporta fracion√°rios)"
    )
    
    preco_unitario = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Pre√ßo por unidade"
    )
    
    valor_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor total da opera√ß√£o (quantidade * pre√ßo)"
    )
    
    taxas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem, cust√≥dia, emolumentos"
    )
    
    impostos = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte, IOF, etc."
    )
    
    # Datas
    data_operacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da opera√ß√£o"
    )
    
    data_liquidacao = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de liquida√ß√£o (D+2, D+3, etc.)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a transa√ß√£o"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='transacoes', lazy='joined')
    corretora = relationship('Corretora', backref='transacoes', lazy='joined')
    ativo = relationship('Ativo', backref='transacoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade > 0",
            name="transacao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_unitario > 0",
            name="transacao_preco_positivo"
        ),
        db.CheckConstraint(
            "valor_total > 0",
            name="transacao_valor_total_positivo"
        ),
        db.CheckConstraint(
            "taxas >= 0",
            name="transacao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos >= 0",
            name="transacao_impostos_positivos"
        ),
        db.CheckConstraint(
            "data_liquidacao IS NULL OR data_liquidacao >= data_operacao",
            name="transacao_data_liquidacao_valida"
        ),
        {'comment': 'Tabela de transa√ß√µes de compra e venda de ativos'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa transa√ß√£o com c√°lculos autom√°ticos
        """
        super(Transacao, self).__init__(**kwargs)
        
        # Calcular valor total se n√£o fornecido
        if self.valor_total is None and self.quantidade and self.preco_unitario:
            self.valor_total = self.quantidade * self.preco_unitario
        
        # Calcular data de liquida√ß√£o se n√£o fornecida (D+2 para a√ß√µes BR)
        if self.data_liquidacao is None and self.data_operacao:
            self.data_liquidacao = self.data_operacao + timedelta(days=2)
    
    def is_compra(self):
        """Verifica se √© uma opera√ß√£o de compra"""
        return self.tipo_operacao == TipoOperacao.COMPRA
    
    def is_venda(self):
        """Verifica se √© uma opera√ß√£o de venda"""
        return self.tipo_operacao == TipoOperacao.VENDA
    
    def custo_total(self):
        """
        Calcula o custo total da opera√ß√£o (valor + taxas + impostos)
        
        Returns:
            Decimal: Custo total
        """
        taxas = self.taxas if self.taxas else 0
        impostos = self.impostos if self.impostos else 0
        return self.valor_total + taxas + impostos
    
    def receita_liquida(self):
        """
        Calcula a receita l√≠quida em caso de venda (valor - taxas - impostos)
        
        Returns:
            Decimal: Receita l√≠quida (None se n√£o for venda)
        """
        if not self.is_venda():
            return None
        
        taxas = self.taxas if self.taxas else 0
        impostos = self.impostos if self.impostos else 0
        return self.valor_total - taxas - impostos
    
    def percentual_custos(self):
        """
        Calcula o percentual de custos (taxas + impostos) sobre o valor
        
        Returns:
            Decimal: Percentual de custos (ex: 1.5 = 1.5%)
        """
        if self.valor_total > 0:
            taxas = self.taxas if self.taxas else 0
            impostos = self.impostos if self.impostos else 0
            total_custos = taxas + impostos
            return (total_custos / self.valor_total) * 100
        return 0
    
    def dias_ate_liquidacao(self):
        """
        Calcula quantos dias faltam para liquida√ß√£o
        
        Returns:
            int: Dias at√© liquida√ß√£o (negativo se j√° liquidada)
        """
        if self.data_liquidacao:
            hoje = datetime.utcnow().date()
            delta = self.data_liquidacao - hoje
            return delta.days
        return None
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da transa√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'tipo_operacao': self.tipo_operacao.value if self.tipo_operacao else None,
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_unitario': float(self.preco_unitario) if self.preco_unitario else 0,
            'valor_total': float(self.valor_total) if self.valor_total else 0,
            'taxas': float(self.taxas) if self.taxas else 0,
            'impostos': float(self.impostos) if self.impostos else 0,
            'custo_total': float(self.custo_total()),
            'receita_liquida': float(self.receita_liquida()) if self.receita_liquida() else None,
            'percentual_custos': float(self.percentual_custos()),
            'data_operacao': self.data_operacao.isoformat() if self.data_operacao else None,
            'data_liquidacao': self.data_liquidacao.isoformat() if self.data_liquidacao else None,
            'dias_ate_liquidacao': self.dias_ate_liquidacao(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = "COMPRA" if self.is_compra() else "VENDA"
        ticker = self.ativo.ticker if self.ativo else "N/A"
        return f"<Transacao {tipo} {self.quantidade}x {ticker} @ {self.preco_unitario}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/usuario.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Usuario
Entidade principal para autentica√ß√£o e gest√£o de usu√°rios
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum
from werkzeug.security import generate_password_hash, check_password_hash


class UserRole(enum.Enum):
    """Enum para roles/perfis de usu√°rio"""
    ADMIN = "admin"
    USER = "user"
    READONLY = "readonly"


class Usuario(db.Model):
    """Model para usu√°rios do sistema Exitus"""
    
    __tablename__ = 'usuario'
    
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = db.Column(String(50), unique=True, nullable=False, index=True)
    email = db.Column(String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(String(255), nullable=False)
    nome_completo = db.Column(String(200), nullable=True)
    ativo = db.Column(Boolean, default=True, nullable=False)
    role = db.Column(Enum(UserRole), default=UserRole.USER, nullable=False)
    created_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def set_password(self, password):
        """Define a senha do usu√°rio (gera hash bcrypt)"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Verifica se a senha fornecida est√° correta"""
        return check_password_hash(self.password_hash, password)
    
    def is_admin(self):
        """Verifica se usu√°rio √© administrador"""
        return self.role == UserRole.ADMIN
    
    def is_active(self):
        """Verifica se usu√°rio est√° ativo"""
        return self.ativo
    
    def to_dict(self, include_sensitive=False):
        """Converte objeto para dicion√°rio (para serializa√ß√£o JSON)"""
        data = {
            'id': str(self.id),
            'username': self.username,
            'email': self.email,
            'nome_completo': self.nome_completo,
            'ativo': self.ativo,
            'role': self.role.value if self.role else UserRole.USER.value,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
        if include_sensitive:
            data['password_hash'] = self.password_hash
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Usuario {self.username} ({self.email})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/run_all_seeds.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Executar Todos os Seeds
Script master para popular o banco com dados iniciais
"""

import sys
from app.seeds.seed_usuarios import seed_usuarios
from app.seeds.seed_ativos_br import seed_ativos_br
from app.seeds.seed_regras_fiscais_br import seed_regras_fiscais_br
from app.seeds.seed_feriados_b3 import seed_feriados_b3
from app.seeds.seed_fontes_dados import seed_fontes_dados


def run_all_seeds():
    """Executa todos os seeds em sequ√™ncia"""
    
    print("\n" + "=" * 60)
    print("  EXITUS - EXECUTAR TODOS OS SEEDS")
    print("=" * 60)
    print("\nEste script ir√° popular o banco com dados iniciais:")
    print("  1. Usu√°rios (4)")
    print("  2. Ativos BR (25)")
    print("  3. Regras Fiscais BR (6)")
    print("  4. Feriados B3 2025-2026 (30)")
    print("  5. Fontes de Dados (7)")
    print("\n‚ö† ATEN√á√ÉO: Seeds existentes ser√£o solicitados para confirma√ß√£o.\n")
    
    resposta = input("Deseja continuar? (s/N): ").lower()
    if resposta != 's':
        print("\n‚úó Opera√ß√£o cancelada pelo usu√°rio.\n")
        return
    
    seeds = [
        ("Usu√°rios", seed_usuarios),
        ("Ativos BR", seed_ativos_br),
        ("Regras Fiscais BR", seed_regras_fiscais_br),
        ("Feriados B3", seed_feriados_b3),
        ("Fontes de Dados", seed_fontes_dados),
    ]
    
    sucessos = 0
    erros = 0
    
    for nome, seed_func in seeds:
        print("\n" + "=" * 60)
        try:
            seed_func()
            sucessos += 1
        except KeyboardInterrupt:
            print(f"\n\n‚ö† Seed '{nome}' interrompido pelo usu√°rio.")
            print("Processo de seeds cancelado.\n")
            sys.exit(1)
        except Exception as e:
            print(f"\n‚úó Erro ao executar seed '{nome}': {e}")
            erros += 1
            resposta = input("\nDeseja continuar com os pr√≥ximos seeds? (s/N): ").lower()
            if resposta != 's':
                break
    
    # Resumo final
    print("\n" + "=" * 60)
    print("  RESUMO FINAL")
    print("=" * 60)
    print(f"‚úì Seeds executados com sucesso: {sucessos}")
    if erros > 0:
        print(f"‚úó Seeds com erro: {erros}")
    print("=" * 60 + "\n")
    
    if erros == 0:
        print("üéâ Todos os seeds foram executados com sucesso!")
        print("O banco de dados est√° pronto para uso.\n")
    else:
        print("‚ö† Alguns seeds falharam. Verifique os erros acima.\n")


if __name__ == '__main__':
    run_all_seeds()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_ativos_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Ativos Brasileiros
Popular tabela ativo com a√ß√µes e FIIs da B3
"""

from app import create_app
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal


def seed_ativos_br():
    """Cria ativos brasileiros (B3)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Ativos Brasileiros (B3)")
        print("=" * 50)
        
        # Verificar se j√° existem ativos
        count = Ativo.query.filter_by(mercado='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} ativos brasileiros cadastrados.")
            resposta = input("Deseja recriar os ativos BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar ativos BR existentes
            Ativo.query.filter_by(mercado='BR').delete()
            db.session.commit()
            print("‚úì Ativos brasileiros anteriores removidos.")
        
        # A√ß√µes mais negociadas da B3
        acoes = [
            # Ticker, Nome, Setor, Pre√ßo Inicial
            ('PETR4', 'Petrobras PN', 'Petr√≥leo e G√°s', Decimal('38.50')),
            ('VALE3', 'Vale ON', 'Minera√ß√£o', Decimal('62.80')),
            ('ITUB4', 'Ita√∫ Unibanco PN', 'Bancos', Decimal('28.45')),
            ('BBDC4', 'Bradesco PN', 'Bancos', Decimal('13.20')),
            ('BBAS3', 'Banco do Brasil ON', 'Bancos', Decimal('25.60')),
            ('MGLU3', 'Magazine Luiza ON', 'Varejo', Decimal('8.75')),
            ('WEGE3', 'WEG ON', 'M√°quinas e Equipamentos', Decimal('42.30')),
            ('RENT3', 'Localiza ON', 'Loca√ß√£o de Ve√≠culos', Decimal('56.90')),
            ('RAIL3', 'Rumo ON', 'Transporte', Decimal('18.45')),
            ('SUZB3', 'Suzano ON', 'Papel e Celulose', Decimal('52.80')),
            ('KLBN11', 'Klabin Units', 'Papel e Celulose', Decimal('22.15')),
            ('ELET3', 'Eletrobras ON', 'Energia El√©trica', Decimal('42.10')),
            ('CMIG4', 'Cemig PN', 'Energia El√©trica', Decimal('10.85')),
            ('CPLE6', 'Copel PNB', 'Energia El√©trica', Decimal('8.95')),
            ('ABEV3', 'Ambev ON', 'Bebidas', Decimal('11.20')),
        ]
        
        # FIIs mais negociados
        fiis = [
            # Ticker, Nome, Segmento, Pre√ßo Inicial
            ('HGLG11', 'CSHG Log√≠stica FII', 'Log√≠stica', Decimal('152.30')),
            ('VISC11', 'Vinci Shopping Centers FII', 'Shopping', Decimal('105.80')),
            ('KNRI11', 'Kinea Renda Imobili√°ria FII', 'H√≠brido', Decimal('98.45')),
            ('BTLG11', 'BTG Pactual Log√≠stica FII', 'Log√≠stica', Decimal('102.70')),
            ('XPML11', 'XP Malls FII', 'Shopping', Decimal('95.60')),
            ('MXRF11', 'Maxi Renda FII', 'H√≠brido', Decimal('10.25')),
            ('TRXF11', 'TRX Real Estate FII', 'Lajes Corporativas', Decimal('95.30')),
            ('KNCR11', 'Kinea Rendimentos Imobili√°rios FII', 'Papel', Decimal('110.50')),
            ('LVBI11', 'VBI Log√≠stico FII', 'Log√≠stica', Decimal('98.20')),
            ('GGRC11', 'GGR Covepi Renda FII', 'Lajes Corporativas', Decimal('105.40')),
        ]
        
        created_ativos = []
        
        # Criar a√ß√µes
        print("\nüìà Criando A√ß√µes...")
        for ticker, nome, setor, preco in acoes:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.ACAO,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Setor: {setor}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:35} - R$ {preco}")
        
        # Criar FIIs
        print("\nüè¢ Criando FIIs...")
        for ticker, nome, segmento, preco in fiis:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.FII,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Segmento: {segmento}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:40} - R$ {preco}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_ativos)} ativos criados com sucesso!")
            print(f"  - {len(acoes)} a√ß√µes")
            print(f"  - {len(fiis)} FIIs")
            print("=" * 50 + "\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar ativos: {e}")
            raise


if __name__ == '__main__':
    seed_ativos_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_feriados_b3.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Feriados B3
Popular tabela feriado_mercado com feriados da B3
"""

from app import create_app
from app.database import db
from app.models import FeriadoMercado, TipoFeriado
from datetime import date


def seed_feriados_b3():
    """Cria feriados da B3 para 2025 e 2026"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Feriados B3 (2025-2026)")
        print("=" * 50)
        
        # Verificar se j√° existem feriados B3
        count = FeriadoMercado.query.filter_by(pais='BR', mercado='B3').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} feriados B3 cadastrados.")
            resposta = input("Deseja recriar os feriados? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar feriados B3 existentes
            FeriadoMercado.query.filter_by(pais='BR', mercado='B3').delete()
            db.session.commit()
            print("‚úì Feriados B3 anteriores removidos.")
        
        # Feriados B3 2025
        feriados_2025 = [
            (date(2025, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2025, 3, 3), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2025, 3, 4), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2025, 4, 18), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2025, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2025, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2025, 6, 19), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2025, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2025, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2025, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        # Feriados B3 2026
        feriados_2026 = [
            (date(2026, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2026, 2, 16), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2026, 2, 17), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2026, 4, 3), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2026, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2026, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2026, 6, 4), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2026, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2026, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2026, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        todos_feriados = feriados_2025 + feriados_2026
        created_feriados = []
        
        print("\nüìÖ Criando Feriados 2025...")
        for data_feriado, nome, tipo, recorrente in feriados_2025:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        print("\nüìÖ Criando Feriados 2026...")
        for data_feriado, nome, tipo, recorrente in feriados_2026:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_feriados)} feriados criados!")
            print(f"  - 2025: {len(feriados_2025)} feriados")
            print(f"  - 2026: {len(feriados_2026)} feriados")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  üö´ = Fechamento total (sem preg√£o)")
            print("  ‚è∞ = Fechamento antecipado (meio per√≠odo)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar feriados: {e}")
            raise


if __name__ == '__main__':
    seed_feriados_b3()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_fontes_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Fontes de Dados
Popular tabela fonte_dados com APIs de cota√ß√µes
"""

from app import create_app
from app.database import db
from app.models import FonteDados, TipoFonteDados


def seed_fontes_dados():
    """Cria fontes de dados (APIs)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Fontes de Dados (APIs)")
        print("=" * 50)
        
        # Verificar se j√° existem fontes
        count = FonteDados.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} fontes de dados cadastradas.")
            resposta = input("Deseja recriar as fontes? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar fontes existentes
            FonteDados.query.delete()
            db.session.commit()
            print("‚úì Fontes de dados anteriores removidas.")
        
        # Fontes de dados
        fontes = [
            {
                'nome': 'yfinance',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://query1.finance.yahoo.com',
                'requer_autenticacao': False,
                'rate_limit': '2000/hour',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'Biblioteca Python gratuita para Yahoo Finance. Boa cobertura global, incluindo B3.'
            },
            {
                'nome': 'brapi.dev',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://brapi.dev/api',
                'requer_autenticacao': False,
                'rate_limit': '100/minute',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'API brasileira gratuita especializada em ativos da B3. Dados em tempo real.'
            },
            {
                'nome': 'Alpha Vantage',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://www.alphavantage.co/query',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API gratuita com chave. Limite de 5 requisi√ß√µes por minuto (plano free).'
            },
            {
                'nome': 'Finnhub',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://finnhub.io/api/v1',
                'requer_autenticacao': True,
                'rate_limit': '60/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API com plano gratuito. Boa cobertura de mercados globais e not√≠cias.'
            },
            {
                'nome': 'IEX Cloud',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://cloud.iexapis.com/stable',
                'requer_autenticacao': True,
                'rate_limit': '50000/month',
                'ativa': True,
                'prioridade': 3,
                'observacoes': 'API focada em mercado americano. Plano gratuito com limite mensal.'
            },
            {
                'nome': 'Polygon.io',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://api.polygon.io',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': False,
                'prioridade': 4,
                'observacoes': 'API premium com dados hist√≥ricos detalhados. Desativada por padr√£o.'
            },
            {
                'nome': 'Manual',
                'tipo_fonte': TipoFonteDados.MANUAL,
                'url_base': None,
                'requer_autenticacao': False,
                'rate_limit': None,
                'ativa': True,
                'prioridade': 99,
                'observacoes': 'Entrada manual de dados pelo usu√°rio.'
            },
        ]
        
        created_fontes = []
        
        print("\nüîå Criando Fontes de Dados...")
        for fonte_data in fontes:
            fonte = FonteDados(
                nome=fonte_data['nome'],
                tipo_fonte=fonte_data['tipo_fonte'],
                url_base=fonte_data['url_base'],
                requer_autenticacao=fonte_data['requer_autenticacao'],
                rate_limit=fonte_data['rate_limit'],
                ativa=fonte_data['ativa'],
                prioridade=fonte_data['prioridade'],
                observacoes=fonte_data['observacoes']
            )
            db.session.add(fonte)
            created_fontes.append(fonte)
            
            status_icon = "‚úì" if fonte.ativa else "‚úó"
            auth_icon = "üîê" if fonte.requer_autenticacao else "üîì"
            
            print(f"  {status_icon} {auth_icon} {fonte.nome:20} | Prioridade: {fonte.prioridade} | Limite: {fonte.rate_limit or 'N/A'}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_fontes)} fontes de dados criadas!")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  ‚úì = Ativa    | ‚úó = Inativa")
            print("  üîì = Sem auth | üîê = Requer chave API")
            print("\nüí° PRIORIDADE:")
            print("  1 = Alta (usar primeiro)")
            print("  2-3 = M√©dia (fallback)")
            print("  99 = Baixa (manual)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar fontes: {e}")
            raise


if __name__ == '__main__':
    seed_fontes_dados()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_regras_fiscais_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Regras Fiscais Brasileiras
Popular tabela regra_fiscal com regras de IR do Brasil
"""

from app import create_app
from app.database import db
from app.models import RegraFiscal, IncidenciaImposto
from decimal import Decimal
from datetime import date


def seed_regras_fiscais_br():
    """Cria regras fiscais brasileiras"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Regras Fiscais Brasileiras")
        print("=" * 50)
        
        # Verificar se j√° existem regras BR
        count = RegraFiscal.query.filter_by(pais='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} regras fiscais brasileiras.")
            resposta = input("Deseja recriar as regras BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar regras BR existentes
            RegraFiscal.query.filter_by(pais='BR').delete()
            db.session.commit()
            print("‚úì Regras fiscais brasileiras anteriores removidas.")
        
        # Regras fiscais brasileiras
        regras = [
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': Decimal('20000.00'),
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em a√ß√µes - Swing Trade. Isen√ß√£o para vendas at√© R$ 20.000,00 por m√™s.'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'DAY_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em Day Trade. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em FIIs. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': None,  # Aplica a todos
                'tipo_operacao': None,
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'IR sobre JCP (Juros sobre Capital Pr√≥prio). Retido na fonte, al√≠quota de 15%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Rendimentos de FII s√£o ISENTOS de IR para pessoa f√≠sica (requisitos: FII com +50 cotistas, cotas negociadas em bolsa, investidor com <10% das cotas).'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Dividendos de a√ß√µes s√£o ISENTOS de IR para pessoa f√≠sica no Brasil.'
            },
        ]
        
        created_regras = []
        
        print("\nüìã Criando Regras...")
        for regra_data in regras:
            regra = RegraFiscal(
                pais='BR',
                tipo_ativo=regra_data['tipo_ativo'],
                tipo_operacao=regra_data['tipo_operacao'],
                aliquota_ir=regra_data['aliquota_ir'],
                valor_isencao=regra_data['valor_isencao'],
                incide_sobre=regra_data['incide_sobre'],
                descricao=regra_data['descricao'],
                vigencia_inicio=date(2024, 1, 1),
                ativa=True
            )
            db.session.add(regra)
            created_regras.append(regra)
            
            tipo_str = regra_data['tipo_ativo'] or 'TODOS'
            op_str = regra_data['tipo_operacao'] or 'TODAS'
            isencao_str = f"R$ {regra_data['valor_isencao']}" if regra_data['valor_isencao'] else "SEM"
            
            print(f"  ‚úì {tipo_str:10} | {op_str:12} | IR: {regra_data['aliquota_ir']:6}% | Isen√ß√£o: {isencao_str}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_regras)} regras fiscais criadas!")
            print("=" * 50)
            print("\nüìå RESUMO DAS REGRAS:")
            print("-" * 50)
            print("‚Ä¢ A√ß√µes Swing Trade: 15% IR (isen√ß√£o at√© R$ 20k/m√™s)")
            print("‚Ä¢ A√ß√µes Day Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ FII Swing Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ Dividendos de A√ß√µes: ISENTO")
            print("‚Ä¢ Rendimentos de FII: ISENTO*")
            print("‚Ä¢ JCP: 15% IR retido na fonte")
            print("-" * 50)
            print("* Requisitos para isen√ß√£o de FII aplicam-se\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar regras fiscais: {e}")
            raise


if __name__ == '__main__':
    seed_regras_fiscais_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_usuarios.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Usu√°rios
Popular tabela usuario com dados iniciais
"""
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))


from app import create_app
from app.database import db
from app.models import Usuario, UserRole
from datetime import datetime


def seed_usuarios():
    """Cria usu√°rios iniciais do sistema"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Usu√°rios Iniciais")
        print("=" * 50)
        
        # Verificar se j√° existem usu√°rios
        count = Usuario.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} usu√°rios cadastrados.")
            resposta = input("Deseja recriar os usu√°rios? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar usu√°rios existentes
            Usuario.query.delete()
            db.session.commit()
            print("‚úì Usu√°rios anteriores removidos.")
        
        # Lista de usu√°rios a criar
        usuarios = [
            {
                'username': 'admin',
                'email': 'admin@exitus.com',
                'password': 'admin123',  # Senha padr√£o para desenvolvimento
                'nome_completo': 'Administrador do Sistema',
                'role': UserRole.ADMIN,
                'ativo': True
            },
            {
                'username': 'joao.silva',
                'email': 'joao.silva@example.com',
                'password': 'user123',
                'nome_completo': 'Jo√£o Silva',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'maria.santos',
                'email': 'maria.santos@example.com',
                'password': 'user123',
                'nome_completo': 'Maria Santos',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'viewer',
                'email': 'viewer@exitus.com',
                'password': 'viewer123',
                'nome_completo': 'Usu√°rio Visualizador',
                'role': UserRole.READONLY,
                'ativo': True
            }
        ]
        
        # Criar usu√°rios
        created_users = []
        for user_data in usuarios:
            user = Usuario(
                username=user_data['username'],
                email=user_data['email'],
                nome_completo=user_data.get('nome_completo'),
                role=user_data['role'],
                ativo=user_data['ativo']
            )
            user.set_password(user_data['password'])
            
            db.session.add(user)
            created_users.append(user)
            
            print(f"‚úì Usu√°rio criado: {user.username} ({user.role.value}) - {user.email}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_users)} usu√°rios criados com sucesso!")
            print("=" * 50)
            
            # Exibir credenciais
            print("\nüìã CREDENCIAIS DE ACESSO:")
            print("-" * 50)
            for user_data in usuarios:
                print(f"Username: {user_data['username']:<15} | Senha: {user_data['password']}")
            print("-" * 50)
            print("‚ö† ATEN√á√ÉO: Altere as senhas em produ√ß√£o!\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar usu√°rios: {e}")
            raise


if __name__ == '__main__':
    seed_usuarios()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
alembic==1.13.1
Flask-Migrate==4.0.5

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backup_fase4_20251126.sql ---
--
-- PostgreSQL database dump
--

\restrict GKPkJ0HUazHhGWoZucB0W175i385M8gluav75q4QDk791AqK2yfWUeOUdV3G2s9

-- Dumped from database version 15.15 (Debian 15.15-1.pgdg13+1)
-- Dumped by pg_dump version 15.15 (Debian 15.15-1.pgdg13+1)

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: classeativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.classeativo AS ENUM (
    'RENDA_VARIAVEL',
    'RENDA_FIXA',
    'CRIPTO',
    'HIBRIDO'
);


ALTER TYPE public.classeativo OWNER TO exitus;

--
-- Name: incidenciaimposto; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.incidenciaimposto AS ENUM (
    'LUCRO',
    'RECEITA',
    'PROVENTO',
    'OPERACAO'
);


ALTER TYPE public.incidenciaimposto OWNER TO exitus;

--
-- Name: tipoativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoativo AS ENUM (
    'ACAO',
    'FII',
    'REIT',
    'BOND',
    'ETF',
    'CRIPTO',
    'OUTRO'
);


ALTER TYPE public.tipoativo OWNER TO exitus;

--
-- Name: tipocorretora; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipocorretora AS ENUM (
    'CORRETORA',
    'EXCHANGE'
);


ALTER TYPE public.tipocorretora OWNER TO exitus;

--
-- Name: tipoeventocorporativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoeventocorporativo AS ENUM (
    'SPLIT',
    'GRUPAMENTO',
    'BONIFICACAO',
    'DIREITO_SUBSCRICAO',
    'FUSAO',
    'CISAO',
    'INCORPORACAO',
    'MUDANCA_TICKER',
    'DESLISTAGEM',
    'RELISTING',
    'CANCELAMENTO',
    'OUTRO'
);


ALTER TYPE public.tipoeventocorporativo OWNER TO exitus;

--
-- Name: tipoferiado; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoferiado AS ENUM (
    'NACIONAL',
    'BOLSA',
    'PONTE',
    'FECHAMENTO_ANTECIPADO',
    'MANUTENCAO',
    'OUTRO'
);


ALTER TYPE public.tipoferiado OWNER TO exitus;

--
-- Name: tipofontedados; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipofontedados AS ENUM (
    'API',
    'SCRAPER',
    'MANUAL',
    'ARQUIVO',
    'OUTRO'
);


ALTER TYPE public.tipofontedados OWNER TO exitus;

--
-- Name: tipomovimentacao; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipomovimentacao AS ENUM (
    'DEPOSITO',
    'SAQUE',
    'TRANSFERENCIA_ENVIADA',
    'TRANSFERENCIA_RECEBIDA',
    'CREDITO_PROVENTO',
    'PAGAMENTO_TAXA',
    'PAGAMENTO_IMPOSTO',
    'AJUSTE',
    'OUTRO'
);


ALTER TYPE public.tipomovimentacao OWNER TO exitus;

--
-- Name: tipooperacao; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipooperacao AS ENUM (
    'COMPRA',
    'VENDA'
);


ALTER TYPE public.tipooperacao OWNER TO exitus;

--
-- Name: tipoprovento; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoprovento AS ENUM (
    'DIVIDENDO',
    'JCP',
    'RENDIMENTO',
    'CUPOM',
    'BONIFICACAO',
    'DIREITO_SUBSCRICAO',
    'OUTRO'
);


ALTER TYPE public.tipoprovento OWNER TO exitus;

--
-- Name: userrole; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.userrole AS ENUM (
    'ADMIN',
    'USER',
    'READONLY'
);


ALTER TYPE public.userrole OWNER TO exitus;

SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: alembic_version; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.alembic_version (
    version_num character varying(32) NOT NULL
);


ALTER TABLE public.alembic_version OWNER TO exitus;

--
-- Name: ativo; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.ativo (
    id uuid NOT NULL,
    ticker character varying(20) NOT NULL,
    nome character varying(200) NOT NULL,
    tipo public.tipoativo NOT NULL,
    classe public.classeativo NOT NULL,
    mercado character varying(10) NOT NULL,
    moeda character varying(3) NOT NULL,
    preco_atual numeric(18,6),
    data_ultima_cotacao timestamp with time zone,
    dividend_yield numeric(8,4),
    p_l numeric(10,2),
    p_vp numeric(10,2),
    roe numeric(8,4),
    ativo boolean NOT NULL,
    deslistado boolean NOT NULL,
    data_deslistagem date,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT ativo_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT ativo_preco_positivo CHECK (((preco_atual IS NULL) OR (preco_atual >= (0)::numeric))),
    CONSTRAINT ativo_ticker_min_length CHECK ((length((ticker)::text) >= 1))
);


ALTER TABLE public.ativo OWNER TO exitus;

--
-- Name: TABLE ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.ativo IS 'Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)';


--
-- Name: COLUMN ativo.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.id IS 'Identificador √∫nico do ativo';


--
-- Name: COLUMN ativo.ticker; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.ticker IS 'C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)';


--
-- Name: COLUMN ativo.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.nome IS 'Nome completo do ativo';


--
-- Name: COLUMN ativo.tipo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.tipo IS 'Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)';


--
-- Name: COLUMN ativo.classe; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.classe IS 'Classe do ativo (renda vari√°vel, fixa, cripto)';


--
-- Name: COLUMN ativo.mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.mercado IS 'Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)';


--
-- Name: COLUMN ativo.moeda; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.moeda IS 'Moeda de negocia√ß√£o (BRL, USD, EUR)';


--
-- Name: COLUMN ativo.preco_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.preco_atual IS 'Pre√ßo/cota√ß√£o atual do ativo';


--
-- Name: COLUMN ativo.data_ultima_cotacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.data_ultima_cotacao IS 'Data e hora da √∫ltima cota√ß√£o';


--
-- Name: COLUMN ativo.dividend_yield; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.dividend_yield IS 'Dividend Yield em % (ex: 6.5000 = 6.5%)';


--
-- Name: COLUMN ativo.p_l; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.p_l IS '√çndice Pre√ßo/Lucro';


--
-- Name: COLUMN ativo.p_vp; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.p_vp IS '√çndice Pre√ßo/Valor Patrimonial';


--
-- Name: COLUMN ativo.roe; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.roe IS 'Return on Equity em %';


--
-- Name: COLUMN ativo.ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.ativo IS 'Indica se ativo est√° dispon√≠vel para negocia√ß√£o';


--
-- Name: COLUMN ativo.deslistado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.deslistado IS 'Indica se ativo foi deslistado da bolsa';


--
-- Name: COLUMN ativo.data_deslistagem; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.data_deslistagem IS 'Data de deslistagem (se aplic√°vel)';


--
-- Name: COLUMN ativo.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.observacoes IS 'Observa√ß√µes e notas sobre o ativo';


--
-- Name: COLUMN ativo.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN ativo.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: corretora; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.corretora (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    nome character varying(100) NOT NULL,
    tipo public.tipocorretora NOT NULL,
    pais character varying(2) NOT NULL,
    moeda_padrao character varying(3) NOT NULL,
    saldo_atual numeric(18,2) NOT NULL,
    ativa boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT corretora_moeda_iso_format CHECK (((moeda_padrao)::text ~* '^[A-Z]{3}$'::text)),
    CONSTRAINT corretora_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT corretora_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text)),
    CONSTRAINT corretora_saldo_positivo CHECK ((saldo_atual >= (0)::numeric))
);


ALTER TABLE public.corretora OWNER TO exitus;

--
-- Name: TABLE corretora; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.corretora IS 'Tabela de corretoras e contas de investimento';


--
-- Name: COLUMN corretora.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.id IS 'Identificador √∫nico da corretora';


--
-- Name: COLUMN corretora.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.usuario_id IS 'ID do usu√°rio propriet√°rio';


--
-- Name: COLUMN corretora.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.nome IS 'Nome da corretora/exchange (ex: XP, Clear, Binance)';


--
-- Name: COLUMN corretora.tipo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.tipo IS 'Tipo: corretora tradicional ou exchange cripto';


--
-- Name: COLUMN corretora.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.pais IS 'C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN corretora.moeda_padrao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.moeda_padrao IS 'C√≥digo ISO 4217 da moeda (BRL, USD, EUR)';


--
-- Name: COLUMN corretora.saldo_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.saldo_atual IS 'Saldo dispon√≠vel em caixa (na moeda padr√£o)';


--
-- Name: COLUMN corretora.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.ativa IS 'Indica se conta est√° ativa';


--
-- Name: COLUMN corretora.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.observacoes IS 'Observa√ß√µes e notas do usu√°rio sobre a conta';


--
-- Name: COLUMN corretora.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN corretora.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: evento_corporativo; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.evento_corporativo (
    id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    ativo_novo_id uuid,
    tipo_evento public.tipoeventocorporativo NOT NULL,
    data_evento date NOT NULL,
    data_com date,
    proporcao character varying(20),
    descricao text NOT NULL,
    impacto_posicoes boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT evento_data_com_valida CHECK (((data_com IS NULL) OR (data_com <= data_evento)))
);


ALTER TABLE public.evento_corporativo OWNER TO exitus;

--
-- Name: TABLE evento_corporativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.evento_corporativo IS 'Tabela de eventos corporativos que afetam ativos';


--
-- Name: COLUMN evento_corporativo.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.id IS 'Identificador √∫nico do evento';


--
-- Name: COLUMN evento_corporativo.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.ativo_id IS 'ID do ativo afetado pelo evento';


--
-- Name: COLUMN evento_corporativo.ativo_novo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.ativo_novo_id IS 'ID do novo ativo (fus√µes, mudan√ßas de ticker)';


--
-- Name: COLUMN evento_corporativo.tipo_evento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.tipo_evento IS 'Tipo do evento corporativo';


--
-- Name: COLUMN evento_corporativo.data_evento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.data_evento IS 'Data do evento';


--
-- Name: COLUMN evento_corporativo.data_com; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.data_com IS 'Data COM (√∫ltimo dia para ter direito ao evento)';


--
-- Name: COLUMN evento_corporativo.proporcao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.proporcao IS 'Propor√ß√£o do evento (ex: ''2:1'', ''1:10'', ''1:1.5'')';


--
-- Name: COLUMN evento_corporativo.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.descricao IS 'Descri√ß√£o detalhada do evento';


--
-- Name: COLUMN evento_corporativo.impacto_posicoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.impacto_posicoes IS 'Indica se as posi√ß√µes j√° foram ajustadas';


--
-- Name: COLUMN evento_corporativo.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.observacoes IS 'Observa√ß√µes adicionais sobre o evento';


--
-- Name: COLUMN evento_corporativo.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN evento_corporativo.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: feriado_mercado; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.feriado_mercado (
    id uuid NOT NULL,
    pais character varying(2) NOT NULL,
    mercado character varying(20),
    data_feriado date NOT NULL,
    tipo_feriado public.tipoferiado NOT NULL,
    nome character varying(200) NOT NULL,
    horario_fechamento time without time zone,
    recorrente boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT feriado_nome_min_length CHECK ((length((nome)::text) >= 3)),
    CONSTRAINT feriado_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text))
);


ALTER TABLE public.feriado_mercado OWNER TO exitus;

--
-- Name: TABLE feriado_mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.feriado_mercado IS 'Tabela de feriados e dias sem preg√£o nos mercados';


--
-- Name: COLUMN feriado_mercado.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.id IS 'Identificador √∫nico do feriado';


--
-- Name: COLUMN feriado_mercado.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.pais IS 'C√≥digo ISO do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN feriado_mercado.mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.mercado IS 'Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos';


--
-- Name: COLUMN feriado_mercado.data_feriado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.data_feriado IS 'Data do feriado';


--
-- Name: COLUMN feriado_mercado.tipo_feriado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.tipo_feriado IS 'Tipo do feriado';


--
-- Name: COLUMN feriado_mercado.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.nome IS 'Nome do feriado';


--
-- Name: COLUMN feriado_mercado.horario_fechamento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.horario_fechamento IS 'Hor√°rio de fechamento antecipado (se aplic√°vel)';


--
-- Name: COLUMN feriado_mercado.recorrente; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.recorrente IS 'Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)';


--
-- Name: COLUMN feriado_mercado.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.observacoes IS 'Observa√ß√µes sobre o feriado';


--
-- Name: COLUMN feriado_mercado.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN feriado_mercado.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: fonte_dados; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.fonte_dados (
    id uuid NOT NULL,
    nome character varying(100) NOT NULL,
    tipo_fonte public.tipofontedados NOT NULL,
    url_base character varying(500),
    requer_autenticacao boolean NOT NULL,
    rate_limit character varying(50),
    ativa boolean NOT NULL,
    prioridade integer NOT NULL,
    ultima_consulta timestamp with time zone,
    total_consultas integer NOT NULL,
    total_erros integer NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT fonte_consultas_positivas CHECK ((total_consultas >= 0)),
    CONSTRAINT fonte_erros_positivos CHECK ((total_erros >= 0)),
    CONSTRAINT fonte_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT fonte_prioridade_positiva CHECK ((prioridade > 0))
);


ALTER TABLE public.fonte_dados OWNER TO exitus;

--
-- Name: TABLE fonte_dados; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.fonte_dados IS 'Tabela de fontes de dados externas (APIs, scrapers)';


--
-- Name: COLUMN fonte_dados.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.id IS 'Identificador √∫nico da fonte';


--
-- Name: COLUMN fonte_dados.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.nome IS 'Nome da fonte de dados (ex: yfinance, Alpha Vantage)';


--
-- Name: COLUMN fonte_dados.tipo_fonte; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.tipo_fonte IS 'Tipo da fonte de dados';


--
-- Name: COLUMN fonte_dados.url_base; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.url_base IS 'URL base da API ou site';


--
-- Name: COLUMN fonte_dados.requer_autenticacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.requer_autenticacao IS 'Indica se requer chave API ou autentica√ß√£o';


--
-- Name: COLUMN fonte_dados.rate_limit; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.rate_limit IS 'Limite de requisi√ß√µes (ex: ''5/minute'', ''500/day'')';


--
-- Name: COLUMN fonte_dados.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.ativa IS 'Indica se fonte est√° ativa';


--
-- Name: COLUMN fonte_dados.prioridade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.prioridade IS 'Ordem de prioridade (1 = maior prioridade)';


--
-- Name: COLUMN fonte_dados.ultima_consulta; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.ultima_consulta IS 'Timestamp da √∫ltima consulta bem-sucedida';


--
-- Name: COLUMN fonte_dados.total_consultas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.total_consultas IS 'Total de consultas realizadas';


--
-- Name: COLUMN fonte_dados.total_erros; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.total_erros IS 'Total de erros encontrados';


--
-- Name: COLUMN fonte_dados.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.observacoes IS 'Observa√ß√µes sobre a fonte de dados';


--
-- Name: COLUMN fonte_dados.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN fonte_dados.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: log_auditoria; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.log_auditoria (
    id uuid NOT NULL,
    usuario_id uuid,
    acao character varying(50) NOT NULL,
    entidade character varying(100),
    entidade_id uuid,
    dados_antes json,
    dados_depois json,
    ip_address character varying(45),
    user_agent character varying(500),
    "timestamp" timestamp with time zone NOT NULL,
    sucesso boolean NOT NULL,
    mensagem text,
    CONSTRAINT log_acao_min_length CHECK ((length((acao)::text) >= 3))
);


ALTER TABLE public.log_auditoria OWNER TO exitus;

--
-- Name: TABLE log_auditoria; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.log_auditoria IS 'Tabela de logs de auditoria para compliance';


--
-- Name: COLUMN log_auditoria.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.id IS 'Identificador √∫nico do log';


--
-- Name: COLUMN log_auditoria.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.usuario_id IS 'ID do usu√°rio (NULL para a√ß√µes an√¥nimas)';


--
-- Name: COLUMN log_auditoria.acao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.acao IS 'Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)';


--
-- Name: COLUMN log_auditoria.entidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.entidade IS 'Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)';


--
-- Name: COLUMN log_auditoria.entidade_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.entidade_id IS 'ID do registro afetado';


--
-- Name: COLUMN log_auditoria.dados_antes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.dados_antes IS 'Estado anterior do registro (JSON)';


--
-- Name: COLUMN log_auditoria.dados_depois; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.dados_depois IS 'Estado posterior do registro (JSON)';


--
-- Name: COLUMN log_auditoria.ip_address; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.ip_address IS 'Endere√ßo IP de origem';


--
-- Name: COLUMN log_auditoria.user_agent; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.user_agent IS 'User-Agent (navegador/cliente)';


--
-- Name: COLUMN log_auditoria."timestamp"; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria."timestamp" IS 'Data/hora da a√ß√£o';


--
-- Name: COLUMN log_auditoria.sucesso; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.sucesso IS 'Indica se a√ß√£o foi bem-sucedida';


--
-- Name: COLUMN log_auditoria.mensagem; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.mensagem IS 'Mensagem de erro ou detalhes adicionais';


--
-- Name: movimentacao_caixa; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.movimentacao_caixa (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    corretora_destino_id uuid,
    provento_id uuid,
    tipo_movimentacao public.tipomovimentacao NOT NULL,
    valor numeric(18,2) NOT NULL,
    moeda character varying(3) NOT NULL,
    data_movimentacao date NOT NULL,
    descricao text,
    comprovante character varying(200),
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT movimentacao_moeda_iso_format CHECK (((moeda)::text ~* '^[A-Z]{3}$'::text)),
    CONSTRAINT movimentacao_valor_positivo CHECK ((valor > (0)::numeric))
);


ALTER TABLE public.movimentacao_caixa OWNER TO exitus;

--
-- Name: TABLE movimentacao_caixa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.movimentacao_caixa IS 'Tabela de movimenta√ß√µes de caixa em corretoras';


--
-- Name: COLUMN movimentacao_caixa.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.id IS 'Identificador √∫nico da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.usuario_id IS 'ID do usu√°rio';


--
-- Name: COLUMN movimentacao_caixa.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.corretora_id IS 'ID da corretora (origem)';


--
-- Name: COLUMN movimentacao_caixa.corretora_destino_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.corretora_destino_id IS 'ID da corretora destino (apenas para transfer√™ncias)';


--
-- Name: COLUMN movimentacao_caixa.provento_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.provento_id IS 'ID do provento (apenas para cr√©dito de provento)';


--
-- Name: COLUMN movimentacao_caixa.tipo_movimentacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.tipo_movimentacao IS 'Tipo da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.valor; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.valor IS 'Valor da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.moeda; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.moeda IS 'C√≥digo ISO 4217 da moeda (BRL, USD, EUR)';


--
-- Name: COLUMN movimentacao_caixa.data_movimentacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.data_movimentacao IS 'Data da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.descricao IS 'Descri√ß√£o da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.comprovante; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.comprovante IS 'Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)';


--
-- Name: COLUMN movimentacao_caixa.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN movimentacao_caixa.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: posicao; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.posicao (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    quantidade numeric(18,8) NOT NULL,
    preco_medio numeric(18,6) NOT NULL,
    custo_total numeric(18,2) NOT NULL,
    taxas_acumuladas numeric(18,2) NOT NULL,
    impostos_acumulados numeric(18,2) NOT NULL,
    valor_atual numeric(18,2),
    lucro_prejuizo_realizado numeric(18,2) NOT NULL,
    lucro_prejuizo_nao_realizado numeric(18,2),
    data_primeira_compra date,
    data_ultima_atualizacao timestamp with time zone,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT posicao_custo_total_positivo CHECK ((custo_total >= (0)::numeric)),
    CONSTRAINT posicao_impostos_positivos CHECK ((impostos_acumulados >= (0)::numeric)),
    CONSTRAINT posicao_preco_medio_positivo CHECK ((preco_medio >= (0)::numeric)),
    CONSTRAINT posicao_quantidade_positiva CHECK ((quantidade >= (0)::numeric)),
    CONSTRAINT posicao_taxas_positivas CHECK ((taxas_acumuladas >= (0)::numeric))
);


ALTER TABLE public.posicao OWNER TO exitus;

--
-- Name: TABLE posicao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.posicao IS 'Tabela de posi√ß√µes em carteira (holdings)';


--
-- Name: COLUMN posicao.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.id IS 'Identificador √∫nico da posi√ß√£o';


--
-- Name: COLUMN posicao.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.usuario_id IS 'ID do usu√°rio propriet√°rio';


--
-- Name: COLUMN posicao.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.corretora_id IS 'ID da corretora onde est√° a posi√ß√£o';


--
-- Name: COLUMN posicao.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.ativo_id IS 'ID do ativo';


--
-- Name: COLUMN posicao.quantidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.quantidade IS 'Quantidade de ativos (suporta fracion√°rios)';


--
-- Name: COLUMN posicao.preco_medio; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.preco_medio IS 'Pre√ßo m√©dio de aquisi√ß√£o';


--
-- Name: COLUMN posicao.custo_total; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.custo_total IS 'Custo total investido (quantidade * pre√ßo m√©dio)';


--
-- Name: COLUMN posicao.taxas_acumuladas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.taxas_acumuladas IS 'Taxas de corretagem e cust√≥dia acumuladas';


--
-- Name: COLUMN posicao.impostos_acumulados; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.impostos_acumulados IS 'Impostos pagos acumulados (IR, IOF, etc.)';


--
-- Name: COLUMN posicao.valor_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.valor_atual IS 'Valor de mercado atual da posi√ß√£o';


--
-- Name: COLUMN posicao.lucro_prejuizo_realizado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.lucro_prejuizo_realizado IS 'Lucro/preju√≠zo realizado em vendas';


--
-- Name: COLUMN posicao.lucro_prejuizo_nao_realizado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.lucro_prejuizo_nao_realizado IS 'Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)';


--
-- Name: COLUMN posicao.data_primeira_compra; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.data_primeira_compra IS 'Data da primeira aquisi√ß√£o deste ativo';


--
-- Name: COLUMN posicao.data_ultima_atualizacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.data_ultima_atualizacao IS 'Data da √∫ltima atualiza√ß√£o de valores';


--
-- Name: COLUMN posicao.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN posicao.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: provento; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.provento (
    id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    tipo_provento public.tipoprovento NOT NULL,
    valor_por_acao numeric(18,6) NOT NULL,
    quantidade_ativos numeric(18,8) NOT NULL,
    valor_bruto numeric(18,2) NOT NULL,
    imposto_retido numeric(18,2) NOT NULL,
    valor_liquido numeric(18,2) NOT NULL,
    data_com date NOT NULL,
    data_pagamento date NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT provento_data_pagamento_valida CHECK ((data_pagamento >= data_com)),
    CONSTRAINT provento_imposto_positivo CHECK ((imposto_retido >= (0)::numeric)),
    CONSTRAINT provento_liquido_menor_bruto CHECK ((valor_liquido <= valor_bruto)),
    CONSTRAINT provento_quantidade_positiva CHECK ((quantidade_ativos > (0)::numeric)),
    CONSTRAINT provento_valor_bruto_positivo CHECK ((valor_bruto > (0)::numeric)),
    CONSTRAINT provento_valor_liquido_positivo CHECK ((valor_liquido > (0)::numeric)),
    CONSTRAINT provento_valor_por_acao_positivo CHECK ((valor_por_acao > (0)::numeric))
);


ALTER TABLE public.provento OWNER TO exitus;

--
-- Name: TABLE provento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.provento IS 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)';


--
-- Name: COLUMN provento.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.id IS 'Identificador √∫nico do provento';


--
-- Name: COLUMN provento.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.ativo_id IS 'ID do ativo que pagou o provento';


--
-- Name: COLUMN provento.tipo_provento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.tipo_provento IS 'Tipo do provento (dividendo, JCP, rendimento, etc.)';


--
-- Name: COLUMN provento.valor_por_acao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_por_acao IS 'Valor unit√°rio por ativo';


--
-- Name: COLUMN provento.quantidade_ativos; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.quantidade_ativos IS 'Quantidade de ativos que geraram o provento';


--
-- Name: COLUMN provento.valor_bruto; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_bruto IS 'Valor bruto recebido';


--
-- Name: COLUMN provento.imposto_retido; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.imposto_retido IS 'IR retido na fonte';


--
-- Name: COLUMN provento.valor_liquido; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_liquido IS 'Valor l√≠quido creditado';


--
-- Name: COLUMN provento.data_com; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.data_com IS 'Data COM (√∫ltimo dia para ter direito ao provento)';


--
-- Name: COLUMN provento.data_pagamento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.data_pagamento IS 'Data efetiva do pagamento';


--
-- Name: COLUMN provento.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.observacoes IS 'Observa√ß√µes sobre o provento';


--
-- Name: COLUMN provento.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN provento.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: regra_fiscal; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.regra_fiscal (
    id uuid NOT NULL,
    pais character varying(2) NOT NULL,
    tipo_ativo character varying(20),
    tipo_operacao character varying(20),
    aliquota_ir numeric(6,4) NOT NULL,
    valor_isencao numeric(18,2),
    incide_sobre public.incidenciaimposto NOT NULL,
    descricao text NOT NULL,
    vigencia_inicio date NOT NULL,
    vigencia_fim date,
    ativa boolean NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT regra_aliquota_valida CHECK (((aliquota_ir >= (0)::numeric) AND (aliquota_ir <= (100)::numeric))),
    CONSTRAINT regra_isencao_positiva CHECK (((valor_isencao IS NULL) OR (valor_isencao >= (0)::numeric))),
    CONSTRAINT regra_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text)),
    CONSTRAINT regra_vigencia_valida CHECK (((vigencia_fim IS NULL) OR (vigencia_fim >= vigencia_inicio)))
);


ALTER TABLE public.regra_fiscal OWNER TO exitus;

--
-- Name: TABLE regra_fiscal; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.regra_fiscal IS 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo';


--
-- Name: COLUMN regra_fiscal.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.id IS 'Identificador √∫nico da regra';


--
-- Name: COLUMN regra_fiscal.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.pais IS 'C√≥digo ISO do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN regra_fiscal.tipo_ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.tipo_ativo IS 'Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos';


--
-- Name: COLUMN regra_fiscal.tipo_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.tipo_operacao IS 'Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas';


--
-- Name: COLUMN regra_fiscal.aliquota_ir; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.aliquota_ir IS 'Al√≠quota de IR em % (ex: 15.0000 = 15%)';


--
-- Name: COLUMN regra_fiscal.valor_isencao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.valor_isencao IS 'Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)';


--
-- Name: COLUMN regra_fiscal.incide_sobre; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.incide_sobre IS 'Sobre o que incide o imposto';


--
-- Name: COLUMN regra_fiscal.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.descricao IS 'Descri√ß√£o detalhada da regra fiscal';


--
-- Name: COLUMN regra_fiscal.vigencia_inicio; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.vigencia_inicio IS 'Data de in√≠cio da vig√™ncia da regra';


--
-- Name: COLUMN regra_fiscal.vigencia_fim; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.vigencia_fim IS 'Data de fim da vig√™ncia (NULL = vigente indefinidamente)';


--
-- Name: COLUMN regra_fiscal.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.ativa IS 'Indica se regra est√° ativa';


--
-- Name: COLUMN regra_fiscal.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN regra_fiscal.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: transacao; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.transacao (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    tipo_operacao public.tipooperacao NOT NULL,
    quantidade numeric(18,8) NOT NULL,
    preco_unitario numeric(18,6) NOT NULL,
    valor_total numeric(18,2) NOT NULL,
    taxas numeric(18,2) NOT NULL,
    impostos numeric(18,2) NOT NULL,
    data_operacao date NOT NULL,
    data_liquidacao date,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT transacao_data_liquidacao_valida CHECK (((data_liquidacao IS NULL) OR (data_liquidacao >= data_operacao))),
    CONSTRAINT transacao_impostos_positivos CHECK ((impostos >= (0)::numeric)),
    CONSTRAINT transacao_preco_positivo CHECK ((preco_unitario > (0)::numeric)),
    CONSTRAINT transacao_quantidade_positiva CHECK ((quantidade > (0)::numeric)),
    CONSTRAINT transacao_taxas_positivas CHECK ((taxas >= (0)::numeric)),
    CONSTRAINT transacao_valor_total_positivo CHECK ((valor_total > (0)::numeric))
);


ALTER TABLE public.transacao OWNER TO exitus;

--
-- Name: TABLE transacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.transacao IS 'Tabela de transa√ß√µes de compra e venda de ativos';


--
-- Name: COLUMN transacao.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.id IS 'Identificador √∫nico da transa√ß√£o';


--
-- Name: COLUMN transacao.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.usuario_id IS 'ID do usu√°rio';


--
-- Name: COLUMN transacao.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.corretora_id IS 'ID da corretora';


--
-- Name: COLUMN transacao.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.ativo_id IS 'ID do ativo transacionado';


--
-- Name: COLUMN transacao.tipo_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.tipo_operacao IS 'Tipo de opera√ß√£o: COMPRA ou VENDA';


--
-- Name: COLUMN transacao.quantidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.quantidade IS 'Quantidade transacionada (suporta fracion√°rios)';


--
-- Name: COLUMN transacao.preco_unitario; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.preco_unitario IS 'Pre√ßo por unidade';


--
-- Name: COLUMN transacao.valor_total; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.valor_total IS 'Valor total da opera√ß√£o (quantidade * pre√ßo)';


--
-- Name: COLUMN transacao.taxas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.taxas IS 'Taxas de corretagem, cust√≥dia, emolumentos';


--
-- Name: COLUMN transacao.impostos; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.impostos IS 'IR retido na fonte, IOF, etc.';


--
-- Name: COLUMN transacao.data_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.data_operacao IS 'Data da opera√ß√£o';


--
-- Name: COLUMN transacao.data_liquidacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.data_liquidacao IS 'Data de liquida√ß√£o (D+2, D+3, etc.)';


--
-- Name: COLUMN transacao.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.observacoes IS 'Observa√ß√µes sobre a transa√ß√£o';


--
-- Name: COLUMN transacao.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN transacao.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: usuario; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.usuario (
    id uuid NOT NULL,
    username character varying(50) NOT NULL,
    email character varying(120) NOT NULL,
    password_hash character varying(255) NOT NULL,
    nome_completo character varying(200),
    ativo boolean NOT NULL,
    role public.userrole NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL
);


ALTER TABLE public.usuario OWNER TO exitus;

--
-- Data for Name: alembic_version; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.alembic_version (version_num) FROM stdin;
b2542b2f7857
\.


--
-- Data for Name: ativo; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.ativo (id, ticker, nome, tipo, classe, mercado, moeda, preco_atual, data_ultima_cotacao, dividend_yield, p_l, p_vp, roe, ativo, deslistado, data_deslistagem, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: corretora; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.corretora (id, usuario_id, nome, tipo, pais, moeda_padrao, saldo_atual, ativa, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: evento_corporativo; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.evento_corporativo (id, ativo_id, ativo_novo_id, tipo_evento, data_evento, data_com, proporcao, descricao, impacto_posicoes, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: feriado_mercado; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.feriado_mercado (id, pais, mercado, data_feriado, tipo_feriado, nome, horario_fechamento, recorrente, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: fonte_dados; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.fonte_dados (id, nome, tipo_fonte, url_base, requer_autenticacao, rate_limit, ativa, prioridade, ultima_consulta, total_consultas, total_erros, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: log_auditoria; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.log_auditoria (id, usuario_id, acao, entidade, entidade_id, dados_antes, dados_depois, ip_address, user_agent, "timestamp", sucesso, mensagem) FROM stdin;
\.


--
-- Data for Name: movimentacao_caixa; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.movimentacao_caixa (id, usuario_id, corretora_id, corretora_destino_id, provento_id, tipo_movimentacao, valor, moeda, data_movimentacao, descricao, comprovante, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: posicao; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.posicao (id, usuario_id, corretora_id, ativo_id, quantidade, preco_medio, custo_total, taxas_acumuladas, impostos_acumulados, valor_atual, lucro_prejuizo_realizado, lucro_prejuizo_nao_realizado, data_primeira_compra, data_ultima_atualizacao, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: provento; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.provento (id, ativo_id, tipo_provento, valor_por_acao, quantidade_ativos, valor_bruto, imposto_retido, valor_liquido, data_com, data_pagamento, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: regra_fiscal; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.regra_fiscal (id, pais, tipo_ativo, tipo_operacao, aliquota_ir, valor_isencao, incide_sobre, descricao, vigencia_inicio, vigencia_fim, ativa, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: transacao; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.transacao (id, usuario_id, corretora_id, ativo_id, tipo_operacao, quantidade, preco_unitario, valor_total, taxas, impostos, data_operacao, data_liquidacao, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: usuario; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.usuario (id, username, email, password_hash, nome_completo, ativo, role, created_at, updated_at) FROM stdin;
\.


--
-- Name: alembic_version alembic_version_pkc; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.alembic_version
    ADD CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num);


--
-- Name: ativo ativo_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.ativo
    ADD CONSTRAINT ativo_pkey PRIMARY KEY (id);


--
-- Name: corretora corretora_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT corretora_pkey PRIMARY KEY (id);


--
-- Name: evento_corporativo evento_corporativo_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_pkey PRIMARY KEY (id);


--
-- Name: feriado_mercado feriado_mercado_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.feriado_mercado
    ADD CONSTRAINT feriado_mercado_pkey PRIMARY KEY (id);


--
-- Name: fonte_dados fonte_dados_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.fonte_dados
    ADD CONSTRAINT fonte_dados_pkey PRIMARY KEY (id);


--
-- Name: log_auditoria log_auditoria_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.log_auditoria
    ADD CONSTRAINT log_auditoria_pkey PRIMARY KEY (id);


--
-- Name: movimentacao_caixa movimentacao_caixa_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_pkey PRIMARY KEY (id);


--
-- Name: posicao posicao_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_pkey PRIMARY KEY (id);


--
-- Name: provento provento_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.provento
    ADD CONSTRAINT provento_pkey PRIMARY KEY (id);


--
-- Name: regra_fiscal regra_fiscal_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.regra_fiscal
    ADD CONSTRAINT regra_fiscal_pkey PRIMARY KEY (id);


--
-- Name: transacao transacao_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_pkey PRIMARY KEY (id);


--
-- Name: ativo unique_ativo_ticker_mercado; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.ativo
    ADD CONSTRAINT unique_ativo_ticker_mercado UNIQUE (ticker, mercado);


--
-- Name: corretora unique_corretora_usuario_nome_pais; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT unique_corretora_usuario_nome_pais UNIQUE (usuario_id, nome, pais);


--
-- Name: feriado_mercado unique_feriado_pais_mercado_data; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.feriado_mercado
    ADD CONSTRAINT unique_feriado_pais_mercado_data UNIQUE (pais, mercado, data_feriado);


--
-- Name: posicao unique_posicao_usuario_corretora_ativo; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT unique_posicao_usuario_corretora_ativo UNIQUE (usuario_id, corretora_id, ativo_id);


--
-- Name: usuario usuario_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.usuario
    ADD CONSTRAINT usuario_pkey PRIMARY KEY (id);


--
-- Name: ix_ativo_ativo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_ativo ON public.ativo USING btree (ativo);


--
-- Name: ix_ativo_classe; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_classe ON public.ativo USING btree (classe);


--
-- Name: ix_ativo_data_ultima_cotacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_data_ultima_cotacao ON public.ativo USING btree (data_ultima_cotacao);


--
-- Name: ix_ativo_deslistado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_deslistado ON public.ativo USING btree (deslistado);


--
-- Name: ix_ativo_mercado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_mercado ON public.ativo USING btree (mercado);


--
-- Name: ix_ativo_moeda; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_moeda ON public.ativo USING btree (moeda);


--
-- Name: ix_ativo_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_nome ON public.ativo USING btree (nome);


--
-- Name: ix_ativo_ticker; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_ticker ON public.ativo USING btree (ticker);


--
-- Name: ix_ativo_tipo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_tipo ON public.ativo USING btree (tipo);


--
-- Name: ix_corretora_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_ativa ON public.corretora USING btree (ativa);


--
-- Name: ix_corretora_moeda_padrao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_moeda_padrao ON public.corretora USING btree (moeda_padrao);


--
-- Name: ix_corretora_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_nome ON public.corretora USING btree (nome);


--
-- Name: ix_corretora_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_pais ON public.corretora USING btree (pais);


--
-- Name: ix_corretora_tipo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_tipo ON public.corretora USING btree (tipo);


--
-- Name: ix_corretora_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_usuario_id ON public.corretora USING btree (usuario_id);


--
-- Name: ix_evento_corporativo_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_ativo_id ON public.evento_corporativo USING btree (ativo_id);


--
-- Name: ix_evento_corporativo_ativo_novo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_ativo_novo_id ON public.evento_corporativo USING btree (ativo_novo_id);


--
-- Name: ix_evento_corporativo_data_com; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_data_com ON public.evento_corporativo USING btree (data_com);


--
-- Name: ix_evento_corporativo_data_evento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_data_evento ON public.evento_corporativo USING btree (data_evento);


--
-- Name: ix_evento_corporativo_impacto_posicoes; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_impacto_posicoes ON public.evento_corporativo USING btree (impacto_posicoes);


--
-- Name: ix_evento_corporativo_tipo_evento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_tipo_evento ON public.evento_corporativo USING btree (tipo_evento);


--
-- Name: ix_feriado_mercado_data_feriado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_data_feriado ON public.feriado_mercado USING btree (data_feriado);


--
-- Name: ix_feriado_mercado_mercado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_mercado ON public.feriado_mercado USING btree (mercado);


--
-- Name: ix_feriado_mercado_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_pais ON public.feriado_mercado USING btree (pais);


--
-- Name: ix_feriado_mercado_recorrente; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_recorrente ON public.feriado_mercado USING btree (recorrente);


--
-- Name: ix_feriado_mercado_tipo_feriado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_tipo_feriado ON public.feriado_mercado USING btree (tipo_feriado);


--
-- Name: ix_fonte_dados_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_ativa ON public.fonte_dados USING btree (ativa);


--
-- Name: ix_fonte_dados_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_fonte_dados_nome ON public.fonte_dados USING btree (nome);


--
-- Name: ix_fonte_dados_prioridade; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_prioridade ON public.fonte_dados USING btree (prioridade);


--
-- Name: ix_fonte_dados_tipo_fonte; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_tipo_fonte ON public.fonte_dados USING btree (tipo_fonte);


--
-- Name: ix_fonte_dados_ultima_consulta; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_ultima_consulta ON public.fonte_dados USING btree (ultima_consulta);


--
-- Name: ix_log_auditoria_acao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_acao ON public.log_auditoria USING btree (acao);


--
-- Name: ix_log_auditoria_entidade; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_entidade ON public.log_auditoria USING btree (entidade);


--
-- Name: ix_log_auditoria_entidade_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_entidade_id ON public.log_auditoria USING btree (entidade_id);


--
-- Name: ix_log_auditoria_ip_address; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_ip_address ON public.log_auditoria USING btree (ip_address);


--
-- Name: ix_log_auditoria_sucesso; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_sucesso ON public.log_auditoria USING btree (sucesso);


--
-- Name: ix_log_auditoria_timestamp; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_timestamp ON public.log_auditoria USING btree ("timestamp");


--
-- Name: ix_log_auditoria_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_usuario_id ON public.log_auditoria USING btree (usuario_id);


--
-- Name: ix_movimentacao_caixa_corretora_destino_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_corretora_destino_id ON public.movimentacao_caixa USING btree (corretora_destino_id);


--
-- Name: ix_movimentacao_caixa_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_corretora_id ON public.movimentacao_caixa USING btree (corretora_id);


--
-- Name: ix_movimentacao_caixa_data_movimentacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_data_movimentacao ON public.movimentacao_caixa USING btree (data_movimentacao);


--
-- Name: ix_movimentacao_caixa_moeda; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_moeda ON public.movimentacao_caixa USING btree (moeda);


--
-- Name: ix_movimentacao_caixa_provento_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_provento_id ON public.movimentacao_caixa USING btree (provento_id);


--
-- Name: ix_movimentacao_caixa_tipo_movimentacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_tipo_movimentacao ON public.movimentacao_caixa USING btree (tipo_movimentacao);


--
-- Name: ix_movimentacao_caixa_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_usuario_id ON public.movimentacao_caixa USING btree (usuario_id);


--
-- Name: ix_posicao_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_ativo_id ON public.posicao USING btree (ativo_id);


--
-- Name: ix_posicao_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_corretora_id ON public.posicao USING btree (corretora_id);


--
-- Name: ix_posicao_data_primeira_compra; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_data_primeira_compra ON public.posicao USING btree (data_primeira_compra);


--
-- Name: ix_posicao_data_ultima_atualizacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_data_ultima_atualizacao ON public.posicao USING btree (data_ultima_atualizacao);


--
-- Name: ix_posicao_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_usuario_id ON public.posicao USING btree (usuario_id);


--
-- Name: ix_provento_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_ativo_id ON public.provento USING btree (ativo_id);


--
-- Name: ix_provento_data_com; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_data_com ON public.provento USING btree (data_com);


--
-- Name: ix_provento_data_pagamento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_data_pagamento ON public.provento USING btree (data_pagamento);


--
-- Name: ix_provento_tipo_provento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_tipo_provento ON public.provento USING btree (tipo_provento);


--
-- Name: ix_regra_fiscal_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_ativa ON public.regra_fiscal USING btree (ativa);


--
-- Name: ix_regra_fiscal_incide_sobre; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_incide_sobre ON public.regra_fiscal USING btree (incide_sobre);


--
-- Name: ix_regra_fiscal_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_pais ON public.regra_fiscal USING btree (pais);


--
-- Name: ix_regra_fiscal_tipo_ativo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_tipo_ativo ON public.regra_fiscal USING btree (tipo_ativo);


--
-- Name: ix_regra_fiscal_tipo_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_tipo_operacao ON public.regra_fiscal USING btree (tipo_operacao);


--
-- Name: ix_regra_fiscal_vigencia_fim; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_vigencia_fim ON public.regra_fiscal USING btree (vigencia_fim);


--
-- Name: ix_regra_fiscal_vigencia_inicio; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_vigencia_inicio ON public.regra_fiscal USING btree (vigencia_inicio);


--
-- Name: ix_transacao_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_ativo_id ON public.transacao USING btree (ativo_id);


--
-- Name: ix_transacao_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_corretora_id ON public.transacao USING btree (corretora_id);


--
-- Name: ix_transacao_data_liquidacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_data_liquidacao ON public.transacao USING btree (data_liquidacao);


--
-- Name: ix_transacao_data_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_data_operacao ON public.transacao USING btree (data_operacao);


--
-- Name: ix_transacao_tipo_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_tipo_operacao ON public.transacao USING btree (tipo_operacao);


--
-- Name: ix_transacao_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_usuario_id ON public.transacao USING btree (usuario_id);


--
-- Name: ix_usuario_email; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_usuario_email ON public.usuario USING btree (email);


--
-- Name: ix_usuario_username; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_usuario_username ON public.usuario USING btree (username);


--
-- Name: corretora corretora_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT corretora_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: evento_corporativo evento_corporativo_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: evento_corporativo evento_corporativo_ativo_novo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_ativo_novo_id_fkey FOREIGN KEY (ativo_novo_id) REFERENCES public.ativo(id) ON DELETE SET NULL;


--
-- Name: log_auditoria log_auditoria_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.log_auditoria
    ADD CONSTRAINT log_auditoria_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_corretora_destino_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_corretora_destino_id_fkey FOREIGN KEY (corretora_destino_id) REFERENCES public.corretora(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: movimentacao_caixa movimentacao_caixa_provento_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_provento_id_fkey FOREIGN KEY (provento_id) REFERENCES public.provento(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: posicao posicao_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: posicao posicao_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: posicao posicao_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: provento provento_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.provento
    ADD CONSTRAINT provento_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: transacao transacao_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: transacao transacao_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: transacao transacao_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- PostgreSQL database dump complete
--

\unrestrict GKPkJ0HUazHhGWoZucB0W175i385M8gluav75q4QDk791AqK2yfWUeOUdV3G2s9


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.development.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.production.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.staging.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase1.sh ---
# No HOST Ubuntu
echo "=== Valida√ß√£o Fase 1 ==="
echo "1. Containers:"
#podman ps --format "{{.Names}}" | grep exitus
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
echo "2. Estrutura:"
ls -la backend/app/models/ backend/app/seeds/ backend/alembic/
echo ""
echo "3. Conex√£o DB:"
podman exec exitus-backend python3 -c "from app import create_app; app=create_app(); print('‚úì App inicializada')"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase2.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 2 - Models Core

echo "======================================"
echo "  VALIDA√á√ÉO FASE 2 - MODELS CORE"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("usuario.py" "corretora.py" "ativo.py" "posicao.py" "transacao.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo, Posicao, Transacao, TipoOperacao
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal

errors = 0

# Testar Usuario
try:
    u = Usuario(username='test', email='test@test.com')
    u.set_password('123')
    print('‚úì Usuario OK')
except Exception as e:
    print(f'‚úó Usuario ERRO: {e}')
    errors += 1

# Testar Corretora
try:
    c = Corretora(usuario_id=u.id, nome='Test', pais='BR', moeda_padrao='BRL')
    print('‚úì Corretora OK')
except Exception as e:
    print(f'‚úó Corretora ERRO: {e}')
    errors += 1

# Testar Ativo
try:
    a = Ativo(ticker='TEST4', nome='Test SA', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    print('‚úì Ativo OK')
except Exception as e:
    print(f'‚úó Ativo ERRO: {e}')
    errors += 1

# Testar Posicao
try:
    p = Posicao(usuario_id=u.id, corretora_id=c.id, ativo_id=a.id)
    p.adicionar_compra(Decimal('10'), Decimal('50'))
    print('‚úì Posicao OK')
except Exception as e:
    print(f'‚úó Posicao ERRO: {e}')
    errors += 1

# Testar Transacao
try:
    from datetime import date
    t = Transacao(
        usuario_id=u.id,
        corretora_id=c.id,
        ativo_id=a.id,
        tipo_operacao=TipoOperacao.COMPRA,
        quantidade=Decimal('10'),
        preco_unitario=Decimal('50'),
        data_operacao=date.today()
    )
    print('‚úì Transacao OK')
except Exception as e:
    print(f'‚úó Transacao ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import UserRole, TipoCorretora, TipoAtivo, ClasseAtivo, TipoOperacao
print(f'‚úì UserRole: {[r.value for r in UserRole]}')
print(f'‚úì TipoCorretora: {[t.value for t in TipoCorretora]}')
print(f'‚úì TipoAtivo: {[t.value for t in TipoAtivo]}')
print(f'‚úì ClasseAtivo: {[c.value for c in ClasseAtivo]}')
print(f'‚úì TipoOperacao: {[t.value for t in TipoOperacao]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 2 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    exit 0
else
    echo -e "${RED}‚úó FASE 2 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase3.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 3 - Models Complementares

echo "======================================"
echo "  VALIDA√á√ÉO FASE 3 - MODELS COMPLEMENTARES"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("provento.py" "movimentacao_caixa.py" "evento_corporativo.py" "fonte_dados.py" "regra_fiscal.py" "feriado_mercado.py" "log_auditoria.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import (
    Provento, TipoProvento,
    MovimentacaoCaixa, TipoMovimentacao,
    EventoCorporativo, TipoEventoCorporativo,
    FonteDados, TipoFonteDados,
    RegraFiscal, IncidenciaImposto,
    FeriadoMercado, TipoFeriado,
    LogAuditoria
)
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date, time

errors = 0

# Testar Provento
try:
    ativo = Ativo(ticker='TEST4', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    p = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('1.50'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    print('‚úì Provento OK')
except Exception as e:
    print(f'‚úó Provento ERRO: {e}')
    errors += 1

# Testar MovimentacaoCaixa
try:
    user = Usuario(username='test', email='test@test.com')
    corr = Corretora(usuario_id=user.id, nome='Test', pais='BR', moeda_padrao='BRL')
    m = MovimentacaoCaixa(
        usuario_id=user.id,
        corretora_id=corr.id,
        tipo_movimentacao=TipoMovimentacao.DEPOSITO,
        valor=Decimal('1000'),
        moeda='BRL',
        data_movimentacao=date.today()
    )
    print('‚úì MovimentacaoCaixa OK')
except Exception as e:
    print(f'‚úó MovimentacaoCaixa ERRO: {e}')
    errors += 1

# Testar EventoCorporativo
try:
    e = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split 2 para 1'
    )
    print('‚úì EventoCorporativo OK')
except Exception as e:
    print(f'‚úó EventoCorporativo ERRO: {e}')
    errors += 1

# Testar FonteDados
try:
    f = FonteDados(
        nome='yfinance',
        tipo_fonte=TipoFonteDados.API,
        url_base='https://finance.yahoo.com',
        ativa=True,
        prioridade=1
    )
    print('‚úì FonteDados OK')
except Exception as e:
    print(f'‚úó FonteDados ERRO: {e}')
    errors += 1

# Testar RegraFiscal
try:
    r = RegraFiscal(
        pais='BR',
        tipo_ativo='ACAO',
        aliquota_ir=Decimal('15.0'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='IR sobre ganhos de capital',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    print('‚úì RegraFiscal OK')
except Exception as e:
    print(f'‚úó RegraFiscal ERRO: {e}')
    errors += 1

# Testar FeriadoMercado
try:
    fer = FeriadoMercado(
        pais='BR',
        mercado='B3',
        data_feriado=date(2025, 12, 25),
        tipo_feriado=TipoFeriado.NACIONAL,
        nome='Natal',
        recorrente=True
    )
    print('‚úì FeriadoMercado OK')
except Exception as e:
    print(f'‚úó FeriadoMercado ERRO: {e}')
    errors += 1

# Testar LogAuditoria
try:
    log = LogAuditoria(
        usuario_id=user.id,
        acao='LOGIN',
        ip_address='127.0.0.1',
        sucesso=True
    )
    print('‚úì LogAuditoria OK')
except Exception as e:
    print(f'‚úó LogAuditoria ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import (
    TipoProvento, TipoMovimentacao, TipoEventoCorporativo,
    TipoFonteDados, IncidenciaImposto, TipoFeriado
)
print(f'‚úì TipoProvento: {[t.value for t in TipoProvento]}')
print(f'‚úì TipoMovimentacao: {[t.value for t in TipoMovimentacao]}')
print(f'‚úì TipoEventoCorporativo: {[t.value for t in TipoEventoCorporativo]}')
print(f'‚úì TipoFonteDados: {[t.value for t in TipoFonteDados]}')
print(f'‚úì IncidenciaImposto: {[i.value for i in IncidenciaImposto]}')
print(f'‚úì TipoFeriado: {[t.value for t in TipoFeriado]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "5. Testando m√©todos espec√≠ficos..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date

errors = 0

# Testar c√°lculos de Provento
try:
    ativo = Ativo(ticker='TEST', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL', preco_atual=Decimal('40'))
    prov = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('2.00'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    dy = prov.dividend_yield_efetivo(ativo.preco_atual)
    assert dy == 5.0, f"DY deveria ser 5.0, foi {dy}"
    print('‚úì Provento.dividend_yield_efetivo() OK')
except Exception as e:
    print(f'‚úó Provento m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculos de EventoCorporativo
try:
    evento = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split'
    )
    fator = evento.calcular_fator_ajuste()
    assert fator == 2.0, f"Fator deveria ser 2.0, foi {fator}"
    print('‚úì EventoCorporativo.calcular_fator_ajuste() OK')
except Exception as e:
    print(f'‚úó EventoCorporativo m√©todos ERRO: {e}')
    errors += 1

# Testar estat√≠sticas de FonteDados
try:
    fonte = FonteDados(nome='test', tipo_fonte=TipoFonteDados.API, ativa=True, prioridade=1)
    fonte.registrar_consulta_sucesso()
    fonte.registrar_consulta_sucesso()
    fonte.registrar_erro()
    taxa = fonte.taxa_sucesso()
    assert 66.0 <= taxa <= 67.0, f"Taxa sucesso deveria ser ~66.67%, foi {taxa}"
    print('‚úì FonteDados.taxa_sucesso() OK')
except Exception as e:
    print(f'‚úó FonteDados m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculo de imposto RegraFiscal
try:
    regra = RegraFiscal(
        pais='BR',
        aliquota_ir=Decimal('15.0'),
        valor_isencao=Decimal('20000'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='Test',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    imposto = regra.calcular_imposto(Decimal('30000'))
    assert imposto == 1500, f"Imposto deveria ser 1500, foi {imposto}"
    print('‚úì RegraFiscal.calcular_imposto() OK')
except Exception as e:
    print(f'‚úó RegraFiscal m√©todos ERRO: {e}')
    errors += 1

# Testar altera√ß√µes LogAuditoria
try:
    log = LogAuditoria(
        acao='UPDATE',
        dados_antes={'nome': 'Jo√£o', 'idade': 30},
        dados_depois={'nome': 'Jo√£o Silva', 'idade': 30},
        sucesso=True
    )
    alteracoes = log.get_alteracoes()
    assert 'nome' in alteracoes, "Deveria detectar altera√ß√£o em 'nome'"
    assert 'idade' not in alteracoes, "N√£o deveria detectar altera√ß√£o em 'idade'"
    print('‚úì LogAuditoria.get_alteracoes() OK')
except Exception as e:
    print(f'‚úó LogAuditoria m√©todos ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os m√©todos espec√≠ficos funcionando"
else
    echo -e "${RED}‚úó${NC} Erros nos m√©todos espec√≠ficos"
    ((ERRORS++))
fi
echo ""

echo "6. Resumo de models criados..."
echo -e "${YELLOW}Fase 2 (Core):${NC}"
echo "  1. Usuario"
echo "  2. Corretora"
echo "  3. Ativo"
echo "  4. Posicao"
echo "  5. Transacao"
echo ""
echo -e "${YELLOW}Fase 3 (Complementares):${NC}"
echo "  6. Provento"
echo "  7. MovimentacaoCaixa"
echo "  8. EventoCorporativo"
echo "  9. FonteDados"
echo "  10. RegraFiscal"
echo "  11. FeriadoMercado"
echo "  12. LogAuditoria"
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 3 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Total: 12 models criados"
    echo "‚úÖ Pr√≥ximo: Fase 4 - Migrations e Schema"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 3 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase4.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 4 - Migrations e Schema

echo "======================================"
echo "  VALIDA√á√ÉO FASE 4 - MIGRATIONS E SCHEMA"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando migration gerada..."
MIGRATION_FILE=$(ls backend/alembic/versions/*_initial_schema_12_models.py 2>/dev/null | head -1)
if [ -f "$MIGRATION_FILE" ]; then
    LINES=$(wc -l < "$MIGRATION_FILE")
    if [ "$LINES" -gt 400 ]; then
        echo -e "${GREEN}‚úì${NC} Migration gerada: $MIGRATION_FILE ($LINES linhas)"
    else
        echo -e "${RED}‚úó${NC} Migration muito pequena: $LINES linhas"
        ((ERRORS++))
    fi
else
    echo -e "${RED}‚úó${NC} Migration n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando tabelas no PostgreSQL..."
TABLES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE';")
TABLES=$(echo $TABLES | xargs) # trim whitespace
if [ "$TABLES" -eq 13 ]; then
    echo -e "${GREEN}‚úì${NC} 13 tabelas criadas (12 models + alembic_version)"
else
    echo -e "${RED}‚úó${NC} Esperado 13 tabelas, encontrado: $TABLES"
    ((ERRORS++))
fi

# Listar tabelas
echo -e "${YELLOW}Tabelas encontradas:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE' ORDER BY table_name;" | sed 's/^/ - /'
echo ""

echo "3. Verificando enums no PostgreSQL..."
ENUMS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_type WHERE typtype='e';")
ENUMS=$(echo $ENUMS | xargs)
if [ "$ENUMS" -eq 11 ]; then
    echo -e "${GREEN}‚úì${NC} 11 enums criados"
else
    echo -e "${RED}‚úó${NC} Esperado 11 enums, encontrado: $ENUMS"
    ((ERRORS++))
fi

# Listar enums
echo -e "${YELLOW}Enums encontrados:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT typname FROM pg_type WHERE typtype='e' ORDER BY typname;" | sed 's/^/ - /'
echo ""

echo "4. Verificando foreign keys..."
FKS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.table_constraints WHERE constraint_type='FOREIGN KEY';")
FKS=$(echo $FKS | xargs)
if [ "$FKS" -ge 10 ]; then
    echo -e "${GREEN}‚úì${NC} $FKS foreign keys criadas"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $FKS foreign keys encontradas (esperado >=10)"
fi
echo ""

echo "5. Verificando √≠ndices..."
INDEXES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname='public';")
INDEXES=$(echo $INDEXES | xargs)
if [ "$INDEXES" -ge 50 ]; then
    echo -e "${GREEN}‚úì${NC} $INDEXES √≠ndices criados"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $INDEXES √≠ndices encontrados"
fi
echo ""

echo "6. Testando insert em tabela usuario..."
podman exec exitus-db psql -U exitus -d exitusdb -c "
INSERT INTO usuario (id, username, email, password_hash, ativo, role, created_at, updated_at)
VALUES (
    gen_random_uuid(),
    'test_validation',
    'test@validation.com',
    'hash123',
    true,
    'USER'::userrole,
    NOW(),
    NOW()
) ON CONFLICT DO NOTHING;
" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Insert de teste bem-sucedido"
    # Limpar
    podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario WHERE username='test_validation';" > /dev/null 2>&1
else
    echo -e "${RED}‚úó${NC} Erro no insert de teste"
    ((ERRORS++))
fi
echo ""

echo "7. Verificando vers√£o do Alembic..."
ALEMBIC_VERSION=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT version_num FROM alembic_version;")
ALEMBIC_VERSION=$(echo $ALEMBIC_VERSION | xargs)
if [ ! -z "$ALEMBIC_VERSION" ]; then
    echo -e "${GREEN}‚úì${NC} Alembic version: $ALEMBIC_VERSION"
else
    echo -e "${RED}‚úó${NC} Vers√£o do Alembic n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 4 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo:"
    echo "  - 13 tabelas criadas"
    echo "  - 11 enums criados"
    echo "  - $FKS foreign keys"
    echo "  - $INDEXES √≠ndices"
    echo ""
    echo "‚úÖ Pr√≥ximo: Fase 5 - Seeds de Dados"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 4 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase5.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 5 - Seeds de Dados

echo "======================================"
echo "  VALIDA√á√ÉO FASE 5 - SEEDS DE DADOS"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

echo "1. Verificando usu√°rios..."
USERS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM usuario;")
USERS=$(echo $USERS | xargs)
if [ "$USERS" -eq 4 ]; then
    echo -e "${GREEN}‚úì${NC} 4 usu√°rios cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 4 usu√°rios, encontrado: $USERS"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando ativos brasileiros..."
ATIVOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR';")
ATIVOS=$(echo $ATIVOS | xargs)
if [ "$ATIVOS" -eq 25 ]; then
    echo -e "${GREEN}‚úì${NC} 25 ativos brasileiros cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 25 ativos, encontrado: $ATIVOS"
    ((ERRORS++))
fi

#ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='acao';")
ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='ACAO';")
ACOES=$(echo $ACOES | xargs)
echo -e "  - A√ß√µes: $ACOES"

#FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='fii';")
FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='FII';")
FIIS=$(echo $FIIS | xargs)
echo -e "  - FIIs: $FIIS"
echo ""

echo "3. Verificando regras fiscais BR..."
REGRAS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM regra_fiscal WHERE pais='BR';")
REGRAS=$(echo $REGRAS | xargs)
if [ "$REGRAS" -eq 6 ]; then
    echo -e "${GREEN}‚úì${NC} 6 regras fiscais brasileiras cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 6 regras, encontrado: $REGRAS"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando feriados B3..."
FERIADOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM feriado_mercado WHERE pais='BR' AND mercado='B3';")
FERIADOS=$(echo $FERIADOS | xargs)
if [ "$FERIADOS" -eq 30 ]; then
    echo -e "${GREEN}‚úì${NC} 30 feriados B3 cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 30 feriados, encontrado: $FERIADOS"
    ((ERRORS++))
fi
echo ""

echo "5. Verificando fontes de dados..."
FONTES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM fonte_dados;")
FONTES=$(echo $FONTES | xargs)
if [ "$FONTES" -eq 7 ]; then
    echo -e "${GREEN}‚úì${NC} 7 fontes de dados cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 7 fontes, encontrado: $FONTES"
    ((ERRORS++))
fi
echo ""

echo "6. Verificando dados espec√≠ficos..."

# Verificar usu√°rio admin
ADMIN=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT username FROM usuario WHERE role='ADMIN' LIMIT 1;")
ADMIN=$(echo $ADMIN | xargs)
if [ "$ADMIN" = "admin" ]; then
    echo -e "${GREEN}‚úì${NC} Usu√°rio admin encontrado"
else
    echo -e "${RED}‚úó${NC} Usu√°rio admin n√£o encontrado"
    ((ERRORS++))
fi

# Verificar PETR4
PETR4=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT ticker FROM ativo WHERE ticker='PETR4';")
PETR4=$(echo $PETR4 | xargs)
if [ "$PETR4" = "PETR4" ]; then
    echo -e "${GREEN}‚úì${NC} Ativo PETR4 encontrado"
else
    echo -e "${RED}‚úó${NC} Ativo PETR4 n√£o encontrado"
    ((ERRORS++))
fi

# Verificar yfinance
YFINANCE=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT nome FROM fonte_dados WHERE nome='yfinance';")
YFINANCE=$(echo $YFINANCE | xargs)
if [ "$YFINANCE" = "yfinance" ]; then
    echo -e "${GREEN}‚úì${NC} Fonte yfinance encontrada"
else
    echo -e "${RED}‚úó${NC} Fonte yfinance n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 5 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo dos Dados:"
    echo "  - $USERS usu√°rios"
    echo "  - $ATIVOS ativos ($ACOES a√ß√µes + $FIIS FIIs)"
    echo "  - $REGRAS regras fiscais"
    echo "  - $FERIADOS feriados"
    echo "  - $FONTES fontes de dados"
    echo ""
    echo "‚úÖ Banco de dados populado e pronto!"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 5 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/test_module0.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/modulo2_fontes.txt ---
====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example*
!frontend/.env.*example*
!backend/.env.*example*
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.development.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.production.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.staging.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic.ini ---
# A generic, single database configuration.

[alembic]
# path to migration scripts
script_location = alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the
# "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:alembic/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
version_path_separator = os  # Use os.pathsep. Default configuration used for new projects.

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = driver://user:pass@localhost/dbname


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/README ---
Generic single-database configuration.
====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py ---
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# Adicionar path do app
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

# Importar a aplica√ß√£o Flask e o db
from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Criar aplica√ß√£o Flask e obter metadata
app = create_app()
with app.app_context():
    # Garantir que todos os models sejam importados
    from app.models import (
        Usuario, Corretora, Ativo, Posicao, Transacao,
        Provento, MovimentacaoCaixa, EventoCorporativo,
        FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
    )
    target_metadata = db.metadata
    
# Configurar URL do banco
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py.back ---
# backend/alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# ADICIONAR ESTAS LINHAS:
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ADICIONAR ESTA LINHA:
# Configurar a URL do banco a partir da aplica√ß√£o Flask
app = create_app()
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])

# add your model's MetaData object here
# SUBSTITUIR por:
target_metadata = db.metadata

# ... resto do arquivo permanece igual

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/script.py.mako ---
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/versions/b2542b2f7857_initial_schema_12_models.py ---
"""Initial schema - 12 models

Revision ID: b2542b2f7857
Revises: 
Create Date: 2025-11-26 19:40:34.891548

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b2542b2f7857'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do ativo'),
    sa.Column('ticker', sa.String(length=20), nullable=False, comment='C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome completo do ativo'),
    sa.Column('tipo', sa.Enum('ACAO', 'FII', 'REIT', 'BOND', 'ETF', 'CRIPTO', 'OUTRO', name='tipoativo'), nullable=False, comment='Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)'),
    sa.Column('classe', sa.Enum('RENDA_VARIAVEL', 'RENDA_FIXA', 'CRIPTO', 'HIBRIDO', name='classeativo'), nullable=False, comment='Classe do ativo (renda vari√°vel, fixa, cripto)'),
    sa.Column('mercado', sa.String(length=10), nullable=False, comment='Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='Moeda de negocia√ß√£o (BRL, USD, EUR)'),
    sa.Column('preco_atual', sa.Numeric(precision=18, scale=6), nullable=True, comment='Pre√ßo/cota√ß√£o atual do ativo'),
    sa.Column('data_ultima_cotacao', sa.DateTime(timezone=True), nullable=True, comment='Data e hora da √∫ltima cota√ß√£o'),
    sa.Column('dividend_yield', sa.Numeric(precision=8, scale=4), nullable=True, comment='Dividend Yield em % (ex: 6.5000 = 6.5%)'),
    sa.Column('p_l', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Lucro'),
    sa.Column('p_vp', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Valor Patrimonial'),
    sa.Column('roe', sa.Numeric(precision=8, scale=4), nullable=True, comment='Return on Equity em %'),
    sa.Column('ativo', sa.Boolean(), nullable=False, comment='Indica se ativo est√° dispon√≠vel para negocia√ß√£o'),
    sa.Column('deslistado', sa.Boolean(), nullable=False, comment='Indica se ativo foi deslistado da bolsa'),
    sa.Column('data_deslistagem', sa.Date(), nullable=True, comment='Data de deslistagem (se aplic√°vel)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas sobre o ativo'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='ativo_nome_min_length'),
    sa.CheckConstraint('length(ticker) >= 1', name='ativo_ticker_min_length'),
    sa.CheckConstraint('preco_atual IS NULL OR preco_atual >= 0', name='ativo_preco_positivo'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ticker', 'mercado', name='unique_ativo_ticker_mercado'),
    comment='Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'
    )
    op.create_index(op.f('ix_ativo_ativo'), 'ativo', ['ativo'], unique=False)
    op.create_index(op.f('ix_ativo_classe'), 'ativo', ['classe'], unique=False)
    op.create_index(op.f('ix_ativo_data_ultima_cotacao'), 'ativo', ['data_ultima_cotacao'], unique=False)
    op.create_index(op.f('ix_ativo_deslistado'), 'ativo', ['deslistado'], unique=False)
    op.create_index(op.f('ix_ativo_mercado'), 'ativo', ['mercado'], unique=False)
    op.create_index(op.f('ix_ativo_moeda'), 'ativo', ['moeda'], unique=False)
    op.create_index(op.f('ix_ativo_nome'), 'ativo', ['nome'], unique=False)
    op.create_index(op.f('ix_ativo_ticker'), 'ativo', ['ticker'], unique=False)
    op.create_index(op.f('ix_ativo_tipo'), 'ativo', ['tipo'], unique=False)
    op.create_table('feriado_mercado',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do feriado'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('mercado', sa.String(length=20), nullable=True, comment='Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos'),
    sa.Column('data_feriado', sa.Date(), nullable=False, comment='Data do feriado'),
    sa.Column('tipo_feriado', sa.Enum('NACIONAL', 'BOLSA', 'PONTE', 'FECHAMENTO_ANTECIPADO', 'MANUTENCAO', 'OUTRO', name='tipoferiado'), nullable=False, comment='Tipo do feriado'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome do feriado'),
    sa.Column('horario_fechamento', sa.Time(), nullable=True, comment='Hor√°rio de fechamento antecipado (se aplic√°vel)'),
    sa.Column('recorrente', sa.Boolean(), nullable=False, comment='Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o feriado'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='feriado_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 3', name='feriado_nome_min_length'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('pais', 'mercado', 'data_feriado', name='unique_feriado_pais_mercado_data'),
    comment='Tabela de feriados e dias sem preg√£o nos mercados'
    )
    op.create_index(op.f('ix_feriado_mercado_data_feriado'), 'feriado_mercado', ['data_feriado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_mercado'), 'feriado_mercado', ['mercado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_pais'), 'feriado_mercado', ['pais'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_recorrente'), 'feriado_mercado', ['recorrente'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_tipo_feriado'), 'feriado_mercado', ['tipo_feriado'], unique=False)
    op.create_table('fonte_dados',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da fonte'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da fonte de dados (ex: yfinance, Alpha Vantage)'),
    sa.Column('tipo_fonte', sa.Enum('API', 'SCRAPER', 'MANUAL', 'ARQUIVO', 'OUTRO', name='tipofontedados'), nullable=False, comment='Tipo da fonte de dados'),
    sa.Column('url_base', sa.String(length=500), nullable=True, comment='URL base da API ou site'),
    sa.Column('requer_autenticacao', sa.Boolean(), nullable=False, comment='Indica se requer chave API ou autentica√ß√£o'),
    sa.Column('rate_limit', sa.String(length=50), nullable=True, comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se fonte est√° ativa'),
    sa.Column('prioridade', sa.Integer(), nullable=False, comment='Ordem de prioridade (1 = maior prioridade)'),
    sa.Column('ultima_consulta', sa.DateTime(timezone=True), nullable=True, comment='Timestamp da √∫ltima consulta bem-sucedida'),
    sa.Column('total_consultas', sa.Integer(), nullable=False, comment='Total de consultas realizadas'),
    sa.Column('total_erros', sa.Integer(), nullable=False, comment='Total de erros encontrados'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a fonte de dados'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='fonte_nome_min_length'),
    sa.CheckConstraint('prioridade > 0', name='fonte_prioridade_positiva'),
    sa.CheckConstraint('total_consultas >= 0', name='fonte_consultas_positivas'),
    sa.CheckConstraint('total_erros >= 0', name='fonte_erros_positivos'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de fontes de dados externas (APIs, scrapers)'
    )
    op.create_index(op.f('ix_fonte_dados_ativa'), 'fonte_dados', ['ativa'], unique=False)
    op.create_index(op.f('ix_fonte_dados_nome'), 'fonte_dados', ['nome'], unique=True)
    op.create_index(op.f('ix_fonte_dados_prioridade'), 'fonte_dados', ['prioridade'], unique=False)
    op.create_index(op.f('ix_fonte_dados_tipo_fonte'), 'fonte_dados', ['tipo_fonte'], unique=False)
    op.create_index(op.f('ix_fonte_dados_ultima_consulta'), 'fonte_dados', ['ultima_consulta'], unique=False)
    op.create_table('regra_fiscal',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da regra'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('tipo_ativo', sa.String(length=20), nullable=True, comment='Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos'),
    sa.Column('tipo_operacao', sa.String(length=20), nullable=True, comment='Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas'),
    sa.Column('aliquota_ir', sa.Numeric(precision=6, scale=4), nullable=False, comment='Al√≠quota de IR em % (ex: 15.0000 = 15%)'),
    sa.Column('valor_isencao', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)'),
    sa.Column('incide_sobre', sa.Enum('LUCRO', 'RECEITA', 'PROVENTO', 'OPERACAO', name='incidenciaimposto'), nullable=False, comment='Sobre o que incide o imposto'),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada da regra fiscal'),
    sa.Column('vigencia_inicio', sa.Date(), nullable=False, comment='Data de in√≠cio da vig√™ncia da regra'),
    sa.Column('vigencia_fim', sa.Date(), nullable=True, comment='Data de fim da vig√™ncia (NULL = vigente indefinidamente)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se regra est√° ativa'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='regra_pais_iso_format'),
    sa.CheckConstraint('aliquota_ir >= 0 AND aliquota_ir <= 100', name='regra_aliquota_valida'),
    sa.CheckConstraint('valor_isencao IS NULL OR valor_isencao >= 0', name='regra_isencao_positiva'),
    sa.CheckConstraint('vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio', name='regra_vigencia_valida'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'
    )
    op.create_index(op.f('ix_regra_fiscal_ativa'), 'regra_fiscal', ['ativa'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_incide_sobre'), 'regra_fiscal', ['incide_sobre'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_pais'), 'regra_fiscal', ['pais'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_ativo'), 'regra_fiscal', ['tipo_ativo'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_operacao'), 'regra_fiscal', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_fim'), 'regra_fiscal', ['vigencia_fim'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_inicio'), 'regra_fiscal', ['vigencia_inicio'], unique=False)
    op.create_table('usuario',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('nome_completo', sa.String(length=200), nullable=True),
    sa.Column('ativo', sa.Boolean(), nullable=False),
    sa.Column('role', sa.Enum('ADMIN', 'USER', 'READONLY', name='userrole'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_usuario_email'), 'usuario', ['email'], unique=True)
    op.create_index(op.f('ix_usuario_username'), 'usuario', ['username'], unique=True)
    op.create_table('corretora',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da corretora'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da corretora/exchange (ex: XP, Clear, Binance)'),
    sa.Column('tipo', sa.Enum('CORRETORA', 'EXCHANGE', name='tipocorretora'), nullable=False, comment='Tipo: corretora tradicional ou exchange cripto'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)'),
    sa.Column('moeda_padrao', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('saldo_atual', sa.Numeric(precision=18, scale=2), nullable=False, comment='Saldo dispon√≠vel em caixa (na moeda padr√£o)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se conta est√° ativa'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas do usu√°rio sobre a conta'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("moeda_padrao ~* '^[A-Z]{3}$'", name='corretora_moeda_iso_format'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='corretora_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 2', name='corretora_nome_min_length'),
    sa.CheckConstraint('saldo_atual >= 0', name='corretora_saldo_positivo'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'nome', 'pais', name='unique_corretora_usuario_nome_pais'),
    comment='Tabela de corretoras e contas de investimento'
    )
    op.create_index(op.f('ix_corretora_ativa'), 'corretora', ['ativa'], unique=False)
    op.create_index(op.f('ix_corretora_moeda_padrao'), 'corretora', ['moeda_padrao'], unique=False)
    op.create_index(op.f('ix_corretora_nome'), 'corretora', ['nome'], unique=False)
    op.create_index(op.f('ix_corretora_pais'), 'corretora', ['pais'], unique=False)
    op.create_index(op.f('ix_corretora_tipo'), 'corretora', ['tipo'], unique=False)
    op.create_index(op.f('ix_corretora_usuario_id'), 'corretora', ['usuario_id'], unique=False)
    op.create_table('evento_corporativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do evento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo afetado pelo evento'),
    sa.Column('ativo_novo_id', sa.UUID(), nullable=True, comment='ID do novo ativo (fus√µes, mudan√ßas de ticker)'),
    sa.Column('tipo_evento', sa.Enum('SPLIT', 'GRUPAMENTO', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'FUSAO', 'CISAO', 'INCORPORACAO', 'MUDANCA_TICKER', 'DESLISTAGEM', 'RELISTING', 'CANCELAMENTO', 'OUTRO', name='tipoeventocorporativo'), nullable=False, comment='Tipo do evento corporativo'),
    sa.Column('data_evento', sa.Date(), nullable=False, comment='Data do evento'),
    sa.Column('data_com', sa.Date(), nullable=True, comment='Data COM (√∫ltimo dia para ter direito ao evento)'),
    sa.Column('proporcao', sa.String(length=20), nullable=True, comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada do evento'),
    sa.Column('impacto_posicoes', sa.Boolean(), nullable=False, comment='Indica se as posi√ß√µes j√° foram ajustadas'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes adicionais sobre o evento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)\n            OR \n            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))\n            ", name='evento_proporcao_obrigatoria'),
    sa.CheckConstraint('data_com IS NULL OR data_com <= data_evento', name='evento_data_com_valida'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['ativo_novo_id'], ['ativo.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de eventos corporativos que afetam ativos'
    )
    op.create_index(op.f('ix_evento_corporativo_ativo_id'), 'evento_corporativo', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_ativo_novo_id'), 'evento_corporativo', ['ativo_novo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_com'), 'evento_corporativo', ['data_com'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_evento'), 'evento_corporativo', ['data_evento'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_impacto_posicoes'), 'evento_corporativo', ['impacto_posicoes'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_tipo_evento'), 'evento_corporativo', ['tipo_evento'], unique=False)
    op.create_table('log_auditoria',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do log'),
    sa.Column('usuario_id', sa.UUID(), nullable=True, comment='ID do usu√°rio (NULL para a√ß√µes an√¥nimas)'),
    sa.Column('acao', sa.String(length=50), nullable=False, comment='Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)'),
    sa.Column('entidade', sa.String(length=100), nullable=True, comment='Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)'),
    sa.Column('entidade_id', sa.UUID(), nullable=True, comment='ID do registro afetado'),
    sa.Column('dados_antes', sa.JSON(), nullable=True, comment='Estado anterior do registro (JSON)'),
    sa.Column('dados_depois', sa.JSON(), nullable=True, comment='Estado posterior do registro (JSON)'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='Endere√ßo IP de origem'),
    sa.Column('user_agent', sa.String(length=500), nullable=True, comment='User-Agent (navegador/cliente)'),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False, comment='Data/hora da a√ß√£o'),
    sa.Column('sucesso', sa.Boolean(), nullable=False, comment='Indica se a√ß√£o foi bem-sucedida'),
    sa.Column('mensagem', sa.Text(), nullable=True, comment='Mensagem de erro ou detalhes adicionais'),
    sa.CheckConstraint('length(acao) >= 3', name='log_acao_min_length'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de logs de auditoria para compliance'
    )
    op.create_index(op.f('ix_log_auditoria_acao'), 'log_auditoria', ['acao'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade'), 'log_auditoria', ['entidade'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade_id'), 'log_auditoria', ['entidade_id'], unique=False)
    op.create_index(op.f('ix_log_auditoria_ip_address'), 'log_auditoria', ['ip_address'], unique=False)
    op.create_index(op.f('ix_log_auditoria_sucesso'), 'log_auditoria', ['sucesso'], unique=False)
    op.create_index(op.f('ix_log_auditoria_timestamp'), 'log_auditoria', ['timestamp'], unique=False)
    op.create_index(op.f('ix_log_auditoria_usuario_id'), 'log_auditoria', ['usuario_id'], unique=False)
    op.create_table('provento',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do provento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo que pagou o provento'),
    sa.Column('tipo_provento', sa.Enum('DIVIDENDO', 'JCP', 'RENDIMENTO', 'CUPOM', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'OUTRO', name='tipoprovento'), nullable=False, comment='Tipo do provento (dividendo, JCP, rendimento, etc.)'),
    sa.Column('valor_por_acao', sa.Numeric(precision=18, scale=6), nullable=False, comment='Valor unit√°rio por ativo'),
    sa.Column('quantidade_ativos', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos que geraram o provento'),
    sa.Column('valor_bruto', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor bruto recebido'),
    sa.Column('imposto_retido', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte'),
    sa.Column('valor_liquido', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor l√≠quido creditado'),
    sa.Column('data_com', sa.Date(), nullable=False, comment='Data COM (√∫ltimo dia para ter direito ao provento)'),
    sa.Column('data_pagamento', sa.Date(), nullable=False, comment='Data efetiva do pagamento'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o provento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_pagamento >= data_com', name='provento_data_pagamento_valida'),
    sa.CheckConstraint('imposto_retido >= 0', name='provento_imposto_positivo'),
    sa.CheckConstraint('quantidade_ativos > 0', name='provento_quantidade_positiva'),
    sa.CheckConstraint('valor_bruto > 0', name='provento_valor_bruto_positivo'),
    sa.CheckConstraint('valor_liquido <= valor_bruto', name='provento_liquido_menor_bruto'),
    sa.CheckConstraint('valor_liquido > 0', name='provento_valor_liquido_positivo'),
    sa.CheckConstraint('valor_por_acao > 0', name='provento_valor_por_acao_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de proventos recebidos (dividendos, JCP, rendimentos)'
    )
    op.create_index(op.f('ix_provento_ativo_id'), 'provento', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_provento_data_com'), 'provento', ['data_com'], unique=False)
    op.create_index(op.f('ix_provento_data_pagamento'), 'provento', ['data_pagamento'], unique=False)
    op.create_index(op.f('ix_provento_tipo_provento'), 'provento', ['tipo_provento'], unique=False)
    op.create_table('movimentacao_caixa',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da movimenta√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora (origem)'),
    sa.Column('corretora_destino_id', sa.UUID(), nullable=True, comment='ID da corretora destino (apenas para transfer√™ncias)'),
    sa.Column('provento_id', sa.UUID(), nullable=True, comment='ID do provento (apenas para cr√©dito de provento)'),
    sa.Column('tipo_movimentacao', sa.Enum('DEPOSITO', 'SAQUE', 'TRANSFERENCIA_ENVIADA', 'TRANSFERENCIA_RECEBIDA', 'CREDITO_PROVENTO', 'PAGAMENTO_TAXA', 'PAGAMENTO_IMPOSTO', 'AJUSTE', 'OUTRO', name='tipomovimentacao'), nullable=False, comment='Tipo da movimenta√ß√£o'),
    sa.Column('valor', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor da movimenta√ß√£o'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('data_movimentacao', sa.Date(), nullable=False, comment='Data da movimenta√ß√£o'),
    sa.Column('descricao', sa.Text(), nullable=True, comment='Descri√ß√£o da movimenta√ß√£o'),
    sa.Column('comprovante', sa.String(length=200), nullable=True, comment='Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)\n            OR \n            (tipo_movimentacao != 'credito_provento')\n            ", name='movimentacao_credito_tem_provento'),
    #sa.CheckConstraint("\n            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') \n             AND corretora_destino_id IS NOT NULL)\n            OR \n            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))\n            ", name='movimentacao_transferencia_tem_destino'),
    sa.CheckConstraint("moeda ~* '^[A-Z]{3}$'", name='movimentacao_moeda_iso_format'),
    sa.CheckConstraint('valor > 0', name='movimentacao_valor_positivo'),
    sa.ForeignKeyConstraint(['corretora_destino_id'], ['corretora.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provento_id'], ['provento.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de movimenta√ß√µes de caixa em corretoras'
    )
    op.create_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), 'movimentacao_caixa', ['corretora_destino_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_corretora_id'), 'movimentacao_caixa', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_data_movimentacao'), 'movimentacao_caixa', ['data_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_moeda'), 'movimentacao_caixa', ['moeda'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_provento_id'), 'movimentacao_caixa', ['provento_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), 'movimentacao_caixa', ['tipo_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_usuario_id'), 'movimentacao_caixa', ['usuario_id'], unique=False)
    op.create_table('posicao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da posi√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora onde est√° a posi√ß√£o'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos (suporta fracion√°rios)'),
    sa.Column('preco_medio', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo m√©dio de aquisi√ß√£o'),
    sa.Column('custo_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Custo total investido (quantidade * pre√ßo m√©dio)'),
    sa.Column('taxas_acumuladas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem e cust√≥dia acumuladas'),
    sa.Column('impostos_acumulados', sa.Numeric(precision=18, scale=2), nullable=False, comment='Impostos pagos acumulados (IR, IOF, etc.)'),
    sa.Column('valor_atual', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de mercado atual da posi√ß√£o'),
    sa.Column('lucro_prejuizo_realizado', sa.Numeric(precision=18, scale=2), nullable=False, comment='Lucro/preju√≠zo realizado em vendas'),
    sa.Column('lucro_prejuizo_nao_realizado', sa.Numeric(precision=18, scale=2), nullable=True, comment='Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)'),
    sa.Column('data_primeira_compra', sa.Date(), nullable=True, comment='Data da primeira aquisi√ß√£o deste ativo'),
    sa.Column('data_ultima_atualizacao', sa.DateTime(timezone=True), nullable=True, comment='Data da √∫ltima atualiza√ß√£o de valores'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('custo_total >= 0', name='posicao_custo_total_positivo'),
    sa.CheckConstraint('impostos_acumulados >= 0', name='posicao_impostos_positivos'),
    sa.CheckConstraint('preco_medio >= 0', name='posicao_preco_medio_positivo'),
    sa.CheckConstraint('quantidade >= 0', name='posicao_quantidade_positiva'),
    sa.CheckConstraint('taxas_acumuladas >= 0', name='posicao_taxas_positivas'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'corretora_id', 'ativo_id', name='unique_posicao_usuario_corretora_ativo'),
    comment='Tabela de posi√ß√µes em carteira (holdings)'
    )
    op.create_index(op.f('ix_posicao_ativo_id'), 'posicao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_posicao_corretora_id'), 'posicao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_posicao_data_primeira_compra'), 'posicao', ['data_primeira_compra'], unique=False)
    op.create_index(op.f('ix_posicao_data_ultima_atualizacao'), 'posicao', ['data_ultima_atualizacao'], unique=False)
    op.create_index(op.f('ix_posicao_usuario_id'), 'posicao', ['usuario_id'], unique=False)
    op.create_table('transacao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da transa√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo transacionado'),
    sa.Column('tipo_operacao', sa.Enum('COMPRA', 'VENDA', name='tipooperacao'), nullable=False, comment='Tipo de opera√ß√£o: COMPRA ou VENDA'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade transacionada (suporta fracion√°rios)'),
    sa.Column('preco_unitario', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo por unidade'),
    sa.Column('valor_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor total da opera√ß√£o (quantidade * pre√ßo)'),
    sa.Column('taxas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem, cust√≥dia, emolumentos'),
    sa.Column('impostos', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte, IOF, etc.'),
    sa.Column('data_operacao', sa.Date(), nullable=False, comment='Data da opera√ß√£o'),
    sa.Column('data_liquidacao', sa.Date(), nullable=True, comment='Data de liquida√ß√£o (D+2, D+3, etc.)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a transa√ß√£o'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_liquidacao IS NULL OR data_liquidacao >= data_operacao', name='transacao_data_liquidacao_valida'),
    sa.CheckConstraint('impostos >= 0', name='transacao_impostos_positivos'),
    sa.CheckConstraint('preco_unitario > 0', name='transacao_preco_positivo'),
    sa.CheckConstraint('quantidade > 0', name='transacao_quantidade_positiva'),
    sa.CheckConstraint('taxas >= 0', name='transacao_taxas_positivas'),
    sa.CheckConstraint('valor_total > 0', name='transacao_valor_total_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de transa√ß√µes de compra e venda de ativos'
    )
    op.create_index(op.f('ix_transacao_ativo_id'), 'transacao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_transacao_corretora_id'), 'transacao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_transacao_data_liquidacao'), 'transacao', ['data_liquidacao'], unique=False)
    op.create_index(op.f('ix_transacao_data_operacao'), 'transacao', ['data_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_tipo_operacao'), 'transacao', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_usuario_id'), 'transacao', ['usuario_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_transacao_usuario_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_tipo_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_liquidacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_corretora_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_ativo_id'), table_name='transacao')
    op.drop_table('transacao')
    op.drop_index(op.f('ix_posicao_usuario_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_ultima_atualizacao'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_primeira_compra'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_corretora_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_ativo_id'), table_name='posicao')
    op.drop_table('posicao')
    op.drop_index(op.f('ix_movimentacao_caixa_usuario_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_provento_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_moeda'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_data_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), table_name='movimentacao_caixa')
    op.drop_table('movimentacao_caixa')
    op.drop_index(op.f('ix_provento_tipo_provento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_pagamento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_com'), table_name='provento')
    op.drop_index(op.f('ix_provento_ativo_id'), table_name='provento')
    op.drop_table('provento')
    op.drop_index(op.f('ix_log_auditoria_usuario_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_timestamp'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_sucesso'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_ip_address'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_acao'), table_name='log_auditoria')
    op.drop_table('log_auditoria')
    op.drop_index(op.f('ix_evento_corporativo_tipo_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_impacto_posicoes'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_com'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_novo_id'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_id'), table_name='evento_corporativo')
    op.drop_table('evento_corporativo')
    op.drop_index(op.f('ix_corretora_usuario_id'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_tipo'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_pais'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_nome'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_moeda_padrao'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_ativa'), table_name='corretora')
    op.drop_table('corretora')
    op.drop_index(op.f('ix_usuario_username'), table_name='usuario')
    op.drop_index(op.f('ix_usuario_email'), table_name='usuario')
    op.drop_table('usuario')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_inicio'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_fim'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_operacao'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_ativo'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_pais'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_incide_sobre'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_ativa'), table_name='regra_fiscal')
    op.drop_table('regra_fiscal')
    op.drop_index(op.f('ix_fonte_dados_ultima_consulta'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_tipo_fonte'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_prioridade'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_nome'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_ativa'), table_name='fonte_dados')
    op.drop_table('fonte_dados')
    op.drop_index(op.f('ix_feriado_mercado_tipo_feriado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_recorrente'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_pais'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_mercado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_data_feriado'), table_name='feriado_mercado')
    op.drop_table('feriado_mercado')
    op.drop_index(op.f('ix_ativo_tipo'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ticker'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_nome'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_moeda'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_mercado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_deslistado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_data_ultima_cotacao'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_classe'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ativo'), table_name='ativo')
    op.drop_table('ativo')
    # ### end Alembic commands ###

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - M√≥dulo 2 Backend API REST - Application Factory"""

from flask import Flask
from flask_cors import CORS
from flask_jwt_extended import JWTManager
from .config import Config
from .database import init_db

def create_app(testing=False):
    """
    Factory para criar a aplica√ß√£o Flask do Exitus Backend.
    
    Args:
        testing (bool): Modo de teste (configura√ß√µes espec√≠ficas)
    
    Returns:
        Flask: Aplica√ß√£o Flask configurada
    """
    app = Flask(__name__)
    
    # Carregar configura√ß√µes
    app.config.from_object(Config)
    
    # Configura√ß√µes adicionais para JWT
    app.config['JWT_SECRET_KEY'] = app.config.get('SECRET_KEY', 'super-secret-key-mudar-no-env')
    app.config['JWT_ACCESS_TOKEN_EXPIRES'] = 3600  # 1 hora
    app.config['JWT_REFRESH_TOKEN_EXPIRES'] = 2592000  # 30 dias
    
    # Inicializar extens√µes
    jwt = JWTManager(app)
    cors = CORS(app, resources={
        r"/api/*": {
            "origins": ["http://localhost:8080", "http://127.0.0.1:8080"],
            "methods": ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
            "allow_headers": ["Content-Type", "Authorization", "X-Requested-With"]
        }
    })
    
    # Inicializar banco de dados
    init_db(app)
    
    # Health check b√°sico (M√≥dulo 1 + M√≥dulo 2)
    @app.route('/health')
    def health():
        return {
            "env": app.config.get('FLASK_ENV', 'development'),
            "service": "exitus-backend",
            "status": "ok",
            "module": "2 - API REST"
        }
    
    # ‚≠ê Registrar blueprints
    # Blueprint de autentica√ß√£o (Fase 2.1)
    from .blueprints.auth.routes import bp as auth_bp
    app.register_blueprint(auth_bp)
    
    # Blueprint de usu√°rios (Fase 2.2.1)
    from .blueprints.usuarios.routes import bp as usuarios_bp
    app.register_blueprint(usuarios_bp)
    
    # Blueprint de corretoras (Fase 2.2.2)
    from .blueprints.corretoras.routes import bp as corretoras_bp
    app.register_blueprint(corretoras_bp)
    
    # Blueprint de ativos (Fase 2.2.3)
    from .blueprints.ativos.routes import bp as ativos_bp
    app.register_blueprint(ativos_bp)
    
    # Blueprint de transa√ß√µes (Fase 2.2.4)
    from .blueprints.transacoes.routes import bp as transacoes_bp
    app.register_blueprint(transacoes_bp)
    
    # Outros blueprints ser√£o adicionados gradualmente nas pr√≥ximas fases
    # from .blueprints.posicoes.routes import bp as posicoes_bp
    # app.register_blueprint(posicoes_bp)
    
    print("üöÄ Exitus Backend M√≥dulo 2 - Application Factory criada com sucesso!")
    print(f"üìç Environment: {app.config.get('FLASK_ENV')}")
    print(f"üîê JWT Secret configurado: {'*' * 16}")
    print(f"üåê CORS configurado para: http://localhost:8080")
    print(f"‚úÖ Blueprints registrados: auth, usuarios, corretoras, ativos, transacoes")
    
    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py.mod1.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config
from .database import init_db


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)
    
    # Inicializa banco de dados
    init_db(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__kk ---


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/ativos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/ativos/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativos Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from app.services.ativo_service import AtivoService
from app.schemas.ativo_schema import (
    AtivoCreateSchema, AtivoUpdateSchema, AtivoResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden
from app.utils.decorators import admin_required

bp = Blueprint('ativos', __name__, url_prefix='/api/ativos')

@bp.route('', methods=['GET'])
@jwt_required()
def list_ativos():
    """Lista ativos com filtros"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativo = request.args.get('ativo', type=lambda x: x.lower() == 'true')
    tipo = request.args.get('tipo', type=str)
    classe = request.args.get('classe', type=str)
    mercado = request.args.get('mercado', type=str)
    deslistado = request.args.get('deslistado', type=lambda x: x.lower() == 'true')
    search = request.args.get('search', type=str)
    
    pagination = AtivoService.get_all(page, per_page, ativo, tipo, classe, mercado, deslistado, search)
    
    return success({
        "ativos": AtivoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de ativos")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_ativo(id):
    """Buscar ativo por ID"""
    ativo = AtivoService.get_by_id(id)
    
    if not ativo:
        return not_found("Ativo n√£o encontrado")
    
    return success(AtivoResponseSchema().dump(ativo), "Dados do ativo")

@bp.route('/ticker/<string:ticker>', methods=['GET'])
@jwt_required()
def get_by_ticker(ticker):
    """Buscar ativo por ticker e mercado"""
    mercado = request.args.get('mercado', 'BR', type=str)
    ativo = AtivoService.get_by_ticker(ticker, mercado)
    
    if not ativo:
        return not_found(f"Ativo {ticker} n√£o encontrado no mercado {mercado}")
    
    return success(AtivoResponseSchema().dump(ativo), "Dados do ativo")

@bp.route('', methods=['POST'])
@admin_required
def create_ativo():
    """Criar novo ativo (admin only)"""
    try:
        data = AtivoCreateSchema().load(request.json)
        ativo = AtivoService.create(data)
        return success(
            AtivoResponseSchema().dump(ativo),
            "Ativo criado com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar ativo: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@admin_required
def update_ativo(id):
    """Atualizar ativo (admin only)"""
    try:
        data = AtivoUpdateSchema().load(request.json)
        ativo = AtivoService.update(id, data)
        return success(AtivoResponseSchema().dump(ativo), "Ativo atualizado")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@admin_required
def delete_ativo(id):
    """Deletar ativo (admin only)"""
    try:
        AtivoService.delete(id)
        return success(None, "Ativo deletado com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/mercado/<string:mercado>', methods=['GET'])
@jwt_required()
def list_by_mercado(mercado):
    """Listar ativos de um mercado espec√≠fico"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 50, type=int)
    
    pagination = AtivoService.get_by_mercado(mercado, page, per_page)
    
    return success({
        "mercado": mercado.upper(),
        "ativos": AtivoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page
    }, f"Ativos do mercado {mercado.upper()}")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/auth/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/auth/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Blueprint - Endpoints de autentica√ß√£o"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt
from app.services.auth_service import AuthService
from app.schemas.auth_schema import LoginSchema, TokenResponseSchema, UserMeSchema
from app.utils.responses import success, error, unauthorized
from app.utils.decorators import admin_required  # ‚Üê NOVO IMPORT
from app.models import Usuario  # ‚Üê NOVO IMPORT
from app.database import db

bp = Blueprint('auth', __name__, url_prefix='/api/auth')

@bp.route('/login', methods=['POST'])
def login():
    """Login e gera√ß√£o de tokens JWT."""
    try:
        data = LoginSchema().load(request.json)
        tokens = AuthService.login(data['username'], data['password'])
        return success(tokens, "Login realizado com sucesso", 200)
    except ValueError as e:
        return unauthorized(str(e))
    except Exception as e:
        return error(f"Erro no login: {str(e)}", 500)

@bp.route('/refresh', methods=['POST'])
@jwt_required(refresh=True)
def refresh():
    """Refresh do access_token."""
    identity = get_jwt_identity()
    tokens = AuthService.refresh(identity)
    return success(tokens, "Token renovado com sucesso", 200)

@bp.route('/me', methods=['GET'])
@jwt_required()
def me():
    """Dados do usu√°rio autenticado."""
    identity = get_jwt_identity()
    user = Usuario.query.get(identity)
    if not user:
        return unauthorized("Usu√°rio n√£o encontrado")
    return success(UserMeSchema().dump(user), "Dados do usu√°rio")

@bp.route('/me/admin', methods=['GET'])
@admin_required  # ‚Üê NOVO: Apenas ADMIN pode acessar
def me_admin():
    """Endpoint de teste - apenas para ADMIN."""
    identity = get_jwt_identity()
    user = Usuario.query.get(identity)
    return success({
        "message": "Voc√™ √© um administrador!",
        "user": UserMeSchema().dump(user)
    }, "Acesso ADMIN confirmado")

@bp.route('/logout', methods=['POST'])
@jwt_required(refresh=True)
def logout():
    """Logout - invalida refresh token (implementa√ß√£o b√°sica)."""
    return success({"message": "Logout realizado com sucesso"}, 200)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/corretoras/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/corretoras/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretoras Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from app.services.corretora_service import CorretoraService
from app.schemas.corretora_schema import (
    CorretoraCreateSchema, CorretoraUpdateSchema, CorretoraResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden

bp = Blueprint('corretoras', __name__, url_prefix='/api/corretoras')

@bp.route('', methods=['GET'])
@jwt_required()
def list_corretoras():
    """Lista corretoras do usu√°rio autenticado"""
    usuario_id = get_jwt_identity()
    
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativa = request.args.get('ativa', type=lambda x: x.lower() == 'true')
    tipo = request.args.get('tipo', type=str)
    pais = request.args.get('pais', type=str)
    search = request.args.get('search', type=str)
    
    pagination = CorretoraService.get_all(usuario_id, page, per_page, ativa, tipo, pais, search)
    
    return success({
        "corretoras": CorretoraResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de corretoras")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_corretora(id):
    """Buscar corretora por ID"""
    usuario_id = get_jwt_identity()
    corretora = CorretoraService.get_by_id(id, usuario_id)
    
    if not corretora:
        return not_found("Corretora n√£o encontrada")
    
    return success(CorretoraResponseSchema().dump(corretora), "Dados da corretora")

@bp.route('', methods=['POST'])
@jwt_required()
def create_corretora():
    """Criar nova corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        data = CorretoraCreateSchema().load(request.json)
        corretora = CorretoraService.create(data, usuario_id)
        return success(
            CorretoraResponseSchema().dump(corretora),
            "Corretora criada com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar corretora: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_corretora(id):
    """Atualizar corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        data = CorretoraUpdateSchema().load(request.json)
        corretora = CorretoraService.update(id, data, usuario_id)
        return success(CorretoraResponseSchema().dump(corretora), "Corretora atualizada")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@jwt_required()
def delete_corretora(id):
    """Deletar corretora"""
    usuario_id = get_jwt_identity()
    
    try:
        CorretoraService.delete(id, usuario_id)
        return success(None, "Corretora deletada com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/saldo-total', methods=['GET'])
@jwt_required()
def saldo_total():
    """Saldo total do usu√°rio em determinada moeda"""
    usuario_id = get_jwt_identity()
    moeda = request.args.get('moeda', 'BRL', type=str)
    
    total = CorretoraService.get_saldo_total(usuario_id, moeda)
    
    return success({
        "moeda": moeda.upper(),
        "saldo_total": str(total)
    }, "Saldo total calculado")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/eventos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/eventos/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/feriados/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/feriados/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/fontes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/fontes/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/movimentacoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/movimentacoes/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/posicoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/posicoes/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/proventos/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/proventos/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/regras_fiscais/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/regras_fiscais/routes.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/transacoes/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/transacoes/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacoes Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from marshmallow import ValidationError
from datetime import datetime
from app.services.transacao_service import TransacaoService
from app.schemas.transacao_schema import TransacaoCreateSchema, TransacaoUpdateSchema, TransacaoResponseSchema
from app.utils.responses import success, error, not_found
from uuid import UUID

bp = Blueprint('transacoes', __name__, url_prefix='/api/transacoes')

@bp.route('', methods=['GET'])
@jwt_required()
def list_transacoes():
    """Lista transa√ß√µes do usu√°rio com filtros"""
    usuario_id = get_jwt_identity()
    
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    tipo = request.args.get('tipo', type=str)
    ativo_id = request.args.get('ativo_id', type=str)
    corretora_id = request.args.get('corretora_id', type=str)
    data_inicio = request.args.get('data_inicio', type=str)
    data_fim = request.args.get('data_fim', type=str)
    
    # Converter datas
    try:
        data_inicio = datetime.fromisoformat(data_inicio) if data_inicio else None
        data_fim = datetime.fromisoformat(data_fim) if data_fim else None
    except ValueError:
        return error("Formato de data inv√°lido. Use ISO 8601 (YYYY-MM-DD)", 400)
    
    pagination = TransacaoService.get_all(
        usuario_id, page, per_page, tipo, ativo_id, corretora_id, data_inicio, data_fim
    )
    
    return success({
        "transacoes": TransacaoResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de transa√ß√µes")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_transacao(id):
    """Buscar transa√ß√£o por ID"""
    usuario_id = get_jwt_identity()
    
    transacao = TransacaoService.get_by_id(id, usuario_id)
    if not transacao:
        return not_found("Transa√ß√£o n√£o encontrada")
    
    return success(TransacaoResponseSchema().dump(transacao), "Dados da transa√ß√£o")

@bp.route('', methods=['POST'])
@jwt_required()
def create_transacao():
    """Criar nova transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        data = TransacaoCreateSchema().load(request.json)
        transacao = TransacaoService.create(usuario_id, data)
        return success(
            TransacaoResponseSchema().dump(transacao),
            "Transa√ß√£o criada com sucesso",
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar transa√ß√£o: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_transacao(id):
    """Atualizar transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        data = TransacaoUpdateSchema().load(request.json)
        transacao = TransacaoService.update(id, usuario_id, data)
        return success(TransacaoResponseSchema().dump(transacao), "Transa√ß√£o atualizada")
    except ValidationError as e:
        return error(str(e), 400)
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@jwt_required()
def delete_transacao(id):
    """Deletar transa√ß√£o"""
    usuario_id = get_jwt_identity()
    
    try:
        TransacaoService.delete(id, usuario_id)
        return success(None, "Transa√ß√£o deletada com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/resumo/<uuid:ativo_id>', methods=['GET'])
@jwt_required()
def get_resumo_ativo(ativo_id):
    """Retorna resumo de transa√ß√µes de um ativo"""
    usuario_id = get_jwt_identity()
    
    resumo = TransacaoService.get_resumo_por_ativo(usuario_id, ativo_id)
    return success(resumo, "Resumo do ativo")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/usuarios/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/blueprints/usuarios/routes.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuarios Blueprint - Endpoints CRUD"""

from flask import Blueprint, request, jsonify, g
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.services.usuario_service import UsuarioService
from app.schemas.usuario_schema import (
    UsuarioCreateSchema, UsuarioUpdateSchema, 
    ChangePasswordSchema, UsuarioResponseSchema
)
from app.utils.responses import success, error, not_found, forbidden
from app.utils.decorators import admin_required
from app.models import Usuario

bp = Blueprint('usuarios', __name__, url_prefix='/api/usuarios')

@bp.route('', methods=['GET'])
@admin_required
def list_usuarios():
    """Lista usu√°rios (admin only) com pagina√ß√£o e filtros"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    ativo = request.args.get('ativo', type=lambda x: x.lower() == 'true')
    role = request.args.get('role', type=str)
    search = request.args.get('search', type=str)
    
    pagination = UsuarioService.get_all(page, per_page, ativo, role, search)
    
    return success({
        "usuarios": UsuarioResponseSchema(many=True).dump(pagination.items),
        "total": pagination.total,
        "pages": pagination.pages,
        "page": pagination.page,
        "per_page": pagination.per_page
    }, "Lista de usu√°rios")

@bp.route('/<uuid:id>', methods=['GET'])
@jwt_required()
def get_usuario(id):
    """Ver detalhes de usu√°rio (pr√≥prio ou admin)"""
    current_user_id = get_jwt_identity()
    current_user = Usuario.query.get(current_user_id)
    usuario = UsuarioService.get_by_id(id)
    
    if not usuario:
        return not_found("Usu√°rio n√£o encontrado")
    
    # Verifica permiss√£o: pr√≥prio usu√°rio ou admin
    if str(usuario.id) != current_user_id and current_user.role.value.upper() != 'ADMIN':
        return forbidden("Acesso negado")
    
    return success(UsuarioResponseSchema().dump(usuario), "Dados do usu√°rio")

@bp.route('', methods=['POST'])
def create_usuario():
    """Criar usu√°rio (registro p√∫blico)"""
    try:
        data = UsuarioCreateSchema().load(request.json)
        usuario = UsuarioService.create(data)
        return success(
            UsuarioResponseSchema().dump(usuario), 
            "Usu√°rio criado com sucesso", 
            201
        )
    except ValidationError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao criar usu√°rio: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['PUT'])
@jwt_required()
def update_usuario(id):
    """Atualizar usu√°rio (pr√≥prio ou admin)"""
    current_user_id = get_jwt_identity()
    current_user = Usuario.query.get(current_user_id)
    
    # Verifica permiss√£o
    if str(id) != current_user_id and current_user.role.value.upper() != 'ADMIN':
        return forbidden("Acesso negado")
    
    try:
        data = UsuarioUpdateSchema().load(request.json)
        usuario = UsuarioService.update(id, data, current_user)
        return success(UsuarioResponseSchema().dump(usuario), "Usu√°rio atualizado")
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao atualizar: {str(e)}", 500)

@bp.route('/<uuid:id>', methods=['DELETE'])
@admin_required
def delete_usuario(id):
    """Deletar usu√°rio (admin only)"""
    try:
        UsuarioService.delete(id)
        return success(None, "Usu√°rio deletado com sucesso")
    except ValueError as e:
        return not_found(str(e))
    except Exception as e:
        return error(f"Erro ao deletar: {str(e)}", 500)

@bp.route('/<uuid:id>/password', methods=['PATCH'])
@jwt_required()
def change_password(id):
    """Trocar senha (pr√≥prio usu√°rio)"""
    current_user_id = get_jwt_identity()
    
    # Apenas o pr√≥prio usu√°rio pode trocar sua senha
    if str(id) != current_user_id:
        return forbidden("Voc√™ s√≥ pode trocar sua pr√≥pria senha")
    
    try:
        data = ChangePasswordSchema().load(request.json)
        UsuarioService.change_password(id, data['old_password'], data['new_password'])
        return success(None, "Senha alterada com sucesso")
    except ValueError as e:
        return error(str(e), 400)
    except Exception as e:
        return error(f"Erro ao trocar senha: {str(e)}", 500)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py ---
# -*- coding: utf-8 -*-
"""Exitus - Database Configuration - SQLAlchemy + PostgreSQL"""

from flask_sqlalchemy import SQLAlchemy

# Inst√¢ncia global do SQLAlchemy
db = SQLAlchemy()

def init_db(app):
    """
    Inicializa o banco de dados com a aplica√ß√£o Flask.

    Args:
        app: Inst√¢ncia Flask
    """
    db.init_app(app)

    # Importar models DEPOIS de db.init_app para evitar circular imports
    with app.app_context():
        # Import APENAS do pacote - o __init__.py j√° importa todos os models
        # na ordem correta para resolver foreign keys
        import app.models

        # Criar todas as tabelas
        db.create_all()
        print("‚úÖ Banco de dados inicializado e tabelas criadas!")

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models (apenas quando existirem)
        # COMENTADO at√© criarmos os models na Fase 2
        # from app.models import (
        #     usuario, corretora, ativo, posicao, transacao,
        #     provento, movimentacao_caixa, evento_corporativo,
        #     fonte_dados, regra_fiscal, feriado_mercado, log_auditoria
        # )
        pass
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/middlewares/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/middlewares/auth_middleware.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Middlewares - Middlewares JWT avan√ßados"""

from functools import wraps
from flask import request, jsonify, g
from flask_jwt_extended import verify_jwt_in_request, get_jwt_identity
from app.database import db
from app.models import Usuario
from app.utils.responses import unauthorized, forbidden

def require_jwt():
    """Middleware: requer JWT v√°lido em todas as rotas protegidas."""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            try:
                verify_jwt_in_request()
                identity = get_jwt_identity()
                g.jwt_identity = identity
                return f(*args, **kwargs)
            except Exception:
                return unauthorized("Token JWT inv√°lido ou expirado"), 401
        return decorated_function
    return decorator

def rate_limit_by_user(max_requests=100):
    """Middleware: rate limiting por usu√°rio (implementa√ß√£o b√°sica)."""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            identity = get_jwt_identity()
            # Implementa√ß√£o simples - pode usar Redis em produ√ß√£o
            request_count = getattr(g, 'request_count', 0)
            g.request_count = request_count + 1
            
            if g.request_count > max_requests:
                return forbidden("Limite de requisi√ß√µes excedido"), 429
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - Models Package - Exporta√ß√£o centralizada"""

from .usuario import Usuario, UserRole
from .corretora import Corretora, TipoCorretora
from .ativo import Ativo, TipoAtivo, ClasseAtivo
from .transacao import Transacao, TipoTransacao

__all__ = [
    'Usuario',
    'UserRole',
    'Corretora',
    'TipoCorretora',
    'Ativo',
    'TipoAtivo',
    'ClasseAtivo',
    'Transacao',
    'TipoTransacao',
]

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/ativo.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Ativo - Entidade para instrumentos financeiros"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
from app.database import db

class TipoAtivo(enum.Enum):
    """Enum para tipos de ativo"""
    ACAO = "acao"
    FII = "fii"
    REIT = "reit"
    BOND = "bond"
    ETF = "etf"
    CRIPTO = "cripto"
    OUTRO = "outro"

class ClasseAtivo(enum.Enum):
    """Enum para classes de ativo"""
    RENDA_VARIAVEL = "renda_variavel"
    RENDA_FIXA = "renda_fixa"
    CRIPTO = "cripto"
    HIBRIDO = "hibrido"

class Ativo(db.Model):
    """Model para ativos financeiros"""
    __tablename__ = 'ativos'  # ‚¨ÖÔ∏è PLURAL
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    ticker = Column(String(20), nullable=False, index=True)
    nome = Column(String(200), nullable=False, index=True)
    tipo = Column(Enum(TipoAtivo), nullable=False, index=True)
    classe = Column(Enum(ClasseAtivo), nullable=False, index=True)
    
    # Mercado
    mercado = Column(String(10), nullable=False, default='BR', index=True)
    moeda = Column(String(3), nullable=False, default='BRL', index=True)
    
    # Cota√ß√£o
    preco_atual = Column(Numeric(18, 6), nullable=True)
    data_ultima_cotacao = Column(DateTime(timezone=True), nullable=True, index=True)
    
    # Indicadores
    dividend_yield = Column(Numeric(8, 4), nullable=True)
    p_l = Column(Numeric(10, 2), nullable=True)
    p_vp = Column(Numeric(10, 2), nullable=True)
    roe = Column(Numeric(8, 4), nullable=True)
    
    # Status
    ativo = Column(Boolean, default=True, nullable=False, index=True)
    deslistado = Column(Boolean, default=False, nullable=False, index=True)
    data_deslistagem = Column(Date, nullable=True)
    
    # Metadados
    observacoes = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def __repr__(self):
        return f"<Ativo {self.ticker} - {self.nome} ({self.mercado})>"
    
    def to_dict(self):
        return {
            "id": str(self.id),
            "ticker": self.ticker,
            "nome": self.nome,
            "tipo": self.tipo.value if self.tipo else None,
            "classe": self.classe.value if self.classe else None,
            "mercado": self.mercado,
            "moeda": self.moeda,
            "preco_atual": str(self.preco_atual) if self.preco_atual else None,
            "data_ultima_cotacao": self.data_ultima_cotacao.isoformat() if self.data_ultima_cotacao else None,
            "dividend_yield": str(self.dividend_yield) if self.dividend_yield else None,
            "p_l": str(self.p_l) if self.p_l else None,
            "p_vp": str(self.p_vp) if self.p_vp else None,
            "roe": str(self.roe) if self.roe else None,
            "ativo": self.ativo,
            "deslistado": self.deslistado,
            "data_deslistagem": self.data_deslistagem.isoformat() if self.data_deslistagem else None,
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/corretora.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Corretora"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Boolean, DateTime, Enum, Numeric, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from app.database import db

class TipoCorretora(enum.Enum):
    """Enum para tipos de corretora"""
    CORRETORA = "corretora"
    EXCHANGE = "exchange"

class Corretora(db.Model):
    """Model para corretoras/exchanges"""
    __tablename__ = 'corretoras'  # ‚¨ÖÔ∏è PLURAL
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    usuario_id = Column(UUID(as_uuid=True), ForeignKey('usuarios.id', ondelete='CASCADE'), nullable=False, index=True)
    
    # Dados
    nome = Column(String(100), nullable=False, index=True)
    tipo = Column(Enum(TipoCorretora), default=TipoCorretora.CORRETORA, nullable=False, index=True)
    pais = Column(String(2), nullable=False, default='BR', index=True)
    moeda_padrao = Column(String(3), nullable=False, default='BRL', index=True)
    saldo_atual = Column(Numeric(18, 2), default=0.00, nullable=False)
    
    # Status
    ativa = Column(Boolean, default=True, nullable=False, index=True)
    observacoes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # Relationships
    usuario = relationship("Usuario", backref="corretoras", lazy=True)
    
    def __repr__(self):
        return f"<Corretora {self.nome} ({self.pais})>"
    
    def to_dict(self):
        return {
            "id": str(self.id),
            "usuario_id": str(self.usuario_id),
            "nome": self.nome,
            "tipo": self.tipo.value if self.tipo else None,
            "pais": self.pais,
            "moeda_padrao": self.moeda_padrao,
            "saldo_atual": str(self.saldo_atual),
            "ativa": self.ativa,
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/evento_corporativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model EventoCorporativo
Entidade para eventos corporativos que afetam ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Boolean, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoEventoCorporativo(enum.Enum):
    """Enum para tipos de evento corporativo"""
    SPLIT = "split"                          # Desdobramento (ex: 1 a√ß√£o vira 2)
    GRUPAMENTO = "grupamento"                # Grupamento/Inplit (ex: 10 a√ß√µes viram 1)
    BONIFICACAO = "bonificacao"              # Bonifica√ß√£o em a√ß√µes
    DIREITO_SUBSCRICAO = "direito_sub"       # Direito de subscri√ß√£o
    FUSAO = "fusao"                          # Fus√£o com outra empresa
    CISAO = "cisao"                          # Cis√£o (spin-off)
    INCORPORACAO = "incorporacao"            # Incorpora√ß√£o por outra empresa
    MUDANCA_TICKER = "mudanca_ticker"        # Mudan√ßa de c√≥digo
    DESLISTAGEM = "deslistagem"              # Deslistagem da bolsa
    RELISTING = "relisting"                  # Relistagem
    CANCELAMENTO = "cancelamento"            # Cancelamento de a√ß√µes
    OUTRO = "outro"                          # Outros eventos


class EventoCorporativo(db.Model):
    """
    Model para eventos corporativos que afetam ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo afetado
        tipo_evento (TipoEventoCorporativo): Tipo do evento
        data_evento (date): Data do evento
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        proporcao (str): Propor√ß√£o do evento (ex: "2:1", "1:10")
        ativo_novo_id (UUID): ID do novo ativo (fus√µes, mudan√ßas)
        descricao (str): Descri√ß√£o detalhada do evento
        impacto_posicoes (bool): Indica se posi√ß√µes j√° foram ajustadas
        observacoes (str): Observa√ß√µes adicionais
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo original afetado
        ativo_novo: Novo ativo (para fus√µes, mudan√ßas de ticker)
    """
    
    __tablename__ = 'evento_corporativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do evento"
    )
    
    # Foreign keys
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo afetado pelo evento"
    )
    
    ativo_novo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do novo ativo (fus√µes, mudan√ßas de ticker)"
    )
    
    # Dados do evento
    tipo_evento = db.Column(
        Enum(TipoEventoCorporativo),
        nullable=False,
        index=True,
        comment="Tipo do evento corporativo"
    )
    
    data_evento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do evento"
    )
    
    data_com = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao evento)"
    )
    
    proporcao = db.Column(
        String(20),
        nullable=True,
        comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"
    )
    
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada do evento"
    )
    
    # Controle de processamento
    impacto_posicoes = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se as posi√ß√µes j√° foram ajustadas"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes adicionais sobre o evento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship(
        'Ativo',
        foreign_keys=[ativo_id],
        backref='eventos_corporativos',
        lazy='joined'
    )
    ativo_novo = relationship(
        'Ativo',
        foreign_keys=[ativo_novo_id],
        lazy='joined'
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "data_com IS NULL OR data_com <= data_evento",
            name="evento_data_com_valida"
        ),
        db.CheckConstraint(
            """
            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)
            OR 
            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))
            """,
            name="evento_proporcao_obrigatoria"
        ),
        {'comment': 'Tabela de eventos corporativos que afetam ativos'}
    )
    
    def is_split(self):
        """Verifica se √© split (desdobramento)"""
        return self.tipo_evento == TipoEventoCorporativo.SPLIT
    
    def is_grupamento(self):
        """Verifica se √© grupamento (inplit)"""
        return self.tipo_evento == TipoEventoCorporativo.GRUPAMENTO
    
    def is_bonificacao(self):
        """Verifica se √© bonifica√ß√£o"""
        return self.tipo_evento == TipoEventoCorporativo.BONIFICACAO
    
    def is_mudanca_ticker(self):
        """Verifica se √© mudan√ßa de ticker"""
        return self.tipo_evento == TipoEventoCorporativo.MUDANCA_TICKER
    
    def parse_proporcao(self):
        """
        Faz parse da propor√ß√£o do evento
        
        Returns:
            tuple: (numerador, denominador) ou None se inv√°lido
            
        Examples:
            "2:1" -> (2.0, 1.0) # Split 2 para 1
            "1:10" -> (1.0, 10.0) # Grupamento 1 para 10
            "1:1.5" -> (1.0, 1.5) # Bonifica√ß√£o 50%
        """
        if not self.proporcao:
            return None
        
        try:
            parts = self.proporcao.split(':')
            if len(parts) == 2:
                return (float(parts[0]), float(parts[1]))
        except (ValueError, IndexError):
            pass
        
        return None
    
    def calcular_fator_ajuste(self):
        """
        Calcula o fator de ajuste para quantidade de ativos
        
        Returns:
            float: Fator multiplicador (ex: 2.0 para split 2:1, 0.1 para grupamento 1:10)
        """
        proporcao = self.parse_proporcao()
        if not proporcao:
            return 1.0
        
        numerador, denominador = proporcao
        
        if self.is_split() or self.is_bonificacao():
            # Split 2:1 ou Bonifica√ß√£o 1:1.5 -> multiplica quantidade
            return numerador / denominador
        elif self.is_grupamento():
            # Grupamento 1:10 -> divide quantidade (inverte propor√ß√£o)
            return numerador / denominador
        
        return 1.0
    
    def calcular_fator_ajuste_preco(self):
        """
        Calcula o fator de ajuste para pre√ßo m√©dio
        (inverso do ajuste de quantidade)
        
        Returns:
            float: Fator divisor para pre√ßo
        """
        fator_quantidade = self.calcular_fator_ajuste()
        if fator_quantidade > 0:
            return 1.0 / fator_quantidade
        return 1.0
    
    def marcar_como_processado(self):
        """Marca o evento como processado (posi√ß√µes ajustadas)"""
        self.impacto_posicoes = True
    
    def dias_ate_evento(self):
        """
        Calcula quantos dias faltam para o evento
        
        Returns:
            int: Dias at√© evento (negativo se j√° ocorreu)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_evento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do evento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'ativo_novo_id': str(self.ativo_novo_id) if self.ativo_novo_id else None,
            'tipo_evento': self.tipo_evento.value if self.tipo_evento else None,
            'data_evento': self.data_evento.isoformat() if self.data_evento else None,
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'proporcao': self.proporcao,
            'fator_ajuste_quantidade': self.calcular_fator_ajuste(),
            'fator_ajuste_preco': self.calcular_fator_ajuste_preco(),
            'descricao': self.descricao,
            'impacto_posicoes': self.impacto_posicoes,
            'dias_ate_evento': self.dias_ate_evento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_evento.value if self.tipo_evento else "N/A"
        return f"<EventoCorporativo {tipo.upper()} {ticker} {self.proporcao or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/feriado_mercado.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FeriadoMercado
Entidade para feriados e dias sem preg√£o
"""

from datetime import datetime, time
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Text, Date, Time
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFeriado(enum.Enum):
    """Enum para tipos de feriado"""
    NACIONAL = "nacional"            # Feriado nacional
    BOLSA = "bolsa"                  # Feriado espec√≠fico da bolsa
    PONTE = "ponte"                  # Ponto facultativo
    FECHAMENTO_ANTECIPADO = "antecip"  # Fechamento antecipado
    MANUTENCAO = "manutencao"        # Manuten√ß√£o de sistemas
    OUTRO = "outro"                  # Outros tipos


class FeriadoMercado(db.Model):
    """
    Model para feriados e dias sem preg√£o
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s do feriado (c√≥digo ISO)
        mercado (str): Mercado/bolsa espec√≠fica
        data_feriado (date): Data do feriado
        tipo_feriado (TipoFeriado): Tipo do feriado
        nome (str): Nome do feriado
        horario_fechamento (time): Hor√°rio de fechamento antecipado
        recorrente (bool): Se √© feriado anual fixo
        observacoes (str): Observa√ß√µes sobre o feriado
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'feriado_mercado'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do feriado"
    )
    
    # Localiza√ß√£o
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    mercado = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos"
    )
    
    # Dados do feriado
    data_feriado = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do feriado"
    )
    
    tipo_feriado = db.Column(
        Enum(TipoFeriado),
        nullable=False,
        index=True,
        comment="Tipo do feriado"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        comment="Nome do feriado"
    )
    
    horario_fechamento = db.Column(
        Time,
        nullable=True,
        comment="Hor√°rio de fechamento antecipado (se aplic√°vel)"
    )
    
    recorrente = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o feriado"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="feriado_pais_iso_format"
        ),
        db.CheckConstraint(
            "length(nome) >= 3",
            name="feriado_nome_min_length"
        ),
        db.UniqueConstraint(
            'pais', 'mercado', 'data_feriado',
            name='unique_feriado_pais_mercado_data'
        ),
        {'comment': 'Tabela de feriados e dias sem preg√£o nos mercados'}
    )
    
    def is_fechamento_total(self):
        """Verifica se √© fechamento total (n√£o h√° preg√£o)"""
        return self.tipo_feriado in [
            TipoFeriado.NACIONAL,
            TipoFeriado.BOLSA,
            TipoFeriado.PONTE
        ]
    
    def is_fechamento_antecipado(self):
        """Verifica se √© fechamento antecipado"""
        return self.tipo_feriado == TipoFeriado.FECHAMENTO_ANTECIPADO
    
    def is_recorrente(self):
        """Verifica se √© feriado recorrente (anual)"""
        return self.recorrente
    
    def dias_ate_feriado(self):
        """
        Calcula quantos dias faltam para o feriado
        
        Returns:
            int: Dias at√© feriado (negativo se j√° passou)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_feriado - hoje
        return delta.days
    
    def is_hoje(self):
        """Verifica se o feriado √© hoje"""
        return self.data_feriado == datetime.utcnow().date()
    
    def is_futuro(self):
        """Verifica se o feriado √© no futuro"""
        return self.data_feriado > datetime.utcnow().date()
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do feriado
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'mercado': self.mercado,
            'data_feriado': self.data_feriado.isoformat() if self.data_feriado else None,
            'tipo_feriado': self.tipo_feriado.value if self.tipo_feriado else None,
            'nome': self.nome,
            'horario_fechamento': self.horario_fechamento.isoformat() if self.horario_fechamento else None,
            'recorrente': self.recorrente,
            'is_fechamento_total': self.is_fechamento_total(),
            'is_fechamento_antecipado': self.is_fechamento_antecipado(),
            'dias_ate_feriado': self.dias_ate_feriado(),
            'is_hoje': self.is_hoje(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<FeriadoMercado {self.pais} {self.data_feriado} - {self.nome}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/fonte_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FonteDados
Entidade para gerenciamento de fontes de dados externas (APIs)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Integer, Text
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFonteDados(enum.Enum):
    """Enum para tipos de fonte de dados"""
    API = "api"              # API RESTful
    SCRAPER = "scraper"      # Web scraping
    MANUAL = "manual"        # Entrada manual
    ARQUIVO = "arquivo"      # Import de arquivo
    OUTRO = "outro"          # Outros tipos


class FonteDados(db.Model):
    """
    Model para fontes de dados externas
    
    Attributes:
        id (UUID): Identificador √∫nico
        nome (str): Nome da fonte
        tipo_fonte (TipoFonteDados): Tipo da fonte
        url_base (str): URL base da API/fonte
        requer_autenticacao (bool): Se requer chave API
        rate_limit (str): Limite de requisi√ß√µes
        ativa (bool): Se fonte est√° ativa
        prioridade (int): Ordem de prioridade (1 = maior)
        ultima_consulta (datetime): Timestamp da √∫ltima consulta
        total_consultas (int): Total de consultas realizadas
        total_erros (int): Total de erros encontrados
        observacoes (str): Observa√ß√µes sobre a fonte
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'fonte_dados'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da fonte"
    )
    
    # Identifica√ß√£o
    nome = db.Column(
        String(100),
        unique=True,
        nullable=False,
        index=True,
        comment="Nome da fonte de dados (ex: yfinance, Alpha Vantage)"
    )
    
    tipo_fonte = db.Column(
        Enum(TipoFonteDados),
        nullable=False,
        index=True,
        comment="Tipo da fonte de dados"
    )
    
    url_base = db.Column(
        String(500),
        nullable=True,
        comment="URL base da API ou site"
    )
    
    # Configura√ß√µes
    requer_autenticacao = db.Column(
        Boolean,
        default=False,
        nullable=False,
        comment="Indica se requer chave API ou autentica√ß√£o"
    )
    
    rate_limit = db.Column(
        String(50),
        nullable=True,
        comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"
    )
    
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se fonte est√° ativa"
    )
    
    prioridade = db.Column(
        Integer,
        default=100,
        nullable=False,
        index=True,
        comment="Ordem de prioridade (1 = maior prioridade)"
    )
    
    # Estat√≠sticas
    ultima_consulta = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Timestamp da √∫ltima consulta bem-sucedida"
    )
    
    total_consultas = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de consultas realizadas"
    )
    
    total_erros = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de erros encontrados"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a fonte de dados"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "prioridade > 0",
            name="fonte_prioridade_positiva"
        ),
        db.CheckConstraint(
            "total_consultas >= 0",
            name="fonte_consultas_positivas"
        ),
        db.CheckConstraint(
            "total_erros >= 0",
            name="fonte_erros_positivos"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="fonte_nome_min_length"
        ),
        {'comment': 'Tabela de fontes de dados externas (APIs, scrapers)'}
    )
    
    def is_active(self):
        """Verifica se fonte est√° ativa"""
        return self.ativa
    
    def is_api(self):
        """Verifica se √© API"""
        return self.tipo_fonte == TipoFonteDados.API
    
    def registrar_consulta_sucesso(self):
        """Registra uma consulta bem-sucedida"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.ultima_consulta = datetime.utcnow()
        self.total_consultas += 1

    def registrar_erro(self):
        """Registra um erro na consulta"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.total_erros += 1
        self.total_consultas += 1

    def taxa_sucesso(self):
        """
        Calcula a taxa de sucesso das consultas
        
        Returns:
            float: Percentual de sucesso (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            sucessos = total - erros
            return (sucessos / total) * 100
        return 100.0  # Sem consultas = 100% por padr√£o

    def taxa_erro(self):
        """
        Calcula a taxa de erro das consultas
        
        Returns:
            float: Percentual de erro (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            return (erros / total) * 100
        return 0.0

    def health_status(self):
        """
        Determina o status de sa√∫de da fonte
        
        Returns:
            str: 'healthy', 'degraded', 'down', 'unknown'
        """
        total = self.total_consultas if self.total_consultas else 0
        
        if total == 0:
            return 'unknown'
        
        taxa_sucesso = self.taxa_sucesso()
        
        if taxa_sucesso >= 95:
            return 'healthy'
        elif taxa_sucesso >= 80:
            return 'degraded'
        else:
            return 'down'

    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da fonte
        """
        return {
            'id': str(self.id),
            'nome': self.nome,
            'tipo_fonte': self.tipo_fonte.value if self.tipo_fonte else None,
            'url_base': self.url_base,
            'requer_autenticacao': self.requer_autenticacao,
            'rate_limit': self.rate_limit,
            'ativa': self.ativa,
            'prioridade': self.prioridade,
            'ultima_consulta': self.ultima_consulta.isoformat() if self.ultima_consulta else None,
            'total_consultas': self.total_consultas,
            'total_erros': self.total_erros,
            'taxa_sucesso': round(self.taxa_sucesso(), 2),
            'taxa_erro': round(self.taxa_erro(), 2),
            'health_status': self.health_status(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.ativa else "‚úó"
        return f"<FonteDados {status} {self.nome} (prioridade {self.prioridade})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/log_auditoria.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model LogAuditoria
Entidade para logs de auditoria e compliance
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Text, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class LogAuditoria(db.Model):
    """
    Model para logs de auditoria
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio que realizou a a√ß√£o
        acao (str): Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE, etc.)
        entidade (str): Nome da entidade afetada
        entidade_id (UUID): ID do registro afetado
        dados_antes (dict): Estado anterior do registro (JSON)
        dados_depois (dict): Estado posterior do registro (JSON)
        ip_address (str): Endere√ßo IP de origem
        user_agent (str): Navegador/cliente usado
        timestamp (datetime): Data/hora da a√ß√£o
        sucesso (bool): Se a√ß√£o foi bem-sucedida
        mensagem (str): Mensagem de erro ou detalhes adicionais
    
    Relationships:
        usuario: Usu√°rio que realizou a a√ß√£o
    """
    
    __tablename__ = 'log_auditoria'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do log"
    )
    
    # Foreign key
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do usu√°rio (NULL para a√ß√µes an√¥nimas)"
    )
    
    # Dados da a√ß√£o
    acao = db.Column(
        String(50),
        nullable=False,
        index=True,
        comment="Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)"
    )
    
    entidade = db.Column(
        String(100),
        nullable=True,
        index=True,
        comment="Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)"
    )
    
    entidade_id = db.Column(
        UUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="ID do registro afetado"
    )
    
    # Estados anterior e posterior (para UPDATE)
    dados_antes = db.Column(
        JSON,
        nullable=True,
        comment="Estado anterior do registro (JSON)"
    )
    
    dados_depois = db.Column(
        JSON,
        nullable=True,
        comment="Estado posterior do registro (JSON)"
    )
    
    # Dados de contexto
    ip_address = db.Column(
        String(45),  # IPv6 pode ter at√© 45 caracteres
        nullable=True,
        index=True,
        comment="Endere√ßo IP de origem"
    )
    
    user_agent = db.Column(
        String(500),
        nullable=True,
        comment="User-Agent (navegador/cliente)"
    )
    
    timestamp = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        index=True,
        comment="Data/hora da a√ß√£o"
    )
    
    # Resultado
    sucesso = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se a√ß√£o foi bem-sucedida"
    )
    
    mensagem = db.Column(
        Text,
        nullable=True,
        comment="Mensagem de erro ou detalhes adicionais"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='logs_auditoria', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "length(acao) >= 3",
            name="log_acao_min_length"
        ),
        {'comment': 'Tabela de logs de auditoria para compliance'}
    )
    
    def is_sucesso(self):
        """Verifica se a√ß√£o foi bem-sucedida"""
        return self.sucesso
    
    def is_falha(self):
        """Verifica se a√ß√£o falhou"""
        return not self.sucesso
    
    def is_login(self):
        """Verifica se √© log de login"""
        return self.acao == 'LOGIN'
    
    def is_logout(self):
        """Verifica se √© log de logout"""
        return self.acao == 'LOGOUT'
    
    def is_create(self):
        """Verifica se √© cria√ß√£o de registro"""
        return self.acao == 'CREATE'
    
    def is_update(self):
        """Verifica se √© atualiza√ß√£o de registro"""
        return self.acao == 'UPDATE'
    
    def is_delete(self):
        """Verifica se √© exclus√£o de registro"""
        return self.acao == 'DELETE'
    
    def is_export(self):
        """Verifica se √© exporta√ß√£o de dados"""
        return self.acao == 'EXPORT'
    
    def get_alteracoes(self):
        """
        Extrai as altera√ß√µes realizadas (campos modificados)
        
        Returns:
            dict: Dicion√°rio com campos alterados e seus valores antes/depois
        """
        if not self.is_update() or not self.dados_antes or not self.dados_depois:
            return {}
        
        alteracoes = {}
        for campo, valor_depois in self.dados_depois.items():
            valor_antes = self.dados_antes.get(campo)
            if valor_antes != valor_depois:
                alteracoes[campo] = {
                    'antes': valor_antes,
                    'depois': valor_depois
                }
        
        return alteracoes
    
    def to_dict(self, include_dados=False):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Args:
            include_dados (bool): Se deve incluir dados_antes e dados_depois
        
        Returns:
            dict: Dicion√°rio com dados do log
        """
        data = {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id) if self.usuario_id else None,
            'acao': self.acao,
            'entidade': self.entidade,
            'entidade_id': str(self.entidade_id) if self.entidade_id else None,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None,
            'sucesso': self.sucesso,
            'mensagem': self.mensagem
        }
        
        if include_dados:
            data['dados_antes'] = self.dados_antes
            data['dados_depois'] = self.dados_depois
            data['alteracoes'] = self.get_alteracoes()
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.sucesso else "‚úó"
        usuario = self.usuario.username if self.usuario else "ANON"
        return f"<LogAuditoria {status} {usuario} {self.acao} {self.entidade or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/movimentacao_caixa.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model MovimentacaoCaixa
Entidade para movimenta√ß√µes de caixa em corretoras
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoMovimentacao(enum.Enum):
    """Enum para tipos de movimenta√ß√£o"""
    DEPOSITO = "deposito"                    # Dep√≥sito na corretora
    SAQUE = "saque"                          # Saque da corretora
    TRANSFERENCIA_ENVIADA = "transf_env"    # Transfer√™ncia para outra corretora
    TRANSFERENCIA_RECEBIDA = "transf_rec"   # Transfer√™ncia de outra corretora
    CREDITO_PROVENTO = "credito_prov"       # Cr√©dito de provento
    PAGAMENTO_TAXA = "pagto_taxa"           # Pagamento de taxa/cust√≥dia
    PAGAMENTO_IMPOSTO = "pagto_imposto"     # Pagamento de imposto
    AJUSTE = "ajuste"                        # Ajuste manual
    OUTRO = "outro"                          # Outros tipos


class MovimentacaoCaixa(db.Model):
    """
    Model para movimenta√ß√µes de caixa em corretoras
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora (origem)
        tipo_movimentacao (TipoMovimentacao): Tipo da movimenta√ß√£o
        valor (Decimal): Valor da movimenta√ß√£o
        moeda (str): Moeda (BRL, USD, EUR)
        data_movimentacao (date): Data da movimenta√ß√£o
        corretora_destino_id (UUID): ID da corretora destino (transfer√™ncias)
        provento_id (UUID): ID do provento (se for cr√©dito de provento)
        descricao (str): Descri√ß√£o da movimenta√ß√£o
        comprovante (str): Refer√™ncia ao comprovante
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora origem
        corretora_destino: Corretora destino (para transfer√™ncias)
        provento: Provento relacionado (para cr√©ditos)
    """
    
    __tablename__ = 'movimentacao_caixa'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da movimenta√ß√£o"
    )
    
    # Foreign keys obrigat√≥rias
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora (origem)"
    )
    
    # Foreign keys opcionais
    corretora_destino_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID da corretora destino (apenas para transfer√™ncias)"
    )
    
    provento_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('provento.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do provento (apenas para cr√©dito de provento)"
    )
    
    # Dados da movimenta√ß√£o
    tipo_movimentacao = db.Column(
        Enum(TipoMovimentacao),
        nullable=False,
        index=True,
        comment="Tipo da movimenta√ß√£o"
    )
    
    valor = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor da movimenta√ß√£o"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    data_movimentacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da movimenta√ß√£o"
    )
    
    # Metadados
    descricao = db.Column(
        Text,
        nullable=True,
        comment="Descri√ß√£o da movimenta√ß√£o"
    )
    
    comprovante = db.Column(
        String(200),
        nullable=True,
        comment="Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='movimentacoes_caixa', lazy='joined')
    corretora = relationship(
        'Corretora',
        foreign_keys=[corretora_id],
        backref='movimentacoes_caixa',
        lazy='joined'
    )
    corretora_destino = relationship(
        'Corretora',
        foreign_keys=[corretora_destino_id],
        lazy='joined'
    )
    provento = relationship('Provento', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor > 0",
            name="movimentacao_valor_positivo"
        ),
        db.CheckConstraint(
            "moeda ~* '^[A-Z]{3}$'",
            name="movimentacao_moeda_iso_format"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') 
             AND corretora_destino_id IS NOT NULL)
            OR 
            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))
            """,
            name="movimentacao_transferencia_tem_destino"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)
            OR 
            (tipo_movimentacao != 'credito_provento')
            """,
            name="movimentacao_credito_tem_provento"
        ),
        {'comment': 'Tabela de movimenta√ß√µes de caixa em corretoras'}
    )
    
    def is_entrada(self):
        """Verifica se √© movimenta√ß√£o de entrada (aumenta saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.DEPOSITO,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA,
            TipoMovimentacao.CREDITO_PROVENTO,
            TipoMovimentacao.AJUSTE  # Depende do contexto, mas inclu√≠mos aqui
        ]
    
    def is_saida(self):
        """Verifica se √© movimenta√ß√£o de sa√≠da (diminui saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.SAQUE,
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.PAGAMENTO_TAXA,
            TipoMovimentacao.PAGAMENTO_IMPOSTO
        ]
    
    def is_transferencia(self):
        """Verifica se √© transfer√™ncia entre corretoras"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA
        ]
    
    def is_credito_provento(self):
        """Verifica se √© cr√©dito de provento"""
        return self.tipo_movimentacao == TipoMovimentacao.CREDITO_PROVENTO
    
    def impacto_saldo(self):
        """
        Calcula o impacto no saldo da corretora
        
        Returns:
            Decimal: Valor positivo para entradas, negativo para sa√≠das
        """
        if self.is_entrada():
            return self.valor
        elif self.is_saida():
            return -self.valor
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da movimenta√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'corretora_destino_id': str(self.corretora_destino_id) if self.corretora_destino_id else None,
            'provento_id': str(self.provento_id) if self.provento_id else None,
            'tipo_movimentacao': self.tipo_movimentacao.value if self.tipo_movimentacao else None,
            'valor': float(self.valor) if self.valor else 0,
            'moeda': self.moeda,
            'impacto_saldo': float(self.impacto_saldo()),
            'data_movimentacao': self.data_movimentacao.isoformat() if self.data_movimentacao else None,
            'descricao': self.descricao,
            'comprovante': self.comprovante,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = self.tipo_movimentacao.value if self.tipo_movimentacao else "N/A"
        sinal = "+" if self.is_entrada() else "-"
        return f"<MovimentacaoCaixa {tipo.upper()} {sinal} {self.moeda} {self.valor}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/posicao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Posicao
Entidade para holdings/posi√ß√µes em carteira de ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Numeric, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class Posicao(db.Model):
    """
    Model para posi√ß√µes em carteira (holdings)
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        corretora_id (UUID): ID da corretora onde est√° a posi√ß√£o
        ativo_id (UUID): ID do ativo
        quantidade (Decimal): Quantidade de ativos em posse
        preco_medio (Decimal): Pre√ßo m√©dio de aquisi√ß√£o
        custo_total (Decimal): Custo total investido
        taxas_acumuladas (Decimal): Taxas de corretagem acumuladas
        impostos_acumulados (Decimal): Impostos pagos acumulados
        valor_atual (Decimal): Valor de mercado atual da posi√ß√£o
        lucro_prejuizo_realizado (Decimal): L/P realizado (vendas)
        lucro_prejuizo_nao_realizado (Decimal): L/P n√£o realizado
        data_primeira_compra (date): Data da primeira aquisi√ß√£o
        data_ultima_atualizacao (datetime): √öltima atualiza√ß√£o
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora onde est√° a posi√ß√£o
        ativo: Ativo da posi√ß√£o
    """
    
    __tablename__ = 'posicao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da posi√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora onde est√° a posi√ß√£o"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo"
    )
    
    # Dados da posi√ß√£o
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        default=0,
        comment="Quantidade de ativos (suporta fracion√°rios)"
    )
    
    preco_medio = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        default=0,
        comment="Pre√ßo m√©dio de aquisi√ß√£o"
    )
    
    custo_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Custo total investido (quantidade * pre√ßo m√©dio)"
    )
    
    taxas_acumuladas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem e cust√≥dia acumuladas"
    )
    
    impostos_acumulados = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Impostos pagos acumulados (IR, IOF, etc.)"
    )
    
    # Valores calculados
    valor_atual = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de mercado atual da posi√ß√£o"
    )
    
    lucro_prejuizo_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Lucro/preju√≠zo realizado em vendas"
    )
    
    lucro_prejuizo_nao_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)"
    )
    
    # Datas
    data_primeira_compra = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data da primeira aquisi√ß√£o deste ativo"
    )
    
    data_ultima_atualizacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data da √∫ltima atualiza√ß√£o de valores"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='posicoes', lazy='joined')
    corretora = relationship('Corretora', backref='posicoes', lazy='joined')
    ativo = relationship('Ativo', backref='posicoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade >= 0",
            name="posicao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_medio >= 0",
            name="posicao_preco_medio_positivo"
        ),
        db.CheckConstraint(
            "custo_total >= 0",
            name="posicao_custo_total_positivo"
        ),
        db.CheckConstraint(
            "taxas_acumuladas >= 0",
            name="posicao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos_acumulados >= 0",
            name="posicao_impostos_positivos"
        ),
        db.UniqueConstraint(
            'usuario_id', 'corretora_id', 'ativo_id',
            name='unique_posicao_usuario_corretora_ativo'
        ),
        {'comment': 'Tabela de posi√ß√µes em carteira (holdings)'}
    )
    
    def calcular_valor_atual(self, preco_mercado):
        """
        Calcula o valor atual da posi√ß√£o baseado no pre√ßo de mercado
        
        Args:
            preco_mercado (Decimal): Pre√ßo atual do ativo no mercado
        
        Returns:
            Decimal: Valor atual da posi√ß√£o
        """
        self.valor_atual = self.quantidade * preco_mercado
        self.data_ultima_atualizacao = datetime.utcnow()
        return self.valor_atual
    
    def calcular_lucro_prejuizo_nao_realizado(self):
        """
        Calcula o lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)
        
        Returns:
            Decimal: L/P n√£o realizado
        """
        if self.valor_atual is not None:
            self.lucro_prejuizo_nao_realizado = self.valor_atual - self.custo_total
        return self.lucro_prejuizo_nao_realizado
    
    def adicionar_compra(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma compra √† posi√ß√£o (recalcula pre√ßo m√©dio)
        
        Args:
            quantidade (Decimal): Quantidade comprada
            preco_unitario (Decimal): Pre√ßo unit√°rio da compra
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        """
        # Garantir valores n√£o-None (defaults do SQLAlchemy s√≥ aplicam ao persistir)
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        custo_compra = quantidade * preco_unitario
        
        # Recalcular pre√ßo m√©dio ponderado
        novo_custo_total = self.custo_total + custo_compra
        nova_quantidade = self.quantidade + quantidade
        
        if nova_quantidade > 0:
            self.preco_medio = novo_custo_total / nova_quantidade
        
        self.quantidade = nova_quantidade
        self.custo_total = novo_custo_total
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Definir data primeira compra se for a primeira
        if self.data_primeira_compra is None:
            self.data_primeira_compra = datetime.utcnow().date()

    
    def adicionar_venda(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma venda √† posi√ß√£o
        
        Args:
            quantidade (Decimal): Quantidade vendida
            preco_unitario (Decimal): Pre√ßo unit√°rio da venda
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        
        Raises:
            ValueError: Se quantidade vendida for maior que quantidade em posse
        """
        # Garantir valores n√£o-None
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        if quantidade > self.quantidade:
            raise ValueError(
                f"Quantidade vendida ({quantidade}) maior que quantidade em posse ({self.quantidade})"
            )
        
        # Calcular lucro/preju√≠zo realizado
        receita_venda = quantidade * preco_unitario
        custo_proporcional = quantidade * self.preco_medio
        lp_realizado = receita_venda - custo_proporcional - taxas - impostos
        
        self.lucro_prejuizo_realizado += lp_realizado
        self.quantidade -= quantidade
        self.custo_total -= custo_proporcional
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Se zerou a posi√ß√£o, resetar pre√ßo m√©dio
        if self.quantidade == 0:
            self.preco_medio = 0
            self.custo_total = 0

    
    def percentual_lucro_prejuizo(self):
        """
        Calcula o percentual de lucro/preju√≠zo n√£o realizado
        
        Returns:
            Decimal: Percentual de L/P (ex: 15.5 = 15.5%)
        """
        if self.custo_total > 0 and self.lucro_prejuizo_nao_realizado is not None:
            return (self.lucro_prejuizo_nao_realizado / self.custo_total) * 100
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da posi√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_medio': float(self.preco_medio) if self.preco_medio else 0,
            'custo_total': float(self.custo_total) if self.custo_total else 0,
            'taxas_acumuladas': float(self.taxas_acumuladas) if self.taxas_acumuladas else 0,
            'impostos_acumulados': float(self.impostos_acumulados) if self.impostos_acumulados else 0,
            'valor_atual': float(self.valor_atual) if self.valor_atual else None,
            'lucro_prejuizo_realizado': float(self.lucro_prejuizo_realizado) if self.lucro_prejuizo_realizado else 0,
            'lucro_prejuizo_nao_realizado': float(self.lucro_prejuizo_nao_realizado) if self.lucro_prejuizo_nao_realizado else None,
            'percentual_lp': float(self.percentual_lucro_prejuizo()),
            'data_primeira_compra': self.data_primeira_compra.isoformat() if self.data_primeira_compra else None,
            'data_ultima_atualizacao': self.data_ultima_atualizacao.isoformat() if self.data_ultima_atualizacao else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Posicao {self.quantidade}x {self.ativo.ticker if self.ativo else 'N/A'}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/provento.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Provento
Entidade para registro de proventos (dividendos, JCP, rendimentos)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoProvento(enum.Enum):
    """Enum para tipos de provento"""
    DIVIDENDO = "dividendo"              # Dividendo ordin√°rio
    JCP = "jcp"                          # Juros sobre Capital Pr√≥prio
    RENDIMENTO = "rendimento"            # Rendimento de FII
    CUPOM = "cupom"                      # Cupom de t√≠tulo de renda fixa
    BONIFICACAO = "bonificacao"          # Bonifica√ß√£o em dinheiro
    DIREITO_SUBSCRICAO = "direito_sub"   # Direito de subscri√ß√£o vendido
    OUTRO = "outro"                      # Outros tipos


class Provento(db.Model):
    """
    Model para proventos recebidos de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo que pagou o provento
        tipo_provento (TipoProvento): Tipo do provento
        valor_por_acao (Decimal): Valor unit√°rio por ativo
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        data_pagamento (date): Data efetiva do pagamento
        quantidade_ativos (Decimal): Quantidade de ativos que geraram provento
        valor_bruto (Decimal): Valor bruto recebido
        imposto_retido (Decimal): IR retido na fonte
        valor_liquido (Decimal): Valor l√≠quido creditado
        observacoes (str): Observa√ß√µes sobre o provento
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo que pagou o provento
    """
    
    __tablename__ = 'provento'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do provento"
    )
    
    # Foreign key
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo que pagou o provento"
    )
    
    # Tipo de provento
    tipo_provento = db.Column(
        Enum(TipoProvento),
        nullable=False,
        index=True,
        comment="Tipo do provento (dividendo, JCP, rendimento, etc.)"
    )
    
    # Valores
    valor_por_acao = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Valor unit√°rio por ativo"
    )
    
    quantidade_ativos = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade de ativos que geraram o provento"
    )
    
    valor_bruto = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor bruto recebido"
    )
    
    imposto_retido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte"
    )
    
    valor_liquido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor l√≠quido creditado"
    )
    
    # Datas
    data_com = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao provento)"
    )
    
    data_pagamento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data efetiva do pagamento"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o provento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship('Ativo', backref='proventos', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor_por_acao > 0",
            name="provento_valor_por_acao_positivo"
        ),
        db.CheckConstraint(
            "quantidade_ativos > 0",
            name="provento_quantidade_positiva"
        ),
        db.CheckConstraint(
            "valor_bruto > 0",
            name="provento_valor_bruto_positivo"
        ),
        db.CheckConstraint(
            "imposto_retido >= 0",
            name="provento_imposto_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido > 0",
            name="provento_valor_liquido_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido <= valor_bruto",
            name="provento_liquido_menor_bruto"
        ),
        db.CheckConstraint(
            "data_pagamento >= data_com",
            name="provento_data_pagamento_valida"
        ),
        {'comment': 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa provento com c√°lculos autom√°ticos
        """
        super(Provento, self).__init__(**kwargs)
        
        # Calcular valor bruto se n√£o fornecido
        if self.valor_bruto is None and self.valor_por_acao and self.quantidade_ativos:
            self.valor_bruto = self.valor_por_acao * self.quantidade_ativos
        
        # Calcular valor l√≠quido se n√£o fornecido
        if self.valor_liquido is None and self.valor_bruto is not None:
            imposto = self.imposto_retido if self.imposto_retido else 0
            self.valor_liquido = self.valor_bruto - imposto
    
    def is_dividendo(self):
        """Verifica se √© dividendo"""
        return self.tipo_provento == TipoProvento.DIVIDENDO
    
    def is_jcp(self):
        """Verifica se √© JCP"""
        return self.tipo_provento == TipoProvento.JCP
    
    def is_rendimento_fii(self):
        """Verifica se √© rendimento de FII"""
        return self.tipo_provento == TipoProvento.RENDIMENTO
    
    def percentual_imposto(self):
        """
        Calcula o percentual de imposto retido
        
        Returns:
            Decimal: Percentual de imposto (ex: 15.0 = 15%)
        """
        if self.valor_bruto and self.valor_bruto > 0:
            imposto = self.imposto_retido if self.imposto_retido else 0
            return (imposto / self.valor_bruto) * 100
        return 0
    
    def dividend_yield_efetivo(self, preco_ativo):
        """
        Calcula o dividend yield efetivo baseado no pre√ßo do ativo
        
        Args:
            preco_ativo (Decimal): Pre√ßo atual do ativo
            
        Returns:
            Decimal: DY efetivo em % (ex: 6.5 = 6.5%)
        """
        if preco_ativo and preco_ativo > 0:
            return (self.valor_por_acao / preco_ativo) * 100
        return 0
    
    def dias_ate_pagamento(self):
        """
        Calcula quantos dias faltam para o pagamento
        
        Returns:
            int: Dias at√© pagamento (negativo se j√° pago)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_pagamento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do provento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'tipo_provento': self.tipo_provento.value if self.tipo_provento else None,
            'valor_por_acao': float(self.valor_por_acao) if self.valor_por_acao else 0,
            'quantidade_ativos': float(self.quantidade_ativos) if self.quantidade_ativos else 0,
            'valor_bruto': float(self.valor_bruto) if self.valor_bruto else 0,
            'imposto_retido': float(self.imposto_retido) if self.imposto_retido else 0,
            'valor_liquido': float(self.valor_liquido) if self.valor_liquido else 0,
            'percentual_imposto': float(self.percentual_imposto()),
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'data_pagamento': self.data_pagamento.isoformat() if self.data_pagamento else None,
            'dias_ate_pagamento': self.dias_ate_pagamento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_provento.value if self.tipo_provento else "N/A"
        return f"<Provento {tipo.upper()} {ticker} R$ {self.valor_por_acao}/a√ß√£o>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/regra_fiscal.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model RegraFiscal
Entidade para regras tribut√°rias por pa√≠s e tipo de ativo
"""

from datetime import datetime, date
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class IncidenciaImposto(enum.Enum):
    """Enum para tipo de incid√™ncia do imposto"""
    LUCRO = "lucro"              # Incide sobre lucro/ganho de capital
    RECEITA = "receita"          # Incide sobre receita bruta
    PROVENTO = "provento"        # Incide sobre proventos recebidos
    OPERACAO = "operacao"        # Incide sobre cada opera√ß√£o


class RegraFiscal(db.Model):
    """
    Model para regras tribut√°rias
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s da regra (c√≥digo ISO)
        tipo_ativo (str): Tipo de ativo (ACAO, FII, REIT, etc.)
        tipo_operacao (str): Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE)
        aliquota_ir (Decimal): Al√≠quota de IR em %
        valor_isencao (Decimal): Valor de isen√ß√£o mensal
        incide_sobre (IncidenciaImposto): Sobre o que incide o imposto
        descricao (str): Descri√ß√£o da regra
        vigencia_inicio (date): Data de in√≠cio da vig√™ncia
        vigencia_fim (date): Data de fim da vig√™ncia
        ativa (bool): Indica se regra est√° ativa
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'regra_fiscal'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da regra"
    )
    
    # Identifica√ß√£o da regra
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    tipo_ativo = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos"
    )
    
    tipo_operacao = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas"
    )
    
    # Valores fiscais
    aliquota_ir = db.Column(
        Numeric(precision=6, scale=4),
        nullable=False,
        comment="Al√≠quota de IR em % (ex: 15.0000 = 15%)"
    )
    
    valor_isencao = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)"
    )
    
    incide_sobre = db.Column(
        Enum(IncidenciaImposto),
        nullable=False,
        index=True,
        comment="Sobre o que incide o imposto"
    )
    
    # Descri√ß√£o
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada da regra fiscal"
    )
    
    # Vig√™ncia
    vigencia_inicio = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data de in√≠cio da vig√™ncia da regra"
    )
    
    vigencia_fim = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de fim da vig√™ncia (NULL = vigente indefinidamente)"
    )
    
    # Status
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se regra est√° ativa"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "aliquota_ir >= 0 AND aliquota_ir <= 100",
            name="regra_aliquota_valida"
        ),
        db.CheckConstraint(
            "valor_isencao IS NULL OR valor_isencao >= 0",
            name="regra_isencao_positiva"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="regra_pais_iso_format"
        ),
        db.CheckConstraint(
            "vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio",
            name="regra_vigencia_valida"
        ),
        {'comment': 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'}
    )
    
    def is_active(self):
        """Verifica se regra est√° ativa"""
        return self.ativa
    
    def is_vigente(self, data_referencia=None):
        """
        Verifica se regra est√° vigente em uma data
        
        Args:
            data_referencia (date): Data de refer√™ncia (default: hoje)
            
        Returns:
            bool: True se vigente
        """
        if not self.ativa:
            return False
        
        if data_referencia is None:
            data_referencia = datetime.utcnow().date()
        
        # Verifica in√≠cio
        if data_referencia < self.vigencia_inicio:
            return False
        
        # Verifica fim (se definido)
        if self.vigencia_fim and data_referencia > self.vigencia_fim:
            return False
        
        return True
    
    def tem_isencao(self):
        """Verifica se regra possui valor de isen√ß√£o"""
        return self.valor_isencao is not None and self.valor_isencao > 0
    
    def calcular_imposto(self, base_calculo):
        """
        Calcula o imposto devido sobre uma base de c√°lculo
        
        Args:
            base_calculo (Decimal): Valor base para c√°lculo
            
        Returns:
            Decimal: Valor do imposto devido
        """
        # Se tem isen√ß√£o e base est√° abaixo, n√£o h√° imposto
        if self.tem_isencao() and base_calculo <= self.valor_isencao:
            return 0
        
        # Calcula imposto sobre o valor (ou valor acima da isen√ß√£o)
        valor_tributavel = base_calculo
        if self.tem_isencao():
            valor_tributavel = base_calculo - self.valor_isencao
        
        imposto = valor_tributavel * (self.aliquota_ir / 100)
        return max(imposto, 0)  # Nunca retornar negativo
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da regra
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'tipo_ativo': self.tipo_ativo,
            'tipo_operacao': self.tipo_operacao,
            'aliquota_ir': float(self.aliquota_ir) if self.aliquota_ir else 0,
            'valor_isencao': float(self.valor_isencao) if self.valor_isencao else None,
            'incide_sobre': self.incide_sobre.value if self.incide_sobre else None,
            'descricao': self.descricao,
            'vigencia_inicio': self.vigencia_inicio.isoformat() if self.vigencia_inicio else None,
            'vigencia_fim': self.vigencia_fim.isoformat() if self.vigencia_fim else None,
            'ativa': self.ativa,
            'vigente': self.is_vigente(),
            'tem_isencao': self.tem_isencao(),
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<RegraFiscal {self.pais} {self.tipo_ativo or 'ALL'} IR={self.aliquota_ir}%>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/transacao.py ---
# -*- coding: utf-8 -*-
"""Exitus - Modelo Transacao - M√≥dulo 2 Fase 2.2.4"""

import enum
from datetime import datetime
from sqlalchemy import Column, String, Numeric, DateTime, Enum, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from app.database import db

class TipoTransacao(enum.Enum):
    """Enum para tipos de transa√ß√£o"""
    COMPRA = "compra"
    VENDA = "venda"
    DIVIDENDO = "dividendo"
    JCP = "jcp"
    BONIFICACAO = "bonificacao"
    DESDOBRAMENTO = "desdobramento"
    GRUPAMENTO = "grupamento"

class Transacao(db.Model):
    """
    Modelo de Transa√ß√£o.
    
    Representa opera√ß√µes financeiras do usu√°rio:
    - Compra/venda de ativos
    - Recebimento de dividendos/JCP
    - Eventos corporativos (bonifica√ß√£o, desdobramento, grupamento)
    """
    __tablename__ = 'transacoes'
    
    # Identifica√ß√£o
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    usuario_id = Column(UUID(as_uuid=True), ForeignKey('usuarios.id'), nullable=False)
    tipo = Column(Enum(TipoTransacao), nullable=False)
    
    # Relacionamentos
    ativo_id = Column(UUID(as_uuid=True), ForeignKey('ativos.id'), nullable=False)
    corretora_id = Column(UUID(as_uuid=True), ForeignKey('corretoras.id'), nullable=False)
    
    # Dados da transa√ß√£o
    data_transacao = Column(DateTime(timezone=True), nullable=False)
    quantidade = Column(Numeric(18, 8), nullable=False)
    preco_unitario = Column(Numeric(18, 6), nullable=False)
    valor_total = Column(Numeric(18, 2), nullable=False)  # quantidade * preco_unitario
    
    # Custos operacionais
    taxa_corretagem = Column(Numeric(18, 2), nullable=False, default=0)
    taxa_liquidacao = Column(Numeric(18, 2), nullable=False, default=0)
    emolumentos = Column(Numeric(18, 2), nullable=False, default=0)
    imposto = Column(Numeric(18, 2), nullable=False, default=0)
    outros_custos = Column(Numeric(18, 2), nullable=False, default=0)
    
    # Totalizadores
    custos_totais = Column(Numeric(18, 2), nullable=False, default=0)
    valor_liquido = Column(Numeric(18, 2), nullable=False)  # valor_total +/- custos
    
    # Metadados
    observacoes = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships (lazy loading)
    usuario = relationship("Usuario", backref="transacoes", lazy=True)
    ativo = relationship("Ativo", backref="transacoes", lazy=True)
    corretora = relationship("Corretora", backref="transacoes", lazy=True)
    
    def __repr__(self):
        return f"<Transacao {self.tipo.value} {self.quantidade} {self.ativo.ticker if self.ativo else '?'} @ {self.data_transacao.date()}>"
    
    def to_dict(self):
        """Serializa transa√ß√£o para dict"""
        return {
            "id": str(self.id),
            "usuario_id": str(self.usuario_id),
            "tipo": self.tipo.value,
            "ativo_id": str(self.ativo_id),
            "corretora_id": str(self.corretora_id),
            "data_transacao": self.data_transacao.isoformat(),
            "quantidade": str(self.quantidade),
            "preco_unitario": str(self.preco_unitario),
            "valor_total": str(self.valor_total),
            "taxa_corretagem": str(self.taxa_corretagem),
            "taxa_liquidacao": str(self.taxa_liquidacao),
            "emolumentos": str(self.emolumentos),
            "imposto": str(self.imposto),
            "outros_custos": str(self.outros_custos),
            "custos_totais": str(self.custos_totais),
            "valor_liquido": str(self.valor_liquido),
            "observacoes": self.observacoes,
            "created_at": self.created_at.isoformat(),
            "updated_at": self.updated_at.isoformat()
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/usuario.py ---
# -*- coding: utf-8 -*-
"""Exitus - Model Usuario - Entidade principal para autentica√ß√£o"""

import enum
from datetime import datetime
from sqlalchemy import String, Boolean, DateTime, Enum
from sqlalchemy.dialects.postgresql import UUID
import uuid
from werkzeug.security import generate_password_hash, check_password_hash
from app.database import db

class UserRole(enum.Enum):
    """Enum para roles/perfis de usu√°rio"""
    ADMIN = "admin"
    USER = "user"
    READONLY = "readonly"

class Usuario(db.Model):
    """Model para usu√°rios do sistema Exitus"""
    __tablename__ = 'usuarios'  # ‚¨ÖÔ∏è PLURAL (consistente com FK)
    
    # Identifica√ß√£o
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = db.Column(String(50), unique=True, nullable=False, index=True)
    email = db.Column(String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(String(255), nullable=False)
    nome_completo = db.Column(String(200), nullable=True)
    
    # Controle
    ativo = db.Column(Boolean, default=True, nullable=False)
    role = db.Column(Enum(UserRole), default=UserRole.USER, nullable=False)
    
    # Timestamps
    created_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def set_password(self, password):
        """Define a senha do usu√°rio (gera hash bcrypt)"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Verifica se a senha fornecida est√° correta"""
        return check_password_hash(self.password_hash, password)
    
    def is_admin(self):
        """Verifica se usu√°rio √© administrador"""
        return self.role == UserRole.ADMIN
    
    def is_active(self):
        """Verifica se usu√°rio est√° ativo"""
        return self.ativo
    
    def to_dict(self, include_sensitive=False):
        """Converte objeto para dicion√°rio para serializa√ß√£o JSON"""
        data = {
            "id": str(self.id),
            "username": self.username,
            "email": self.email,
            "nome_completo": self.nome_completo,
            "ativo": self.ativo,
            "role": self.role.value if self.role else UserRole.USER.value,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }
        
        if include_sensitive:
            data["password_hash"] = self.password_hash
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Usuario {self.username} ({self.email})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/ativo_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Ativo, TipoAtivo, ClasseAtivo
from app.database import db
from decimal import Decimal

class AtivoCreateSchema(Schema):
    """Schema para cria√ß√£o de ativo"""
    ticker = fields.Str(required=True, validate=lambda x: 1 <= len(x) <= 20)
    nome = fields.Str(required=True, validate=lambda x: 2 <= len(x) <= 200)
    tipo = fields.Str(required=True)
    classe = fields.Str(required=True)
    mercado = fields.Str(required=True, validate=lambda x: len(x) <= 10)
    moeda = fields.Str(required=True, validate=lambda x: len(x) == 3)
    preco_atual = fields.Decimal(required=False, as_string=True, allow_none=True)
    dividend_yield = fields.Decimal(required=False, as_string=True, allow_none=True)
    pl = fields.Decimal(required=False, as_string=True, allow_none=True)
    pvp = fields.Decimal(required=False, as_string=True, allow_none=True)
    roe = fields.Decimal(required=False, as_string=True, allow_none=True)
    ativo = fields.Bool(required=False, default=True)
    deslistado = fields.Bool(required=False, default=False)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['acao', 'fii', 'reit', 'bond', 'etf', 'cripto', 'outro']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('classe')
    def validate_classe(self, value):
        """Valida se classe √© v√°lida"""
        valid_classes = ['renda_variavel', 'renda_fixa', 'cripto', 'hibrido']
        if value.lower() not in valid_classes:
            raise ValidationError(f"Classe inv√°lida. Op√ß√µes: {', '.join(valid_classes)}")
    
    @validates('moeda')
    def validate_moeda(self, value):
        """Valida c√≥digo ISO da moeda (3 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")
    
    @validates('ticker')
    def validate_ticker_format(self, value):
        """Valida formato do ticker"""
        if not value.replace('.', '').replace('-', '').isalnum():
            raise ValidationError("Ticker deve conter apenas letras, n√∫meros, pontos e h√≠fens")

class AtivoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de ativo"""
    nome = fields.Str(required=False, validate=lambda x: 2 <= len(x) <= 200)
    tipo = fields.Str(required=False)
    classe = fields.Str(required=False)
    mercado = fields.Str(required=False, validate=lambda x: len(x) <= 10)
    moeda = fields.Str(required=False, validate=lambda x: len(x) == 3)
    preco_atual = fields.Decimal(required=False, as_string=True, allow_none=True)
    dividend_yield = fields.Decimal(required=False, as_string=True, allow_none=True)
    pl = fields.Decimal(required=False, as_string=True, allow_none=True)
    pvp = fields.Decimal(required=False, as_string=True, allow_none=True)
    roe = fields.Decimal(required=False, as_string=True, allow_none=True)
    ativo = fields.Bool(required=False)
    deslistado = fields.Bool(required=False)
    data_deslistagem = fields.Date(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        valid_tipos = ['acao', 'fii', 'reit', 'bond', 'etf', 'cripto', 'outro']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('classe')
    def validate_classe(self, value):
        valid_classes = ['renda_variavel', 'renda_fixa', 'cripto', 'hibrido']
        if value.lower() not in valid_classes:
            raise ValidationError(f"Classe inv√°lida. Op√ß√µes: {', '.join(valid_classes)}")

class AtivoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de ativo"""
    class Meta:
        model = Ativo
        load_instance = False
    
    tipo = fields.Method("get_tipo_str")
    classe = fields.Method("get_classe_str")
    preco_atual = fields.Decimal(as_string=True)
    dividend_yield = fields.Decimal(as_string=True)
    pl = fields.Decimal(as_string=True)
    pvp = fields.Decimal(as_string=True)
    roe = fields.Decimal(as_string=True)
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None
    
    def get_classe_str(self, obj):
        """Converte Enum para string"""
        return obj.classe.value if obj.classe else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/ativo_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import date
from sqlalchemy import or_
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo

class AtivoService:
    """Servi√ßo para opera√ß√µes de ativos"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, tipo=None, classe=None, mercado=None, 
                deslistado=None, search=None):
        """
        Lista ativos com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            tipo: Filtro por tipo (ACAO, FII, etc)
            classe: Filtro por classe (RENDA_VARIAVEL, etc)
            mercado: Filtro por mercado (BR, US, etc)
            deslistado: Filtro por deslistados
            search: Busca em ticker e nome
        """
        query = Ativo.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if tipo:
            query = query.filter_by(tipo=TipoAtivo[tipo.upper()])
        
        if classe:
            query = query.filter_by(classe=ClasseAtivo[classe.upper()])
        
        if mercado:
            query = query.filter_by(mercado=mercado.upper())
        
        if deslistado is not None:
            query = query.filter_by(deslistado=deslistado)
        
        if search:
            query = query.filter(
                or_(
                    Ativo.ticker.ilike(f'%{search}%'),
                    Ativo.nome.ilike(f'%{search}%')
                )
            )
        
        # Ordenar por ticker
        query = query.order_by(Ativo.ticker)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(ativo_id):
        """Busca ativo por ID"""
        return Ativo.query.get(ativo_id)
    
    @staticmethod
    def get_by_ticker(ticker, mercado):
        """Busca ativo por ticker e mercado"""
        return Ativo.query.filter_by(
            ticker=ticker.upper(),
            mercado=mercado.upper()
        ).first()
    
    @staticmethod
    def create(data):
        """
        Cria novo ativo.
        
        Args:
            data: Dict com ticker, nome, tipo, classe, mercado, moeda, etc
        """
        # Verifica se j√° existe ativo com mesmo ticker e mercado
        existing = Ativo.query.filter_by(
            ticker=data['ticker'].upper(),
            mercado=data['mercado'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"Ativo {data['ticker']} j√° existe no mercado {data['mercado']}")
        
        ativo = Ativo(
            ticker=data['ticker'].upper(),
            nome=data['nome'],
            tipo=TipoAtivo[data['tipo'].upper()],
            classe=ClasseAtivo[data['classe'].upper()],
            mercado=data['mercado'].upper(),
            moeda=data['moeda'].upper(),
            preco_atual=Decimal(str(data['preco_atual'])) if data.get('preco_atual') else None,
            dividend_yield=Decimal(str(data['dividend_yield'])) if data.get('dividend_yield') else None,
            pl=Decimal(str(data['pl'])) if data.get('pl') else None,
            pvp=Decimal(str(data['pvp'])) if data.get('pvp') else None,
            roe=Decimal(str(data['roe'])) if data.get('roe') else None,
            ativo=data.get('ativo', True),
            deslistado=data.get('deslistado', False)
        )
        
        db.session.add(ativo)
        db.session.commit()
        return ativo
    
    @staticmethod
    def update(ativo_id, data):
        """
        Atualiza ativo.
        
        Args:
            ativo_id: ID do ativo
            data: Dict com campos a atualizar
        """
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            ativo.nome = data['nome']
        
        if 'tipo' in data:
            ativo.tipo = TipoAtivo[data['tipo'].upper()]
        
        if 'classe' in data:
            ativo.classe = ClasseAtivo[data['classe'].upper()]
        
        if 'mercado' in data:
            ativo.mercado = data['mercado'].upper()
        
        if 'moeda' in data:
            ativo.moeda = data['moeda'].upper()
        
        if 'preco_atual' in data:
            ativo.preco_atual = Decimal(str(data['preco_atual'])) if data['preco_atual'] else None
        
        if 'dividend_yield' in data:
            ativo.dividend_yield = Decimal(str(data['dividend_yield'])) if data['dividend_yield'] else None
        
        if 'pl' in data:
            ativo.pl = Decimal(str(data['pl'])) if data['pl'] else None
        
        if 'pvp' in data:
            ativo.pvp = Decimal(str(data['pvp'])) if data['pvp'] else None
        
        if 'roe' in data:
            ativo.roe = Decimal(str(data['roe'])) if data['roe'] else None
        
        if 'ativo' in data:
            ativo.ativo = data['ativo']
        
        if 'deslistado' in data:
            ativo.deslistado = data['deslistado']
            if data['deslistado'] and 'data_deslistagem' in data:
                ativo.data_deslistagem = data['data_deslistagem']
        
        db.session.commit()
        return ativo
    
    @staticmethod
    def delete(ativo_id):
        """Deleta ativo"""
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(ativo)
        db.session.commit()
        return True
    
    @staticmethod
    def get_by_mercado(mercado, page=1, per_page=50):
        """Lista ativos de um mercado espec√≠fico"""
        return Ativo.query.filter_by(
            mercado=mercado.upper(),
            ativo=True,
            deslistado=False
        ).order_by(Ativo.ticker).paginate(page=page, per_page=per_page, error_out=False)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/auth_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario

class LoginSchema(Schema):
    """Schema para valida√ß√£o de login"""
    username = fields.Str(required=True, validate=lambda x: len(x) >= 3)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 6)

    @validates('username')
    def validate_username(self, value):
        if len(value) < 3:
            raise ValidationError("Username deve ter pelo menos 3 caracteres")

class TokenResponseSchema(Schema):
    """Schema para resposta de tokens"""
    access_token = fields.Str(dump_only=True)
    refresh_token = fields.Str(dump_only=True)
    token_type = fields.Str(dump_only=True)
    expires_in = fields.Int(dump_only=True)

class UserMeSchema(SQLAlchemyAutoSchema):
    """Schema para dados do usu√°rio logado (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)

    role = fields.Method("get_role_str")

    def get_role_str(self, obj):
        return obj.role.value if obj.role else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/auth_schema.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario

class LoginSchema(Schema):
    """Schema para valida√ß√£o de login"""
    username = fields.Str(required=True, validate=lambda x: len(x) >= 3)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 6)
    
    @validates('username')
    def validate_username(self, value):
        if len(value) < 3:
            raise ValidationError("Username deve ter pelo menos 3 caracteres")

class TokenResponseSchema(Schema):
    """Schema para resposta de tokens"""
    access_token = fields.Str(dump_only=True)
    refresh_token = fields.Str(dump_only=True)
    token_type = fields.Str(dump_only=True)
    expires_in = fields.Int(dump_only=True)

class UserMeSchema(SQLAlchemyAutoSchema):
    """Schema para dados do usu√°rio logado (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)
    
    role = fields.Str(attribute='role')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/corretora_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretora Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Corretora, TipoCorretora
from app.database import db

class CorretoraCreateSchema(Schema):
    """Schema para cria√ß√£o de corretora"""
    nome = fields.Str(required=True, validate=lambda x: 2 <= len(x) <= 100)
    tipo = fields.Str(required=True)
    pais = fields.Str(required=True, validate=lambda x: len(x) == 2)
    moeda_padrao = fields.Str(required=True, validate=lambda x: len(x) == 3)
    saldo_atual = fields.Decimal(required=False, as_string=True, default="0.00")
    ativa = fields.Bool(required=False, default=True)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['corretora', 'exchange']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('pais')
    def validate_pais(self, value):
        """Valida c√≥digo ISO do pa√≠s (2 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 2:
            raise ValidationError("Pa√≠s deve ser c√≥digo ISO 3166-1 alpha-2 (ex: BR, US)")
    
    @validates('moeda_padrao')
    def validate_moeda(self, value):
        """Valida c√≥digo ISO da moeda (3 letras mai√∫sculas)"""
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")

class CorretoraUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de corretora"""
    nome = fields.Str(required=False, validate=lambda x: 2 <= len(x) <= 100)
    tipo = fields.Str(required=False)
    pais = fields.Str(required=False, validate=lambda x: len(x) == 2)
    moeda_padrao = fields.Str(required=False, validate=lambda x: len(x) == 3)
    saldo_atual = fields.Decimal(required=False, as_string=True)
    ativa = fields.Bool(required=False)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        valid_tipos = ['corretora', 'exchange']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('pais')
    def validate_pais(self, value):
        if not value.isupper() or len(value) != 2:
            raise ValidationError("Pa√≠s deve ser c√≥digo ISO 3166-1 alpha-2 (ex: BR, US)")
    
    @validates('moeda_padrao')
    def validate_moeda(self, value):
        if not value.isupper() or len(value) != 3:
            raise ValidationError("Moeda deve ser c√≥digo ISO 4217 (ex: BRL, USD, EUR)")

class CorretoraResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de corretora"""
    class Meta:
        model = Corretora
        load_instance = False
        include_fk = True
    
    tipo = fields.Method("get_tipo_str")
    saldo_atual = fields.Decimal(as_string=True)
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/transacao_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacao Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, validates_schema
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Transacao, TipoTransacao
from datetime import datetime
from decimal import Decimal

class TransacaoCreateSchema(Schema):
    """Schema para cria√ß√£o de transa√ß√£o"""
    tipo = fields.Str(required=True)
    ativo_id = fields.UUID(required=True)
    corretora_id = fields.UUID(required=True)
    data_transacao = fields.DateTime(required=True)
    quantidade = fields.Decimal(required=True, as_string=True)
    preco_unitario = fields.Decimal(required=True, as_string=True)
    taxa_corretagem = fields.Decimal(required=False, as_string=True, load_default="0")
    taxa_liquidacao = fields.Decimal(required=False, as_string=True, load_default="0")
    emolumentos = fields.Decimal(required=False, as_string=True, load_default="0")
    imposto = fields.Decimal(required=False, as_string=True, load_default="0")
    outros_custos = fields.Decimal(required=False, as_string=True, load_default="0")
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('tipo')
    def validate_tipo(self, value):
        """Valida se tipo √© v√°lido"""
        valid_tipos = ['compra', 'venda', 'dividendo', 'jcp', 'bonificacao', 'desdobramento', 'grupamento']
        if value.lower() not in valid_tipos:
            raise ValidationError(f"Tipo inv√°lido. Op√ß√µes: {', '.join(valid_tipos)}")
    
    @validates('quantidade')
    def validate_quantidade(self, value):
        """Valida quantidade positiva"""
        if Decimal(str(value)) <= 0:
            raise ValidationError("Quantidade deve ser maior que zero")
    
    @validates('preco_unitario')
    def validate_preco(self, value):
        """Valida pre√ßo n√£o negativo"""
        if Decimal(str(value)) < 0:
            raise ValidationError("Pre√ßo unit√°rio n√£o pode ser negativo")
    
    @validates_schema
    def validate_compra_venda(self, data, **kwargs):
        """Valida√ß√µes espec√≠ficas por tipo"""
        tipo = data.get('tipo', '').lower()
        preco = Decimal(str(data.get('preco_unitario', 0)))
        
        # Compra/venda devem ter pre√ßo > 0
        if tipo in ['compra', 'venda'] and preco == 0:
            raise ValidationError(
                {"preco_unitario": "Compra/venda deve ter pre√ßo unit√°rio maior que zero"}
            )

class TransacaoUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de transa√ß√£o"""
    data_transacao = fields.DateTime(required=False)
    quantidade = fields.Decimal(required=False, as_string=True)
    preco_unitario = fields.Decimal(required=False, as_string=True)
    taxa_corretagem = fields.Decimal(required=False, as_string=True)
    taxa_liquidacao = fields.Decimal(required=False, as_string=True)
    emolumentos = fields.Decimal(required=False, as_string=True)
    imposto = fields.Decimal(required=False, as_string=True)
    outros_custos = fields.Decimal(required=False, as_string=True)
    observacoes = fields.Str(required=False, allow_none=True)
    
    @validates('quantidade')
    def validate_quantidade(self, value):
        if Decimal(str(value)) <= 0:
            raise ValidationError("Quantidade deve ser maior que zero")
    
    @validates('preco_unitario')
    def validate_preco(self, value):
        if Decimal(str(value)) < 0:
            raise ValidationError("Pre√ßo unit√°rio n√£o pode ser negativo")

class TransacaoResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de transa√ß√£o"""
    class Meta:
        model = Transacao
        load_instance = False
        include_fk = True
    
    tipo = fields.Method("get_tipo_str")
    quantidade = fields.Decimal(as_string=True)
    preco_unitario = fields.Decimal(as_string=True)
    valor_total = fields.Decimal(as_string=True)
    taxa_corretagem = fields.Decimal(as_string=True)
    taxa_liquidacao = fields.Decimal(as_string=True)
    emolumentos = fields.Decimal(as_string=True)
    imposto = fields.Decimal(as_string=True)
    outros_custos = fields.Decimal(as_string=True)
    custos_totais = fields.Decimal(as_string=True)
    valor_liquido = fields.Decimal(as_string=True)
    
    # Campos relacionados (nested)
    ativo = fields.Method("get_ativo_info")
    corretora = fields.Method("get_corretora_info")
    
    def get_tipo_str(self, obj):
        """Converte Enum para string"""
        return obj.tipo.value if obj.tipo else None
    
    def get_ativo_info(self, obj):
        """Retorna info b√°sica do ativo"""
        if obj.ativo:
            return {
                "id": str(obj.ativo.id),
                "ticker": obj.ativo.ticker,
                "nome": obj.ativo.nome,
                "tipo": obj.ativo.tipo.value,
                "mercado": obj.ativo.mercado
            }
        return None
    
    def get_corretora_info(self, obj):
        """Retorna info b√°sica da corretora"""
        if obj.corretora:
            return {
                "id": str(obj.corretora.id),
                "nome": obj.corretora.nome,
                "tipo": obj.corretora.tipo.value
            }
        return None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/schemas/usuario_schema.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuario Schemas - Valida√ß√£o Marshmallow"""

from marshmallow import Schema, fields, validates, ValidationError, post_load
from marshmallow_sqlalchemy import SQLAlchemyAutoSchema
from app.models import Usuario, UserRole
from app.database import db

class UsuarioCreateSchema(Schema):
    """Schema para cria√ß√£o de usu√°rio"""
    username = fields.Str(required=True, validate=lambda x: 3 <= len(x) <= 50)
    email = fields.Email(required=True)
    password = fields.Str(required=True, validate=lambda x: len(x) >= 8, load_only=True)
    nome_completo = fields.Str(required=False, allow_none=True)
    role = fields.Str(required=False, default='user')
    
    @validates('username')
    def validate_username(self, value):
        """Valida se username j√° existe"""
        if Usuario.query.filter_by(username=value).first():
            raise ValidationError("Username j√° existe")
    
    @validates('email')
    def validate_email(self, value):
        """Valida se email j√° existe"""
        if Usuario.query.filter_by(email=value).first():
            raise ValidationError("Email j√° existe")
    
    @validates('role')
    def validate_role(self, value):
        """Valida se role √© v√°lida"""
        valid_roles = ['admin', 'user', 'readonly']
        if value.lower() not in valid_roles:
            raise ValidationError(f"Role inv√°lida. Op√ß√µes: {', '.join(valid_roles)}")

class UsuarioUpdateSchema(Schema):
    """Schema para atualiza√ß√£o de usu√°rio"""
    email = fields.Email(required=False)
    nome_completo = fields.Str(required=False, allow_none=True)
    ativo = fields.Bool(required=False)
    role = fields.Str(required=False)
    
    @validates('email')
    def validate_email_unique(self, value):
        """Valida se email j√° existe (exceto o pr√≥prio)"""
        # Valida√ß√£o adicional ser√° feita no service
        pass
    
    @validates('role')
    def validate_role(self, value):
        """Valida se role √© v√°lida"""
        valid_roles = ['admin', 'user', 'readonly']
        if value.lower() not in valid_roles:
            raise ValidationError(f"Role inv√°lida. Op√ß√µes: {', '.join(valid_roles)}")

class ChangePasswordSchema(Schema):
    """Schema para troca de senha"""
    old_password = fields.Str(required=True, validate=lambda x: len(x) >= 6)
    new_password = fields.Str(required=True, validate=lambda x: len(x) >= 8)

class UsuarioResponseSchema(SQLAlchemyAutoSchema):
    """Schema para resposta de usu√°rio (sem senha)"""
    class Meta:
        model = Usuario
        load_instance = False
        exclude = ('password_hash',)
    
    role = fields.Method("get_role_str")
    
    def get_role_str(self, obj):
        """Converte Enum para string"""
        return obj.role.value if obj.role else None

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/run_all_seeds.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Executar Todos os Seeds
Script master para popular o banco com dados iniciais
"""

import sys
from app.seeds.seed_usuarios import seed_usuarios
from app.seeds.seed_ativos_br import seed_ativos_br
from app.seeds.seed_regras_fiscais_br import seed_regras_fiscais_br
from app.seeds.seed_feriados_b3 import seed_feriados_b3
from app.seeds.seed_fontes_dados import seed_fontes_dados


def run_all_seeds():
    """Executa todos os seeds em sequ√™ncia"""
    
    print("\n" + "=" * 60)
    print("  EXITUS - EXECUTAR TODOS OS SEEDS")
    print("=" * 60)
    print("\nEste script ir√° popular o banco com dados iniciais:")
    print("  1. Usu√°rios (4)")
    print("  2. Ativos BR (25)")
    print("  3. Regras Fiscais BR (6)")
    print("  4. Feriados B3 2025-2026 (30)")
    print("  5. Fontes de Dados (7)")
    print("\n‚ö† ATEN√á√ÉO: Seeds existentes ser√£o solicitados para confirma√ß√£o.\n")
    
    resposta = input("Deseja continuar? (s/N): ").lower()
    if resposta != 's':
        print("\n‚úó Opera√ß√£o cancelada pelo usu√°rio.\n")
        return
    
    seeds = [
        ("Usu√°rios", seed_usuarios),
        ("Ativos BR", seed_ativos_br),
        ("Regras Fiscais BR", seed_regras_fiscais_br),
        ("Feriados B3", seed_feriados_b3),
        ("Fontes de Dados", seed_fontes_dados),
    ]
    
    sucessos = 0
    erros = 0
    
    for nome, seed_func in seeds:
        print("\n" + "=" * 60)
        try:
            seed_func()
            sucessos += 1
        except KeyboardInterrupt:
            print(f"\n\n‚ö† Seed '{nome}' interrompido pelo usu√°rio.")
            print("Processo de seeds cancelado.\n")
            sys.exit(1)
        except Exception as e:
            print(f"\n‚úó Erro ao executar seed '{nome}': {e}")
            erros += 1
            resposta = input("\nDeseja continuar com os pr√≥ximos seeds? (s/N): ").lower()
            if resposta != 's':
                break
    
    # Resumo final
    print("\n" + "=" * 60)
    print("  RESUMO FINAL")
    print("=" * 60)
    print(f"‚úì Seeds executados com sucesso: {sucessos}")
    if erros > 0:
        print(f"‚úó Seeds com erro: {erros}")
    print("=" * 60 + "\n")
    
    if erros == 0:
        print("üéâ Todos os seeds foram executados com sucesso!")
        print("O banco de dados est√° pronto para uso.\n")
    else:
        print("‚ö† Alguns seeds falharam. Verifique os erros acima.\n")


if __name__ == '__main__':
    run_all_seeds()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_ativos_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Ativos Brasileiros
Popular tabela ativo com a√ß√µes e FIIs da B3
"""

from app import create_app
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal


def seed_ativos_br():
    """Cria ativos brasileiros (B3)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Ativos Brasileiros (B3)")
        print("=" * 50)
        
        # Verificar se j√° existem ativos
        count = Ativo.query.filter_by(mercado='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} ativos brasileiros cadastrados.")
            resposta = input("Deseja recriar os ativos BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar ativos BR existentes
            Ativo.query.filter_by(mercado='BR').delete()
            db.session.commit()
            print("‚úì Ativos brasileiros anteriores removidos.")
        
        # A√ß√µes mais negociadas da B3
        acoes = [
            # Ticker, Nome, Setor, Pre√ßo Inicial
            ('PETR4', 'Petrobras PN', 'Petr√≥leo e G√°s', Decimal('38.50')),
            ('VALE3', 'Vale ON', 'Minera√ß√£o', Decimal('62.80')),
            ('ITUB4', 'Ita√∫ Unibanco PN', 'Bancos', Decimal('28.45')),
            ('BBDC4', 'Bradesco PN', 'Bancos', Decimal('13.20')),
            ('BBAS3', 'Banco do Brasil ON', 'Bancos', Decimal('25.60')),
            ('MGLU3', 'Magazine Luiza ON', 'Varejo', Decimal('8.75')),
            ('WEGE3', 'WEG ON', 'M√°quinas e Equipamentos', Decimal('42.30')),
            ('RENT3', 'Localiza ON', 'Loca√ß√£o de Ve√≠culos', Decimal('56.90')),
            ('RAIL3', 'Rumo ON', 'Transporte', Decimal('18.45')),
            ('SUZB3', 'Suzano ON', 'Papel e Celulose', Decimal('52.80')),
            ('KLBN11', 'Klabin Units', 'Papel e Celulose', Decimal('22.15')),
            ('ELET3', 'Eletrobras ON', 'Energia El√©trica', Decimal('42.10')),
            ('CMIG4', 'Cemig PN', 'Energia El√©trica', Decimal('10.85')),
            ('CPLE6', 'Copel PNB', 'Energia El√©trica', Decimal('8.95')),
            ('ABEV3', 'Ambev ON', 'Bebidas', Decimal('11.20')),
        ]
        
        # FIIs mais negociados
        fiis = [
            # Ticker, Nome, Segmento, Pre√ßo Inicial
            ('HGLG11', 'CSHG Log√≠stica FII', 'Log√≠stica', Decimal('152.30')),
            ('VISC11', 'Vinci Shopping Centers FII', 'Shopping', Decimal('105.80')),
            ('KNRI11', 'Kinea Renda Imobili√°ria FII', 'H√≠brido', Decimal('98.45')),
            ('BTLG11', 'BTG Pactual Log√≠stica FII', 'Log√≠stica', Decimal('102.70')),
            ('XPML11', 'XP Malls FII', 'Shopping', Decimal('95.60')),
            ('MXRF11', 'Maxi Renda FII', 'H√≠brido', Decimal('10.25')),
            ('TRXF11', 'TRX Real Estate FII', 'Lajes Corporativas', Decimal('95.30')),
            ('KNCR11', 'Kinea Rendimentos Imobili√°rios FII', 'Papel', Decimal('110.50')),
            ('LVBI11', 'VBI Log√≠stico FII', 'Log√≠stica', Decimal('98.20')),
            ('GGRC11', 'GGR Covepi Renda FII', 'Lajes Corporativas', Decimal('105.40')),
        ]
        
        created_ativos = []
        
        # Criar a√ß√µes
        print("\nüìà Criando A√ß√µes...")
        for ticker, nome, setor, preco in acoes:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.ACAO,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Setor: {setor}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:35} - R$ {preco}")
        
        # Criar FIIs
        print("\nüè¢ Criando FIIs...")
        for ticker, nome, segmento, preco in fiis:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.FII,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Segmento: {segmento}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:40} - R$ {preco}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_ativos)} ativos criados com sucesso!")
            print(f"  - {len(acoes)} a√ß√µes")
            print(f"  - {len(fiis)} FIIs")
            print("=" * 50 + "\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar ativos: {e}")
            raise


if __name__ == '__main__':
    seed_ativos_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_feriados_b3.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Feriados B3
Popular tabela feriado_mercado com feriados da B3
"""

from app import create_app
from app.database import db
from app.models import FeriadoMercado, TipoFeriado
from datetime import date


def seed_feriados_b3():
    """Cria feriados da B3 para 2025 e 2026"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Feriados B3 (2025-2026)")
        print("=" * 50)
        
        # Verificar se j√° existem feriados B3
        count = FeriadoMercado.query.filter_by(pais='BR', mercado='B3').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} feriados B3 cadastrados.")
            resposta = input("Deseja recriar os feriados? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar feriados B3 existentes
            FeriadoMercado.query.filter_by(pais='BR', mercado='B3').delete()
            db.session.commit()
            print("‚úì Feriados B3 anteriores removidos.")
        
        # Feriados B3 2025
        feriados_2025 = [
            (date(2025, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2025, 3, 3), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2025, 3, 4), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2025, 4, 18), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2025, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2025, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2025, 6, 19), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2025, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2025, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2025, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        # Feriados B3 2026
        feriados_2026 = [
            (date(2026, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2026, 2, 16), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2026, 2, 17), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2026, 4, 3), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2026, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2026, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2026, 6, 4), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2026, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2026, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2026, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        todos_feriados = feriados_2025 + feriados_2026
        created_feriados = []
        
        print("\nüìÖ Criando Feriados 2025...")
        for data_feriado, nome, tipo, recorrente in feriados_2025:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        print("\nüìÖ Criando Feriados 2026...")
        for data_feriado, nome, tipo, recorrente in feriados_2026:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_feriados)} feriados criados!")
            print(f"  - 2025: {len(feriados_2025)} feriados")
            print(f"  - 2026: {len(feriados_2026)} feriados")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  üö´ = Fechamento total (sem preg√£o)")
            print("  ‚è∞ = Fechamento antecipado (meio per√≠odo)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar feriados: {e}")
            raise


if __name__ == '__main__':
    seed_feriados_b3()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_fontes_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Fontes de Dados
Popular tabela fonte_dados com APIs de cota√ß√µes
"""

from app import create_app
from app.database import db
from app.models import FonteDados, TipoFonteDados


def seed_fontes_dados():
    """Cria fontes de dados (APIs)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Fontes de Dados (APIs)")
        print("=" * 50)
        
        # Verificar se j√° existem fontes
        count = FonteDados.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} fontes de dados cadastradas.")
            resposta = input("Deseja recriar as fontes? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar fontes existentes
            FonteDados.query.delete()
            db.session.commit()
            print("‚úì Fontes de dados anteriores removidas.")
        
        # Fontes de dados
        fontes = [
            {
                'nome': 'yfinance',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://query1.finance.yahoo.com',
                'requer_autenticacao': False,
                'rate_limit': '2000/hour',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'Biblioteca Python gratuita para Yahoo Finance. Boa cobertura global, incluindo B3.'
            },
            {
                'nome': 'brapi.dev',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://brapi.dev/api',
                'requer_autenticacao': False,
                'rate_limit': '100/minute',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'API brasileira gratuita especializada em ativos da B3. Dados em tempo real.'
            },
            {
                'nome': 'Alpha Vantage',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://www.alphavantage.co/query',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API gratuita com chave. Limite de 5 requisi√ß√µes por minuto (plano free).'
            },
            {
                'nome': 'Finnhub',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://finnhub.io/api/v1',
                'requer_autenticacao': True,
                'rate_limit': '60/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API com plano gratuito. Boa cobertura de mercados globais e not√≠cias.'
            },
            {
                'nome': 'IEX Cloud',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://cloud.iexapis.com/stable',
                'requer_autenticacao': True,
                'rate_limit': '50000/month',
                'ativa': True,
                'prioridade': 3,
                'observacoes': 'API focada em mercado americano. Plano gratuito com limite mensal.'
            },
            {
                'nome': 'Polygon.io',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://api.polygon.io',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': False,
                'prioridade': 4,
                'observacoes': 'API premium com dados hist√≥ricos detalhados. Desativada por padr√£o.'
            },
            {
                'nome': 'Manual',
                'tipo_fonte': TipoFonteDados.MANUAL,
                'url_base': None,
                'requer_autenticacao': False,
                'rate_limit': None,
                'ativa': True,
                'prioridade': 99,
                'observacoes': 'Entrada manual de dados pelo usu√°rio.'
            },
        ]
        
        created_fontes = []
        
        print("\nüîå Criando Fontes de Dados...")
        for fonte_data in fontes:
            fonte = FonteDados(
                nome=fonte_data['nome'],
                tipo_fonte=fonte_data['tipo_fonte'],
                url_base=fonte_data['url_base'],
                requer_autenticacao=fonte_data['requer_autenticacao'],
                rate_limit=fonte_data['rate_limit'],
                ativa=fonte_data['ativa'],
                prioridade=fonte_data['prioridade'],
                observacoes=fonte_data['observacoes']
            )
            db.session.add(fonte)
            created_fontes.append(fonte)
            
            status_icon = "‚úì" if fonte.ativa else "‚úó"
            auth_icon = "üîê" if fonte.requer_autenticacao else "üîì"
            
            print(f"  {status_icon} {auth_icon} {fonte.nome:20} | Prioridade: {fonte.prioridade} | Limite: {fonte.rate_limit or 'N/A'}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_fontes)} fontes de dados criadas!")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  ‚úì = Ativa    | ‚úó = Inativa")
            print("  üîì = Sem auth | üîê = Requer chave API")
            print("\nüí° PRIORIDADE:")
            print("  1 = Alta (usar primeiro)")
            print("  2-3 = M√©dia (fallback)")
            print("  99 = Baixa (manual)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar fontes: {e}")
            raise


if __name__ == '__main__':
    seed_fontes_dados()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_modulo2.py ---
# -*- coding: utf-8 -*-
"""Exitus - Seed M√≥dulo 2 - Usu√°rios, Corretoras e Ativos"""

from app.database import db
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal

def seed_usuarios():
    """Seed de usu√°rios"""
    print("\nüîê Seeding Usu√°rios...")
    
    usuarios = [
        {
            "username": "admin",
            "email": "admin@exitus.com",
            "nome_completo": "Administrador do Sistema",
            "password": "admin123",
            "role": UserRole.ADMIN
        },
        {
            "username": "joao.silva",
            "email": "joao.silva@email.com",
            "nome_completo": "Jo√£o Silva",
            "password": "user123",
            "role": UserRole.USER
        },
        {
            "username": "maria.santos",
            "email": "maria.santos@email.com",
            "nome_completo": "Maria Santos",
            "password": "user123",
            "role": UserRole.USER
        }
    ]
    
    for data in usuarios:
        existing = Usuario.query.filter_by(username=data['username']).first()
        if not existing:
            user = Usuario(
                username=data['username'],
                email=data['email'],
                nome_completo=data['nome_completo'],
                role=data['role'],
                ativo=True
            )
            user.set_password(data['password'])
            db.session.add(user)
            print(f"  ‚úÖ Criado: {data['username']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['username']}")
    
    db.session.commit()
    print("‚úÖ Usu√°rios criados!")

def seed_corretoras():
    """Seed de corretoras para usu√°rio joao.silva"""
    print("\nüè¶ Seeding Corretoras...")
    
    user = Usuario.query.filter_by(username='joao.silva').first()
    if not user:
        print("‚ùå Usu√°rio joao.silva n√£o encontrado")
        return
    
    corretoras = [
        {
            "nome": "XP Investimentos",
            "tipo": TipoCorretora.CORRETORA,
            "pais": "BR",
            "moeda_padrao": "BRL"
        },
        {
            "nome": "Clear Corretora",
            "tipo": TipoCorretora.CORRETORA,
            "pais": "BR",
            "moeda_padrao": "BRL"
        }
    ]
    
    for data in corretoras:
        existing = Corretora.query.filter_by(
            usuario_id=user.id,
            nome=data['nome']
        ).first()
        
        if not existing:
            corretora = Corretora(
                usuario_id=user.id,
                nome=data['nome'],
                tipo=data['tipo'],
                pais=data['pais'],
                moeda_padrao=data['moeda_padrao'],
                saldo_atual=Decimal('0.00'),
                ativa=True
            )
            db.session.add(corretora)
            print(f"  ‚úÖ Criado: {data['nome']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['nome']}")
    
    db.session.commit()
    print("‚úÖ Corretoras criadas!")

def seed_ativos():
    """Seed de ativos - MANT√âM OS 25 ATIVOS ORIGINAIS"""
    print("\nüìà Seeding Ativos...")
    
    ativos_br = [
        # A√ß√µes BR
        {"ticker": "PETR4", "nome": "Petrobras PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "38.50", "observacoes": "Setor: Petr√≥leo e G√°s"},
        {"ticker": "VALE3", "nome": "Vale ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "62.80", "observacoes": "Setor: Minera√ß√£o"},
        {"ticker": "ITUB4", "nome": "Ita√∫ Unibanco PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "28.45", "observacoes": "Setor: Bancos"},
        {"ticker": "BBDC4", "nome": "Bradesco PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "13.20", "observacoes": "Setor: Bancos"},
        {"ticker": "BBAS3", "nome": "Banco do Brasil ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "25.60", "observacoes": "Setor: Bancos"},
        {"ticker": "MGLU3", "nome": "Magazine Luiza ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "8.75", "observacoes": "Setor: Varejo"},
        {"ticker": "WEGE3", "nome": "WEG ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "42.30", "observacoes": "Setor: M√°quinas e Equipamentos"},
        {"ticker": "RENT3", "nome": "Localiza ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "56.90", "observacoes": "Setor: Loca√ß√£o de Ve√≠culos"},
        {"ticker": "RAIL3", "nome": "Rumo ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "18.45", "observacoes": "Setor: Transporte"},
        {"ticker": "SUZB3", "nome": "Suzano ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "52.80", "observacoes": "Setor: Papel e Celulose"},
        {"ticker": "KLBN11", "nome": "Klabin Units", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "22.15", "observacoes": "Setor: Papel e Celulose"},
        {"ticker": "ELET3", "nome": "Eletrobras ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "42.10", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "CMIG4", "nome": "Cemig PN", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "10.85", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "CPLE6", "nome": "Copel PNB", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "8.95", "observacoes": "Setor: Energia El√©trica"},
        {"ticker": "ABEV3", "nome": "Ambev ON", "tipo": TipoAtivo.ACAO, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "11.20", "observacoes": "Setor: Bebidas"},
        
        # FIIs BR
        {"ticker": "HGLG11", "nome": "CSHG Log√≠stica FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "152.30", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "KNRI11", "nome": "Kinea Renda Imobili√°ria FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "98.45", "observacoes": "Segmento: H√≠brido"},
        {"ticker": "BTLG11", "nome": "BTG Pactual Log√≠stica FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "102.70", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "MXRF11", "nome": "Maxi Renda FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "10.25", "observacoes": "Segmento: H√≠brido"},
        {"ticker": "KNCR11", "nome": "Kinea Rendimentos Imobili√°rios FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "110.50", "observacoes": "Segmento: Papel"},
        {"ticker": "LVBI11", "nome": "VBI Log√≠stico FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "98.20", "observacoes": "Segmento: Log√≠stica"},
        {"ticker": "GGRC11", "nome": "GGR Covepi Renda FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "105.40", "observacoes": "Segmento: Lajes Corporativas"},
        {"ticker": "XPML11", "nome": "XP Malls FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "9.85", "observacoes": "Segmento: Shoppings"},
        {"ticker": "VISC11", "nome": "Vinci Shopping Centers FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "7.90", "observacoes": "Segmento: Shoppings"},
        {"ticker": "TRXF11", "nome": "TRX Real Estate FII", "tipo": TipoAtivo.FII, "classe": ClasseAtivo.RENDA_VARIAVEL, "mercado": "BR", "moeda": "BRL", "preco_atual": "92.30", "observacoes": "Segmento: Lajes Corporativas"},
    ]
    
    for data in ativos_br:
        existing = Ativo.query.filter_by(ticker=data['ticker'], mercado=data['mercado']).first()
        if not existing:
            ativo = Ativo(
                ticker=data['ticker'],
                nome=data['nome'],
                tipo=data['tipo'],
                classe=data['classe'],
                mercado=data['mercado'],
                moeda=data['moeda'],
                preco_atual=Decimal(data['preco_atual']) if data.get('preco_atual') else None,
                observacoes=data.get('observacoes'),
                ativo=True,
                deslistado=False
            )
            db.session.add(ativo)
            print(f"  ‚úÖ Criado: {data['ticker']}")
        else:
            print(f"  ‚ÑπÔ∏è  J√° existe: {data['ticker']}")
    
    db.session.commit()
    print("‚úÖ Ativos criados!")

def run_seed_modulo2():
    """Executa todos os seeds do M√≥dulo 2"""
    print("=" * 60)
    print("üå± SEED M√ìDULO 2 - Usu√°rios, Corretoras, Ativos")
    print("=" * 60)
    
    seed_usuarios()
    seed_corretoras()
    seed_ativos()
    
    print("\n" + "=" * 60)
    print("‚úÖ SEED M√ìDULO 2 CONCLU√çDO!")
    print("=" * 60)

if __name__ == "__main__":
    from app import create_app
    app = create_app()
    with app.app_context():
        run_seed_modulo2()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_regras_fiscais_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Regras Fiscais Brasileiras
Popular tabela regra_fiscal com regras de IR do Brasil
"""

from app import create_app
from app.database import db
from app.models import RegraFiscal, IncidenciaImposto
from decimal import Decimal
from datetime import date


def seed_regras_fiscais_br():
    """Cria regras fiscais brasileiras"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Regras Fiscais Brasileiras")
        print("=" * 50)
        
        # Verificar se j√° existem regras BR
        count = RegraFiscal.query.filter_by(pais='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} regras fiscais brasileiras.")
            resposta = input("Deseja recriar as regras BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar regras BR existentes
            RegraFiscal.query.filter_by(pais='BR').delete()
            db.session.commit()
            print("‚úì Regras fiscais brasileiras anteriores removidas.")
        
        # Regras fiscais brasileiras
        regras = [
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': Decimal('20000.00'),
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em a√ß√µes - Swing Trade. Isen√ß√£o para vendas at√© R$ 20.000,00 por m√™s.'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'DAY_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em Day Trade. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em FIIs. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': None,  # Aplica a todos
                'tipo_operacao': None,
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'IR sobre JCP (Juros sobre Capital Pr√≥prio). Retido na fonte, al√≠quota de 15%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Rendimentos de FII s√£o ISENTOS de IR para pessoa f√≠sica (requisitos: FII com +50 cotistas, cotas negociadas em bolsa, investidor com <10% das cotas).'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Dividendos de a√ß√µes s√£o ISENTOS de IR para pessoa f√≠sica no Brasil.'
            },
        ]
        
        created_regras = []
        
        print("\nüìã Criando Regras...")
        for regra_data in regras:
            regra = RegraFiscal(
                pais='BR',
                tipo_ativo=regra_data['tipo_ativo'],
                tipo_operacao=regra_data['tipo_operacao'],
                aliquota_ir=regra_data['aliquota_ir'],
                valor_isencao=regra_data['valor_isencao'],
                incide_sobre=regra_data['incide_sobre'],
                descricao=regra_data['descricao'],
                vigencia_inicio=date(2024, 1, 1),
                ativa=True
            )
            db.session.add(regra)
            created_regras.append(regra)
            
            tipo_str = regra_data['tipo_ativo'] or 'TODOS'
            op_str = regra_data['tipo_operacao'] or 'TODAS'
            isencao_str = f"R$ {regra_data['valor_isencao']}" if regra_data['valor_isencao'] else "SEM"
            
            print(f"  ‚úì {tipo_str:10} | {op_str:12} | IR: {regra_data['aliquota_ir']:6}% | Isen√ß√£o: {isencao_str}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_regras)} regras fiscais criadas!")
            print("=" * 50)
            print("\nüìå RESUMO DAS REGRAS:")
            print("-" * 50)
            print("‚Ä¢ A√ß√µes Swing Trade: 15% IR (isen√ß√£o at√© R$ 20k/m√™s)")
            print("‚Ä¢ A√ß√µes Day Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ FII Swing Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ Dividendos de A√ß√µes: ISENTO")
            print("‚Ä¢ Rendimentos de FII: ISENTO*")
            print("‚Ä¢ JCP: 15% IR retido na fonte")
            print("-" * 50)
            print("* Requisitos para isen√ß√£o de FII aplicam-se\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar regras fiscais: {e}")
            raise


if __name__ == '__main__':
    seed_regras_fiscais_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_usuarios.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Usu√°rios
Popular tabela usuario com dados iniciais
"""
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))


from app import create_app
from app.database import db
from app.models import Usuario, UserRole
from datetime import datetime


def seed_usuarios():
    """Cria usu√°rios iniciais do sistema"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Usu√°rios Iniciais")
        print("=" * 50)
        
        # Verificar se j√° existem usu√°rios
        count = Usuario.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} usu√°rios cadastrados.")
            resposta = input("Deseja recriar os usu√°rios? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar usu√°rios existentes
            Usuario.query.delete()
            db.session.commit()
            print("‚úì Usu√°rios anteriores removidos.")
        
        # Lista de usu√°rios a criar
        usuarios = [
            {
                'username': 'admin',
                'email': 'admin@exitus.com',
                'password': 'admin123',  # Senha padr√£o para desenvolvimento
                'nome_completo': 'Administrador do Sistema',
                'role': UserRole.ADMIN,
                'ativo': True
            },
            {
                'username': 'joao.silva',
                'email': 'joao.silva@example.com',
                'password': 'user123',
                'nome_completo': 'Jo√£o Silva',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'maria.santos',
                'email': 'maria.santos@example.com',
                'password': 'user123',
                'nome_completo': 'Maria Santos',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'viewer',
                'email': 'viewer@exitus.com',
                'password': 'viewer123',
                'nome_completo': 'Usu√°rio Visualizador',
                'role': UserRole.READONLY,
                'ativo': True
            }
        ]
        
        # Criar usu√°rios
        created_users = []
        for user_data in usuarios:
            user = Usuario(
                username=user_data['username'],
                email=user_data['email'],
                nome_completo=user_data.get('nome_completo'),
                role=user_data['role'],
                ativo=user_data['ativo']
            )
            user.set_password(user_data['password'])
            
            db.session.add(user)
            created_users.append(user)
            
            print(f"‚úì Usu√°rio criado: {user.username} ({user.role.value}) - {user.email}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_users)} usu√°rios criados com sucesso!")
            print("=" * 50)
            
            # Exibir credenciais
            print("\nüìã CREDENCIAIS DE ACESSO:")
            print("-" * 50)
            for user_data in usuarios:
                print(f"Username: {user_data['username']:<15} | Senha: {user_data['password']}")
            print("-" * 50)
            print("‚ö† ATEN√á√ÉO: Altere as senhas em produ√ß√£o!\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar usu√°rios: {e}")
            raise


if __name__ == '__main__':
    seed_usuarios()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/ativo_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Ativo Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import date
from sqlalchemy import or_
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo

class AtivoService:
    """Servi√ßo para opera√ß√µes de ativos"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, tipo=None, classe=None, mercado=None, 
                deslistado=None, search=None):
        """
        Lista ativos com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            tipo: Filtro por tipo (ACAO, FII, etc)
            classe: Filtro por classe (RENDA_VARIAVEL, etc)
            mercado: Filtro por mercado (BR, US, etc)
            deslistado: Filtro por deslistados
            search: Busca em ticker e nome
        """
        query = Ativo.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if tipo:
            query = query.filter_by(tipo=TipoAtivo[tipo.upper()])
        
        if classe:
            query = query.filter_by(classe=ClasseAtivo[classe.upper()])
        
        if mercado:
            query = query.filter_by(mercado=mercado.upper())
        
        if deslistado is not None:
            query = query.filter_by(deslistado=deslistado)
        
        if search:
            query = query.filter(
                or_(
                    Ativo.ticker.ilike(f'%{search}%'),
                    Ativo.nome.ilike(f'%{search}%')
                )
            )
        
        # Ordenar por ticker
        query = query.order_by(Ativo.ticker)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(ativo_id):
        """Busca ativo por ID"""
        return Ativo.query.get(ativo_id)
    
    @staticmethod
    def get_by_ticker(ticker, mercado):
        """Busca ativo por ticker e mercado"""
        return Ativo.query.filter_by(
            ticker=ticker.upper(),
            mercado=mercado.upper()
        ).first()
    
    @staticmethod
    def create(data):
        """
        Cria novo ativo.
        
        Args:
            data: Dict com ticker, nome, tipo, classe, mercado, moeda, etc
        """
        # Verifica se j√° existe ativo com mesmo ticker e mercado
        existing = Ativo.query.filter_by(
            ticker=data['ticker'].upper(),
            mercado=data['mercado'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"Ativo {data['ticker']} j√° existe no mercado {data['mercado']}")
        
        # ‚ö†Ô∏è CORRE√á√ÉO: Usar p_l, p_vp (nomes das colunas no DB)
        ativo = Ativo(
            ticker=data['ticker'].upper(),
            nome=data['nome'],
            tipo=TipoAtivo[data['tipo'].upper()],
            classe=ClasseAtivo[data['classe'].upper()],
            mercado=data['mercado'].upper(),
            moeda=data['moeda'].upper(),
            preco_atual=Decimal(str(data['preco_atual'])) if data.get('preco_atual') else None,
            dividend_yield=Decimal(str(data['dividend_yield'])) if data.get('dividend_yield') else None,
            p_l=Decimal(str(data['pl'])) if data.get('pl') else None,  # ‚¨ÖÔ∏è CORRIGIDO
            p_vp=Decimal(str(data['pvp'])) if data.get('pvp') else None,  # ‚¨ÖÔ∏è CORRIGIDO
            roe=Decimal(str(data['roe'])) if data.get('roe') else None,
            ativo=data.get('ativo', True),
            deslistado=data.get('deslistado', False)
        )
        
        db.session.add(ativo)
        db.session.commit()
        return ativo
    
    @staticmethod
    def update(ativo_id, data):
        """
        Atualiza ativo.
        
        Args:
            ativo_id: ID do ativo
            data: Dict com campos a atualizar
        """
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            ativo.nome = data['nome']
        
        if 'tipo' in data:
            ativo.tipo = TipoAtivo[data['tipo'].upper()]
        
        if 'classe' in data:
            ativo.classe = ClasseAtivo[data['classe'].upper()]
        
        if 'mercado' in data:
            ativo.mercado = data['mercado'].upper()
        
        if 'moeda' in data:
            ativo.moeda = data['moeda'].upper()
        
        if 'preco_atual' in data:
            ativo.preco_atual = Decimal(str(data['preco_atual'])) if data['preco_atual'] else None
        
        if 'dividend_yield' in data:
            ativo.dividend_yield = Decimal(str(data['dividend_yield'])) if data['dividend_yield'] else None
        
        # ‚ö†Ô∏è CORRE√á√ÉO: Usar p_l, p_vp
        if 'pl' in data:
            ativo.p_l = Decimal(str(data['pl'])) if data['pl'] else None  # ‚¨ÖÔ∏è CORRIGIDO
        
        if 'pvp' in data:
            ativo.p_vp = Decimal(str(data['pvp'])) if data['pvp'] else None  # ‚¨ÖÔ∏è CORRIGIDO
        
        if 'roe' in data:
            ativo.roe = Decimal(str(data['roe'])) if data['roe'] else None
        
        if 'ativo' in data:
            ativo.ativo = data['ativo']
        
        if 'deslistado' in data:
            ativo.deslistado = data['deslistado']
            if data['deslistado'] and 'data_deslistagem' in data:
                ativo.data_deslistagem = data['data_deslistagem']
        
        db.session.commit()
        return ativo
    
    @staticmethod
    def delete(ativo_id):
        """Deleta ativo"""
        ativo = Ativo.query.get(ativo_id)
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(ativo)
        db.session.commit()
        return True
    
    @staticmethod
    def get_by_mercado(mercado, page=1, per_page=50):
        """Lista ativos de um mercado espec√≠fico"""
        return Ativo.query.filter_by(
            mercado=mercado.upper(),
            ativo=True,
            deslistado=False
        ).order_by(Ativo.ticker).paginate(page=page, per_page=per_page, error_out=False)

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/auth_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Service - L√≥gica de autentica√ß√£o JWT"""

from datetime import timedelta
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import check_password_hash
from app.database import db
from app.models import Usuario

class AuthService:
    """Servi√ßo respons√°vel por autentica√ß√£o e gera√ß√£o de tokens JWT"""
    
    @staticmethod
    def login(username: str, password: str):
        """
        Valida credenciais e gera tokens JWT.
        
        Returns:
            dict: Tokens de acesso e refresh
        Raises:
            ValueError: Credenciais inv√°lidas
        """
        user = Usuario.query.filter_by(username=username).first()
        if not user or not check_password_hash(user.password_hash, password):
            raise ValueError("Credenciais inv√°lidas")
        
        if not user.ativo:
            raise ValueError("Usu√°rio inativo")
        
        # ‚úÖ CORRE√á√ÉO: .value converte Enum UserRole para string
        additional_claims = {"role": user.role.value}
        
        access_token = create_access_token(
            identity=str(user.id), 
            additional_claims=additional_claims, 
            expires_delta=timedelta(hours=1)
        )
        refresh_token = create_refresh_token(
            identity=str(user.id), 
            expires_delta=timedelta(days=30)
        )
        
        # Atualizar √∫ltimo login
        user.ultimo_login = db.func.now()
        db.session.commit()
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
    
    @staticmethod
    def refresh(identity: str):
        """Gera novo access_token a partir do refresh_token."""
        user = Usuario.query.get(identity)
        additional_claims = {"role": user.role.value} if user else {}
        
        access_token = create_access_token(
            identity=identity, 
            additional_claims=additional_claims,
            expires_delta=timedelta(hours=1)
        )
        return {
            "access_token": access_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/auth_service.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus - Auth Service - L√≥gica de autentica√ß√£o JWT"""

from datetime import timedelta
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import check_password_hash
from app.database import db
from app.models import Usuario

class AuthService:
    """Servi√ßo respons√°vel por autentica√ß√£o e gera√ß√£o de tokens JWT"""
    
    @staticmethod
    def login(username: str, password: str):
        """
        Valida credenciais e gera tokens JWT.
        
        Returns:
            dict: Tokens de acesso e refresh
        Raises:
            ValueError: Credenciais inv√°lidas
        """
        user = Usuario.query.filter_by(username=username).first()
        if not user or not check_password_hash(user.password_hash, password):
            raise ValueError("Credenciais inv√°lidas")
        
        if not user.ativo:
            raise ValueError("Usu√°rio inativo")
        
        # Claims adicionais para autoriza√ß√£o
        additional_claims = {"role": user.role}
        access_token = create_access_token(
            identity=str(user.id), 
            additional_claims=additional_claims, 
            expires_delta=timedelta(hours=1)
        )
        refresh_token = create_refresh_token(
            identity=str(user.id), 
            expires_delta=timedelta(days=30)
        )
        
        # Atualizar √∫ltimo login
        user.ultimo_login = db.func.now()
        db.session.commit()
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
    
    @staticmethod
    def refresh(identity: str):
        """Gera novo access_token a partir do refresh_token."""
        access_token = create_access_token(
            identity=identity, 
            expires_delta=timedelta(hours=1)
        )
        return {
            "access_token": access_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/corretora_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Corretora Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from sqlalchemy import or_
from app.database import db
from app.models import Corretora, TipoCorretora

class CorretoraService:
    """Servi√ßo para opera√ß√µes de corretoras"""
    
    @staticmethod
    def get_all(usuario_id, page=1, per_page=20, ativa=None, tipo=None, pais=None, search=None):
        """
        Lista corretoras do usu√°rio com pagina√ß√£o e filtros.
        
        Args:
            usuario_id: ID do usu√°rio propriet√°rio
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativa: Filtro por status ativo
            tipo: Filtro por tipo (CORRETORA, EXCHANGE)
            pais: Filtro por pa√≠s (BR, US, etc)
            search: Busca em nome
        """
        query = Corretora.query.filter_by(usuario_id=usuario_id)
        
        # Filtros
        if ativa is not None:
            query = query.filter_by(ativa=ativa)
        
        if tipo:
            query = query.filter_by(tipo=TipoCorretora[tipo.upper()])
        
        if pais:
            query = query.filter_by(pais=pais.upper())
        
        if search:
            query = query.filter(Corretora.nome.ilike(f'%{search}%'))
        
        # Ordenar por nome
        query = query.order_by(Corretora.nome)
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(corretora_id, usuario_id):
        """Busca corretora por ID (valida propriedade)"""
        return Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
    
    @staticmethod
    def create(data, usuario_id):
        """
        Cria nova corretora.
        
        Args:
            data: Dict com nome, tipo, pais, moeda_padrao, etc
            usuario_id: ID do usu√°rio propriet√°rio
        """
        # Verifica se j√° existe corretora com mesmo nome, pa√≠s e usu√°rio
        existing = Corretora.query.filter_by(
            usuario_id=usuario_id,
            nome=data['nome'],
            pais=data['pais'].upper()
        ).first()
        
        if existing:
            raise ValueError(f"J√° existe uma corretora '{data['nome']}' em {data['pais']}")
        
        corretora = Corretora(
            usuario_id=usuario_id,
            nome=data['nome'],
            tipo=TipoCorretora[data['tipo'].upper()],
            pais=data['pais'].upper(),
            moeda_padrao=data['moeda_padrao'].upper(),
            saldo_atual=Decimal(data.get('saldo_atual', '0.00')),
            ativa=data.get('ativa', True),
            observacoes=data.get('observacoes')
        )
        
        db.session.add(corretora)
        db.session.commit()
        return corretora
    
    @staticmethod
    def update(corretora_id, data, usuario_id):
        """
        Atualiza corretora.
        
        Args:
            corretora_id: ID da corretora
            data: Dict com campos a atualizar
            usuario_id: ID do usu√°rio propriet√°rio
        """
        corretora = Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
        if not corretora:
            raise ValueError("Corretora n√£o encontrada")
        
        # Atualizar campos permitidos
        if 'nome' in data:
            # Verifica duplicidade
            existing = Corretora.query.filter_by(
                usuario_id=usuario_id,
                nome=data['nome'],
                pais=corretora.pais
            ).first()
            if existing and existing.id != corretora.id:
                raise ValueError(f"J√° existe uma corretora '{data['nome']}' em {corretora.pais}")
            corretora.nome = data['nome']
        
        if 'tipo' in data:
            corretora.tipo = TipoCorretora[data['tipo'].upper()]
        
        if 'pais' in data:
            corretora.pais = data['pais'].upper()
        
        if 'moeda_padrao' in data:
            corretora.moeda_padrao = data['moeda_padrao'].upper()
        
        if 'saldo_atual' in data:
            corretora.saldo_atual = Decimal(str(data['saldo_atual']))
        
        if 'ativa' in data:
            corretora.ativa = data['ativa']
        
        if 'observacoes' in data:
            corretora.observacoes = data['observacoes']
        
        db.session.commit()
        return corretora
    
    @staticmethod
    def delete(corretora_id, usuario_id):
        """Deleta corretora (valida propriedade)"""
        corretora = Corretora.query.filter_by(id=corretora_id, usuario_id=usuario_id).first()
        if not corretora:
            raise ValueError("Corretora n√£o encontrada")
        
        # TODO: Verificar se h√° posi√ß√µes/transa√ß√µes vinculadas
        # Por enquanto, permite deletar
        
        db.session.delete(corretora)
        db.session.commit()
        return True
    
    @staticmethod
    def get_saldo_total(usuario_id, moeda='BRL'):
        """Calcula saldo total do usu√°rio em determinada moeda"""
        corretoras = Corretora.query.filter_by(
            usuario_id=usuario_id,
            moeda_padrao=moeda.upper(),
            ativa=True
        ).all()
        
        total = sum(c.saldo_atual for c in corretoras)
        return total

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/transacao_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Transacao Service - L√≥gica de neg√≥cio"""

from decimal import Decimal
from datetime import datetime, date
from sqlalchemy import and_, or_, func
from app.database import db
from app.models import Transacao, TipoTransacao, Ativo, Corretora

class TransacaoService:
    """Servi√ßo para opera√ß√µes de transa√ß√µes"""
    
    @staticmethod
    def get_all(usuario_id, page=1, per_page=20, tipo=None, ativo_id=None, 
                corretora_id=None, data_inicio=None, data_fim=None):
        """
        Lista transa√ß√µes do usu√°rio com pagina√ß√£o e filtros.
        
        Args:
            usuario_id: ID do usu√°rio (multi-tenant)
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            tipo: Filtro por tipo (COMPRA, VENDA, etc)
            ativo_id: Filtro por ativo
            corretora_id: Filtro por corretora
            data_inicio: Data inicial
            data_fim: Data final
        """
        query = Transacao.query.filter_by(usuario_id=usuario_id)
        
        # Filtros
        if tipo:
            query = query.filter_by(tipo=TipoTransacao[tipo.upper()])
        
        if ativo_id:
            query = query.filter_by(ativo_id=ativo_id)
        
        if corretora_id:
            query = query.filter_by(corretora_id=corretora_id)
        
        if data_inicio:
            query = query.filter(Transacao.data_transacao >= data_inicio)
        
        if data_fim:
            query = query.filter(Transacao.data_transacao <= data_fim)
        
        # Ordenar por data (mais recentes primeiro)
        query = query.order_by(Transacao.data_transacao.desc())
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(transacao_id, usuario_id):
        """Busca transa√ß√£o por ID (com verifica√ß√£o de ownership)"""
        return Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
    
    @staticmethod
    def create(usuario_id, data):
        """
        Cria nova transa√ß√£o.
        
        Args:
            usuario_id: ID do usu√°rio
            data: Dict com tipo, ativo_id, corretora_id, quantidade, preco, etc
        """
        # Verificar se ativo existe
        ativo = Ativo.query.get(data['ativo_id'])
        if not ativo:
            raise ValueError("Ativo n√£o encontrado")
        
        # Verificar se corretora existe e pertence ao usu√°rio
        corretora = Corretora.query.filter_by(
            id=data['corretora_id'],
            usuario_id=usuario_id
        ).first()
        
        if not corretora:
            raise ValueError("Corretora n√£o encontrada ou n√£o pertence ao usu√°rio")
        
        # Calcular valores
        quantidade = Decimal(str(data['quantidade']))
        preco_unitario = Decimal(str(data['preco_unitario']))
        valor_total = quantidade * preco_unitario
        
        # Somar custos
        taxa_corretagem = Decimal(str(data.get('taxa_corretagem', 0)))
        taxa_liquidacao = Decimal(str(data.get('taxa_liquidacao', 0)))
        emolumentos = Decimal(str(data.get('emolumentos', 0)))
        imposto = Decimal(str(data.get('imposto', 0)))
        outros_custos = Decimal(str(data.get('outros_custos', 0)))
        
        custos_totais = (taxa_corretagem + taxa_liquidacao + emolumentos + 
                        imposto + outros_custos)
        
        # Valor l√≠quido (compra: total + custos, venda: total - custos)
        tipo = TipoTransacao[data['tipo'].upper()]
        if tipo == TipoTransacao.COMPRA:
            valor_liquido = valor_total + custos_totais
        elif tipo == TipoTransacao.VENDA:
            valor_liquido = valor_total - custos_totais
        else:
            valor_liquido = valor_total  # Dividendos, JCP, etc
        
        transacao = Transacao(
            usuario_id=usuario_id,
            tipo=tipo,
            ativo_id=data['ativo_id'],
            corretora_id=data['corretora_id'],
            data_transacao=data['data_transacao'],
            quantidade=quantidade,
            preco_unitario=preco_unitario,
            valor_total=valor_total,
            taxa_corretagem=taxa_corretagem,
            taxa_liquidacao=taxa_liquidacao,
            emolumentos=emolumentos,
            imposto=imposto,
            outros_custos=outros_custos,
            custos_totais=custos_totais,
            valor_liquido=valor_liquido,
            observacoes=data.get('observacoes')
        )
        
        db.session.add(transacao)
        db.session.commit()
        return transacao
    
    @staticmethod
    def update(transacao_id, usuario_id, data):
        """
        Atualiza transa√ß√£o.
        
        Args:
            transacao_id: ID da transa√ß√£o
            usuario_id: ID do usu√°rio
            data: Dict com campos a atualizar
        """
        transacao = Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
        
        if not transacao:
            raise ValueError("Transa√ß√£o n√£o encontrada")
        
        # Atualizar campos permitidos
        if 'data_transacao' in data:
            transacao.data_transacao = data['data_transacao']
        
        if 'quantidade' in data:
            transacao.quantidade = Decimal(str(data['quantidade']))
        
        if 'preco_unitario' in data:
            transacao.preco_unitario = Decimal(str(data['preco_unitario']))
        
        if 'taxa_corretagem' in data:
            transacao.taxa_corretagem = Decimal(str(data['taxa_corretagem']))
        
        if 'taxa_liquidacao' in data:
            transacao.taxa_liquidacao = Decimal(str(data['taxa_liquidacao']))
        
        if 'emolumentos' in data:
            transacao.emolumentos = Decimal(str(data['emolumentos']))
        
        if 'imposto' in data:
            transacao.imposto = Decimal(str(data['imposto']))
        
        if 'outros_custos' in data:
            transacao.outros_custos = Decimal(str(data['outros_custos']))
        
        if 'observacoes' in data:
            transacao.observacoes = data['observacoes']
        
        # Recalcular valores
        transacao.valor_total = transacao.quantidade * transacao.preco_unitario
        transacao.custos_totais = (transacao.taxa_corretagem + transacao.taxa_liquidacao + 
                                   transacao.emolumentos + transacao.imposto + 
                                   transacao.outros_custos)
        
        if transacao.tipo == TipoTransacao.COMPRA:
            transacao.valor_liquido = transacao.valor_total + transacao.custos_totais
        elif transacao.tipo == TipoTransacao.VENDA:
            transacao.valor_liquido = transacao.valor_total - transacao.custos_totais
        else:
            transacao.valor_liquido = transacao.valor_total
        
        db.session.commit()
        return transacao
    
    @staticmethod
    def delete(transacao_id, usuario_id):
        """Deleta transa√ß√£o"""
        transacao = Transacao.query.filter_by(
            id=transacao_id,
            usuario_id=usuario_id
        ).first()
        
        if not transacao:
            raise ValueError("Transa√ß√£o n√£o encontrada")
        
        db.session.delete(transacao)
        db.session.commit()
        return True
    
    @staticmethod
    def get_resumo_por_ativo(usuario_id, ativo_id):
        """
        Retorna resumo de transa√ß√µes de um ativo.
        
        Returns:
            Dict com quantidade_total, valor_investido, preco_medio
        """
        transacoes = Transacao.query.filter_by(
            usuario_id=usuario_id,
            ativo_id=ativo_id
        ).all()
        
        quantidade_comprada = Decimal('0')
        quantidade_vendida = Decimal('0')
        valor_investido = Decimal('0')
        valor_vendido = Decimal('0')
        
        for t in transacoes:
            if t.tipo == TipoTransacao.COMPRA:
                quantidade_comprada += t.quantidade
                valor_investido += t.valor_liquido
            elif t.tipo == TipoTransacao.VENDA:
                quantidade_vendida += t.quantidade
                valor_vendido += t.valor_liquido
        
        quantidade_atual = quantidade_comprada - quantidade_vendida
        preco_medio = (valor_investido / quantidade_comprada 
                      if quantidade_comprada > 0 else Decimal('0'))
        
        return {
            "quantidade_total": quantidade_atual,
            "quantidade_comprada": quantidade_comprada,
            "quantidade_vendida": quantidade_vendida,
            "valor_investido": valor_investido,
            "valor_vendido": valor_vendido,
            "preco_medio": preco_medio
        }

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/services/usuario_service.py ---
# -*- coding: utf-8 -*-
"""Exitus - Usuario Service - L√≥gica de neg√≥cio"""

from werkzeug.security import generate_password_hash, check_password_hash
from sqlalchemy import or_
from app.database import db
from app.models import Usuario, UserRole

class UsuarioService:
    """Servi√ßo para opera√ß√µes de usu√°rios"""
    
    @staticmethod
    def get_all(page=1, per_page=20, ativo=None, role=None, search=None):
        """
        Lista usu√°rios com pagina√ß√£o e filtros.
        
        Args:
            page: N√∫mero da p√°gina
            per_page: Itens por p√°gina
            ativo: Filtro por status ativo
            role: Filtro por role
            search: Busca em username e nome_completo
        """
        query = Usuario.query
        
        # Filtros
        if ativo is not None:
            query = query.filter_by(ativo=ativo)
        
        if role:
            query = query.filter_by(role=UserRole[role.upper()])
        
        if search:
            query = query.filter(
                or_(
                    Usuario.username.ilike(f'%{search}%'),
                    Usuario.nome_completo.ilike(f'%{search}%')
                )
            )
        
        # Pagina√ß√£o
        return query.paginate(page=page, per_page=per_page, error_out=False)
    
    @staticmethod
    def get_by_id(user_id):
        """Busca usu√°rio por ID"""
        return Usuario.query.get(user_id)
    
    @staticmethod
    def create(data):
        """
        Cria novo usu√°rio.
        
        Args:
            data: Dict com username, email, password, nome_completo, role
        """
        user = Usuario(
            username=data['username'],
            email=data['email'],
            password_hash=generate_password_hash(data['password']),
            nome_completo=data.get('nome_completo'),
            role=UserRole[data.get('role', 'user').upper()]
        )
        db.session.add(user)
        db.session.commit()
        return user
    
    @staticmethod
    def update(user_id, data, current_user):
        """
        Atualiza usu√°rio.
        
        Args:
            user_id: ID do usu√°rio a atualizar
            data: Dict com campos a atualizar
            current_user: Usu√°rio fazendo a atualiza√ß√£o
        """
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        # Apenas admin pode alterar role e ativo
        is_admin = current_user.role.value.upper() == 'ADMIN'
        
        if 'email' in data:
            # Verifica se email j√° existe (exceto o pr√≥prio)
            existing = Usuario.query.filter_by(email=data['email']).first()
            if existing and existing.id != user.id:
                raise ValueError("Email j√° existe")
            user.email = data['email']
        
        if 'nome_completo' in data:
            user.nome_completo = data['nome_completo']
        
        if 'ativo' in data and is_admin:
            user.ativo = data['ativo']
        
        if 'role' in data and is_admin:
            user.role = UserRole[data['role'].upper()]
        
        db.session.commit()
        return user
    
    @staticmethod
    def delete(user_id):
        """Deleta usu√°rio"""
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        db.session.delete(user)
        db.session.commit()
        return True
    
    @staticmethod
    def change_password(user_id, old_password, new_password):
        """Troca senha do usu√°rio"""
        user = Usuario.query.get(user_id)
        if not user:
            raise ValueError("Usu√°rio n√£o encontrado")
        
        if not check_password_hash(user.password_hash, old_password):
            raise ValueError("Senha atual incorreta")
        
        user.password_hash = generate_password_hash(new_password)
        db.session.commit()
        return True

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/decorators.py ---
# -*- coding: utf-8 -*-
"""Exitus - Decorators - Controle de autoriza√ß√£o por roles"""

from functools import wraps
from flask import jsonify, g
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt
from app.database import db
from app.models import Usuario
from app.utils.responses import forbidden, unauthorized

def admin_required(f):
    """Decorator: apenas usu√°rios ADMIN."""
    @wraps(f)
    @jwt_required()
    def decorated_function(*args, **kwargs):
        identity = get_jwt_identity()
        user = Usuario.query.get(identity)
        # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
        if not user or user.role.value.upper() != 'ADMIN':
            return forbidden("Acesso restrito a administradores")
        g.current_user = user
        return f(*args, **kwargs)
    return decorated_function

def role_required(*roles):
    """Decorator: usu√°rios com roles espec√≠ficas.
    
    Uso: @role_required('ADMIN', 'USER')
    """
    def decorator(f):
        @wraps(f)
        @jwt_required()
        def decorated_function(*args, **kwargs):
            identity = get_jwt_identity()
            user = Usuario.query.get(identity)
            # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
            user_role = user.role.value.upper() if user else None
            roles_upper = [r.upper() for r in roles]
            
            if not user or user_role not in roles_upper:
                return forbidden(f"Acesso restrito √†s roles: {', '.join(roles)}")
            g.current_user = user
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def owner_or_admin_required(resource_model):
    """Decorator: propriet√°rio do recurso OU ADMIN.
    
    Uso: @owner_or_admin_required(Usuario)
    """
    def decorator(f):
        @wraps(f)
        @jwt_required()
        def decorated_function(resource_id, *args, **kwargs):
            identity = get_jwt_identity()
            current_user = Usuario.query.get(identity)
            
            if not current_user:
                return unauthorized("Usu√°rio n√£o encontrado")
            
            # ‚úÖ CORRE√á√ÉO: compara√ß√£o case-insensitive
            if current_user.role.value.upper() == 'ADMIN':
                g.current_user = current_user
                return f(resource_id, *args, **kwargs)
            
            # Verificar se √© o dono do recurso
            resource = resource_model.query.filter_by(usuario_id=identity).first()
            if not resource:
                return forbidden("Acesso negado ao recurso")
            
            g.current_user = current_user
            g.resource_owner = True
            return f(resource_id, *args, **kwargs)
        return decorated_function
    return decorator

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/utils/responses.py ---
# -*- coding: utf-8 -*-
"""Exitus - Utility Responses - Respostas padronizadas"""

from flask import jsonify

def success(data=None, message="Sucesso", status=200):
    """Resposta de sucesso padronizada."""
    response = {"success": True, "message": message}
    if data is not None:
        response["data"] = data
    return jsonify(response), status

def error(message="Erro interno do servidor", status=500):
    """Resposta de erro gen√©rico."""
    return jsonify({
        "success": False, 
        "message": message
    }), status

def unauthorized(message="N√£o autorizado"):
    """Resposta 401."""
    return jsonify({
        "success": False,
        "message": message
    }), 401

def forbidden(message="Acesso negado"):
    """Resposta 403."""
    return jsonify({
        "success": False,
        "message": message
    }), 403

def not_found(message="Recurso n√£o encontrado"):
    """Resposta 404."""
    return jsonify({
        "success": False,
        "message": message
    }), 404

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
# Exitus - M√≥dulo 2 Backend API REST
# Depend√™ncias existentes (M√≥dulo 1)
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
psycopg2-binary==2.9.9
python-dotenv==1.0.0
alembic==1.13.0
gunicorn==21.2.0

# ‚≠ê Novas depend√™ncias (M√≥dulo 2)
Flask-JWT-Extended==4.5.3
Flask-CORS==4.0.0
marshmallow==3.20.1
marshmallow-sqlalchemy==0.29.0
pytest==7.4.3
pytest-flask==1.3.0
pytest-cov==4.1.0
flask-restx==1.3.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt.mod1.bak ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
alembic==1.13.1
Flask-Migrate==4.0.5

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

# Criar a aplica√ß√£o Flask (j√° inicializa o banco internamente)
app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/conftest.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_ativos_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.3 - CRUD DE ATIVOS"
echo ""

# 1. Login ADMIN
echo "1. Login ADMIN..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$ADMIN_TOKEN" ]; then
    echo "‚ùå Erro ao obter token ADMIN!"
    exit 1
fi
echo "‚úÖ Token ADMIN obtido"
echo ""

# 2. Criar a√ß√£o brasileira
echo "2. POST /api/ativos - Criar PETR4 (A√ß√£o BR)..."
PETR4=$(curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "PETR4",
    "nome": "Petrobras PN",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL",
    "preco_atual": "38.50",
    "dividend_yield": "12.5",
    "pl": "4.2",
    "pvp": "0.85",
    "roe": "18.3"
  }')

echo "$PETR4" | python3 -m json.tool
PETR4_ID=$(echo "$PETR4" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['id'])" 2>/dev/null)
echo ""

# 3. Criar FII
echo "3. POST /api/ativos - Criar HGLG11 (FII)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "HGLG11",
    "nome": "CSHG Log√≠stica FII",
    "tipo": "fii",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL",
    "preco_atual": "165.00",
    "dividend_yield": "10.2",
    "pvp": "0.98"
  }' | python3 -m json.tool
echo ""

# 4. Criar a√ß√£o US
echo "4. POST /api/ativos - Criar AAPL (A√ß√£o US)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "AAPL",
    "nome": "Apple Inc",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "US",
    "moeda": "USD",
    "preco_atual": "195.50",
    "dividend_yield": "0.5",
    "pl": "32.5",
    "pvp": "45.2",
    "roe": "147.5"
  }' | python3 -m json.tool
echo ""

# 5. Criar criptomoeda
echo "5. POST /api/ativos - Criar BTC (Cripto)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "BTC",
    "nome": "Bitcoin",
    "tipo": "cripto",
    "classe": "cripto",
    "mercado": "CRIPTO",
    "moeda": "USD",
    "preco_atual": "43500.00"
  }' | python3 -m json.tool
echo ""

# 6. Listar todos os ativos
echo "6. GET /api/ativos - Listar todos ativos..."
curl -s -X GET "http://localhost:5000/api/ativos?page=1&per_page=10" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 7. Filtrar por tipo
echo "7. GET /api/ativos?tipo=acao - Filtrar a√ß√µes..."
curl -s -X GET "http://localhost:5000/api/ativos?tipo=acao" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 8. Filtrar por mercado
echo "8. GET /api/ativos?mercado=BR - Filtrar mercado BR..."
curl -s -X GET "http://localhost:5000/api/ativos?mercado=BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 9. Buscar por ticker
echo "9. GET /api/ativos/ticker/PETR4?mercado=BR - Buscar PETR4..."
curl -s -X GET "http://localhost:5000/api/ativos/ticker/PETR4?mercado=BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 10. Buscar por nome
echo "10. GET /api/ativos?search=Petrobras - Buscar 'Petrobras'..."
curl -s -X GET "http://localhost:5000/api/ativos?search=Petrobras" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 11. Atualizar pre√ßo
if [ ! -z "$PETR4_ID" ]; then
    echo "11. PUT /api/ativos/{id} - Atualizar pre√ßo PETR4..."
    curl -s -X PUT "http://localhost:5000/api/ativos/$PETR4_ID" \
      -H "Authorization: Bearer $ADMIN_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"preco_atual": "39.75", "pl": "4.3"}' | python3 -m json.tool
    echo ""
fi

# 12. Listar ativos por mercado
echo "12. GET /api/ativos/mercado/BR - Ativos mercado BR..."
curl -s -X GET "http://localhost:5000/api/ativos/mercado/BR" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 13. Login USER
echo "13. Login USER (joao.silva)..."
USER_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"novasenha123"}')

USER_TOKEN=$(echo "$USER_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    # Tentar senha antiga
    USER_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username":"joao.silva","password":"user123"}')
    USER_TOKEN=$(echo "$USER_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
fi

echo "‚úÖ Token USER obtido"
echo ""

# 14. USER pode listar ativos (leitura p√∫blica)
echo "14. GET /api/ativos - USER listando ativos (deve funcionar)..."
curl -s -X GET "http://localhost:5000/api/ativos" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 15. USER tentar criar ativo (deve falhar 403)
echo "15. POST /api/ativos - USER tentando criar (deve falhar 403)..."
curl -s -X POST http://localhost:5000/api/ativos \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "VALE3",
    "nome": "Vale",
    "tipo": "acao",
    "classe": "renda_variavel",
    "mercado": "BR",
    "moeda": "BRL"
  }' | python3 -m json.tool
echo ""

echo "‚úÖ Testes CRUD Ativos conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_auth_phase21.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.1 - AUTENTICA√á√ÉO JWT"

# 1. Health check
echo "1. Health check..."
curl -s http://localhost:5000/health | python3 -m json.tool

# 2. Login admin (deve funcionar)
echo "2. Login admin..."
curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | python3 -m json.tool

# 3. Login inv√°lido (deve falhar)
echo "3. Login inv√°lido..."
curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"invalido","password":"123"}' | python3 -m json.tool

# 4. /me sem token (deve falhar 401)
echo "4. /me sem token..."
curl -s -X GET http://localhost:5000/api/auth/me | python3 -m json.tool

echo "‚úÖ Testes Fase 2.1 conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_corretoras_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.2 - CRUD DE CORRETORAS"
echo ""

# 1. Login usu√°rio comum (joao.silva) - senha foi alterada para novasenha123
echo "1. Login USER (joao.silva)..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"novasenha123"}')

USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    echo "‚ùå Erro ao obter token USER! Tentando senha antiga..."
    RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username":"joao.silva","password":"user123"}')
    USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
fi

echo "‚úÖ Token USER obtido"
echo ""

# 2. Criar corretora BR
echo "2. POST /api/corretoras - Criar corretora XP (BR)..."
CORRETORA_XP=$(curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "XP Investimentos",
    "tipo": "corretora",
    "pais": "BR",
    "moeda_padrao": "BRL",
    "saldo_atual": "10000.50",
    "observacoes": "Conta principal"
  }')

echo "$CORRETORA_XP" | python3 -m json.tool
XP_ID=$(echo "$CORRETORA_XP" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['id'])" 2>/dev/null)
echo ""

# 3. Criar exchange cripto
echo "3. POST /api/corretoras - Criar exchange Binance..."
curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Binance",
    "tipo": "exchange",
    "pais": "US",
    "moeda_padrao": "USD",
    "saldo_atual": "5000.00",
    "observacoes": "Exchange de criptomoedas"
  }' | python3 -m json.tool
echo ""

# 4. Criar corretora US
echo "4. POST /api/corretoras - Criar Avenue (US)..."
curl -s -X POST http://localhost:5000/api/corretoras \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Avenue Securities",
    "tipo": "corretora",
    "pais": "US",
    "moeda_padrao": "USD",
    "saldo_atual": "2500.75"
  }' | python3 -m json.tool
echo ""

# 5. Listar todas as corretoras
echo "5. GET /api/corretoras - Listar todas corretoras do usu√°rio..."
curl -s -X GET "http://localhost:5000/api/corretoras?page=1&per_page=10" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 6. Filtrar por tipo
echo "6. GET /api/corretoras?tipo=exchange - Filtrar exchanges..."
curl -s -X GET "http://localhost:5000/api/corretoras?tipo=exchange" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 7. Filtrar por pa√≠s
echo "7. GET /api/corretoras?pais=BR - Filtrar por pa√≠s BR..."
curl -s -X GET "http://localhost:5000/api/corretoras?pais=BR" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 8. Buscar por nome
echo "8. GET /api/corretoras?search=XP - Buscar 'XP'..."
curl -s -X GET "http://localhost:5000/api/corretoras?search=XP" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 9. Buscar corretora espec√≠fica
if [ ! -z "$XP_ID" ]; then
    echo "9. GET /api/corretoras/{id} - Buscar XP por ID..."
    curl -s -X GET "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 10. Atualizar corretora
if [ ! -z "$XP_ID" ]; then
    echo "10. PUT /api/corretoras/{id} - Atualizar saldo XP..."
    curl -s -X PUT "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $USER_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"saldo_atual": "15000.00", "observacoes": "Saldo atualizado"}' | python3 -m json.tool
    echo ""
fi

# 11. Saldo total em BRL
echo "11. GET /api/corretoras/saldo-total?moeda=BRL - Saldo total BRL..."
curl -s -X GET "http://localhost:5000/api/corretoras/saldo-total?moeda=BRL" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 12. Saldo total em USD
echo "12. GET /api/corretoras/saldo-total?moeda=USD - Saldo total USD..."
curl -s -X GET "http://localhost:5000/api/corretoras/saldo-total?moeda=USD" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 13. Tentar acessar corretora de outro usu√°rio (admin)
echo "13. Login ADMIN..."
ADMIN_RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$ADMIN_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ ! -z "$XP_ID" ] && [ ! -z "$ADMIN_TOKEN" ]; then
    echo "14. GET - ADMIN tentando acessar corretora do USER (deve falhar)..."
    curl -s -X GET "http://localhost:5000/api/corretoras/$XP_ID" \
      -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
    echo ""
fi

echo "‚úÖ Testes CRUD Corretoras conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_decorators.sh ---
#!/bin/bash
echo "üß™ TESTES DECORATORS - Fase 2.1.2"

# 1. Fazer login e pegar token
echo "1. Login admin..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ACCESS_TOKEN=$(echo $RESPONSE | python3 -m json.tool | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
echo "‚úÖ Token obtido: ${ACCESS_TOKEN:0:30}..."

# 2. Teste /me COM token (deve funcionar)
echo "2. /me COM token..."
curl -s -X GET "http://localhost:5000/api/auth/me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | python3 -m json.tool

# 3. Teste /me SEM token (deve falhar 401)
echo "3. /me SEM token..."
curl -s -X GET http://localhost:5000/api/auth/me | python3 -m json.tool

# 4. Teste refresh token
echo "4. Refresh token..."
REFRESH_TOKEN=$(echo $RESPONSE | python3 -m json.tool | grep -o '"refresh_token":"[^"]*' | cut -d'"' -f4)
curl -s -X POST http://localhost:5000/api/auth/refresh \
  -H "Authorization: Bearer $REFRESH_TOKEN" | python3 -m json.tool

echo "‚úÖ Testes decorators conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_transacoes_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.4 - CRUD DE TRANSA√á√ïES"
echo ""

# 1. Login USER
echo "1. Login USER (joao.silva)..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"user123"}')

USER_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('access_token', ''))" 2>/dev/null)

if [ -z "$USER_TOKEN" ]; then
    echo "‚ùå Falha ao obter token USER"
    echo "$RESPONSE" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ Token USER obtido: ${USER_TOKEN:0:20}..."
echo ""

# 2. Buscar corretora do USER
echo "2. GET /api/corretoras - Buscar corretora do USER..."
CORRETORAS=$(curl -s -X GET "http://localhost:5000/api/corretoras" \
  -H "Authorization: Bearer $USER_TOKEN")

CORRETORA_ID=$(echo "$CORRETORAS" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('corretoras', [{}])[0].get('id', ''))" 2>/dev/null)

if [ -z "$CORRETORA_ID" ]; then
    echo "‚ùå Nenhuma corretora encontrada"
    echo "$CORRETORAS" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ Corretora ID: $CORRETORA_ID"
echo ""

# 3. Buscar ativo PETR4
echo "3. GET /api/ativos/ticker/PETR4?mercado=BR - Buscar PETR4..."
PETR4=$(curl -s -X GET "http://localhost:5000/api/ativos/ticker/PETR4?mercado=BR" \
  -H "Authorization: Bearer $USER_TOKEN")

PETR4_ID=$(echo "$PETR4" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)

if [ -z "$PETR4_ID" ]; then
    echo "‚ùå PETR4 n√£o encontrado"
    echo "$PETR4" | python3 -m json.tool
    exit 1
fi

echo "‚úÖ PETR4 ID: $PETR4_ID"
echo ""

# 4. Criar transa√ß√£o de COMPRA
echo "4. POST /api/transacoes - Criar COMPRA 100 PETR4 @ R\$ 38.50..."
COMPRA=$(curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"compra\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-01T10:30:00\",
    \"quantidade\": \"100\",
    \"preco_unitario\": \"38.50\",
    \"taxa_corretagem\": \"10.00\",
    \"emolumentos\": \"2.50\",
    \"imposto\": \"0.50\"
  }")

echo "$COMPRA" | python3 -m json.tool
COMPRA_ID=$(echo "$COMPRA" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)
echo ""

# 5. Buscar ativo VALE3
echo "5. GET /api/ativos/ticker/VALE3?mercado=BR - Buscar VALE3..."
VALE3=$(curl -s -X GET "http://localhost:5000/api/ativos/ticker/VALE3?mercado=BR" \
  -H "Authorization: Bearer $USER_TOKEN")

VALE3_ID=$(echo "$VALE3" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('id', ''))" 2>/dev/null)
echo "‚úÖ VALE3 ID: $VALE3_ID"
echo ""

# 6. Criar transa√ß√£o de COMPRA VALE3
echo "6. POST /api/transacoes - Criar COMPRA 50 VALE3 @ R\$ 62.80..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"compra\",
    \"ativo_id\": \"$VALE3_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-02T14:00:00\",
    \"quantidade\": \"50\",
    \"preco_unitario\": \"62.80\",
    \"taxa_corretagem\": \"8.00\",
    \"emolumentos\": \"2.00\"
  }" | python3 -m json.tool
echo ""

# 7. Criar transa√ß√£o de VENDA
echo "7. POST /api/transacoes - Criar VENDA 30 PETR4 @ R\$ 39.20..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"venda\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-12-02T15:30:00\",
    \"quantidade\": \"30\",
    \"preco_unitario\": \"39.20\",
    \"taxa_corretagem\": \"6.00\",
    \"emolumentos\": \"1.50\",
    \"imposto\": \"0.30\"
  }" | python3 -m json.tool
echo ""

# 8. Criar transa√ß√£o de DIVIDENDO
echo "8. POST /api/transacoes - Criar DIVIDENDO PETR4..."
curl -s -X POST http://localhost:5000/api/transacoes \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"tipo\": \"dividendo\",
    \"ativo_id\": \"$PETR4_ID\",
    \"corretora_id\": \"$CORRETORA_ID\",
    \"data_transacao\": \"2025-11-15T00:00:00\",
    \"quantidade\": \"100\",
    \"preco_unitario\": \"0.85\",
    \"observacoes\": \"Dividendos referentes a novembro/2025\"
  }" | python3 -m json.tool
echo ""

# 9. Listar todas as transa√ß√µes
echo "9. GET /api/transacoes - Listar todas transa√ß√µes..."
curl -s -X GET "http://localhost:5000/api/transacoes?page=1&per_page=10" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 10. Filtrar por tipo
echo "10. GET /api/transacoes?tipo=compra - Filtrar compras..."
curl -s -X GET "http://localhost:5000/api/transacoes?tipo=compra" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 11. Filtrar por ativo
if [ ! -z "$PETR4_ID" ]; then
    echo "11. GET /api/transacoes?ativo_id=PETR4_ID - Filtrar PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes?ativo_id=$PETR4_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 12. Filtrar por per√≠odo
echo "12. GET /api/transacoes?data_inicio=2025-12-01 - Filtrar dezembro..."
curl -s -X GET "http://localhost:5000/api/transacoes?data_inicio=2025-12-01T00:00:00" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 13. Buscar transa√ß√£o por ID
if [ ! -z "$COMPRA_ID" ]; then
    echo "13. GET /api/transacoes/{id} - Buscar compra PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes/$COMPRA_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

# 14. Atualizar transa√ß√£o
if [ ! -z "$COMPRA_ID" ]; then
    echo "14. PUT /api/transacoes/{id} - Atualizar taxa corretagem..."
    curl -s -X PUT "http://localhost:5000/api/transacoes/$COMPRA_ID" \
      -H "Authorization: Bearer $USER_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"taxa_corretagem": "12.00"}' | python3 -m json.tool
    echo ""
fi

# 15. Resumo por ativo
if [ ! -z "$PETR4_ID" ]; then
    echo "15. GET /api/transacoes/resumo/{ativo_id} - Resumo PETR4..."
    curl -s -X GET "http://localhost:5000/api/transacoes/resumo/$PETR4_ID" \
      -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
    echo ""
fi

echo "‚úÖ Testes CRUD Transa√ß√µes conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/tests/test_usuarios_crud.sh ---
#!/bin/bash
echo "üß™ TESTES FASE 2.2.1 - CRUD DE USU√ÅRIOS"
echo ""

# 1. Login ADMIN para obter token
echo "1. Login ADMIN..."
RESPONSE=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

ADMIN_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$ADMIN_TOKEN" ]; then
    echo "‚ùå Erro ao obter token ADMIN!"
    exit 1
fi
echo "‚úÖ Token ADMIN obtido"
echo ""

# 2. Criar novo usu√°rio
echo "2. POST /api/usuarios - Criar usu√°rio 'teste.user'..."
curl -s -X POST http://localhost:5000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "username": "teste.user",
    "email": "teste@exitus.com",
    "password": "senha12345",
    "nome_completo": "Usu√°rio de Teste",
    "role": "user"
  }' | python3 -m json.tool
echo ""

# 3. Listar usu√°rios (admin only)
echo "3. GET /api/usuarios - Listar usu√°rios (ADMIN)..."
curl -s -X GET "http://localhost:5000/api/usuarios?page=1&per_page=10" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 4. Buscar usu√°rio espec√≠fico
echo "4. GET /api/usuarios/{id} - Buscar admin (com token ADMIN)..."
ADMIN_ID="783c2bfd-9e36-4cbd-a4fb-901afae9fad3"
curl -s -X GET "http://localhost:5000/api/usuarios/$ADMIN_ID" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

# 5. Login usu√°rio comum
echo "5. Login usu√°rio comum (joao.silva)..."
RESPONSE_USER=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"joao.silva","password":"user123"}')

USER_TOKEN=$(echo "$RESPONSE_USER" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)
USER_ID=$(echo "$RESPONSE_USER" | python3 -c "import sys, json; import jwt; token=json.load(sys.stdin)['data']['access_token']; print(jwt.decode(token, options={'verify_signature': False})['sub'])" 2>/dev/null)

echo "‚úÖ Token USER obtido (ID: $USER_ID)"
echo ""

# 6. Tentar listar usu√°rios com USER (deve falhar 403)
echo "6. GET /api/usuarios - Tentar listar com USER (deve falhar 403)..."
curl -s -X GET http://localhost:5000/api/usuarios \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 7. Ver pr√≥prio perfil com USER (deve funcionar)
echo "7. GET /api/usuarios/{id} - USER vendo pr√≥prio perfil..."
curl -s -X GET "http://localhost:5000/api/usuarios/$USER_ID" \
  -H "Authorization: Bearer $USER_TOKEN" | python3 -m json.tool
echo ""

# 8. Atualizar pr√≥prio perfil
echo "8. PUT /api/usuarios/{id} - USER atualizando pr√≥prio nome..."
curl -s -X PUT "http://localhost:5000/api/usuarios/$USER_ID" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nome_completo": "Jo√£o Silva Atualizado"}' | python3 -m json.tool
echo ""

# 9. Trocar senha
echo "9. PATCH /api/usuarios/{id}/password - Trocar senha..."
curl -s -X PATCH "http://localhost:5000/api/usuarios/$USER_ID/password" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"old_password": "user123", "new_password": "novasenha123"}' | python3 -m json.tool
echo ""

# 10. Filtros e busca
echo "10. GET /api/usuarios?search=admin - Buscar por nome..."
curl -s -X GET "http://localhost:5000/api/usuarios?search=admin" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | python3 -m json.tool
echo ""

echo "‚úÖ Testes CRUD Usu√°rios conclu√≠dos!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/INSTALACAO_MODULO1.md ---
# Exitus - M√≥dulo 1: Database Backend
## Guia Completo de Instala√ß√£o e Configura√ß√£o

---

## üìã √çndice

1. [Pr√©-requisitos](#pr√©-requisitos)
2. [Estrutura do Projeto](#estrutura-do-projeto)
3. [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
4. [Instala√ß√£o dos Containers](#instala√ß√£o-dos-containers)
5. [Configura√ß√£o do Backend](#configura√ß√£o-do-backend)
6. [Migrations e Schema](#migrations-e-schema)
7. [Seeds de Dados](#seeds-de-dados)
8. [Valida√ß√£o da Instala√ß√£o](#valida√ß√£o-da-instala√ß√£o)
9. [Troubleshooting](#troubleshooting)

---

## üîß Pr√©-requisitos

### Sistema Operacional
- Ubuntu 22.04+ (WSL2 ou nativo)
- Podman instalado e configurado

### Verificar Instala√ß√£o
```bash
# Verificar vers√£o do Podman
podman --version
# Sa√≠da esperada: podman version 4.x.x ou superior

# Verificar se Podman est√° rodando
podman ps
```

---

## üìÅ Estrutura do Projeto

```
exitus/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ alembic/              # Migrations do banco de dados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ versions/         # Arquivos de migration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.py           # Configura√ß√£o do Alembic
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py      # Inicializa√ß√£o da aplica√ß√£o Flask
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py        # Configura√ß√µes da aplica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py      # Configura√ß√£o do SQLAlchemy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/          # Models do sistema (12 arquivos)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ usuario.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ corretora.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ativo.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posicao.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transacao.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provento.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ movimentacao_caixa.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ evento_corporativo.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fonte_dados.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ regra_fiscal.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ feriado_mercado.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ log_auditoria.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeds/           # Scripts de popula√ß√£o de dados
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_usuarios.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_ativos_br.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_regras_fiscais_br.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_feriados_b3.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seed_fontes_dados.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ run_all_seeds.py
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile           # Imagem Docker do backend
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt     # Depend√™ncias Python
‚îÇ   ‚îú‚îÄ‚îÄ alembic.ini         # Configura√ß√£o do Alembic
‚îÇ   ‚îî‚îÄ‚îÄ run.py              # Entry point da aplica√ß√£o
‚îú‚îÄ‚îÄ docs/                    # Documenta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ INSTALACAO_MODULO1.md
‚îÇ   ‚îî‚îÄ‚îÄ modulo1_database.md
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ setup_containers.sh  # Script de setup dos containers
‚îî‚îÄ‚îÄ tests/                   # Scripts de valida√ß√£o
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase1.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase2.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase3.sh
    ‚îú‚îÄ‚îÄ mod1_validacao_final_fase4.sh
    ‚îî‚îÄ‚îÄ mod1_validacao_final_fase5.sh
```

---

## ‚öôÔ∏è Configura√ß√£o do Ambiente

### 1. Criar Diret√≥rios do Projeto

```bash
mkdir -p ~/exitus/{backend,docs,scripts,tests}
cd ~/exitus
```

### 2. Criar Rede Podman

```bash
podman network create exitus-network
```

**Verificar:**
```bash
podman network ls
# Deve mostrar: exitus-network
```

---

## üê≥ Instala√ß√£o dos Containers

### 1. Container PostgreSQL

```bash
podman run -d \
  --name exitus-db \
  --network exitus-network \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus_pass \
  -e POSTGRES_DB=exitusdb \
  -v exitus-db-data:/var/lib/postgresql/data \
  postgres:15-alpine
```

**Verificar:**
```bash
podman logs exitus-db
# Deve mostrar: "database system is ready to accept connections"
```

### 2. Preparar Backend

**Criar requirements.txt:**
```bash
nano backend/requirements.txt
```

```txt
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
psycopg2-binary==2.9.9
python-dotenv==1.0.0
alembic==1.13.0
gunicorn==21.2.0
```

**Criar Dockerfile:**
```bash
nano backend/Dockerfile
```

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instalar depend√™ncias do sistema
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Copiar requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar c√≥digo
COPY . .

# Expor porta
EXPOSE 5000

# Comando de inicializa√ß√£o
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--reload", "--timeout", "120", "run:app"]
```

### 3. Container Backend

**Build da imagem:**
```bash
cd backend
podman build -t exitus-backend:latest .
```

**Executar container:**
```bash
podman run -d \
  --name exitus-backend \
  --network exitus-network \
  -p 5000:5000 \
  -e FLASK_ENV=development \
  -e DATABASE_URL=postgresql://exitus:exitus_pass@exitus-db:5432/exitusdb \
  -v $(pwd):/app:Z \
  exitus-backend:latest
```

**Verificar:**
```bash
curl http://localhost:5000/health
# Deve retornar: {"status":"ok","service":"exitus-backend","env":"development"}
```

---

## üîß Configura√ß√£o do Backend

### 1. Estrutura de Arquivos

Todos os arquivos do backend j√° devem estar criados conforme a estrutura mostrada acima.

### 2. Arquivo de Configura√ß√£o Principal

**backend/app/__init__.py:**
```python
from flask import Flask
from app.config import Config
from app.database import init_db

def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)

    # Inicializar banco de dados
    init_db(app)

    # Registrar blueprints (ser√° feito no M√≥dulo 2)

    # Rota de health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config['ENV']
        }

    return app

app = create_app()
```

### 3. Configura√ß√£o do Banco de Dados

**backend/app/database.py:**
```python
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()

def init_db(app):
    db.init_app(app)
    migrate.init_app(app, db)

    with app.app_context():
        # Importar todos os models
        from app.models import (
            Usuario, Corretora, Ativo, Posicao, Transacao,
            Provento, MovimentacaoCaixa, EventoCorporativo,
            FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
        )

    return db
```

---

## üóÉÔ∏è Migrations e Schema

### 1. Configurar Alembic

**backend/alembic/env.py** (j√° deve estar configurado corretamente)

### 2. Gerar Migration Inicial

```bash
# Entrar no container
podman exec -it exitus-backend bash

# Dentro do container:
cd /app
alembic revision --autogenerate -m "Initial schema - 12 models"
```

**Sa√≠da esperada:**
```
INFO  [alembic.autogenerate.compare] Detected added table 'usuario'
INFO  [alembic.autogenerate.compare] Detected added table 'ativo'
...
Generating /app/alembic/versions/XXXXX_initial_schema_12_models.py ... done
```

### 3. Aplicar Migration

```bash
# Dentro do container:
alembic upgrade head
```

**Sa√≠da esperada:**
```
INFO  [alembic.runtime.migration] Running upgrade  -> XXXXX, Initial schema - 12 models
```

### 4. Validar Schema Criado

```bash
# No host:
podman exec exitus-db psql -U exitus -d exitusdb -c "\dt"
```

**Deve listar 13 tabelas:**
- alembic_version
- ativo
- corretora
- evento_corporativo
- feriado_mercado
- fonte_dados
- log_auditoria
- movimentacao_caixa
- posicao
- provento
- regra_fiscal
- transacao
- usuario

---

## üå± Seeds de Dados

### Executar Seeds Individuais

```bash
# Dentro do container backend:
python3 -m app.seeds.seed_usuarios
python3 -m app.seeds.seed_ativos_br
python3 -m app.seeds.seed_regras_fiscais_br
python3 -m app.seeds.seed_feriados_b3
python3 -m app.seeds.seed_fontes_dados
```

### Ou Executar Todos de Uma Vez

```bash
# Dentro do container backend:
python3 -m app.seeds.run_all_seeds
```

### Dados Populados

Ap√≥s executar os seeds, o banco ter√°:
- **4 usu√°rios** (admin, 2 users, 1 readonly)
- **25 ativos BR** (15 a√ß√µes + 10 FIIs)
- **6 regras fiscais** brasileiras
- **30 feriados** B3 (2025-2026)
- **7 fontes de dados** (APIs)

**Credenciais de acesso:**
```
Username: admin       | Senha: admin123
Username: joao.silva  | Senha: user123
Username: maria.santos| Senha: user123
Username: viewer      | Senha: viewer123
```

‚ö†Ô∏è **ATEN√á√ÉO:** Altere as senhas em produ√ß√£o!

---

## ‚úÖ Valida√ß√£o da Instala√ß√£o

### Scripts de Valida√ß√£o Autom√°tica

```bash
# No host, executar cada fase:
./tests/mod1_validacao_final_fase1.sh
./tests/mod1_validacao_final_fase2.sh
./tests/mod1_validacao_final_fase3.sh
./tests/mod1_validacao_final_fase4.sh
./tests/mod1_validacao_final_fase5.sh
```

### Valida√ß√£o Manual

**1. Verificar containers:**
```bash
podman ps
# Deve mostrar 3 containers rodando: exitus-db, exitus-backend, exitus-frontend
```

**2. Testar conex√£o com banco:**
```bash
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT COUNT(*) FROM usuario;"
# Deve retornar: 4
```

**3. Testar API backend:**
```bash
curl http://localhost:5000/health
# Deve retornar JSON com status ok
```

**4. Verificar logs:**
```bash
podman logs exitus-backend --tail 20
# N√£o deve ter erros cr√≠ticos
```

---

## üîç Troubleshooting

### Container n√£o inicia

**Problema:** Container exitus-backend n√£o sobe
```bash
podman logs exitus-backend
# Ver erros espec√≠ficos
```

**Solu√ß√µes comuns:**
- Verificar se porta 5000 n√£o est√° em uso: `netstat -tulpn | grep 5000`
- Verificar vari√°veis de ambiente: `podman exec exitus-backend env | grep DATABASE`
- Reconstruir imagem: `podman build --no-cache -t exitus-backend:latest .`

### Erro de conex√£o com banco

**Problema:** Backend n√£o conecta no PostgreSQL

**Solu√ß√µes:**
```bash
# Verificar se containers est√£o na mesma rede
podman network inspect exitus-network

# Testar conex√£o manualmente
podman exec exitus-backend ping exitus-db

# Verificar se PostgreSQL est√° aceitando conex√µes
podman exec exitus-db pg_isready -U exitus
```

### Migration falha

**Problema:** `alembic upgrade head` retorna erro

**Solu√ß√µes:**
```bash
# Ver hist√≥rico de migrations
alembic history

# Ver vers√£o atual
alembic current

# Reverter migration (cuidado!)
alembic downgrade -1

# Gerar nova migration
alembic revision --autogenerate -m "Fix: descri√ß√£o"
```

### Seed falha

**Problema:** Seed retorna erro de constraint ou duplicate

**Solu√ß√µes:**
```bash
# Limpar tabela espec√≠fica (exemplo: usuario)
podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario;"

# Resetar banco (CUIDADO - apaga tudo!)
podman exec exitus-db psql -U exitus -d exitusdb -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
alembic upgrade head
```

---

## üìä Resumo da Instala√ß√£o

Ao final deste guia, voc√™ ter√°:

‚úÖ 3 containers rodando (PostgreSQL, Backend, Frontend)  
‚úÖ 13 tabelas criadas no banco de dados  
‚úÖ 11 enums personalizados  
‚úÖ 15 foreign keys configuradas  
‚úÖ 86 √≠ndices otimizados  
‚úÖ 72 registros de dados iniciais  
‚úÖ 5 scripts de valida√ß√£o funcionando  

**Tempo estimado de instala√ß√£o:** 45-60 minutos

---

## üéØ Pr√≥ximos Passos

Com o M√≥dulo 1 instalado, voc√™ pode:

1. **M√≥dulo 2:** Desenvolver API REST com endpoints CRUD
2. **M√≥dulo 3:** Criar interface frontend
3. **Testes:** Implementar testes unit√°rios e de integra√ß√£o
4. **Deploy:** Preparar ambiente de produ√ß√£o

---

## üìö Refer√™ncias

- [Documenta√ß√£o do PostgreSQL](https://www.postgresql.org/docs/)
- [Flask Documentation](https://flask.palletsprojects.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Podman Documentation](https://docs.podman.io/)

---

**Vers√£o:** 1.0  
**Data:** Novembro 2025  
**Autor:** Equipe Exitus

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo1_database.md ---
# Exitus - M√≥dulo 1: Database
## Documenta√ß√£o T√©cnica do Banco de Dados

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Banco](#arquitetura-do-banco)
3. [Models e Tabelas](#models-e-tabelas)
4. [Relacionamentos](#relacionamentos)
5. [Enums e Tipos](#enums-e-tipos)
6. [√çndices e Performance](#√≠ndices-e-performance)
7. [Queries √öteis](#queries-√∫teis)
8. [Diagrama ER](#diagrama-er)
9. [Boas Pr√°ticas](#boas-pr√°ticas)

---

## üéØ Vis√£o Geral

O banco de dados do Exitus foi projetado para gerenciar investimentos de forma completa e eficiente.

### Estat√≠sticas

| M√©trica | Valor |
|---------|-------|
| **Tabelas** | 13 (12 models + alembic_version) |
| **Enums** | 11 tipos personalizados |
| **Foreign Keys** | 15 relacionamentos |
| **√çndices** | 86 (autom√°ticos + customizados) |
| **SGBD** | PostgreSQL 15+ |

### Tecnologias

- **ORM:** SQLAlchemy 2.0+
- **Migrations:** Alembic 1.13+
- **Language:** Python 3.11+
- **Database:** PostgreSQL 15+ Alpine

---

## üèóÔ∏è Arquitetura do Banco

### Camadas de Dados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CAMADA DE APLICA√á√ÉO (Flask)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   CAMADA ORM (SQLAlchemy)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   CAMADA DE DADOS (PostgreSQL)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Grupos de Tabelas

**1. Core (Essenciais):**
- `usuario` - Usu√°rios do sistema
- `corretora` - Corretoras/brokers
- `ativo` - Ativos financeiros (a√ß√µes, FIIs, etc.)
- `posicao` - Posi√ß√µes consolidadas
- `transacao` - Opera√ß√µes de compra/venda

**2. Financeiras:**
- `provento` - Dividendos, JCP, rendimentos
- `movimentacao_caixa` - Dep√≥sitos, saques, transfer√™ncias

**3. Eventos e Refer√™ncia:**
- `evento_corporativo` - Splits, grupamentos, bonifica√ß√µes
- `feriado_mercado` - Feriados de bolsa

**4. Sistema:**
- `fonte_dados` - APIs de cota√ß√µes
- `regra_fiscal` - Regras de IR
- `log_auditoria` - Auditoria de a√ß√µes

---

## üìä Models e Tabelas

### 1. Usuario

**Descri√ß√£o:** Gerencia usu√°rios e autentica√ß√£o

**Tabela:** `usuario`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `username` | VARCHAR(80) | Username √∫nico |
| `email` | VARCHAR(120) | Email √∫nico |
| `password_hash` | VARCHAR(256) | Senha criptografada |
| `nome_completo` | VARCHAR(200) | Nome completo (opcional) |
| `ativo` | BOOLEAN | Se usu√°rio est√° ativo |
| `role` | ENUM(UserRole) | Papel: ADMIN, USER, READONLY |
| `ultimo_login` | TIMESTAMP | Data do √∫ltimo login |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `username`, `email`
- CHECK: `username` deve ter pelo menos 3 caracteres
- CHECK: `email` deve ter formato v√°lido

**√çndices:**
- `ix_usuario_username`
- `ix_usuario_email`

**Relacionamentos:**
- 1:N com `corretora`
- 1:N com `posicao`
- 1:N com `transacao`
- 1:N com `movimentacao_caixa`
- 1:N com `log_auditoria`

---

### 2. Corretora

**Descri√ß√£o:** Corretoras/brokers onde o usu√°rio opera

**Tabela:** `corretora`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio dono |
| `nome` | VARCHAR(100) | Nome da corretora |
| `tipo` | ENUM(TipoCorretora) | NACIONAL, INTERNACIONAL |
| `pais` | VARCHAR(2) | C√≥digo ISO do pa√≠s |
| `moeda_padrao` | VARCHAR(3) | Moeda padr√£o (BRL, USD) |
| `ativa` | BOOLEAN | Se corretora est√° ativa |
| `numero_conta` | VARCHAR(50) | N√∫mero da conta (opcional) |
| `observacoes` | TEXT | Observa√ß√µes gerais |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (ON DELETE CASCADE)
- CHECK: `pais` formato ISO (2 letras mai√∫sculas)
- CHECK: `moeda_padrao` formato ISO (3 letras mai√∫sculas)
- CHECK: `nome` pelo menos 2 caracteres

**√çndices:**
- `ix_corretora_usuario_id`
- `ix_corretora_nome`
- `ix_corretora_tipo`
- `ix_corretora_pais`
- `ix_corretora_moeda_padrao`
- `ix_corretora_ativa`

---

### 3. Ativo

**Descri√ß√£o:** Ativos financeiros (a√ß√µes, FIIs, ETFs, etc.)

**Tabela:** `ativo`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ticker` | VARCHAR(20) | C√≥digo do ativo (PETR4, AAPL) |
| `nome` | VARCHAR(200) | Nome completo |
| `tipo` | ENUM(TipoAtivo) | ACAO, FII, ETF, BDR, etc. |
| `classe` | ENUM(ClasseAtivo) | RENDA_VARIAVEL, RENDA_FIXA |
| `mercado` | VARCHAR(10) | Mercado (BR, US, etc.) |
| `moeda` | VARCHAR(3) | Moeda de negocia√ß√£o |
| `preco_atual` | NUMERIC(18,8) | √öltimo pre√ßo |
| `data_ultima_cotacao` | TIMESTAMP | Data da √∫ltima cota√ß√£o |
| `ativo` | BOOLEAN | Se est√° dispon√≠vel |
| `deslistado` | BOOLEAN | Se foi deslistado |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `ticker`, `mercado`
- CHECK: `ticker` pelo menos 1 caractere
- CHECK: `preco_atual` >= 0 (se informado)

**√çndices:**
- `ix_ativo_ticker`
- `ix_ativo_nome`
- `ix_ativo_tipo`
- `ix_ativo_classe`
- `ix_ativo_mercado`
- `ix_ativo_moeda`
- `ix_ativo_ativo`
- `ix_ativo_deslistado`
- `ix_ativo_data_ultima_cotacao`

---

### 4. Posicao

**Descri√ß√£o:** Posi√ß√£o consolidada de um ativo na carteira

**Tabela:** `posicao`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio dono |
| `corretora_id` | UUID | FK - Corretora |
| `ativo_id` | UUID | FK - Ativo |
| `quantidade` | NUMERIC(18,8) | Quantidade de ativos |
| `preco_medio` | NUMERIC(18,8) | Pre√ßo m√©dio de compra |
| `valor_investido` | NUMERIC(18,2) | Custo total |
| `data_primeira_compra` | DATE | Data da primeira compra |
| `data_ultima_atualizacao` | TIMESTAMP | √öltima atualiza√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (CASCADE)
- FOREIGN KEY: `corretora_id` ‚Üí `corretora.id` (CASCADE)
- FOREIGN KEY: `ativo_id` ‚Üí `ativo.id` (RESTRICT)
- UNIQUE: `usuario_id`, `corretora_id`, `ativo_id`
- CHECK: `quantidade` >= 0
- CHECK: `preco_medio` > 0
- CHECK: `valor_investido` >= 0

**√çndices:**
- `ix_posicao_usuario_id`
- `ix_posicao_corretora_id`
- `ix_posicao_ativo_id`
- `ix_posicao_data_primeira_compra`
- `ix_posicao_data_ultima_atualizacao`

---

### 5. Transacao

**Descri√ß√£o:** Opera√ß√µes de compra/venda de ativos

**Tabela:** `transacao`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio |
| `corretora_id` | UUID | FK - Corretora |
| `ativo_id` | UUID | FK - Ativo |
| `tipo_operacao` | ENUM | COMPRA, VENDA, BONIFICACAO, etc. |
| `quantidade` | NUMERIC(18,8) | Quantidade negociada |
| `preco_unitario` | NUMERIC(18,8) | Pre√ßo por ativo |
| `custos_operacao` | NUMERIC(18,2) | Taxas e emolumentos |
| `data_operacao` | DATE | Data da opera√ß√£o |
| `data_liquidacao` | DATE | Data de liquida√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id`, `corretora_id`, `ativo_id`
- CHECK: `quantidade` > 0
- CHECK: `preco_unitario` >= 0
- CHECK: `custos_operacao` >= 0
- CHECK: `data_liquidacao` >= `data_operacao`

**√çndices:**
- `ix_transacao_usuario_id`
- `ix_transacao_corretora_id`
- `ix_transacao_ativo_id`
- `ix_transacao_tipo_operacao`
- `ix_transacao_data_operacao`
- `ix_transacao_data_liquidacao`

---

### 6. Provento

**Descri√ß√£o:** Dividendos, JCP e outros proventos

**Tabela:** `provento`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ativo_id` | UUID | FK - Ativo que pagou |
| `tipo_provento` | ENUM | DIVIDENDO, JCP, RENDIMENTO, etc. |
| `valor_por_acao` | NUMERIC(18,8) | Valor por a√ß√£o/cota |
| `quantidade_ativos` | NUMERIC(18,8) | Qtd de ativos que o usu√°rio tinha |
| `valor_total` | NUMERIC(18,2) | Valor total recebido |
| `imposto_retido` | NUMERIC(18,2) | IR retido na fonte |
| `data_com` | DATE | Data COM |
| `data_pagamento` | DATE | Data de pagamento |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `ativo_id` ‚Üí `ativo.id` (RESTRICT)
- CHECK: `valor_por_acao` >= 0
- CHECK: `quantidade_ativos` > 0
- CHECK: `valor_total` >= 0
- CHECK: `imposto_retido` >= 0
- CHECK: `data_pagamento` >= `data_com`

**√çndices:**
- `ix_provento_ativo_id`
- `ix_provento_tipo_provento`
- `ix_provento_data_com`
- `ix_provento_data_pagamento`

---

### 7. MovimentacaoCaixa

**Descri√ß√£o:** Dep√≥sitos, saques e transfer√™ncias entre corretoras

**Tabela:** `movimentacao_caixa`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio |
| `corretora_id` | UUID | FK - Corretora origem |
| `corretora_destino_id` | UUID | FK - Corretora destino (transfer√™ncias) |
| `provento_id` | UUID | FK - Provento relacionado (se houver) |
| `tipo_movimentacao` | ENUM | DEPOSITO, SAQUE, TRANSFERENCIA, etc. |
| `valor` | NUMERIC(18,2) | Valor da movimenta√ß√£o |
| `moeda` | VARCHAR(3) | Moeda |
| `data_movimentacao` | DATE | Data da movimenta√ß√£o |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `usuario_id`, `corretora_id`, `corretora_destino_id`, `provento_id`
- CHECK: `valor` > 0

**√çndices:**
- `ix_movimentacao_caixa_usuario_id`
- `ix_movimentacao_caixa_corretora_id`
- `ix_movimentacao_caixa_corretora_destino_id`
- `ix_movimentacao_caixa_provento_id`
- `ix_movimentacao_caixa_tipo_movimentacao`
- `ix_movimentacao_caixa_data_movimentacao`
- `ix_movimentacao_caixa_moeda`

---

### 8. EventoCorporativo

**Descri√ß√£o:** Eventos corporativos (splits, grupamentos, etc.)

**Tabela:** `evento_corporativo`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `ativo_id` | UUID | FK - Ativo afetado |
| `ativo_novo_id` | UUID | FK - Novo ativo (fus√µes/cis√µes) |
| `tipo_evento` | ENUM | SPLIT, GRUPAMENTO, BONIFICACAO, etc. |
| `data_evento` | DATE | Data do evento |
| `data_com` | DATE | Data COM |
| `proporcao` | VARCHAR(20) | Propor√ß√£o (ex: 2:1) |
| `descricao` | TEXT | Descri√ß√£o do evento |
| `impacto_posicoes` | BOOLEAN | Se afeta posi√ß√µes |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- FOREIGN KEY: `ativo_id`, `ativo_novo_id` ‚Üí `ativo.id`
- CHECK: `data_com` <= `data_evento` (se informado)

**√çndices:**
- `ix_evento_corporativo_ativo_id`
- `ix_evento_corporativo_ativo_novo_id`
- `ix_evento_corporativo_tipo_evento`
- `ix_evento_corporativo_data_evento`
- `ix_evento_corporativo_data_com`
- `ix_evento_corporativo_impacto_posicoes`

---

### 9. FonteDados

**Descri√ß√£o:** Fontes de dados para cota√ß√µes (APIs)

**Tabela:** `fonte_dados`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `nome` | VARCHAR(100) | Nome da fonte (yfinance, brapi) |
| `tipo_fonte` | ENUM | API, SCRAPING, MANUAL, ARQUIVO |
| `url_base` | VARCHAR(500) | URL base da API |
| `requer_autenticacao` | BOOLEAN | Se requer API key |
| `rate_limit` | VARCHAR(50) | Limite de requisi√ß√µes |
| `ativa` | BOOLEAN | Se est√° ativa |
| `prioridade` | INTEGER | Ordem de prioridade |
| `ultima_consulta` | TIMESTAMP | √öltima consulta realizada |
| `total_consultas` | INTEGER | Total de consultas |
| `total_erros` | INTEGER | Total de erros |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `nome`
- CHECK: `nome` pelo menos 2 caracteres
- CHECK: `prioridade` >= 1

**√çndices:**
- `ix_fonte_dados_nome`
- `ix_fonte_dados_tipo_fonte`
- `ix_fonte_dados_ativa`
- `ix_fonte_dados_prioridade`
- `ix_fonte_dados_ultima_consulta`

---

### 10. RegraFiscal

**Descri√ß√£o:** Regras de tributa√ß√£o (IR)

**Tabela:** `regra_fiscal`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `pais` | VARCHAR(2) | Pa√≠s (c√≥digo ISO) |
| `tipo_ativo` | VARCHAR(50) | Tipo de ativo (ACAO, FII) |
| `tipo_operacao` | VARCHAR(50) | Tipo opera√ß√£o (SWING_TRADE, DAY_TRADE) |
| `aliquota_ir` | NUMERIC(5,4) | Al√≠quota de IR (%) |
| `valor_isencao` | NUMERIC(18,2) | Valor de isen√ß√£o mensal |
| `incide_sobre` | ENUM | LUCRO, PROVENTO, OPERACAO |
| `descricao` | TEXT | Descri√ß√£o da regra |
| `vigencia_inicio` | DATE | In√≠cio da vig√™ncia |
| `vigencia_fim` | DATE | Fim da vig√™ncia |
| `ativa` | BOOLEAN | Se regra est√° ativa |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- CHECK: `pais` formato ISO (2 letras)
- CHECK: `aliquota_ir` >= 0 AND <= 100
- CHECK: `valor_isencao` >= 0 (se informado)
- CHECK: `vigencia_fim` >= `vigencia_inicio` (se informado)

**√çndices:**
- `ix_regra_fiscal_pais`
- `ix_regra_fiscal_tipo_ativo`
- `ix_regra_fiscal_tipo_operacao`
- `ix_regra_fiscal_incide_sobre`
- `ix_regra_fiscal_vigencia_inicio`
- `ix_regra_fiscal_vigencia_fim`
- `ix_regra_fiscal_ativa`

---

### 11. FeriadoMercado

**Descri√ß√£o:** Feriados e dias sem preg√£o

**Tabela:** `feriado_mercado`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `pais` | VARCHAR(2) | Pa√≠s (c√≥digo ISO) |
| `mercado` | VARCHAR(20) | Mercado/bolsa (B3, NYSE) |
| `data_feriado` | DATE | Data do feriado |
| `tipo_feriado` | ENUM | NACIONAL, BOLSA, ANTECIPADO, etc. |
| `nome` | VARCHAR(200) | Nome do feriado |
| `horario_fechamento` | TIME | Hor√°rio de fechamento (se antecipado) |
| `recorrente` | BOOLEAN | Se √© feriado anual fixo |
| `observacoes` | TEXT | Observa√ß√µes |
| `created_at` | TIMESTAMP | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | √öltima atualiza√ß√£o |

**Constraints:**
- UNIQUE: `pais`, `mercado`, `data_feriado`
- CHECK: `pais` formato ISO
- CHECK: `nome` pelo menos 3 caracteres

**√çndices:**
- `ix_feriado_mercado_pais`
- `ix_feriado_mercado_mercado`
- `ix_feriado_mercado_data_feriado`
- `ix_feriado_mercado_tipo_feriado`
- `ix_feriado_mercado_recorrente`

---

### 12. LogAuditoria

**Descri√ß√£o:** Logs de auditoria para compliance

**Tabela:** `log_auditoria`

**Campos:**
| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | PK - Identificador √∫nico |
| `usuario_id` | UUID | FK - Usu√°rio que realizou a√ß√£o |
| `acao` | VARCHAR(50) | Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE) |
| `entidade` | VARCHAR(100) | Entidade afetada (Usuario, Transacao) |
| `entidade_id` | UUID | ID do registro afetado |
| `dados_antes` | JSON | Estado anterior (UPDATE) |
| `dados_depois` | JSON | Estado posterior (UPDATE/CREATE) |
| `ip_address` | VARCHAR(45) | IP de origem |
| `user_agent` | VARCHAR(500) | Navegador/cliente |
| `timestamp` | TIMESTAMP | Data/hora da a√ß√£o |
| `sucesso` | BOOLEAN | Se a√ß√£o foi bem-sucedida |
| `mensagem` | TEXT | Mensagem de erro ou detalhes |

**Constraints:**
- FOREIGN KEY: `usuario_id` ‚Üí `usuario.id` (SET NULL)
- CHECK: `acao` pelo menos 3 caracteres

**√çndices:**
- `ix_log_auditoria_usuario_id`
- `ix_log_auditoria_acao`
- `ix_log_auditoria_entidade`
- `ix_log_auditoria_entidade_id`
- `ix_log_auditoria_timestamp`
- `ix_log_auditoria_sucesso`
- `ix_log_auditoria_ip_address`

---

## üîó Relacionamentos

### Diagrama de Relacionamentos

```
USUARIO (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) CORRETORA
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) LOG_AUDITORIA

CORRETORA (1) ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA

ATIVO (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) POSICAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) TRANSACAO
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) PROVENTO
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) EVENTO_CORPORATIVO

PROVENTO (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) MOVIMENTACAO_CAIXA

EVENTO_CORPORATIVO ‚îÄ‚îÄ‚îÄ (1) ATIVO (ativo_novo_id, opcional)
```

### Pol√≠ticas de DELETE

| Tabela Pai | Tabela Filha | Pol√≠tica |
|------------|--------------|----------|
| `usuario` | `corretora` | CASCADE |
| `usuario` | `posicao` | CASCADE |
| `usuario` | `transacao` | CASCADE |
| `usuario` | `movimentacao_caixa` | CASCADE |
| `usuario` | `log_auditoria` | SET NULL |
| `corretora` | `posicao` | CASCADE |
| `corretora` | `transacao` | CASCADE |
| `ativo` | `posicao` | RESTRICT |
| `ativo` | `transacao` | RESTRICT |
| `ativo` | `provento` | RESTRICT |
| `provento` | `movimentacao_caixa` | SET NULL |

---

## üî¢ Enums e Tipos

### 1. UserRole
```python
ADMIN = "admin"      # Administrador completo
USER = "user"        # Usu√°rio normal
READONLY = "readonly" # Apenas leitura
```

### 2. TipoCorretora
```python
NACIONAL = "nacional"           # Corretora brasileira
INTERNACIONAL = "internacional" # Corretora estrangeira
```

### 3. TipoAtivo
```python
ACAO = "acao"               # A√ß√£o
FII = "fii"                 # Fundo Imobili√°rio
ETF = "etf"                 # Exchange Traded Fund
BDR = "bdr"                 # Brazilian Depositary Receipt
REIT = "reit"               # Real Estate Investment Trust
STOCK = "stock"             # A√ß√£o estrangeira
CRYPTO = "crypto"           # Criptomoeda
RENDA_FIXA = "renda_fixa"   # T√≠tulo de renda fixa
OUTRO = "outro"             # Outros
```

### 4. ClasseAtivo
```python
RENDA_VARIAVEL = "renda_variavel"
RENDA_FIXA = "renda_fixa"
```

### 5. TipoOperacao
```python
COMPRA = "compra"
VENDA = "venda"
BONIFICACAO = "bonificacao"
SUBSCRICAO = "subscricao"
DESDOBRAMENTO = "desdobramento"
GRUPAMENTO = "grupamento"
```

### 6. TipoProvento
```python
DIVIDENDO = "dividendo"
JCP = "jcp"                    # Juros sobre Capital Pr√≥prio
RENDIMENTO = "rendimento"      # Rendimento de FII
BONUS = "bonus"
```

### 7. TipoMovimentacao
```python
DEPOSITO = "deposito"
SAQUE = "saque"
TRANSFERENCIA = "transferencia"
CREDITO_PROVENTO = "credito_provento"
DEBITO_TAXA = "debito_taxa"
```

### 8. TipoEventoCorporativo
```python
SPLIT = "split"               # Desdobramento
GRUPAMENTO = "grupamento"
BONIFICACAO = "bonificacao"
FUSAO = "fusao"
CISAO = "cisao"
INCORPORACAO = "incorporacao"
MUDANCA_TICKER = "mudanca_ticker"
```

### 9. TipoFonteDados
```python
API = "api"
SCRAPING = "scraping"
MANUAL = "manual"
ARQUIVO = "arquivo"
```

### 10. IncidenciaImposto
```python
LUCRO = "lucro"           # IR sobre ganho de capital
PROVENTO = "provento"     # IR sobre dividendos/JCP
OPERACAO = "operacao"     # IR sobre opera√ß√£o (day trade)
```

### 11. TipoFeriado
```python
NACIONAL = "nacional"
BOLSA = "bolsa"
PONTE = "ponte"
FECHAMENTO_ANTECIPADO = "antecip"
MANUTENCAO = "manutencao"
OUTRO = "outro"
```

---

## üìà √çndices e Performance

### √çndices Principais por Tabela

**Total de √≠ndices:** 86

**Distribui√ß√£o:**
- √çndices em foreign keys: 15
- √çndices em campos de busca: 35
- √çndices em campos de data: 20
- √çndices UNIQUE: 8
- Outros √≠ndices: 8

### Estrat√©gias de Indexa√ß√£o

1. **Foreign Keys:** Todas possuem √≠ndice autom√°tico
2. **Campos de Busca Frequente:** `ticker`, `username`, `email`, `nome`
3. **Campos de Filtro:** `ativo`, `tipo`, `mercado`, `pais`
4. **Campos de Ordena√ß√£o:** `data_operacao`, `timestamp`, `prioridade`
5. **Campos UNIQUE:** `username`, `email`, `ticker+mercado`

### Queries Otimizadas

Todos os relacionamentos e buscas frequentes est√£o cobertos por √≠ndices.

---

## üí° Queries √öteis

### 1. Listar todas as tabelas
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema='public' 
AND table_type='BASE TABLE'
ORDER BY table_name;
```

### 2. Ver estrutura de uma tabela
```sql
\d+ usuario
```

### 3. Ver todos os enums
```sql
SELECT typname, enumlabel
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typtype = 'e'
ORDER BY typname, enumsortorder;
```

### 4. Ver todas as foreign keys
```sql
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    rc.delete_rule
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
JOIN information_schema.referential_constraints AS rc
    ON rc.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
ORDER BY tc.table_name;
```

### 5. Ver todos os √≠ndices
```sql
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

### 6. Estat√≠sticas de tabelas
```sql
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    n_tup_ins AS inserts,
    n_tup_upd AS updates,
    n_tup_del AS deletes
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7. Buscar ativos por ticker
```sql
SELECT ticker, nome, tipo, mercado, preco_atual
FROM ativo
WHERE ticker ILIKE '%PETR%'
AND ativo = true
ORDER BY ticker;
```

### 8. Carteira consolidada de um usu√°rio
```sql
SELECT
    a.ticker,
    a.nome,
    p.quantidade,
    p.preco_medio,
    p.valor_investido,
    a.preco_atual,
    (a.preco_atual * p.quantidade) AS valor_atual,
    ((a.preco_atual * p.quantidade) - p.valor_investido) AS lucro_prejuizo
FROM posicao p
JOIN ativo a ON p.ativo_id = a.id
WHERE p.usuario_id = 'uuid-do-usuario'
AND p.quantidade > 0
ORDER BY p.valor_investido DESC;
```

### 9. Hist√≥rico de transa√ß√µes
```sql
SELECT
    t.data_operacao,
    a.ticker,
    t.tipo_operacao,
    t.quantidade,
    t.preco_unitario,
    t.custos_operacao,
    (t.quantidade * t.preco_unitario + t.custos_operacao) AS valor_total
FROM transacao t
JOIN ativo a ON t.ativo_id = a.id
WHERE t.usuario_id = 'uuid-do-usuario'
ORDER BY t.data_operacao DESC
LIMIT 50;
```

### 10. Proventos recebidos no m√™s
```sql
SELECT
    a.ticker,
    p.tipo_provento,
    p.data_pagamento,
    p.valor_total,
    p.imposto_retido,
    (p.valor_total - p.imposto_retido) AS valor_liquido
FROM provento p
JOIN ativo a ON p.ativo_id = a.id
WHERE DATE_TRUNC('month', p.data_pagamento) = DATE_TRUNC('month', CURRENT_DATE)
ORDER BY p.data_pagamento DESC;
```

---

## üìê Diagrama ER

### Diagrama Textual Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      USUARIO        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ
‚îÇ username (UQ)      ‚îÇ
‚îÇ email (UQ)         ‚îÇ
‚îÇ password_hash      ‚îÇ
‚îÇ role               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 1:N
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                      ‚îÇ
           ‚ñº                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     CORRETORA       ‚îÇ  ‚îÇ      POSICAO        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ  ‚îÇ id (PK)            ‚îÇ
‚îÇ usuario_id (FK)    ‚îÇ  ‚îÇ usuario_id (FK)    ‚îÇ
‚îÇ nome               ‚îÇ  ‚îÇ corretora_id (FK)  ‚îÇ
‚îÇ tipo               ‚îÇ  ‚îÇ ativo_id (FK)      ‚îÇ
‚îÇ pais               ‚îÇ  ‚îÇ quantidade         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                        ‚îÇ
           ‚îÇ                        ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
           ‚îÇ                        ‚îÇ
           ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     TRANSACAO       ‚îÇ  ‚îÇ       ATIVO         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)            ‚îÇ  ‚îÇ id (PK)            ‚îÇ
‚îÇ usuario_id (FK)    ‚îÇ  ‚îÇ ticker (UQ)        ‚îÇ
‚îÇ corretora_id (FK)  ‚îÇ  ‚îÇ nome               ‚îÇ
‚îÇ ativo_id (FK)      ‚îÇ  ‚îÇ tipo               ‚îÇ
‚îÇ tipo_operacao      ‚îÇ  ‚îÇ mercado            ‚îÇ
‚îÇ quantidade         ‚îÇ  ‚îÇ preco_atual        ‚îÇ
‚îÇ preco_unitario     ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
                                    ‚îÇ 1:N
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ           ‚îÇ           ‚îÇ
                        ‚ñº           ‚ñº           ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   PROVENTO   ‚îÇ ‚îÇ MOVIMENTACAO ‚îÇ ‚îÇ EVENTO_          ‚îÇ
              ‚îÇ              ‚îÇ ‚îÇ    _CAIXA    ‚îÇ ‚îÇ CORPORATIVO      ‚îÇ
              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
              ‚îÇ id (PK)     ‚îÇ ‚îÇ id (PK)     ‚îÇ ‚îÇ id (PK)         ‚îÇ
              ‚îÇ ativo_id(FK)‚îÇ ‚îÇ usuario_id  ‚îÇ ‚îÇ ativo_id (FK)   ‚îÇ
              ‚îÇ tipo        ‚îÇ ‚îÇ corretora   ‚îÇ ‚îÇ tipo_evento     ‚îÇ
              ‚îÇ valor       ‚îÇ ‚îÇ provento_id ‚îÇ ‚îÇ proporcao       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TABELAS DE REFER√äNCIA                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FONTE_DADOS   ‚îÇ  REGRA_FISCAL  ‚îÇ  FERIADO_MERCADO          ‚îÇ
‚îÇ  LOG_AUDITORIA ‚îÇ                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Boas Pr√°ticas

### 1. Uso de UUIDs

Todas as PKs s√£o UUIDs para:
- Evitar exposi√ß√£o de IDs sequenciais
- Facilitar merge de bancos
- Seguran√ßa adicional

### 2. Timestamps

Todas as tabelas t√™m `created_at` e `updated_at` para auditoria.

### 3. Soft Delete

Tabelas principais usam flag `ativo` ao inv√©s de DELETE f√≠sico.

### 4. Constraints

Uso extensivo de:
- CHECK constraints para valida√ß√£o
- UNIQUE constraints para integridade
- Foreign keys com pol√≠ticas apropriadas

### 5. √çndices

√çndices em:
- Todas as foreign keys
- Campos de busca frequente
- Campos de ordena√ß√£o
- Campos de filtro

### 6. Normaliza√ß√£o

Banco normalizado (3FN) com desnormaliza√ß√µes estrat√©gicas:
- `preco_atual` em `ativo` (cache)
- `valor_total` em `provento` (calculado)

### 7. Tipos de Dados

- `NUMERIC` para valores monet√°rios (evita erros de arredondamento)
- `DATE` para datas puras
- `TIMESTAMP` para data+hora
- `VARCHAR` com limites apropriados
- `TEXT` para campos sem limite
- `BOOLEAN` para flags
- `JSON` para dados semi-estruturados

### 8. Nomenclatura

- Tabelas: singular, snake_case
- Colunas: snake_case
- Enums: UPPERCASE
- Foreign keys: `<tabela>_id`

---

## üîí Seguran√ßa

### 1. Senhas

- Armazenadas com hash bcrypt
- Nunca expor `password_hash` em APIs

### 2. SQL Injection

- Uso exclusivo de ORM (SQLAlchemy)
- Queries parametrizadas

### 3. Auditoria

- Tabela `log_auditoria` registra todas as a√ß√µes
- IP e user-agent salvos

### 4. Roles

- Sistema de permiss√µes baseado em roles
- ADMIN, USER, READONLY

---

## üìä Performance

### Otimiza√ß√µes Implementadas

1. ‚úÖ √çndices em foreign keys
2. ‚úÖ √çndices em campos de busca
3. ‚úÖ √çndices compostos quando necess√°rio
4. ‚úÖ Connection pooling (SQLAlchemy)
5. ‚úÖ Lazy loading de relacionamentos
6. ‚úÖ Eager loading quando apropriado (joined)

### Monitoramento

```sql
-- Ver queries lentas
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- Ver tamanho das tabelas
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## üéØ Conclus√£o

O banco de dados do Exitus foi projetado para:

‚úÖ **Escalabilidade:** Suporta milh√µes de registros  
‚úÖ **Performance:** √çndices e queries otimizadas  
‚úÖ **Integridade:** Constraints e foreign keys  
‚úÖ **Auditoria:** Log completo de a√ß√µes  
‚úÖ **Seguran√ßa:** Hashing, roles, valida√ß√µes  
‚úÖ **Manutenibilidade:** C√≥digo limpo e documentado  

---

**Vers√£o:** 1.0  
**Data:** Novembro 2025  
**Autor:** Equipe Exitus

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/exitus_db_doc.sh ---
#!/bin/bash

# Script para documentar estrutura completa do banco exitus-db
# Gera arquivo texto com todas as tabelas, colunas, PKs, FKs e constraints
# Autor: Sistema Exitus
# Data: 2025-12-02

# Configura√ß√µes do ambiente
DB_CONTAINER="exitus-db"
DB_NAME="exitus"
DB_USER="exitus_user"
OUTPUT_FILE="exitus_db_structure_$(date +%Y%m%d_%H%M%S).txt"

# Cores para output (opcional, comentar se preferir sem cores)
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  EXITUS - Documenta√ß√£o da Estrutura do Banco${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Verifica se o container est√° rodando
if ! podman ps | grep -q "$DB_CONTAINER"; then
    echo -e "${YELLOW}AVISO: Container $DB_CONTAINER n√£o est√° rodando!${NC}"
    echo "Execute: podman start $DB_CONTAINER"
    exit 1
fi

echo -e "${GREEN}‚úì Container $DB_CONTAINER est√° online${NC}"
echo -e "Gerando documenta√ß√£o em: ${YELLOW}$OUTPUT_FILE${NC}"
echo ""

# Cria o arquivo de sa√≠da com cabe√ßalho
cat > "$OUTPUT_FILE" << EOF
================================================================================
EXITUS - ESTRUTURA DO BANCO DE DADOS
================================================================================
Database: $DB_NAME
Gerado em: $(date '+%Y-%m-%d %H:%M:%S')
================================================================================

EOF

# SQL para listar todas as tabelas do schema public
echo "Coletando lista de tabelas..." 
podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"
\echo '================================================================================'
\echo 'TABELAS DO BANCO EXITUS'
\echo '================================================================================'
\echo ''

SELECT 
    schemaname as "Schema",
    tablename as "Tabela",
    tableowner as "Owner"
FROM pg_catalog.pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;

\echo ''
EOSQL

# SQL para estrutura detalhada de cada tabela
echo "Coletando estrutura detalhada das tabelas..."
podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"

\echo '================================================================================'
\echo 'ESTRUTURA DETALHADA DAS TABELAS'
\echo '================================================================================'
\echo ''

-- Para cada tabela, mostra estrutura completa
DO $$
DECLARE
    tbl_name text;
BEGIN
    FOR tbl_name IN 
        SELECT tablename 
        FROM pg_catalog.pg_tables 
        WHERE schemaname = 'public'
        ORDER BY tablename
    LOOP
        RAISE NOTICE '';
        RAISE NOTICE '################################################################################';
        RAISE NOTICE 'TABELA: %', tbl_name;
        RAISE NOTICE '################################################################################';
        RAISE NOTICE '';
    END LOOP;
END $$;

EOSQL

# Para cada tabela, executa \d+ e informa√ß√µes adicionais
echo "Coletando detalhes de colunas, PKs e FKs..."
TABLES=$(podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -t -c "SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public' ORDER BY tablename;")

for table in $TABLES; do
    # Remove espa√ßos em branco
    table=$(echo "$table" | xargs)
    
    echo "  - Processando tabela: $table"
    
    cat >> "$OUTPUT_FILE" << EOF

################################################################################
TABELA: $table
################################################################################

EOF

    # Usa \d+ para mostrar estrutura completa da tabela
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"
\d+ $table

EOSQL

    # Query customizada para mostrar colunas com detalhes
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Detalhes das Colunas
SELECT 
    ordinal_position as "Pos",
    column_name as "Coluna",
    data_type as "Tipo",
    CASE 
        WHEN character_maximum_length IS NOT NULL 
        THEN '(' || character_maximum_length || ')'
        ELSE ''
    END as "Tamanho",
    is_nullable as "Null?",
    column_default as "Default"
FROM information_schema.columns
WHERE table_schema = 'public' 
    AND table_name = '$table'
ORDER BY ordinal_position;

EOSQL

    # Query para mostrar Foreign Keys
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Foreign Keys (FKs)
\echo ''
\echo 'Foreign Keys:'
SELECT
    tc.constraint_name as "Nome FK",
    kcu.column_name as "Coluna",
    ccu.table_name AS "Tabela Referenciada",
    ccu.column_name AS "Coluna Referenciada"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Primary Keys
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Primary Keys (PKs)
\echo ''
\echo 'Primary Keys:'
SELECT
    tc.constraint_name as "Nome PK",
    kcu.column_name as "Coluna"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
WHERE tc.constraint_type = 'PRIMARY KEY' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Unique Constraints
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Unique Constraints
\echo ''
\echo 'Unique Constraints:'
SELECT
    tc.constraint_name as "Nome Constraint",
    kcu.column_name as "Coluna"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
WHERE tc.constraint_type = 'UNIQUE' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Indexes
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- √çndices
\echo ''
\echo '√çndices:'
SELECT
    indexname as "Nome do √çndice",
    indexdef as "Defini√ß√£o"
FROM pg_indexes
WHERE schemaname = 'public'
    AND tablename = '$table';

\echo ''
\echo '________________________________________________________________________________'
\echo ''

EOSQL

done

# Adiciona resumo ao final
cat >> "$OUTPUT_FILE" << EOF

================================================================================
RESUMO GERAL
================================================================================

EOF

podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"

-- Contagem de tabelas
\echo 'Total de Tabelas:'
SELECT COUNT(*) as "Total" 
FROM pg_catalog.pg_tables 
WHERE schemaname = 'public';

\echo ''
\echo 'Total de Colunas por Tabela:'
SELECT 
    table_name as "Tabela",
    COUNT(*) as "Num Colunas"
FROM information_schema.columns
WHERE table_schema = 'public'
GROUP BY table_name
ORDER BY table_name;

\echo ''
\echo 'Total de Foreign Keys por Tabela:'
SELECT
    tc.table_name as "Tabela",
    COUNT(*) as "Num FKs"
FROM information_schema.table_constraints AS tc 
WHERE tc.constraint_type = 'FOREIGN KEY' 
    AND tc.table_schema = 'public'
GROUP BY tc.table_name
ORDER BY tc.table_name;

EOSQL

# Finaliza o arquivo
cat >> "$OUTPUT_FILE" << EOF

================================================================================
FIM DA DOCUMENTA√á√ÉO
================================================================================
EOF

echo ""
echo -e "${GREEN}‚úì Documenta√ß√£o gerada com sucesso!${NC}"
echo -e "${BLUE}Arquivo: ${YELLOW}$OUTPUT_FILE${NC}"
echo ""
echo -e "${BLUE}Para visualizar:${NC}"
echo -e "  cat $OUTPUT_FILE"
echo -e "  less $OUTPUT_FILE"
echo -e "  code $OUTPUT_FILE  ${BLUE}# (se estiver usando VSCode)${NC}"
echo ""
echo -e "${GREEN}Pronto para compartilhar o status do banco! üéØ${NC}"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/exitus_db_structure_20251202_123453.txt ---
================================================================================
EXITUS - ESTRUTURA DO BANCO DE DADOS
================================================================================
Database: exitus
Gerado em: 2025-12-02 12:34:53
================================================================================


================================================================================
RESUMO GERAL
================================================================================


================================================================================
FIM DA DOCUMENTA√á√ÉO
================================================================================

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.development.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.production.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.staging.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/modulo0_fontes.txt ---
====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
!frontend/.env.example
!backend/.env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/all_git_files_concatenated.txt ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/test_module0.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/modulo1_fontes.txt ---
====================================================
--- ARQUIVO: /home/p016525/elielson/exitus/.gitignore ---
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example*
!frontend/.env.*example*
!backend/.env.*example*
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/README.md ---
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |
-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0](docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.development.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.production.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/.env.staging.example ---
# Backend Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic.ini ---
# A generic, single database configuration.

[alembic]
# path to migration scripts
script_location = alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the
# "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:alembic/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
version_path_separator = os  # Use os.pathsep. Default configuration used for new projects.

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = driver://user:pass@localhost/dbname


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/README ---
Generic single-database configuration.
====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py ---
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# Adicionar path do app
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

# Importar a aplica√ß√£o Flask e o db
from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Criar aplica√ß√£o Flask e obter metadata
app = create_app()
with app.app_context():
    # Garantir que todos os models sejam importados
    from app.models import (
        Usuario, Corretora, Ativo, Posicao, Transacao,
        Provento, MovimentacaoCaixa, EventoCorporativo,
        FonteDados, RegraFiscal, FeriadoMercado, LogAuditoria
    )
    target_metadata = db.metadata
    
# Configurar URL do banco
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/env.py.back ---
# backend/alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context

# ADICIONAR ESTAS LINHAS:
import sys
import os
sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app
from app.database import db

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ADICIONAR ESTA LINHA:
# Configurar a URL do banco a partir da aplica√ß√£o Flask
app = create_app()
config.set_main_option('sqlalchemy.url', app.config['SQLALCHEMY_DATABASE_URI'])

# add your model's MetaData object here
# SUBSTITUIR por:
target_metadata = db.metadata

# ... resto do arquivo permanece igual

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/script.py.mako ---
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/alembic/versions/b2542b2f7857_initial_schema_12_models.py ---
"""Initial schema - 12 models

Revision ID: b2542b2f7857
Revises: 
Create Date: 2025-11-26 19:40:34.891548

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b2542b2f7857'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do ativo'),
    sa.Column('ticker', sa.String(length=20), nullable=False, comment='C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome completo do ativo'),
    sa.Column('tipo', sa.Enum('ACAO', 'FII', 'REIT', 'BOND', 'ETF', 'CRIPTO', 'OUTRO', name='tipoativo'), nullable=False, comment='Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)'),
    sa.Column('classe', sa.Enum('RENDA_VARIAVEL', 'RENDA_FIXA', 'CRIPTO', 'HIBRIDO', name='classeativo'), nullable=False, comment='Classe do ativo (renda vari√°vel, fixa, cripto)'),
    sa.Column('mercado', sa.String(length=10), nullable=False, comment='Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='Moeda de negocia√ß√£o (BRL, USD, EUR)'),
    sa.Column('preco_atual', sa.Numeric(precision=18, scale=6), nullable=True, comment='Pre√ßo/cota√ß√£o atual do ativo'),
    sa.Column('data_ultima_cotacao', sa.DateTime(timezone=True), nullable=True, comment='Data e hora da √∫ltima cota√ß√£o'),
    sa.Column('dividend_yield', sa.Numeric(precision=8, scale=4), nullable=True, comment='Dividend Yield em % (ex: 6.5000 = 6.5%)'),
    sa.Column('p_l', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Lucro'),
    sa.Column('p_vp', sa.Numeric(precision=10, scale=2), nullable=True, comment='√çndice Pre√ßo/Valor Patrimonial'),
    sa.Column('roe', sa.Numeric(precision=8, scale=4), nullable=True, comment='Return on Equity em %'),
    sa.Column('ativo', sa.Boolean(), nullable=False, comment='Indica se ativo est√° dispon√≠vel para negocia√ß√£o'),
    sa.Column('deslistado', sa.Boolean(), nullable=False, comment='Indica se ativo foi deslistado da bolsa'),
    sa.Column('data_deslistagem', sa.Date(), nullable=True, comment='Data de deslistagem (se aplic√°vel)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas sobre o ativo'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='ativo_nome_min_length'),
    sa.CheckConstraint('length(ticker) >= 1', name='ativo_ticker_min_length'),
    sa.CheckConstraint('preco_atual IS NULL OR preco_atual >= 0', name='ativo_preco_positivo'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ticker', 'mercado', name='unique_ativo_ticker_mercado'),
    comment='Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'
    )
    op.create_index(op.f('ix_ativo_ativo'), 'ativo', ['ativo'], unique=False)
    op.create_index(op.f('ix_ativo_classe'), 'ativo', ['classe'], unique=False)
    op.create_index(op.f('ix_ativo_data_ultima_cotacao'), 'ativo', ['data_ultima_cotacao'], unique=False)
    op.create_index(op.f('ix_ativo_deslistado'), 'ativo', ['deslistado'], unique=False)
    op.create_index(op.f('ix_ativo_mercado'), 'ativo', ['mercado'], unique=False)
    op.create_index(op.f('ix_ativo_moeda'), 'ativo', ['moeda'], unique=False)
    op.create_index(op.f('ix_ativo_nome'), 'ativo', ['nome'], unique=False)
    op.create_index(op.f('ix_ativo_ticker'), 'ativo', ['ticker'], unique=False)
    op.create_index(op.f('ix_ativo_tipo'), 'ativo', ['tipo'], unique=False)
    op.create_table('feriado_mercado',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do feriado'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('mercado', sa.String(length=20), nullable=True, comment='Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos'),
    sa.Column('data_feriado', sa.Date(), nullable=False, comment='Data do feriado'),
    sa.Column('tipo_feriado', sa.Enum('NACIONAL', 'BOLSA', 'PONTE', 'FECHAMENTO_ANTECIPADO', 'MANUTENCAO', 'OUTRO', name='tipoferiado'), nullable=False, comment='Tipo do feriado'),
    sa.Column('nome', sa.String(length=200), nullable=False, comment='Nome do feriado'),
    sa.Column('horario_fechamento', sa.Time(), nullable=True, comment='Hor√°rio de fechamento antecipado (se aplic√°vel)'),
    sa.Column('recorrente', sa.Boolean(), nullable=False, comment='Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o feriado'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='feriado_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 3', name='feriado_nome_min_length'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('pais', 'mercado', 'data_feriado', name='unique_feriado_pais_mercado_data'),
    comment='Tabela de feriados e dias sem preg√£o nos mercados'
    )
    op.create_index(op.f('ix_feriado_mercado_data_feriado'), 'feriado_mercado', ['data_feriado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_mercado'), 'feriado_mercado', ['mercado'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_pais'), 'feriado_mercado', ['pais'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_recorrente'), 'feriado_mercado', ['recorrente'], unique=False)
    op.create_index(op.f('ix_feriado_mercado_tipo_feriado'), 'feriado_mercado', ['tipo_feriado'], unique=False)
    op.create_table('fonte_dados',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da fonte'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da fonte de dados (ex: yfinance, Alpha Vantage)'),
    sa.Column('tipo_fonte', sa.Enum('API', 'SCRAPER', 'MANUAL', 'ARQUIVO', 'OUTRO', name='tipofontedados'), nullable=False, comment='Tipo da fonte de dados'),
    sa.Column('url_base', sa.String(length=500), nullable=True, comment='URL base da API ou site'),
    sa.Column('requer_autenticacao', sa.Boolean(), nullable=False, comment='Indica se requer chave API ou autentica√ß√£o'),
    sa.Column('rate_limit', sa.String(length=50), nullable=True, comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se fonte est√° ativa'),
    sa.Column('prioridade', sa.Integer(), nullable=False, comment='Ordem de prioridade (1 = maior prioridade)'),
    sa.Column('ultima_consulta', sa.DateTime(timezone=True), nullable=True, comment='Timestamp da √∫ltima consulta bem-sucedida'),
    sa.Column('total_consultas', sa.Integer(), nullable=False, comment='Total de consultas realizadas'),
    sa.Column('total_erros', sa.Integer(), nullable=False, comment='Total de erros encontrados'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a fonte de dados'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('length(nome) >= 2', name='fonte_nome_min_length'),
    sa.CheckConstraint('prioridade > 0', name='fonte_prioridade_positiva'),
    sa.CheckConstraint('total_consultas >= 0', name='fonte_consultas_positivas'),
    sa.CheckConstraint('total_erros >= 0', name='fonte_erros_positivos'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de fontes de dados externas (APIs, scrapers)'
    )
    op.create_index(op.f('ix_fonte_dados_ativa'), 'fonte_dados', ['ativa'], unique=False)
    op.create_index(op.f('ix_fonte_dados_nome'), 'fonte_dados', ['nome'], unique=True)
    op.create_index(op.f('ix_fonte_dados_prioridade'), 'fonte_dados', ['prioridade'], unique=False)
    op.create_index(op.f('ix_fonte_dados_tipo_fonte'), 'fonte_dados', ['tipo_fonte'], unique=False)
    op.create_index(op.f('ix_fonte_dados_ultima_consulta'), 'fonte_dados', ['ultima_consulta'], unique=False)
    op.create_table('regra_fiscal',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da regra'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO do pa√≠s (BR, US, etc.)'),
    sa.Column('tipo_ativo', sa.String(length=20), nullable=True, comment='Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos'),
    sa.Column('tipo_operacao', sa.String(length=20), nullable=True, comment='Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas'),
    sa.Column('aliquota_ir', sa.Numeric(precision=6, scale=4), nullable=False, comment='Al√≠quota de IR em % (ex: 15.0000 = 15%)'),
    sa.Column('valor_isencao', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)'),
    sa.Column('incide_sobre', sa.Enum('LUCRO', 'RECEITA', 'PROVENTO', 'OPERACAO', name='incidenciaimposto'), nullable=False, comment='Sobre o que incide o imposto'),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada da regra fiscal'),
    sa.Column('vigencia_inicio', sa.Date(), nullable=False, comment='Data de in√≠cio da vig√™ncia da regra'),
    sa.Column('vigencia_fim', sa.Date(), nullable=True, comment='Data de fim da vig√™ncia (NULL = vigente indefinidamente)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se regra est√° ativa'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='regra_pais_iso_format'),
    sa.CheckConstraint('aliquota_ir >= 0 AND aliquota_ir <= 100', name='regra_aliquota_valida'),
    sa.CheckConstraint('valor_isencao IS NULL OR valor_isencao >= 0', name='regra_isencao_positiva'),
    sa.CheckConstraint('vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio', name='regra_vigencia_valida'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'
    )
    op.create_index(op.f('ix_regra_fiscal_ativa'), 'regra_fiscal', ['ativa'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_incide_sobre'), 'regra_fiscal', ['incide_sobre'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_pais'), 'regra_fiscal', ['pais'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_ativo'), 'regra_fiscal', ['tipo_ativo'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_tipo_operacao'), 'regra_fiscal', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_fim'), 'regra_fiscal', ['vigencia_fim'], unique=False)
    op.create_index(op.f('ix_regra_fiscal_vigencia_inicio'), 'regra_fiscal', ['vigencia_inicio'], unique=False)
    op.create_table('usuario',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('username', sa.String(length=50), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('nome_completo', sa.String(length=200), nullable=True),
    sa.Column('ativo', sa.Boolean(), nullable=False),
    sa.Column('role', sa.Enum('ADMIN', 'USER', 'READONLY', name='userrole'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_usuario_email'), 'usuario', ['email'], unique=True)
    op.create_index(op.f('ix_usuario_username'), 'usuario', ['username'], unique=True)
    op.create_table('corretora',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da corretora'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('nome', sa.String(length=100), nullable=False, comment='Nome da corretora/exchange (ex: XP, Clear, Binance)'),
    sa.Column('tipo', sa.Enum('CORRETORA', 'EXCHANGE', name='tipocorretora'), nullable=False, comment='Tipo: corretora tradicional ou exchange cripto'),
    sa.Column('pais', sa.String(length=2), nullable=False, comment='C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)'),
    sa.Column('moeda_padrao', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('saldo_atual', sa.Numeric(precision=18, scale=2), nullable=False, comment='Saldo dispon√≠vel em caixa (na moeda padr√£o)'),
    sa.Column('ativa', sa.Boolean(), nullable=False, comment='Indica se conta est√° ativa'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes e notas do usu√°rio sobre a conta'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint("moeda_padrao ~* '^[A-Z]{3}$'", name='corretora_moeda_iso_format'),
    sa.CheckConstraint("pais ~* '^[A-Z]{2}$'", name='corretora_pais_iso_format'),
    sa.CheckConstraint('length(nome) >= 2', name='corretora_nome_min_length'),
    sa.CheckConstraint('saldo_atual >= 0', name='corretora_saldo_positivo'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'nome', 'pais', name='unique_corretora_usuario_nome_pais'),
    comment='Tabela de corretoras e contas de investimento'
    )
    op.create_index(op.f('ix_corretora_ativa'), 'corretora', ['ativa'], unique=False)
    op.create_index(op.f('ix_corretora_moeda_padrao'), 'corretora', ['moeda_padrao'], unique=False)
    op.create_index(op.f('ix_corretora_nome'), 'corretora', ['nome'], unique=False)
    op.create_index(op.f('ix_corretora_pais'), 'corretora', ['pais'], unique=False)
    op.create_index(op.f('ix_corretora_tipo'), 'corretora', ['tipo'], unique=False)
    op.create_index(op.f('ix_corretora_usuario_id'), 'corretora', ['usuario_id'], unique=False)
    op.create_table('evento_corporativo',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do evento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo afetado pelo evento'),
    sa.Column('ativo_novo_id', sa.UUID(), nullable=True, comment='ID do novo ativo (fus√µes, mudan√ßas de ticker)'),
    sa.Column('tipo_evento', sa.Enum('SPLIT', 'GRUPAMENTO', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'FUSAO', 'CISAO', 'INCORPORACAO', 'MUDANCA_TICKER', 'DESLISTAGEM', 'RELISTING', 'CANCELAMENTO', 'OUTRO', name='tipoeventocorporativo'), nullable=False, comment='Tipo do evento corporativo'),
    sa.Column('data_evento', sa.Date(), nullable=False, comment='Data do evento'),
    sa.Column('data_com', sa.Date(), nullable=True, comment='Data COM (√∫ltimo dia para ter direito ao evento)'),
    sa.Column('proporcao', sa.String(length=20), nullable=True, comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"),
    sa.Column('descricao', sa.Text(), nullable=False, comment='Descri√ß√£o detalhada do evento'),
    sa.Column('impacto_posicoes', sa.Boolean(), nullable=False, comment='Indica se as posi√ß√µes j√° foram ajustadas'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes adicionais sobre o evento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)\n            OR \n            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))\n            ", name='evento_proporcao_obrigatoria'),
    sa.CheckConstraint('data_com IS NULL OR data_com <= data_evento', name='evento_data_com_valida'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['ativo_novo_id'], ['ativo.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de eventos corporativos que afetam ativos'
    )
    op.create_index(op.f('ix_evento_corporativo_ativo_id'), 'evento_corporativo', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_ativo_novo_id'), 'evento_corporativo', ['ativo_novo_id'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_com'), 'evento_corporativo', ['data_com'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_data_evento'), 'evento_corporativo', ['data_evento'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_impacto_posicoes'), 'evento_corporativo', ['impacto_posicoes'], unique=False)
    op.create_index(op.f('ix_evento_corporativo_tipo_evento'), 'evento_corporativo', ['tipo_evento'], unique=False)
    op.create_table('log_auditoria',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do log'),
    sa.Column('usuario_id', sa.UUID(), nullable=True, comment='ID do usu√°rio (NULL para a√ß√µes an√¥nimas)'),
    sa.Column('acao', sa.String(length=50), nullable=False, comment='Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)'),
    sa.Column('entidade', sa.String(length=100), nullable=True, comment='Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)'),
    sa.Column('entidade_id', sa.UUID(), nullable=True, comment='ID do registro afetado'),
    sa.Column('dados_antes', sa.JSON(), nullable=True, comment='Estado anterior do registro (JSON)'),
    sa.Column('dados_depois', sa.JSON(), nullable=True, comment='Estado posterior do registro (JSON)'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='Endere√ßo IP de origem'),
    sa.Column('user_agent', sa.String(length=500), nullable=True, comment='User-Agent (navegador/cliente)'),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False, comment='Data/hora da a√ß√£o'),
    sa.Column('sucesso', sa.Boolean(), nullable=False, comment='Indica se a√ß√£o foi bem-sucedida'),
    sa.Column('mensagem', sa.Text(), nullable=True, comment='Mensagem de erro ou detalhes adicionais'),
    sa.CheckConstraint('length(acao) >= 3', name='log_acao_min_length'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de logs de auditoria para compliance'
    )
    op.create_index(op.f('ix_log_auditoria_acao'), 'log_auditoria', ['acao'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade'), 'log_auditoria', ['entidade'], unique=False)
    op.create_index(op.f('ix_log_auditoria_entidade_id'), 'log_auditoria', ['entidade_id'], unique=False)
    op.create_index(op.f('ix_log_auditoria_ip_address'), 'log_auditoria', ['ip_address'], unique=False)
    op.create_index(op.f('ix_log_auditoria_sucesso'), 'log_auditoria', ['sucesso'], unique=False)
    op.create_index(op.f('ix_log_auditoria_timestamp'), 'log_auditoria', ['timestamp'], unique=False)
    op.create_index(op.f('ix_log_auditoria_usuario_id'), 'log_auditoria', ['usuario_id'], unique=False)
    op.create_table('provento',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico do provento'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo que pagou o provento'),
    sa.Column('tipo_provento', sa.Enum('DIVIDENDO', 'JCP', 'RENDIMENTO', 'CUPOM', 'BONIFICACAO', 'DIREITO_SUBSCRICAO', 'OUTRO', name='tipoprovento'), nullable=False, comment='Tipo do provento (dividendo, JCP, rendimento, etc.)'),
    sa.Column('valor_por_acao', sa.Numeric(precision=18, scale=6), nullable=False, comment='Valor unit√°rio por ativo'),
    sa.Column('quantidade_ativos', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos que geraram o provento'),
    sa.Column('valor_bruto', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor bruto recebido'),
    sa.Column('imposto_retido', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte'),
    sa.Column('valor_liquido', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor l√≠quido creditado'),
    sa.Column('data_com', sa.Date(), nullable=False, comment='Data COM (√∫ltimo dia para ter direito ao provento)'),
    sa.Column('data_pagamento', sa.Date(), nullable=False, comment='Data efetiva do pagamento'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre o provento'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_pagamento >= data_com', name='provento_data_pagamento_valida'),
    sa.CheckConstraint('imposto_retido >= 0', name='provento_imposto_positivo'),
    sa.CheckConstraint('quantidade_ativos > 0', name='provento_quantidade_positiva'),
    sa.CheckConstraint('valor_bruto > 0', name='provento_valor_bruto_positivo'),
    sa.CheckConstraint('valor_liquido <= valor_bruto', name='provento_liquido_menor_bruto'),
    sa.CheckConstraint('valor_liquido > 0', name='provento_valor_liquido_positivo'),
    sa.CheckConstraint('valor_por_acao > 0', name='provento_valor_por_acao_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de proventos recebidos (dividendos, JCP, rendimentos)'
    )
    op.create_index(op.f('ix_provento_ativo_id'), 'provento', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_provento_data_com'), 'provento', ['data_com'], unique=False)
    op.create_index(op.f('ix_provento_data_pagamento'), 'provento', ['data_pagamento'], unique=False)
    op.create_index(op.f('ix_provento_tipo_provento'), 'provento', ['tipo_provento'], unique=False)
    op.create_table('movimentacao_caixa',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da movimenta√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora (origem)'),
    sa.Column('corretora_destino_id', sa.UUID(), nullable=True, comment='ID da corretora destino (apenas para transfer√™ncias)'),
    sa.Column('provento_id', sa.UUID(), nullable=True, comment='ID do provento (apenas para cr√©dito de provento)'),
    sa.Column('tipo_movimentacao', sa.Enum('DEPOSITO', 'SAQUE', 'TRANSFERENCIA_ENVIADA', 'TRANSFERENCIA_RECEBIDA', 'CREDITO_PROVENTO', 'PAGAMENTO_TAXA', 'PAGAMENTO_IMPOSTO', 'AJUSTE', 'OUTRO', name='tipomovimentacao'), nullable=False, comment='Tipo da movimenta√ß√£o'),
    sa.Column('valor', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor da movimenta√ß√£o'),
    sa.Column('moeda', sa.String(length=3), nullable=False, comment='C√≥digo ISO 4217 da moeda (BRL, USD, EUR)'),
    sa.Column('data_movimentacao', sa.Date(), nullable=False, comment='Data da movimenta√ß√£o'),
    sa.Column('descricao', sa.Text(), nullable=True, comment='Descri√ß√£o da movimenta√ß√£o'),
    sa.Column('comprovante', sa.String(length=200), nullable=True, comment='Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    #sa.CheckConstraint("\n            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)\n            OR \n            (tipo_movimentacao != 'credito_provento')\n            ", name='movimentacao_credito_tem_provento'),
    #sa.CheckConstraint("\n            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') \n             AND corretora_destino_id IS NOT NULL)\n            OR \n            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))\n            ", name='movimentacao_transferencia_tem_destino'),
    sa.CheckConstraint("moeda ~* '^[A-Z]{3}$'", name='movimentacao_moeda_iso_format'),
    sa.CheckConstraint('valor > 0', name='movimentacao_valor_positivo'),
    sa.ForeignKeyConstraint(['corretora_destino_id'], ['corretora.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provento_id'], ['provento.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de movimenta√ß√µes de caixa em corretoras'
    )
    op.create_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), 'movimentacao_caixa', ['corretora_destino_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_corretora_id'), 'movimentacao_caixa', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_data_movimentacao'), 'movimentacao_caixa', ['data_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_moeda'), 'movimentacao_caixa', ['moeda'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_provento_id'), 'movimentacao_caixa', ['provento_id'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), 'movimentacao_caixa', ['tipo_movimentacao'], unique=False)
    op.create_index(op.f('ix_movimentacao_caixa_usuario_id'), 'movimentacao_caixa', ['usuario_id'], unique=False)
    op.create_table('posicao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da posi√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio propriet√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora onde est√° a posi√ß√£o'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade de ativos (suporta fracion√°rios)'),
    sa.Column('preco_medio', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo m√©dio de aquisi√ß√£o'),
    sa.Column('custo_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Custo total investido (quantidade * pre√ßo m√©dio)'),
    sa.Column('taxas_acumuladas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem e cust√≥dia acumuladas'),
    sa.Column('impostos_acumulados', sa.Numeric(precision=18, scale=2), nullable=False, comment='Impostos pagos acumulados (IR, IOF, etc.)'),
    sa.Column('valor_atual', sa.Numeric(precision=18, scale=2), nullable=True, comment='Valor de mercado atual da posi√ß√£o'),
    sa.Column('lucro_prejuizo_realizado', sa.Numeric(precision=18, scale=2), nullable=False, comment='Lucro/preju√≠zo realizado em vendas'),
    sa.Column('lucro_prejuizo_nao_realizado', sa.Numeric(precision=18, scale=2), nullable=True, comment='Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)'),
    sa.Column('data_primeira_compra', sa.Date(), nullable=True, comment='Data da primeira aquisi√ß√£o deste ativo'),
    sa.Column('data_ultima_atualizacao', sa.DateTime(timezone=True), nullable=True, comment='Data da √∫ltima atualiza√ß√£o de valores'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('custo_total >= 0', name='posicao_custo_total_positivo'),
    sa.CheckConstraint('impostos_acumulados >= 0', name='posicao_impostos_positivos'),
    sa.CheckConstraint('preco_medio >= 0', name='posicao_preco_medio_positivo'),
    sa.CheckConstraint('quantidade >= 0', name='posicao_quantidade_positiva'),
    sa.CheckConstraint('taxas_acumuladas >= 0', name='posicao_taxas_positivas'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('usuario_id', 'corretora_id', 'ativo_id', name='unique_posicao_usuario_corretora_ativo'),
    comment='Tabela de posi√ß√µes em carteira (holdings)'
    )
    op.create_index(op.f('ix_posicao_ativo_id'), 'posicao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_posicao_corretora_id'), 'posicao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_posicao_data_primeira_compra'), 'posicao', ['data_primeira_compra'], unique=False)
    op.create_index(op.f('ix_posicao_data_ultima_atualizacao'), 'posicao', ['data_ultima_atualizacao'], unique=False)
    op.create_index(op.f('ix_posicao_usuario_id'), 'posicao', ['usuario_id'], unique=False)
    op.create_table('transacao',
    sa.Column('id', sa.UUID(), nullable=False, comment='Identificador √∫nico da transa√ß√£o'),
    sa.Column('usuario_id', sa.UUID(), nullable=False, comment='ID do usu√°rio'),
    sa.Column('corretora_id', sa.UUID(), nullable=False, comment='ID da corretora'),
    sa.Column('ativo_id', sa.UUID(), nullable=False, comment='ID do ativo transacionado'),
    sa.Column('tipo_operacao', sa.Enum('COMPRA', 'VENDA', name='tipooperacao'), nullable=False, comment='Tipo de opera√ß√£o: COMPRA ou VENDA'),
    sa.Column('quantidade', sa.Numeric(precision=18, scale=8), nullable=False, comment='Quantidade transacionada (suporta fracion√°rios)'),
    sa.Column('preco_unitario', sa.Numeric(precision=18, scale=6), nullable=False, comment='Pre√ßo por unidade'),
    sa.Column('valor_total', sa.Numeric(precision=18, scale=2), nullable=False, comment='Valor total da opera√ß√£o (quantidade * pre√ßo)'),
    sa.Column('taxas', sa.Numeric(precision=18, scale=2), nullable=False, comment='Taxas de corretagem, cust√≥dia, emolumentos'),
    sa.Column('impostos', sa.Numeric(precision=18, scale=2), nullable=False, comment='IR retido na fonte, IOF, etc.'),
    sa.Column('data_operacao', sa.Date(), nullable=False, comment='Data da opera√ß√£o'),
    sa.Column('data_liquidacao', sa.Date(), nullable=True, comment='Data de liquida√ß√£o (D+2, D+3, etc.)'),
    sa.Column('observacoes', sa.Text(), nullable=True, comment='Observa√ß√µes sobre a transa√ß√£o'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Data de cria√ß√£o do registro'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, comment='Data da √∫ltima atualiza√ß√£o'),
    sa.CheckConstraint('data_liquidacao IS NULL OR data_liquidacao >= data_operacao', name='transacao_data_liquidacao_valida'),
    sa.CheckConstraint('impostos >= 0', name='transacao_impostos_positivos'),
    sa.CheckConstraint('preco_unitario > 0', name='transacao_preco_positivo'),
    sa.CheckConstraint('quantidade > 0', name='transacao_quantidade_positiva'),
    sa.CheckConstraint('taxas >= 0', name='transacao_taxas_positivas'),
    sa.CheckConstraint('valor_total > 0', name='transacao_valor_total_positivo'),
    sa.ForeignKeyConstraint(['ativo_id'], ['ativo.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['corretora_id'], ['corretora.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['usuario_id'], ['usuario.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='Tabela de transa√ß√µes de compra e venda de ativos'
    )
    op.create_index(op.f('ix_transacao_ativo_id'), 'transacao', ['ativo_id'], unique=False)
    op.create_index(op.f('ix_transacao_corretora_id'), 'transacao', ['corretora_id'], unique=False)
    op.create_index(op.f('ix_transacao_data_liquidacao'), 'transacao', ['data_liquidacao'], unique=False)
    op.create_index(op.f('ix_transacao_data_operacao'), 'transacao', ['data_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_tipo_operacao'), 'transacao', ['tipo_operacao'], unique=False)
    op.create_index(op.f('ix_transacao_usuario_id'), 'transacao', ['usuario_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_transacao_usuario_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_tipo_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_operacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_data_liquidacao'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_corretora_id'), table_name='transacao')
    op.drop_index(op.f('ix_transacao_ativo_id'), table_name='transacao')
    op.drop_table('transacao')
    op.drop_index(op.f('ix_posicao_usuario_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_ultima_atualizacao'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_data_primeira_compra'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_corretora_id'), table_name='posicao')
    op.drop_index(op.f('ix_posicao_ativo_id'), table_name='posicao')
    op.drop_table('posicao')
    op.drop_index(op.f('ix_movimentacao_caixa_usuario_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_tipo_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_provento_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_moeda'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_data_movimentacao'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_id'), table_name='movimentacao_caixa')
    op.drop_index(op.f('ix_movimentacao_caixa_corretora_destino_id'), table_name='movimentacao_caixa')
    op.drop_table('movimentacao_caixa')
    op.drop_index(op.f('ix_provento_tipo_provento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_pagamento'), table_name='provento')
    op.drop_index(op.f('ix_provento_data_com'), table_name='provento')
    op.drop_index(op.f('ix_provento_ativo_id'), table_name='provento')
    op.drop_table('provento')
    op.drop_index(op.f('ix_log_auditoria_usuario_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_timestamp'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_sucesso'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_ip_address'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade_id'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_entidade'), table_name='log_auditoria')
    op.drop_index(op.f('ix_log_auditoria_acao'), table_name='log_auditoria')
    op.drop_table('log_auditoria')
    op.drop_index(op.f('ix_evento_corporativo_tipo_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_impacto_posicoes'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_evento'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_data_com'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_novo_id'), table_name='evento_corporativo')
    op.drop_index(op.f('ix_evento_corporativo_ativo_id'), table_name='evento_corporativo')
    op.drop_table('evento_corporativo')
    op.drop_index(op.f('ix_corretora_usuario_id'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_tipo'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_pais'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_nome'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_moeda_padrao'), table_name='corretora')
    op.drop_index(op.f('ix_corretora_ativa'), table_name='corretora')
    op.drop_table('corretora')
    op.drop_index(op.f('ix_usuario_username'), table_name='usuario')
    op.drop_index(op.f('ix_usuario_email'), table_name='usuario')
    op.drop_table('usuario')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_inicio'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_vigencia_fim'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_operacao'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_tipo_ativo'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_pais'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_incide_sobre'), table_name='regra_fiscal')
    op.drop_index(op.f('ix_regra_fiscal_ativa'), table_name='regra_fiscal')
    op.drop_table('regra_fiscal')
    op.drop_index(op.f('ix_fonte_dados_ultima_consulta'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_tipo_fonte'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_prioridade'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_nome'), table_name='fonte_dados')
    op.drop_index(op.f('ix_fonte_dados_ativa'), table_name='fonte_dados')
    op.drop_table('fonte_dados')
    op.drop_index(op.f('ix_feriado_mercado_tipo_feriado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_recorrente'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_pais'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_mercado'), table_name='feriado_mercado')
    op.drop_index(op.f('ix_feriado_mercado_data_feriado'), table_name='feriado_mercado')
    op.drop_table('feriado_mercado')
    op.drop_index(op.f('ix_ativo_tipo'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ticker'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_nome'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_moeda'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_mercado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_deslistado'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_data_ultima_cotacao'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_classe'), table_name='ativo')
    op.drop_index(op.f('ix_ativo_ativo'), table_name='ativo')
    op.drop_table('ativo')
    # ### end Alembic commands ###

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config
from .database import init_db


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)
    
    # Inicializa banco de dados
    init_db(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models para que Alembic os detecte
        from app.models import (
            Usuario, UserRole,
            Corretora, TipoCorretora,
            Ativo, TipoAtivo, ClasseAtivo,
            Posicao,
            Transacao, TipoOperacao,
            Provento, TipoProvento,
            MovimentacaoCaixa, TipoMovimentacao,
            EventoCorporativo, TipoEventoCorporativo,
            FonteDados, TipoFonteDados,
            RegraFiscal, IncidenciaImposto,
            FeriadoMercado, TipoFeriado,
            LogAuditoria
        )
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/database.py.bak ---
# -*- coding: utf-8 -*-
"""Exitus Backend - Database Configuration"""

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Inst√¢ncias globais
db = SQLAlchemy()
migrate = Migrate()


def init_db(app):
    """Inicializa o banco de dados com a aplica√ß√£o Flask"""
    db.init_app(app)
    migrate.init_app(app, db)
    
    with app.app_context():
        # Importa todos os models (apenas quando existirem)
        # COMENTADO at√© criarmos os models na Fase 2
        # from app.models import (
        #     usuario, corretora, ativo, posicao, transacao,
        #     provento, movimentacao_caixa, evento_corporativo,
        #     fonte_dados, regra_fiscal, feriado_mercado, log_auditoria
        # )
        pass
    
    return db

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus - Models Package"""

from app.database import db

# Importar models criados
from .usuario import Usuario, UserRole
from .corretora import Corretora, TipoCorretora
from .ativo import Ativo, TipoAtivo, ClasseAtivo
from .posicao import Posicao
from .transacao import Transacao, TipoOperacao
from .provento import Provento, TipoProvento
from .movimentacao_caixa import MovimentacaoCaixa, TipoMovimentacao
from .evento_corporativo import EventoCorporativo, TipoEventoCorporativo
from .fonte_dados import FonteDados, TipoFonteDados
from .regra_fiscal import RegraFiscal, IncidenciaImposto
from .feriado_mercado import FeriadoMercado, TipoFeriado
from .log_auditoria import LogAuditoria

# Exportar para facilitar imports
__all__ = [
    'db',
    'Usuario',
    'UserRole',
    'Corretora',
    'TipoCorretora',
    'Ativo',
    'TipoAtivo',
    'ClasseAtivo',
    'Posicao',
    'Transacao',
    'TipoOperacao',
    'Provento',
    'TipoProvento',
    'MovimentacaoCaixa',
    'TipoMovimentacao',
    'EventoCorporativo',
    'TipoEventoCorporativo',
    'FonteDados',
    'TipoFonteDados',
    'RegraFiscal',
    'IncidenciaImposto',
    'FeriadoMercado',
    'TipoFeriado',
    'LogAuditoria'
]

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/ativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Ativo
Entidade para instrumentos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoAtivo(enum.Enum):
    """Enum para tipos de ativo"""
    ACAO = "acao"              # A√ß√£o
    FII = "fii"                # Fundo Imobili√°rio
    REIT = "reit"              # Real Estate Investment Trust
    BOND = "bond"              # T√≠tulo de renda fixa
    ETF = "etf"                # Exchange Traded Fund
    CRIPTO = "cripto"          # Criptomoeda
    OUTRO = "outro"            # Outros tipos


class ClasseAtivo(enum.Enum):
    """Enum para classes de ativo"""
    RENDA_VARIAVEL = "renda_variavel"
    RENDA_FIXA = "renda_fixa"
    CRIPTO = "cripto"
    HIBRIDO = "hibrido"


class Ativo(db.Model):
    """
    Model para ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)
    
    Attributes:
        id (UUID): Identificador √∫nico
        ticker (str): C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL)
        nome (str): Nome completo do ativo
        tipo (TipoAtivo): Tipo do ativo
        classe (ClasseAtivo): Classe do ativo
        mercado (str): Mercado/pa√≠s (BR, US, EUR)
        moeda (str): Moeda de negocia√ß√£o (BRL, USD, EUR)
        preco_atual (Decimal): Pre√ßo/cota√ß√£o atual
        data_ultima_cotacao (datetime): Data da √∫ltima cota√ß√£o
        dividend_yield (Decimal): Dividend Yield (%)
        p_l (Decimal): √çndice Pre√ßo/Lucro
        p_vp (Decimal): √çndice Pre√ßo/Valor Patrimonial
        roe (Decimal): Return on Equity (%)
        ativo (bool): Indica se ativo est√° ativo para negocia√ß√£o
        deslistado (bool): Indica se foi deslistado da bolsa
        data_deslistagem (date): Data de deslistagem (se aplic√°vel)
        observacoes (str): Observa√ß√µes gerais
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        posicoes: Posi√ß√µes deste ativo nos portfolios
        transacoes: Transa√ß√µes realizadas com este ativo
        proventos: Proventos distribu√≠dos por este ativo
        eventos_corporativos: Eventos corporativos deste ativo
    """
    
    __tablename__ = 'ativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do ativo"
    )
    
    # Identifica√ß√£o do ativo
    ticker = db.Column(
        String(20),
        nullable=False,
        index=True,
        comment="C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        index=True,
        comment="Nome completo do ativo"
    )
    
    tipo = db.Column(
        Enum(TipoAtivo),
        nullable=False,
        index=True,
        comment="Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)"
    )
    
    classe = db.Column(
        Enum(ClasseAtivo),
        nullable=False,
        index=True,
        comment="Classe do ativo (renda vari√°vel, fixa, cripto)"
    )
    
    # Mercado e moeda
    mercado = db.Column(
        String(10),
        nullable=False,
        default='BR',
        index=True,
        comment="Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="Moeda de negocia√ß√£o (BRL, USD, EUR)"
    )
    
    # Cota√ß√£o
    preco_atual = db.Column(
        Numeric(precision=18, scale=6),
        nullable=True,
        comment="Pre√ßo/cota√ß√£o atual do ativo"
    )
    
    data_ultima_cotacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data e hora da √∫ltima cota√ß√£o"
    )
    
    # Indicadores financeiros
    dividend_yield = db.Column(
        Numeric(precision=8, scale=4),
        nullable=True,
        comment="Dividend Yield em % (ex: 6.5000 = 6.5%)"
    )
    
    p_l = db.Column(
        Numeric(precision=10, scale=2),
        nullable=True,
        comment="√çndice Pre√ßo/Lucro"
    )
    
    p_vp = db.Column(
        Numeric(precision=10, scale=2),
        nullable=True,
        comment="√çndice Pre√ßo/Valor Patrimonial"
    )
    
    roe = db.Column(
        Numeric(precision=8, scale=4),
        nullable=True,
        comment="Return on Equity em %"
    )
    
    # Status
    ativo = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se ativo est√° dispon√≠vel para negocia√ß√£o"
    )
    
    deslistado = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se ativo foi deslistado da bolsa"
    )
    
    data_deslistagem = db.Column(
        Date,
        nullable=True,
        comment="Data de deslistagem (se aplic√°vel)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes e notas sobre o ativo"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos futuros (descomentar quando criar os models)
    # posicoes = relationship('Posicao', back_populates='ativo', lazy='dynamic')
    # transacoes = relationship('Transacao', back_populates='ativo', lazy='dynamic')
    # proventos = relationship('Provento', back_populates='ativo', lazy='dynamic')
    # eventos_corporativos = relationship('EventoCorporativo', back_populates='ativo', lazy='dynamic')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "preco_atual IS NULL OR preco_atual >= 0",
            name="ativo_preco_positivo"
        ),
        db.CheckConstraint(
            "length(ticker) >= 1",
            name="ativo_ticker_min_length"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="ativo_nome_min_length"
        ),
        db.UniqueConstraint(
            'ticker', 'mercado',
            name='unique_ativo_ticker_mercado'
        ),
        {'comment': 'Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)'}
    )
    
    def is_active(self):
        """Verifica se ativo est√° ativo"""
        return self.ativo and not self.deslistado
    
    def is_renda_fixa(self):
        """Verifica se √© ativo de renda fixa"""
        return self.classe == ClasseAtivo.RENDA_FIXA
    
    def is_renda_variavel(self):
        """Verifica se √© ativo de renda vari√°vel"""
        return self.classe == ClasseAtivo.RENDA_VARIAVEL
    
    def is_cripto(self):
        """Verifica se √© criptomoeda"""
        return self.tipo == TipoAtivo.CRIPTO or self.classe == ClasseAtivo.CRIPTO
    
    def atualizar_cotacao(self, preco, data_cotacao=None):
        """
        Atualiza a cota√ß√£o do ativo
        
        Args:
            preco (Decimal): Novo pre√ßo
            data_cotacao (datetime): Data da cota√ß√£o (default: agora)
        
        Raises:
            ValueError: Se pre√ßo for negativo
        """
        if preco < 0:
            raise ValueError(f"Pre√ßo n√£o pode ser negativo: {preco}")
        
        self.preco_atual = preco
        self.data_ultima_cotacao = data_cotacao or datetime.utcnow()
    
    def atualizar_indicadores(self, dy=None, pl=None, pvp=None, roe_value=None):
        """
        Atualiza indicadores financeiros do ativo
        
        Args:
            dy (Decimal): Dividend Yield
            pl (Decimal): √çndice P/L
            pvp (Decimal): √çndice P/VP
            roe_value (Decimal): ROE
        """
        if dy is not None:
            self.dividend_yield = dy
        if pl is not None:
            self.p_l = pl
        if pvp is not None:
            self.p_vp = pvp
        if roe_value is not None:
            self.roe = roe_value
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do ativo
        """
        return {
            'id': str(self.id),
            'ticker': self.ticker,
            'nome': self.nome,
            'tipo': self.tipo.value if self.tipo else None,
            'classe': self.classe.value if self.classe else None,
            'mercado': self.mercado,
            'moeda': self.moeda,
            'preco_atual': float(self.preco_atual) if self.preco_atual else None,
            'data_ultima_cotacao': self.data_ultima_cotacao.isoformat() if self.data_ultima_cotacao else None,
            'dividend_yield': float(self.dividend_yield) if self.dividend_yield else None,
            'p_l': float(self.p_l) if self.p_l else None,
            'p_vp': float(self.p_vp) if self.p_vp else None,
            'roe': float(self.roe) if self.roe else None,
            'ativo': self.ativo,
            'deslistado': self.deslistado,
            'data_deslistagem': self.data_deslistagem.isoformat() if self.data_deslistagem else None,
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Ativo {self.ticker} - {self.nome} ({self.mercado})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/corretora.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Corretora
Entidade para gest√£o de contas de investimento (corretoras e exchanges)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoCorretora(enum.Enum):
    """Enum para tipos de corretora"""
    CORRETORA = "corretora"  # Corretora tradicional
    EXCHANGE = "exchange"     # Exchange de criptomoedas


class Corretora(db.Model):
    """
    Model para corretoras/exchanges de investimento
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        nome (str): Nome da corretora
        tipo (TipoCorretora): Tipo (corretora ou exchange)
        pais (str): C√≥digo ISO do pa√≠s (BR, US, etc.)
        moeda_padrao (str): Moeda padr√£o (BRL, USD, EUR)
        saldo_atual (Decimal): Saldo dispon√≠vel em caixa
        ativa (bool): Indica se conta est√° ativa
        observacoes (str): Observa√ß√µes do usu√°rio
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio da conta
        posicoes: Posi√ß√µes de ativos nesta corretora
        transacoes: Transa√ß√µes realizadas nesta corretora
        movimentacoes_caixa: Movimenta√ß√µes de caixa desta corretora
    """
    
    __tablename__ = 'corretora'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da corretora"
    )
    
    # Foreign key para Usuario
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    # Dados da corretora
    nome = db.Column(
        String(100),
        nullable=False,
        index=True,
        comment="Nome da corretora/exchange (ex: XP, Clear, Binance)"
    )
    
    tipo = db.Column(
        Enum(TipoCorretora),
        default=TipoCorretora.CORRETORA,
        nullable=False,
        index=True,
        comment="Tipo: corretora tradicional ou exchange cripto"
    )
    
    pais = db.Column(
        String(2),
        nullable=False,
        default='BR',
        index=True,
        comment="C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)"
    )
    
    moeda_padrao = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    saldo_atual = db.Column(
        Numeric(precision=18, scale=2),
        default=0.00,
        nullable=False,
        comment="Saldo dispon√≠vel em caixa (na moeda padr√£o)"
    )
    
    # Status e metadados
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se conta est√° ativa"
    )
    
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes e notas do usu√°rio sobre a conta"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship(
        'Usuario',
        backref='corretoras',
        lazy='joined'
    )
    
    # Relacionamentos futuros (descomentar quando criar os models)
    # posicoes = relationship('Posicao', back_populates='corretora', lazy='dynamic')
    # transacoes = relationship('Transacao', back_populates='corretora', lazy='dynamic')
    # movimentacoes_caixa = relationship('MovimentacaoCaixa', back_populates='corretora', lazy='dynamic')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "saldo_atual >= 0",
            name="corretora_saldo_positivo"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="corretora_nome_min_length"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="corretora_pais_iso_format"
        ),
        db.CheckConstraint(
            "moeda_padrao ~* '^[A-Z]{3}$'",
            name="corretora_moeda_iso_format"
        ),
        db.UniqueConstraint(
            'usuario_id', 'nome', 'pais',
            name='unique_corretora_usuario_nome_pais'
        ),
        {'comment': 'Tabela de corretoras e contas de investimento'}
    )
    
    def is_active(self):
        """Verifica se corretora est√° ativa"""
        return self.ativa
    
    def is_exchange(self):
        """Verifica se √© exchange de criptomoedas"""
        return self.tipo == TipoCorretora.EXCHANGE
    
    def atualizar_saldo(self, valor, operacao='credito'):
        """
        Atualiza o saldo da corretora
        
        Args:
            valor (Decimal): Valor a ser creditado/debitado
            operacao (str): 'credito' ou 'debito'
        
        Raises:
            ValueError: Se saldo ficar negativo ou opera√ß√£o inv√°lida
        """
        if operacao == 'credito':
            self.saldo_atual += valor
        elif operacao == 'debito':
            if self.saldo_atual < valor:
                raise ValueError(f"Saldo insuficiente. Dispon√≠vel: {self.saldo_atual}, Solicitado: {valor}")
            self.saldo_atual -= valor
        else:
            raise ValueError(f"Opera√ß√£o inv√°lida: {operacao}. Use 'credito' ou 'debito'")
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da corretora
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'nome': self.nome,
            'tipo': self.tipo.value if self.tipo else TipoCorretora.CORRETORA.value,
            'pais': self.pais,
            'moeda_padrao': self.moeda_padrao,
            'saldo_atual': float(self.saldo_atual) if self.saldo_atual else 0.0,
            'ativa': self.ativa,
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Corretora {self.nome} ({self.pais}/{self.moeda_padrao})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/evento_corporativo.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model EventoCorporativo
Entidade para eventos corporativos que afetam ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Boolean, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoEventoCorporativo(enum.Enum):
    """Enum para tipos de evento corporativo"""
    SPLIT = "split"                          # Desdobramento (ex: 1 a√ß√£o vira 2)
    GRUPAMENTO = "grupamento"                # Grupamento/Inplit (ex: 10 a√ß√µes viram 1)
    BONIFICACAO = "bonificacao"              # Bonifica√ß√£o em a√ß√µes
    DIREITO_SUBSCRICAO = "direito_sub"       # Direito de subscri√ß√£o
    FUSAO = "fusao"                          # Fus√£o com outra empresa
    CISAO = "cisao"                          # Cis√£o (spin-off)
    INCORPORACAO = "incorporacao"            # Incorpora√ß√£o por outra empresa
    MUDANCA_TICKER = "mudanca_ticker"        # Mudan√ßa de c√≥digo
    DESLISTAGEM = "deslistagem"              # Deslistagem da bolsa
    RELISTING = "relisting"                  # Relistagem
    CANCELAMENTO = "cancelamento"            # Cancelamento de a√ß√µes
    OUTRO = "outro"                          # Outros eventos


class EventoCorporativo(db.Model):
    """
    Model para eventos corporativos que afetam ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo afetado
        tipo_evento (TipoEventoCorporativo): Tipo do evento
        data_evento (date): Data do evento
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        proporcao (str): Propor√ß√£o do evento (ex: "2:1", "1:10")
        ativo_novo_id (UUID): ID do novo ativo (fus√µes, mudan√ßas)
        descricao (str): Descri√ß√£o detalhada do evento
        impacto_posicoes (bool): Indica se posi√ß√µes j√° foram ajustadas
        observacoes (str): Observa√ß√µes adicionais
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo original afetado
        ativo_novo: Novo ativo (para fus√µes, mudan√ßas de ticker)
    """
    
    __tablename__ = 'evento_corporativo'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do evento"
    )
    
    # Foreign keys
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo afetado pelo evento"
    )
    
    ativo_novo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do novo ativo (fus√µes, mudan√ßas de ticker)"
    )
    
    # Dados do evento
    tipo_evento = db.Column(
        Enum(TipoEventoCorporativo),
        nullable=False,
        index=True,
        comment="Tipo do evento corporativo"
    )
    
    data_evento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do evento"
    )
    
    data_com = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao evento)"
    )
    
    proporcao = db.Column(
        String(20),
        nullable=True,
        comment="Propor√ß√£o do evento (ex: '2:1', '1:10', '1:1.5')"
    )
    
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada do evento"
    )
    
    # Controle de processamento
    impacto_posicoes = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se as posi√ß√µes j√° foram ajustadas"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes adicionais sobre o evento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship(
        'Ativo',
        foreign_keys=[ativo_id],
        backref='eventos_corporativos',
        lazy='joined'
    )
    ativo_novo = relationship(
        'Ativo',
        foreign_keys=[ativo_novo_id],
        lazy='joined'
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "data_com IS NULL OR data_com <= data_evento",
            name="evento_data_com_valida"
        ),
        db.CheckConstraint(
            """
            (tipo_evento IN ('split', 'grupamento', 'bonificacao') AND proporcao IS NOT NULL)
            OR 
            (tipo_evento NOT IN ('split', 'grupamento', 'bonificacao'))
            """,
            name="evento_proporcao_obrigatoria"
        ),
        {'comment': 'Tabela de eventos corporativos que afetam ativos'}
    )
    
    def is_split(self):
        """Verifica se √© split (desdobramento)"""
        return self.tipo_evento == TipoEventoCorporativo.SPLIT
    
    def is_grupamento(self):
        """Verifica se √© grupamento (inplit)"""
        return self.tipo_evento == TipoEventoCorporativo.GRUPAMENTO
    
    def is_bonificacao(self):
        """Verifica se √© bonifica√ß√£o"""
        return self.tipo_evento == TipoEventoCorporativo.BONIFICACAO
    
    def is_mudanca_ticker(self):
        """Verifica se √© mudan√ßa de ticker"""
        return self.tipo_evento == TipoEventoCorporativo.MUDANCA_TICKER
    
    def parse_proporcao(self):
        """
        Faz parse da propor√ß√£o do evento
        
        Returns:
            tuple: (numerador, denominador) ou None se inv√°lido
            
        Examples:
            "2:1" -> (2.0, 1.0) # Split 2 para 1
            "1:10" -> (1.0, 10.0) # Grupamento 1 para 10
            "1:1.5" -> (1.0, 1.5) # Bonifica√ß√£o 50%
        """
        if not self.proporcao:
            return None
        
        try:
            parts = self.proporcao.split(':')
            if len(parts) == 2:
                return (float(parts[0]), float(parts[1]))
        except (ValueError, IndexError):
            pass
        
        return None
    
    def calcular_fator_ajuste(self):
        """
        Calcula o fator de ajuste para quantidade de ativos
        
        Returns:
            float: Fator multiplicador (ex: 2.0 para split 2:1, 0.1 para grupamento 1:10)
        """
        proporcao = self.parse_proporcao()
        if not proporcao:
            return 1.0
        
        numerador, denominador = proporcao
        
        if self.is_split() or self.is_bonificacao():
            # Split 2:1 ou Bonifica√ß√£o 1:1.5 -> multiplica quantidade
            return numerador / denominador
        elif self.is_grupamento():
            # Grupamento 1:10 -> divide quantidade (inverte propor√ß√£o)
            return numerador / denominador
        
        return 1.0
    
    def calcular_fator_ajuste_preco(self):
        """
        Calcula o fator de ajuste para pre√ßo m√©dio
        (inverso do ajuste de quantidade)
        
        Returns:
            float: Fator divisor para pre√ßo
        """
        fator_quantidade = self.calcular_fator_ajuste()
        if fator_quantidade > 0:
            return 1.0 / fator_quantidade
        return 1.0
    
    def marcar_como_processado(self):
        """Marca o evento como processado (posi√ß√µes ajustadas)"""
        self.impacto_posicoes = True
    
    def dias_ate_evento(self):
        """
        Calcula quantos dias faltam para o evento
        
        Returns:
            int: Dias at√© evento (negativo se j√° ocorreu)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_evento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do evento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'ativo_novo_id': str(self.ativo_novo_id) if self.ativo_novo_id else None,
            'tipo_evento': self.tipo_evento.value if self.tipo_evento else None,
            'data_evento': self.data_evento.isoformat() if self.data_evento else None,
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'proporcao': self.proporcao,
            'fator_ajuste_quantidade': self.calcular_fator_ajuste(),
            'fator_ajuste_preco': self.calcular_fator_ajuste_preco(),
            'descricao': self.descricao,
            'impacto_posicoes': self.impacto_posicoes,
            'dias_ate_evento': self.dias_ate_evento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_evento.value if self.tipo_evento else "N/A"
        return f"<EventoCorporativo {tipo.upper()} {ticker} {self.proporcao or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/feriado_mercado.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FeriadoMercado
Entidade para feriados e dias sem preg√£o
"""

from datetime import datetime, time
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Text, Date, Time
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFeriado(enum.Enum):
    """Enum para tipos de feriado"""
    NACIONAL = "nacional"            # Feriado nacional
    BOLSA = "bolsa"                  # Feriado espec√≠fico da bolsa
    PONTE = "ponte"                  # Ponto facultativo
    FECHAMENTO_ANTECIPADO = "antecip"  # Fechamento antecipado
    MANUTENCAO = "manutencao"        # Manuten√ß√£o de sistemas
    OUTRO = "outro"                  # Outros tipos


class FeriadoMercado(db.Model):
    """
    Model para feriados e dias sem preg√£o
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s do feriado (c√≥digo ISO)
        mercado (str): Mercado/bolsa espec√≠fica
        data_feriado (date): Data do feriado
        tipo_feriado (TipoFeriado): Tipo do feriado
        nome (str): Nome do feriado
        horario_fechamento (time): Hor√°rio de fechamento antecipado
        recorrente (bool): Se √© feriado anual fixo
        observacoes (str): Observa√ß√µes sobre o feriado
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'feriado_mercado'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do feriado"
    )
    
    # Localiza√ß√£o
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    mercado = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos"
    )
    
    # Dados do feriado
    data_feriado = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data do feriado"
    )
    
    tipo_feriado = db.Column(
        Enum(TipoFeriado),
        nullable=False,
        index=True,
        comment="Tipo do feriado"
    )
    
    nome = db.Column(
        String(200),
        nullable=False,
        comment="Nome do feriado"
    )
    
    horario_fechamento = db.Column(
        Time,
        nullable=True,
        comment="Hor√°rio de fechamento antecipado (se aplic√°vel)"
    )
    
    recorrente = db.Column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o feriado"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="feriado_pais_iso_format"
        ),
        db.CheckConstraint(
            "length(nome) >= 3",
            name="feriado_nome_min_length"
        ),
        db.UniqueConstraint(
            'pais', 'mercado', 'data_feriado',
            name='unique_feriado_pais_mercado_data'
        ),
        {'comment': 'Tabela de feriados e dias sem preg√£o nos mercados'}
    )
    
    def is_fechamento_total(self):
        """Verifica se √© fechamento total (n√£o h√° preg√£o)"""
        return self.tipo_feriado in [
            TipoFeriado.NACIONAL,
            TipoFeriado.BOLSA,
            TipoFeriado.PONTE
        ]
    
    def is_fechamento_antecipado(self):
        """Verifica se √© fechamento antecipado"""
        return self.tipo_feriado == TipoFeriado.FECHAMENTO_ANTECIPADO
    
    def is_recorrente(self):
        """Verifica se √© feriado recorrente (anual)"""
        return self.recorrente
    
    def dias_ate_feriado(self):
        """
        Calcula quantos dias faltam para o feriado
        
        Returns:
            int: Dias at√© feriado (negativo se j√° passou)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_feriado - hoje
        return delta.days
    
    def is_hoje(self):
        """Verifica se o feriado √© hoje"""
        return self.data_feriado == datetime.utcnow().date()
    
    def is_futuro(self):
        """Verifica se o feriado √© no futuro"""
        return self.data_feriado > datetime.utcnow().date()
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do feriado
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'mercado': self.mercado,
            'data_feriado': self.data_feriado.isoformat() if self.data_feriado else None,
            'tipo_feriado': self.tipo_feriado.value if self.tipo_feriado else None,
            'nome': self.nome,
            'horario_fechamento': self.horario_fechamento.isoformat() if self.horario_fechamento else None,
            'recorrente': self.recorrente,
            'is_fechamento_total': self.is_fechamento_total(),
            'is_fechamento_antecipado': self.is_fechamento_antecipado(),
            'dias_ate_feriado': self.dias_ate_feriado(),
            'is_hoje': self.is_hoje(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<FeriadoMercado {self.pais} {self.data_feriado} - {self.nome}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/fonte_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model FonteDados
Entidade para gerenciamento de fontes de dados externas (APIs)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Integer, Text
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class TipoFonteDados(enum.Enum):
    """Enum para tipos de fonte de dados"""
    API = "api"              # API RESTful
    SCRAPER = "scraper"      # Web scraping
    MANUAL = "manual"        # Entrada manual
    ARQUIVO = "arquivo"      # Import de arquivo
    OUTRO = "outro"          # Outros tipos


class FonteDados(db.Model):
    """
    Model para fontes de dados externas
    
    Attributes:
        id (UUID): Identificador √∫nico
        nome (str): Nome da fonte
        tipo_fonte (TipoFonteDados): Tipo da fonte
        url_base (str): URL base da API/fonte
        requer_autenticacao (bool): Se requer chave API
        rate_limit (str): Limite de requisi√ß√µes
        ativa (bool): Se fonte est√° ativa
        prioridade (int): Ordem de prioridade (1 = maior)
        ultima_consulta (datetime): Timestamp da √∫ltima consulta
        total_consultas (int): Total de consultas realizadas
        total_erros (int): Total de erros encontrados
        observacoes (str): Observa√ß√µes sobre a fonte
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'fonte_dados'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da fonte"
    )
    
    # Identifica√ß√£o
    nome = db.Column(
        String(100),
        unique=True,
        nullable=False,
        index=True,
        comment="Nome da fonte de dados (ex: yfinance, Alpha Vantage)"
    )
    
    tipo_fonte = db.Column(
        Enum(TipoFonteDados),
        nullable=False,
        index=True,
        comment="Tipo da fonte de dados"
    )
    
    url_base = db.Column(
        String(500),
        nullable=True,
        comment="URL base da API ou site"
    )
    
    # Configura√ß√µes
    requer_autenticacao = db.Column(
        Boolean,
        default=False,
        nullable=False,
        comment="Indica se requer chave API ou autentica√ß√£o"
    )
    
    rate_limit = db.Column(
        String(50),
        nullable=True,
        comment="Limite de requisi√ß√µes (ex: '5/minute', '500/day')"
    )
    
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se fonte est√° ativa"
    )
    
    prioridade = db.Column(
        Integer,
        default=100,
        nullable=False,
        index=True,
        comment="Ordem de prioridade (1 = maior prioridade)"
    )
    
    # Estat√≠sticas
    ultima_consulta = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Timestamp da √∫ltima consulta bem-sucedida"
    )
    
    total_consultas = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de consultas realizadas"
    )
    
    total_erros = db.Column(
        Integer,
        default=0,
        nullable=False,
        comment="Total de erros encontrados"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a fonte de dados"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "prioridade > 0",
            name="fonte_prioridade_positiva"
        ),
        db.CheckConstraint(
            "total_consultas >= 0",
            name="fonte_consultas_positivas"
        ),
        db.CheckConstraint(
            "total_erros >= 0",
            name="fonte_erros_positivos"
        ),
        db.CheckConstraint(
            "length(nome) >= 2",
            name="fonte_nome_min_length"
        ),
        {'comment': 'Tabela de fontes de dados externas (APIs, scrapers)'}
    )
    
    def is_active(self):
        """Verifica se fonte est√° ativa"""
        return self.ativa
    
    def is_api(self):
        """Verifica se √© API"""
        return self.tipo_fonte == TipoFonteDados.API
    
    def registrar_consulta_sucesso(self):
        """Registra uma consulta bem-sucedida"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.ultima_consulta = datetime.utcnow()
        self.total_consultas += 1

    def registrar_erro(self):
        """Registra um erro na consulta"""
        # Garantir valores n√£o-None
        if self.total_consultas is None:
            self.total_consultas = 0
        if self.total_erros is None:
            self.total_erros = 0
        
        self.total_erros += 1
        self.total_consultas += 1

    def taxa_sucesso(self):
        """
        Calcula a taxa de sucesso das consultas
        
        Returns:
            float: Percentual de sucesso (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            sucessos = total - erros
            return (sucessos / total) * 100
        return 100.0  # Sem consultas = 100% por padr√£o

    def taxa_erro(self):
        """
        Calcula a taxa de erro das consultas
        
        Returns:
            float: Percentual de erro (0-100)
        """
        total = self.total_consultas if self.total_consultas else 0
        erros = self.total_erros if self.total_erros else 0
        
        if total > 0:
            return (erros / total) * 100
        return 0.0

    def health_status(self):
        """
        Determina o status de sa√∫de da fonte
        
        Returns:
            str: 'healthy', 'degraded', 'down', 'unknown'
        """
        total = self.total_consultas if self.total_consultas else 0
        
        if total == 0:
            return 'unknown'
        
        taxa_sucesso = self.taxa_sucesso()
        
        if taxa_sucesso >= 95:
            return 'healthy'
        elif taxa_sucesso >= 80:
            return 'degraded'
        else:
            return 'down'

    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da fonte
        """
        return {
            'id': str(self.id),
            'nome': self.nome,
            'tipo_fonte': self.tipo_fonte.value if self.tipo_fonte else None,
            'url_base': self.url_base,
            'requer_autenticacao': self.requer_autenticacao,
            'rate_limit': self.rate_limit,
            'ativa': self.ativa,
            'prioridade': self.prioridade,
            'ultima_consulta': self.ultima_consulta.isoformat() if self.ultima_consulta else None,
            'total_consultas': self.total_consultas,
            'total_erros': self.total_erros,
            'taxa_sucesso': round(self.taxa_sucesso(), 2),
            'taxa_erro': round(self.taxa_erro(), 2),
            'health_status': self.health_status(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.ativa else "‚úó"
        return f"<FonteDados {status} {self.nome} (prioridade {self.prioridade})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/log_auditoria.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model LogAuditoria
Entidade para logs de auditoria e compliance
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Text, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class LogAuditoria(db.Model):
    """
    Model para logs de auditoria
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio que realizou a a√ß√£o
        acao (str): Tipo de a√ß√£o (LOGIN, CREATE, UPDATE, DELETE, etc.)
        entidade (str): Nome da entidade afetada
        entidade_id (UUID): ID do registro afetado
        dados_antes (dict): Estado anterior do registro (JSON)
        dados_depois (dict): Estado posterior do registro (JSON)
        ip_address (str): Endere√ßo IP de origem
        user_agent (str): Navegador/cliente usado
        timestamp (datetime): Data/hora da a√ß√£o
        sucesso (bool): Se a√ß√£o foi bem-sucedida
        mensagem (str): Mensagem de erro ou detalhes adicionais
    
    Relationships:
        usuario: Usu√°rio que realizou a a√ß√£o
    """
    
    __tablename__ = 'log_auditoria'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do log"
    )
    
    # Foreign key
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do usu√°rio (NULL para a√ß√µes an√¥nimas)"
    )
    
    # Dados da a√ß√£o
    acao = db.Column(
        String(50),
        nullable=False,
        index=True,
        comment="Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)"
    )
    
    entidade = db.Column(
        String(100),
        nullable=True,
        index=True,
        comment="Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)"
    )
    
    entidade_id = db.Column(
        UUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="ID do registro afetado"
    )
    
    # Estados anterior e posterior (para UPDATE)
    dados_antes = db.Column(
        JSON,
        nullable=True,
        comment="Estado anterior do registro (JSON)"
    )
    
    dados_depois = db.Column(
        JSON,
        nullable=True,
        comment="Estado posterior do registro (JSON)"
    )
    
    # Dados de contexto
    ip_address = db.Column(
        String(45),  # IPv6 pode ter at√© 45 caracteres
        nullable=True,
        index=True,
        comment="Endere√ßo IP de origem"
    )
    
    user_agent = db.Column(
        String(500),
        nullable=True,
        comment="User-Agent (navegador/cliente)"
    )
    
    timestamp = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        index=True,
        comment="Data/hora da a√ß√£o"
    )
    
    # Resultado
    sucesso = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se a√ß√£o foi bem-sucedida"
    )
    
    mensagem = db.Column(
        Text,
        nullable=True,
        comment="Mensagem de erro ou detalhes adicionais"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='logs_auditoria', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "length(acao) >= 3",
            name="log_acao_min_length"
        ),
        {'comment': 'Tabela de logs de auditoria para compliance'}
    )
    
    def is_sucesso(self):
        """Verifica se a√ß√£o foi bem-sucedida"""
        return self.sucesso
    
    def is_falha(self):
        """Verifica se a√ß√£o falhou"""
        return not self.sucesso
    
    def is_login(self):
        """Verifica se √© log de login"""
        return self.acao == 'LOGIN'
    
    def is_logout(self):
        """Verifica se √© log de logout"""
        return self.acao == 'LOGOUT'
    
    def is_create(self):
        """Verifica se √© cria√ß√£o de registro"""
        return self.acao == 'CREATE'
    
    def is_update(self):
        """Verifica se √© atualiza√ß√£o de registro"""
        return self.acao == 'UPDATE'
    
    def is_delete(self):
        """Verifica se √© exclus√£o de registro"""
        return self.acao == 'DELETE'
    
    def is_export(self):
        """Verifica se √© exporta√ß√£o de dados"""
        return self.acao == 'EXPORT'
    
    def get_alteracoes(self):
        """
        Extrai as altera√ß√µes realizadas (campos modificados)
        
        Returns:
            dict: Dicion√°rio com campos alterados e seus valores antes/depois
        """
        if not self.is_update() or not self.dados_antes or not self.dados_depois:
            return {}
        
        alteracoes = {}
        for campo, valor_depois in self.dados_depois.items():
            valor_antes = self.dados_antes.get(campo)
            if valor_antes != valor_depois:
                alteracoes[campo] = {
                    'antes': valor_antes,
                    'depois': valor_depois
                }
        
        return alteracoes
    
    def to_dict(self, include_dados=False):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Args:
            include_dados (bool): Se deve incluir dados_antes e dados_depois
        
        Returns:
            dict: Dicion√°rio com dados do log
        """
        data = {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id) if self.usuario_id else None,
            'acao': self.acao,
            'entidade': self.entidade,
            'entidade_id': str(self.entidade_id) if self.entidade_id else None,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None,
            'sucesso': self.sucesso,
            'mensagem': self.mensagem
        }
        
        if include_dados:
            data['dados_antes'] = self.dados_antes
            data['dados_depois'] = self.dados_depois
            data['alteracoes'] = self.get_alteracoes()
        
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        status = "‚úì" if self.sucesso else "‚úó"
        usuario = self.usuario.username if self.usuario else "ANON"
        return f"<LogAuditoria {status} {usuario} {self.acao} {self.entidade or ''}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/movimentacao_caixa.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model MovimentacaoCaixa
Entidade para movimenta√ß√µes de caixa em corretoras
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoMovimentacao(enum.Enum):
    """Enum para tipos de movimenta√ß√£o"""
    DEPOSITO = "deposito"                    # Dep√≥sito na corretora
    SAQUE = "saque"                          # Saque da corretora
    TRANSFERENCIA_ENVIADA = "transf_env"    # Transfer√™ncia para outra corretora
    TRANSFERENCIA_RECEBIDA = "transf_rec"   # Transfer√™ncia de outra corretora
    CREDITO_PROVENTO = "credito_prov"       # Cr√©dito de provento
    PAGAMENTO_TAXA = "pagto_taxa"           # Pagamento de taxa/cust√≥dia
    PAGAMENTO_IMPOSTO = "pagto_imposto"     # Pagamento de imposto
    AJUSTE = "ajuste"                        # Ajuste manual
    OUTRO = "outro"                          # Outros tipos


class MovimentacaoCaixa(db.Model):
    """
    Model para movimenta√ß√µes de caixa em corretoras
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora (origem)
        tipo_movimentacao (TipoMovimentacao): Tipo da movimenta√ß√£o
        valor (Decimal): Valor da movimenta√ß√£o
        moeda (str): Moeda (BRL, USD, EUR)
        data_movimentacao (date): Data da movimenta√ß√£o
        corretora_destino_id (UUID): ID da corretora destino (transfer√™ncias)
        provento_id (UUID): ID do provento (se for cr√©dito de provento)
        descricao (str): Descri√ß√£o da movimenta√ß√£o
        comprovante (str): Refer√™ncia ao comprovante
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora origem
        corretora_destino: Corretora destino (para transfer√™ncias)
        provento: Provento relacionado (para cr√©ditos)
    """
    
    __tablename__ = 'movimentacao_caixa'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da movimenta√ß√£o"
    )
    
    # Foreign keys obrigat√≥rias
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora (origem)"
    )
    
    # Foreign keys opcionais
    corretora_destino_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID da corretora destino (apenas para transfer√™ncias)"
    )
    
    provento_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('provento.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        comment="ID do provento (apenas para cr√©dito de provento)"
    )
    
    # Dados da movimenta√ß√£o
    tipo_movimentacao = db.Column(
        Enum(TipoMovimentacao),
        nullable=False,
        index=True,
        comment="Tipo da movimenta√ß√£o"
    )
    
    valor = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor da movimenta√ß√£o"
    )
    
    moeda = db.Column(
        String(3),
        nullable=False,
        default='BRL',
        index=True,
        comment="C√≥digo ISO 4217 da moeda (BRL, USD, EUR)"
    )
    
    data_movimentacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da movimenta√ß√£o"
    )
    
    # Metadados
    descricao = db.Column(
        Text,
        nullable=True,
        comment="Descri√ß√£o da movimenta√ß√£o"
    )
    
    comprovante = db.Column(
        String(200),
        nullable=True,
        comment="Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='movimentacoes_caixa', lazy='joined')
    corretora = relationship(
        'Corretora',
        foreign_keys=[corretora_id],
        backref='movimentacoes_caixa',
        lazy='joined'
    )
    corretora_destino = relationship(
        'Corretora',
        foreign_keys=[corretora_destino_id],
        lazy='joined'
    )
    provento = relationship('Provento', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor > 0",
            name="movimentacao_valor_positivo"
        ),
        db.CheckConstraint(
            "moeda ~* '^[A-Z]{3}$'",
            name="movimentacao_moeda_iso_format"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao IN ('transferencia_enviada', 'transferencia_recebida') 
             AND corretora_destino_id IS NOT NULL)
            OR 
            (tipo_movimentacao NOT IN ('transferencia_enviada', 'transferencia_recebida'))
            """,
            name="movimentacao_transferencia_tem_destino"
        ),
        db.CheckConstraint(
            """
            (tipo_movimentacao = 'credito_provento' AND provento_id IS NOT NULL)
            OR 
            (tipo_movimentacao != 'credito_provento')
            """,
            name="movimentacao_credito_tem_provento"
        ),
        {'comment': 'Tabela de movimenta√ß√µes de caixa em corretoras'}
    )
    
    def is_entrada(self):
        """Verifica se √© movimenta√ß√£o de entrada (aumenta saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.DEPOSITO,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA,
            TipoMovimentacao.CREDITO_PROVENTO,
            TipoMovimentacao.AJUSTE  # Depende do contexto, mas inclu√≠mos aqui
        ]
    
    def is_saida(self):
        """Verifica se √© movimenta√ß√£o de sa√≠da (diminui saldo)"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.SAQUE,
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.PAGAMENTO_TAXA,
            TipoMovimentacao.PAGAMENTO_IMPOSTO
        ]
    
    def is_transferencia(self):
        """Verifica se √© transfer√™ncia entre corretoras"""
        return self.tipo_movimentacao in [
            TipoMovimentacao.TRANSFERENCIA_ENVIADA,
            TipoMovimentacao.TRANSFERENCIA_RECEBIDA
        ]
    
    def is_credito_provento(self):
        """Verifica se √© cr√©dito de provento"""
        return self.tipo_movimentacao == TipoMovimentacao.CREDITO_PROVENTO
    
    def impacto_saldo(self):
        """
        Calcula o impacto no saldo da corretora
        
        Returns:
            Decimal: Valor positivo para entradas, negativo para sa√≠das
        """
        if self.is_entrada():
            return self.valor
        elif self.is_saida():
            return -self.valor
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da movimenta√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'corretora_destino_id': str(self.corretora_destino_id) if self.corretora_destino_id else None,
            'provento_id': str(self.provento_id) if self.provento_id else None,
            'tipo_movimentacao': self.tipo_movimentacao.value if self.tipo_movimentacao else None,
            'valor': float(self.valor) if self.valor else 0,
            'moeda': self.moeda,
            'impacto_saldo': float(self.impacto_saldo()),
            'data_movimentacao': self.data_movimentacao.isoformat() if self.data_movimentacao else None,
            'descricao': self.descricao,
            'comprovante': self.comprovante,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = self.tipo_movimentacao.value if self.tipo_movimentacao else "N/A"
        sinal = "+" if self.is_entrada() else "-"
        return f"<MovimentacaoCaixa {tipo.upper()} {sinal} {self.moeda} {self.valor}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/posicao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Posicao
Entidade para holdings/posi√ß√µes em carteira de ativos
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Numeric, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid


class Posicao(db.Model):
    """
    Model para posi√ß√µes em carteira (holdings)
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio propriet√°rio
        corretora_id (UUID): ID da corretora onde est√° a posi√ß√£o
        ativo_id (UUID): ID do ativo
        quantidade (Decimal): Quantidade de ativos em posse
        preco_medio (Decimal): Pre√ßo m√©dio de aquisi√ß√£o
        custo_total (Decimal): Custo total investido
        taxas_acumuladas (Decimal): Taxas de corretagem acumuladas
        impostos_acumulados (Decimal): Impostos pagos acumulados
        valor_atual (Decimal): Valor de mercado atual da posi√ß√£o
        lucro_prejuizo_realizado (Decimal): L/P realizado (vendas)
        lucro_prejuizo_nao_realizado (Decimal): L/P n√£o realizado
        data_primeira_compra (date): Data da primeira aquisi√ß√£o
        data_ultima_atualizacao (datetime): √öltima atualiza√ß√£o
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio propriet√°rio
        corretora: Corretora onde est√° a posi√ß√£o
        ativo: Ativo da posi√ß√£o
    """
    
    __tablename__ = 'posicao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da posi√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio propriet√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora onde est√° a posi√ß√£o"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo"
    )
    
    # Dados da posi√ß√£o
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        default=0,
        comment="Quantidade de ativos (suporta fracion√°rios)"
    )
    
    preco_medio = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        default=0,
        comment="Pre√ßo m√©dio de aquisi√ß√£o"
    )
    
    custo_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Custo total investido (quantidade * pre√ßo m√©dio)"
    )
    
    taxas_acumuladas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem e cust√≥dia acumuladas"
    )
    
    impostos_acumulados = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Impostos pagos acumulados (IR, IOF, etc.)"
    )
    
    # Valores calculados
    valor_atual = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de mercado atual da posi√ß√£o"
    )
    
    lucro_prejuizo_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Lucro/preju√≠zo realizado em vendas"
    )
    
    lucro_prejuizo_nao_realizado = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)"
    )
    
    # Datas
    data_primeira_compra = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data da primeira aquisi√ß√£o deste ativo"
    )
    
    data_ultima_atualizacao = db.Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="Data da √∫ltima atualiza√ß√£o de valores"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='posicoes', lazy='joined')
    corretora = relationship('Corretora', backref='posicoes', lazy='joined')
    ativo = relationship('Ativo', backref='posicoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade >= 0",
            name="posicao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_medio >= 0",
            name="posicao_preco_medio_positivo"
        ),
        db.CheckConstraint(
            "custo_total >= 0",
            name="posicao_custo_total_positivo"
        ),
        db.CheckConstraint(
            "taxas_acumuladas >= 0",
            name="posicao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos_acumulados >= 0",
            name="posicao_impostos_positivos"
        ),
        db.UniqueConstraint(
            'usuario_id', 'corretora_id', 'ativo_id',
            name='unique_posicao_usuario_corretora_ativo'
        ),
        {'comment': 'Tabela de posi√ß√µes em carteira (holdings)'}
    )
    
    def calcular_valor_atual(self, preco_mercado):
        """
        Calcula o valor atual da posi√ß√£o baseado no pre√ßo de mercado
        
        Args:
            preco_mercado (Decimal): Pre√ßo atual do ativo no mercado
        
        Returns:
            Decimal: Valor atual da posi√ß√£o
        """
        self.valor_atual = self.quantidade * preco_mercado
        self.data_ultima_atualizacao = datetime.utcnow()
        return self.valor_atual
    
    def calcular_lucro_prejuizo_nao_realizado(self):
        """
        Calcula o lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)
        
        Returns:
            Decimal: L/P n√£o realizado
        """
        if self.valor_atual is not None:
            self.lucro_prejuizo_nao_realizado = self.valor_atual - self.custo_total
        return self.lucro_prejuizo_nao_realizado
    
    def adicionar_compra(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma compra √† posi√ß√£o (recalcula pre√ßo m√©dio)
        
        Args:
            quantidade (Decimal): Quantidade comprada
            preco_unitario (Decimal): Pre√ßo unit√°rio da compra
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        """
        # Garantir valores n√£o-None (defaults do SQLAlchemy s√≥ aplicam ao persistir)
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        custo_compra = quantidade * preco_unitario
        
        # Recalcular pre√ßo m√©dio ponderado
        novo_custo_total = self.custo_total + custo_compra
        nova_quantidade = self.quantidade + quantidade
        
        if nova_quantidade > 0:
            self.preco_medio = novo_custo_total / nova_quantidade
        
        self.quantidade = nova_quantidade
        self.custo_total = novo_custo_total
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Definir data primeira compra se for a primeira
        if self.data_primeira_compra is None:
            self.data_primeira_compra = datetime.utcnow().date()

    
    def adicionar_venda(self, quantidade, preco_unitario, taxas=0, impostos=0):
        """
        Adiciona uma venda √† posi√ß√£o
        
        Args:
            quantidade (Decimal): Quantidade vendida
            preco_unitario (Decimal): Pre√ßo unit√°rio da venda
            taxas (Decimal): Taxas da opera√ß√£o
            impostos (Decimal): Impostos da opera√ß√£o
        
        Raises:
            ValueError: Se quantidade vendida for maior que quantidade em posse
        """
        # Garantir valores n√£o-None
        if self.quantidade is None:
            self.quantidade = 0
        if self.preco_medio is None:
            self.preco_medio = 0
        if self.custo_total is None:
            self.custo_total = 0
        if self.taxas_acumuladas is None:
            self.taxas_acumuladas = 0
        if self.impostos_acumulados is None:
            self.impostos_acumulados = 0
        if self.lucro_prejuizo_realizado is None:
            self.lucro_prejuizo_realizado = 0
        
        if quantidade > self.quantidade:
            raise ValueError(
                f"Quantidade vendida ({quantidade}) maior que quantidade em posse ({self.quantidade})"
            )
        
        # Calcular lucro/preju√≠zo realizado
        receita_venda = quantidade * preco_unitario
        custo_proporcional = quantidade * self.preco_medio
        lp_realizado = receita_venda - custo_proporcional - taxas - impostos
        
        self.lucro_prejuizo_realizado += lp_realizado
        self.quantidade -= quantidade
        self.custo_total -= custo_proporcional
        self.taxas_acumuladas += taxas
        self.impostos_acumulados += impostos
        
        # Se zerou a posi√ß√£o, resetar pre√ßo m√©dio
        if self.quantidade == 0:
            self.preco_medio = 0
            self.custo_total = 0

    
    def percentual_lucro_prejuizo(self):
        """
        Calcula o percentual de lucro/preju√≠zo n√£o realizado
        
        Returns:
            Decimal: Percentual de L/P (ex: 15.5 = 15.5%)
        """
        if self.custo_total > 0 and self.lucro_prejuizo_nao_realizado is not None:
            return (self.lucro_prejuizo_nao_realizado / self.custo_total) * 100
        return 0
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da posi√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_medio': float(self.preco_medio) if self.preco_medio else 0,
            'custo_total': float(self.custo_total) if self.custo_total else 0,
            'taxas_acumuladas': float(self.taxas_acumuladas) if self.taxas_acumuladas else 0,
            'impostos_acumulados': float(self.impostos_acumulados) if self.impostos_acumulados else 0,
            'valor_atual': float(self.valor_atual) if self.valor_atual else None,
            'lucro_prejuizo_realizado': float(self.lucro_prejuizo_realizado) if self.lucro_prejuizo_realizado else 0,
            'lucro_prejuizo_nao_realizado': float(self.lucro_prejuizo_nao_realizado) if self.lucro_prejuizo_nao_realizado else None,
            'percentual_lp': float(self.percentual_lucro_prejuizo()),
            'data_primeira_compra': self.data_primeira_compra.isoformat() if self.data_primeira_compra else None,
            'data_ultima_atualizacao': self.data_ultima_atualizacao.isoformat() if self.data_ultima_atualizacao else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Posicao {self.quantidade}x {self.ativo.ticker if self.ativo else 'N/A'}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/provento.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Provento
Entidade para registro de proventos (dividendos, JCP, rendimentos)
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoProvento(enum.Enum):
    """Enum para tipos de provento"""
    DIVIDENDO = "dividendo"              # Dividendo ordin√°rio
    JCP = "jcp"                          # Juros sobre Capital Pr√≥prio
    RENDIMENTO = "rendimento"            # Rendimento de FII
    CUPOM = "cupom"                      # Cupom de t√≠tulo de renda fixa
    BONIFICACAO = "bonificacao"          # Bonifica√ß√£o em dinheiro
    DIREITO_SUBSCRICAO = "direito_sub"   # Direito de subscri√ß√£o vendido
    OUTRO = "outro"                      # Outros tipos


class Provento(db.Model):
    """
    Model para proventos recebidos de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        ativo_id (UUID): ID do ativo que pagou o provento
        tipo_provento (TipoProvento): Tipo do provento
        valor_por_acao (Decimal): Valor unit√°rio por ativo
        data_com (date): Data COM (√∫ltimo dia para ter direito)
        data_pagamento (date): Data efetiva do pagamento
        quantidade_ativos (Decimal): Quantidade de ativos que geraram provento
        valor_bruto (Decimal): Valor bruto recebido
        imposto_retido (Decimal): IR retido na fonte
        valor_liquido (Decimal): Valor l√≠quido creditado
        observacoes (str): Observa√ß√µes sobre o provento
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        ativo: Ativo que pagou o provento
    """
    
    __tablename__ = 'provento'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico do provento"
    )
    
    # Foreign key
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo que pagou o provento"
    )
    
    # Tipo de provento
    tipo_provento = db.Column(
        Enum(TipoProvento),
        nullable=False,
        index=True,
        comment="Tipo do provento (dividendo, JCP, rendimento, etc.)"
    )
    
    # Valores
    valor_por_acao = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Valor unit√°rio por ativo"
    )
    
    quantidade_ativos = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade de ativos que geraram o provento"
    )
    
    valor_bruto = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor bruto recebido"
    )
    
    imposto_retido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte"
    )
    
    valor_liquido = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor l√≠quido creditado"
    )
    
    # Datas
    data_com = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data COM (√∫ltimo dia para ter direito ao provento)"
    )
    
    data_pagamento = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data efetiva do pagamento"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre o provento"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    ativo = relationship('Ativo', backref='proventos', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "valor_por_acao > 0",
            name="provento_valor_por_acao_positivo"
        ),
        db.CheckConstraint(
            "quantidade_ativos > 0",
            name="provento_quantidade_positiva"
        ),
        db.CheckConstraint(
            "valor_bruto > 0",
            name="provento_valor_bruto_positivo"
        ),
        db.CheckConstraint(
            "imposto_retido >= 0",
            name="provento_imposto_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido > 0",
            name="provento_valor_liquido_positivo"
        ),
        db.CheckConstraint(
            "valor_liquido <= valor_bruto",
            name="provento_liquido_menor_bruto"
        ),
        db.CheckConstraint(
            "data_pagamento >= data_com",
            name="provento_data_pagamento_valida"
        ),
        {'comment': 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa provento com c√°lculos autom√°ticos
        """
        super(Provento, self).__init__(**kwargs)
        
        # Calcular valor bruto se n√£o fornecido
        if self.valor_bruto is None and self.valor_por_acao and self.quantidade_ativos:
            self.valor_bruto = self.valor_por_acao * self.quantidade_ativos
        
        # Calcular valor l√≠quido se n√£o fornecido
        if self.valor_liquido is None and self.valor_bruto is not None:
            imposto = self.imposto_retido if self.imposto_retido else 0
            self.valor_liquido = self.valor_bruto - imposto
    
    def is_dividendo(self):
        """Verifica se √© dividendo"""
        return self.tipo_provento == TipoProvento.DIVIDENDO
    
    def is_jcp(self):
        """Verifica se √© JCP"""
        return self.tipo_provento == TipoProvento.JCP
    
    def is_rendimento_fii(self):
        """Verifica se √© rendimento de FII"""
        return self.tipo_provento == TipoProvento.RENDIMENTO
    
    def percentual_imposto(self):
        """
        Calcula o percentual de imposto retido
        
        Returns:
            Decimal: Percentual de imposto (ex: 15.0 = 15%)
        """
        if self.valor_bruto and self.valor_bruto > 0:
            imposto = self.imposto_retido if self.imposto_retido else 0
            return (imposto / self.valor_bruto) * 100
        return 0
    
    def dividend_yield_efetivo(self, preco_ativo):
        """
        Calcula o dividend yield efetivo baseado no pre√ßo do ativo
        
        Args:
            preco_ativo (Decimal): Pre√ßo atual do ativo
            
        Returns:
            Decimal: DY efetivo em % (ex: 6.5 = 6.5%)
        """
        if preco_ativo and preco_ativo > 0:
            return (self.valor_por_acao / preco_ativo) * 100
        return 0
    
    def dias_ate_pagamento(self):
        """
        Calcula quantos dias faltam para o pagamento
        
        Returns:
            int: Dias at√© pagamento (negativo se j√° pago)
        """
        hoje = datetime.utcnow().date()
        delta = self.data_pagamento - hoje
        return delta.days
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados do provento
        """
        return {
            'id': str(self.id),
            'ativo_id': str(self.ativo_id),
            'tipo_provento': self.tipo_provento.value if self.tipo_provento else None,
            'valor_por_acao': float(self.valor_por_acao) if self.valor_por_acao else 0,
            'quantidade_ativos': float(self.quantidade_ativos) if self.quantidade_ativos else 0,
            'valor_bruto': float(self.valor_bruto) if self.valor_bruto else 0,
            'imposto_retido': float(self.imposto_retido) if self.imposto_retido else 0,
            'valor_liquido': float(self.valor_liquido) if self.valor_liquido else 0,
            'percentual_imposto': float(self.percentual_imposto()),
            'data_com': self.data_com.isoformat() if self.data_com else None,
            'data_pagamento': self.data_pagamento.isoformat() if self.data_pagamento else None,
            'dias_ate_pagamento': self.dias_ate_pagamento(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        ticker = self.ativo.ticker if self.ativo else "N/A"
        tipo = self.tipo_provento.value if self.tipo_provento else "N/A"
        return f"<Provento {tipo.upper()} {ticker} R$ {self.valor_por_acao}/a√ß√£o>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/regra_fiscal.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model RegraFiscal
Entidade para regras tribut√°rias por pa√≠s e tipo de ativo
"""

from datetime import datetime, date
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum, Numeric, Text, Date
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum


class IncidenciaImposto(enum.Enum):
    """Enum para tipo de incid√™ncia do imposto"""
    LUCRO = "lucro"              # Incide sobre lucro/ganho de capital
    RECEITA = "receita"          # Incide sobre receita bruta
    PROVENTO = "provento"        # Incide sobre proventos recebidos
    OPERACAO = "operacao"        # Incide sobre cada opera√ß√£o


class RegraFiscal(db.Model):
    """
    Model para regras tribut√°rias
    
    Attributes:
        id (UUID): Identificador √∫nico
        pais (str): Pa√≠s da regra (c√≥digo ISO)
        tipo_ativo (str): Tipo de ativo (ACAO, FII, REIT, etc.)
        tipo_operacao (str): Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE)
        aliquota_ir (Decimal): Al√≠quota de IR em %
        valor_isencao (Decimal): Valor de isen√ß√£o mensal
        incide_sobre (IncidenciaImposto): Sobre o que incide o imposto
        descricao (str): Descri√ß√£o da regra
        vigencia_inicio (date): Data de in√≠cio da vig√™ncia
        vigencia_fim (date): Data de fim da vig√™ncia
        ativa (bool): Indica se regra est√° ativa
        created_at (datetime): Data de cria√ß√£o
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    """
    
    __tablename__ = 'regra_fiscal'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da regra"
    )
    
    # Identifica√ß√£o da regra
    pais = db.Column(
        String(2),
        nullable=False,
        index=True,
        comment="C√≥digo ISO do pa√≠s (BR, US, etc.)"
    )
    
    tipo_ativo = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos"
    )
    
    tipo_operacao = db.Column(
        String(20),
        nullable=True,
        index=True,
        comment="Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas"
    )
    
    # Valores fiscais
    aliquota_ir = db.Column(
        Numeric(precision=6, scale=4),
        nullable=False,
        comment="Al√≠quota de IR em % (ex: 15.0000 = 15%)"
    )
    
    valor_isencao = db.Column(
        Numeric(precision=18, scale=2),
        nullable=True,
        comment="Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)"
    )
    
    incide_sobre = db.Column(
        Enum(IncidenciaImposto),
        nullable=False,
        index=True,
        comment="Sobre o que incide o imposto"
    )
    
    # Descri√ß√£o
    descricao = db.Column(
        Text,
        nullable=False,
        comment="Descri√ß√£o detalhada da regra fiscal"
    )
    
    # Vig√™ncia
    vigencia_inicio = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data de in√≠cio da vig√™ncia da regra"
    )
    
    vigencia_fim = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de fim da vig√™ncia (NULL = vigente indefinidamente)"
    )
    
    # Status
    ativa = db.Column(
        Boolean,
        default=True,
        nullable=False,
        index=True,
        comment="Indica se regra est√° ativa"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "aliquota_ir >= 0 AND aliquota_ir <= 100",
            name="regra_aliquota_valida"
        ),
        db.CheckConstraint(
            "valor_isencao IS NULL OR valor_isencao >= 0",
            name="regra_isencao_positiva"
        ),
        db.CheckConstraint(
            "pais ~* '^[A-Z]{2}$'",
            name="regra_pais_iso_format"
        ),
        db.CheckConstraint(
            "vigencia_fim IS NULL OR vigencia_fim >= vigencia_inicio",
            name="regra_vigencia_valida"
        ),
        {'comment': 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo'}
    )
    
    def is_active(self):
        """Verifica se regra est√° ativa"""
        return self.ativa
    
    def is_vigente(self, data_referencia=None):
        """
        Verifica se regra est√° vigente em uma data
        
        Args:
            data_referencia (date): Data de refer√™ncia (default: hoje)
            
        Returns:
            bool: True se vigente
        """
        if not self.ativa:
            return False
        
        if data_referencia is None:
            data_referencia = datetime.utcnow().date()
        
        # Verifica in√≠cio
        if data_referencia < self.vigencia_inicio:
            return False
        
        # Verifica fim (se definido)
        if self.vigencia_fim and data_referencia > self.vigencia_fim:
            return False
        
        return True
    
    def tem_isencao(self):
        """Verifica se regra possui valor de isen√ß√£o"""
        return self.valor_isencao is not None and self.valor_isencao > 0
    
    def calcular_imposto(self, base_calculo):
        """
        Calcula o imposto devido sobre uma base de c√°lculo
        
        Args:
            base_calculo (Decimal): Valor base para c√°lculo
            
        Returns:
            Decimal: Valor do imposto devido
        """
        # Se tem isen√ß√£o e base est√° abaixo, n√£o h√° imposto
        if self.tem_isencao() and base_calculo <= self.valor_isencao:
            return 0
        
        # Calcula imposto sobre o valor (ou valor acima da isen√ß√£o)
        valor_tributavel = base_calculo
        if self.tem_isencao():
            valor_tributavel = base_calculo - self.valor_isencao
        
        imposto = valor_tributavel * (self.aliquota_ir / 100)
        return max(imposto, 0)  # Nunca retornar negativo
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da regra
        """
        return {
            'id': str(self.id),
            'pais': self.pais,
            'tipo_ativo': self.tipo_ativo,
            'tipo_operacao': self.tipo_operacao,
            'aliquota_ir': float(self.aliquota_ir) if self.aliquota_ir else 0,
            'valor_isencao': float(self.valor_isencao) if self.valor_isencao else None,
            'incide_sobre': self.incide_sobre.value if self.incide_sobre else None,
            'descricao': self.descricao,
            'vigencia_inicio': self.vigencia_inicio.isoformat() if self.vigencia_inicio else None,
            'vigencia_fim': self.vigencia_fim.isoformat() if self.vigencia_fim else None,
            'ativa': self.ativa,
            'vigente': self.is_vigente(),
            'tem_isencao': self.tem_isencao(),
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<RegraFiscal {self.pais} {self.tipo_ativo or 'ALL'} IR={self.aliquota_ir}%>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/transacao.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Transacao
Entidade para registro de opera√ß√µes de compra e venda de ativos
"""

from datetime import datetime, timedelta
from app.database import db
from sqlalchemy import String, DateTime, Enum, Numeric, Text, Date, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum


class TipoOperacao(enum.Enum):
    """Enum para tipos de opera√ß√£o"""
    COMPRA = "compra"
    VENDA = "venda"


class Transacao(db.Model):
    """
    Model para transa√ß√µes de compra e venda de ativos
    
    Attributes:
        id (UUID): Identificador √∫nico
        usuario_id (UUID): ID do usu√°rio
        corretora_id (UUID): ID da corretora
        ativo_id (UUID): ID do ativo
        tipo_operacao (TipoOperacao): COMPRA ou VENDA
        quantidade (Decimal): Quantidade transacionada
        preco_unitario (Decimal): Pre√ßo por unidade
        valor_total (Decimal): Valor total da opera√ß√£o
        taxas (Decimal): Taxas de corretagem e cust√≥dia
        impostos (Decimal): IR e outros impostos
        data_operacao (date): Data da opera√ß√£o
        data_liquidacao (date): Data de liquida√ß√£o
        observacoes (str): Observa√ß√µes sobre a transa√ß√£o
        created_at (datetime): Data de cria√ß√£o do registro
        updated_at (datetime): Data da √∫ltima atualiza√ß√£o
    
    Relationships:
        usuario: Usu√°rio que realizou a opera√ß√£o
        corretora: Corretora onde foi realizada
        ativo: Ativo transacionado
    """
    
    __tablename__ = 'transacao'
    
    # Chave prim√°ria
    id = db.Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        comment="Identificador √∫nico da transa√ß√£o"
    )
    
    # Foreign keys
    usuario_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('usuario.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID do usu√°rio"
    )
    
    corretora_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('corretora.id', ondelete='CASCADE'),
        nullable=False,
        index=True,
        comment="ID da corretora"
    )
    
    ativo_id = db.Column(
        UUID(as_uuid=True),
        ForeignKey('ativo.id', ondelete='RESTRICT'),
        nullable=False,
        index=True,
        comment="ID do ativo transacionado"
    )
    
    # Dados da transa√ß√£o
    tipo_operacao = db.Column(
        Enum(TipoOperacao),
        nullable=False,
        index=True,
        comment="Tipo de opera√ß√£o: COMPRA ou VENDA"
    )
    
    quantidade = db.Column(
        Numeric(precision=18, scale=8),
        nullable=False,
        comment="Quantidade transacionada (suporta fracion√°rios)"
    )
    
    preco_unitario = db.Column(
        Numeric(precision=18, scale=6),
        nullable=False,
        comment="Pre√ßo por unidade"
    )
    
    valor_total = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        comment="Valor total da opera√ß√£o (quantidade * pre√ßo)"
    )
    
    taxas = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="Taxas de corretagem, cust√≥dia, emolumentos"
    )
    
    impostos = db.Column(
        Numeric(precision=18, scale=2),
        nullable=False,
        default=0,
        comment="IR retido na fonte, IOF, etc."
    )
    
    # Datas
    data_operacao = db.Column(
        Date,
        nullable=False,
        index=True,
        comment="Data da opera√ß√£o"
    )
    
    data_liquidacao = db.Column(
        Date,
        nullable=True,
        index=True,
        comment="Data de liquida√ß√£o (D+2, D+3, etc.)"
    )
    
    # Metadados
    observacoes = db.Column(
        Text,
        nullable=True,
        comment="Observa√ß√µes sobre a transa√ß√£o"
    )
    
    # Timestamps
    created_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        nullable=False,
        comment="Data de cria√ß√£o do registro"
    )
    
    updated_at = db.Column(
        DateTime(timezone=True),
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
        comment="Data da √∫ltima atualiza√ß√£o"
    )
    
    # Relacionamentos
    usuario = relationship('Usuario', backref='transacoes', lazy='joined')
    corretora = relationship('Corretora', backref='transacoes', lazy='joined')
    ativo = relationship('Ativo', backref='transacoes', lazy='joined')
    
    # Constraints de tabela
    __table_args__ = (
        db.CheckConstraint(
            "quantidade > 0",
            name="transacao_quantidade_positiva"
        ),
        db.CheckConstraint(
            "preco_unitario > 0",
            name="transacao_preco_positivo"
        ),
        db.CheckConstraint(
            "valor_total > 0",
            name="transacao_valor_total_positivo"
        ),
        db.CheckConstraint(
            "taxas >= 0",
            name="transacao_taxas_positivas"
        ),
        db.CheckConstraint(
            "impostos >= 0",
            name="transacao_impostos_positivos"
        ),
        db.CheckConstraint(
            "data_liquidacao IS NULL OR data_liquidacao >= data_operacao",
            name="transacao_data_liquidacao_valida"
        ),
        {'comment': 'Tabela de transa√ß√µes de compra e venda de ativos'}
    )
    
    def __init__(self, **kwargs):
        """
        Inicializa transa√ß√£o com c√°lculos autom√°ticos
        """
        super(Transacao, self).__init__(**kwargs)
        
        # Calcular valor total se n√£o fornecido
        if self.valor_total is None and self.quantidade and self.preco_unitario:
            self.valor_total = self.quantidade * self.preco_unitario
        
        # Calcular data de liquida√ß√£o se n√£o fornecida (D+2 para a√ß√µes BR)
        if self.data_liquidacao is None and self.data_operacao:
            self.data_liquidacao = self.data_operacao + timedelta(days=2)
    
    def is_compra(self):
        """Verifica se √© uma opera√ß√£o de compra"""
        return self.tipo_operacao == TipoOperacao.COMPRA
    
    def is_venda(self):
        """Verifica se √© uma opera√ß√£o de venda"""
        return self.tipo_operacao == TipoOperacao.VENDA
    
    def custo_total(self):
        """
        Calcula o custo total da opera√ß√£o (valor + taxas + impostos)
        
        Returns:
            Decimal: Custo total
        """
        taxas = self.taxas if self.taxas else 0
        impostos = self.impostos if self.impostos else 0
        return self.valor_total + taxas + impostos
    
    def receita_liquida(self):
        """
        Calcula a receita l√≠quida em caso de venda (valor - taxas - impostos)
        
        Returns:
            Decimal: Receita l√≠quida (None se n√£o for venda)
        """
        if not self.is_venda():
            return None
        
        taxas = self.taxas if self.taxas else 0
        impostos = self.impostos if self.impostos else 0
        return self.valor_total - taxas - impostos
    
    def percentual_custos(self):
        """
        Calcula o percentual de custos (taxas + impostos) sobre o valor
        
        Returns:
            Decimal: Percentual de custos (ex: 1.5 = 1.5%)
        """
        if self.valor_total > 0:
            taxas = self.taxas if self.taxas else 0
            impostos = self.impostos if self.impostos else 0
            total_custos = taxas + impostos
            return (total_custos / self.valor_total) * 100
        return 0
    
    def dias_ate_liquidacao(self):
        """
        Calcula quantos dias faltam para liquida√ß√£o
        
        Returns:
            int: Dias at√© liquida√ß√£o (negativo se j√° liquidada)
        """
        if self.data_liquidacao:
            hoje = datetime.utcnow().date()
            delta = self.data_liquidacao - hoje
            return delta.days
        return None
    
    def to_dict(self):
        """
        Converte objeto para dicion√°rio (para serializa√ß√£o JSON)
        
        Returns:
            dict: Dicion√°rio com dados da transa√ß√£o
        """
        return {
            'id': str(self.id),
            'usuario_id': str(self.usuario_id),
            'corretora_id': str(self.corretora_id),
            'ativo_id': str(self.ativo_id),
            'tipo_operacao': self.tipo_operacao.value if self.tipo_operacao else None,
            'quantidade': float(self.quantidade) if self.quantidade else 0,
            'preco_unitario': float(self.preco_unitario) if self.preco_unitario else 0,
            'valor_total': float(self.valor_total) if self.valor_total else 0,
            'taxas': float(self.taxas) if self.taxas else 0,
            'impostos': float(self.impostos) if self.impostos else 0,
            'custo_total': float(self.custo_total()),
            'receita_liquida': float(self.receita_liquida()) if self.receita_liquida() else None,
            'percentual_custos': float(self.percentual_custos()),
            'data_operacao': self.data_operacao.isoformat() if self.data_operacao else None,
            'data_liquidacao': self.data_liquidacao.isoformat() if self.data_liquidacao else None,
            'dias_ate_liquidacao': self.dias_ate_liquidacao(),
            'observacoes': self.observacoes,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        tipo = "COMPRA" if self.is_compra() else "VENDA"
        ticker = self.ativo.ticker if self.ativo else "N/A"
        return f"<Transacao {tipo} {self.quantidade}x {ticker} @ {self.preco_unitario}>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/models/usuario.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Model Usuario
Entidade principal para autentica√ß√£o e gest√£o de usu√°rios
"""

from datetime import datetime
from app.database import db
from sqlalchemy import String, Boolean, DateTime, Enum
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum
from werkzeug.security import generate_password_hash, check_password_hash


class UserRole(enum.Enum):
    """Enum para roles/perfis de usu√°rio"""
    ADMIN = "admin"
    USER = "user"
    READONLY = "readonly"


class Usuario(db.Model):
    """Model para usu√°rios do sistema Exitus"""
    
    __tablename__ = 'usuario'
    
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = db.Column(String(50), unique=True, nullable=False, index=True)
    email = db.Column(String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(String(255), nullable=False)
    nome_completo = db.Column(String(200), nullable=True)
    ativo = db.Column(Boolean, default=True, nullable=False)
    role = db.Column(Enum(UserRole), default=UserRole.USER, nullable=False)
    created_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)
    updated_at = db.Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    def set_password(self, password):
        """Define a senha do usu√°rio (gera hash bcrypt)"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Verifica se a senha fornecida est√° correta"""
        return check_password_hash(self.password_hash, password)
    
    def is_admin(self):
        """Verifica se usu√°rio √© administrador"""
        return self.role == UserRole.ADMIN
    
    def is_active(self):
        """Verifica se usu√°rio est√° ativo"""
        return self.ativo
    
    def to_dict(self, include_sensitive=False):
        """Converte objeto para dicion√°rio (para serializa√ß√£o JSON)"""
        data = {
            'id': str(self.id),
            'username': self.username,
            'email': self.email,
            'nome_completo': self.nome_completo,
            'ativo': self.ativo,
            'role': self.role.value if self.role else UserRole.USER.value,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
        if include_sensitive:
            data['password_hash'] = self.password_hash
        return data
    
    def __repr__(self):
        """Representa√ß√£o string do objeto"""
        return f"<Usuario {self.username} ({self.email})>"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/__init__.py ---

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/run_all_seeds.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Executar Todos os Seeds
Script master para popular o banco com dados iniciais
"""

import sys
from app.seeds.seed_usuarios import seed_usuarios
from app.seeds.seed_ativos_br import seed_ativos_br
from app.seeds.seed_regras_fiscais_br import seed_regras_fiscais_br
from app.seeds.seed_feriados_b3 import seed_feriados_b3
from app.seeds.seed_fontes_dados import seed_fontes_dados


def run_all_seeds():
    """Executa todos os seeds em sequ√™ncia"""
    
    print("\n" + "=" * 60)
    print("  EXITUS - EXECUTAR TODOS OS SEEDS")
    print("=" * 60)
    print("\nEste script ir√° popular o banco com dados iniciais:")
    print("  1. Usu√°rios (4)")
    print("  2. Ativos BR (25)")
    print("  3. Regras Fiscais BR (6)")
    print("  4. Feriados B3 2025-2026 (30)")
    print("  5. Fontes de Dados (7)")
    print("\n‚ö† ATEN√á√ÉO: Seeds existentes ser√£o solicitados para confirma√ß√£o.\n")
    
    resposta = input("Deseja continuar? (s/N): ").lower()
    if resposta != 's':
        print("\n‚úó Opera√ß√£o cancelada pelo usu√°rio.\n")
        return
    
    seeds = [
        ("Usu√°rios", seed_usuarios),
        ("Ativos BR", seed_ativos_br),
        ("Regras Fiscais BR", seed_regras_fiscais_br),
        ("Feriados B3", seed_feriados_b3),
        ("Fontes de Dados", seed_fontes_dados),
    ]
    
    sucessos = 0
    erros = 0
    
    for nome, seed_func in seeds:
        print("\n" + "=" * 60)
        try:
            seed_func()
            sucessos += 1
        except KeyboardInterrupt:
            print(f"\n\n‚ö† Seed '{nome}' interrompido pelo usu√°rio.")
            print("Processo de seeds cancelado.\n")
            sys.exit(1)
        except Exception as e:
            print(f"\n‚úó Erro ao executar seed '{nome}': {e}")
            erros += 1
            resposta = input("\nDeseja continuar com os pr√≥ximos seeds? (s/N): ").lower()
            if resposta != 's':
                break
    
    # Resumo final
    print("\n" + "=" * 60)
    print("  RESUMO FINAL")
    print("=" * 60)
    print(f"‚úì Seeds executados com sucesso: {sucessos}")
    if erros > 0:
        print(f"‚úó Seeds com erro: {erros}")
    print("=" * 60 + "\n")
    
    if erros == 0:
        print("üéâ Todos os seeds foram executados com sucesso!")
        print("O banco de dados est√° pronto para uso.\n")
    else:
        print("‚ö† Alguns seeds falharam. Verifique os erros acima.\n")


if __name__ == '__main__':
    run_all_seeds()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_ativos_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Ativos Brasileiros
Popular tabela ativo com a√ß√µes e FIIs da B3
"""

from app import create_app
from app.database import db
from app.models import Ativo, TipoAtivo, ClasseAtivo
from decimal import Decimal


def seed_ativos_br():
    """Cria ativos brasileiros (B3)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Ativos Brasileiros (B3)")
        print("=" * 50)
        
        # Verificar se j√° existem ativos
        count = Ativo.query.filter_by(mercado='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} ativos brasileiros cadastrados.")
            resposta = input("Deseja recriar os ativos BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar ativos BR existentes
            Ativo.query.filter_by(mercado='BR').delete()
            db.session.commit()
            print("‚úì Ativos brasileiros anteriores removidos.")
        
        # A√ß√µes mais negociadas da B3
        acoes = [
            # Ticker, Nome, Setor, Pre√ßo Inicial
            ('PETR4', 'Petrobras PN', 'Petr√≥leo e G√°s', Decimal('38.50')),
            ('VALE3', 'Vale ON', 'Minera√ß√£o', Decimal('62.80')),
            ('ITUB4', 'Ita√∫ Unibanco PN', 'Bancos', Decimal('28.45')),
            ('BBDC4', 'Bradesco PN', 'Bancos', Decimal('13.20')),
            ('BBAS3', 'Banco do Brasil ON', 'Bancos', Decimal('25.60')),
            ('MGLU3', 'Magazine Luiza ON', 'Varejo', Decimal('8.75')),
            ('WEGE3', 'WEG ON', 'M√°quinas e Equipamentos', Decimal('42.30')),
            ('RENT3', 'Localiza ON', 'Loca√ß√£o de Ve√≠culos', Decimal('56.90')),
            ('RAIL3', 'Rumo ON', 'Transporte', Decimal('18.45')),
            ('SUZB3', 'Suzano ON', 'Papel e Celulose', Decimal('52.80')),
            ('KLBN11', 'Klabin Units', 'Papel e Celulose', Decimal('22.15')),
            ('ELET3', 'Eletrobras ON', 'Energia El√©trica', Decimal('42.10')),
            ('CMIG4', 'Cemig PN', 'Energia El√©trica', Decimal('10.85')),
            ('CPLE6', 'Copel PNB', 'Energia El√©trica', Decimal('8.95')),
            ('ABEV3', 'Ambev ON', 'Bebidas', Decimal('11.20')),
        ]
        
        # FIIs mais negociados
        fiis = [
            # Ticker, Nome, Segmento, Pre√ßo Inicial
            ('HGLG11', 'CSHG Log√≠stica FII', 'Log√≠stica', Decimal('152.30')),
            ('VISC11', 'Vinci Shopping Centers FII', 'Shopping', Decimal('105.80')),
            ('KNRI11', 'Kinea Renda Imobili√°ria FII', 'H√≠brido', Decimal('98.45')),
            ('BTLG11', 'BTG Pactual Log√≠stica FII', 'Log√≠stica', Decimal('102.70')),
            ('XPML11', 'XP Malls FII', 'Shopping', Decimal('95.60')),
            ('MXRF11', 'Maxi Renda FII', 'H√≠brido', Decimal('10.25')),
            ('TRXF11', 'TRX Real Estate FII', 'Lajes Corporativas', Decimal('95.30')),
            ('KNCR11', 'Kinea Rendimentos Imobili√°rios FII', 'Papel', Decimal('110.50')),
            ('LVBI11', 'VBI Log√≠stico FII', 'Log√≠stica', Decimal('98.20')),
            ('GGRC11', 'GGR Covepi Renda FII', 'Lajes Corporativas', Decimal('105.40')),
        ]
        
        created_ativos = []
        
        # Criar a√ß√µes
        print("\nüìà Criando A√ß√µes...")
        for ticker, nome, setor, preco in acoes:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.ACAO,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Setor: {setor}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:35} - R$ {preco}")
        
        # Criar FIIs
        print("\nüè¢ Criando FIIs...")
        for ticker, nome, segmento, preco in fiis:
            ativo = Ativo(
                ticker=ticker,
                nome=nome,
                tipo=TipoAtivo.FII,
                classe=ClasseAtivo.RENDA_VARIAVEL,
                mercado='BR',
                moeda='BRL',
                preco_atual=preco,
                observacoes=f'Segmento: {segmento}',
                ativo=True
            )
            db.session.add(ativo)
            created_ativos.append(ativo)
            print(f"  ‚úì {ticker:8} - {nome:40} - R$ {preco}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_ativos)} ativos criados com sucesso!")
            print(f"  - {len(acoes)} a√ß√µes")
            print(f"  - {len(fiis)} FIIs")
            print("=" * 50 + "\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar ativos: {e}")
            raise


if __name__ == '__main__':
    seed_ativos_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_feriados_b3.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Feriados B3
Popular tabela feriado_mercado com feriados da B3
"""

from app import create_app
from app.database import db
from app.models import FeriadoMercado, TipoFeriado
from datetime import date


def seed_feriados_b3():
    """Cria feriados da B3 para 2025 e 2026"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Feriados B3 (2025-2026)")
        print("=" * 50)
        
        # Verificar se j√° existem feriados B3
        count = FeriadoMercado.query.filter_by(pais='BR', mercado='B3').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} feriados B3 cadastrados.")
            resposta = input("Deseja recriar os feriados? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar feriados B3 existentes
            FeriadoMercado.query.filter_by(pais='BR', mercado='B3').delete()
            db.session.commit()
            print("‚úì Feriados B3 anteriores removidos.")
        
        # Feriados B3 2025
        feriados_2025 = [
            (date(2025, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2025, 3, 3), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2025, 3, 4), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2025, 4, 18), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2025, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2025, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2025, 6, 19), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2025, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2025, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2025, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2025, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2025, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        # Feriados B3 2026
        feriados_2026 = [
            (date(2026, 1, 1), 'Confraterniza√ß√£o Universal', TipoFeriado.NACIONAL, True),
            (date(2026, 2, 16), 'Carnaval', TipoFeriado.NACIONAL, False),
            (date(2026, 2, 17), 'Carnaval (Quarta de Cinzas - meio per√≠odo)', TipoFeriado.NACIONAL, False),
            (date(2026, 4, 3), 'Sexta-feira Santa', TipoFeriado.NACIONAL, True),
            (date(2026, 4, 21), 'Tiradentes', TipoFeriado.NACIONAL, True),
            (date(2026, 5, 1), 'Dia do Trabalho', TipoFeriado.NACIONAL, True),
            (date(2026, 6, 4), 'Corpus Christi', TipoFeriado.NACIONAL, False),
            (date(2026, 9, 7), 'Independ√™ncia do Brasil', TipoFeriado.NACIONAL, True),
            (date(2026, 10, 12), 'Nossa Senhora Aparecida', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 2), 'Finados', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 15), 'Proclama√ß√£o da Rep√∫blica', TipoFeriado.NACIONAL, True),
            (date(2026, 11, 20), 'Dia da Consci√™ncia Negra', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 24), 'V√©spera de Natal (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
            (date(2026, 12, 25), 'Natal', TipoFeriado.NACIONAL, True),
            (date(2026, 12, 31), 'V√©spera de Ano Novo (meio per√≠odo)', TipoFeriado.FECHAMENTO_ANTECIPADO, False),
        ]
        
        todos_feriados = feriados_2025 + feriados_2026
        created_feriados = []
        
        print("\nüìÖ Criando Feriados 2025...")
        for data_feriado, nome, tipo, recorrente in feriados_2025:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        print("\nüìÖ Criando Feriados 2026...")
        for data_feriado, nome, tipo, recorrente in feriados_2026:
            feriado = FeriadoMercado(
                pais='BR',
                mercado='B3',
                data_feriado=data_feriado,
                tipo_feriado=tipo,
                nome=nome,
                recorrente=recorrente
            )
            db.session.add(feriado)
            created_feriados.append(feriado)
            tipo_icon = "üö´" if tipo == TipoFeriado.NACIONAL else "‚è∞"
            print(f"  {tipo_icon} {data_feriado.strftime('%d/%m/%Y')} - {nome}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_feriados)} feriados criados!")
            print(f"  - 2025: {len(feriados_2025)} feriados")
            print(f"  - 2026: {len(feriados_2026)} feriados")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  üö´ = Fechamento total (sem preg√£o)")
            print("  ‚è∞ = Fechamento antecipado (meio per√≠odo)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar feriados: {e}")
            raise


if __name__ == '__main__':
    seed_feriados_b3()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_fontes_dados.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Fontes de Dados
Popular tabela fonte_dados com APIs de cota√ß√µes
"""

from app import create_app
from app.database import db
from app.models import FonteDados, TipoFonteDados


def seed_fontes_dados():
    """Cria fontes de dados (APIs)"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Fontes de Dados (APIs)")
        print("=" * 50)
        
        # Verificar se j√° existem fontes
        count = FonteDados.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} fontes de dados cadastradas.")
            resposta = input("Deseja recriar as fontes? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar fontes existentes
            FonteDados.query.delete()
            db.session.commit()
            print("‚úì Fontes de dados anteriores removidas.")
        
        # Fontes de dados
        fontes = [
            {
                'nome': 'yfinance',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://query1.finance.yahoo.com',
                'requer_autenticacao': False,
                'rate_limit': '2000/hour',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'Biblioteca Python gratuita para Yahoo Finance. Boa cobertura global, incluindo B3.'
            },
            {
                'nome': 'brapi.dev',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://brapi.dev/api',
                'requer_autenticacao': False,
                'rate_limit': '100/minute',
                'ativa': True,
                'prioridade': 1,
                'observacoes': 'API brasileira gratuita especializada em ativos da B3. Dados em tempo real.'
            },
            {
                'nome': 'Alpha Vantage',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://www.alphavantage.co/query',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API gratuita com chave. Limite de 5 requisi√ß√µes por minuto (plano free).'
            },
            {
                'nome': 'Finnhub',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://finnhub.io/api/v1',
                'requer_autenticacao': True,
                'rate_limit': '60/minute',
                'ativa': True,
                'prioridade': 2,
                'observacoes': 'API com plano gratuito. Boa cobertura de mercados globais e not√≠cias.'
            },
            {
                'nome': 'IEX Cloud',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://cloud.iexapis.com/stable',
                'requer_autenticacao': True,
                'rate_limit': '50000/month',
                'ativa': True,
                'prioridade': 3,
                'observacoes': 'API focada em mercado americano. Plano gratuito com limite mensal.'
            },
            {
                'nome': 'Polygon.io',
                'tipo_fonte': TipoFonteDados.API,
                'url_base': 'https://api.polygon.io',
                'requer_autenticacao': True,
                'rate_limit': '5/minute',
                'ativa': False,
                'prioridade': 4,
                'observacoes': 'API premium com dados hist√≥ricos detalhados. Desativada por padr√£o.'
            },
            {
                'nome': 'Manual',
                'tipo_fonte': TipoFonteDados.MANUAL,
                'url_base': None,
                'requer_autenticacao': False,
                'rate_limit': None,
                'ativa': True,
                'prioridade': 99,
                'observacoes': 'Entrada manual de dados pelo usu√°rio.'
            },
        ]
        
        created_fontes = []
        
        print("\nüîå Criando Fontes de Dados...")
        for fonte_data in fontes:
            fonte = FonteDados(
                nome=fonte_data['nome'],
                tipo_fonte=fonte_data['tipo_fonte'],
                url_base=fonte_data['url_base'],
                requer_autenticacao=fonte_data['requer_autenticacao'],
                rate_limit=fonte_data['rate_limit'],
                ativa=fonte_data['ativa'],
                prioridade=fonte_data['prioridade'],
                observacoes=fonte_data['observacoes']
            )
            db.session.add(fonte)
            created_fontes.append(fonte)
            
            status_icon = "‚úì" if fonte.ativa else "‚úó"
            auth_icon = "üîê" if fonte.requer_autenticacao else "üîì"
            
            print(f"  {status_icon} {auth_icon} {fonte.nome:20} | Prioridade: {fonte.prioridade} | Limite: {fonte.rate_limit or 'N/A'}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_fontes)} fontes de dados criadas!")
            print("=" * 50)
            print("\nüìå LEGENDA:")
            print("  ‚úì = Ativa    | ‚úó = Inativa")
            print("  üîì = Sem auth | üîê = Requer chave API")
            print("\nüí° PRIORIDADE:")
            print("  1 = Alta (usar primeiro)")
            print("  2-3 = M√©dia (fallback)")
            print("  99 = Baixa (manual)\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar fontes: {e}")
            raise


if __name__ == '__main__':
    seed_fontes_dados()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_regras_fiscais_br.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Regras Fiscais Brasileiras
Popular tabela regra_fiscal com regras de IR do Brasil
"""

from app import create_app
from app.database import db
from app.models import RegraFiscal, IncidenciaImposto
from decimal import Decimal
from datetime import date


def seed_regras_fiscais_br():
    """Cria regras fiscais brasileiras"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Regras Fiscais Brasileiras")
        print("=" * 50)
        
        # Verificar se j√° existem regras BR
        count = RegraFiscal.query.filter_by(pais='BR').count()
        if count > 0:
            print(f"‚ö† J√° existem {count} regras fiscais brasileiras.")
            resposta = input("Deseja recriar as regras BR? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar regras BR existentes
            RegraFiscal.query.filter_by(pais='BR').delete()
            db.session.commit()
            print("‚úì Regras fiscais brasileiras anteriores removidas.")
        
        # Regras fiscais brasileiras
        regras = [
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': Decimal('20000.00'),
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em a√ß√µes - Swing Trade. Isen√ß√£o para vendas at√© R$ 20.000,00 por m√™s.'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': 'DAY_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em Day Trade. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': 'SWING_TRADE',
                'aliquota_ir': Decimal('20.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.LUCRO,
                'descricao': 'IR sobre ganho de capital em FIIs. SEM isen√ß√£o, al√≠quota de 20%.'
            },
            {
                'tipo_ativo': None,  # Aplica a todos
                'tipo_operacao': None,
                'aliquota_ir': Decimal('15.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'IR sobre JCP (Juros sobre Capital Pr√≥prio). Retido na fonte, al√≠quota de 15%.'
            },
            {
                'tipo_ativo': 'FII',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Rendimentos de FII s√£o ISENTOS de IR para pessoa f√≠sica (requisitos: FII com +50 cotistas, cotas negociadas em bolsa, investidor com <10% das cotas).'
            },
            {
                'tipo_ativo': 'ACAO',
                'tipo_operacao': None,
                'aliquota_ir': Decimal('0.0000'),
                'valor_isencao': None,
                'incide_sobre': IncidenciaImposto.PROVENTO,
                'descricao': 'Dividendos de a√ß√µes s√£o ISENTOS de IR para pessoa f√≠sica no Brasil.'
            },
        ]
        
        created_regras = []
        
        print("\nüìã Criando Regras...")
        for regra_data in regras:
            regra = RegraFiscal(
                pais='BR',
                tipo_ativo=regra_data['tipo_ativo'],
                tipo_operacao=regra_data['tipo_operacao'],
                aliquota_ir=regra_data['aliquota_ir'],
                valor_isencao=regra_data['valor_isencao'],
                incide_sobre=regra_data['incide_sobre'],
                descricao=regra_data['descricao'],
                vigencia_inicio=date(2024, 1, 1),
                ativa=True
            )
            db.session.add(regra)
            created_regras.append(regra)
            
            tipo_str = regra_data['tipo_ativo'] or 'TODOS'
            op_str = regra_data['tipo_operacao'] or 'TODAS'
            isencao_str = f"R$ {regra_data['valor_isencao']}" if regra_data['valor_isencao'] else "SEM"
            
            print(f"  ‚úì {tipo_str:10} | {op_str:12} | IR: {regra_data['aliquota_ir']:6}% | Isen√ß√£o: {isencao_str}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_regras)} regras fiscais criadas!")
            print("=" * 50)
            print("\nüìå RESUMO DAS REGRAS:")
            print("-" * 50)
            print("‚Ä¢ A√ß√µes Swing Trade: 15% IR (isen√ß√£o at√© R$ 20k/m√™s)")
            print("‚Ä¢ A√ß√µes Day Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ FII Swing Trade: 20% IR (sem isen√ß√£o)")
            print("‚Ä¢ Dividendos de A√ß√µes: ISENTO")
            print("‚Ä¢ Rendimentos de FII: ISENTO*")
            print("‚Ä¢ JCP: 15% IR retido na fonte")
            print("-" * 50)
            print("* Requisitos para isen√ß√£o de FII aplicam-se\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar regras fiscais: {e}")
            raise


if __name__ == '__main__':
    seed_regras_fiscais_br()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/app/seeds/seed_usuarios.py ---
# -*- coding: utf-8 -*-
"""
Exitus - Seed de Usu√°rios
Popular tabela usuario com dados iniciais
"""
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))


from app import create_app
from app.database import db
from app.models import Usuario, UserRole
from datetime import datetime


def seed_usuarios():
    """Cria usu√°rios iniciais do sistema"""
    
    app = create_app()
    
    with app.app_context():
        print("=" * 50)
        print("SEED: Criando Usu√°rios Iniciais")
        print("=" * 50)
        
        # Verificar se j√° existem usu√°rios
        count = Usuario.query.count()
        if count > 0:
            print(f"‚ö† J√° existem {count} usu√°rios cadastrados.")
            resposta = input("Deseja recriar os usu√°rios? (s/N): ").lower()
            if resposta != 's':
                print("‚úó Seed cancelado pelo usu√°rio.")
                return
            
            # Limpar usu√°rios existentes
            Usuario.query.delete()
            db.session.commit()
            print("‚úì Usu√°rios anteriores removidos.")
        
        # Lista de usu√°rios a criar
        usuarios = [
            {
                'username': 'admin',
                'email': 'admin@exitus.com',
                'password': 'admin123',  # Senha padr√£o para desenvolvimento
                'nome_completo': 'Administrador do Sistema',
                'role': UserRole.ADMIN,
                'ativo': True
            },
            {
                'username': 'joao.silva',
                'email': 'joao.silva@example.com',
                'password': 'user123',
                'nome_completo': 'Jo√£o Silva',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'maria.santos',
                'email': 'maria.santos@example.com',
                'password': 'user123',
                'nome_completo': 'Maria Santos',
                'role': UserRole.USER,
                'ativo': True
            },
            {
                'username': 'viewer',
                'email': 'viewer@exitus.com',
                'password': 'viewer123',
                'nome_completo': 'Usu√°rio Visualizador',
                'role': UserRole.READONLY,
                'ativo': True
            }
        ]
        
        # Criar usu√°rios
        created_users = []
        for user_data in usuarios:
            user = Usuario(
                username=user_data['username'],
                email=user_data['email'],
                nome_completo=user_data.get('nome_completo'),
                role=user_data['role'],
                ativo=user_data['ativo']
            )
            user.set_password(user_data['password'])
            
            db.session.add(user)
            created_users.append(user)
            
            print(f"‚úì Usu√°rio criado: {user.username} ({user.role.value}) - {user.email}")
        
        # Commit no banco
        try:
            db.session.commit()
            print("\n" + "=" * 50)
            print(f"‚úì {len(created_users)} usu√°rios criados com sucesso!")
            print("=" * 50)
            
            # Exibir credenciais
            print("\nüìã CREDENCIAIS DE ACESSO:")
            print("-" * 50)
            for user_data in usuarios:
                print(f"Username: {user_data['username']:<15} | Senha: {user_data['password']}")
            print("-" * 50)
            print("‚ö† ATEN√á√ÉO: Altere as senhas em produ√ß√£o!\n")
            
        except Exception as e:
            db.session.rollback()
            print(f"\n‚úó Erro ao criar usu√°rios: {e}")
            raise


if __name__ == '__main__':
    seed_usuarios()

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/requirements.txt ---
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
alembic==1.13.1
Flask-Migrate==4.0.5

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/backup_fase4_20251126.sql ---
--
-- PostgreSQL database dump
--

\restrict GKPkJ0HUazHhGWoZucB0W175i385M8gluav75q4QDk791AqK2yfWUeOUdV3G2s9

-- Dumped from database version 15.15 (Debian 15.15-1.pgdg13+1)
-- Dumped by pg_dump version 15.15 (Debian 15.15-1.pgdg13+1)

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: classeativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.classeativo AS ENUM (
    'RENDA_VARIAVEL',
    'RENDA_FIXA',
    'CRIPTO',
    'HIBRIDO'
);


ALTER TYPE public.classeativo OWNER TO exitus;

--
-- Name: incidenciaimposto; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.incidenciaimposto AS ENUM (
    'LUCRO',
    'RECEITA',
    'PROVENTO',
    'OPERACAO'
);


ALTER TYPE public.incidenciaimposto OWNER TO exitus;

--
-- Name: tipoativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoativo AS ENUM (
    'ACAO',
    'FII',
    'REIT',
    'BOND',
    'ETF',
    'CRIPTO',
    'OUTRO'
);


ALTER TYPE public.tipoativo OWNER TO exitus;

--
-- Name: tipocorretora; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipocorretora AS ENUM (
    'CORRETORA',
    'EXCHANGE'
);


ALTER TYPE public.tipocorretora OWNER TO exitus;

--
-- Name: tipoeventocorporativo; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoeventocorporativo AS ENUM (
    'SPLIT',
    'GRUPAMENTO',
    'BONIFICACAO',
    'DIREITO_SUBSCRICAO',
    'FUSAO',
    'CISAO',
    'INCORPORACAO',
    'MUDANCA_TICKER',
    'DESLISTAGEM',
    'RELISTING',
    'CANCELAMENTO',
    'OUTRO'
);


ALTER TYPE public.tipoeventocorporativo OWNER TO exitus;

--
-- Name: tipoferiado; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoferiado AS ENUM (
    'NACIONAL',
    'BOLSA',
    'PONTE',
    'FECHAMENTO_ANTECIPADO',
    'MANUTENCAO',
    'OUTRO'
);


ALTER TYPE public.tipoferiado OWNER TO exitus;

--
-- Name: tipofontedados; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipofontedados AS ENUM (
    'API',
    'SCRAPER',
    'MANUAL',
    'ARQUIVO',
    'OUTRO'
);


ALTER TYPE public.tipofontedados OWNER TO exitus;

--
-- Name: tipomovimentacao; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipomovimentacao AS ENUM (
    'DEPOSITO',
    'SAQUE',
    'TRANSFERENCIA_ENVIADA',
    'TRANSFERENCIA_RECEBIDA',
    'CREDITO_PROVENTO',
    'PAGAMENTO_TAXA',
    'PAGAMENTO_IMPOSTO',
    'AJUSTE',
    'OUTRO'
);


ALTER TYPE public.tipomovimentacao OWNER TO exitus;

--
-- Name: tipooperacao; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipooperacao AS ENUM (
    'COMPRA',
    'VENDA'
);


ALTER TYPE public.tipooperacao OWNER TO exitus;

--
-- Name: tipoprovento; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.tipoprovento AS ENUM (
    'DIVIDENDO',
    'JCP',
    'RENDIMENTO',
    'CUPOM',
    'BONIFICACAO',
    'DIREITO_SUBSCRICAO',
    'OUTRO'
);


ALTER TYPE public.tipoprovento OWNER TO exitus;

--
-- Name: userrole; Type: TYPE; Schema: public; Owner: exitus
--

CREATE TYPE public.userrole AS ENUM (
    'ADMIN',
    'USER',
    'READONLY'
);


ALTER TYPE public.userrole OWNER TO exitus;

SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: alembic_version; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.alembic_version (
    version_num character varying(32) NOT NULL
);


ALTER TABLE public.alembic_version OWNER TO exitus;

--
-- Name: ativo; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.ativo (
    id uuid NOT NULL,
    ticker character varying(20) NOT NULL,
    nome character varying(200) NOT NULL,
    tipo public.tipoativo NOT NULL,
    classe public.classeativo NOT NULL,
    mercado character varying(10) NOT NULL,
    moeda character varying(3) NOT NULL,
    preco_atual numeric(18,6),
    data_ultima_cotacao timestamp with time zone,
    dividend_yield numeric(8,4),
    p_l numeric(10,2),
    p_vp numeric(10,2),
    roe numeric(8,4),
    ativo boolean NOT NULL,
    deslistado boolean NOT NULL,
    data_deslistagem date,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT ativo_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT ativo_preco_positivo CHECK (((preco_atual IS NULL) OR (preco_atual >= (0)::numeric))),
    CONSTRAINT ativo_ticker_min_length CHECK ((length((ticker)::text) >= 1))
);


ALTER TABLE public.ativo OWNER TO exitus;

--
-- Name: TABLE ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.ativo IS 'Tabela de ativos financeiros (a√ß√µes, FIIs, REITs, bonds, criptomoedas)';


--
-- Name: COLUMN ativo.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.id IS 'Identificador √∫nico do ativo';


--
-- Name: COLUMN ativo.ticker; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.ticker IS 'C√≥digo/s√≠mbolo do ativo (ex: PETR4, AAPL, BTC)';


--
-- Name: COLUMN ativo.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.nome IS 'Nome completo do ativo';


--
-- Name: COLUMN ativo.tipo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.tipo IS 'Tipo do ativo (a√ß√£o, FII, REIT, bond, cripto)';


--
-- Name: COLUMN ativo.classe; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.classe IS 'Classe do ativo (renda vari√°vel, fixa, cripto)';


--
-- Name: COLUMN ativo.mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.mercado IS 'Mercado/pa√≠s de negocia√ß√£o (BR, US, EUR)';


--
-- Name: COLUMN ativo.moeda; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.moeda IS 'Moeda de negocia√ß√£o (BRL, USD, EUR)';


--
-- Name: COLUMN ativo.preco_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.preco_atual IS 'Pre√ßo/cota√ß√£o atual do ativo';


--
-- Name: COLUMN ativo.data_ultima_cotacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.data_ultima_cotacao IS 'Data e hora da √∫ltima cota√ß√£o';


--
-- Name: COLUMN ativo.dividend_yield; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.dividend_yield IS 'Dividend Yield em % (ex: 6.5000 = 6.5%)';


--
-- Name: COLUMN ativo.p_l; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.p_l IS '√çndice Pre√ßo/Lucro';


--
-- Name: COLUMN ativo.p_vp; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.p_vp IS '√çndice Pre√ßo/Valor Patrimonial';


--
-- Name: COLUMN ativo.roe; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.roe IS 'Return on Equity em %';


--
-- Name: COLUMN ativo.ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.ativo IS 'Indica se ativo est√° dispon√≠vel para negocia√ß√£o';


--
-- Name: COLUMN ativo.deslistado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.deslistado IS 'Indica se ativo foi deslistado da bolsa';


--
-- Name: COLUMN ativo.data_deslistagem; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.data_deslistagem IS 'Data de deslistagem (se aplic√°vel)';


--
-- Name: COLUMN ativo.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.observacoes IS 'Observa√ß√µes e notas sobre o ativo';


--
-- Name: COLUMN ativo.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN ativo.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.ativo.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: corretora; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.corretora (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    nome character varying(100) NOT NULL,
    tipo public.tipocorretora NOT NULL,
    pais character varying(2) NOT NULL,
    moeda_padrao character varying(3) NOT NULL,
    saldo_atual numeric(18,2) NOT NULL,
    ativa boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT corretora_moeda_iso_format CHECK (((moeda_padrao)::text ~* '^[A-Z]{3}$'::text)),
    CONSTRAINT corretora_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT corretora_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text)),
    CONSTRAINT corretora_saldo_positivo CHECK ((saldo_atual >= (0)::numeric))
);


ALTER TABLE public.corretora OWNER TO exitus;

--
-- Name: TABLE corretora; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.corretora IS 'Tabela de corretoras e contas de investimento';


--
-- Name: COLUMN corretora.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.id IS 'Identificador √∫nico da corretora';


--
-- Name: COLUMN corretora.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.usuario_id IS 'ID do usu√°rio propriet√°rio';


--
-- Name: COLUMN corretora.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.nome IS 'Nome da corretora/exchange (ex: XP, Clear, Binance)';


--
-- Name: COLUMN corretora.tipo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.tipo IS 'Tipo: corretora tradicional ou exchange cripto';


--
-- Name: COLUMN corretora.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.pais IS 'C√≥digo ISO 3166-1 alpha-2 do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN corretora.moeda_padrao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.moeda_padrao IS 'C√≥digo ISO 4217 da moeda (BRL, USD, EUR)';


--
-- Name: COLUMN corretora.saldo_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.saldo_atual IS 'Saldo dispon√≠vel em caixa (na moeda padr√£o)';


--
-- Name: COLUMN corretora.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.ativa IS 'Indica se conta est√° ativa';


--
-- Name: COLUMN corretora.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.observacoes IS 'Observa√ß√µes e notas do usu√°rio sobre a conta';


--
-- Name: COLUMN corretora.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN corretora.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.corretora.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: evento_corporativo; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.evento_corporativo (
    id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    ativo_novo_id uuid,
    tipo_evento public.tipoeventocorporativo NOT NULL,
    data_evento date NOT NULL,
    data_com date,
    proporcao character varying(20),
    descricao text NOT NULL,
    impacto_posicoes boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT evento_data_com_valida CHECK (((data_com IS NULL) OR (data_com <= data_evento)))
);


ALTER TABLE public.evento_corporativo OWNER TO exitus;

--
-- Name: TABLE evento_corporativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.evento_corporativo IS 'Tabela de eventos corporativos que afetam ativos';


--
-- Name: COLUMN evento_corporativo.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.id IS 'Identificador √∫nico do evento';


--
-- Name: COLUMN evento_corporativo.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.ativo_id IS 'ID do ativo afetado pelo evento';


--
-- Name: COLUMN evento_corporativo.ativo_novo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.ativo_novo_id IS 'ID do novo ativo (fus√µes, mudan√ßas de ticker)';


--
-- Name: COLUMN evento_corporativo.tipo_evento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.tipo_evento IS 'Tipo do evento corporativo';


--
-- Name: COLUMN evento_corporativo.data_evento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.data_evento IS 'Data do evento';


--
-- Name: COLUMN evento_corporativo.data_com; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.data_com IS 'Data COM (√∫ltimo dia para ter direito ao evento)';


--
-- Name: COLUMN evento_corporativo.proporcao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.proporcao IS 'Propor√ß√£o do evento (ex: ''2:1'', ''1:10'', ''1:1.5'')';


--
-- Name: COLUMN evento_corporativo.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.descricao IS 'Descri√ß√£o detalhada do evento';


--
-- Name: COLUMN evento_corporativo.impacto_posicoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.impacto_posicoes IS 'Indica se as posi√ß√µes j√° foram ajustadas';


--
-- Name: COLUMN evento_corporativo.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.observacoes IS 'Observa√ß√µes adicionais sobre o evento';


--
-- Name: COLUMN evento_corporativo.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN evento_corporativo.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.evento_corporativo.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: feriado_mercado; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.feriado_mercado (
    id uuid NOT NULL,
    pais character varying(2) NOT NULL,
    mercado character varying(20),
    data_feriado date NOT NULL,
    tipo_feriado public.tipoferiado NOT NULL,
    nome character varying(200) NOT NULL,
    horario_fechamento time without time zone,
    recorrente boolean NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT feriado_nome_min_length CHECK ((length((nome)::text) >= 3)),
    CONSTRAINT feriado_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text))
);


ALTER TABLE public.feriado_mercado OWNER TO exitus;

--
-- Name: TABLE feriado_mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.feriado_mercado IS 'Tabela de feriados e dias sem preg√£o nos mercados';


--
-- Name: COLUMN feriado_mercado.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.id IS 'Identificador √∫nico do feriado';


--
-- Name: COLUMN feriado_mercado.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.pais IS 'C√≥digo ISO do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN feriado_mercado.mercado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.mercado IS 'Mercado/bolsa espec√≠fica (B3, NYSE, NASDAQ, etc.) - NULL = todos';


--
-- Name: COLUMN feriado_mercado.data_feriado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.data_feriado IS 'Data do feriado';


--
-- Name: COLUMN feriado_mercado.tipo_feriado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.tipo_feriado IS 'Tipo do feriado';


--
-- Name: COLUMN feriado_mercado.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.nome IS 'Nome do feriado';


--
-- Name: COLUMN feriado_mercado.horario_fechamento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.horario_fechamento IS 'Hor√°rio de fechamento antecipado (se aplic√°vel)';


--
-- Name: COLUMN feriado_mercado.recorrente; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.recorrente IS 'Indica se √© feriado anual fixo (sempre no mesmo dia/m√™s)';


--
-- Name: COLUMN feriado_mercado.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.observacoes IS 'Observa√ß√µes sobre o feriado';


--
-- Name: COLUMN feriado_mercado.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN feriado_mercado.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.feriado_mercado.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: fonte_dados; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.fonte_dados (
    id uuid NOT NULL,
    nome character varying(100) NOT NULL,
    tipo_fonte public.tipofontedados NOT NULL,
    url_base character varying(500),
    requer_autenticacao boolean NOT NULL,
    rate_limit character varying(50),
    ativa boolean NOT NULL,
    prioridade integer NOT NULL,
    ultima_consulta timestamp with time zone,
    total_consultas integer NOT NULL,
    total_erros integer NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT fonte_consultas_positivas CHECK ((total_consultas >= 0)),
    CONSTRAINT fonte_erros_positivos CHECK ((total_erros >= 0)),
    CONSTRAINT fonte_nome_min_length CHECK ((length((nome)::text) >= 2)),
    CONSTRAINT fonte_prioridade_positiva CHECK ((prioridade > 0))
);


ALTER TABLE public.fonte_dados OWNER TO exitus;

--
-- Name: TABLE fonte_dados; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.fonte_dados IS 'Tabela de fontes de dados externas (APIs, scrapers)';


--
-- Name: COLUMN fonte_dados.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.id IS 'Identificador √∫nico da fonte';


--
-- Name: COLUMN fonte_dados.nome; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.nome IS 'Nome da fonte de dados (ex: yfinance, Alpha Vantage)';


--
-- Name: COLUMN fonte_dados.tipo_fonte; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.tipo_fonte IS 'Tipo da fonte de dados';


--
-- Name: COLUMN fonte_dados.url_base; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.url_base IS 'URL base da API ou site';


--
-- Name: COLUMN fonte_dados.requer_autenticacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.requer_autenticacao IS 'Indica se requer chave API ou autentica√ß√£o';


--
-- Name: COLUMN fonte_dados.rate_limit; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.rate_limit IS 'Limite de requisi√ß√µes (ex: ''5/minute'', ''500/day'')';


--
-- Name: COLUMN fonte_dados.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.ativa IS 'Indica se fonte est√° ativa';


--
-- Name: COLUMN fonte_dados.prioridade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.prioridade IS 'Ordem de prioridade (1 = maior prioridade)';


--
-- Name: COLUMN fonte_dados.ultima_consulta; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.ultima_consulta IS 'Timestamp da √∫ltima consulta bem-sucedida';


--
-- Name: COLUMN fonte_dados.total_consultas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.total_consultas IS 'Total de consultas realizadas';


--
-- Name: COLUMN fonte_dados.total_erros; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.total_erros IS 'Total de erros encontrados';


--
-- Name: COLUMN fonte_dados.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.observacoes IS 'Observa√ß√µes sobre a fonte de dados';


--
-- Name: COLUMN fonte_dados.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN fonte_dados.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.fonte_dados.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: log_auditoria; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.log_auditoria (
    id uuid NOT NULL,
    usuario_id uuid,
    acao character varying(50) NOT NULL,
    entidade character varying(100),
    entidade_id uuid,
    dados_antes json,
    dados_depois json,
    ip_address character varying(45),
    user_agent character varying(500),
    "timestamp" timestamp with time zone NOT NULL,
    sucesso boolean NOT NULL,
    mensagem text,
    CONSTRAINT log_acao_min_length CHECK ((length((acao)::text) >= 3))
);


ALTER TABLE public.log_auditoria OWNER TO exitus;

--
-- Name: TABLE log_auditoria; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.log_auditoria IS 'Tabela de logs de auditoria para compliance';


--
-- Name: COLUMN log_auditoria.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.id IS 'Identificador √∫nico do log';


--
-- Name: COLUMN log_auditoria.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.usuario_id IS 'ID do usu√°rio (NULL para a√ß√µes an√¥nimas)';


--
-- Name: COLUMN log_auditoria.acao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.acao IS 'Tipo de a√ß√£o (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.)';


--
-- Name: COLUMN log_auditoria.entidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.entidade IS 'Nome da entidade afetada (Usuario, Transacao, Posicao, etc.)';


--
-- Name: COLUMN log_auditoria.entidade_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.entidade_id IS 'ID do registro afetado';


--
-- Name: COLUMN log_auditoria.dados_antes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.dados_antes IS 'Estado anterior do registro (JSON)';


--
-- Name: COLUMN log_auditoria.dados_depois; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.dados_depois IS 'Estado posterior do registro (JSON)';


--
-- Name: COLUMN log_auditoria.ip_address; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.ip_address IS 'Endere√ßo IP de origem';


--
-- Name: COLUMN log_auditoria.user_agent; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.user_agent IS 'User-Agent (navegador/cliente)';


--
-- Name: COLUMN log_auditoria."timestamp"; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria."timestamp" IS 'Data/hora da a√ß√£o';


--
-- Name: COLUMN log_auditoria.sucesso; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.sucesso IS 'Indica se a√ß√£o foi bem-sucedida';


--
-- Name: COLUMN log_auditoria.mensagem; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.log_auditoria.mensagem IS 'Mensagem de erro ou detalhes adicionais';


--
-- Name: movimentacao_caixa; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.movimentacao_caixa (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    corretora_destino_id uuid,
    provento_id uuid,
    tipo_movimentacao public.tipomovimentacao NOT NULL,
    valor numeric(18,2) NOT NULL,
    moeda character varying(3) NOT NULL,
    data_movimentacao date NOT NULL,
    descricao text,
    comprovante character varying(200),
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT movimentacao_moeda_iso_format CHECK (((moeda)::text ~* '^[A-Z]{3}$'::text)),
    CONSTRAINT movimentacao_valor_positivo CHECK ((valor > (0)::numeric))
);


ALTER TABLE public.movimentacao_caixa OWNER TO exitus;

--
-- Name: TABLE movimentacao_caixa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.movimentacao_caixa IS 'Tabela de movimenta√ß√µes de caixa em corretoras';


--
-- Name: COLUMN movimentacao_caixa.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.id IS 'Identificador √∫nico da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.usuario_id IS 'ID do usu√°rio';


--
-- Name: COLUMN movimentacao_caixa.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.corretora_id IS 'ID da corretora (origem)';


--
-- Name: COLUMN movimentacao_caixa.corretora_destino_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.corretora_destino_id IS 'ID da corretora destino (apenas para transfer√™ncias)';


--
-- Name: COLUMN movimentacao_caixa.provento_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.provento_id IS 'ID do provento (apenas para cr√©dito de provento)';


--
-- Name: COLUMN movimentacao_caixa.tipo_movimentacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.tipo_movimentacao IS 'Tipo da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.valor; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.valor IS 'Valor da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.moeda; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.moeda IS 'C√≥digo ISO 4217 da moeda (BRL, USD, EUR)';


--
-- Name: COLUMN movimentacao_caixa.data_movimentacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.data_movimentacao IS 'Data da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.descricao IS 'Descri√ß√£o da movimenta√ß√£o';


--
-- Name: COLUMN movimentacao_caixa.comprovante; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.comprovante IS 'Refer√™ncia ao comprovante (n√∫mero, hash, arquivo)';


--
-- Name: COLUMN movimentacao_caixa.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN movimentacao_caixa.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.movimentacao_caixa.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: posicao; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.posicao (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    quantidade numeric(18,8) NOT NULL,
    preco_medio numeric(18,6) NOT NULL,
    custo_total numeric(18,2) NOT NULL,
    taxas_acumuladas numeric(18,2) NOT NULL,
    impostos_acumulados numeric(18,2) NOT NULL,
    valor_atual numeric(18,2),
    lucro_prejuizo_realizado numeric(18,2) NOT NULL,
    lucro_prejuizo_nao_realizado numeric(18,2),
    data_primeira_compra date,
    data_ultima_atualizacao timestamp with time zone,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT posicao_custo_total_positivo CHECK ((custo_total >= (0)::numeric)),
    CONSTRAINT posicao_impostos_positivos CHECK ((impostos_acumulados >= (0)::numeric)),
    CONSTRAINT posicao_preco_medio_positivo CHECK ((preco_medio >= (0)::numeric)),
    CONSTRAINT posicao_quantidade_positiva CHECK ((quantidade >= (0)::numeric)),
    CONSTRAINT posicao_taxas_positivas CHECK ((taxas_acumuladas >= (0)::numeric))
);


ALTER TABLE public.posicao OWNER TO exitus;

--
-- Name: TABLE posicao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.posicao IS 'Tabela de posi√ß√µes em carteira (holdings)';


--
-- Name: COLUMN posicao.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.id IS 'Identificador √∫nico da posi√ß√£o';


--
-- Name: COLUMN posicao.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.usuario_id IS 'ID do usu√°rio propriet√°rio';


--
-- Name: COLUMN posicao.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.corretora_id IS 'ID da corretora onde est√° a posi√ß√£o';


--
-- Name: COLUMN posicao.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.ativo_id IS 'ID do ativo';


--
-- Name: COLUMN posicao.quantidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.quantidade IS 'Quantidade de ativos (suporta fracion√°rios)';


--
-- Name: COLUMN posicao.preco_medio; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.preco_medio IS 'Pre√ßo m√©dio de aquisi√ß√£o';


--
-- Name: COLUMN posicao.custo_total; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.custo_total IS 'Custo total investido (quantidade * pre√ßo m√©dio)';


--
-- Name: COLUMN posicao.taxas_acumuladas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.taxas_acumuladas IS 'Taxas de corretagem e cust√≥dia acumuladas';


--
-- Name: COLUMN posicao.impostos_acumulados; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.impostos_acumulados IS 'Impostos pagos acumulados (IR, IOF, etc.)';


--
-- Name: COLUMN posicao.valor_atual; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.valor_atual IS 'Valor de mercado atual da posi√ß√£o';


--
-- Name: COLUMN posicao.lucro_prejuizo_realizado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.lucro_prejuizo_realizado IS 'Lucro/preju√≠zo realizado em vendas';


--
-- Name: COLUMN posicao.lucro_prejuizo_nao_realizado; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.lucro_prejuizo_nao_realizado IS 'Lucro/preju√≠zo n√£o realizado (marca√ß√£o a mercado)';


--
-- Name: COLUMN posicao.data_primeira_compra; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.data_primeira_compra IS 'Data da primeira aquisi√ß√£o deste ativo';


--
-- Name: COLUMN posicao.data_ultima_atualizacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.data_ultima_atualizacao IS 'Data da √∫ltima atualiza√ß√£o de valores';


--
-- Name: COLUMN posicao.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN posicao.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.posicao.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: provento; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.provento (
    id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    tipo_provento public.tipoprovento NOT NULL,
    valor_por_acao numeric(18,6) NOT NULL,
    quantidade_ativos numeric(18,8) NOT NULL,
    valor_bruto numeric(18,2) NOT NULL,
    imposto_retido numeric(18,2) NOT NULL,
    valor_liquido numeric(18,2) NOT NULL,
    data_com date NOT NULL,
    data_pagamento date NOT NULL,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT provento_data_pagamento_valida CHECK ((data_pagamento >= data_com)),
    CONSTRAINT provento_imposto_positivo CHECK ((imposto_retido >= (0)::numeric)),
    CONSTRAINT provento_liquido_menor_bruto CHECK ((valor_liquido <= valor_bruto)),
    CONSTRAINT provento_quantidade_positiva CHECK ((quantidade_ativos > (0)::numeric)),
    CONSTRAINT provento_valor_bruto_positivo CHECK ((valor_bruto > (0)::numeric)),
    CONSTRAINT provento_valor_liquido_positivo CHECK ((valor_liquido > (0)::numeric)),
    CONSTRAINT provento_valor_por_acao_positivo CHECK ((valor_por_acao > (0)::numeric))
);


ALTER TABLE public.provento OWNER TO exitus;

--
-- Name: TABLE provento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.provento IS 'Tabela de proventos recebidos (dividendos, JCP, rendimentos)';


--
-- Name: COLUMN provento.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.id IS 'Identificador √∫nico do provento';


--
-- Name: COLUMN provento.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.ativo_id IS 'ID do ativo que pagou o provento';


--
-- Name: COLUMN provento.tipo_provento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.tipo_provento IS 'Tipo do provento (dividendo, JCP, rendimento, etc.)';


--
-- Name: COLUMN provento.valor_por_acao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_por_acao IS 'Valor unit√°rio por ativo';


--
-- Name: COLUMN provento.quantidade_ativos; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.quantidade_ativos IS 'Quantidade de ativos que geraram o provento';


--
-- Name: COLUMN provento.valor_bruto; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_bruto IS 'Valor bruto recebido';


--
-- Name: COLUMN provento.imposto_retido; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.imposto_retido IS 'IR retido na fonte';


--
-- Name: COLUMN provento.valor_liquido; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.valor_liquido IS 'Valor l√≠quido creditado';


--
-- Name: COLUMN provento.data_com; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.data_com IS 'Data COM (√∫ltimo dia para ter direito ao provento)';


--
-- Name: COLUMN provento.data_pagamento; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.data_pagamento IS 'Data efetiva do pagamento';


--
-- Name: COLUMN provento.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.observacoes IS 'Observa√ß√µes sobre o provento';


--
-- Name: COLUMN provento.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN provento.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.provento.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: regra_fiscal; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.regra_fiscal (
    id uuid NOT NULL,
    pais character varying(2) NOT NULL,
    tipo_ativo character varying(20),
    tipo_operacao character varying(20),
    aliquota_ir numeric(6,4) NOT NULL,
    valor_isencao numeric(18,2),
    incide_sobre public.incidenciaimposto NOT NULL,
    descricao text NOT NULL,
    vigencia_inicio date NOT NULL,
    vigencia_fim date,
    ativa boolean NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT regra_aliquota_valida CHECK (((aliquota_ir >= (0)::numeric) AND (aliquota_ir <= (100)::numeric))),
    CONSTRAINT regra_isencao_positiva CHECK (((valor_isencao IS NULL) OR (valor_isencao >= (0)::numeric))),
    CONSTRAINT regra_pais_iso_format CHECK (((pais)::text ~* '^[A-Z]{2}$'::text)),
    CONSTRAINT regra_vigencia_valida CHECK (((vigencia_fim IS NULL) OR (vigencia_fim >= vigencia_inicio)))
);


ALTER TABLE public.regra_fiscal OWNER TO exitus;

--
-- Name: TABLE regra_fiscal; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.regra_fiscal IS 'Tabela de regras tribut√°rias por pa√≠s e tipo de ativo';


--
-- Name: COLUMN regra_fiscal.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.id IS 'Identificador √∫nico da regra';


--
-- Name: COLUMN regra_fiscal.pais; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.pais IS 'C√≥digo ISO do pa√≠s (BR, US, etc.)';


--
-- Name: COLUMN regra_fiscal.tipo_ativo; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.tipo_ativo IS 'Tipo de ativo (ACAO, FII, REIT, BOND, etc.) - NULL = todos';


--
-- Name: COLUMN regra_fiscal.tipo_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.tipo_operacao IS 'Tipo de opera√ß√£o (COMPRA, VENDA, DAY_TRADE, SWING_TRADE) - NULL = todas';


--
-- Name: COLUMN regra_fiscal.aliquota_ir; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.aliquota_ir IS 'Al√≠quota de IR em % (ex: 15.0000 = 15%)';


--
-- Name: COLUMN regra_fiscal.valor_isencao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.valor_isencao IS 'Valor de isen√ß√£o mensal (ex: R$ 20.000,00 no Brasil)';


--
-- Name: COLUMN regra_fiscal.incide_sobre; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.incide_sobre IS 'Sobre o que incide o imposto';


--
-- Name: COLUMN regra_fiscal.descricao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.descricao IS 'Descri√ß√£o detalhada da regra fiscal';


--
-- Name: COLUMN regra_fiscal.vigencia_inicio; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.vigencia_inicio IS 'Data de in√≠cio da vig√™ncia da regra';


--
-- Name: COLUMN regra_fiscal.vigencia_fim; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.vigencia_fim IS 'Data de fim da vig√™ncia (NULL = vigente indefinidamente)';


--
-- Name: COLUMN regra_fiscal.ativa; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.ativa IS 'Indica se regra est√° ativa';


--
-- Name: COLUMN regra_fiscal.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN regra_fiscal.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.regra_fiscal.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: transacao; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.transacao (
    id uuid NOT NULL,
    usuario_id uuid NOT NULL,
    corretora_id uuid NOT NULL,
    ativo_id uuid NOT NULL,
    tipo_operacao public.tipooperacao NOT NULL,
    quantidade numeric(18,8) NOT NULL,
    preco_unitario numeric(18,6) NOT NULL,
    valor_total numeric(18,2) NOT NULL,
    taxas numeric(18,2) NOT NULL,
    impostos numeric(18,2) NOT NULL,
    data_operacao date NOT NULL,
    data_liquidacao date,
    observacoes text,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    CONSTRAINT transacao_data_liquidacao_valida CHECK (((data_liquidacao IS NULL) OR (data_liquidacao >= data_operacao))),
    CONSTRAINT transacao_impostos_positivos CHECK ((impostos >= (0)::numeric)),
    CONSTRAINT transacao_preco_positivo CHECK ((preco_unitario > (0)::numeric)),
    CONSTRAINT transacao_quantidade_positiva CHECK ((quantidade > (0)::numeric)),
    CONSTRAINT transacao_taxas_positivas CHECK ((taxas >= (0)::numeric)),
    CONSTRAINT transacao_valor_total_positivo CHECK ((valor_total > (0)::numeric))
);


ALTER TABLE public.transacao OWNER TO exitus;

--
-- Name: TABLE transacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON TABLE public.transacao IS 'Tabela de transa√ß√µes de compra e venda de ativos';


--
-- Name: COLUMN transacao.id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.id IS 'Identificador √∫nico da transa√ß√£o';


--
-- Name: COLUMN transacao.usuario_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.usuario_id IS 'ID do usu√°rio';


--
-- Name: COLUMN transacao.corretora_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.corretora_id IS 'ID da corretora';


--
-- Name: COLUMN transacao.ativo_id; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.ativo_id IS 'ID do ativo transacionado';


--
-- Name: COLUMN transacao.tipo_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.tipo_operacao IS 'Tipo de opera√ß√£o: COMPRA ou VENDA';


--
-- Name: COLUMN transacao.quantidade; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.quantidade IS 'Quantidade transacionada (suporta fracion√°rios)';


--
-- Name: COLUMN transacao.preco_unitario; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.preco_unitario IS 'Pre√ßo por unidade';


--
-- Name: COLUMN transacao.valor_total; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.valor_total IS 'Valor total da opera√ß√£o (quantidade * pre√ßo)';


--
-- Name: COLUMN transacao.taxas; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.taxas IS 'Taxas de corretagem, cust√≥dia, emolumentos';


--
-- Name: COLUMN transacao.impostos; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.impostos IS 'IR retido na fonte, IOF, etc.';


--
-- Name: COLUMN transacao.data_operacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.data_operacao IS 'Data da opera√ß√£o';


--
-- Name: COLUMN transacao.data_liquidacao; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.data_liquidacao IS 'Data de liquida√ß√£o (D+2, D+3, etc.)';


--
-- Name: COLUMN transacao.observacoes; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.observacoes IS 'Observa√ß√µes sobre a transa√ß√£o';


--
-- Name: COLUMN transacao.created_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.created_at IS 'Data de cria√ß√£o do registro';


--
-- Name: COLUMN transacao.updated_at; Type: COMMENT; Schema: public; Owner: exitus
--

COMMENT ON COLUMN public.transacao.updated_at IS 'Data da √∫ltima atualiza√ß√£o';


--
-- Name: usuario; Type: TABLE; Schema: public; Owner: exitus
--

CREATE TABLE public.usuario (
    id uuid NOT NULL,
    username character varying(50) NOT NULL,
    email character varying(120) NOT NULL,
    password_hash character varying(255) NOT NULL,
    nome_completo character varying(200),
    ativo boolean NOT NULL,
    role public.userrole NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL
);


ALTER TABLE public.usuario OWNER TO exitus;

--
-- Data for Name: alembic_version; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.alembic_version (version_num) FROM stdin;
b2542b2f7857
\.


--
-- Data for Name: ativo; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.ativo (id, ticker, nome, tipo, classe, mercado, moeda, preco_atual, data_ultima_cotacao, dividend_yield, p_l, p_vp, roe, ativo, deslistado, data_deslistagem, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: corretora; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.corretora (id, usuario_id, nome, tipo, pais, moeda_padrao, saldo_atual, ativa, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: evento_corporativo; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.evento_corporativo (id, ativo_id, ativo_novo_id, tipo_evento, data_evento, data_com, proporcao, descricao, impacto_posicoes, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: feriado_mercado; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.feriado_mercado (id, pais, mercado, data_feriado, tipo_feriado, nome, horario_fechamento, recorrente, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: fonte_dados; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.fonte_dados (id, nome, tipo_fonte, url_base, requer_autenticacao, rate_limit, ativa, prioridade, ultima_consulta, total_consultas, total_erros, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: log_auditoria; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.log_auditoria (id, usuario_id, acao, entidade, entidade_id, dados_antes, dados_depois, ip_address, user_agent, "timestamp", sucesso, mensagem) FROM stdin;
\.


--
-- Data for Name: movimentacao_caixa; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.movimentacao_caixa (id, usuario_id, corretora_id, corretora_destino_id, provento_id, tipo_movimentacao, valor, moeda, data_movimentacao, descricao, comprovante, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: posicao; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.posicao (id, usuario_id, corretora_id, ativo_id, quantidade, preco_medio, custo_total, taxas_acumuladas, impostos_acumulados, valor_atual, lucro_prejuizo_realizado, lucro_prejuizo_nao_realizado, data_primeira_compra, data_ultima_atualizacao, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: provento; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.provento (id, ativo_id, tipo_provento, valor_por_acao, quantidade_ativos, valor_bruto, imposto_retido, valor_liquido, data_com, data_pagamento, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: regra_fiscal; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.regra_fiscal (id, pais, tipo_ativo, tipo_operacao, aliquota_ir, valor_isencao, incide_sobre, descricao, vigencia_inicio, vigencia_fim, ativa, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: transacao; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.transacao (id, usuario_id, corretora_id, ativo_id, tipo_operacao, quantidade, preco_unitario, valor_total, taxas, impostos, data_operacao, data_liquidacao, observacoes, created_at, updated_at) FROM stdin;
\.


--
-- Data for Name: usuario; Type: TABLE DATA; Schema: public; Owner: exitus
--

COPY public.usuario (id, username, email, password_hash, nome_completo, ativo, role, created_at, updated_at) FROM stdin;
\.


--
-- Name: alembic_version alembic_version_pkc; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.alembic_version
    ADD CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num);


--
-- Name: ativo ativo_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.ativo
    ADD CONSTRAINT ativo_pkey PRIMARY KEY (id);


--
-- Name: corretora corretora_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT corretora_pkey PRIMARY KEY (id);


--
-- Name: evento_corporativo evento_corporativo_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_pkey PRIMARY KEY (id);


--
-- Name: feriado_mercado feriado_mercado_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.feriado_mercado
    ADD CONSTRAINT feriado_mercado_pkey PRIMARY KEY (id);


--
-- Name: fonte_dados fonte_dados_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.fonte_dados
    ADD CONSTRAINT fonte_dados_pkey PRIMARY KEY (id);


--
-- Name: log_auditoria log_auditoria_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.log_auditoria
    ADD CONSTRAINT log_auditoria_pkey PRIMARY KEY (id);


--
-- Name: movimentacao_caixa movimentacao_caixa_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_pkey PRIMARY KEY (id);


--
-- Name: posicao posicao_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_pkey PRIMARY KEY (id);


--
-- Name: provento provento_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.provento
    ADD CONSTRAINT provento_pkey PRIMARY KEY (id);


--
-- Name: regra_fiscal regra_fiscal_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.regra_fiscal
    ADD CONSTRAINT regra_fiscal_pkey PRIMARY KEY (id);


--
-- Name: transacao transacao_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_pkey PRIMARY KEY (id);


--
-- Name: ativo unique_ativo_ticker_mercado; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.ativo
    ADD CONSTRAINT unique_ativo_ticker_mercado UNIQUE (ticker, mercado);


--
-- Name: corretora unique_corretora_usuario_nome_pais; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT unique_corretora_usuario_nome_pais UNIQUE (usuario_id, nome, pais);


--
-- Name: feriado_mercado unique_feriado_pais_mercado_data; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.feriado_mercado
    ADD CONSTRAINT unique_feriado_pais_mercado_data UNIQUE (pais, mercado, data_feriado);


--
-- Name: posicao unique_posicao_usuario_corretora_ativo; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT unique_posicao_usuario_corretora_ativo UNIQUE (usuario_id, corretora_id, ativo_id);


--
-- Name: usuario usuario_pkey; Type: CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.usuario
    ADD CONSTRAINT usuario_pkey PRIMARY KEY (id);


--
-- Name: ix_ativo_ativo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_ativo ON public.ativo USING btree (ativo);


--
-- Name: ix_ativo_classe; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_classe ON public.ativo USING btree (classe);


--
-- Name: ix_ativo_data_ultima_cotacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_data_ultima_cotacao ON public.ativo USING btree (data_ultima_cotacao);


--
-- Name: ix_ativo_deslistado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_deslistado ON public.ativo USING btree (deslistado);


--
-- Name: ix_ativo_mercado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_mercado ON public.ativo USING btree (mercado);


--
-- Name: ix_ativo_moeda; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_moeda ON public.ativo USING btree (moeda);


--
-- Name: ix_ativo_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_nome ON public.ativo USING btree (nome);


--
-- Name: ix_ativo_ticker; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_ticker ON public.ativo USING btree (ticker);


--
-- Name: ix_ativo_tipo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_ativo_tipo ON public.ativo USING btree (tipo);


--
-- Name: ix_corretora_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_ativa ON public.corretora USING btree (ativa);


--
-- Name: ix_corretora_moeda_padrao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_moeda_padrao ON public.corretora USING btree (moeda_padrao);


--
-- Name: ix_corretora_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_nome ON public.corretora USING btree (nome);


--
-- Name: ix_corretora_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_pais ON public.corretora USING btree (pais);


--
-- Name: ix_corretora_tipo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_tipo ON public.corretora USING btree (tipo);


--
-- Name: ix_corretora_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_corretora_usuario_id ON public.corretora USING btree (usuario_id);


--
-- Name: ix_evento_corporativo_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_ativo_id ON public.evento_corporativo USING btree (ativo_id);


--
-- Name: ix_evento_corporativo_ativo_novo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_ativo_novo_id ON public.evento_corporativo USING btree (ativo_novo_id);


--
-- Name: ix_evento_corporativo_data_com; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_data_com ON public.evento_corporativo USING btree (data_com);


--
-- Name: ix_evento_corporativo_data_evento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_data_evento ON public.evento_corporativo USING btree (data_evento);


--
-- Name: ix_evento_corporativo_impacto_posicoes; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_impacto_posicoes ON public.evento_corporativo USING btree (impacto_posicoes);


--
-- Name: ix_evento_corporativo_tipo_evento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_evento_corporativo_tipo_evento ON public.evento_corporativo USING btree (tipo_evento);


--
-- Name: ix_feriado_mercado_data_feriado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_data_feriado ON public.feriado_mercado USING btree (data_feriado);


--
-- Name: ix_feriado_mercado_mercado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_mercado ON public.feriado_mercado USING btree (mercado);


--
-- Name: ix_feriado_mercado_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_pais ON public.feriado_mercado USING btree (pais);


--
-- Name: ix_feriado_mercado_recorrente; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_recorrente ON public.feriado_mercado USING btree (recorrente);


--
-- Name: ix_feriado_mercado_tipo_feriado; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_feriado_mercado_tipo_feriado ON public.feriado_mercado USING btree (tipo_feriado);


--
-- Name: ix_fonte_dados_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_ativa ON public.fonte_dados USING btree (ativa);


--
-- Name: ix_fonte_dados_nome; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_fonte_dados_nome ON public.fonte_dados USING btree (nome);


--
-- Name: ix_fonte_dados_prioridade; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_prioridade ON public.fonte_dados USING btree (prioridade);


--
-- Name: ix_fonte_dados_tipo_fonte; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_tipo_fonte ON public.fonte_dados USING btree (tipo_fonte);


--
-- Name: ix_fonte_dados_ultima_consulta; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_fonte_dados_ultima_consulta ON public.fonte_dados USING btree (ultima_consulta);


--
-- Name: ix_log_auditoria_acao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_acao ON public.log_auditoria USING btree (acao);


--
-- Name: ix_log_auditoria_entidade; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_entidade ON public.log_auditoria USING btree (entidade);


--
-- Name: ix_log_auditoria_entidade_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_entidade_id ON public.log_auditoria USING btree (entidade_id);


--
-- Name: ix_log_auditoria_ip_address; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_ip_address ON public.log_auditoria USING btree (ip_address);


--
-- Name: ix_log_auditoria_sucesso; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_sucesso ON public.log_auditoria USING btree (sucesso);


--
-- Name: ix_log_auditoria_timestamp; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_timestamp ON public.log_auditoria USING btree ("timestamp");


--
-- Name: ix_log_auditoria_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_log_auditoria_usuario_id ON public.log_auditoria USING btree (usuario_id);


--
-- Name: ix_movimentacao_caixa_corretora_destino_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_corretora_destino_id ON public.movimentacao_caixa USING btree (corretora_destino_id);


--
-- Name: ix_movimentacao_caixa_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_corretora_id ON public.movimentacao_caixa USING btree (corretora_id);


--
-- Name: ix_movimentacao_caixa_data_movimentacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_data_movimentacao ON public.movimentacao_caixa USING btree (data_movimentacao);


--
-- Name: ix_movimentacao_caixa_moeda; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_moeda ON public.movimentacao_caixa USING btree (moeda);


--
-- Name: ix_movimentacao_caixa_provento_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_provento_id ON public.movimentacao_caixa USING btree (provento_id);


--
-- Name: ix_movimentacao_caixa_tipo_movimentacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_tipo_movimentacao ON public.movimentacao_caixa USING btree (tipo_movimentacao);


--
-- Name: ix_movimentacao_caixa_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_movimentacao_caixa_usuario_id ON public.movimentacao_caixa USING btree (usuario_id);


--
-- Name: ix_posicao_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_ativo_id ON public.posicao USING btree (ativo_id);


--
-- Name: ix_posicao_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_corretora_id ON public.posicao USING btree (corretora_id);


--
-- Name: ix_posicao_data_primeira_compra; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_data_primeira_compra ON public.posicao USING btree (data_primeira_compra);


--
-- Name: ix_posicao_data_ultima_atualizacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_data_ultima_atualizacao ON public.posicao USING btree (data_ultima_atualizacao);


--
-- Name: ix_posicao_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_posicao_usuario_id ON public.posicao USING btree (usuario_id);


--
-- Name: ix_provento_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_ativo_id ON public.provento USING btree (ativo_id);


--
-- Name: ix_provento_data_com; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_data_com ON public.provento USING btree (data_com);


--
-- Name: ix_provento_data_pagamento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_data_pagamento ON public.provento USING btree (data_pagamento);


--
-- Name: ix_provento_tipo_provento; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_provento_tipo_provento ON public.provento USING btree (tipo_provento);


--
-- Name: ix_regra_fiscal_ativa; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_ativa ON public.regra_fiscal USING btree (ativa);


--
-- Name: ix_regra_fiscal_incide_sobre; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_incide_sobre ON public.regra_fiscal USING btree (incide_sobre);


--
-- Name: ix_regra_fiscal_pais; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_pais ON public.regra_fiscal USING btree (pais);


--
-- Name: ix_regra_fiscal_tipo_ativo; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_tipo_ativo ON public.regra_fiscal USING btree (tipo_ativo);


--
-- Name: ix_regra_fiscal_tipo_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_tipo_operacao ON public.regra_fiscal USING btree (tipo_operacao);


--
-- Name: ix_regra_fiscal_vigencia_fim; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_vigencia_fim ON public.regra_fiscal USING btree (vigencia_fim);


--
-- Name: ix_regra_fiscal_vigencia_inicio; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_regra_fiscal_vigencia_inicio ON public.regra_fiscal USING btree (vigencia_inicio);


--
-- Name: ix_transacao_ativo_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_ativo_id ON public.transacao USING btree (ativo_id);


--
-- Name: ix_transacao_corretora_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_corretora_id ON public.transacao USING btree (corretora_id);


--
-- Name: ix_transacao_data_liquidacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_data_liquidacao ON public.transacao USING btree (data_liquidacao);


--
-- Name: ix_transacao_data_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_data_operacao ON public.transacao USING btree (data_operacao);


--
-- Name: ix_transacao_tipo_operacao; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_tipo_operacao ON public.transacao USING btree (tipo_operacao);


--
-- Name: ix_transacao_usuario_id; Type: INDEX; Schema: public; Owner: exitus
--

CREATE INDEX ix_transacao_usuario_id ON public.transacao USING btree (usuario_id);


--
-- Name: ix_usuario_email; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_usuario_email ON public.usuario USING btree (email);


--
-- Name: ix_usuario_username; Type: INDEX; Schema: public; Owner: exitus
--

CREATE UNIQUE INDEX ix_usuario_username ON public.usuario USING btree (username);


--
-- Name: corretora corretora_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.corretora
    ADD CONSTRAINT corretora_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: evento_corporativo evento_corporativo_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: evento_corporativo evento_corporativo_ativo_novo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.evento_corporativo
    ADD CONSTRAINT evento_corporativo_ativo_novo_id_fkey FOREIGN KEY (ativo_novo_id) REFERENCES public.ativo(id) ON DELETE SET NULL;


--
-- Name: log_auditoria log_auditoria_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.log_auditoria
    ADD CONSTRAINT log_auditoria_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_corretora_destino_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_corretora_destino_id_fkey FOREIGN KEY (corretora_destino_id) REFERENCES public.corretora(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: movimentacao_caixa movimentacao_caixa_provento_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_provento_id_fkey FOREIGN KEY (provento_id) REFERENCES public.provento(id) ON DELETE SET NULL;


--
-- Name: movimentacao_caixa movimentacao_caixa_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.movimentacao_caixa
    ADD CONSTRAINT movimentacao_caixa_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: posicao posicao_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: posicao posicao_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: posicao posicao_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.posicao
    ADD CONSTRAINT posicao_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- Name: provento provento_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.provento
    ADD CONSTRAINT provento_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: transacao transacao_ativo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_ativo_id_fkey FOREIGN KEY (ativo_id) REFERENCES public.ativo(id) ON DELETE RESTRICT;


--
-- Name: transacao transacao_corretora_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_corretora_id_fkey FOREIGN KEY (corretora_id) REFERENCES public.corretora(id) ON DELETE CASCADE;


--
-- Name: transacao transacao_usuario_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: exitus
--

ALTER TABLE ONLY public.transacao
    ADD CONSTRAINT transacao_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuario(id) ON DELETE CASCADE;


--
-- PostgreSQL database dump complete
--

\unrestrict GKPkJ0HUazHhGWoZucB0W175i385M8gluav75q4QDk791AqK2yfWUeOUdV3G2s9


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/concatenate_git_files.sh ---
#!/bin/bash

# Nome do arquivo de sa√≠da
OUTPUT_FILE="all_git_files_concatenated.txt"

# Separador visual entre os arquivos
SEPARATOR="===================================================="

# Verifica se estamos em um reposit√≥rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Erro: Este n√£o √© um diret√≥rio de trabalho Git."
    exit 1
fi

# Inicia o arquivo de sa√≠da (cria ou limpa)
> "$OUTPUT_FILE"

echo "Iniciando a concatena√ß√£o dos arquivos rastreados pelo Git em: $OUTPUT_FILE"
echo "$SEPARATOR" >> "$OUTPUT_FILE"

# Usa 'git ls-files' para obter a lista de arquivos rastreados
# O argumento -z (null-termination) e o 'xargs -0' s√£o usados para lidar corretamente
# com nomes de arquivos que contenham espa√ßos ou outros caracteres especiais.
git ls-files -z | while IFS= read -r -d $'\0' FILE_PATH; do
    # Verifica se o arquivo existe e √© regular (para evitar links simb√≥licos ou diret√≥rios, embora o git ls-files j√° ajude)
    if [ -f "$FILE_PATH" ]; then
        echo "Adicionando: $FILE_PATH"
        
        # Escreve o caminho completo do arquivo no arquivo de sa√≠da
        echo "--- ARQUIVO: $(pwd)/$FILE_PATH ---" >> "$OUTPUT_FILE"
        
        # Concatena o conte√∫do do arquivo
        cat "$FILE_PATH" >> "$OUTPUT_FILE"
        
        # Adiciona o separador
        echo -e "\n$SEPARATOR\n" >> "$OUTPUT_FILE"
    else
        echo "Aviso: Ignorando caminho n√£o-arquivo ou inexistente: $FILE_PATH"
    fi
done

echo "Conclu√≠do! Todos os arquivos rastreados foram concatenados em $OUTPUT_FILE."

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/docs/modulo0_ambiente.md ---

# Exitus - M√≥dulo 0: Prepara√ß√£o do Ambiente (Podman)

## Introdu√ß√£o

Este documento detalha o passo a passo para a prepara√ß√£o do ambiente computacional do Sistema Exitus, iniciando pela cria√ß√£o da estrutura de projeto, configura√ß√£o de vari√°veis de ambiente em estilo produ√ß√£o (.env), instala√ß√£o do Podman, configura√ß√£o de rede e volumes, build das imagens, cria√ß√£o dos containers e testes de comunica√ß√£o para a arquitetura proposta: PostgreSQL (DB), Flask Backend (API) e Flask Frontend (UI).

O pr√≥prio conte√∫do deste arquivo deve ser salvo em `exitus/docs/docs_modulo0.md` e servir√° como documenta√ß√£o oficial do M√≥dulo 0.

## 1. Estrutura do Projeto

Crie o diret√≥rio raiz e a estrutura base do projeto:

```bash
mkdir -p exitus/{docs,scripts,backend,frontend,tests,backups}
cd exitus
```

### Estrutura de Diret√≥rios

```text
exitus/
‚îú‚îÄ‚îÄ README.md                    # Introdu√ß√£o ao sistema e links para m√≥dulos
‚îú‚îÄ‚îÄ docs/                        # Documenta√ß√£o modular
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo0.md          # Este documento (M√≥dulo 0)
‚îÇ   ‚îú‚îÄ‚îÄ docs_modulo1.md          # Ser√° criado no M√≥dulo 1
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/                     # Scripts de gerenciamento e automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup_env.sh            # Sele√ß√£o de ambiente (dev/staging/prod)
‚îÇ   ‚îú‚îÄ‚îÄ setup_containers.sh     # Configura√ß√£o inicial dos containers
‚îÇ   ‚îú‚îÄ‚îÄ start_services.sh       # Iniciar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ stop_services.sh        # Parar todos os servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ backup_db.sh            # Backup do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_containers.sh   # Limpeza de containers e recursos
‚îú‚îÄ‚îÄ backend/                     # C√≥digo do Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo do Frontend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # (ser√° detalhado em m√≥dulos futuros)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.development.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.staging.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.production.example
‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_backend.py
‚îÇ   ‚îî‚îÄ‚îÄ test_frontend.py
‚îî‚îÄ‚îÄ backups/                     # Backups do banco de dados
```

### README.md Principal

Crie o arquivo `exitus/README.md` com vis√£o geral do sistema e links para os m√≥dulos:

```markdown
-----

## üèóÔ∏è Arquitetura T√©cnica

Para m√°xima portabilidade e desempenho, o **Exitus** adota uma arquitetura em cont√™ineres:

| Componente | Tecnologia Principal | Descri√ß√£o/Detalhes |
| :--- | :--- | :--- |
| **Banco de Dados** | **PostgreSQL 15** | Armazenamento robusto e transacional (em container Podman). |
| **Backend** | **Flask + SQLAlchemy** | APIs RESTful de alto desempenho para l√≥gica de neg√≥cios (em container Podman). |
| **Frontend** | **Flask + HTMX + Alpine.js** | Interface de usu√°rio moderna, leve e reativa (em container Podman). |
| **Infraestrutura** | **Ubuntu + Podman** | Sistema operacional base e runtime de cont√™ineres. |

-----

## üõ†Ô∏è Tecnologias Chave

  * üêç **Python 3.11+** (Linguagem de Backend)
  * üåê **Flask 3.x** (Framework Web)
  * üíæ **PostgreSQL 15** (Base de Dados)
  * ‚öôÔ∏è **SQLAlchemy 2.x** (ORM)
  * üê≥ **Podman** (Containeriza√ß√£o)
  * ‚ú® **HTMX, Alpine.js** (Interatividade de Frontend)

-----

## üìö Documenta√ß√£o Detalhada dos M√≥dulos

Nossa documenta√ß√£o est√° organizada para guiar voc√™ desde a configura√ß√£o inicial at√© o deploy:

## Documenta√ß√£o dos M√≥dulos

- [M√≥dulo 0: Prepara√ß√£o do Ambiente](docs/modulo0_ambiente.md)
- [M√≥dulo 1: Estrutura do Banco de Dados](docs/modulo1_database.md)
- [M√≥dulo 2: Backend - Autentica√ß√£o e Usu√°rios](docs/modulo2_backend_auth.md)
- [M√≥dulo 3: Backend - Gest√£o de Ativos](docs/modulo3_backend_financeiro.md)
- [M√≥dulo 4: Backend - Transa√ß√µes e Portf√≥lio](docs/modulo4_backend_integracoes.md)
- [M√≥dulo 5: Backend - APIs de Integra√ß√£o](docs/modulo5_frontend_base.md)
- [M√≥dulo 6: Frontend - Interface do Usu√°rio](docs/modulo6_frontend_dashboards.md)
- [M√≥dulo 7: Testes e Valida√ß√£o](docs/modulo7_relatorios.md)
- [M√≥dulo 8: Deploy e Monitoramento](docs/modulo8_deploy.md)

-----

## ‚ñ∂Ô∏è Guia de In√≠cio R√°pido (Quick Start)

1.  **Configura√ß√£o do Ambiente** (Veja o [M√≥dulo 0]((docs/modulo0_ambiente.md)):
    ```bash
    ./scripts/setup_containers.sh
    ```
2.  **Iniciar Servi√ßos:**
    ```bash
    ./scripts/start_services.sh
    ```
3.  **Acessar a Aplica√ß√£o:**
      * **Frontend (Interface Web):** `http://localhost:8080`
      * **Backend (API RESTful):** `http://localhost:5000`
```

## 2. Cria√ß√£o da Estrutura Backend

### 2.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p backend/app/routes
mkdir -p backend/logs
```

### 2.2 backend/requirements.txt

Crie o arquivo `backend/requirements.txt`:

```text
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
requests==2.31.0
pytest==7.4.3
gunicorn==21.2.0
```

### 2.3 backend/.env.example (template base)

Crie o arquivo `backend/.env.example`:

```bash
# Database Configuration
POSTGRES_HOST=exitus-db
POSTGRES_USER=exitus
POSTGRES_PASSWORD=exitus123
POSTGRES_DB=exitusdb
POSTGRES_PORT=5432

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes espec√≠ficas por ambiente apenas como exemplos (staging/production):

```bash
cp backend/.env.example backend/.env.development.example
cp backend/.env.example backend/.env.staging.example
cp backend/.env.example backend/.env.production.example
```

### 2.4 backend/run.py

Crie o arquivo `backend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Backend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 2.5 backend/app/config.py

Crie o arquivo `backend/app/config.py` para carregar vari√°veis de ambiente em estilo produ√ß√£o:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Configuration"""

import os
from dotenv import load_dotenv

# Carrega .env se existir
load_dotenv()

class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    # Database
    POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_USER = os.getenv('POSTGRES_USER', 'exitus')
    POSTGRES_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'exitus123')
    POSTGRES_DB = os.getenv('POSTGRES_DB', 'exitusdb')
    POSTGRES_PORT = os.getenv('POSTGRES_PORT', '5432')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

    # SQLAlchemy
    SQLALCHEMY_DATABASE_URI = (
        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@"
        f"{POSTGRES_HOST}:{POSTGRES_PORT}/{POSTGRES_DB}"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### 2.6 backend/app/\_\_init\_\_.py

Crie/atualize o arquivo `backend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Backend - Application Factory"""

from flask import Flask
from flask_cors import CORS
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Habilita CORS
    CORS(app)

    # Health check route
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-backend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 2.7 backend/Dockerfile

Atualize ou crie o arquivo `backend/Dockerfile` com boas pr√°ticas de produ√ß√£o (imagem slim, depend√™ncias m√≠nimas e ferramentas de diagn√≥stico):

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala depend√™ncias do sistema (incluindo ping e curl para diagn√≥stico)
RUN apt-get update && apt-get install -y     gcc     postgresql-client     iputils-ping     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 5000

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:5000", "run:app", "--reload"]
```

## 3. Cria√ß√£o da Estrutura Frontend

### 3.1 Criar Estrutura de Diret√≥rios

```bash
mkdir -p frontend/app/{routes,templates,static/{css,js}}
mkdir -p frontend/logs
```

### 3.2 frontend/requirements.txt

Crie o arquivo `frontend/requirements.txt`:

```text
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0
```

### 3.3 frontend/.env.example

Crie o arquivo `frontend/.env.example`:

```bash
# Backend API Configuration
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo
```

Opcionalmente, crie varia√ß√µes por ambiente (apenas templates):

```bash
cp frontend/.env.example frontend/.env.development.example
cp frontend/.env.example frontend/.env.staging.example
cp frontend/.env.example frontend/.env.production.example
```

### 3.4 frontend/run.py

Crie o arquivo `frontend/run.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))
```

### 3.5 frontend/app/config.py

Crie o arquivo `frontend/app/config.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')
```

### 3.6 frontend/app/\_\_init\_\_.py

Crie/atualize o arquivo `frontend/app/__init__.py`:

```python
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app
```

### 3.7 frontend/Dockerfile

Atualize ou crie o arquivo `frontend/Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]

```

## 4. Instala√ß√£o do Podman (Ubuntu)

No host Ubuntu, instale e prepare o Podman para uso rootless:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y podman

# Verificar instala√ß√£o
podman --version

# Configurar subuid/subgid para rootless (se ainda n√£o configurado)
echo "$USER:100000:65536" | sudo tee -a /etc/subuid
echo "$USER:100000:65536" | sudo tee -a /etc/subgid
```

## 5. Network e Volumes

Crie a rede dedicada e volumes persistentes (pode ser feito manualmente ou pelo script):

```bash
# Network
podman network create exitus-net

# Volumes
podman volume create exitus-pgdata
podman volume create exitus-backend-logs
podman volume create exitus-frontend-logs
```

## 6. Build das Imagens

Em ambiente de desenvolvimento, o build ser√° automatizado pelo script `scripts/setup_containers.sh`, mas os comandos manuais s√£o:

```bash
# Backend
cd backend
podman build -t exitus-backend:latest .
cd ..

# Frontend
cd frontend
podman build -t exitus-frontend:latest .
cd ..
```

## 7. Scripts de Ambiente e Containers

### 7.1 scripts/setup_env.sh

Crie o arquivo `scripts/setup_env.sh` para selecionar o ambiente (development/staging/production):

```bash
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"
```

Torne execut√°vel:

```bash
chmod +x scripts/setup_env.sh
```

### 7.2 scripts/setup_containers.sh

Atualize `scripts/setup_containers.sh` para operar de forma idempotente e usar `.env`:

```bash
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true
pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db   --network exitus-net   -v exitus-pgdata:/var/lib/postgresql/data   -e POSTGRES_USER=exitus   -e POSTGRES_PASSWORD=exitus123   -e POSTGRES_DB=exitusdb   -e TZ=America/Sao_Paulo   docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend   --network exitus-net   -p 5000:5000   -v ./backend:/app:Z   -v exitus-backend-logs:/app/logs:Z   --env-file ./backend/.env   exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend   --network exitus-net   -p 8080:8080   -v ./frontend:/app:Z   -v exitus-frontend-logs:/app/logs:Z   --env-file ./frontend/.env   exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.3 scripts/start_services.sh

```bash
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps
```

### 7.4 scripts/stop_services.sh

```bash
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="
```

### 7.5 scripts/cleanup_containers.sh

```bash
#!/bin/bash
# Remove todos os containers do Exitus

echo "=== Cleanup Exitus ==="

echo "Parando containers..."
podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "Containers removidos!"

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
```

### 7.6 scripts/backup_db.sh

```bash
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"
```

Torne todos os scripts execut√°veis:

```bash
chmod +x scripts/*.sh
```

## 8. Testes de Comunica√ß√£o e Sa√∫de

### 8.1 Testes a partir do host

```bash
# Backend health
curl http://localhost:5000/health

# Frontend health
curl http://localhost:8080/health
```

### 8.2 Testes dentro dos containers

```bash
# Frontend ‚Üí Backend (via curl)
podman exec exitus-frontend curl http://exitus-backend:5000/health

# Backend ‚Üí Database (TCP via Python)
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('Conexao OK com PostgreSQL')"

# Database respondendo
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT 'PostgreSQL OK' as status;"
```

### 8.3 Verifica√ß√£o de logs e status

```bash
# Status dos containers
podman ps

# Logs
podman logs exitus-db --tail 50
podman logs exitus-backend --tail 50
podman logs exitus-frontend --tail 50
```

## 9. Boas Pr√°ticas

### .gitignore

Crie o arquivo `exitus/.gitignore` para evitar versionar artefatos sens√≠veis ou gerados:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyd
*.env
.env
.env.*
!.env.example    # Permite apenas .env.example
instance/
db.sqlite3
# logs
logs/
*.log
# Docker
*.pid
*.db
backups/

# IDEs/editors
.vscode/
.idea/
*.swp

# Test files
*.coverage
htmlcov/
.tox/
*.cache
pytest_cache/
.mypy_cache/
coverage.xml

# Container artifacts
exitus-backend/
exitus-frontend/
exitus-db/

# OS files
.DS_Store
Thumbs.db
```

### 9.2 Template dotenv.

Segue exemplo de uso dos dotenv para prepara√ß√£o do ambiente.

```bash
# Desenvolvimento (padr√£o)
./scripts/setup_env.sh development
./scripts/setup_containers.sh

# Staging
./scripts/setup_env.sh staging
./scripts/setup_containers.sh

# Produ√ß√£o
./scripts/setup_env.sh production
./scripts/setup_containers.sh
```

## 10. Documenta√ß√£o do M√≥dulo

Este documento deve ser salvo como `exitus/docs/docs_modulo0.md` e ter√° as seguintes finalidades:

- Refer√™ncia oficial para recria√ß√£o do ambiente de desenvolvimento e homologa√ß√£o.
- Base para onboarding de novos desenvolvedores no projeto Exitus.
- Guia de troubleshooting inicial envolvendo containers, rede, volumes e vari√°veis de ambiente.
- Ponto de partida para ajustes espec√≠ficos de ambientes (staging/production) em m√≥dulos posteriores.

Ap√≥s concluir todos os passos deste m√≥dulo e validar os testes de comunica√ß√£o, prossiga para o **M√≥dulo 1**, que tratar√° da modelagem e implementa√ß√£o da estrutura de banco de dados PostgreSQL do sistema Exitus.

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.development.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.production.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/.env.staging.example ---
# Backend API URL
BACKEND_API_URL=http://exitus-backend:5000

# Flask Configuration
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=change-me-in-env

# Timezone
TZ=America/Sao_Paulo

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/Dockerfile ---
FROM python:3.11-slim

WORKDIR /app

# Instala ferramentas √∫teis de diagn√≥stico
RUN apt-get update && apt-get install -y     curl     && rm -rf /var/lib/apt/lists/*

# Copia e instala depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia c√≥digo da aplica√ß√£o
COPY . .

# Se n√£o existir .env dentro da imagem, cria a partir do exemplo (√∫til para dev)
RUN if [ ! -f .env ]; then cp .env.example .env; fi

# Exp√µe porta
EXPOSE 8080

# Comando anterior
# CMD ["python", "run.py"]

# Novo comando
CMD ["gunicorn", "-b", "0.0.0.0:8080", "run:app", "--reload"]


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/__init__.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Application Factory"""

from flask import Flask, render_template_string
from .config import Config


def create_app():
    """Cria e configura a aplica√ß√£o Flask"""
    app = Flask(__name__)

    # Carrega configura√ß√µes
    app.config.from_object(Config)

    # Rota inicial simples (ser√° substitu√≠da em m√≥dulos futuros)
    @app.route('/')
    def index():
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Exitus - Sistema de Investimentos</title>
        </head>
        <body>
            <h1>Exitus - Sistema de Controle e An√°lise de Investimentos</h1>
            <p>Frontend funcionando corretamente!</p>
        </body>
        </html>
        """
        return render_template_string(html)

    # Health check
    @app.route('/health')
    def health():
        return {
            'status': 'ok',
            'service': 'exitus-frontend',
            'env': app.config.get('FLASK_ENV', 'unknown')
        }, 200

    return app

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/app/config.py ---
# -*- coding: utf-8 -*-
"""Exitus Frontend - Configuration"""

import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Configura√ß√µes da aplica√ß√£o"""

    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    FLASK_ENV = os.getenv('FLASK_ENV', 'development')

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/requirements.txt ---
Flask==3.0.0
requests==2.31.0
python-dotenv==1.0.0
pytest==7.4.3
gunicorn==21.2.0

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/frontend/run.py ---
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Exitus Frontend - Entry Point"""

from app import create_app
import os

app = create_app()

if __name__ == '__main__':
    port = int(os.getenv('FLASK_PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=(os.getenv('FLASK_ENV') == 'development'))

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase1.sh ---
# No HOST Ubuntu
echo "=== Valida√ß√£o Fase 1 ==="
echo "1. Containers:"
#podman ps --format "{{.Names}}" | grep exitus
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
echo "2. Estrutura:"
ls -la backend/app/models/ backend/app/seeds/ backend/alembic/
echo ""
echo "3. Conex√£o DB:"
podman exec exitus-backend python3 -c "from app import create_app; app=create_app(); print('‚úì App inicializada')"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase2.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 2 - Models Core

echo "======================================"
echo "  VALIDA√á√ÉO FASE 2 - MODELS CORE"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("usuario.py" "corretora.py" "ativo.py" "posicao.py" "transacao.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo, Posicao, Transacao, TipoOperacao
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal

errors = 0

# Testar Usuario
try:
    u = Usuario(username='test', email='test@test.com')
    u.set_password('123')
    print('‚úì Usuario OK')
except Exception as e:
    print(f'‚úó Usuario ERRO: {e}')
    errors += 1

# Testar Corretora
try:
    c = Corretora(usuario_id=u.id, nome='Test', pais='BR', moeda_padrao='BRL')
    print('‚úì Corretora OK')
except Exception as e:
    print(f'‚úó Corretora ERRO: {e}')
    errors += 1

# Testar Ativo
try:
    a = Ativo(ticker='TEST4', nome='Test SA', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    print('‚úì Ativo OK')
except Exception as e:
    print(f'‚úó Ativo ERRO: {e}')
    errors += 1

# Testar Posicao
try:
    p = Posicao(usuario_id=u.id, corretora_id=c.id, ativo_id=a.id)
    p.adicionar_compra(Decimal('10'), Decimal('50'))
    print('‚úì Posicao OK')
except Exception as e:
    print(f'‚úó Posicao ERRO: {e}')
    errors += 1

# Testar Transacao
try:
    from datetime import date
    t = Transacao(
        usuario_id=u.id,
        corretora_id=c.id,
        ativo_id=a.id,
        tipo_operacao=TipoOperacao.COMPRA,
        quantidade=Decimal('10'),
        preco_unitario=Decimal('50'),
        data_operacao=date.today()
    )
    print('‚úì Transacao OK')
except Exception as e:
    print(f'‚úó Transacao ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import UserRole, TipoCorretora, TipoAtivo, ClasseAtivo, TipoOperacao
print(f'‚úì UserRole: {[r.value for r in UserRole]}')
print(f'‚úì TipoCorretora: {[t.value for t in TipoCorretora]}')
print(f'‚úì TipoAtivo: {[t.value for t in TipoAtivo]}')
print(f'‚úì ClasseAtivo: {[c.value for c in ClasseAtivo]}')
print(f'‚úì TipoOperacao: {[t.value for t in TipoOperacao]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 2 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    exit 0
else
    echo -e "${RED}‚úó FASE 2 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase3.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 3 - Models Complementares

echo "======================================"
echo "  VALIDA√á√ÉO FASE 3 - MODELS COMPLEMENTARES"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("provento.py" "movimentacao_caixa.py" "evento_corporativo.py" "fonte_dados.py" "regra_fiscal.py" "feriado_mercado.py" "log_auditoria.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import (
    Provento, TipoProvento,
    MovimentacaoCaixa, TipoMovimentacao,
    EventoCorporativo, TipoEventoCorporativo,
    FonteDados, TipoFonteDados,
    RegraFiscal, IncidenciaImposto,
    FeriadoMercado, TipoFeriado,
    LogAuditoria
)
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date, time

errors = 0

# Testar Provento
try:
    ativo = Ativo(ticker='TEST4', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    p = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('1.50'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    print('‚úì Provento OK')
except Exception as e:
    print(f'‚úó Provento ERRO: {e}')
    errors += 1

# Testar MovimentacaoCaixa
try:
    user = Usuario(username='test', email='test@test.com')
    corr = Corretora(usuario_id=user.id, nome='Test', pais='BR', moeda_padrao='BRL')
    m = MovimentacaoCaixa(
        usuario_id=user.id,
        corretora_id=corr.id,
        tipo_movimentacao=TipoMovimentacao.DEPOSITO,
        valor=Decimal('1000'),
        moeda='BRL',
        data_movimentacao=date.today()
    )
    print('‚úì MovimentacaoCaixa OK')
except Exception as e:
    print(f'‚úó MovimentacaoCaixa ERRO: {e}')
    errors += 1

# Testar EventoCorporativo
try:
    e = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split 2 para 1'
    )
    print('‚úì EventoCorporativo OK')
except Exception as e:
    print(f'‚úó EventoCorporativo ERRO: {e}')
    errors += 1

# Testar FonteDados
try:
    f = FonteDados(
        nome='yfinance',
        tipo_fonte=TipoFonteDados.API,
        url_base='https://finance.yahoo.com',
        ativa=True,
        prioridade=1
    )
    print('‚úì FonteDados OK')
except Exception as e:
    print(f'‚úó FonteDados ERRO: {e}')
    errors += 1

# Testar RegraFiscal
try:
    r = RegraFiscal(
        pais='BR',
        tipo_ativo='ACAO',
        aliquota_ir=Decimal('15.0'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='IR sobre ganhos de capital',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    print('‚úì RegraFiscal OK')
except Exception as e:
    print(f'‚úó RegraFiscal ERRO: {e}')
    errors += 1

# Testar FeriadoMercado
try:
    fer = FeriadoMercado(
        pais='BR',
        mercado='B3',
        data_feriado=date(2025, 12, 25),
        tipo_feriado=TipoFeriado.NACIONAL,
        nome='Natal',
        recorrente=True
    )
    print('‚úì FeriadoMercado OK')
except Exception as e:
    print(f'‚úó FeriadoMercado ERRO: {e}')
    errors += 1

# Testar LogAuditoria
try:
    log = LogAuditoria(
        usuario_id=user.id,
        acao='LOGIN',
        ip_address='127.0.0.1',
        sucesso=True
    )
    print('‚úì LogAuditoria OK')
except Exception as e:
    print(f'‚úó LogAuditoria ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import (
    TipoProvento, TipoMovimentacao, TipoEventoCorporativo,
    TipoFonteDados, IncidenciaImposto, TipoFeriado
)
print(f'‚úì TipoProvento: {[t.value for t in TipoProvento]}')
print(f'‚úì TipoMovimentacao: {[t.value for t in TipoMovimentacao]}')
print(f'‚úì TipoEventoCorporativo: {[t.value for t in TipoEventoCorporativo]}')
print(f'‚úì TipoFonteDados: {[t.value for t in TipoFonteDados]}')
print(f'‚úì IncidenciaImposto: {[i.value for i in IncidenciaImposto]}')
print(f'‚úì TipoFeriado: {[t.value for t in TipoFeriado]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "5. Testando m√©todos espec√≠ficos..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date

errors = 0

# Testar c√°lculos de Provento
try:
    ativo = Ativo(ticker='TEST', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL', preco_atual=Decimal('40'))
    prov = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('2.00'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    dy = prov.dividend_yield_efetivo(ativo.preco_atual)
    assert dy == 5.0, f"DY deveria ser 5.0, foi {dy}"
    print('‚úì Provento.dividend_yield_efetivo() OK')
except Exception as e:
    print(f'‚úó Provento m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculos de EventoCorporativo
try:
    evento = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split'
    )
    fator = evento.calcular_fator_ajuste()
    assert fator == 2.0, f"Fator deveria ser 2.0, foi {fator}"
    print('‚úì EventoCorporativo.calcular_fator_ajuste() OK')
except Exception as e:
    print(f'‚úó EventoCorporativo m√©todos ERRO: {e}')
    errors += 1

# Testar estat√≠sticas de FonteDados
try:
    fonte = FonteDados(nome='test', tipo_fonte=TipoFonteDados.API, ativa=True, prioridade=1)
    fonte.registrar_consulta_sucesso()
    fonte.registrar_consulta_sucesso()
    fonte.registrar_erro()
    taxa = fonte.taxa_sucesso()
    assert 66.0 <= taxa <= 67.0, f"Taxa sucesso deveria ser ~66.67%, foi {taxa}"
    print('‚úì FonteDados.taxa_sucesso() OK')
except Exception as e:
    print(f'‚úó FonteDados m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculo de imposto RegraFiscal
try:
    regra = RegraFiscal(
        pais='BR',
        aliquota_ir=Decimal('15.0'),
        valor_isencao=Decimal('20000'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='Test',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    imposto = regra.calcular_imposto(Decimal('30000'))
    assert imposto == 1500, f"Imposto deveria ser 1500, foi {imposto}"
    print('‚úì RegraFiscal.calcular_imposto() OK')
except Exception as e:
    print(f'‚úó RegraFiscal m√©todos ERRO: {e}')
    errors += 1

# Testar altera√ß√µes LogAuditoria
try:
    log = LogAuditoria(
        acao='UPDATE',
        dados_antes={'nome': 'Jo√£o', 'idade': 30},
        dados_depois={'nome': 'Jo√£o Silva', 'idade': 30},
        sucesso=True
    )
    alteracoes = log.get_alteracoes()
    assert 'nome' in alteracoes, "Deveria detectar altera√ß√£o em 'nome'"
    assert 'idade' not in alteracoes, "N√£o deveria detectar altera√ß√£o em 'idade'"
    print('‚úì LogAuditoria.get_alteracoes() OK')
except Exception as e:
    print(f'‚úó LogAuditoria m√©todos ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os m√©todos espec√≠ficos funcionando"
else
    echo -e "${RED}‚úó${NC} Erros nos m√©todos espec√≠ficos"
    ((ERRORS++))
fi
echo ""

echo "6. Resumo de models criados..."
echo -e "${YELLOW}Fase 2 (Core):${NC}"
echo "  1. Usuario"
echo "  2. Corretora"
echo "  3. Ativo"
echo "  4. Posicao"
echo "  5. Transacao"
echo ""
echo -e "${YELLOW}Fase 3 (Complementares):${NC}"
echo "  6. Provento"
echo "  7. MovimentacaoCaixa"
echo "  8. EventoCorporativo"
echo "  9. FonteDados"
echo "  10. RegraFiscal"
echo "  11. FeriadoMercado"
echo "  12. LogAuditoria"
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 3 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Total: 12 models criados"
    echo "‚úÖ Pr√≥ximo: Fase 4 - Migrations e Schema"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 3 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase4.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 4 - Migrations e Schema

echo "======================================"
echo "  VALIDA√á√ÉO FASE 4 - MIGRATIONS E SCHEMA"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando migration gerada..."
MIGRATION_FILE=$(ls backend/alembic/versions/*_initial_schema_12_models.py 2>/dev/null | head -1)
if [ -f "$MIGRATION_FILE" ]; then
    LINES=$(wc -l < "$MIGRATION_FILE")
    if [ "$LINES" -gt 400 ]; then
        echo -e "${GREEN}‚úì${NC} Migration gerada: $MIGRATION_FILE ($LINES linhas)"
    else
        echo -e "${RED}‚úó${NC} Migration muito pequena: $LINES linhas"
        ((ERRORS++))
    fi
else
    echo -e "${RED}‚úó${NC} Migration n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando tabelas no PostgreSQL..."
TABLES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE';")
TABLES=$(echo $TABLES | xargs) # trim whitespace
if [ "$TABLES" -eq 13 ]; then
    echo -e "${GREEN}‚úì${NC} 13 tabelas criadas (12 models + alembic_version)"
else
    echo -e "${RED}‚úó${NC} Esperado 13 tabelas, encontrado: $TABLES"
    ((ERRORS++))
fi

# Listar tabelas
echo -e "${YELLOW}Tabelas encontradas:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE' ORDER BY table_name;" | sed 's/^/ - /'
echo ""

echo "3. Verificando enums no PostgreSQL..."
ENUMS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_type WHERE typtype='e';")
ENUMS=$(echo $ENUMS | xargs)
if [ "$ENUMS" -eq 11 ]; then
    echo -e "${GREEN}‚úì${NC} 11 enums criados"
else
    echo -e "${RED}‚úó${NC} Esperado 11 enums, encontrado: $ENUMS"
    ((ERRORS++))
fi

# Listar enums
echo -e "${YELLOW}Enums encontrados:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT typname FROM pg_type WHERE typtype='e' ORDER BY typname;" | sed 's/^/ - /'
echo ""

echo "4. Verificando foreign keys..."
FKS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.table_constraints WHERE constraint_type='FOREIGN KEY';")
FKS=$(echo $FKS | xargs)
if [ "$FKS" -ge 10 ]; then
    echo -e "${GREEN}‚úì${NC} $FKS foreign keys criadas"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $FKS foreign keys encontradas (esperado >=10)"
fi
echo ""

echo "5. Verificando √≠ndices..."
INDEXES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname='public';")
INDEXES=$(echo $INDEXES | xargs)
if [ "$INDEXES" -ge 50 ]; then
    echo -e "${GREEN}‚úì${NC} $INDEXES √≠ndices criados"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $INDEXES √≠ndices encontrados"
fi
echo ""

echo "6. Testando insert em tabela usuario..."
podman exec exitus-db psql -U exitus -d exitusdb -c "
INSERT INTO usuario (id, username, email, password_hash, ativo, role, created_at, updated_at)
VALUES (
    gen_random_uuid(),
    'test_validation',
    'test@validation.com',
    'hash123',
    true,
    'USER'::userrole,
    NOW(),
    NOW()
) ON CONFLICT DO NOTHING;
" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Insert de teste bem-sucedido"
    # Limpar
    podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario WHERE username='test_validation';" > /dev/null 2>&1
else
    echo -e "${RED}‚úó${NC} Erro no insert de teste"
    ((ERRORS++))
fi
echo ""

echo "7. Verificando vers√£o do Alembic..."
ALEMBIC_VERSION=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT version_num FROM alembic_version;")
ALEMBIC_VERSION=$(echo $ALEMBIC_VERSION | xargs)
if [ ! -z "$ALEMBIC_VERSION" ]; then
    echo -e "${GREEN}‚úì${NC} Alembic version: $ALEMBIC_VERSION"
else
    echo -e "${RED}‚úó${NC} Vers√£o do Alembic n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 4 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo:"
    echo "  - 13 tabelas criadas"
    echo "  - 11 enums criados"
    echo "  - $FKS foreign keys"
    echo "  - $INDEXES √≠ndices"
    echo ""
    echo "‚úÖ Pr√≥ximo: Fase 5 - Seeds de Dados"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 4 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase5.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 5 - Seeds de Dados

echo "======================================"
echo "  VALIDA√á√ÉO FASE 5 - SEEDS DE DADOS"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

echo "1. Verificando usu√°rios..."
USERS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM usuario;")
USERS=$(echo $USERS | xargs)
if [ "$USERS" -eq 4 ]; then
    echo -e "${GREEN}‚úì${NC} 4 usu√°rios cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 4 usu√°rios, encontrado: $USERS"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando ativos brasileiros..."
ATIVOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR';")
ATIVOS=$(echo $ATIVOS | xargs)
if [ "$ATIVOS" -eq 25 ]; then
    echo -e "${GREEN}‚úì${NC} 25 ativos brasileiros cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 25 ativos, encontrado: $ATIVOS"
    ((ERRORS++))
fi

#ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='acao';")
ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='ACAO';")
ACOES=$(echo $ACOES | xargs)
echo -e "  - A√ß√µes: $ACOES"

#FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='fii';")
FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='FII';")
FIIS=$(echo $FIIS | xargs)
echo -e "  - FIIs: $FIIS"
echo ""

echo "3. Verificando regras fiscais BR..."
REGRAS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM regra_fiscal WHERE pais='BR';")
REGRAS=$(echo $REGRAS | xargs)
if [ "$REGRAS" -eq 6 ]; then
    echo -e "${GREEN}‚úì${NC} 6 regras fiscais brasileiras cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 6 regras, encontrado: $REGRAS"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando feriados B3..."
FERIADOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM feriado_mercado WHERE pais='BR' AND mercado='B3';")
FERIADOS=$(echo $FERIADOS | xargs)
if [ "$FERIADOS" -eq 30 ]; then
    echo -e "${GREEN}‚úì${NC} 30 feriados B3 cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 30 feriados, encontrado: $FERIADOS"
    ((ERRORS++))
fi
echo ""

echo "5. Verificando fontes de dados..."
FONTES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM fonte_dados;")
FONTES=$(echo $FONTES | xargs)
if [ "$FONTES" -eq 7 ]; then
    echo -e "${GREEN}‚úì${NC} 7 fontes de dados cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 7 fontes, encontrado: $FONTES"
    ((ERRORS++))
fi
echo ""

echo "6. Verificando dados espec√≠ficos..."

# Verificar usu√°rio admin
ADMIN=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT username FROM usuario WHERE role='ADMIN' LIMIT 1;")
ADMIN=$(echo $ADMIN | xargs)
if [ "$ADMIN" = "admin" ]; then
    echo -e "${GREEN}‚úì${NC} Usu√°rio admin encontrado"
else
    echo -e "${RED}‚úó${NC} Usu√°rio admin n√£o encontrado"
    ((ERRORS++))
fi

# Verificar PETR4
PETR4=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT ticker FROM ativo WHERE ticker='PETR4';")
PETR4=$(echo $PETR4 | xargs)
if [ "$PETR4" = "PETR4" ]; then
    echo -e "${GREEN}‚úì${NC} Ativo PETR4 encontrado"
else
    echo -e "${RED}‚úó${NC} Ativo PETR4 n√£o encontrado"
    ((ERRORS++))
fi

# Verificar yfinance
YFINANCE=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT nome FROM fonte_dados WHERE nome='yfinance';")
YFINANCE=$(echo $YFINANCE | xargs)
if [ "$YFINANCE" = "yfinance" ]; then
    echo -e "${GREEN}‚úì${NC} Fonte yfinance encontrada"
else
    echo -e "${RED}‚úó${NC} Fonte yfinance n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 5 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo dos Dados:"
    echo "  - $USERS usu√°rios"
    echo "  - $ATIVOS ativos ($ACOES a√ß√µes + $FIIS FIIs)"
    echo "  - $REGRAS regras fiscais"
    echo "  - $FERIADOS feriados"
    echo "  - $FONTES fontes de dados"
    echo ""
    echo "‚úÖ Banco de dados populado e pronto!"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 5 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/test_module0.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/rebuild_restart_exitus-backend.sh ---
# 1. Substituir backend/app/models/usuario.py com o c√≥digo acima

# 2. Rebuild
cd backend && podman build -t exitus-backend:latest . && cd ..

# 3. Restart
./scripts/setup_containers.sh 

# 4. Verificar status
podman ps

# 5. Verificar logs
podman logs --tail 50 exitus-backend

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/populate_seeds.sh ---
#!/bin/bash

# =====================================================
# EXITUS - POPULAR BANCO COM SEEDS INICIAIS
# =====================================================
# Arquivo: scripts/populate_seeds.sh
# =====================================================

set -e  # Para em caso de erro

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "üöÄ Iniciando popula√ß√£o de seeds do Exitus..."
echo "üìÅ Projeto: $PROJECT_ROOT"
echo

# =====================================================
# 1. VERIFICAR CONTAINERS ONLINE (CORRIGIDO)
# =====================================================
echo "üîç [1/3] Verificando containers..."

# M√©todo mais robusto: usar podman inspect
if ! podman inspect exitus-backend >/dev/null 2>&1; then
    echo "‚ùå ERRO: Container 'exitus-backend' n√£o existe"
    exit 1
fi

if ! podman inspect exitus-db >/dev/null 2>&1; then
    echo "‚ùå ERRO: Container 'exitus-db' n√£o existe"
    exit 1
fi

BACKEND_STATUS=$(podman inspect exitus-backend --format "{{.State.Status}}" 2>/dev/null)
DB_STATUS=$(podman inspect exitus-db --format "{{.State.Status}}" 2>/dev/null)

if [[ "$BACKEND_STATUS" != "running" ]]; then
    echo "‚ùå ERRO: Container 'exitus-backend' n√£o est√° rodando ($BACKEND_STATUS)"
    exit 1
fi

if [[ "$DB_STATUS" != "running" ]]; then
    echo "‚ùå ERRO: Container 'exitus-db' n√£o est√° rodando ($DB_STATUS)"
    exit 1
fi

echo "‚úÖ Containers OK: backend($BACKEND_STATUS) | db($DB_STATUS)"
echo

# =====================================================
# 2. EXECUTAR RUN_ALL_SEEDS (INTERATIVO)
# =====================================================
echo "üå± [2/3] Executando seeds interativos..."
echo "   Digite 's' para continuar e 'n' quando solicitado para seeds j√° existentes."
echo

podman exec -it exitus-backend python -m app.seeds.run_all_seeds

echo
echo "‚úÖ Seeds executados com sucesso!"
echo

# =====================================================
# 3. LISTAR RESUMO DAS TABELAS (2 FORMAS)
# =====================================================
echo "üìä [3/3] Resumo das tabelas populadas..."

echo "=== M√âTODO 1: Query Direta (Tabelas Principais) ==="
podman exec exitus-db psql -U exitus -d exitusdb -c "
SELECT 
  'usuario' as tabela, COUNT(*) as registros FROM usuario
UNION ALL
SELECT 'ativo', COUNT(*) FROM ativo
UNION ALL
SELECT 'regra_fiscal', COUNT(*) FROM regra_fiscal
UNION ALL
SELECT 'feriado_mercado', COUNT(*) FROM feriado_mercado
UNION ALL
SELECT 'fonte_dados', COUNT(*) FROM fonte_dados
ORDER BY tabela;"

echo
echo "=== M√âTODO 2: Todas as Tabelas (Autom√°tico) ==="
podman exec exitus-db psql -U exitus -d exitusdb -c "
SELECT 
  t.table_name as tabela,
  COALESCE(c.reltuples::bigint, 0) as estimativa_registros
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE t.table_schema = 'public' 
AND t.table_type = 'BASE TABLE'
ORDER BY t.table_name;"

echo
echo "üéâ Popula√ß√£o de seeds conclu√≠da com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/restore_db.sh ---
#!/bin/bash

# --- Configura√ß√µes ---
DB_CONTAINER="exitus-db"
APP_CONTAINERS=("exitus-backend" "exitus-frontend")
DB_NAME="exitusdb"
DB_USER="exitus"
POSTGRES_MASTER_DB="postgres" # Banco de dados para se conectar e executar DROP/CREATE


## --- FUN√á√ïES AUXILIARES ---

# Fun√ß√£o para checar o status de um container
check_container_status() {
    local container_name=$1
    if podman inspect --format '{{.State.Running}}' "$container_name" 2>/dev/null | grep -q "true"; then
        echo "‚úÖ $container_name est√° ONLINE."
        return 0
    else
        echo "‚ùå $container_name est√° OFFLINE."
        return 1
    fi
}

# Fun√ß√£o para parar containers da aplica√ß√£o
stop_app_containers() {
    echo "--- üõë Parando containers da aplica√ß√£o... ---"
    for container in "${APP_CONTAINERS[@]}"; do
        if check_container_status "$container"; then
            echo "Parando $container..."
            podman stop "$container"
        fi
    done
    echo "Containers da aplica√ß√£o parados."
}

# Fun√ß√£o para iniciar containers da aplica√ß√£o
start_app_containers() {
    echo "--- üöÄ Iniciando containers da aplica√ß√£o... ---"
    for container in "${APP_CONTAINERS[@]}"; do
        echo "Iniciando $container..."
        podman start "$container"
    done
}


## --- L√ìGICA PRINCIPAL DO SCRIPT ---

# 1. Checa o argumento de entrada
if [ -z "$1" ]; then
    echo "ERRO: O nome do arquivo de dump √© obrigat√≥rio."
    echo "Uso: $0 <caminho/para/arquivo.sql>"
    exit 1
fi

DUMP_FILE="$1"

if [ ! -f "$DUMP_FILE" ]; then
    echo "ERRO: Arquivo de dump n√£o encontrado: $DUMP_FILE"
    exit 1
fi

echo "Arquivo de Dump Selecionado: $DUMP_FILE"

# 2. Para os containers da aplica√ß√£o
stop_app_containers

# 3. Verifica o status do container do banco de dados
echo "--- üîé Verificando status do container do banco de dados ($DB_CONTAINER)... ---"
if ! check_container_status "$DB_CONTAINER"; then
    echo "ERRO: O container do banco de dados ($DB_CONTAINER) n√£o est√° rodando. Por favor, inicie-o primeiro."
    exit 1
fi


# 4. Drop e Create do Banco de Dados
echo "--- üóëÔ∏è Limpando e recriando o banco de dados ($DB_NAME)... ---"

# Drop do banco de dados
echo "Deletando banco de dados existente ($DB_NAME)..."
# Conecta ao master DB para manipular o DB alvo
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" -d "$POSTGRES_MASTER_DB" -c "DROP DATABASE IF EXISTS $DB_NAME WITH (FORCE);"

if [ $? -ne 0 ]; then
    echo "ERRO ao deletar o banco de dados $DB_NAME."
    exit 1
fi

# Cria√ß√£o do novo banco de dados
echo "Criando novo banco de dados ($DB_NAME)..."
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" -d "$POSTGRES_MASTER_DB" -c "CREATE DATABASE $DB_NAME;"

if [ $? -ne 0 ]; then
    echo "ERRO ao criar o banco de dados $DB_NAME."
    exit 1
fi

echo "Banco de dados $DB_NAME limpo e recriado com sucesso."


# 5. Execu√ß√£o do Restore
echo "--- üì• Iniciando o Restore do arquivo $DUMP_FILE... ---"
cat "$DUMP_FILE" | podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" "$DB_NAME"

if [ $? -eq 0 ]; then
    echo "‚úÖ RESTORE CONCLU√çDO COM SUCESSO!"
else
    echo "‚ùå ERRO DURANTE O RESTORE. Verifique os logs."
fi


# 6. Lista a tabela 'usuario'
echo "--- üìù Conte√∫do da Tabela 'usuario' ap√≥s o Restore ---"
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" "$DB_NAME" -c "SELECT id, username, email FROM usuario LIMIT 10;"


# 7. Inicia os containers da aplica√ß√£o
start_app_containers

# 8. Lista o status de todos os containers
echo "--- üìä Status de Todos os Containers ---"
podman ps -a

echo
echo

cat << 'EOF'
# ========================================================
# GARANTA QUE AS SEEDS ESTEJAM POPULADAS NA BASE DE DADOS:
# 
# EXECUTE: exitus/scirpts/populate_seeds.sh
# ========================================================
EOF

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
sleep 30
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod0_validacao_final.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase1.sh ---
# No HOST Ubuntu
echo "=== Valida√ß√£o Fase 1 ==="
echo "1. Containers:"
#podman ps --format "{{.Names}}" | grep exitus
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
echo "2. Estrutura:"
ls -la backend/app/models/ backend/app/seeds/ backend/alembic/
echo ""
echo "3. Conex√£o DB:"
podman exec exitus-backend python3 -c "from app import create_app; app=create_app(); print('‚úì App inicializada')"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase2.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 2 - Models Core

echo "======================================"
echo "  VALIDA√á√ÉO FASE 2 - MODELS CORE"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("usuario.py" "corretora.py" "ativo.py" "posicao.py" "transacao.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo, Posicao, Transacao, TipoOperacao
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal

errors = 0

# Testar Usuario
try:
    u = Usuario(username='test', email='test@test.com')
    u.set_password('123')
    print('‚úì Usuario OK')
except Exception as e:
    print(f'‚úó Usuario ERRO: {e}')
    errors += 1

# Testar Corretora
try:
    c = Corretora(usuario_id=u.id, nome='Test', pais='BR', moeda_padrao='BRL')
    print('‚úì Corretora OK')
except Exception as e:
    print(f'‚úó Corretora ERRO: {e}')
    errors += 1

# Testar Ativo
try:
    a = Ativo(ticker='TEST4', nome='Test SA', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    print('‚úì Ativo OK')
except Exception as e:
    print(f'‚úó Ativo ERRO: {e}')
    errors += 1

# Testar Posicao
try:
    p = Posicao(usuario_id=u.id, corretora_id=c.id, ativo_id=a.id)
    p.adicionar_compra(Decimal('10'), Decimal('50'))
    print('‚úì Posicao OK')
except Exception as e:
    print(f'‚úó Posicao ERRO: {e}')
    errors += 1

# Testar Transacao
try:
    from datetime import date
    t = Transacao(
        usuario_id=u.id,
        corretora_id=c.id,
        ativo_id=a.id,
        tipo_operacao=TipoOperacao.COMPRA,
        quantidade=Decimal('10'),
        preco_unitario=Decimal('50'),
        data_operacao=date.today()
    )
    print('‚úì Transacao OK')
except Exception as e:
    print(f'‚úó Transacao ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import UserRole, TipoCorretora, TipoAtivo, ClasseAtivo, TipoOperacao
print(f'‚úì UserRole: {[r.value for r in UserRole]}')
print(f'‚úì TipoCorretora: {[t.value for t in TipoCorretora]}')
print(f'‚úì TipoAtivo: {[t.value for t in TipoAtivo]}')
print(f'‚úì ClasseAtivo: {[c.value for c in ClasseAtivo]}')
print(f'‚úì TipoOperacao: {[t.value for t in TipoOperacao]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 2 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    exit 0
else
    echo -e "${RED}‚úó FASE 2 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase3.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 3 - Models Complementares

echo "======================================"
echo "  VALIDA√á√ÉO FASE 3 - MODELS COMPLEMENTARES"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("provento.py" "movimentacao_caixa.py" "evento_corporativo.py" "fonte_dados.py" "regra_fiscal.py" "feriado_mercado.py" "log_auditoria.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import (
    Provento, TipoProvento,
    MovimentacaoCaixa, TipoMovimentacao,
    EventoCorporativo, TipoEventoCorporativo,
    FonteDados, TipoFonteDados,
    RegraFiscal, IncidenciaImposto,
    FeriadoMercado, TipoFeriado,
    LogAuditoria
)
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date, time

errors = 0

# Testar Provento
try:
    ativo = Ativo(ticker='TEST4', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    p = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('1.50'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    print('‚úì Provento OK')
except Exception as e:
    print(f'‚úó Provento ERRO: {e}')
    errors += 1

# Testar MovimentacaoCaixa
try:
    user = Usuario(username='test', email='test@test.com')
    corr = Corretora(usuario_id=user.id, nome='Test', pais='BR', moeda_padrao='BRL')
    m = MovimentacaoCaixa(
        usuario_id=user.id,
        corretora_id=corr.id,
        tipo_movimentacao=TipoMovimentacao.DEPOSITO,
        valor=Decimal('1000'),
        moeda='BRL',
        data_movimentacao=date.today()
    )
    print('‚úì MovimentacaoCaixa OK')
except Exception as e:
    print(f'‚úó MovimentacaoCaixa ERRO: {e}')
    errors += 1

# Testar EventoCorporativo
try:
    e = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split 2 para 1'
    )
    print('‚úì EventoCorporativo OK')
except Exception as e:
    print(f'‚úó EventoCorporativo ERRO: {e}')
    errors += 1

# Testar FonteDados
try:
    f = FonteDados(
        nome='yfinance',
        tipo_fonte=TipoFonteDados.API,
        url_base='https://finance.yahoo.com',
        ativa=True,
        prioridade=1
    )
    print('‚úì FonteDados OK')
except Exception as e:
    print(f'‚úó FonteDados ERRO: {e}')
    errors += 1

# Testar RegraFiscal
try:
    r = RegraFiscal(
        pais='BR',
        tipo_ativo='ACAO',
        aliquota_ir=Decimal('15.0'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='IR sobre ganhos de capital',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    print('‚úì RegraFiscal OK')
except Exception as e:
    print(f'‚úó RegraFiscal ERRO: {e}')
    errors += 1

# Testar FeriadoMercado
try:
    fer = FeriadoMercado(
        pais='BR',
        mercado='B3',
        data_feriado=date(2025, 12, 25),
        tipo_feriado=TipoFeriado.NACIONAL,
        nome='Natal',
        recorrente=True
    )
    print('‚úì FeriadoMercado OK')
except Exception as e:
    print(f'‚úó FeriadoMercado ERRO: {e}')
    errors += 1

# Testar LogAuditoria
try:
    log = LogAuditoria(
        usuario_id=user.id,
        acao='LOGIN',
        ip_address='127.0.0.1',
        sucesso=True
    )
    print('‚úì LogAuditoria OK')
except Exception as e:
    print(f'‚úó LogAuditoria ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import (
    TipoProvento, TipoMovimentacao, TipoEventoCorporativo,
    TipoFonteDados, IncidenciaImposto, TipoFeriado
)
print(f'‚úì TipoProvento: {[t.value for t in TipoProvento]}')
print(f'‚úì TipoMovimentacao: {[t.value for t in TipoMovimentacao]}')
print(f'‚úì TipoEventoCorporativo: {[t.value for t in TipoEventoCorporativo]}')
print(f'‚úì TipoFonteDados: {[t.value for t in TipoFonteDados]}')
print(f'‚úì IncidenciaImposto: {[i.value for i in IncidenciaImposto]}')
print(f'‚úì TipoFeriado: {[t.value for t in TipoFeriado]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "5. Testando m√©todos espec√≠ficos..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date

errors = 0

# Testar c√°lculos de Provento
try:
    ativo = Ativo(ticker='TEST', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL', preco_atual=Decimal('40'))
    prov = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('2.00'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    dy = prov.dividend_yield_efetivo(ativo.preco_atual)
    assert dy == 5.0, f"DY deveria ser 5.0, foi {dy}"
    print('‚úì Provento.dividend_yield_efetivo() OK')
except Exception as e:
    print(f'‚úó Provento m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculos de EventoCorporativo
try:
    evento = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split'
    )
    fator = evento.calcular_fator_ajuste()
    assert fator == 2.0, f"Fator deveria ser 2.0, foi {fator}"
    print('‚úì EventoCorporativo.calcular_fator_ajuste() OK')
except Exception as e:
    print(f'‚úó EventoCorporativo m√©todos ERRO: {e}')
    errors += 1

# Testar estat√≠sticas de FonteDados
try:
    fonte = FonteDados(nome='test', tipo_fonte=TipoFonteDados.API, ativa=True, prioridade=1)
    fonte.registrar_consulta_sucesso()
    fonte.registrar_consulta_sucesso()
    fonte.registrar_erro()
    taxa = fonte.taxa_sucesso()
    assert 66.0 <= taxa <= 67.0, f"Taxa sucesso deveria ser ~66.67%, foi {taxa}"
    print('‚úì FonteDados.taxa_sucesso() OK')
except Exception as e:
    print(f'‚úó FonteDados m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculo de imposto RegraFiscal
try:
    regra = RegraFiscal(
        pais='BR',
        aliquota_ir=Decimal('15.0'),
        valor_isencao=Decimal('20000'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='Test',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    imposto = regra.calcular_imposto(Decimal('30000'))
    assert imposto == 1500, f"Imposto deveria ser 1500, foi {imposto}"
    print('‚úì RegraFiscal.calcular_imposto() OK')
except Exception as e:
    print(f'‚úó RegraFiscal m√©todos ERRO: {e}')
    errors += 1

# Testar altera√ß√µes LogAuditoria
try:
    log = LogAuditoria(
        acao='UPDATE',
        dados_antes={'nome': 'Jo√£o', 'idade': 30},
        dados_depois={'nome': 'Jo√£o Silva', 'idade': 30},
        sucesso=True
    )
    alteracoes = log.get_alteracoes()
    assert 'nome' in alteracoes, "Deveria detectar altera√ß√£o em 'nome'"
    assert 'idade' not in alteracoes, "N√£o deveria detectar altera√ß√£o em 'idade'"
    print('‚úì LogAuditoria.get_alteracoes() OK')
except Exception as e:
    print(f'‚úó LogAuditoria m√©todos ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os m√©todos espec√≠ficos funcionando"
else
    echo -e "${RED}‚úó${NC} Erros nos m√©todos espec√≠ficos"
    ((ERRORS++))
fi
echo ""

echo "6. Resumo de models criados..."
echo -e "${YELLOW}Fase 2 (Core):${NC}"
echo "  1. Usuario"
echo "  2. Corretora"
echo "  3. Ativo"
echo "  4. Posicao"
echo "  5. Transacao"
echo ""
echo -e "${YELLOW}Fase 3 (Complementares):${NC}"
echo "  6. Provento"
echo "  7. MovimentacaoCaixa"
echo "  8. EventoCorporativo"
echo "  9. FonteDados"
echo "  10. RegraFiscal"
echo "  11. FeriadoMercado"
echo "  12. LogAuditoria"
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 3 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Total: 12 models criados"
    echo "‚úÖ Pr√≥ximo: Fase 4 - Migrations e Schema"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 3 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase4.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 4 - Migrations e Schema

echo "======================================"
echo "  VALIDA√á√ÉO FASE 4 - MIGRATIONS E SCHEMA"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando migration gerada..."
MIGRATION_FILE=$(ls backend/alembic/versions/*_initial_schema_12_models.py 2>/dev/null | head -1)
if [ -f "$MIGRATION_FILE" ]; then
    LINES=$(wc -l < "$MIGRATION_FILE")
    if [ "$LINES" -gt 400 ]; then
        echo -e "${GREEN}‚úì${NC} Migration gerada: $MIGRATION_FILE ($LINES linhas)"
    else
        echo -e "${RED}‚úó${NC} Migration muito pequena: $LINES linhas"
        ((ERRORS++))
    fi
else
    echo -e "${RED}‚úó${NC} Migration n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando tabelas no PostgreSQL..."
TABLES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE';")
TABLES=$(echo $TABLES | xargs) # trim whitespace
if [ "$TABLES" -eq 13 ]; then
    echo -e "${GREEN}‚úì${NC} 13 tabelas criadas (12 models + alembic_version)"
else
    echo -e "${RED}‚úó${NC} Esperado 13 tabelas, encontrado: $TABLES"
    ((ERRORS++))
fi

# Listar tabelas
echo -e "${YELLOW}Tabelas encontradas:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE' ORDER BY table_name;" | sed 's/^/ - /'
echo ""

echo "3. Verificando enums no PostgreSQL..."
ENUMS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_type WHERE typtype='e';")
ENUMS=$(echo $ENUMS | xargs)
if [ "$ENUMS" -eq 11 ]; then
    echo -e "${GREEN}‚úì${NC} 11 enums criados"
else
    echo -e "${RED}‚úó${NC} Esperado 11 enums, encontrado: $ENUMS"
    ((ERRORS++))
fi

# Listar enums
echo -e "${YELLOW}Enums encontrados:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT typname FROM pg_type WHERE typtype='e' ORDER BY typname;" | sed 's/^/ - /'
echo ""

echo "4. Verificando foreign keys..."
FKS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.table_constraints WHERE constraint_type='FOREIGN KEY';")
FKS=$(echo $FKS | xargs)
if [ "$FKS" -ge 10 ]; then
    echo -e "${GREEN}‚úì${NC} $FKS foreign keys criadas"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $FKS foreign keys encontradas (esperado >=10)"
fi
echo ""

echo "5. Verificando √≠ndices..."
INDEXES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname='public';")
INDEXES=$(echo $INDEXES | xargs)
if [ "$INDEXES" -ge 50 ]; then
    echo -e "${GREEN}‚úì${NC} $INDEXES √≠ndices criados"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $INDEXES √≠ndices encontrados"
fi
echo ""

echo "6. Testando insert em tabela usuario..."
podman exec exitus-db psql -U exitus -d exitusdb -c "
INSERT INTO usuario (id, username, email, password_hash, ativo, role, created_at, updated_at)
VALUES (
    gen_random_uuid(),
    'test_validation',
    'test@validation.com',
    'hash123',
    true,
    'USER'::userrole,
    NOW(),
    NOW()
) ON CONFLICT DO NOTHING;
" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Insert de teste bem-sucedido"
    # Limpar
    podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario WHERE username='test_validation';" > /dev/null 2>&1
else
    echo -e "${RED}‚úó${NC} Erro no insert de teste"
    ((ERRORS++))
fi
echo ""

echo "7. Verificando vers√£o do Alembic..."
ALEMBIC_VERSION=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT version_num FROM alembic_version;")
ALEMBIC_VERSION=$(echo $ALEMBIC_VERSION | xargs)
if [ ! -z "$ALEMBIC_VERSION" ]; then
    echo -e "${GREEN}‚úì${NC} Alembic version: $ALEMBIC_VERSION"
else
    echo -e "${RED}‚úó${NC} Vers√£o do Alembic n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 4 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo:"
    echo "  - 13 tabelas criadas"
    echo "  - 11 enums criados"
    echo "  - $FKS foreign keys"
    echo "  - $INDEXES √≠ndices"
    echo ""
    echo "‚úÖ Pr√≥ximo: Fase 5 - Seeds de Dados"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 4 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase5.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 5 - Seeds de Dados

echo "======================================"
echo "  VALIDA√á√ÉO FASE 5 - SEEDS DE DADOS"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

echo "1. Verificando usu√°rios..."
USERS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM usuario;")
USERS=$(echo $USERS | xargs)
if [ "$USERS" -eq 4 ]; then
    echo -e "${GREEN}‚úì${NC} 4 usu√°rios cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 4 usu√°rios, encontrado: $USERS"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando ativos brasileiros..."
ATIVOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR';")
ATIVOS=$(echo $ATIVOS | xargs)
if [ "$ATIVOS" -eq 25 ]; then
    echo -e "${GREEN}‚úì${NC} 25 ativos brasileiros cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 25 ativos, encontrado: $ATIVOS"
    ((ERRORS++))
fi

#ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='acao';")
ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='ACAO';")
ACOES=$(echo $ACOES | xargs)
echo -e "  - A√ß√µes: $ACOES"

#FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='fii';")
FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='FII';")
FIIS=$(echo $FIIS | xargs)
echo -e "  - FIIs: $FIIS"
echo ""

echo "3. Verificando regras fiscais BR..."
REGRAS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM regra_fiscal WHERE pais='BR';")
REGRAS=$(echo $REGRAS | xargs)
if [ "$REGRAS" -eq 6 ]; then
    echo -e "${GREEN}‚úì${NC} 6 regras fiscais brasileiras cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 6 regras, encontrado: $REGRAS"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando feriados B3..."
FERIADOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM feriado_mercado WHERE pais='BR' AND mercado='B3';")
FERIADOS=$(echo $FERIADOS | xargs)
if [ "$FERIADOS" -eq 30 ]; then
    echo -e "${GREEN}‚úì${NC} 30 feriados B3 cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 30 feriados, encontrado: $FERIADOS"
    ((ERRORS++))
fi
echo ""

echo "5. Verificando fontes de dados..."
FONTES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM fonte_dados;")
FONTES=$(echo $FONTES | xargs)
if [ "$FONTES" -eq 7 ]; then
    echo -e "${GREEN}‚úì${NC} 7 fontes de dados cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 7 fontes, encontrado: $FONTES"
    ((ERRORS++))
fi
echo ""

echo "6. Verificando dados espec√≠ficos..."

# Verificar usu√°rio admin
ADMIN=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT username FROM usuario WHERE role='ADMIN' LIMIT 1;")
ADMIN=$(echo $ADMIN | xargs)
if [ "$ADMIN" = "admin" ]; then
    echo -e "${GREEN}‚úì${NC} Usu√°rio admin encontrado"
else
    echo -e "${RED}‚úó${NC} Usu√°rio admin n√£o encontrado"
    ((ERRORS++))
fi

# Verificar PETR4
PETR4=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT ticker FROM ativo WHERE ticker='PETR4';")
PETR4=$(echo $PETR4 | xargs)
if [ "$PETR4" = "PETR4" ]; then
    echo -e "${GREEN}‚úì${NC} Ativo PETR4 encontrado"
else
    echo -e "${RED}‚úó${NC} Ativo PETR4 n√£o encontrado"
    ((ERRORS++))
fi

# Verificar yfinance
YFINANCE=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT nome FROM fonte_dados WHERE nome='yfinance';")
YFINANCE=$(echo $YFINANCE | xargs)
if [ "$YFINANCE" = "yfinance" ]; then
    echo -e "${GREEN}‚úì${NC} Fonte yfinance encontrada"
else
    echo -e "${RED}‚úó${NC} Fonte yfinance n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 5 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo dos Dados:"
    echo "  - $USERS usu√°rios"
    echo "  - $ATIVOS ativos ($ACOES a√ß√µes + $FIIS FIIs)"
    echo "  - $REGRAS regras fiscais"
    echo "  - $FERIADOS feriados"
    echo "  - $FONTES fontes de dados"
    echo ""
    echo "‚úÖ Banco de dados populado e pronto!"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 5 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================


====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/rebuild_restart_exitus-backend.sh ---
#!/bin/bash
echo "üîÑ Exitus Backend - Rebuild SEGURO (preserva banco)"

# 1. Build SEM recriar banco
cd backend && podman build -t exitus-backend:latest . && cd ..

# 2. S√ì backend (preserva DB + Frontend)
podman stop exitus-backend
podman rm exitus-backend
podman run -d --name exitus-backend --network exitus-net -p 5000:5000 \
  -v $(pwd)/backend/app:/app/app \
  -v exitus-backend-logs:/app/logs \
  --env-file backend/.env exitus-backend:latest

sleep 15
podman logs --tail 30 exitus-backend
curl http://localhost:5000/health

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/backup_db.sh ---
#!/bin/bash
# Backup do banco de dados PostgreSQL

BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "Criando backup do banco de dados..."

podman exec exitus-db pg_dump -U exitus exitusdb > "$BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

echo "Backup criado: $BACKUP_DIR/exitusdb_$TIMESTAMP.sql"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/cleanup_containers.sh ---
#!/bin/bash
# Remove todos os containers, volumes do Exitus E mata processos √≥rf√£os na porta 5000

echo "=== Cleanup Exitus ==="

# --- 1. Limpeza de Cont√™ineres ---

echo "Parando containers..."
podman stop exitus-frontend 2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-db 2>/dev/null || true

echo "Removendo containers..."
podman rm exitus-frontend 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-db 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "Containers removidos!"
echo ""

echo "Para remover tamb√©m volumes e network, execute manualmente (cuidado!):"
echo "  podman volume rm exitus-pgdata exitus-backend-logs exitus-frontend-logs"
echo "  podman network rm exitus-net"
echo ""

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/exitus_db_doc.sh ---
#!/bin/bash

# Script para documentar estrutura completa do banco exitus-db
# Gera arquivo texto com todas as tabelas, colunas, PKs, FKs e constraints
# Autor: Sistema Exitus
# Data: 2025-12-02

# Configura√ß√µes do ambiente (baseadas no restore_db.sh)
DB_CONTAINER="exitus-db"
DB_NAME="exitusdb"  # Corrigido de "exitus" para "exitusdb"
DB_USER="exitus"     # Corrigido de "exitus_user" para "exitus"
OUTPUT_FILE="exitus_db_structure_$(date +%Y%m%d_%H%M%S).txt"

# Cores para output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  EXITUS - Documenta√ß√£o da Estrutura do Banco${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Verifica se o container est√° rodando
if ! podman ps | grep -q "$DB_CONTAINER"; then
    echo -e "${YELLOW}AVISO: Container $DB_CONTAINER n√£o est√° rodando!${NC}"
    echo "Execute: podman start $DB_CONTAINER"
    exit 1
fi

echo -e "${GREEN}‚úì Container $DB_CONTAINER est√° online${NC}"
echo -e "Gerando documenta√ß√£o em: ${YELLOW}$OUTPUT_FILE${NC}"
echo ""

# Cria o arquivo de sa√≠da com cabe√ßalho
cat > "$OUTPUT_FILE" << EOF
================================================================================
EXITUS - ESTRUTURA DO BANCO DE DADOS
================================================================================
Database: $DB_NAME
Gerado em: $(date '+%Y-%m-%d %H:%M:%S')
================================================================================

EOF

# SQL para listar todas as tabelas do schema public
echo "Coletando lista de tabelas..." 
podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"
\echo '================================================================================'
\echo 'TABELAS DO BANCO EXITUS'
\echo '================================================================================'
\echo ''

SELECT 
    schemaname as "Schema",
    tablename as "Tabela",
    tableowner as "Owner"
FROM pg_catalog.pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;

\echo ''
EOSQL

# Verifica se houve erro na primeira query
if [ $? -ne 0 ]; then
    echo -e "${YELLOW}ERRO ao conectar ao banco de dados!${NC}"
    exit 1
fi

# SQL para estrutura detalhada de cada tabela
echo "Coletando estrutura detalhada das tabelas..."
podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"

\echo '================================================================================'
\echo 'ESTRUTURA DETALHADA DAS TABELAS'
\echo '================================================================================'
\echo ''

-- Para cada tabela, mostra estrutura completa
DO $$
DECLARE
    tbl_name text;
BEGIN
    FOR tbl_name IN 
        SELECT tablename 
        FROM pg_catalog.pg_tables 
        WHERE schemaname = 'public'
        ORDER BY tablename
    LOOP
        RAISE NOTICE '';
        RAISE NOTICE '################################################################################';
        RAISE NOTICE 'TABELA: %', tbl_name;
        RAISE NOTICE '################################################################################';
        RAISE NOTICE '';
    END LOOP;
END $$;

EOSQL

# Para cada tabela, executa \d+ e informa√ß√µes adicionais
echo "Coletando detalhes de colunas, PKs e FKs..."
TABLES=$(podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -t -c "SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public' ORDER BY tablename;")

for table in $TABLES; do
    # Remove espa√ßos em branco
    table=$(echo "$table" | xargs)
    
    echo "  - Processando tabela: $table"
    
    cat >> "$OUTPUT_FILE" << EOF

################################################################################
TABELA: $table
################################################################################

EOF

    # Usa \d+ para mostrar estrutura completa da tabela
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"
\d+ $table

EOSQL

    # Query customizada para mostrar colunas com detalhes
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Detalhes das Colunas
SELECT 
    ordinal_position as "Pos",
    column_name as "Coluna",
    data_type as "Tipo",
    CASE 
        WHEN character_maximum_length IS NOT NULL 
        THEN '(' || character_maximum_length || ')'
        ELSE ''
    END as "Tamanho",
    is_nullable as "Null?",
    column_default as "Default"
FROM information_schema.columns
WHERE table_schema = 'public' 
    AND table_name = '$table'
ORDER BY ordinal_position;

EOSQL

    # Query para mostrar Foreign Keys
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Foreign Keys (FKs)
\echo ''
\echo 'Foreign Keys:'
SELECT
    tc.constraint_name as "Nome FK",
    kcu.column_name as "Coluna",
    ccu.table_name AS "Tabela Referenciada",
    ccu.column_name AS "Coluna Referenciada"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Primary Keys
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Primary Keys (PKs)
\echo ''
\echo 'Primary Keys:'
SELECT
    tc.constraint_name as "Nome PK",
    kcu.column_name as "Coluna"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
WHERE tc.constraint_type = 'PRIMARY KEY' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Unique Constraints
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- Unique Constraints
\echo ''
\echo 'Unique Constraints:'
SELECT
    tc.constraint_name as "Nome Constraint",
    kcu.column_name as "Coluna"
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
WHERE tc.constraint_type = 'UNIQUE' 
    AND tc.table_schema = 'public'
    AND tc.table_name = '$table';

EOSQL

    # Query para mostrar Indexes
    podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << EOSQL >> "$OUTPUT_FILE"

-- √çndices
\echo ''
\echo '√çndices:'
SELECT
    indexname as "Nome do √çndice",
    indexdef as "Defini√ß√£o"
FROM pg_indexes
WHERE schemaname = 'public'
    AND tablename = '$table';

\echo ''
\echo '________________________________________________________________________________'
\echo ''

EOSQL

done

# Adiciona resumo ao final
cat >> "$OUTPUT_FILE" << EOF

================================================================================
RESUMO GERAL
================================================================================

EOF

podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" << 'EOSQL' >> "$OUTPUT_FILE"

-- Contagem de tabelas
\echo 'Total de Tabelas:'
SELECT COUNT(*) as "Total" 
FROM pg_catalog.pg_tables 
WHERE schemaname = 'public';

\echo ''
\echo 'Total de Colunas por Tabela:'
SELECT 
    table_name as "Tabela",
    COUNT(*) as "Num Colunas"
FROM information_schema.columns
WHERE table_schema = 'public'
GROUP BY table_name
ORDER BY table_name;

\echo ''
\echo 'Total de Foreign Keys por Tabela:'
SELECT
    tc.table_name as "Tabela",
    COUNT(*) as "Num FKs"
FROM information_schema.table_constraints AS tc 
WHERE tc.constraint_type = 'FOREIGN KEY' 
    AND tc.table_schema = 'public'
GROUP BY tc.table_name
ORDER BY tc.table_name;

EOSQL

# Finaliza o arquivo
cat >> "$OUTPUT_FILE" << EOF

================================================================================
FIM DA DOCUMENTA√á√ÉO
================================================================================
EOF

echo ""
echo -e "${GREEN}‚úì Documenta√ß√£o gerada com sucesso!${NC}"
echo -e "${BLUE}Arquivo: ${YELLOW}$OUTPUT_FILE${NC}"
echo ""
echo -e "${BLUE}Para visualizar:${NC}"
echo -e "  cat $OUTPUT_FILE"
echo -e "  less $OUTPUT_FILE"
echo -e "  code $OUTPUT_FILE  ${BLUE}# (se estiver usando VSCode)${NC}"
echo ""
echo -e "${GREEN}Pronto para compartilhar o status do banco! üéØ${NC}"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/populate_seeds.sh ---
#!/bin/bash

# =====================================================
# EXITUS - POPULAR BANCO COM SEEDS INICIAIS
# =====================================================
# Arquivo: scripts/populate_seeds.sh
# =====================================================

set -e  # Para em caso de erro

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "üöÄ Iniciando popula√ß√£o de seeds do Exitus..."
echo "üìÅ Projeto: $PROJECT_ROOT"
echo

# =====================================================
# 1. VERIFICAR CONTAINERS ONLINE (CORRIGIDO)
# =====================================================
echo "üîç [1/3] Verificando containers..."

# M√©todo mais robusto: usar podman inspect
if ! podman inspect exitus-backend >/dev/null 2>&1; then
    echo "‚ùå ERRO: Container 'exitus-backend' n√£o existe"
    exit 1
fi

if ! podman inspect exitus-db >/dev/null 2>&1; then
    echo "‚ùå ERRO: Container 'exitus-db' n√£o existe"
    exit 1
fi

BACKEND_STATUS=$(podman inspect exitus-backend --format "{{.State.Status}}" 2>/dev/null)
DB_STATUS=$(podman inspect exitus-db --format "{{.State.Status}}" 2>/dev/null)

if [[ "$BACKEND_STATUS" != "running" ]]; then
    echo "‚ùå ERRO: Container 'exitus-backend' n√£o est√° rodando ($BACKEND_STATUS)"
    exit 1
fi

if [[ "$DB_STATUS" != "running" ]]; then
    echo "‚ùå ERRO: Container 'exitus-db' n√£o est√° rodando ($DB_STATUS)"
    exit 1
fi

echo "‚úÖ Containers OK: backend($BACKEND_STATUS) | db($DB_STATUS)"
echo

# =====================================================
# 2. EXECUTAR RUN_ALL_SEEDS (INTERATIVO)
# =====================================================
echo "üå± [2/3] Executando seeds interativos..."
echo "   Digite 's' para continuar e 'n' quando solicitado para seeds j√° existentes."
echo

podman exec -it exitus-backend python -m app.seeds.run_all_seeds

echo
echo "‚úÖ Seeds executados com sucesso!"
echo

# =====================================================
# 3. LISTAR RESUMO DAS TABELAS (2 FORMAS)
# =====================================================
echo "üìä [3/3] Resumo das tabelas populadas..."

echo "=== M√âTODO 1: Query Direta (Tabelas Principais) ==="
podman exec exitus-db psql -U exitus -d exitusdb -c "
SELECT 
  'usuario' as tabela, COUNT(*) as registros FROM usuario
UNION ALL
SELECT 'ativo', COUNT(*) FROM ativo
UNION ALL
SELECT 'regra_fiscal', COUNT(*) FROM regra_fiscal
UNION ALL
SELECT 'feriado_mercado', COUNT(*) FROM feriado_mercado
UNION ALL
SELECT 'fonte_dados', COUNT(*) FROM fonte_dados
ORDER BY tabela;"

echo
echo "=== M√âTODO 2: Todas as Tabelas (Autom√°tico) ==="
podman exec exitus-db psql -U exitus -d exitusdb -c "
SELECT 
  t.table_name as tabela,
  COALESCE(c.reltuples::bigint, 0) as estimativa_registros
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE t.table_schema = 'public' 
AND t.table_type = 'BASE TABLE'
ORDER BY t.table_name;"

echo
echo "üéâ Popula√ß√£o de seeds conclu√≠da com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/restore_complete.sh ---
#!/bin/bash
echo "üîÑ Exitus - Restore COMPLETO (DB + Seeds)"

# 1. Parar servi√ßos
./scripts/stop_services.sh

# 2. Restore banco
./scripts/restore_db.sh

# 3. Recriar containers
./scripts/setup_containers.sh

# 4. Popular seeds
./scripts/populate_seeds.sh

echo "‚úÖ Restore completo conclu√≠do!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/restore_db.sh ---
#!/bin/bash

# --- Configura√ß√µes ---
DB_CONTAINER="exitus-db"
APP_CONTAINERS=("exitus-backend" "exitus-frontend")
DB_NAME="exitusdb"
DB_USER="exitus"
POSTGRES_MASTER_DB="postgres" # Banco de dados para se conectar e executar DROP/CREATE


## --- FUN√á√ïES AUXILIARES ---

# Fun√ß√£o para checar o status de um container
check_container_status() {
    local container_name=$1
    if podman inspect --format '{{.State.Running}}' "$container_name" 2>/dev/null | grep -q "true"; then
        echo "‚úÖ $container_name est√° ONLINE."
        return 0
    else
        echo "‚ùå $container_name est√° OFFLINE."
        return 1
    fi
}

# Fun√ß√£o para parar containers da aplica√ß√£o
stop_app_containers() {
    echo "--- üõë Parando containers da aplica√ß√£o... ---"
    for container in "${APP_CONTAINERS[@]}"; do
        if check_container_status "$container"; then
            echo "Parando $container..."
            podman stop "$container"
        fi
    done
    echo "Containers da aplica√ß√£o parados."
}

# Fun√ß√£o para iniciar containers da aplica√ß√£o
start_app_containers() {
    echo "--- üöÄ Iniciando containers da aplica√ß√£o... ---"
    for container in "${APP_CONTAINERS[@]}"; do
        echo "Iniciando $container..."
        podman start "$container"
    done
}


## --- L√ìGICA PRINCIPAL DO SCRIPT ---

# 1. Checa o argumento de entrada
if [ -z "$1" ]; then
    echo "ERRO: O nome do arquivo de dump √© obrigat√≥rio."
    echo "Uso: $0 <caminho/para/arquivo.sql>"
    exit 1
fi

DUMP_FILE="$1"

if [ ! -f "$DUMP_FILE" ]; then
    echo "ERRO: Arquivo de dump n√£o encontrado: $DUMP_FILE"
    exit 1
fi

echo "Arquivo de Dump Selecionado: $DUMP_FILE"

# 2. Para os containers da aplica√ß√£o
stop_app_containers

# 3. Verifica o status do container do banco de dados
echo "--- üîé Verificando status do container do banco de dados ($DB_CONTAINER)... ---"
if ! check_container_status "$DB_CONTAINER"; then
    echo "ERRO: O container do banco de dados ($DB_CONTAINER) n√£o est√° rodando. Por favor, inicie-o primeiro."
    exit 1
fi


# 4. Drop e Create do Banco de Dados
echo "--- üóëÔ∏è Limpando e recriando o banco de dados ($DB_NAME)... ---"

# Drop do banco de dados
echo "Deletando banco de dados existente ($DB_NAME)..."
# Conecta ao master DB para manipular o DB alvo
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" -d "$POSTGRES_MASTER_DB" -c "DROP DATABASE IF EXISTS $DB_NAME WITH (FORCE);"

if [ $? -ne 0 ]; then
    echo "ERRO ao deletar o banco de dados $DB_NAME."
    exit 1
fi

# Cria√ß√£o do novo banco de dados
echo "Criando novo banco de dados ($DB_NAME)..."
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" -d "$POSTGRES_MASTER_DB" -c "CREATE DATABASE $DB_NAME;"

if [ $? -ne 0 ]; then
    echo "ERRO ao criar o banco de dados $DB_NAME."
    exit 1
fi

echo "Banco de dados $DB_NAME limpo e recriado com sucesso."


# 5. Execu√ß√£o do Restore
echo "--- üì• Iniciando o Restore do arquivo $DUMP_FILE... ---"
cat "$DUMP_FILE" | podman exec -i "$DB_CONTAINER" psql -U "$DB_USER" "$DB_NAME"

if [ $? -eq 0 ]; then
    echo "‚úÖ RESTORE CONCLU√çDO COM SUCESSO!"
else
    echo "‚ùå ERRO DURANTE O RESTORE. Verifique os logs."
fi


# 6. Lista a tabela 'usuario'
echo "--- üìù Conte√∫do da Tabela 'usuario' ap√≥s o Restore ---"
podman exec -it "$DB_CONTAINER" psql -U "$DB_USER" "$DB_NAME" -c "SELECT id, username, email FROM usuario LIMIT 10;"


# 7. Inicia os containers da aplica√ß√£o
start_app_containers

# 8. Lista o status de todos os containers
echo "--- üìä Status de Todos os Containers ---"
podman ps -a

echo
echo

cat << 'EOF'
# ========================================================
# GARANTA QUE AS SEEDS ESTEJAM POPULADAS NA BASE DE DADOS:
# 
# EXECUTE: exitus/scirpts/populate_seeds.sh
# ========================================================
EOF

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_containers.sh ---
#!/bin/bash
# Configura√ß√£o inicial dos containers do Exitus

set -e

# Remover containers existentes
echo "Removendo containers antigos (se existirem)..."
podman stop exitus-db  2>/dev/null || true
podman stop exitus-backend 2>/dev/null || true
podman stop exitus-frontend 2>/dev/null || true

podman rm exitus-db 2>/dev/null || true
podman rm exitus-backend 2>/dev/null || true
podman rm exitus-frontend 2>/dev/null || true

pkill -9 containers-rootlessport || true

echo "=== Setup Exitus - M√≥dulo 0 ==="

# Criar network
echo "Criando network..."
podman network create exitus-net 2>/dev/null || echo "Network j√° existe"

# Criar volumes
echo "Criando volumes..."
podman volume create exitus-pgdata 2>/dev/null || echo "Volume pgdata j√° existe"
podman volume create exitus-backend-logs 2>/dev/null || echo "Volume backend-logs j√° existe"
podman volume create exitus-frontend-logs 2>/dev/null || echo "Volume frontend-logs j√° existe"

# Criar arquivos .env a partir dos exemplos (se n√£o existirem)
echo "Criando arquivos .env..."
if [ ! -f backend/.env ]; then
    cp backend/.env.example backend/.env
    echo "‚úì backend/.env criado a partir do .env.example"
else
    echo "‚úì backend/.env j√° existe"
fi

if [ ! -f frontend/.env ]; then
    cp frontend/.env.example frontend/.env
    echo "‚úì frontend/.env criado a partir do .env.example"
else
    echo "‚úì frontend/.env j√° existe"
fi

# Build das imagens
echo "Building backend image..."
cd backend
podman build -t exitus-backend:latest .
cd ..

echo "Building frontend image..."
cd frontend
podman build -t exitus-frontend:latest .
cd ..

# Criar container PostgreSQL
echo "Criando container PostgreSQL..."
podman run -d --name exitus-db \
  --network exitus-net \
  -v exitus-pgdata:/var/lib/postgresql/data \
  -e POSTGRES_USER=exitus \
  -e POSTGRES_PASSWORD=exitus123 \
  -e POSTGRES_DB=exitusdb \
  -e TZ=America/Sao_Paulo \
  docker.io/postgres:15

echo "Aguardando PostgreSQL inicializar..."
sleep 10

# Criar container Backend (usando .env)
echo "Criando container Backend..."
podman run -d --name exitus-backend \
  --network exitus-net \
  -p 5000:5000 \
  -v ./backend:/app:Z \
  -v exitus-backend-logs:/app/logs:Z \
  --env-file ./backend/.env \
  exitus-backend:latest

# Criar container Frontend (usando .env)
echo "Criando container Frontend..."
podman run -d --name exitus-frontend \
  --network exitus-net \
  -p 8080:8080 \
  -v ./frontend:/app:Z \
  -v exitus-frontend-logs:/app/logs:Z \
  --env-file ./frontend/.env \
  exitus-frontend:latest

echo ""
echo "=== Setup conclu√≠do! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
sleep 30
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/setup_env.sh ---
#!/bin/bash
# Configura ambiente (development, staging, production)

ENV=${1:-development}

echo "Configurando ambiente: $ENV"

case $ENV in
  development)
    echo "Usando configura√ß√µes de desenvolvimento..."
    cp backend/.env.example backend/.env
    cp frontend/.env.example frontend/.env
    ;;

  staging)
    echo "Usando configura√ß√µes de staging..."
    if [ -f backend/.env.staging ]; then
      cp backend/.env.staging backend/.env
    else
      echo "ERRO: backend/.env.staging n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.staging ]; then
      cp frontend/.env.staging frontend/.env
    else
      echo "ERRO: frontend/.env.staging n√£o encontrado"; exit 1
    fi
    ;;

  production)
    echo "Usando configura√ß√µes de produ√ß√£o..."
    if [ -f backend/.env.production ]; then
      cp backend/.env.production backend/.env
    else
      echo "ERRO: backend/.env.production n√£o encontrado"; exit 1
    fi
    if [ -f frontend/.env.production ]; then
      cp frontend/.env.production frontend/.env
    else
      echo "ERRO: frontend/.env.production n√£o encontrado"; exit 1
    fi
    ;;

  *)
    echo "Ambiente inv√°lido. Use: development, staging ou production"; exit 1;;
esac

echo "Ambiente $ENV configurado com sucesso!"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/start_services.sh ---
#!/bin/bash
# Inicia todos os servi√ßos do Exitus

echo "Iniciando servi√ßos Exitus..."

podman start exitus-db || true
echo "PostgreSQL iniciado"
sleep 5

podman start exitus-backend || true
echo "Backend iniciado"

podman start exitus-frontend || true
echo "Frontend iniciado"

echo ""
echo "=== Servi√ßos iniciados! ==="
echo "Backend: http://localhost:5000"
echo "Frontend: http://localhost:8080"
echo ""
podman ps

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/scripts/stop_services.sh ---
#!/bin/bash
# Para todos os servi√ßos do Exitus

echo "Parando servi√ßos Exitus..."

podman stop exitus-frontend exitus-backend exitus-db 2>/dev/null || true

echo "=== Servi√ßos parados! ==="

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod0_validacao_final.sh ---
#!/bin/bash
echo "======================================"
echo "  EXITUS - TESTES DO M√ìDULO 0"
echo "======================================"
echo ""

echo "1. Backend Health Check (host):"
curl -s http://localhost:5000/health | python3 -m json.tool
echo ""

echo "2. Frontend Health Check (host):"
curl -s http://localhost:8080/health | python3 -m json.tool
echo ""

echo "3. Frontend ‚Üí Backend (interno):"
podman exec exitus-frontend python -c "import requests; r = requests.get('http://exitus-backend:5000/health'); print(r.json())"
echo ""

echo "4. Backend ‚Üí Database (conex√£o):"
podman exec exitus-backend python -c "import socket; socket.create_connection(('exitus-db', 5432), timeout=5); print('‚úì Conex√£o OK')"
echo ""

echo "5. PostgreSQL Query:"
podman exec exitus-db psql -U exitus -d exitusdb -c "SELECT version();" | head -3
echo ""

echo "6. Containers rodando:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "======================================"
echo "  TODOS OS TESTES CONCLU√çDOS!"
echo "======================================"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase1.sh ---
# No HOST Ubuntu
echo "=== Valida√ß√£o Fase 1 ==="
echo "1. Containers:"
#podman ps --format "{{.Names}}" | grep exitus
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
echo "2. Estrutura:"
ls -la backend/app/models/ backend/app/seeds/ backend/alembic/
echo ""
echo "3. Conex√£o DB:"
podman exec exitus-backend python3 -c "from app import create_app; app=create_app(); print('‚úì App inicializada')"

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase2.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 2 - Models Core

echo "======================================"
echo "  VALIDA√á√ÉO FASE 2 - MODELS CORE"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("usuario.py" "corretora.py" "ativo.py" "posicao.py" "transacao.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import Usuario, UserRole, Corretora, TipoCorretora, Ativo, TipoAtivo, ClasseAtivo, Posicao, Transacao, TipoOperacao
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal

errors = 0

# Testar Usuario
try:
    u = Usuario(username='test', email='test@test.com')
    u.set_password('123')
    print('‚úì Usuario OK')
except Exception as e:
    print(f'‚úó Usuario ERRO: {e}')
    errors += 1

# Testar Corretora
try:
    c = Corretora(usuario_id=u.id, nome='Test', pais='BR', moeda_padrao='BRL')
    print('‚úì Corretora OK')
except Exception as e:
    print(f'‚úó Corretora ERRO: {e}')
    errors += 1

# Testar Ativo
try:
    a = Ativo(ticker='TEST4', nome='Test SA', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    print('‚úì Ativo OK')
except Exception as e:
    print(f'‚úó Ativo ERRO: {e}')
    errors += 1

# Testar Posicao
try:
    p = Posicao(usuario_id=u.id, corretora_id=c.id, ativo_id=a.id)
    p.adicionar_compra(Decimal('10'), Decimal('50'))
    print('‚úì Posicao OK')
except Exception as e:
    print(f'‚úó Posicao ERRO: {e}')
    errors += 1

# Testar Transacao
try:
    from datetime import date
    t = Transacao(
        usuario_id=u.id,
        corretora_id=c.id,
        ativo_id=a.id,
        tipo_operacao=TipoOperacao.COMPRA,
        quantidade=Decimal('10'),
        preco_unitario=Decimal('50'),
        data_operacao=date.today()
    )
    print('‚úì Transacao OK')
except Exception as e:
    print(f'‚úó Transacao ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import UserRole, TipoCorretora, TipoAtivo, ClasseAtivo, TipoOperacao
print(f'‚úì UserRole: {[r.value for r in UserRole]}')
print(f'‚úì TipoCorretora: {[t.value for t in TipoCorretora]}')
print(f'‚úì TipoAtivo: {[t.value for t in TipoAtivo]}')
print(f'‚úì ClasseAtivo: {[c.value for c in ClasseAtivo]}')
print(f'‚úì TipoOperacao: {[t.value for t in TipoOperacao]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 2 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    exit 0
else
    echo -e "${RED}‚úó FASE 2 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase3.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 3 - Models Complementares

echo "======================================"
echo "  VALIDA√á√ÉO FASE 3 - MODELS COMPLEMENTARES"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando arquivos de models..."
MODELS=("provento.py" "movimentacao_caixa.py" "evento_corporativo.py" "fonte_dados.py" "regra_fiscal.py" "feriado_mercado.py" "log_auditoria.py")
for model in "${MODELS[@]}"; do
    if [ -f "backend/app/models/$model" ]; then
        echo -e "${GREEN}‚úì${NC} backend/app/models/$model"
    else
        echo -e "${RED}‚úó${NC} backend/app/models/$model FALTANDO"
        ((ERRORS++))
    fi
done
echo ""

echo "2. Testando imports dos models..."
podman exec exitus-backend python3 -c "
from app.models import (
    Provento, TipoProvento,
    MovimentacaoCaixa, TipoMovimentacao,
    EventoCorporativo, TipoEventoCorporativo,
    FonteDados, TipoFonteDados,
    RegraFiscal, IncidenciaImposto,
    FeriadoMercado, TipoFeriado,
    LogAuditoria
)
print('‚úì Todos os imports OK')
" 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Imports bem-sucedidos"
else
    echo -e "${RED}‚úó${NC} Erro nos imports"
    ((ERRORS++))
fi
echo ""

echo "3. Testando cria√ß√£o de inst√¢ncias..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date, time

errors = 0

# Testar Provento
try:
    ativo = Ativo(ticker='TEST4', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL')
    p = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('1.50'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    print('‚úì Provento OK')
except Exception as e:
    print(f'‚úó Provento ERRO: {e}')
    errors += 1

# Testar MovimentacaoCaixa
try:
    user = Usuario(username='test', email='test@test.com')
    corr = Corretora(usuario_id=user.id, nome='Test', pais='BR', moeda_padrao='BRL')
    m = MovimentacaoCaixa(
        usuario_id=user.id,
        corretora_id=corr.id,
        tipo_movimentacao=TipoMovimentacao.DEPOSITO,
        valor=Decimal('1000'),
        moeda='BRL',
        data_movimentacao=date.today()
    )
    print('‚úì MovimentacaoCaixa OK')
except Exception as e:
    print(f'‚úó MovimentacaoCaixa ERRO: {e}')
    errors += 1

# Testar EventoCorporativo
try:
    e = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split 2 para 1'
    )
    print('‚úì EventoCorporativo OK')
except Exception as e:
    print(f'‚úó EventoCorporativo ERRO: {e}')
    errors += 1

# Testar FonteDados
try:
    f = FonteDados(
        nome='yfinance',
        tipo_fonte=TipoFonteDados.API,
        url_base='https://finance.yahoo.com',
        ativa=True,
        prioridade=1
    )
    print('‚úì FonteDados OK')
except Exception as e:
    print(f'‚úó FonteDados ERRO: {e}')
    errors += 1

# Testar RegraFiscal
try:
    r = RegraFiscal(
        pais='BR',
        tipo_ativo='ACAO',
        aliquota_ir=Decimal('15.0'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='IR sobre ganhos de capital',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    print('‚úì RegraFiscal OK')
except Exception as e:
    print(f'‚úó RegraFiscal ERRO: {e}')
    errors += 1

# Testar FeriadoMercado
try:
    fer = FeriadoMercado(
        pais='BR',
        mercado='B3',
        data_feriado=date(2025, 12, 25),
        tipo_feriado=TipoFeriado.NACIONAL,
        nome='Natal',
        recorrente=True
    )
    print('‚úì FeriadoMercado OK')
except Exception as e:
    print(f'‚úó FeriadoMercado ERRO: {e}')
    errors += 1

# Testar LogAuditoria
try:
    log = LogAuditoria(
        usuario_id=user.id,
        acao='LOGIN',
        ip_address='127.0.0.1',
        sucesso=True
    )
    print('‚úì LogAuditoria OK')
except Exception as e:
    print(f'‚úó LogAuditoria ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todas as inst√¢ncias criadas com sucesso"
else
    echo -e "${RED}‚úó${NC} Erros na cria√ß√£o de inst√¢ncias"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando enums..."
podman exec exitus-backend python3 -c "
from app.models import (
    TipoProvento, TipoMovimentacao, TipoEventoCorporativo,
    TipoFonteDados, IncidenciaImposto, TipoFeriado
)
print(f'‚úì TipoProvento: {[t.value for t in TipoProvento]}')
print(f'‚úì TipoMovimentacao: {[t.value for t in TipoMovimentacao]}')
print(f'‚úì TipoEventoCorporativo: {[t.value for t in TipoEventoCorporativo]}')
print(f'‚úì TipoFonteDados: {[t.value for t in TipoFonteDados]}')
print(f'‚úì IncidenciaImposto: {[i.value for i in IncidenciaImposto]}')
print(f'‚úì TipoFeriado: {[t.value for t in TipoFeriado]}')
"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os enums funcionando"
else
    echo -e "${RED}‚úó${NC} Erro nos enums"
    ((ERRORS++))
fi
echo ""

echo "5. Testando m√©todos espec√≠ficos..."
podman exec exitus-backend python3 << 'EOF'
from app.models import *
from decimal import Decimal
from datetime import date

errors = 0

# Testar c√°lculos de Provento
try:
    ativo = Ativo(ticker='TEST', nome='Test', tipo=TipoAtivo.ACAO, classe=ClasseAtivo.RENDA_VARIAVEL, mercado='BR', moeda='BRL', preco_atual=Decimal('40'))
    prov = Provento(
        ativo_id=ativo.id,
        tipo_provento=TipoProvento.DIVIDENDO,
        valor_por_acao=Decimal('2.00'),
        quantidade_ativos=Decimal('100'),
        imposto_retido=Decimal('0'),
        data_com=date(2025, 11, 20),
        data_pagamento=date(2025, 12, 5)
    )
    dy = prov.dividend_yield_efetivo(ativo.preco_atual)
    assert dy == 5.0, f"DY deveria ser 5.0, foi {dy}"
    print('‚úì Provento.dividend_yield_efetivo() OK')
except Exception as e:
    print(f'‚úó Provento m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculos de EventoCorporativo
try:
    evento = EventoCorporativo(
        ativo_id=ativo.id,
        tipo_evento=TipoEventoCorporativo.SPLIT,
        data_evento=date(2025, 12, 1),
        proporcao='2:1',
        descricao='Split'
    )
    fator = evento.calcular_fator_ajuste()
    assert fator == 2.0, f"Fator deveria ser 2.0, foi {fator}"
    print('‚úì EventoCorporativo.calcular_fator_ajuste() OK')
except Exception as e:
    print(f'‚úó EventoCorporativo m√©todos ERRO: {e}')
    errors += 1

# Testar estat√≠sticas de FonteDados
try:
    fonte = FonteDados(nome='test', tipo_fonte=TipoFonteDados.API, ativa=True, prioridade=1)
    fonte.registrar_consulta_sucesso()
    fonte.registrar_consulta_sucesso()
    fonte.registrar_erro()
    taxa = fonte.taxa_sucesso()
    assert 66.0 <= taxa <= 67.0, f"Taxa sucesso deveria ser ~66.67%, foi {taxa}"
    print('‚úì FonteDados.taxa_sucesso() OK')
except Exception as e:
    print(f'‚úó FonteDados m√©todos ERRO: {e}')
    errors += 1

# Testar c√°lculo de imposto RegraFiscal
try:
    regra = RegraFiscal(
        pais='BR',
        aliquota_ir=Decimal('15.0'),
        valor_isencao=Decimal('20000'),
        incide_sobre=IncidenciaImposto.LUCRO,
        descricao='Test',
        vigencia_inicio=date(2023, 1, 1),
        ativa=True
    )
    imposto = regra.calcular_imposto(Decimal('30000'))
    assert imposto == 1500, f"Imposto deveria ser 1500, foi {imposto}"
    print('‚úì RegraFiscal.calcular_imposto() OK')
except Exception as e:
    print(f'‚úó RegraFiscal m√©todos ERRO: {e}')
    errors += 1

# Testar altera√ß√µes LogAuditoria
try:
    log = LogAuditoria(
        acao='UPDATE',
        dados_antes={'nome': 'Jo√£o', 'idade': 30},
        dados_depois={'nome': 'Jo√£o Silva', 'idade': 30},
        sucesso=True
    )
    alteracoes = log.get_alteracoes()
    assert 'nome' in alteracoes, "Deveria detectar altera√ß√£o em 'nome'"
    assert 'idade' not in alteracoes, "N√£o deveria detectar altera√ß√£o em 'idade'"
    print('‚úì LogAuditoria.get_alteracoes() OK')
except Exception as e:
    print(f'‚úó LogAuditoria m√©todos ERRO: {e}')
    errors += 1

exit(errors)
EOF

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Todos os m√©todos espec√≠ficos funcionando"
else
    echo -e "${RED}‚úó${NC} Erros nos m√©todos espec√≠ficos"
    ((ERRORS++))
fi
echo ""

echo "6. Resumo de models criados..."
echo -e "${YELLOW}Fase 2 (Core):${NC}"
echo "  1. Usuario"
echo "  2. Corretora"
echo "  3. Ativo"
echo "  4. Posicao"
echo "  5. Transacao"
echo ""
echo -e "${YELLOW}Fase 3 (Complementares):${NC}"
echo "  6. Provento"
echo "  7. MovimentacaoCaixa"
echo "  8. EventoCorporativo"
echo "  9. FonteDados"
echo "  10. RegraFiscal"
echo "  11. FeriadoMercado"
echo "  12. LogAuditoria"
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 3 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Total: 12 models criados"
    echo "‚úÖ Pr√≥ximo: Fase 4 - Migrations e Schema"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 3 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase4.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 4 - Migrations e Schema

echo "======================================"
echo "  VALIDA√á√ÉO FASE 4 - MIGRATIONS E SCHEMA"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Contador de erros
ERRORS=0

echo "1. Verificando migration gerada..."
MIGRATION_FILE=$(ls backend/alembic/versions/*_initial_schema_12_models.py 2>/dev/null | head -1)
if [ -f "$MIGRATION_FILE" ]; then
    LINES=$(wc -l < "$MIGRATION_FILE")
    if [ "$LINES" -gt 400 ]; then
        echo -e "${GREEN}‚úì${NC} Migration gerada: $MIGRATION_FILE ($LINES linhas)"
    else
        echo -e "${RED}‚úó${NC} Migration muito pequena: $LINES linhas"
        ((ERRORS++))
    fi
else
    echo -e "${RED}‚úó${NC} Migration n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando tabelas no PostgreSQL..."
TABLES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE';")
TABLES=$(echo $TABLES | xargs) # trim whitespace
if [ "$TABLES" -eq 13 ]; then
    echo -e "${GREEN}‚úì${NC} 13 tabelas criadas (12 models + alembic_version)"
else
    echo -e "${RED}‚úó${NC} Esperado 13 tabelas, encontrado: $TABLES"
    ((ERRORS++))
fi

# Listar tabelas
echo -e "${YELLOW}Tabelas encontradas:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_type='BASE TABLE' ORDER BY table_name;" | sed 's/^/ - /'
echo ""

echo "3. Verificando enums no PostgreSQL..."
ENUMS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_type WHERE typtype='e';")
ENUMS=$(echo $ENUMS | xargs)
if [ "$ENUMS" -eq 11 ]; then
    echo -e "${GREEN}‚úì${NC} 11 enums criados"
else
    echo -e "${RED}‚úó${NC} Esperado 11 enums, encontrado: $ENUMS"
    ((ERRORS++))
fi

# Listar enums
echo -e "${YELLOW}Enums encontrados:${NC}"
podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT typname FROM pg_type WHERE typtype='e' ORDER BY typname;" | sed 's/^/ - /'
echo ""

echo "4. Verificando foreign keys..."
FKS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM information_schema.table_constraints WHERE constraint_type='FOREIGN KEY';")
FKS=$(echo $FKS | xargs)
if [ "$FKS" -ge 10 ]; then
    echo -e "${GREEN}‚úì${NC} $FKS foreign keys criadas"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $FKS foreign keys encontradas (esperado >=10)"
fi
echo ""

echo "5. Verificando √≠ndices..."
INDEXES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname='public';")
INDEXES=$(echo $INDEXES | xargs)
if [ "$INDEXES" -ge 50 ]; then
    echo -e "${GREEN}‚úì${NC} $INDEXES √≠ndices criados"
else
    echo -e "${YELLOW}‚ö†${NC} Apenas $INDEXES √≠ndices encontrados"
fi
echo ""

echo "6. Testando insert em tabela usuario..."
podman exec exitus-db psql -U exitus -d exitusdb -c "
INSERT INTO usuario (id, username, email, password_hash, ativo, role, created_at, updated_at)
VALUES (
    gen_random_uuid(),
    'test_validation',
    'test@validation.com',
    'hash123',
    true,
    'USER'::userrole,
    NOW(),
    NOW()
) ON CONFLICT DO NOTHING;
" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Insert de teste bem-sucedido"
    # Limpar
    podman exec exitus-db psql -U exitus -d exitusdb -c "DELETE FROM usuario WHERE username='test_validation';" > /dev/null 2>&1
else
    echo -e "${RED}‚úó${NC} Erro no insert de teste"
    ((ERRORS++))
fi
echo ""

echo "7. Verificando vers√£o do Alembic..."
ALEMBIC_VERSION=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT version_num FROM alembic_version;")
ALEMBIC_VERSION=$(echo $ALEMBIC_VERSION | xargs)
if [ ! -z "$ALEMBIC_VERSION" ]; then
    echo -e "${GREEN}‚úì${NC} Alembic version: $ALEMBIC_VERSION"
else
    echo -e "${RED}‚úó${NC} Vers√£o do Alembic n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 4 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo:"
    echo "  - 13 tabelas criadas"
    echo "  - 11 enums criados"
    echo "  - $FKS foreign keys"
    echo "  - $INDEXES √≠ndices"
    echo ""
    echo "‚úÖ Pr√≥ximo: Fase 5 - Seeds de Dados"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 4 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

--- ARQUIVO: /home/p016525/elielson/exitus/tests/mod1_validacao_final_fase5.sh ---
#!/bin/bash
# Script de valida√ß√£o da Fase 5 - Seeds de Dados

echo "======================================"
echo "  VALIDA√á√ÉO FASE 5 - SEEDS DE DADOS"
echo "======================================"
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

echo "1. Verificando usu√°rios..."
USERS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM usuario;")
USERS=$(echo $USERS | xargs)
if [ "$USERS" -eq 4 ]; then
    echo -e "${GREEN}‚úì${NC} 4 usu√°rios cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 4 usu√°rios, encontrado: $USERS"
    ((ERRORS++))
fi
echo ""

echo "2. Verificando ativos brasileiros..."
ATIVOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR';")
ATIVOS=$(echo $ATIVOS | xargs)
if [ "$ATIVOS" -eq 25 ]; then
    echo -e "${GREEN}‚úì${NC} 25 ativos brasileiros cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 25 ativos, encontrado: $ATIVOS"
    ((ERRORS++))
fi

#ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='acao';")
ACOES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='ACAO';")
ACOES=$(echo $ACOES | xargs)
echo -e "  - A√ß√µes: $ACOES"

#FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='fii';")
FIIS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM ativo WHERE mercado='BR' AND tipo='FII';")
FIIS=$(echo $FIIS | xargs)
echo -e "  - FIIs: $FIIS"
echo ""

echo "3. Verificando regras fiscais BR..."
REGRAS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM regra_fiscal WHERE pais='BR';")
REGRAS=$(echo $REGRAS | xargs)
if [ "$REGRAS" -eq 6 ]; then
    echo -e "${GREEN}‚úì${NC} 6 regras fiscais brasileiras cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 6 regras, encontrado: $REGRAS"
    ((ERRORS++))
fi
echo ""

echo "4. Verificando feriados B3..."
FERIADOS=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM feriado_mercado WHERE pais='BR' AND mercado='B3';")
FERIADOS=$(echo $FERIADOS | xargs)
if [ "$FERIADOS" -eq 30 ]; then
    echo -e "${GREEN}‚úì${NC} 30 feriados B3 cadastrados"
else
    echo -e "${RED}‚úó${NC} Esperado 30 feriados, encontrado: $FERIADOS"
    ((ERRORS++))
fi
echo ""

echo "5. Verificando fontes de dados..."
FONTES=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT COUNT(*) FROM fonte_dados;")
FONTES=$(echo $FONTES | xargs)
if [ "$FONTES" -eq 7 ]; then
    echo -e "${GREEN}‚úì${NC} 7 fontes de dados cadastradas"
else
    echo -e "${RED}‚úó${NC} Esperado 7 fontes, encontrado: $FONTES"
    ((ERRORS++))
fi
echo ""

echo "6. Verificando dados espec√≠ficos..."

# Verificar usu√°rio admin
ADMIN=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT username FROM usuario WHERE role='ADMIN' LIMIT 1;")
ADMIN=$(echo $ADMIN | xargs)
if [ "$ADMIN" = "admin" ]; then
    echo -e "${GREEN}‚úì${NC} Usu√°rio admin encontrado"
else
    echo -e "${RED}‚úó${NC} Usu√°rio admin n√£o encontrado"
    ((ERRORS++))
fi

# Verificar PETR4
PETR4=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT ticker FROM ativo WHERE ticker='PETR4';")
PETR4=$(echo $PETR4 | xargs)
if [ "$PETR4" = "PETR4" ]; then
    echo -e "${GREEN}‚úì${NC} Ativo PETR4 encontrado"
else
    echo -e "${RED}‚úó${NC} Ativo PETR4 n√£o encontrado"
    ((ERRORS++))
fi

# Verificar yfinance
YFINANCE=$(podman exec exitus-db psql -U exitus -d exitusdb -t -c "SELECT nome FROM fonte_dados WHERE nome='yfinance';")
YFINANCE=$(echo $YFINANCE | xargs)
if [ "$YFINANCE" = "yfinance" ]; then
    echo -e "${GREEN}‚úì${NC} Fonte yfinance encontrada"
else
    echo -e "${RED}‚úó${NC} Fonte yfinance n√£o encontrada"
    ((ERRORS++))
fi
echo ""

echo "======================================"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úì FASE 5 VALIDADA COM SUCESSO!${NC}"
    echo "======================================"
    echo ""
    echo "üìä Resumo dos Dados:"
    echo "  - $USERS usu√°rios"
    echo "  - $ATIVOS ativos ($ACOES a√ß√µes + $FIIS FIIs)"
    echo "  - $REGRAS regras fiscais"
    echo "  - $FERIADOS feriados"
    echo "  - $FONTES fontes de dados"
    echo ""
    echo "‚úÖ Banco de dados populado e pronto!"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó FASE 5 COM $ERRORS ERRO(S)${NC}"
    echo "======================================"
    exit 1
fi

====================================================

