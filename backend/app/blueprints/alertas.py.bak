# backend/app/blueprints/alertas.py
from flask import Blueprint, jsonify, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from uuid import UUID
from app.services.alerta_service import AlertaService
from app.models.configuracao_alerta import ConfiguracaoAlerta
from app.database import db

# Padronizando o nome 'bp' para facilitar a importação no __init__.py
bp = Blueprint('alertas', __name__, url_prefix='/api/alertas')

@bp.route('/', methods=['GET'])
@jwt_required()
def listar_alertas():
    """Lista todos os alertas do usuário"""
    try:
        usuario_id = UUID(get_jwt_identity())
        alertas = ConfiguracaoAlerta.query.filter_by(usuario_id=usuario_id).all()
        
        # Serialização manual
        result = []
        for a in alertas:
            result.append(a.to_dict())
        
        return jsonify({"data": result}), 200
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

@bp.route('/', methods=['POST'])
@jwt_required()
def criar_alerta():
    """Cria um novo alerta"""
    try:
        usuario_id = UUID(get_jwt_identity())
        dados = request.json
        
        # Validação básica
        if not dados.get('nome'):
            return jsonify({"message": "Nome é obrigatório"}), 400

        novo_alerta = AlertaService.criar_alerta(usuario_id, dados)
        return jsonify({"message": "Alerta criado com sucesso", "data": novo_alerta}), 201
    except Exception as e:
        print(f"Erro criar alerta: {e}")
        return jsonify({"status": "error", "message": str(e)}), 500

@bp.route('/<alerta_id>/toggle', methods=['PATCH'])
@jwt_required()
def toggle_alerta(alerta_id):
    """Ativa/Desativa um alerta"""
    try:
        usuario_id = UUID(get_jwt_identity())
        # Busca o alerta para saber o estado atual
        alerta = ConfiguracaoAlerta.query.filter_by(id=alerta_id, usuario_id=usuario_id).first()
        
        if not alerta:
            return jsonify({"message": "Alerta não encontrado"}), 404
            
        # Inverte o status
        novo_status = not alerta.ativo
        AlertaService.atualizar_alerta(usuario_id, UUID(alerta_id), {'ativo': novo_status})
        
        return jsonify({"message": f"Alerta {'ativado' if novo_status else 'desativado'}"}), 200
    except Exception as e:
        return jsonify({"message": str(e)}), 500

@bp.route('/<alerta_id>', methods=['DELETE'])
@jwt_required()
def deletar_alerta(alerta_id):
    """Remove um alerta"""
    try:
        usuario_id = UUID(get_jwt_identity())
        AlertaService.deletar_alerta(usuario_id, UUID(alerta_id))
        return jsonify({"message": "Alerta removido"}), 200
    except Exception as e:
        return jsonify({"message": str(e)}), 500

@bp.route('/verificar', methods=['POST'])
@jwt_required()
def verificar_manualmente():
    """Força a verificação de regras (para testes)"""
    usuario_id = UUID(get_jwt_identity())
    disparados = AlertaService.verificar_alertas_usuario(usuario_id)
    return jsonify({"data": disparados}), 200
