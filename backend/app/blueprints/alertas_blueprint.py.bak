# backend/app/blueprints/alertas_blueprint.py
from flask import Blueprint, jsonify, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from uuid import UUID
from app.services.alerta_service import AlertaService
from app.models import ConfiguracaoAlerta
from app.database import db

# Define o blueprint
alertas_bp = Blueprint('alertas', __name__, url_prefix='/api/alertas')

@alertas_bp.route('/verificar', methods=['POST'])
@jwt_required()
def verificar_alertas_manualmente():
    """
    Rota para forçar a verificação de alertas do usuário logado.
    Retorna a lista de alertas que foram disparados neste momento.
    """
    usuario_id = UUID(get_jwt_identity())
    try:
        disparados = AlertaService.verificar_alertas_usuario(usuario_id)
        
        return jsonify({
            "status": "success",
            "total_verificados": "N/A", # Otimização: Service não retorna count total
            "total_disparados": len(disparados),
            "alertas_disparados": disparados
        }), 200
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

@alertas_bp.route('/', methods=['GET'])
@jwt_required()
def listar_alertas():
    """Lista as configurações de alertas do usuário."""
    usuario_id = UUID(get_jwt_identity())
    alertas = ConfiguracaoAlerta.query.filter_by(usuario_id=usuario_id).all()
    
    # Serialização manual simples (idealmente usar Marshmallow)
    result = []
    for a in alertas:
        result.append({
            "id": a.id,
            "nome": a.nome,
            "ativo": a.ativo,
            "tipo": a.tipo_alerta.value if hasattr(a.tipo_alerta, 'value') else str(a.tipo_alerta),
            "condicao": f"{a.condicao_operador.value} {a.condicao_valor}",
            "ultimo_disparo": a.timestamp_ultimo_acionamento
        })
    
    return jsonify(result), 200
