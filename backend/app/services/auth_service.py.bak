# -*- coding: utf-8 -*-
"""Exitus - Auth Service - Lógica de autenticação JWT"""

from datetime import timedelta
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import check_password_hash
from app.database import db
from app.models import Usuario

class AuthService:
    """Serviço responsável por autenticação e geração de tokens JWT"""
    
    @staticmethod
    def login(username: str, password: str):
        """
        Valida credenciais e gera tokens JWT.
        
        Returns:
            dict: Tokens de acesso e refresh
        Raises:
            ValueError: Credenciais inválidas
        """
        user = Usuario.query.filter_by(username=username).first()
        if not user or not check_password_hash(user.password_hash, password):
            raise ValueError("Credenciais inválidas")
        
        if not user.ativo:
            raise ValueError("Usuário inativo")
        
        # Claims adicionais para autorização
        additional_claims = {"role": user.role}
        access_token = create_access_token(
            identity=str(user.id), 
            additional_claims=additional_claims, 
            expires_delta=timedelta(hours=1)
        )
        refresh_token = create_refresh_token(
            identity=str(user.id), 
            expires_delta=timedelta(days=30)
        )
        
        # Atualizar último login
        user.ultimo_login = db.func.now()
        db.session.commit()
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
    
    @staticmethod
    def refresh(identity: str):
        """Gera novo access_token a partir do refresh_token."""
        access_token = create_access_token(
            identity=identity, 
            expires_delta=timedelta(hours=1)
        )
        return {
            "access_token": access_token,
            "token_type": "Bearer",
            "expires_in": 3600
        }
