# -*- coding: utf-8 -*-
"""
Exitus Frontend - Dashboard Routes
MÓDULOS 6 e 7 (Restaurado e Corrigido)
"""

from flask import Blueprint, render_template, session, redirect, url_for, flash, request
import requests
from functools import wraps
from app.config import Config

bp = Blueprint('dashboard', __name__, url_prefix='/dashboard')

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('username') and not session.get('access_token'):
            return redirect(url_for('auth.login'))
        return f(*args, **kwargs)
    return decorated_function

# --- Rota Principal (Home) ---
@bp.route('/', methods=['GET'])
@login_required
def index():
    return render_template('dashboard/index.html')

# --- Rotas Restauradas do Módulo 6 ---

@bp.route('/buy-signals')
@login_required
def buy_signals():
    return render_template('dashboard/buy_signals.html')

import requests
import json
from flask import session
from flask_login import login_required, current_user

@bp.route('/portfolios')
@login_required
def portfolios():
    """M7 - Dashboard Portfolios integrado com Backend API"""
    try:
        # Obter token JWT do backend (mesmo usuário)
        backend_url = "http://localhost:5000"
        login_data = {
            "username": current_user.username,
            "password": session.get('backend_password', 'admin123')  # Fallback
        }
        
        # Login no backend para obter token
        login_response = requests.post(
            f"{backend_url}/api/auth/login",
            json=login_data,
            headers={'Content-Type': 'application/json'},
            timeout=5
        )
        
        if login_response.status_code != 200:
            # Fallback para dados mock se backend falhar
            return _render_portfolios_mock()
        
        token = login_response.json()['data']['access_token']
        
        # Buscar portfolios reais
        headers = {
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }
        
        portfolios_response = requests.get(
            f"{backend_url}/api/portfolios",
            headers=headers,
            timeout=10
        )
        
        if portfolios_response.status_code == 200:
            portfolios_data = portfolios_response.json()
            portfolios = portfolios_data.get('data', [])
            
            # Calcular stats reais
            stats = {
                "total": portfolios_data.get('total', 0),
                "ativas": len([p for p in portfolios if p.get('ativo', True)]),
                "saldo_total": 0.0,  # TODO: Somar posições
                "saldo_br": 0.0,     # TODO: Filtrar por país/ativo
                "saldo_us": 0.0
            }
            
            # Mapear para estrutura do template (compatibilidade)
            corretoras = []
            for portfolio in portfolios:
                corretoras.append({
                    "id": portfolio['id'],
                    "nome": portfolio['nome'],
                    "descricao": portfolio['descricao'] or '',
                    "objetivo": portfolio['objetivo'] or 'Geral',
                    "ativo": portfolio['ativo'],
                    "created_at": portfolio['created_at']
                })
            
            filtros = {
                "tipo": "todos",
                "status": "ativos",
                "periodo": "12m",
            }
            
            return render_template(
                'dashboard/portfolios.html',
                stats=stats,
                corretoras=corretoras,  # ← Agora com dados REAIS!
                filtros=filtros,
                backend_status="ok"
            )
        else:
            return _render_portfolios_mock()
            
    except Exception as e:
        print(f"Erro ao integrar portfolios API: {e}")
        return _render_portfolios_mock()


def _render_portfolios_mock():
    """Fallback mock se backend falhar"""
    stats = {
        "total": 2,
        "ativas": 2,
        "saldo_total": 125000.50,
        "saldo_br": 95000.00,
        "saldo_us": 30000.50
    }
    
    corretoras = [
        {
            "id": "1e1c2bfe-e3b8-4ab7-81f5-40d925ffe2e3",
            "nome": "Portfolio Principal - admin",
            "descricao": "Carteira principal de investimentos",
            "objetivo": "Crescimento",
            "ativo": True
        },
        {
            "id": "b6629879-1a9e-460f-944f-3f31b7f34d01",
            "nome": "Aposentadoria 2050",
            "descricao": "Foco em dividendos",
            "objetivo": "Longo Prazo",
            "ativo": True
        }
    ]
    
    filtros = {"tipo": "todos", "status": "ativos", "periodo": "12m"}
    
    return render_template(
        'dashboard/portfolios.html',
        stats=stats,
        corretoras=corretoras,
        filtros=filtros,
        backend_status="mock"
    )


@bp.route('/assets')
@login_required
def assets():
    """M6 - Tela de Ativos (Stub Placeholder)"""
    return render_template('dashboard/assets.html')

@bp.route('/transactions')
@login_required
def transactions():
    stats = {
        "total": 0,
        "compras": 0,
        "vendas": 0,
        "volume_total": 0.0,      # ← COM UNDERSCORE!
        "volume_compras": 0.0,    # ← COM UNDERSCORE!
        "volume_vendas": 0.0,     # ← COM UNDERSCORE!
        "volume_acoes": 0.0,
        "volume_fii": 0.0,
        "volume_cripto": 0.0,
        "volume_outros": 0.0,
    }

    filtros = {
        "tipo": "",
        "classe": "",
        "mercado": "",
        "corretora_id": "",
        "data_inicio": "",
        "data_fim": "",
    }

    transacoes = []
    corretoras = []
    tiposativo = []
    classesativo = []
    mercados = []

    return render_template(
        'dashboard/transactions.html',
        stats=stats,
        transacoes=transacoes,
        filtros=filtros,
        corretoras=corretoras,
        tiposativo=tiposativo,
        classesativo=classesativo,
        mercados=mercados,
    )


@bp.route('/dividends')
@login_required
def dividends():
    stats = {
        "total": 0,
        "recebido": 0.0,
        "previsto": 0.0,
        "total_geral": 0.0,  # ← COM UNDERSCORE!
    }

    filtros = {
        "status": "todos",
        "tipo": "todos",
        "periodo": "12m",
        "ativo": "",
        "corretora": "",
        "datainicio": "",
        "datafim": "",
    }

    proventos = []
    ativos = []
    corretoras = []
    tiposprovento = []
    dividendstimeline = []

    return render_template(
        'dashboard/dividends.html',
        stats=stats,
        proventos=proventos,
        filtros=filtros,
        ativos=ativos,
        corretoras=corretoras,
        tiposprovento=tiposprovento,
        dividendstimeline=dividendstimeline,
    )

@bp.route('/reports')
@login_required
def reports():
    """M7 - Relatórios Consolidados (Stub Placeholder)"""
    return render_template('dashboard/reports.html')


@bp.route('/analytics')
@login_required
def analytics():
    """M7 - Analytics Avançados (Stub Placeholder)"""
    return render_template('dashboard/analytics.html')

# --- M7.4: ALERTAS E NOTIFICAÇÕES (Mantido e Corrigido) ---

@bp.route('/alerts', methods=['GET'])
@login_required
def alerts():
    token = session.get('access_token')
    alertas = []
    stats = {'total': 0, 'ativos': 0, 'alta_preco': 0, 'acionados': 0}
    
    # Filtros
    tipo = request.args.get('tipo')
    status = request.args.get('status')
    ativo = request.args.get('ativo')

    if token:
        try:
            headers = {'Authorization': f'Bearer {token}'}
            params = {}
            if tipo and tipo != 'Todos': params['tipo_alerta'] = tipo
            if status and status != 'Todos': params['ativo'] = 'true' if status == 'ativo' else 'false'
            
            # GET no Backend
            response = requests.get(
                f'{Config.BACKEND_API_URL}/api/alertas/',
                headers=headers, params=params, timeout=5
            )
            
            if response.status_code == 200:
                payload = response.json()
                alertas = payload.get('data', [])
                
                # Calcular stats dinâmicos
                stats['total'] = len(alertas)
                stats['ativos'] = len([a for a in alertas if a.get('ativo')])
                stats['alta_preco'] = len([a for a in alertas if str(a.get('tipo_alerta') or '').upper() == 'ALTA_PRECO'])
                stats['acionados'] = len([a for a in alertas if a.get('foi_acionado')])
                
        except Exception as e:
            print(f"Erro ao buscar alertas: {e}")
            flash('Erro ao carregar alertas.', 'error')

    # Lista única de ativos para o filtro
    ativos_unicos = sorted(list(set(a.get('ticker') for a in alertas if a.get('ticker'))))

    return render_template(
        'dashboard/alerts.html',
        alertas=alertas,
        stats=stats,
        filtros={'tipo': tipo, 'status': status, 'ativo': ativo},
        ativos=ativos_unicos
    )

@bp.route('/alerts/create', methods=['POST'])
@login_required
def alerts_create():
    try:
        token = session.get('access_token')
        
        # Converte valores do form
        val_str = request.form.get('condicaovalor', '0').replace(',', '.')
        val2_str = request.form.get('condicaovalor2', '').replace(',', '.')
        
        payload = {
            "nome": request.form.get('nome'),
            "tipo_alerta": request.form.get('tipoalerta'),
            "ticker": request.form.get('ticker') or None,
            "condicao_operador": request.form.get('condicaooperador'),
            "condicao_valor": float(val_str),
            "condicao_valor2": float(val2_str) if val2_str else None,
            "frequencia_notificacao": request.form.get('frequencianotificacao'),
            "canais_entrega": request.form.getlist('canais'),
            "ativo": True
        }

        headers = {'Authorization': f'Bearer {token}'}
        response = requests.post(
            f'{Config.BACKEND_API_URL}/api/alertas/',
            json=payload, headers=headers, timeout=10
        )

        if response.status_code in [200, 201]:
            flash('✅ Alerta criado com sucesso!', 'success')
        else:
            flash(f'Erro ({response.status_code}): {response.text}', 'error')

    except Exception as e:
        flash(f'Erro de sistema: {str(e)}', 'error')
    
    return redirect(url_for('dashboard.alerts'))

@bp.route('/alerts/toggle/<alert_id>', methods=['POST'])
@login_required
def alerts_toggle(alert_id):
    token = session.get('access_token')
    headers = {'Authorization': f'Bearer {token}'}
    requests.patch(f'{Config.BACKEND_API_URL}/api/alertas/{alert_id}/toggle', headers=headers)
    return redirect(url_for('dashboard.alerts'))

@bp.route('/alerts/delete/<alert_id>', methods=['POST'])
@login_required
def alerts_delete(alert_id):
    token = session.get('access_token')
    headers = {'Authorization': f'Bearer {token}'}
    requests.delete(f'{Config.BACKEND_API_URL}/api/alertas/{alert_id}', headers=headers)
    return redirect(url_for('dashboard.alerts'))
