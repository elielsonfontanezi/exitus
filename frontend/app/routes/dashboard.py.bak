# -*- coding: utf-8 -*-
"""
Exitus Frontend - Dashboard Routes
MÓDULO 6: Buy Signals + Portfolios + Transações + Proventos
MÓDULO 7: Alertas (M7.4 Integrado) ✅
"""

from flask import Blueprint, render_template, session, redirect, url_for, flash, request
import requests
from functools import wraps
from app.config import Config
from collections import defaultdict
from datetime import datetime

bp = Blueprint('dashboard', __name__, url_prefix='/dashboard')

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if session.get('username') or session.get('access_token'):
            return f(*args, **kwargs)
        return redirect(url_for('auth.login'))
    return decorated_function

@bp.route('/', methods=['GET'])
@login_required
def index():
    # Aqui NÃO force redirect para alerts; apenas renderize a home original:
    return render_template('dashboard/index.html')


# ========================================
# M7.4 ALERTAS E NOTIFICAÇÕES (CORRIGIDO)
# ========================================

@bp.route('/alerts', methods=['GET'])
@login_required
def alerts():
    """M7.4 - Lista de alertas consumindo API backend /api/alertas/"""
    token = session.get('access_token')
    alertas = []
    
    # Filtros
    tipo = request.args.get('tipo')
    status = request.args.get('status')
    ativo = request.args.get('ativo')

    if token:
        try:
            headers = {'Authorization': f'Bearer {token}'}
            params = {}
            if tipo and tipo != 'Todos': params['tipo_alerta'] = tipo
            if status and status != 'Todos': params['ativo'] = 'true' if status == 'ativo' else 'false'
            if ativo and ativo != 'Todos': params['ticker'] = ativo

            # CORREÇÃO: Adicionada barra no final da URL (/api/alertas/)
            response = requests.get(
                f'{Config.BACKEND_API_URL}/api/alertas/',
                headers=headers, params=params, timeout=5
            )
            
            if response.status_code == 200:
                data = response.json()
                # Backend retorna lista direta ou { "data": [...] }
                alertas = data.get('data', []) if isinstance(data, dict) else data if isinstance(data, list) else []
            else:
                print(f"[M7.4] Erro API Alertas: {response.status_code} - {response.text}")
                
        except Exception as e:
            print(f"[M7.4] Exceção ao buscar alertas: {e}")
            flash('Erro de conexão ao carregar alertas.', 'error')

    # Calcular Estatísticas para os Cards
    stats = {
        'total': len(alertas),
        'ativos': len([a for a in alertas if a.get('ativo')]),
        'alta_preco': len([a for a in alertas if a.get('tipo') == 'ALTA_PRECO' or a.get('tipo_alerta') == 'ALTA_PRECO']),
        'acionados': len([a for a in alertas if (a.get('total_acionamentos') or 0) > 0])
    }

    filtros = {'tipo': tipo, 'status': status, 'ativo': ativo}
    ativos_unicos = sorted(list(set(a.get('ticker') for a in alertas if a.get('ticker'))))

    return render_template(
        'dashboard/alerts.html',
        alertas=alertas,
        stats=stats,  # Passando stats para o template
        filtros=filtros,
        ativos=ativos_unicos
    )

@bp.route('/alerts/create', methods=['POST'])
@login_required
def alerts_create():
    """M7.4 - Criar novo alerta (POST para API)"""
    try:
        token = session.get('access_token')
        if not token:
            return redirect(url_for('auth.login'))

        # Preparar Payload
        payload = {
            "nome": request.form.get('nome'),
            "tipo_alerta": request.form.get('tipoalerta'),
            "ticker": request.form.get('ticker') or None,
            "condicao_operador": request.form.get('condicaooperador'),
            "condicao_valor": float(request.form.get('condicaovalor') or 0),
            "condicao_valor2": float(request.form.get('condicaovalor2')) if request.form.get('condicaovalor2') else None,
            "frequencia_notificacao": request.form.get('frequencianotificacao'),
            "canais_entrega": request.form.getlist('canais'),
            "ativo": request.form.get('ativo') == 'true'
        }

        headers = {'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
        
        # CORREÇÃO: Adicionada barra no final da URL (/api/alertas/)
        response = requests.post(
            f'{Config.BACKEND_API_URL}/api/alertas/',
            json=payload, headers=headers, timeout=10
        )

        if response.status_code in [200, 201]:
            flash('✅ Alerta criado com sucesso!', 'success')
        else:
            flash(f'Erro ao criar alerta ({response.status_code}): {response.text}', 'error')

    except Exception as e:
        flash(f'Erro de sistema: {str(e)}', 'error')
    
    return redirect(url_for('dashboard.alerts'))

@bp.route('/alerts/table', methods=['GET'])
@login_required
def alerts_table():
    """M7.4 - HTMX partial da tabela"""
    token = session.get('access_token')
    alertas = []
    
    tipo = request.args.get('tipo')
    status = request.args.get('status')
    ativo = request.args.get('ativo')

    if token:
        try:
            headers = {'Authorization': f'Bearer {token}'}
            params = {'tipo_alerta': tipo, 'ativo': status, 'ticker': ativo}
            # CORREÇÃO: URL com barra
            response = requests.get(
                f'{Config.BACKEND_API_URL}/api/alertas/',
                headers=headers, params=params, timeout=5
            )
            if response.status_code == 200:
                data = response.json()
                alertas = data.get('data', []) if isinstance(data, dict) else data if isinstance(data, list) else []
        except Exception:
            pass

    return render_template('components/alerts_table.html', alertas=alertas)

# Outras rotas (toggle, delete, edit) devem seguir o mesmo padrão de URL com '/' final
@bp.route('/alerts/toggle/<alert_id>', methods=['POST'])
@login_required
def alerts_toggle(alert_id):
    token = session.get('access_token')
    headers = {'Authorization': f'Bearer {token}'}
    # PATCH geralmente não precisa de barra se o ID for parte da rota, mas verifique o backend
    requests.patch(f'{Config.BACKEND_API_URL}/api/alertas/{alert_id}/toggle', headers=headers)
    return redirect(url_for('dashboard.alerts'))

@bp.route('/alerts/delete/<alert_id>', methods=['POST'])
@login_required
def alerts_delete(alert_id):
    token = session.get('access_token')
    headers = {'Authorization': f'Bearer {token}'}
    requests.delete(f'{Config.BACKEND_API_URL}/api/alertas/{alert_id}', headers=headers)
    return redirect(url_for('dashboard.alerts'))

@bp.route('/alerts/edit/<alert_id>', methods=['POST'])
@login_required
def alerts_edit(alert_id):
    flash('Edição em breve.', 'info')
    return redirect(url_for('dashboard.alerts'))
